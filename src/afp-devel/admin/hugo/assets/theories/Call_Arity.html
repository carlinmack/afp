<div id="BalancedTraces">
<div class="head">
<h1>Theory BalancedTraces</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BalancedTraces
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> traces <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">=&gt;</span> <span class="tfree">'c</span> <span class="main">=&gt;</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1">⇒</span></span>"</span> 50<span class="main">)</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">steps</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⇒<span class="hidden">⇧</span><sup>*</sup></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">steps</span> <span class="main">≡</span> <span class="free">step</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">trace</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'c</span> list <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> bool"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  trace_nil<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="free"><span class="bound"><span class="entity">final</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">final</span></span></span>"</span></span>
<span class="main">|</span> trace_cons<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="free"><span class="bound"><span class="entity">conf'</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">final</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">conf'</span></span></span> <span class="main">⟹</span> <span class="free">trace</span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">conf'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">final</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> trace_consE<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">conf</span> <span class="main">(</span><span class="free">conf'</span><span class="main">#</span><span class="free">T</span><span class="main">)</span> <span class="free">final</span>"</span></span>

<span class="keyword1" id="BalancedTraces-trace_induct_final"><span class="command">lemma</span></span> trace_induct_final<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> trace_nil trace_cons<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace <span class="free">x1</span> <span class="free">x2</span> <span class="free">final</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">final</span> <span class="main">[]</span> <span class="free">final</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">conf'</span> <span class="bound">T</span>  <span class="bound">conf</span><span class="main">.</span> trace <span class="bound">conf'</span> <span class="bound">T</span> <span class="free">final</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">conf'</span> <span class="bound">T</span> <span class="free">final</span> <span class="main">⟹</span> <span class="bound">conf</span> <span class="main"><span class="free">⇒</span></span> <span class="bound">conf'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">conf</span> <span class="main">(</span><span class="bound">conf'</span> <span class="main">#</span> <span class="bound">T</span><span class="main">)</span> <span class="free">final</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x1</span> <span class="free">x2</span> <span class="free">final</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trace.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="BalancedTraces-build_trace"><span class="command">lemma</span></span> build_trace<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c'</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">T</span><span class="main">.</span> trace <span class="free">c</span> <span class="bound">T</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtranclp_induct<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">c'</span> <span class="main">[]</span> <span class="free">c'</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span><span class="main">.</span> trace <span class="free">c'</span> <span class="bound">T</span> <span class="free">c'</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main"><span class="free">⇒</span></span> <span class="skolem">z</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span><span class="main">.</span> trace <span class="skolem">z</span> <span class="bound">T</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"trace <span class="skolem">z</span> <span class="skolem">T</span> <span class="free">c'</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main"><span class="free">⇒</span></span> <span class="skolem">z</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="skolem">y</span> <span class="main">(</span><span class="skolem">z</span><span class="main">#</span><span class="skolem">T</span><span class="main">)</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span><span class="main">.</span> trace <span class="skolem">y</span> <span class="bound">T</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BalancedTraces-destruct_trace"><span class="command">lemma</span></span> destruct_trace<span class="main">:</span>  <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="free">T</span> <span class="free">c'</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trace.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="BalancedTraces-traceWhile"><span class="command">lemma</span></span> traceWhile<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">T</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span>  <span class="free">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> <span class="free">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">#</span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span>  <span class="free">P</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main"><span class="free">⇒</span></span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">.</span> <span class="main">(</span><span class="free">T</span> <span class="main">=</span> <span class="bound">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="bound">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">#</span> <span class="bound">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> trace <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="bound">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main"><span class="free">⇒</span></span> <span class="bound">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> trace <span class="bound">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> trace_nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>trace_cons <span class="skolem">conf'</span> <span class="skolem">T</span> <span class="quoted">"<span class="skolem">end</span>"</span> <span class="skolem">conf</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">conf'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> trace_cons.IH<span class="main">[</span><span class="operator">OF</span> True <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">P</span> <span class="skolem">end</span>›</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">#</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> trace <span class="skolem">conf'</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main"><span class="free">⇒</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> trace <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">end</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">conf'</span> <span class="main">#</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">conf'</span> <span class="main">#</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">#</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> trace <span class="skolem">conf</span> <span class="main">(</span><span class="skolem">conf'</span> <span class="main">#</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">conf'</span> <span class="main">#</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>  <span class="main">∧</span> <span class="free">P</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main"><span class="free">⇒</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span>  <span class="main">∧</span> trace <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">end</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_cons<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> trace_cons
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">conf'</span> <span class="main">#</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="skolem">conf'</span> <span class="main">#</span> <span class="skolem">T</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">[]</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="skolem">conf</span> <span class="main">∧</span> <span class="skolem">conf</span> <span class="main"><span class="free">⇒</span></span> <span class="skolem">conf'</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="skolem">conf'</span> <span class="main">∧</span> trace <span class="skolem">conf'</span> <span class="skolem">T</span> <span class="skolem">end</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BalancedTraces-traces_list_all"><span class="command">lemma</span></span> traces_list_all<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="free">T</span> <span class="free">c'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">c'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span> <span class="bound">c'</span><span class="main">.</span> <span class="bound">c</span> <span class="main"><span class="free">⇒</span></span> <span class="bound">c'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">T</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trace.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="BalancedTraces-trace_nil"><span class="command">lemma</span></span> trace_nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="main">[]</span> <span class="free">c'</span> <span class="main">⟷</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> trace.cases traces.trace_nil<span class="main">)</span>
  
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extends</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≲</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">≲</span></span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">S''</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span> <span class="main">=</span> <span class="bound">S''</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="BalancedTraces-extends_refl"><span class="command">lemma</span></span> extends_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≲</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> extends_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="BalancedTraces-extends_cons"><span class="command">lemma</span></span> extends_cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≲</span> <span class="free">x</span> <span class="main">#</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> extends_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="BalancedTraces-extends_append"><span class="command">lemma</span></span> extends_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≲</span> <span class="free">L</span> <span class="main">@</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> extends_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="BalancedTraces-extends_not_cons"><span class="command">lemma</span></span> extends_not_cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span> <span class="main">≲</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> extends_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="BalancedTraces-extends_trans"><span class="command">lemma</span></span> extends_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≲</span> <span class="free">S'</span> <span class="main">⟹</span> <span class="free">S'</span> <span class="main">≲</span> <span class="free">S''</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≲</span> <span class="free">S''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> extends_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">locale</span></span> balance_trace <span class="main">=</span> traces <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">stack</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> one_step_only<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main"><span class="free">⇒</span></span> <span class="free">c'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">stack</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">stack</span> <span class="free">c'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">.</span>  <span class="free">stack</span> <span class="free">c'</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">#</span> <span class="free">stack</span> <span class="free">c</span><span class="main">)</span> <span class="main">∨</span>  <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> <span class="free">stack</span> <span class="free">c</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">#</span> <span class="free">stack</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">bal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  balI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">c'</span><span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free">stack</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≲</span> <span class="free">stack</span> <span class="bound">c'</span> <span class="main">⟹</span> <span class="free">stack</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">=</span> <span class="free">stack</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟹</span> <span class="free">bal</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> balE<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="free">c</span> <span class="free">T</span> <span class="free">c'</span>"</span></span>

<span class="keyword1" id="BalancedTraces-bal_nil"><span class="command">lemma</span></span> bal_nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="free">c</span> <span class="main">[]</span> <span class="free">c'</span> <span class="main">⟷</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> balE trace.cases<span class="main">)</span>
  

<span class="keyword1" id="BalancedTraces-bal_stackD"><span class="command">lemma</span></span> bal_stackD<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="free">c</span> <span class="free">T</span> <span class="free">c'</span> <span class="main">⟹</span> <span class="free">stack</span> <span class="free">c'</span> <span class="main">=</span> <span class="free">stack</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> balE<span class="main">)</span>

<span class="keyword1" id="BalancedTraces-stack_passes_lower_bound"><span class="command">lemma</span></span> stack_passes_lower_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main"><span class="free">⇒</span></span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> tl <span class="main">(</span><span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>  
  <span class="keyword1"><span class="command">from</span></span> one_step_only<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> tl <span class="main">(</span><span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">elim</span> disjE exE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span>›</span></span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> c<span class="hidden">⇩</span><sub>3</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">L</span> <span class="main">@</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> extends_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">L</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> c<span class="hidden">⇩</span><sub>3</sub> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span>  Nil  c<span class="hidden">⇩</span><sub>3</sub> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> tl <span class="main">(</span><span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">L'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">L'</span> <span class="main">@</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> tl <span class="main">(</span><span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="BalancedTraces-bal_consE"><span class="command">lemma</span></span> bal_consE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="free">T</span><span class="main">)</span> <span class="free">c<span class="hidden">⇩</span><sub>5</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s</span> <span class="main">#</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> <span class="free">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">#</span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"bal <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main"><span class="free">⇒</span></span> <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>5</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> balE<span class="main">)</span>
  
  <span class="keyword3"><span class="command">assume</span></span> c<span class="hidden">⇩</span><sub>5</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>5</sub></span> <span class="main">=</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="free">T</span><span class="main">)</span><span class="main">.</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="bound">c'</span>"</span></span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="free">T</span><span class="main">)</span> <span class="free">c<span class="hidden">⇩</span><sub>5</sub></span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main"><span class="free">⇒</span></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">T</span> <span class="free">c<span class="hidden">⇩</span><sub>5</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trace_consE<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹trace <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">T</span> <span class="free">c<span class="hidden">⇩</span><sub>5</sub></span>›</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>5</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c<span class="hidden">⇩</span><sub>5</sub> c<span class="hidden">⇩</span><sub>2</sub>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">#</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c'</span> <span class="main">∈</span> set <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="bound">c'</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main"><span class="free">⇒</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>5</sub></span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> traceWhile<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">#</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main"><span class="free">⇒</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="hidden">⇩</span><sub>2</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> tl <span class="main">(</span><span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stack_passes_lower_bound<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹trace <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="bound">a</span>›</span></span> this<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span>"</span></span><span class="keyword1"><span class="command">..</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main"><span class="free">⇒</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

    <span class="keyword1"><span class="command">have</span></span> c<span class="hidden">⇩</span><sub>4</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c<span class="hidden">⇩</span><sub>2</sub> c<span class="hidden">⇩</span><sub>2</sub>' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">note</span></span>  <span class="quoted"><span class="quoted">‹trace <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>5</sub></span>›</span></span> 
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span><span class="main">∈</span>set <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">stack</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">≲</span> <span class="free">stack</span> <span class="bound">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c<span class="hidden">⇩</span><sub>4</sub> T <span class="quoted"><span class="quoted">‹<span class="free">T</span> <span class="main">=</span> <span class="main">_</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free">c<span class="hidden">⇩</span><sub>5</sub></span> <span class="main">=</span> <span class="free">stack</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c<span class="hidden">⇩</span><sub>4</sub> c<span class="hidden">⇩</span><sub>5</sub><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>5</sub></span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>  
</pre>
</div><div id="SestoftConf">
<div class="head">
<h1>Theory SestoftConf</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> SestoftConf
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../launchbury/theories/#Terms">Launchbury.Terms</a> <a href="../../launchbury/theories/#Substitution">Launchbury.Substitution</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> stack_elem <span class="main">=</span> Alts <span class="quoted">exp</span> <span class="quoted">exp</span> <span class="main">|</span> Arg <span class="quoted">var</span> <span class="main">|</span> Upd <span class="quoted">var</span> <span class="main">|</span> Dummy <span class="quoted">var</span>

<span class="keyword1"><span class="command">instantiation</span></span> stack_elem <span class="main">::</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Alts <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">⇒</span> Alts <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">∙</span> <span class="bound">e1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">∙</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span>Arg <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> Arg <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">∙</span> <span class="bound">v</span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span>Upd <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> Upd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">∙</span> <span class="bound">v</span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span>Dummy <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> Dummy <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">∙</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_stack_elem_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>stack_elem.split<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="SestoftConf-Alts_eqvt"><span class="command">lemma</span></span> Alts_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>Alts <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> Alts <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e1</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Arg_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>Arg <span class="free">v</span><span class="main">)</span> <span class="main">=</span> Arg <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Upd_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>Upd <span class="free">v</span><span class="main">)</span> <span class="main">=</span> Upd <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Dummy_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>Dummy <span class="free">v</span><span class="main">)</span> <span class="main">=</span> Dummy <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_stack_elem_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>stack_elem.split<span class="main">)</span>

<span class="keyword1" id="SestoftConf-supp_Alts"><span class="command">lemma</span></span> supp_Alts<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Alts <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">e1</span> <span class="main">∪</span> supp <span class="free">e2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_imp_eq Collect_neg_eq<span class="main">)</span>
<span class="keyword1" id="SestoftConf-supp_Arg"><span class="command">lemma</span></span> supp_Arg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Arg <span class="free">v</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">v</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-supp_Upd"><span class="command">lemma</span></span> supp_Upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Upd <span class="free">v</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">v</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-supp_Dummy"><span class="command">lemma</span></span> supp_Dummy<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Dummy <span class="free">v</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">v</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-fresh_Alts"><span class="command">lemma</span></span> fresh_Alts<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> Alts <span class="free">e1</span> <span class="free">e2</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">♯</span> <span class="free">e1</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">e2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fresh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-fresh_star_Alts"><span class="command">lemma</span></span> fresh_star_Alts<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> Alts <span class="free">e1</span> <span class="free">e2</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">♯*</span> <span class="free">e1</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">♯*</span> <span class="free">e2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fresh_star_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-fresh_Arg"><span class="command">lemma</span></span> fresh_Arg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> Arg <span class="free">v</span> <span class="main">=</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fresh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-fresh_Upd"><span class="command">lemma</span></span> fresh_Upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> Upd <span class="free">v</span> <span class="main">=</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fresh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-fresh_Dummy"><span class="command">lemma</span></span> fresh_Dummy<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> Dummy <span class="free">v</span> <span class="main">=</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fresh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-fv_Alts"><span class="command">lemma</span></span> fv_Alts<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>Alts <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">e1</span> <span class="main">∪</span> fv <span class="free">e2</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-fv_Arg"><span class="command">lemma</span></span> fv_Arg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>Arg <span class="free">v</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">v</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-fv_Upd"><span class="command">lemma</span></span> fv_Upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>Upd <span class="free">v</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">v</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-fv_Dummy"><span class="command">lemma</span></span> fv_Dummy<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>Dummy <span class="free">v</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">v</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span> stack_elem <span class="main">::</span> <span class="quoted">fs</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_supp<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> stack <span class="main">=</span> <span class="quoted"><span class="quoted">"stack_elem list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"stack <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ap</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ap</span> <span class="main">(</span>Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ap</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ap</span> <span class="main">(</span>Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">ap</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ap</span> <span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ap</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ap</span> <span class="main">(</span>Dummy <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ap</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">upds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"stack <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">upds</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">upds</span> <span class="main">(</span>Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">upds</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">upds</span> <span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">upds</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">upds</span> <span class="main">(</span>Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">upds</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">upds</span> <span class="main">(</span>Dummy <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">upds</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dummies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"stack <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dummies</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummies</span> <span class="main">(</span>Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">dummies</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummies</span> <span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">dummies</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummies</span> <span class="main">(</span>Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">dummies</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummies</span> <span class="main">(</span>Dummy <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">dummies</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">flattn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"stack <span class="main">⇒</span> var list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flattn</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flattn</span> <span class="main">(</span>Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> fv_list <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">@</span> fv_list <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">@</span> <span class="free">flattn</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flattn</span> <span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">flattn</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flattn</span> <span class="main">(</span>Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">flattn</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flattn</span> <span class="main">(</span>Dummy <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">flattn</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">upds_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"stack <span class="main">⇒</span> var list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">upds_list</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">upds_list</span> <span class="main">(</span>Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">upds_list</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">upds_list</span> <span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">upds_list</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">upds_list</span> <span class="main">(</span>Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">upds_list</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">upds_list</span> <span class="main">(</span>Dummy <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">upds_list</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1" id="SestoftConf-set_upds_list"><span class="command">lemma</span></span> set_upds_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>upds_list <span class="free">S</span><span class="main">)</span> <span class="main">=</span> upds <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> upds_list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-ups_fv_subset"><span class="command">lemma</span></span> ups_fv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"upds <span class="free">S</span> <span class="main">⊆</span> fv <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> upds.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-fresh_distinct_ups"><span class="command">lemma</span></span> fresh_distinct_ups<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> <span class="free">V</span> <span class="main">♯*</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">V</span> <span class="main">∩</span> upds <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fresh_distinct_fv subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ups_fv_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1" id="SestoftConf-ap_fv_subset"><span class="command">lemma</span></span> ap_fv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"ap <span class="free">S</span> <span class="main">⊆</span> fv <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> upds.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-dummies_fv_subset"><span class="command">lemma</span></span> dummies_fv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"dummies <span class="free">S</span> <span class="main">⊆</span> fv <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dummies.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-fresh_flattn"><span class="command">lemma</span></span> fresh_flattn<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="main">(</span><span class="free">a</span><span class="main">::</span>var<span class="main">)</span> <span class="main">♯</span> flattn <span class="free">S</span> <span class="main">⟷</span> atom <span class="free">a</span> <span class="main">♯</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>flattn.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Nil fresh_Cons fresh_append fresh_fv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_fv<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1" id="SestoftConf-fresh_star_flattn"><span class="command">lemma</span></span> fresh_star_flattn<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> <span class="main">(</span><span class="free">as</span><span class="main">::</span> var set<span class="main">)</span> <span class="main">♯*</span> flattn <span class="free">S</span> <span class="main">⟷</span> atom <span class="main">`</span> <span class="free">as</span> <span class="main">♯*</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>
<span class="keyword1" id="SestoftConf-fresh_upds_list"><span class="command">lemma</span></span> fresh_upds_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">a</span> <span class="main">♯</span> <span class="free">S</span> <span class="main">⟹</span> atom <span class="main">(</span><span class="free">a</span><span class="main">::</span>var<span class="main">)</span> <span class="main">♯</span> upds_list <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>upds_list.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Nil fresh_Cons fresh_append fresh_fv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_fv<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1" id="SestoftConf-fresh_star_upds_list"><span class="command">lemma</span></span> fresh_star_upds_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> <span class="main">(</span><span class="free">as</span><span class="main">::</span> var set<span class="main">)</span> <span class="main">♯*</span> <span class="free">S</span> <span class="main">⟹</span> atom <span class="main">`</span> <span class="main">(</span><span class="free">as</span><span class="main">::</span> var set<span class="main">)</span> <span class="main">♯*</span> upds_list <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>

<span class="keyword1" id="SestoftConf-upds_append"><span class="command">lemma</span></span> upds_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"upds <span class="main">(</span><span class="free">S</span><span class="main">@</span><span class="free">S'</span><span class="main">)</span> <span class="main">=</span> upds <span class="free">S</span> <span class="main">∪</span> upds <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> upds.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-upds_map_Dummy"><span class="command">lemma</span></span> upds_map_Dummy<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"upds <span class="main">(</span>map Dummy <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-upds_list_append"><span class="command">lemma</span></span> upds_list_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"upds_list <span class="main">(</span><span class="free">S</span><span class="main">@</span><span class="free">S'</span><span class="main">)</span> <span class="main">=</span> upds_list <span class="free">S</span> <span class="main">@</span> upds_list <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> upds.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-upds_list_map_Dummy"><span class="command">lemma</span></span> upds_list_map_Dummy<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"upds_list <span class="main">(</span>map Dummy <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-dummies_append"><span class="command">lemma</span></span> dummies_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dummies <span class="main">(</span><span class="free">S</span><span class="main">@</span><span class="free">S'</span><span class="main">)</span> <span class="main">=</span> dummies <span class="free">S</span> <span class="main">∪</span> dummies <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dummies.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-dummies_map_Dummy"><span class="command">lemma</span></span> dummies_map_Dummy<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dummies <span class="main">(</span>map Dummy <span class="free">l</span><span class="main">)</span> <span class="main">=</span> set <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-map_Dummy_inj"><span class="command">lemma</span></span> map_Dummy_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map Dummy <span class="free">l</span> <span class="main">=</span> map Dummy <span class="free">l'</span> <span class="main">⟷</span> <span class="free">l</span> <span class="main">=</span> <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">l'</span></span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> conf <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>heap <span class="main">×</span> exp <span class="main">×</span> stack<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">boring_step</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"isVal <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟹</span> <span class="free">boring_step</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">restr_stack</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set <span class="main">⇒</span> stack <span class="main">⇒</span> stack"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">restr_stack</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">restr_stack</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free">restr_stack</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">restr_stack</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">restr_stack</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">restr_stack</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="keyword1">then</span> Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">restr_stack</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">else</span> <span class="free">restr_stack</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">restr_stack</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>Dummy <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> Dummy <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">restr_stack</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1" id="SestoftConf-restr_stack_cong"><span class="command">lemma</span></span> restr_stack_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> upds <span class="free">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">V'</span><span class="main">)</span> <span class="main">⟹</span> restr_stack <span class="free">V</span> <span class="free">S</span> <span class="main">=</span> restr_stack <span class="free">V'</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> restr_stack.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-upds_restr_stack"><span class="command">lemma</span></span> upds_restr_stack<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"upds <span class="main">(</span>restr_stack <span class="free">V</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> upds <span class="free">S</span> <span class="main">∩</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> restr_stack.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-fresh_star_restict_stack"><span class="command">lemma</span></span> fresh_star_restict_stack<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">♯*</span> restr_stack <span class="free">V</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> restr_stack.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Cons<span class="main">)</span>

<span class="keyword1" id="SestoftConf-restr_stack_restr_stack"><span class="command">lemma</span></span> restr_stack_restr_stack<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"restr_stack <span class="free">V</span> <span class="main">(</span>restr_stack <span class="free">V'</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> restr_stack <span class="main">(</span><span class="free">V</span> <span class="main">∩</span> <span class="free">V'</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> restr_stack.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-Upd_eq_restr_stackD"><span class="command">lemma</span></span> Upd_eq_restr_stackD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Upd <span class="free">x</span> <span class="main">#</span> <span class="free">S</span> <span class="main">=</span> restr_stack <span class="free">V</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted">upds</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-Upd_eq_restr_stackD2"><span class="command">lemma</span></span> Upd_eq_restr_stackD2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"restr_stack <span class="free">V</span> <span class="free">S'</span> <span class="main">=</span> Upd <span class="free">x</span> <span class="main">#</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted">upds</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="SestoftConf-restr_stack_noop"><span class="command">lemma</span></span> restr_stack_noop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"restr_stack <span class="free">V</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S</span> <span class="main">⟷</span> upds <span class="free">S</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> restr_stack.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Upd_eq_restr_stackD2<span class="main">)</span>
  

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants of the semantics›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">invariant</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> invariant.intros<span class="main">[</span><span class="operator">case_names</span> step<span class="main">]</span>

<span class="keyword1" id="SestoftConf-invariantE"><span class="command">lemma</span></span> invariantE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invariant <span class="free">rel</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">rel</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">I</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">I</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> invariant.cases<span class="main">)</span>

<span class="keyword1" id="SestoftConf-invariant_starE"><span class="command">lemma</span></span> invariant_starE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rtranclp <span class="free">rel</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> invariant <span class="free">rel</span> <span class="free">I</span> <span class="main">⟹</span>  <span class="free">I</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">I</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> invariantE<span class="main">)</span>

<span class="keyword1" id="SestoftConf-invariant_True"><span class="command">lemma</span></span> invariant_True<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invariant <span class="free">rel</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> invariant.intros<span class="main">)</span>

<span class="keyword1" id="SestoftConf-invariant_conj"><span class="command">lemma</span></span> invariant_conj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invariant <span class="free">rel</span> <span class="free">I1</span> <span class="main">⟹</span> invariant <span class="free">rel</span> <span class="free">I2</span> <span class="main">⟹</span> invariant <span class="free">rel</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">I1</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">I2</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invariant.simps<span class="main">)</span>


<span class="keyword1" id="SestoftConf-rtranclp_invariant_induct"><span class="command">lemma</span></span> rtranclp_invariant_induct<span class="main">[</span><span class="operator">consumes</span> 3<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invariant <span class="free">r</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">a</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">r</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">a</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="free">a</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">a</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="skolem">y</span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">y</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> invariantE<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">a</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="skolem">y</span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">y</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"conf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">⟷</span> fv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">⊆</span> domA <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">∪</span> upds <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">heap_upds_ok</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_upds_ok</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">⟷</span> domA <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">∩</span> upds <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> distinct <span class="main">(</span>upds_list <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">heap_upds_ok_conf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"conf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_upds_ok_conf</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> heap_upds_ok <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> snd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SestoftConf-heap_upds_okE"><span class="command">lemma</span></span> heap_upds_okE<span class="main">:</span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> upds <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-heap_upds_ok_Nil"><span class="command">lemma</span></span> heap_upds_ok_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-heap_upds_ok_app1"><span class="command">lemma</span></span> heap_upds_ok_app1<span class="main">:</span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span>Arg <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-heap_upds_ok_app2"><span class="command">lemma</span></span> heap_upds_ok_app2<span class="main">:</span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Arg <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-heap_upds_ok_alts1"><span class="command">lemma</span></span> heap_upds_ok_alts1<span class="main">:</span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span>Alts <span class="free">e1</span> <span class="free">e2</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="SestoftConf-heap_upds_ok_alts2"><span class="command">lemma</span></span> heap_upds_ok_alts2<span class="main">:</span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Alts <span class="free">e1</span> <span class="free">e2</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-heap_upds_ok_append"><span class="command">lemma</span></span> heap_upds_ok_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Δ</span> <span class="main">∩</span> upds <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span><span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Δ</span><span class="main">@</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> heap_upds_ok.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-heap_upds_ok_let"><span class="command">lemma</span></span> heap_upds_ok_let<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Δ</span> <span class="main">♯*</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> heap_upds_ok_append <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ups_fv_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="SestoftConf-heap_upds_ok_to_stack"><span class="command">lemma</span></span> heap_upds_ok_to_stack<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">,</span> Upd <span class="free">x</span> <span class="main">#</span><span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="SestoftConf-heap_upds_ok_to_stack'"><span class="command">lemma</span></span> heap_upds_ok_to_stack'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">,</span> Upd <span class="free">x</span> <span class="main">#</span><span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Domain.DomainI domA_def fst_eq_Domain heap_upds_ok_to_stack map_of_SomeD<span class="main">)</span>

<span class="keyword1" id="SestoftConf-heap_upds_ok_delete"><span class="command">lemma</span></span> heap_upds_ok_delete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-heap_upds_ok_restrictA"><span class="command">lemma</span></span> heap_upds_ok_restrictA<span class="main">:</span>
  <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span>restrictA <span class="free">V</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-heap_upds_ok_restr_stack"><span class="command">lemma</span></span> heap_upds_ok_restr_stack<span class="main">:</span>
  <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> restr_stack <span class="free">V</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> restr_stack.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-heap_upds_ok_to_heap"><span class="command">lemma</span></span> heap_upds_ok_to_heap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Upd <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftConf-heap_upds_ok_reorder"><span class="command">lemma</span></span> heap_upds_ok_reorder<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="free">x</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> heap_upds_ok_to_heap heap_upds_ok_to_stack<span class="main">)</span>

<span class="keyword1" id="SestoftConf-heap_upds_ok_upd"><span class="command">lemma</span></span> heap_upds_ok_upd<span class="main">:</span>
<span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Upd <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> upds <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemmas</span></span> heap_upds_ok_intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span>
  heap_upds_ok_to_heap heap_upds_ok_to_stack heap_upds_ok_to_stack' heap_upds_ok_reorder
  heap_upds_ok_app1 heap_upds_ok_app2 heap_upds_ok_alts1 heap_upds_ok_alts2 heap_upds_ok_delete
  heap_upds_ok_restrictA heap_upds_ok_restr_stack
  heap_upds_ok_let
<span class="keyword1"><span class="command">lemmas</span></span> heap_upds_ok.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sestoft">
<div class="head">
<h1>Theory Sestoft</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Sestoft 
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#SestoftConf">SestoftConf</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"conf <span class="main">⇒</span> conf <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⇒</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  app<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> App <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">,</span> Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> app<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">].</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> var<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"map_of <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span>delete <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">,</span> Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> var<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> domA <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⟹</span> isVal <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">♯*</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⟹</span> atom <span class="main">`</span> domA <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">♯*</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>
                           <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> Let <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> if<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">scrut</span></span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">scrut</span></span></span><span class="main">,</span> Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> if<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> Bool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">steps</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⇒<span class="hidden">⇧</span><sup>*</sup></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">steps</span> <span class="main">≡</span> step<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword1" id="Sestoft-SmartLet_stepI"><span class="command">lemma</span></span> SmartLet_stepI<span class="main">:</span>
   <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Δ</span> <span class="main">♯*</span> <span class="free">Γ</span> <span class="main">⟹</span> atom <span class="main">`</span> domA <span class="free">Δ</span> <span class="main">♯*</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> SmartLet <span class="free">Δ</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span>  <span class="main">(</span><span class="free">Δ</span><span class="main">@</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span> <span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> SmartLet_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> let<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>

<span class="keyword1" id="Sestoft-lambda_var"><span class="command">lemma</span></span> lambda_var<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span> <span class="main">⟹</span> isVal <span class="free">e</span>  <span class="main">⟹</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Var <span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="free">x</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span> <span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> r_into_rtranclp r_into_rtranclp<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> var<span class="hidden">⇩</span><sub>1</sub> var<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>

<span class="keyword1" id="Sestoft-let"><span class="command">lemma</span></span> let<span class="hidden">⇩</span><sub>1</sub>_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Let <span class="free">Δ</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Δ</span> <span class="main">∩</span> domA <span class="free">Γ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Δ</span> <span class="main">∩</span> upds <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Let <span class="free">Δ</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="free">Δ</span><span class="main">@</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span> <span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹domA <span class="free">Δ</span> <span class="main">∩</span> domA <span class="free">Γ</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹domA <span class="free">Δ</span> <span class="main">∩</span> upds <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Δ</span> <span class="main">∩</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹closed <span class="main">_</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Δ</span> <span class="main">∩</span> fv <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Δ</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fv_def fresh_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"atom<span class="main">`</span> domA <span class="free">Δ</span> <span class="main">♯*</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Δ</span> <span class="main">♯*</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An induction rule that skips the annoying case of a lambda taken off the heap›</span></span>

<span class="keyword1" id="Sestoft-step_invariant_induction"><span class="command">lemma</span></span> step_invariant_induction<span class="main">[</span><span class="operator">consumes</span> 4<span class="main">,</span> <span class="operator">case_names</span> app<span class="hidden">⇩</span><sub>1</sub> app<span class="hidden">⇩</span><sub>2</sub> thunk lamvar var<span class="hidden">⇩</span><sub>2</sub> let<span class="hidden">⇩</span><sub>1</sub> if<span class="hidden">⇩</span><sub>1</sub> if<span class="hidden">⇩</span><sub>2</sub> refl trans<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> boring_step <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(⇒)</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> app<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Γ</span> <span class="bound">e</span> <span class="bound">x</span> <span class="bound">S</span> <span class="main">.</span> <span class="free">I</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> App <span class="bound">e</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> App <span class="bound">e</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span>  <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span> <span class="main">,</span> Arg <span class="bound">x</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> app<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Γ</span> <span class="bound">y</span> <span class="bound">e</span> <span class="bound">x</span> <span class="bound">S</span> <span class="main">.</span> <span class="free">I</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="bound">y</span><span class="main">].</span> <span class="bound">e</span><span class="main">,</span> Arg <span class="bound">x</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="bound">y</span><span class="main">].</span> <span class="bound">e</span><span class="main">,</span> Arg <span class="bound">x</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span><span class="main">[</span><span class="bound">y</span> <span class="main">::=</span> <span class="bound">x</span><span class="main">]</span> <span class="main">,</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thunk<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Γ</span> <span class="bound">x</span> <span class="bound">e</span> <span class="bound">S</span> <span class="main">.</span> map_of <span class="bound">Γ</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">e</span> <span class="main">⟹</span> <span class="main">¬</span> isVal <span class="bound">e</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> Var <span class="bound">x</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟹</span>  <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> Var <span class="bound">x</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>delete <span class="bound">x</span> <span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span> <span class="main">,</span> Upd <span class="bound">x</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lamvar<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Γ</span> <span class="bound">x</span> <span class="bound">e</span> <span class="bound">S</span> <span class="main">.</span> map_of <span class="bound">Γ</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">e</span> <span class="main">⟹</span> isVal <span class="bound">e</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> Var <span class="bound">x</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> Var <span class="bound">x</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="bound">x</span> <span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span> <span class="main">,</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> var<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Γ</span> <span class="bound">x</span> <span class="bound">e</span> <span class="bound">S</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> domA <span class="bound">Γ</span> <span class="main">⟹</span> isVal <span class="bound">e</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span><span class="main">,</span> Upd <span class="bound">x</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span><span class="main">,</span> Upd <span class="bound">x</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">#</span> <span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span> <span class="main">,</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> let<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Δ</span> <span class="bound">Γ</span> <span class="bound">e</span> <span class="bound">S</span> <span class="main">.</span> atom <span class="main">`</span> domA <span class="bound">Δ</span> <span class="main">♯*</span> <span class="bound">Γ</span> <span class="main">⟹</span> atom <span class="main">`</span> domA <span class="bound">Δ</span> <span class="main">♯*</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> Let <span class="bound">Δ</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> Let <span class="bound">Δ</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="bound">Δ</span><span class="main">@</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> if<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">scrut</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">S</span><span class="main">.</span> <span class="free">I</span>  <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">scrut</span> <span class="main">?</span> <span class="bound">e1</span> <span class="main">:</span> <span class="bound">e2</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">scrut</span> <span class="main">?</span> <span class="bound">e1</span> <span class="main">:</span> <span class="bound">e2</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">scrut</span><span class="main">,</span> Alts <span class="bound">e1</span> <span class="bound">e2</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> if<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">b</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">S</span><span class="main">.</span> <span class="free">I</span>  <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> Bool <span class="bound">b</span><span class="main">,</span> Alts <span class="bound">e1</span> <span class="bound">e2</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> Bool <span class="bound">b</span><span class="main">,</span> Alts <span class="bound">e1</span> <span class="bound">e2</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="bound">e1</span> <span class="keyword1">else</span> <span class="bound">e2</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span> <span class="bound">c'</span> <span class="bound">c''</span><span class="main">.</span> <span class="bound">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">c'</span> <span class="main">⟹</span> <span class="bound">c'</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">c''</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">c'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c'</span> <span class="bound">c''</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">c''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="main">∨</span> <span class="main">(</span>boring_step <span class="free">c'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c''</span><span class="main">.</span> <span class="free">c'</span> <span class="main">⇒</span> <span class="bound">c''</span> <span class="main">⟶</span> <span class="free">P</span> <span class="free">c</span> <span class="bound">c''</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_invariant_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> step<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c</span> <span class="skolem">y</span>"</span></span>

      <span class="keyword1"><span class="command">note</span></span> t <span class="main">=</span> trans<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">y</span>›</span></span> r_into_rtranclp<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">step</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">⇒</span> <span class="skolem">z</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">⇒</span> <span class="skolem">z</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> app<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">c</span> <span class="skolem">y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> t<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> app<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">c</span> <span class="skolem">y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> t<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">S</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"isVal <span class="skolem">e</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> var<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>7<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">c</span> <span class="skolem">y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> t<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span> <span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> var<span class="hidden">⇩</span><sub>1</sub> True lambda_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"boring_step <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span> <span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> var<span class="hidden">⇩</span><sub>1</sub> True assms<span class="main">(</span>8<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">c</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span> <span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">y</span>›</span></span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> var<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.cases<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> var<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>9<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">c</span> <span class="skolem">y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> t<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> let<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>10<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">c</span> <span class="skolem">y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> t<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> if<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>11<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">c</span> <span class="skolem">y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> t<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> if<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>12<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">c</span> <span class="skolem">y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> t<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"boring_step <span class="skolem">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c''</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">⇒</span> <span class="bound">c''</span> <span class="main">⟶</span> <span class="free">P</span> <span class="free">c</span> <span class="bound">c''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">⇒</span> <span class="skolem">z</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Sestoft-step_induction"><span class="command">lemma</span></span> step_induction<span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> app<span class="hidden">⇩</span><sub>1</sub> app<span class="hidden">⇩</span><sub>2</sub> thunk lamvar var<span class="hidden">⇩</span><sub>2</sub> let<span class="hidden">⇩</span><sub>1</sub> if<span class="hidden">⇩</span><sub>1</sub> if<span class="hidden">⇩</span><sub>2</sub> refl trans<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> boring_step <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> app<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Γ</span> <span class="bound">e</span> <span class="bound">x</span> <span class="bound">S</span> <span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> App <span class="bound">e</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span>  <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span> <span class="main">,</span> Arg <span class="bound">x</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> app<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Γ</span> <span class="bound">y</span> <span class="bound">e</span> <span class="bound">x</span> <span class="bound">S</span> <span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="bound">y</span><span class="main">].</span> <span class="bound">e</span><span class="main">,</span> Arg <span class="bound">x</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span><span class="main">[</span><span class="bound">y</span> <span class="main">::=</span> <span class="bound">x</span><span class="main">]</span> <span class="main">,</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thunk<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Γ</span> <span class="bound">x</span> <span class="bound">e</span> <span class="bound">S</span> <span class="main">.</span> map_of <span class="bound">Γ</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">e</span> <span class="main">⟹</span> <span class="main">¬</span> isVal <span class="bound">e</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> Var <span class="bound">x</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>delete <span class="bound">x</span> <span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span> <span class="main">,</span> Upd <span class="bound">x</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lamvar<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Γ</span> <span class="bound">x</span> <span class="bound">e</span> <span class="bound">S</span> <span class="main">.</span> map_of <span class="bound">Γ</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">e</span> <span class="main">⟹</span> isVal <span class="bound">e</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> Var <span class="bound">x</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="bound">x</span> <span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span> <span class="main">,</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> var<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Γ</span> <span class="bound">x</span> <span class="bound">e</span> <span class="bound">S</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> domA <span class="bound">Γ</span> <span class="main">⟹</span> isVal <span class="bound">e</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span><span class="main">,</span> Upd <span class="bound">x</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">#</span> <span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span> <span class="main">,</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> let<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Δ</span> <span class="bound">Γ</span> <span class="bound">e</span> <span class="bound">S</span> <span class="main">.</span> atom <span class="main">`</span> domA <span class="bound">Δ</span> <span class="main">♯*</span> <span class="bound">Γ</span> <span class="main">⟹</span> atom <span class="main">`</span> domA <span class="bound">Δ</span> <span class="main">♯*</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> Let <span class="bound">Δ</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="bound">Δ</span><span class="main">@</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> if<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">scrut</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">S</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">scrut</span> <span class="main">?</span> <span class="bound">e1</span> <span class="main">:</span> <span class="bound">e2</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">scrut</span><span class="main">,</span> Alts <span class="bound">e1</span> <span class="bound">e2</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> if<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">b</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">S</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> Bool <span class="bound">b</span><span class="main">,</span> Alts <span class="bound">e1</span> <span class="bound">e2</span> <span class="main">#</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="bound">e1</span> <span class="keyword1">else</span> <span class="bound">e2</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span> <span class="bound">c'</span> <span class="bound">c''</span><span class="main">.</span> <span class="bound">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">c'</span> <span class="main">⟹</span> <span class="bound">c'</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">c''</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">c'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c'</span> <span class="bound">c''</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">c''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> step_invariant_induction<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ invariant_True<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Equivariance›</span></span>

<span class="keyword1" id="Sestoft-step_eqvt"><span class="command">lemma</span></span> step_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> step <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> step.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> step.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> step.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> permute_boolE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span><span class="free"><span class="free">π</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pemute_minus_self<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> step.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> permute_boolE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span><span class="free"><span class="free">π</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pemute_minus_self<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> permute_boolE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span><span class="free"><span class="free">π</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pemute_minus_self<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> step.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> permute_boolE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span><span class="free"><span class="free">π</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pemute_minus_self<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> permute_boolE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span><span class="free"><span class="free">π</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pemute_minus_self<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> step.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> step.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1" id="Sestoft-closed_invariant"><span class="command">lemma</span></span> closed_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invariant step closed"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">c'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⇒</span> <span class="skolem">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">c</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subst_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fv_delete_subset<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_of_Some_fv_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sestoft-heap_upds_ok_invariant"><span class="command">lemma</span></span> heap_upds_ok_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invariant step heap_upds_ok_conf"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">c'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⇒</span> <span class="skolem">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok_conf <span class="skolem">c</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok_conf <span class="skolem">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SestoftCorrect">
<div class="head">
<h1>Theory SestoftCorrect</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> SestoftCorrect
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#BalancedTraces">BalancedTraces</a> <a href="../../launchbury/theories/#Launchbury">Launchbury.Launchbury</a> <a href="#Sestoft">Sestoft</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1" id="SestoftCorrect-lemma_2"><span class="command">lemma</span></span> lemma_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">L</span> <span class="main">∪</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">Δ</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>reds.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lambda <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">L</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Application <span class="skolem">y</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">Θ</span> <span class="skolem">z</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Γ</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> prem1<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">from</span></span> prem1 reds_pres_closed<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">:</span> <span class="skolem">e</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">L</span></sub><span class="hidden">⇙</span> <span class="skolem">Δ</span> <span class="main">:</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e'</span>›</span></span><span class="main">]</span> reds_doesnt_forget<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">:</span> <span class="skolem">e</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">L</span></sub><span class="hidden">⇙</span> <span class="skolem">Δ</span> <span class="main">:</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e'</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> prem2<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subst_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e'</span><span class="main">,</span> Arg <span class="skolem">x</span><span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Application.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⇒</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">[</span><span class="skolem">y</span> <span class="main">::=</span> <span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Θ</span><span class="main">,</span> <span class="skolem">z</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Application.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Variable <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">z</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Variable<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isVal <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> result_evaluated<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds_avoids_live<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Variable<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Γ</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">L</span><span class="main">)</span> <span class="main">∪</span> domA <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fv_delete_subset<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_of_Some_fv_subset<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">z</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Variable.IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span><span class="main">#</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">z</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Δ</span>›</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> var<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bool <span class="skolem">Γ</span> <span class="skolem">b</span> <span class="skolem">L</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfThenElse <span class="skolem">Γ</span> <span class="skolem">scrut</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">b</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Θ</span> <span class="skolem">z</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">,</span> Alts <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span><span class="skolem">S</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> IfThenElse.prems
  <span class="keyword1"><span class="command">have</span></span> prem1<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">,</span> Alts <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span><span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">,</span> Alts <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span><span class="skolem">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> Bool <span class="skolem">b</span><span class="main">,</span> Alts <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span><span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IfThenElse.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> Bool <span class="skolem">b</span><span class="main">,</span> Alts <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span><span class="skolem">S</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> prem1 reds_pres_closed<span class="main">[</span><span class="operator">OF</span> IfThenElse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> reds_doesnt_forget<span class="main">[</span><span class="operator">OF</span> IfThenElse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> prem2<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Δ</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Θ</span><span class="main">,</span> <span class="skolem">z</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IfThenElse.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">as</span> <span class="skolem">Γ</span> <span class="skolem">L</span> <span class="skolem">body</span> <span class="skolem">Δ</span> <span class="skolem">z</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Let<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">body</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> Let<span class="main">(</span>1<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">as</span> <span class="main">♯*</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> Let<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">as</span> <span class="main">∩</span> fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">L</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fresh_distinct_fv<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">as</span> <span class="main">∩</span> <span class="main">(</span>set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> domA_fv_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Let<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">as</span> <span class="main">∩</span> fv <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">as</span> <span class="main">♯*</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fv_def fresh_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Terms.Let <span class="skolem">as</span> <span class="skolem">body</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">body</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">z</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let.IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> trace <span class="main">=</span> <span class="quoted"><span class="quoted">"conf list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">stack</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"conf <span class="main">⇒</span> stack"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
                 
<span class="keyword1"><span class="command">interpretation</span></span> traces <span class="quoted">step</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace_syn</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⇒<span class="hidden">⇧</span><sup>*</sup>⇘</span>_<span class="keyword1">⇙</span> _"</span> <span class="main">[</span>50<span class="main">,</span>50<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace_syn</span> <span class="main">≡</span> trace"</span></span>

<span class="keyword1" id="SestoftCorrect-conf_trace_induct_final"><span class="command">lemma</span></span> conf_trace_induct_final<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> trace_nil trace_cons<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> ⇒<span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="free">T</span></sub><span class="hidden">⇙</span> <span class="free">final</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">Γ</span> <span class="bound">e</span> <span class="bound">S</span><span class="main">.</span> <span class="free">final</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">Γ</span> <span class="bound">e</span> <span class="bound">S</span> <span class="main">[]</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">e</span> <span class="bound">S</span> <span class="bound">T</span> <span class="bound">Γ'</span> <span class="bound">e'</span> <span class="bound">S'</span><span class="main">.</span> <span class="main">(</span><span class="bound">Γ'</span><span class="main">,</span> <span class="bound">e'</span><span class="main">,</span> <span class="bound">S'</span><span class="main">)</span> ⇒<span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="bound">T</span></sub><span class="hidden">⇙</span> <span class="free">final</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">Γ'</span> <span class="bound">e'</span> <span class="bound">S'</span> <span class="bound">T</span> <span class="free">final</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">Γ'</span><span class="main">,</span> <span class="bound">e'</span><span class="main">,</span> <span class="bound">S'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">Γ</span> <span class="bound">e</span> <span class="bound">S</span> <span class="main">(</span><span class="main">(</span><span class="bound">Γ'</span><span class="main">,</span> <span class="bound">e'</span><span class="main">,</span> <span class="bound">S'</span><span class="main">)</span> <span class="main">#</span> <span class="bound">T</span><span class="main">)</span> <span class="free">final</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">Γ</span> <span class="free">e</span> <span class="free">S</span> <span class="free">T</span> <span class="free">final</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">final</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct_final<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> balance_trace <span class="quoted">step</span>  <span class="quoted">stack</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">bal_syn</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⇒<span class="hidden">⇧</span><sup>b</sup><span class="hidden">⇧</span><sup>*</sup>⇘</span>_<span class="keyword1">⇙</span> _"</span> <span class="main">[</span>50<span class="main">,</span>50<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bal_syn</span> <span class="main">≡</span> bal"</span></span>

<span class="keyword1" id="SestoftCorrect-isVal_stops"><span class="command">lemma</span></span> isVal_stops<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"isVal <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> ⇒<span class="hidden">⇧</span><sup>b</sup><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="free">T</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">Δ</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span><span class="main">=</span><span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> balE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> trace.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

 
<span class="keyword1" id="SestoftCorrect-Ball_subst"><span class="command">lemma</span></span> Ball_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>set <span class="main">(</span><span class="free">Γ</span><span class="main">[</span><span class="free">y</span><span class="keyword1">::h=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>set <span class="free">Γ</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">p</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftCorrect-lemma_3"><span class="command">lemma</span></span> lemma_3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> ⇒<span class="hidden">⇧</span><sup>b</sup><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="free">T</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">Δ</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"isVal <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub>upds_list <span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">length</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">T</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">S</span> <span class="skolem">Δ</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> ⇒<span class="hidden">⇧</span><sup>b</sup><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="skolem">T</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">z</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> ⇒<span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="skolem">T</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">z</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c'</span><span class="main">∈</span>set <span class="skolem">T</span><span class="main">.</span> <span class="skolem">S</span> <span class="main">≲</span> stack <span class="bound">c'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bal.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> trace_nil
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="skolem">z</span>›</span></span>  trace_nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reds_isValI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>trace_cons <span class="skolem">conf'</span> <span class="skolem">T'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">T</span> <span class="main">=</span> <span class="skolem">conf'</span> <span class="main">#</span> <span class="skolem">T'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">c'</span><span class="main">∈</span>set <span class="skolem">T</span><span class="main">.</span> <span class="skolem">S</span> <span class="main">≲</span> stack <span class="bound">c'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≲</span> stack <span class="skolem">conf'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">conf'</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">e</span> <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T'</span> <span class="main">=</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">#</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prem1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> ⇒<span class="hidden">⇧</span><sup>b</sup><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span></sub><span class="hidden">⇙</span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⇒</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prem2<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> ⇒<span class="hidden">⇧</span><sup>b</sup><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">z</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bal_consE<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  <span class="quoted"><span class="quoted">‹bal <span class="main">_</span> <span class="skolem">T</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> app<span class="hidden">⇩</span><sub>1</sub> trace_cons<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">T</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">T'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> length <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;</span> length <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">from</span></span> prem1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stack <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span>  Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>  bal_stackD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> prem2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stack <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bal_stackD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⇒</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span>›</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e'</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">[</span><span class="skolem">y</span> <span class="main">::=</span> <span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> exp_assn.eq_iff<span class="main">)</span>

      
      <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> length <span class="skolem">T</span>›</span></span> prem1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">:</span> <span class="skolem">e</span> ⇓<span class="hidden">⇘</span><sub>upds_list <span class="skolem">S</span></sub><span class="hidden">⇙</span> <span class="skolem">Δ'</span> <span class="main">:</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;</span> length <span class="skolem">T</span>›</span></span> prem2<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="skolem">z</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ'</span> <span class="main">:</span> <span class="skolem">e'</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span> ⇓<span class="hidden">⇘</span><sub>upds_list <span class="skolem">S</span></sub><span class="hidden">⇙</span> <span class="skolem">Δ</span> <span class="main">:</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> app<span class="hidden">⇩</span><sub>1</sub>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds_ApplicationI<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">y</span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">S'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">conf'</span> <span class="main">=</span><span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">_</span> <span class="main">#</span> <span class="skolem">S'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">≲</span> stack <span class="skolem">conf'</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extends_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T'</span> <span class="main">=</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">#</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prem1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> ⇒<span class="hidden">⇧</span><sup>b</sup><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span></sub><span class="hidden">⇙</span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⇒</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prem2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> ⇒<span class="hidden">⇧</span><sup>b</sup><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">z</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bal_consE<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  <span class="quoted"><span class="quoted">‹bal <span class="main">_</span> <span class="skolem">T</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> var<span class="hidden">⇩</span><sub>1</sub> trace_cons<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
      
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">T</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">T'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> length <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;</span> length <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">from</span></span> prem1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stack <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>  bal_stackD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> prem2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stack <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bal_stackD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⇒</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span>›</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">z'</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">z'</span><span class="main">)</span><span class="main">#</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">z'</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"isVal <span class="skolem">z'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> exp_assn.eq_iff<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="skolem">z'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> prem2<span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> isVal_stops<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> prem2 <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span><span class="main">#</span><span class="skolem">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          
      <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> length <span class="skolem">T</span>›</span></span> prem1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">z'</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span>  <span class="quoted"><span class="quoted">‹isVal <span class="skolem">z</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"delete <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="main">:</span> <span class="skolem">e</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">x</span> <span class="main">#</span> upds_list <span class="skolem">S</span></sub><span class="hidden">⇙</span> <span class="skolem">Δ'</span> <span class="main">:</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> var<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">Δ</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">x</span> <span class="skolem">S'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">conf'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">_</span> <span class="main">#</span> <span class="skolem">S'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">≲</span> stack <span class="skolem">conf'</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extends_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">scrut</span>  <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T'</span> <span class="main">=</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">#</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prem1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">,</span> Alts <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> ⇒<span class="hidden">⇧</span><sup>b</sup><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span></sub><span class="hidden">⇙</span> <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⇒</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prem2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> ⇒<span class="hidden">⇧</span><sup>b</sup><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">z</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bal_consE<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  <span class="quoted"><span class="quoted">‹bal <span class="main">_</span> <span class="skolem">T</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> if<span class="hidden">⇩</span><sub>1</sub> trace_cons<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>  <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">T</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">T'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> length <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;</span> length <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">from</span></span> prem1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stack <span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> Alts <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>  bal_stackD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> prem2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stack <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bal_stackD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⇒</span> <span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span>›</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> Bool <span class="skolem">b</span><span class="main">,</span> Alts <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> exp_assn.eq_iff<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> length <span class="skolem">T</span>›</span></span> prem1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="main"><span class="main">]</span></span> isVal_Bool<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">:</span> <span class="skolem">scrut</span> ⇓<span class="hidden">⇘</span><sub>upds_list <span class="skolem">S</span></sub><span class="hidden">⇙</span> <span class="skolem">Δ'</span> <span class="main">:</span> Bool <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;</span> length <span class="skolem">T</span>›</span></span> prem2<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="skolem">z</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ'</span> <span class="main">:</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⇓<span class="hidden">⇘</span><sub>upds_list <span class="skolem">S</span></sub><span class="hidden">⇙</span> <span class="skolem">Δ</span> <span class="main">:</span> <span class="skolem">z</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> if<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds.IfThenElse<span class="main">)</span>
   <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">b</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">S'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">conf'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">_</span> <span class="main">#</span> <span class="skolem">S'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">≲</span> stack <span class="skolem">conf'</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extends_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>let<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">as</span> <span class="skolem">e</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">T</span> <span class="main">=</span> <span class="skolem">conf'</span> <span class="main">#</span> <span class="skolem">T'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">T'</span> <span class="main">&lt;</span> length <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> ⇒<span class="hidden">⇧</span><sup>b</sup><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="skolem">T'</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">z</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> trace_cons <span class="quoted"><span class="quoted">‹<span class="skolem">conf'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">c'</span><span class="main">∈</span>set <span class="skolem">T</span><span class="main">.</span> <span class="skolem">S</span> <span class="main">≲</span> stack <span class="bound">c'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="skolem">z</span>›</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span> <span class="main">:</span> <span class="skolem">e</span> ⇓<span class="hidden">⇘</span><sub>upds_list <span class="skolem">S</span></sub><span class="hidden">⇙</span> <span class="skolem">Δ</span> <span class="main">:</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹atom <span class="main">`</span> domA <span class="skolem">as</span> <span class="main">♯*</span> <span class="skolem">Γ</span>›</span></span>  <span class="quoted"><span class="quoted">‹atom <span class="main">`</span> domA <span class="skolem">as</span> <span class="main">♯*</span> <span class="skolem">S</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">as</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> upds_list <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> let<span class="hidden">⇩</span><sub>1</sub>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds.Let<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SestoftCorrect-dummy_stack_extended"><span class="command">lemma</span></span> dummy_stack_extended<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">S</span> <span class="main">⊆</span>  Dummy <span class="main">`</span> UNIV <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> Dummy <span class="main">`</span> UNIV <span class="main">⟹</span> <span class="main">(</span><span class="free">S</span> <span class="main">≲</span> <span class="free">x</span> <span class="main">#</span> <span class="free">S'</span><span class="main">)</span> <span class="main">⟷</span>  <span class="free">S</span> <span class="main">≲</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extends_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">S''</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Arg <span class="free">x</span> <span class="main">∉</span> range Dummy"</span></span>  <span class="quoted"><span class="quoted">"Upd <span class="free">x</span> <span class="main">∉</span> range Dummy"</span></span>   <span class="quoted"><span class="quoted">"Alts <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> range Dummy"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftCorrect-dummy_stack_balanced"><span class="command">lemma</span></span> dummy_stack_balanced<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">S</span> <span class="main">⊆</span> Dummy <span class="main">`</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">Δ</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">T</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> ⇒<span class="hidden">⇧</span><sup>b</sup><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="free">T</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">Δ</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> build_trace<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> ⇒<span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="skolem">T</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">Δ</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c'</span><span class="main">∈</span>set <span class="skolem">T</span><span class="main">.</span> stack <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">≲</span> stack <span class="bound">c'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conjunct1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> traces_list_all<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> step.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dummy_stack_extended<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹set <span class="free">S</span> <span class="main">⊆</span> Dummy <span class="main">`</span> UNIV›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> ⇒<span class="hidden">⇧</span><sup>b</sup><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇘</span><sub><span class="skolem">T</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">Δ</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> balI<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Arity">
<div class="head">
<h1>Theory Arity</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Arity
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Launchbury/HOLCF-Join-Classes.html">Launchbury.HOLCF-Join-Classes</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">typedef</span></span> Arity <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> nat set"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> Rep_Arity to_Arity <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_Arity

<span class="comment1">(*
instantiation Arity :: order
begin
lift_definition less_eq_Arity :: "Arity ⇒ Arity ⇒ bool" is "λ x y . x ≤ y".
lift_definition less_Arity :: "Arity ⇒ Arity ⇒ bool" is "λ x y . x &lt; y".
instance
  apply standard
  apply (transfer, fastforce)+
  done
end
*)</span>

<span class="keyword1"><span class="command">instantiation</span></span> Arity <span class="main">::</span> <span class="quoted">po</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">below_Arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Arity <span class="main">⇒</span> Arity <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> Arity <span class="main">::</span> <span class="quoted">chfin</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Arity"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"chain <span class="skolem">S</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ARG_MIN</span> Rep_Arity <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> range <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_min_natI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ARG_MIN</span> Rep_Arity <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max_in_chain <span class="skolem">n</span> <span class="skolem">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> max_in_chainI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="skolem">n</span> <span class="main">⊑</span> <span class="skolem">S</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹chain <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chain_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_Arity <span class="main">(</span><span class="skolem">S</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> Rep_Arity <span class="main">(</span><span class="skolem">S</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> n image_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> full_types<span class="main"><span class="main">)</span></span> arg_min_nat_lemma UNIV_I mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="skolem">j</span> <span class="main">⊑</span> <span class="skolem">S</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command">finally</span></span>  
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">S</span> <span class="skolem">j</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> max_in_chain <span class="bound">n</span> <span class="skolem">S</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span> Arity <span class="main">::</span> <span class="quoted">cpo</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> inc_Arity <span class="main">::</span> <span class="quoted"><span class="quoted">"Arity <span class="main">⇒</span> Arity"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">Suc</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> pred_Arity <span class="main">::</span> <span class="quoted"><span class="quoted">"Arity <span class="main">⇒</span> Arity"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Arity-inc_Arity_cont"><span class="command">lemma</span></span> inc_Arity_cont<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cont inc_Arity"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> chfindom_monofun2cont<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monofunI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Arity-pred_Arity_cont"><span class="command">lemma</span></span> pred_Arity_cont<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cont pred_Arity"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> chfindom_monofun2cont<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monofunI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Arity <span class="main">→</span> Arity"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inc</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> inc_Arity <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Arity <span class="main">→</span> Arity"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pred</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> pred_Arity <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Arity-inc_inj"><span class="command">lemma</span></span> inc_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inc<span class="main">⋅</span><span class="free">n</span> <span class="main">=</span> inc<span class="main">⋅</span><span class="free">n'</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_def pred_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Arity-pred_inc"><span class="command">lemma</span></span> pred_inc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pred<span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_def pred_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Arity-inc_below_inc"><span class="command">lemma</span></span> inc_below_inc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inc<span class="main">⋅</span><span class="free">a</span> <span class="main">⊑</span> inc<span class="main">⋅</span><span class="free">b</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">⊑</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_def pred_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Arity-inc_below_below_pred"><span class="command">lemma</span></span> inc_below_below_pred<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inc<span class="main">⋅</span><span class="free">a</span> <span class="main">⊑</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊑</span> pred <span class="main">⋅</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_def pred_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Arity-Rep_Arity_inc"><span class="command">lemma</span></span> Rep_Arity_inc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_Arity <span class="main">(</span>inc<span class="main">⋅</span><span class="free">a'</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Rep_Arity <span class="free">a'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_def pred_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> Arity <span class="main">::</span> <span class="quoted">zero</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">zero_Arity</span> <span class="main">::</span> <span class="quoted">Arity</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="main">0</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">instance</span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Arity <span class="main">::</span> <span class="quoted">one</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">one_Arity</span> <span class="main">::</span> <span class="quoted">Arity</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="main">1</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Arity-one_is_inc_zero"><span class="command">lemma</span></span> one_is_inc_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> inc<span class="main">⋅</span><span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Arity-inc_not_0"><span class="command">lemma</span></span> inc_not_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inc<span class="main">⋅</span><span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_def pred_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
 
<span class="keyword1" id="Arity-pred_0"><span class="command">lemma</span></span> pred_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pred<span class="main">⋅</span><span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_def pred_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  
<span class="keyword1" id="Arity-Arity_ind"><span class="command">lemma</span></span> Arity_ind<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>inc<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nat.induct<span class="main">)</span> 
 
<span class="keyword1" id="Arity-Arity_total"><span class="command">lemma</span></span> Arity_total<span class="main">:</span>   
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">Arity</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span> Arity <span class="main">::</span> <span class="quoted">Finite_Join_cpo</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">Arity</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compatible <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Arity_total compatibleI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Arity-Arity_zero_top"><span class="command">lemma</span></span> Arity_zero_top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::</span> Arity<span class="main">)</span> <span class="main">⊑</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Arity-Arity_above_top"><span class="command">lemma</span></span> Arity_above_top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">a</span> <span class="main">::</span> Arity<span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Arity-Arity_zero_join"><span class="command">lemma</span></span> Arity_zero_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::</span> Arity<span class="main">)</span> <span class="main">⊔</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
<span class="keyword1" id="Arity-Arity_zero_join2"><span class="command">lemma</span></span> Arity_zero_join2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">x</span> <span class="main">::</span> Arity<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Arity-Arity_up_zero_join"><span class="command">lemma</span></span> Arity_up_zero_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::</span> Arity<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">)</span> <span class="main">⊔</span> up<span class="main">⋅</span><span class="main">0</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Arity-Arity_up_zero_join2"><span class="command">lemma</span></span> Arity_up_zero_join2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"up<span class="main">⋅</span><span class="main">0</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">x</span> <span class="main">::</span> Arity<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">)</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Arity-up_zero_top"><span class="command">lemma</span></span> up_zero_top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> up<span class="main">⋅</span><span class="main">(</span><span class="main">0</span><span class="main">::</span>Arity<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Arity-Arity_above_up_top"><span class="command">lemma</span></span> Arity_above_up_top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"up<span class="main">⋅</span><span class="main">0</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">a</span> <span class="main">::</span> Arity<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Arity_up_zero_join2 join_self_below<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1" id="Arity-Arity_exhaust"><span class="command">lemma</span></span> Arity_exhaust<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> inc <span class="main">⋅</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Abs_cfun_inverse2 Arity.inc_def Rep_Arity_inverse inc_Arity.abs_eq inc_Arity_cont list_decode.cases zero_Arity_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="AEnv">
<div class="head">
<h1>Theory AEnv</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> AEnv
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Arity">Arity</a> <a href="../../launchbury/theories/#Vars">Launchbury.Vars</a> <a href="../../launchbury/theories/#Env">Launchbury.Env</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* TODO: This could mostly be a Env-Nominal module *)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> AEnv <span class="main">=</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> Arity<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Arity-Nominal">
<div class="head">
<h1>Theory Arity-Nominal</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Arity-Nominal"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Arity">Arity</a> <span class="quoted">"<a href="../Launchbury/Nominal-HOLCF.html">Launchbury.Nominal-HOLCF</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Arity-Nominal-join_eqvt"><span class="command">lemma</span></span> join_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">y</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>Finite_Join_cpo<span class="main">,</span> cont_pt<span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_joinI<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_below_to_right<span class="main">)</span>


<span class="keyword1"><span class="command">instantiation</span></span> Arity <span class="main">::</span> <span class="quoted">pure</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">::</span>Arity<span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_Arity_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">instance</span></span> Arity <span class="main">::</span> <span class="quoted">cont_pt</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pure_permute_id<span class="main">)</span>
<span class="keyword1"><span class="command">instance</span></span> Arity <span class="main">::</span> <span class="quoted">pure_cont_pt</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ArityAnalysisSig">
<div class="head">
<h1>Theory ArityAnalysisSig</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ArityAnalysisSig
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../launchbury/theories/#Terms">Launchbury.Terms</a> <a href="#AEnv">AEnv</a> <span class="quoted">"<a href="Arity-Nominal.html">Arity-Nominal</a>"</span> <span class="quoted">"<a href="../Launchbury/Nominal-HOLCF.html">Launchbury.Nominal-HOLCF</a>"</span>  <a href="../../launchbury/theories/#Substitution">Launchbury.Substitution</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> ArityAnalysis <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Aexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> Arity <span class="main">→</span> AEnv"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Aexp_syn</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒜⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span><span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">a</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="free">Aexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Aexp_bot_syn</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒜<span class="hidden">⇧</span><sup>⊥</sup>⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇧</span><sup>⊥</sup><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">a</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> fup<span class="main">⋅</span><span class="main">(</span><span class="free">Aexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> ArityAnalysisHeap <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Aheap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> exp <span class="main">⇒</span> Arity <span class="main">→</span> AEnv"</span></span>

<span class="keyword1"><span class="command">locale</span></span> EdomArityAnalysis <span class="main">=</span> ArityAnalysis <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> Aexp_edom<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">e</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="ArityAnalysisSig-fup_Aexp_edom"><span class="command">lemma</span></span> fup_Aexp_edom<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>𝒜<span class="hidden">⇧</span><sup>⊥</sup><span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>
  
  <span class="keyword1" id="ArityAnalysisSig-Aexp_fresh_bot"><span class="command">lemma</span></span> Aexp_fresh_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">v</span> <span class="main">♯</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span> <span class="free">v</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> fv <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fv_not_fresh<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Aexp_edom <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> edom <span class="main">(</span>𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> edom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> ArityAnalysisHeapEqvt <span class="main">=</span> ArityAnalysisHeap <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> Aheap_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">Aheap</span> <span class="main">=</span> <span class="free">Aheap</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ArityAnalysisAbinds">
<div class="head">
<h1>Theory ArityAnalysisAbinds</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ArityAnalysisAbinds
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#ArityAnalysisSig">ArityAnalysisSig</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> ArityAnalysis
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lifting arity analysis to recursive groups›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ABind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> exp <span class="main">⇒</span> <span class="main">(</span>AEnv <span class="main">→</span> AEnv<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ABind</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ae<span class="main">.</span> fup<span class="main">⋅</span><span class="main">(</span><span class="free">Aexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ae</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ArityAnalysisAbinds-ABind_eq"><span class="command">lemma</span></span> ABind_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ABind <span class="free">v</span> <span class="free">e</span> <span class="main">⋅</span> <span class="free">ae</span> <span class="main">=</span> 𝒜<span class="hidden">⇧</span><sup>⊥</sup><span class="hidden">⇘</span><sub><span class="free">ae</span> <span class="free">v</span></sub><span class="hidden">⇙</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ABind_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cont_fun<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ABinds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> <span class="main">(</span>AEnv <span class="main">→</span> AEnv<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ABinds</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
     <span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">ABinds</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">binds</span></span></span><span class="main">)</span> <span class="main">=</span> ABind <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⊔</span> <span class="free">ABinds</span> <span class="main">(</span>delete <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">binds</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ArityAnalysisAbinds-ABinds_strict"><span class="command">lemma</span></span> ABinds_strict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">=</span><span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ABinds.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ArityAnalysisAbinds-Abinds_reorder1"><span class="command">lemma</span></span> Abinds_reorder1<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">e</span> <span class="main">⟹</span> ABinds <span class="free">Γ</span> <span class="main">=</span> ABind <span class="free">v</span> <span class="free">e</span> <span class="main">⊔</span> ABinds <span class="main">(</span>delete <span class="free">v</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ABinds.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_twist<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisAbinds-ABind_below_ABinds"><span class="command">lemma</span></span> ABind_below_ABinds<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">e</span> <span class="main">⟹</span> ABind <span class="free">v</span> <span class="free">e</span> <span class="main">⊑</span> ABinds <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"HOLCF-Join-Classes.join_above1"</span> ArityAnalysis.Abinds_reorder1<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisAbinds-Abinds_reorder"><span class="command">lemma</span></span> Abinds_reorder<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="main">=</span> map_of <span class="free">Δ</span> <span class="main">⟹</span> ABinds <span class="free">Γ</span> <span class="main">=</span> ABinds <span class="free">Δ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span>  <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ABinds.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">v</span> <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">Δ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="main">(</span><span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">=</span> map_of <span class="skolem">Δ</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_of <span class="main">(</span><span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map_of <span class="skolem">Δ</span><span class="main">)</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">=</span> map_of <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> delete_set_none <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">=</span> ABinds <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="main">(</span><span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">=</span> map_of <span class="skolem">Δ</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">Δ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_of_Cons_code<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="skolem">Δ</span> <span class="main">=</span> ABind <span class="skolem">v</span> <span class="skolem">e</span> <span class="main">⊔</span> ABinds <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abinds_reorder1<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*
lemma ABinds_above_arg: "ae ⊑ ABinds Γ ⋅ ae"
proof (induction rule:ABinds.induct)
  show "⊥ ⊑ ABinds []⋅ae" by auto
next
  fix v e Γ
  assume assm: "ae ⊑ ABinds (delete v Γ)⋅ae"
  also have "… ⊑ ABinds ((v, e) # Γ)⋅ae"  by auto
  finally show "ae ⊑ ABinds ((v, e) # Γ)⋅ae" by this simp
qed
*)</span>

<span class="keyword1" id="ArityAnalysisAbinds-Abinds_env_cong"><span class="command">lemma</span></span> Abinds_env_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>domA <span class="free">Δ</span> <span class="main">⟹</span> <span class="free">ae</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">ae'</span> <span class="bound">x</span><span class="main">)</span>  <span class="main">⟹</span>  ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="free">ae'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ABinds.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ArityAnalysisAbinds-Abinds_env_restr_cong"><span class="command">lemma</span></span> Abinds_env_restr_cong<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">ae</span> <span class="keyword1">f|`</span> domA <span class="free">Δ</span> <span class="main">=</span> <span class="free">ae'</span> <span class="keyword1">f|`</span> domA <span class="free">Δ</span> <span class="main">⟹</span>  ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="free">ae'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abinds_env_cong<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> env_restr_eqD<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisAbinds-ABinds_env_restr"><span class="command">lemma</span></span> ABinds_env_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span> <span class="keyword1">f|`</span> domA <span class="free">Δ</span><span class="main">)</span> <span class="main">=</span> ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abinds_env_restr_cong<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="ArityAnalysisAbinds-Abinds_join_fresh"><span class="command">lemma</span></span> Abinds_join_fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ae'</span> <span class="main">`</span> <span class="main">(</span>domA <span class="free">Δ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">⊥</span><span class="main">}</span> <span class="main">⟹</span>  ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span> <span class="main">⊔</span> <span class="free">ae'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abinds_env_cong<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ArityAnalysisAbinds-ABinds_delete_bot"><span class="command">lemma</span></span> ABinds_delete_bot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> ABinds <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ABinds.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_twist<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisAbinds-ABinds_restr_fresh"><span class="command">lemma</span></span> ABinds_restr_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> <span class="free">S</span> <span class="main">♯*</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span>  <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>ABinds.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join fresh_star_Pair fresh_star_Cons fresh_star_delete<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lookup_env_restr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> ComplI fresh_at_base<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fresh_star_def imageI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ArityAnalysisAbinds-ABinds_restr"><span class="command">lemma</span></span> ABinds_restr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span>  <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>ABinds.induct<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="ArityAnalysisAbinds-ABinds_restr_subst"><span class="command">lemma</span></span> ABinds_restr_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x'</span> <span class="bound">e</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">Aexp</span> <span class="bound">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span><span class="main">⋅</span><span class="bound">a</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">Aexp</span> <span class="bound">e</span><span class="main">⋅</span><span class="bound">a</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Γ</span><span class="main">[</span><span class="free">x</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span><span class="main">⋅</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span>  <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>ABinds.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp join_comm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">join</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="improper">v</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> set_delete_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ArityAnalysisAbinds-Abinds_append_disjoint"><span class="command">lemma</span></span> Abinds_append_disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="free">Δ</span> <span class="main">∩</span> domA <span class="free">Γ</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>  ABinds <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊔</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ABinds.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">v</span> <span class="skolem">e</span> <span class="skolem">Δ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> domA <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"domA <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∩</span> domA <span class="free">Γ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> ABinds <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">Δ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊔</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"delete <span class="skolem">v</span> <span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∉</span> domA <span class="free">Γ</span>›</span></span> delete_not_domA<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" ABinds <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> ABinds <span class="main">(</span><span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Δ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊔</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ArityAnalysisAbinds-ABinds_restr_subset"><span class="command">lemma</span></span> ABinds_restr_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">⟹</span> ABinds <span class="main">(</span>restrictA <span class="free">S</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊑</span> ABinds <span class="main">(</span>restrictA <span class="free">S'</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ABinds.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff  restr_delete_twist <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="ArityAnalysisAbinds-ABinds_restrict_edom"><span class="command">lemma</span></span> ABinds_restrict_edom<span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="main">(</span>restrictA <span class="main">(</span>edom <span class="free">ae</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ABinds.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def restr_delete_twist<span class="main">)</span>
  
<span class="keyword1" id="ArityAnalysisAbinds-ABinds_restrict_below"><span class="command">lemma</span></span> ABinds_restrict_below<span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="main">(</span>restrictA <span class="free">S</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊑</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ABinds.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff  restr_delete_twist <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp join_comm<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisAbinds-ABinds_delete_below"><span class="command">lemma</span></span> ABinds_delete_below<span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊑</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ABinds.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff   delete_twist<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="ArityAnalysisAbinds-ABind_eqvt"><span class="command">lemma</span></span> ABind_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>ArityAnalysis.ABind <span class="free">Aexp</span> <span class="free">v</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> ArityAnalysis.ABind <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Aexp</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqvtI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> ArityAnalysis.ABind_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1" id="ArityAnalysisAbinds-ABinds_eqvt"><span class="command">lemma</span></span> ABinds_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>ArityAnalysis.ABinds <span class="free">Aexp</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> ArityAnalysis.ABinds <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Aexp</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqvtI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ArityAnalysis.ABinds.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ArityAnalysis.ABinds.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ArityAnalysis.ABinds.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">perm_simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ArityAnalysisAbinds-Abinds_cong"><span class="command">lemma</span></span> Abinds_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">heap2</span> <span class="main">⟹</span> <span class="free">aexp1</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">aexp2</span> <span class="bound">e</span><span class="main">)</span> <span class="main">;</span> <span class="free">heap1</span> <span class="main">=</span> <span class="free">heap2</span> <span class="main">⟧</span>
      <span class="main">⟹</span> ArityAnalysis.ABinds <span class="free">aexp1</span> <span class="free">heap1</span> <span class="main">=</span> ArityAnalysis.ABinds <span class="free">aexp2</span> <span class="free">heap2</span>"</span></span>    
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">heap1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">heap2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>ArityAnalysis.ABinds.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ArityAnalysis.ABinds.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">v</span> <span class="skolem">e</span> <span class="skolem">as</span> <span class="skolem">heap2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">⊆</span> snd <span class="main">`</span> set <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dom_delete_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> snd <span class="main">`</span>set <span class="main">(</span><span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> prems<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">aexp1</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">aexp2</span> <span class="bound">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> prems prems<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this refl<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ArityAnalysis.ABinds.simps ArityAnalysis.ABind_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> EdomArityAnalysis
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1" id="ArityAnalysisAbinds-fup_Aexp_lookup_fresh"><span class="command">lemma</span></span> fup_Aexp_lookup_fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">v</span> <span class="main">♯</span> <span class="free">e</span> <span class="main">⟹</span> <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>
  
  <span class="keyword1" id="ArityAnalysisAbinds-edom_AnalBinds"><span class="command">lemma</span></span> edom_AnalBinds<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ABinds.induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fup_Aexp_edom<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fv_delete_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ArityAnalysisSpec">
<div class="head">
<h1>Theory ArityAnalysisSpec</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ArityAnalysisSpec
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#ArityAnalysisAbinds">ArityAnalysisAbinds</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> SubstArityAnalysis <span class="main">=</span> EdomArityAnalysis <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> Aexp_subst_restr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ArityAnalysisSafe <span class="main">=</span> SubstArityAnalysis <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Aexp_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"up <span class="main">⋅</span> <span class="free">n</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Aexp_App<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="free">e</span> <span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">⊔</span> esing <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="main">⊑</span>  <span class="free">Aexp</span> <span class="main">(</span>App <span class="free">e</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Aexp_Lam<span class="main">:</span> <span class="quoted"><span class="quoted">"env_delete <span class="free">y</span> <span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span> <span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">Aexp</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Aexp_IfThenElse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="free">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e1</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e2</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊑</span> <span class="free">Aexp</span> <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ArityAnalysisHeapSafe <span class="main">=</span> ArityAnalysisSafe <span class="main">+</span> ArityAnalysisHeapEqvt <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> edom_Aheap<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span> <span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Aheap_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∉</span> domA <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">Aheap</span> <span class="free">Γ</span><span class="main">[</span><span class="free">x</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span> <span class="free">e</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span><span class="free">y</span><span class="main">]</span>  <span class="main">=</span> <span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ArityAnalysisLetSafe <span class="main">=</span> ArityAnalysisHeapSafe <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Aexp_Let<span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊑</span> <span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ArityAnalysisLetSafeNoCard <span class="main">=</span> ArityAnalysisLetSafe <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Aheap_heap3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> thunks <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> SubstArityAnalysis
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1" id="ArityAnalysisSpec-Aexp_subst_upd"><span class="command">lemma</span></span> Aexp_subst_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">⋅</span><span class="free">n</span> <span class="keyword1">f|`</span><span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">n</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Aexp_subst_restr<span class="main">)</span> <span class="operator">auto</span>
  
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∨</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∨</span> <span class="skolem">x'</span> <span class="main">∈</span> <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="skolem">x'</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">⋅</span><span class="free">n</span> <span class="keyword1">f|`</span><span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">n</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Aexp_subst_restr<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> fun_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">x'</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simp_trace</span><span class="main">]</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ArityAnalysisSpec-Aexp_subst"><span class="command">lemma</span></span> Aexp_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊑</span> env_delete <span class="free">y</span> <span class="main">(</span><span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊔</span> esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_subst_upd<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> ArityAnalysisSafe
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="ArityAnalysisSpec-Aexp_Var_singleton"><span class="command">lemma</span></span> Aexp_Var_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"esing <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span>up<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">Aexp</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aexp_Var<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisSpec-fup_Aexp_Var"><span class="command">lemma</span></span> fup_Aexp_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"esing <span class="free">x</span> <span class="main">⋅</span> <span class="free">n</span> <span class="main">⊑</span> fup<span class="main">⋅</span><span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aexp_Var<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">context</span></span> ArityAnalysisLetSafe
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1" id="ArityAnalysisSpec-Aheap_nonrec"><span class="command">lemma</span></span> Aheap_nonrec<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nonrec <span class="free">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="keyword1">f|`</span> domA <span class="free">Δ</span> <span class="main">⊑</span> <span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊑</span> <span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="main">(</span>Let <span class="free">Δ</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Aexp_Let<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> env_restr_mono<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Δ</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="free">Δ</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nonrecE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_def fresh_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fup_Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="keyword1">f|`</span> domA <span class="free">Δ</span> <span class="main">=</span> <span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_useless<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Let <span class="free">Δ</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="free">Δ</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="keyword1">f|`</span> domA <span class="free">Δ</span> <span class="main">⊑</span> <span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TrivialArityAnal">
<div class="head">
<h1>Theory TrivialArityAnal</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TrivialArityAnal
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#ArityAnalysisSpec">ArityAnalysisSpec</a> <span class="quoted">"<a href="../Launchbury/Env-Nominal.html">Launchbury.Env-Nominal</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Trivial_Aexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> Arity <span class="main">→</span> AEnv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Trivial_Aexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> n<span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> fv <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TrivialArityAnal-Trivial_Aexp_simp"><span class="command">lemma</span></span> Trivial_Aexp_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"Trivial_Aexp <span class="free">e</span> <span class="main">⋅</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> fv <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Trivial_Aexp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="TrivialArityAnal-edom_Trivial_Aexp"><span class="command">lemma</span></span> edom_Trivial_Aexp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>Trivial_Aexp <span class="free">e</span> <span class="main">⋅</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def env_restr_def Trivial_Aexp_def<span class="main">)</span> 

<span class="keyword1" id="TrivialArityAnal-Trivial_Aexp_eq"><span class="command">lemma</span></span> Trivial_Aexp_eq<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Trivial_Aexp <span class="free">e</span> <span class="main">⋅</span> <span class="free">n</span> <span class="main">=</span> Trivial_Aexp <span class="free">e'</span> <span class="main">⋅</span> <span class="free">n'</span> <span class="main">⟷</span> fv <span class="free">e</span> <span class="main">=</span> <span class="main">(</span>fv <span class="free">e'</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Trivial_Aexp_simp env_restr_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> up_defined<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="TrivialArityAnal-below_Trivial_Aexp"><span class="command">lemma</span></span> below_Trivial_Aexp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ae</span> <span class="main">⊑</span> Trivial_Aexp <span class="free">e</span> <span class="main">⋅</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> edom <span class="free">ae</span> <span class="main">⊆</span> fv <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>fun_belowD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fun_belowI  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Trivial_Aexp_def env_restr_def edom_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main">)</span>


<span class="keyword1"><span class="command">interpretation</span></span> ArityAnalysis <span class="quoted">Trivial_Aexp</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> EdomArityAnalysis <span class="quoted">Trivial_Aexp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">interpretation</span></span> ArityAnalysisSafe <span class="quoted">Trivial_Aexp</span>
<span class="keyword1"><span class="command">proof</span></span>
<span class="comment1">(*
  fix π
  show "π ∙ Trivial_Aexp = Trivial_Aexp" by perm_simp rule
next
*)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"up<span class="main">⋅</span><span class="skolem">n</span> <span class="main">⊑</span> <span class="main">(</span>Trivial_Aexp <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Trivial_Aexp_simp<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Trivial_Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span> <span class="main">⊔</span> esing <span class="skolem">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="main">⊑</span> Trivial_Aexp <span class="main">(</span>App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fun_belowI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Trivial_Aexp_def env_restr_def <span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">e</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"env_delete <span class="skolem">y</span> <span class="main">(</span>Trivial_Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> Trivial_Aexp <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Trivial_Aexp_simp env_delete_restr Diff_eq inf_commute<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">S</span> <span class="skolem">e</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Trivial_Aexp <span class="skolem">e</span><span class="main">[</span><span class="skolem">x</span><span class="main">::=</span><span class="skolem">y</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span> <span class="keyword1">f|`</span> <span class="skolem">S</span> <span class="main">=</span> Trivial_Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="keyword1">f|`</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Trivial_Aexp_simp fv_subst_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">S</span><span class="main">.</span> env_restr <span class="bound">S</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">e</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">scrut</span> <span class="skolem">e1</span> <span class="skolem">a</span> <span class="skolem">e2</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Trivial_Aexp <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊔</span> Trivial_Aexp <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> Trivial_Aexp <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊑</span> Trivial_Aexp <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> env_restr_mono2 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Trivial_Aexp_simp join_below_iff <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Trivial_Aheap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> exp <span class="main">⇒</span> Arity <span class="main">→</span> AEnv"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Trivial_Aheap</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TrivialArityAnal-Trivial_Aheap_eqvt"><span class="command">lemma</span></span> Trivial_Aheap_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span>  <span class="main">(</span>Trivial_Aheap <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> Trivial_Aheap <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Trivial_Aheap_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">perm_simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_cfun_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TrivialArityAnal-Trivial_Aheap_simp"><span class="command">lemma</span></span> Trivial_Aheap_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"Trivial_Aheap <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Trivial_Aheap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="TrivialArityAnal-Trivial_fup_Aexp_below_fv"><span class="command">lemma</span></span> Trivial_fup_Aexp_below_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"fup<span class="main">⋅</span><span class="main">(</span>Trivial_Aexp <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> fv <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Trivial_Aexp_simp<span class="main">)</span>

<span class="keyword1" id="TrivialArityAnal-Trivial_Abinds_below_fv"><span class="command">lemma</span></span> Trivial_Abinds_below_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> fv <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>ABinds.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Trivial_fup_Aexp_below_fv<span class="main"><span class="main">]</span></span> env_restr_mono2 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fv_delete_subset<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> ArityAnalysisLetSafe <span class="quoted">Trivial_Aexp</span> <span class="quoted">Trivial_Aheap</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">∙</span> Trivial_Aheap <span class="main">=</span> Trivial_Aheap"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>  
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">ae</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>Trivial_Aheap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Trivial_Aheap_simp<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="main">::</span> <span class="quoted">heap</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">e</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="main">(</span>Trivial_Aheap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊔</span> Trivial_Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊑</span> Trivial_Aheap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> Trivial_Aexp <span class="main">(</span>Terms.Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Trivial_Aheap_simp Trivial_Aexp_simp join_below_iff env_restr_join2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> env_restr_mono2 below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Trivial_Abinds_below_fv<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Γ</span> <span class="main">::</span> <span class="quoted">heap</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> domA <span class="skolem">Γ</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Trivial_Aheap <span class="skolem">Γ</span><span class="main">[</span><span class="skolem">x</span><span class="keyword1">::h=</span><span class="skolem">y</span><span class="main">]</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">x</span><span class="main">::=</span><span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> Trivial_Aheap <span class="skolem">Γ</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cfun_eqI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Trivial_Aheap_simp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Cardinality-Domain">
<div class="head">
<h1>Theory Cardinality-Domain</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Cardinality-Domain"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Launchbury/HOLCF-Utils.html">Launchbury.HOLCF-Utils</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> oneShot <span class="main">=</span> <span class="quoted"><span class="quoted">"one"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">notOneShot</span> <span class="main">::</span> <span class="quoted">oneShot</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">notOneShot</span> <span class="main">≡</span> ONE"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">oneShot</span> <span class="main">::</span> <span class="quoted">oneShot</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">oneShot</span> <span class="main">≡</span> <span class="main">⊥</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> two <span class="main">=</span> <span class="quoted"><span class="quoted">"oneShot<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">many</span> <span class="main">::</span> <span class="quoted">two</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">many</span> <span class="main">≡</span> up<span class="main">⋅</span>notOneShot"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">once</span> <span class="main">::</span> <span class="quoted">two</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">once</span> <span class="main">≡</span> up<span class="main">⋅</span>oneShot"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">none</span> <span class="main">::</span> <span class="quoted">two</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">none</span> <span class="main">≡</span> <span class="main">⊥</span>"</span></span>

<span class="keyword1" id="Cardinality-Domain-many_max"><span class="command">lemma</span></span> many_max<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> many"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Cardinality-Domain-two_conj"><span class="command">lemma</span></span> two_conj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> many <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> once <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> none"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Exh_Up one_neq_iffs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Cardinality-Domain-two_cases"><span class="command">lemma</span></span> two_cases<span class="main">[</span><span class="operator">case_names</span> many once none<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> many"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> once"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> none"</span></span> <span class="keyword1"><span class="command">using</span></span> two_conj <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">two_pred</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">two_pred</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">⊑</span> once <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Cardinality-Domain-two_pred_simp"><span class="command">lemma</span></span> two_pred_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"two_pred<span class="main">⋅</span><span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="main">⊑</span> once <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> two_pred_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> beta_cfun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont_if_else_above<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Cardinality-Domain-two_pred_simps"><span class="command">lemma</span></span> two_pred_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"two_pred<span class="main">⋅</span>many <span class="main">=</span> many"</span></span>
  <span class="quoted"><span class="quoted">"two_pred<span class="main">⋅</span>once <span class="main">=</span> none"</span></span>
  <span class="quoted"><span class="quoted">"two_pred<span class="main">⋅</span>none <span class="main">=</span> none"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_pred_simp<span class="main">)</span>

<span class="keyword1" id="Cardinality-Domain-two_pred_below_arg"><span class="command">lemma</span></span> two_pred_below_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"two_pred <span class="main">⋅</span> <span class="free">f</span> <span class="main">⊑</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_pred_simp<span class="main">)</span>

<span class="keyword1" id="Cardinality-Domain-two_pred_none"><span class="command">lemma</span></span> two_pred_none<span class="main">:</span> <span class="quoted"><span class="quoted">"two_pred<span class="main">⋅</span><span class="free">c</span> <span class="main">=</span> none <span class="main">⟷</span> <span class="free">c</span> <span class="main">⊑</span> once"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_pred_simp<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">record_call</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">record_call</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ce<span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">then</span> two_pred<span class="main">⋅</span><span class="main">(</span><span class="bound">ce</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">ce</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Cardinality-Domain-record_call_simp"><span class="command">lemma</span></span> record_call_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>record_call <span class="free">x</span> <span class="main">⋅</span> <span class="free">f</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span> <span class="keyword1">then</span> two_pred <span class="main">⋅</span> <span class="main">(</span><span class="free">f</span> <span class="free">x'</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> record_call_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Cardinality-Domain-record_call"><span class="command">lemma</span></span> record_call<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>record_call <span class="free">x</span> <span class="main">⋅</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> two_pred <span class="main">⋅</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> record_call_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Cardinality-Domain-record_call_other"><span class="command">lemma</span></span> record_call_other<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span>record_call <span class="free">x</span> <span class="main">⋅</span> <span class="free">f</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> record_call_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Cardinality-Domain-record_call_below_arg"><span class="command">lemma</span></span> record_call_below_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"record_call <span class="free">x</span> <span class="main">⋅</span> <span class="free">f</span> <span class="main">⊑</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> record_call_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fun_belowI two_pred_below_arg<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">two_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"two <span class="main">→</span> two <span class="main">→</span> two"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">two_add</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="main">(</span><span class="keyword1">Λ</span> y<span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="main">⊥</span> <span class="keyword1">then</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">y</span> <span class="main">⊑</span> <span class="main">⊥</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="keyword1">else</span> many<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Cardinality-Domain-two_add_simp"><span class="command">lemma</span></span> two_add_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"two_add<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">⊑</span> <span class="main">⊥</span> <span class="keyword1">then</span> <span class="free">y</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">y</span> <span class="main">⊑</span> <span class="main">⊥</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> many<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> two_add_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> beta_cfun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont_if_else_above<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont_if_else_above<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>8<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> beta_cfun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont_if_else_above<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont_if_else_above<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Cardinality-Domain-two_pred_two_add_once"><span class="command">lemma</span></span> two_pred_two_add_once<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊑</span> two_pred<span class="main">⋅</span><span class="main">(</span>two_add<span class="main">⋅</span>once<span class="main">⋅</span><span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_add_simp<span class="main">)</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CardinalityAnalysisSig">
<div class="head">
<h1>Theory CardinalityAnalysisSig</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CardinalityAnalysisSig
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Arity">Arity</a> <a href="#AEnv">AEnv</a> <span class="quoted">"<a href="Cardinality-Domain.html">Cardinality-Domain</a>"</span> <a href="#SestoftConf">SestoftConf</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> CardinalityPrognosis <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">prognosis</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"AEnv <span class="main">⇒</span> Arity list <span class="main">⇒</span> Arity <span class="main">⇒</span> conf <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> two<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> CardinalityHeap <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cHeap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> exp <span class="main">⇒</span> Arity <span class="main">→</span> <span class="main">(</span>var <span class="main">⇒</span> two<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ConstOn">
<div class="head">
<h1>Theory ConstOn</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ConstOn
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">const_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">const_on</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ConstOn-const_onI"><span class="command">lemma</span></span> const_onI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> const_on <span class="free">f</span> <span class="free">S</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_on_def<span class="main">)</span>

<span class="keyword1" id="ConstOn-const_onD"><span class="command">lemma</span></span> const_onD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"const_on <span class="free">f</span> <span class="free">S</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_on_def<span class="main">)</span>

<span class="comment1">(*
lemma const_onE[elim]: "const_on f S r ==&gt; x : S ==&gt; r = r' ==&gt; f x = r'" 
*)</span>

<span class="keyword1" id="ConstOn-const_on_insert"><span class="command">lemma</span></span> const_on_insert<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"const_on <span class="free">f</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟷</span> const_on <span class="free">f</span> <span class="free">S</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ConstOn-const_on_union"><span class="command">lemma</span></span> const_on_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"const_on <span class="free">f</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">S'</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟷</span> const_on <span class="free">f</span> <span class="free">S</span> <span class="free">y</span> <span class="main">∧</span> const_on <span class="free">f</span> <span class="free">S'</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ConstOn-const_on_subset"><span class="command">lemma</span></span> const_on_subset<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"const_on <span class="free">f</span> <span class="free">S</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">S'</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> const_on <span class="free">f</span> <span class="free">S'</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CardinalityAnalysisSpec">
<div class="head">
<h1>Theory CardinalityAnalysisSpec</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CardinalityAnalysisSpec
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#ArityAnalysisSpec">ArityAnalysisSpec</a> <a href="#CardinalityAnalysisSig">CardinalityAnalysisSig</a> <a href="#ConstOn">ConstOn</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> CardinalityPrognosisEdom <span class="main">=</span> CardinalityPrognosis <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> edom_prognosis<span class="main">:</span>
    <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">a</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">Γ</span> <span class="main">∪</span> fv <span class="free">e</span> <span class="main">∪</span> fv <span class="free">S</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> CardinalityPrognosisShape <span class="main">=</span> CardinalityPrognosis <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prognosis_env_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="keyword1">f|`</span> domA <span class="free">Γ</span> <span class="main">=</span> <span class="free">ae'</span> <span class="keyword1">f|`</span> domA <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">u</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">prognosis</span> <span class="free">ae'</span> <span class="free">as</span> <span class="free">u</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prognosis_reorder<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="main">=</span> map_of <span class="free">Δ</span>  <span class="main">⟹</span>  <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">u</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">u</span> <span class="main">(</span><span class="free">Δ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prognosis_ap<span class="main">:</span> <span class="quoted"><span class="quoted">"const_on <span class="main">(</span><span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">a</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ap <span class="free">S</span><span class="main">)</span> many"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prognosis_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">u</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">u</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> Upd <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prognosis_not_called<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">a</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">a</span> <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prognosis_called<span class="main">:</span> <span class="quoted"><span class="quoted">"once <span class="main">⊑</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">a</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Var <span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="free">x</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> CardinalityPrognosisApp <span class="main">=</span> CardinalityPrognosis <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prognosis_App<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="main">(</span>inc<span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> Arg <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">a</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> App <span class="free">e</span> <span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> CardinalityPrognosisLam <span class="main">=</span> CardinalityPrognosis <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prognosis_subst_Lam<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="main">(</span>pred<span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">a</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e</span><span class="main">,</span> Arg <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> CardinalityPrognosisVar <span class="main">=</span> CardinalityPrognosis <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prognosis_Var_lam<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span> <span class="main">⟹</span> <span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="free">u</span> <span class="main">⟹</span> isVal <span class="free">e</span> <span class="main">⟹</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">u</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> record_call <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">a</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Var <span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prognosis_Var_thunk<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span> <span class="main">⟹</span> <span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="free">u</span> <span class="main">⟹</span> <span class="main">¬</span> isVal <span class="free">e</span> <span class="main">⟹</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">u</span> <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> Upd <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> record_call <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">a</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Var <span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prognosis_Var2<span class="main">:</span> <span class="quoted"><span class="quoted">"isVal <span class="free">e</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="main">0</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="main">0</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> Upd <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> CardinalityPrognosisIfThenElse <span class="main">=</span> CardinalityPrognosis <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prognosis_IfThenElse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="free">ae</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">scrut</span><span class="main">,</span> Alts <span class="free">e1</span> <span class="free">e2</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">a</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prognosis_Alts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">a</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">e1</span> <span class="keyword1">else</span> <span class="free">e2</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Bool <span class="free">b</span><span class="main">,</span> Alts <span class="free">e1</span> <span class="free">e2</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> CardinalityPrognosisLet <span class="main">=</span> CardinalityPrognosis <span class="main">+</span> CardinalityHeap <span class="main">+</span> ArityAnalysisHeap <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prognosis_Let<span class="main">:</span>
  <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Δ</span> <span class="main">♯*</span> <span class="free">Γ</span> <span class="main">⟹</span> atom <span class="main">`</span> domA <span class="free">Δ</span> <span class="main">♯*</span> <span class="free">S</span> <span class="main">⟹</span> edom <span class="free">ae</span> <span class="main">⊆</span> domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span> <span class="main">⟹</span> <span class="free">prognosis</span> <span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">ae</span><span class="main">)</span> <span class="free">as</span> <span class="free">a</span> <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">cHeap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">prognosis</span> <span class="free">ae</span> <span class="free">as</span> <span class="free">a</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Terms.Let <span class="free">Δ</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> CardinalityHeapSafe <span class="main">=</span> CardinalityHeap <span class="main">+</span> ArityAnalysisHeap <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Aheap_heap3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> thunks <span class="free">Γ</span> <span class="main">⟹</span> many <span class="main">⊑</span> <span class="main">(</span><span class="free">cHeap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> edom_cHeap<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">cHeap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> CardinalityPrognosisSafe <span class="main">=</span>
  CardinalityPrognosisEdom <span class="main">+</span>
  CardinalityPrognosisShape <span class="main">+</span>
  CardinalityPrognosisApp <span class="main">+</span>
  CardinalityPrognosisLam <span class="main">+</span> 
  CardinalityPrognosisVar <span class="main">+</span>
  CardinalityPrognosisLet <span class="main">+</span>
  CardinalityPrognosisIfThenElse <span class="main">+</span>
  CardinalityHeapSafe <span class="main">+</span>
  ArityAnalysisLetSafe

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ArityAnalysisStack">
<div class="head">
<h1>Theory ArityAnalysisStack</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ArityAnalysisStack
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#SestoftConf">SestoftConf</a> <a href="#ArityAnalysisSig">ArityAnalysisSig</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> ArityAnalysis
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">AEstack</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Arity list <span class="main">⇒</span> stack <span class="main">⇒</span> AEnv"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">AEstack</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">AEstack</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Aexp</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⊔</span> <span class="free">AEstack</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">AEstack</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> esing <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">AEstack</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">AEstack</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span>Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> esing <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">AEstack</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">AEstack</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">AEstack</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> EdomArityAnalysis
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1" id="ArityAnalysisStack-edom_AEstack"><span class="command">lemma</span></span> edom_AEstack<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>AEstack <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> AEstack.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="NoCardinalityAnalysis">
<div class="head">
<h1>Theory NoCardinalityAnalysis</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> NoCardinalityAnalysis
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#CardinalityAnalysisSpec">CardinalityAnalysisSpec</a> <a href="#ArityAnalysisStack">ArityAnalysisStack</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> NoCardinalityAnalysis <span class="main">=</span> ArityAnalysisLetSafe <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Aheap_thunk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> thunks <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">a2c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Arity<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span> <span class="main">→</span> two"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a2c</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">⊑</span> <span class="main">⊥</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> many<span class="main">)</span>"</span></span>
<span class="keyword1" id="NoCardinalityAnalysis-a2c_simp"><span class="command">lemma</span></span> a2c_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"a2c<span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">⊑</span> <span class="main">⊥</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> many<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> a2c_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> beta_cfun<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_if_else_above<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1" id="NoCardinalityAnalysis-a2c_eqvt"><span class="command">lemma</span></span> a2c_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> a2c <span class="main">=</span> a2c"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> a2c_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">perm_simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Abs_cfun_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont_if_else_above<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ae2ce</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"AEnv <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> two<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ae2ce</span> <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> a2c<span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="NoCardinalityAnalysis-ae2ce_cont"><span class="command">lemma</span></span> ae2ce_cont<span class="main">:</span> <span class="quoted"><span class="quoted">"cont ae2ce"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ae2ce_def<span class="main">)</span> 
<span class="keyword1"><span class="command">lemmas</span></span> cont_compose<span class="main">[</span><span class="operator">OF</span> ae2ce_cont<span class="main">,</span> <span class="operator">cont2cont</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="NoCardinalityAnalysis-ae2ce_eqvt"><span class="command">lemma</span></span> ae2ce_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> ae2ce <span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> ae2ce <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">ae</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ae2ce_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1" id="NoCardinalityAnalysis-ae2ce_to_env_restr"><span class="command">lemma</span></span> ae2ce_to_env_restr<span class="main">:</span> <span class="quoted"><span class="quoted">"ae2ce <span class="free">ae</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">.</span> many<span class="main">)</span> <span class="keyword1">f|`</span> edom <span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ae2ce_def lookup_env_restr_eq edom_def a2c_simp<span class="main">)</span>

<span class="keyword1" id="NoCardinalityAnalysis-edom_ae2ce"><span class="command">lemma</span></span> edom_ae2ce<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>ae2ce <span class="free">ae</span><span class="main">)</span> <span class="main">=</span> edom <span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> edom_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ae2ce_def  a2c_simp<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cHeap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> exp <span class="main">⇒</span> Arity <span class="main">→</span> <span class="main">(</span>var <span class="main">⇒</span> two<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cHeap</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> ae2ce <span class="main">(</span><span class="free">Aheap</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1" id="NoCardinalityAnalysis-cHeap_simp"><span class="command">lemma</span></span> cHeap_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cHeap <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> ae2ce <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cHeap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">sublocale</span></span> CardinalityHeap <span class="quoted">cHeap</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> CardinalityHeapSafe <span class="quoted">cHeap</span> <span class="quoted"><span class="free">Aheap</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Aheap_thunk<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">prognosis</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> many<span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>edom <span class="main">(</span>ABinds <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span>AEstack <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="NoCardinalityAnalysis-record_all_noop"><span class="command">lemma</span></span> record_all_noop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"record_call <span class="free">x</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> many<span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> many<span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> record_call_def lookup_env_restr_eq<span class="main">)</span>

<span class="keyword1" id="NoCardinalityAnalysis-const_on_restr_constI"><span class="command">lemma</span></span> const_on_restr_constI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> const_on <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="free">S'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="NoCardinalityAnalysis-ap_subset_edom_AEstack"><span class="command">lemma</span></span> ap_subset_edom_AEstack<span class="main">:</span> <span class="quoted"><span class="quoted">"ap <span class="free">S</span> <span class="main">⊆</span> edom <span class="main">(</span>AEstack <span class="free">as</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>AEstack.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp<span class="main">)</span>
  

<span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosis <span class="quoted">prognosis</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisShape <span class="quoted">prognosis</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> Abinds_env_restr_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> Abinds_reorder<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ap_subset_edom_AEstack<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> env_restr_mono2 <span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">ae</span> <span class="skolem">x</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⊥</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">ae</span> <span class="main">=</span> ABinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ABinds_delete_bot<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Aexp_Var<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edomIff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisApp <span class="quoted">prognosis</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> edom_mono<span class="main">[</span><span class="operator">OF</span> Aexp_App<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> env_restr_mono2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisLam <span class="quoted">prognosis</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">y</span> <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> insert <span class="skolem">x</span> <span class="main">(</span>edom <span class="main">(</span>env_delete <span class="skolem">y</span> <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Aexp_subst<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> insert <span class="skolem">x</span> <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edom_mono<span class="main">[</span><span class="operator">OF</span> Aexp_Lam<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> env_restr_mono2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisVar <span class="quoted">prognosis</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 1
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> env_restr_mono2 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abinds_reorder1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 2
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> env_restr_mono2 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abinds_reorder1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> Aexp_Var edomIff not_up_less_UU<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fup<span class="main">⋅</span><span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">ae</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> monofun_cfun_arg<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> edom_mono<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> env_restr_mono2 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> ABinds_delete_below<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisIfThenElse <span class="quoted">prognosis</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ae</span> <span class="skolem">a</span> <span class="skolem">as</span> <span class="skolem">Γ</span> <span class="skolem">scrut</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊆</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> edom_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_IfThenElse<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> env_restr_mono2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">Γ</span> <span class="skolem">b</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> env_restr_mono2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

  
<span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisLet <span class="quoted">prognosis</span>  <span class="quoted">cHeap</span> <span class="quoted"><span class="free">Aheap</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">Δ</span> <span class="skolem">Γ</span> <span class="skolem">S</span> <span class="skolem">ae</span> <span class="skolem">e</span> <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="keyword1">f|`</span> domA <span class="skolem">Δ</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ups_fv_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">ae</span> <span class="main">⊔</span> <span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> ABinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> Abinds_env_restr_cong <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span>  fresh_distinct<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">ae</span> <span class="main">⊔</span> <span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> ABinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> Abinds_env_restr_cong <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>ABinds <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>  <span class="main">=</span> edom <span class="main">(</span>ABinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span>ABinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">∪</span>  edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abinds_append_disjoint<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fresh_distinct<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> Un_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> edom <span class="main">(</span>ABinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span>ABinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> edom <span class="main">(</span>ABinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  edom_mono<span class="main">[</span><span class="operator">OF</span> Aexp_Let<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span>ABinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>ABinds <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊆</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span>ABinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>ABinds <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span>AEstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span>ABinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span>AEstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ae2ce_to_env_restr env_restr_join2 Un_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> env_restr_mono2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisEdom <span class="quoted">prognosis</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ap_fv_subset<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_AnalBinds<span class="main"><span class="main">]</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_AEstack<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisSafe <span class="quoted">prognosis</span> <span class="quoted">cHeap</span> <span class="quoted"><span class="free">Aheap</span></span> <span class="quoted"><span class="free">Aexp</span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TransformTools">
<div class="head">
<h1>Theory TransformTools</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TransformTools
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Launchbury/Nominal-HOLCF.html">Launchbury.Nominal-HOLCF</a>"</span> <a href="../../launchbury/theories/#Terms">Launchbury.Terms</a> <a href="../../launchbury/theories/#Substitution">Launchbury.Substitution</a> <a href="../../launchbury/theories/#Env">Launchbury.Env</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">default_sort</span></span> <span class="quoted">type</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lift_transform</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>cont_pt <span class="main">⇒</span> exp <span class="main">⇒</span> exp<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span> <span class="main">⇒</span> exp <span class="main">⇒</span> exp<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift_transform</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> Ibottom  <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
  <span class="main">|</span>     <span class="quoted"><span class="quoted">"<span class="free">lift_transform</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>Iup <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1" id="TransformTools-lift_transform_simps"><span class="command">lemma</span></span> lift_transform_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lift_transform <span class="free">t</span> <span class="main">⊥</span> <span class="free">e</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"lift_transform <span class="free">t</span> <span class="main">(</span>up<span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="free">t</span> <span class="free">a</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> inst_up_pcpo lift_transform.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> up_def cont_Iup<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TransformTools-lift_transform_eqvt"><span class="command">lemma</span></span> lift_transform_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span>  lift_transform <span class="free">t</span> <span class="free">a</span> <span class="free">e</span> <span class="main">=</span> lift_transform <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="TransformTools-lift_transform_fun_cong"><span class="command">lemma</span></span> lift_transform_fun_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="free">t1</span> <span class="bound">a</span> <span class="free">e1</span> <span class="main">=</span> <span class="free">t2</span> <span class="bound">a</span> <span class="free">e1</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a1</span> <span class="main">=</span> <span class="free">a2</span> <span class="main">⟹</span> <span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span> <span class="main">⟹</span> lift_transform <span class="free">t1</span> <span class="free">a1</span> <span class="free">e1</span> <span class="main">=</span> lift_transform <span class="free">t2</span> <span class="free">a2</span> <span class="free">e2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t2</span><span class="main">,</span><span class="free">a2</span><span class="main">,</span><span class="free">e2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lift_transform.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="TransformTools-subst_lift_transform"><span class="command">lemma</span></span> subst_lift_transform<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">t</span> <span class="bound">a</span> <span class="free">e</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">t</span> <span class="bound">a</span> <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lift_transform <span class="free">t</span> <span class="free">a</span> <span class="free">e</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> lift_transform <span class="free">t</span> <span class="free">a</span> <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">map_transform</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>cont_pt <span class="main">⇒</span> exp <span class="main">⇒</span> exp<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">)</span> <span class="main">⇒</span> heap <span class="main">⇒</span> heap"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_transform</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="main">=</span> map_ran <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">e</span> <span class="main">.</span> lift_transform <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TransformTools-map_transform_eqvt"><span class="command">lemma</span></span> map_transform_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> map_transform <span class="free">t</span> <span class="free">ae</span> <span class="main">=</span> map_transform <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">ae</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="TransformTools-domA_map_transform"><span class="command">lemma</span></span> domA_map_transform<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="main">(</span>map_transform <span class="free">t</span> <span class="free">ae</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="TransformTools-length_map_transform"><span class="command">lemma</span></span> length_map_transform<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map_transform <span class="free">t</span> <span class="free">ae</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_transform_def map_ran_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 
<span class="keyword1" id="TransformTools-map_transform_delete"><span class="command">lemma</span></span> map_transform_delete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_transform <span class="free">t</span> <span class="free">ae</span> <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> delete <span class="free">x</span> <span class="main">(</span>map_transform <span class="free">t</span> <span class="free">ae</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_ran_delete<span class="main">)</span>

<span class="keyword1" id="TransformTools-map_transform_restrA"><span class="command">lemma</span></span> map_transform_restrA<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_transform <span class="free">t</span> <span class="free">ae</span> <span class="main">(</span>restrictA <span class="free">S</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> restrictA <span class="free">S</span> <span class="main">(</span>map_transform <span class="free">t</span> <span class="free">ae</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_ran_restrictA<span class="main">)</span>

<span class="keyword1" id="TransformTools-delete_map_transform_env_delete"><span class="command">lemma</span></span> delete_map_transform_env_delete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"delete <span class="free">x</span> <span class="main">(</span>map_transform <span class="free">t</span> <span class="main">(</span>env_delete <span class="free">x</span> <span class="free">ae</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> delete <span class="free">x</span> <span class="main">(</span>map_transform <span class="free">t</span> <span class="free">ae</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="TransformTools-map_transform_Nil"><span class="command">lemma</span></span> map_transform_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_transform <span class="free">t</span> <span class="free">ae</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="TransformTools-map_transform_Cons"><span class="command">lemma</span></span> map_transform_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_transform <span class="free">t</span> <span class="free">ae</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">#</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> lift_transform <span class="free">t</span> <span class="main">(</span><span class="free">ae</span> <span class="free">x</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span>  <span class="main">(</span>map_transform <span class="free">t</span> <span class="free">ae</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="TransformTools-map_transform_append"><span class="command">lemma</span></span> map_transform_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_transform <span class="free">t</span> <span class="free">ae</span> <span class="main">(</span><span class="free">Δ</span><span class="main">@</span><span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> map_transform <span class="free">t</span> <span class="free">ae</span> <span class="free">Δ</span> <span class="main">@</span> map_transform <span class="free">t</span> <span class="free">ae</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_ran_append<span class="main">)</span>

<span class="keyword1" id="TransformTools-map_transform_fundef_cong"><span class="command">lemma</span></span> map_transform_fundef_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">e</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">m1</span> <span class="main">⟹</span> <span class="free">t1</span> <span class="bound">a</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">t2</span> <span class="bound">a</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ae1</span> <span class="main">=</span> <span class="free">ae2</span> <span class="main">⟹</span> <span class="free">m1</span> <span class="main">=</span> <span class="free">m2</span> <span class="main">⟹</span> map_transform <span class="free">t1</span> <span class="free">ae1</span> <span class="free">m1</span> <span class="main">=</span> map_transform <span class="free">t2</span> <span class="free">ae2</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m1</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_transform_Nil map_transform_Cons <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lift_transform_fun_cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="TransformTools-map_transform_cong"><span class="command">lemma</span></span> map_transform_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="free">m1</span> <span class="main">⟹</span> <span class="free">ae</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">ae'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">m1</span> <span class="main">=</span> <span class="free">m2</span> <span class="main">⟹</span> map_transform <span class="free">t</span> <span class="free">ae</span> <span class="free">m1</span> <span class="main">=</span> map_transform <span class="free">t</span> <span class="free">ae'</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_ran_cong <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> domA_from_set<span class="main">)</span>

<span class="keyword1" id="TransformTools-map_of_map_transform"><span class="command">lemma</span></span> map_of_map_transform<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map_transform <span class="free">t</span> <span class="free">ae</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> map_option <span class="main">(</span>lift_transform <span class="free">t</span> <span class="main">(</span><span class="free">ae</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_of <span class="free">Γ</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_transform_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_ran_conv<span class="main">)</span>

<span class="keyword1" id="TransformTools-supp_map_transform_step"><span class="command">lemma</span></span> supp_map_transform_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">e</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Γ</span> <span class="main">⟹</span> supp <span class="main">(</span><span class="free">t</span> <span class="bound">a</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="bound">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_transform <span class="free">t</span> <span class="free">ae</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Nil supp_Cons map_transform_Nil map_transform_Cons supp_Pair pure_supp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="improper">a</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TransformTools-subst_map_transform"><span class="command">lemma</span></span> subst_map_transform<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x'</span> <span class="bound">e</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">:</span> set <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">t</span> <span class="bound">a</span> <span class="bound">e</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">t</span> <span class="bound">a</span> <span class="main">(</span><span class="bound">e</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_transform <span class="free">t</span> <span class="free">ae</span> <span class="free">Γ</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> map_transform <span class="free">t</span> <span class="free">ae</span> <span class="main">(</span><span class="free">Γ</span><span class="main">[</span><span class="free">x</span> <span class="keyword1">::h=</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_transform_Nil map_transform_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_lift_transform<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">locale</span></span> supp_bounded_transform <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>cont_pt <span class="main">⇒</span> exp <span class="main">⇒</span> exp"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> supp_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">trans</span> <span class="free">a</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">e</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1" id="TransformTools-supp_lift_transform"><span class="command">lemma</span></span> supp_lift_transform<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>lift_transform <span class="free">trans</span> <span class="free">a</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">trans</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>lift_transform.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> supp_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1" id="TransformTools-supp_map_transform"><span class="command">lemma</span></span> supp_map_transform<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>map_transform <span class="free">trans</span> <span class="free">ae</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_transform_def
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Pair supp_Cons <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> supp_lift_transform<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1" id="TransformTools-fresh_transform"><span class="command">lemma</span></span> fresh_transform<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">trans</span> <span class="free">n</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> supp_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1" id="TransformTools-fresh_star_transform"><span class="command">lemma</span></span> fresh_star_transform<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">♯*</span> <span class="free">trans</span> <span class="free">n</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>

  <span class="keyword1" id="TransformTools-fresh_map_transform"><span class="command">lemma</span></span> fresh_map_transform<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">♯</span> map_transform <span class="free">trans</span> <span class="free">ae</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fresh_def <span class="keyword1"><span class="command">using</span></span> supp_map_transform <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="TransformTools-fresh_star_map_transform"><span class="command">lemma</span></span> fresh_star_map_transform<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">♯*</span> map_transform <span class="free">trans</span> <span class="free">ae</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="AbstractTransform">
<div class="head">
<h1>Theory AbstractTransform</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> AbstractTransform
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../launchbury/theories/#Terms">Launchbury.Terms</a> <a href="#TransformTools">TransformTools</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> AbstractAnalProp <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">PropApp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>cont_pt"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">PropLam</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">AnalLet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> exp <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>cont_pt"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">PropLetBody</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">PropLetHeap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">PropIfScrut</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PropApp_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">PropApp</span> <span class="main">≡</span> <span class="free">PropApp</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PropLam_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">PropLam</span> <span class="main">≡</span> <span class="free">PropLam</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> AnalLet_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">AnalLet</span> <span class="main">≡</span> <span class="free">AnalLet</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PropLetBody_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">PropLetBody</span> <span class="main">≡</span> <span class="free">PropLetBody</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PropLetHeap_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">PropLetHeap</span> <span class="main">≡</span> <span class="free">PropLetHeap</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PropIfScrut_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">PropIfScrut</span> <span class="main">≡</span> <span class="free">PropIfScrut</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> AbstractAnalPropSubst <span class="main">=</span> AbstractAnalProp <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> AnalLet_subst<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∉</span> domA <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">AnalLet</span> <span class="main">(</span><span class="free">Γ</span><span class="main">[</span><span class="free">x</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">AnalLet</span> <span class="free">Γ</span> <span class="free">e</span> <span class="free">a</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> AbstractTransform <span class="main">=</span> AbstractAnalProp <span class="main">+</span>
  <span class="keyword2"><span class="keyword">constrains</span></span> AnalLet <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> exp <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>pure_cont_pt <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>cont_pt"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">TransVar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> var <span class="main">⇒</span> exp"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">TransApp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> exp <span class="main">⇒</span> var <span class="main">⇒</span> exp"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">TransLam</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> var <span class="main">⇒</span> exp <span class="main">⇒</span> exp"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">TransLet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> heap <span class="main">⇒</span> exp <span class="main">⇒</span> exp"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> TransVar_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">TransVar</span> <span class="main">=</span> <span class="free">TransVar</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> TransApp_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">TransApp</span> <span class="main">=</span> <span class="free">TransApp</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> TransLam_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">TransLam</span> <span class="main">=</span> <span class="free">TransLam</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> TransLet_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">TransLet</span> <span class="main">=</span> <span class="free">TransLet</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SuppTransLam<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">TransLam</span> <span class="free">a</span> <span class="free">v</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">e</span> <span class="main">-</span> supp <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SuppTransLet<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">TransLet</span> <span class="free">b</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">-</span> atom <span class="main">`</span> domA <span class="free">Γ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">nominal_function</span></span> <span class="entity">transform</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">transform</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">TransApp</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free">transform</span> <span class="main">(</span><span class="free">PropApp</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transform</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">TransLam</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">transform</span> <span class="main">(</span><span class="free">PropLam</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transform</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">TransVar</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transform</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">TransLet</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>
        <span class="main">(</span>map_transform <span class="free">transform</span> <span class="main">(</span><span class="free">PropLetHeap</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="free">transform</span> <span class="main">(</span><span class="free">PropLetBody</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transform</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Bool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Bool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transform</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">scrut</span></span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="main">(</span><span class="free">transform</span> <span class="main">(</span><span class="free">PropIfScrut</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">scrut</span></span></span> <span class="main">?</span> <span class="free">transform</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">:</span> <span class="free">transform</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">note</span></span> PropApp_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLam_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLetBody_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLetHeap_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> AnalLet_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> TransVar_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>  TransApp_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>  TransLam_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span> TransLet_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eqvt_def transform_graph_aux_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">perm_simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">P</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> prems
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>Terms.exp_strong_exhaust<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>10 <span class="skolem">a</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">a'</span> <span class="skolem">x'</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>5<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">].</span> <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">a</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> eqvt_lam_case<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="main">::</span> <span class="quoted">perm</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">TransLam</span> <span class="skolem">a</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLam</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SuppTransLam<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  exp_assn.supp supp_Pair supp_at_base pure_supp exp_assn.fsupp <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> supp_eqvt_at<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">π</span> <span class="main">♯*</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">π</span> <span class="main">♯*</span> <span class="free">TransLam</span> <span class="skolem">a</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLam</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_def<span class="main">)</span>

    <span class="keyword1"><span class="command">note</span></span> PropApp_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLam_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLetBody_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLetHeap_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> TransVar_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span> TransApp_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>  TransLam_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span> TransLet_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">TransLam</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLam</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>
        <span class="main">=</span> <span class="free">TransLam</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span>  <span class="main">(</span><span class="free">PropLam</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">TransLam</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLam</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> eqvt_at_apply'<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="main">(</span><span class="free">TransLam</span> <span class="skolem">a</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLam</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">TransLam</span> <span class="skolem">a</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLam</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> perm_supp_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">TransLam</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLam</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">TransLam</span> <span class="skolem">a</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLam</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>19 <span class="skolem">a</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a'</span> <span class="skolem">as'</span> <span class="skolem">body'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> PropApp_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLam_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLetBody_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span>  AnalLet_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLetHeap_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> TransVar_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>  TransApp_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>  TransLam_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span> TransLet_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> supp_eqvt_at<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">e</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">as</span> <span class="main">⟹</span> supp <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="bound">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_assn.fsupp supp_Pair pure_supp<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> supp_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ae</span><span class="main">.</span> supp <span class="main">(</span>map_transform <span class="main">(</span><span class="main">λ</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="free">transform_sumC</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span> <span class="bound">ae</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="skolem">as</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> supp_map_transform_step<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>9<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"Terms.Let <span class="skolem">as</span> <span class="skolem">body</span> <span class="main">=</span> Terms.Let <span class="skolem">as'</span> <span class="skolem">body'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">a</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eqvt_let_case<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">TransLet</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>map_transform <span class="main">(</span><span class="main">λ</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="free">transform_sumC</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">PropLetHeap</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLetBody</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="main">(</span>Let <span class="skolem">as</span> <span class="skolem">body</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_supp supp_Pair pure_supp exp_assn.fsupp
               <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> supp_eqvt_at<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SuppTransLet<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> supp_map<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="main">::</span> <span class="quoted">perm</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">π</span> <span class="main">♯*</span> Terms.Let <span class="skolem">as</span> <span class="skolem">body</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">π</span> <span class="main">♯*</span> <span class="free">TransLet</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>map_transform <span class="main">(</span><span class="main">λ</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="free">transform_sumC</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">PropLetHeap</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLetBody</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">TransLet</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>map_transform <span class="main">(</span><span class="main">λ</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="free">transform_sumC</span><span class="main">)</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">PropLetHeap</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="free">transform_sumC</span><span class="main">)</span> <span class="main">(</span><span class="free">PropLetBody</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        <span class="skolem">π</span> <span class="main">∙</span> <span class="free">TransLet</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>map_transform <span class="main">(</span><span class="main">λ</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="free">transform_sumC</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">PropLetHeap</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLetBody</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Let_eq_iff Pair_eqvt <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  eqvt_at_apply<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">TransLet</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>map_transform <span class="main">(</span><span class="main">λ</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="free">transform_sumC</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">PropLetHeap</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLetBody</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> perm_supp_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_transform <span class="main">(</span><span class="main">λ</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="free">transform_sumC</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">PropLetHeap</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span>
        <span class="main">=</span> map_transform <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="free">transform_sumC</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">PropLetHeap</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> map_transform_fundef_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> set_eqvt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mem_permute_set<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_self  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eqvt_at_apply''<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> aa <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span></span> <span class="skolem">a</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">π</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="free">transform_sumC</span><span class="main">)</span> <span class="main">(</span><span class="free">PropLetBody</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span> <span class="main">=</span> <span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLetBody</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eqvt_at_apply''<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">π</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">TransLet</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>map_transform <span class="main">(</span><span class="main">λ</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="free">transform_sumC</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">PropLetHeap</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLetBody</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="free">TransLet</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>map_transform <span class="main">(</span><span class="main">λ</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="free">transform_sumC</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">PropLetHeap</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="free">transform_sumC</span> <span class="main">(</span><span class="free">PropLetBody</span> <span class="main">(</span><span class="free">AnalLet</span> <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">nominal_termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

  <span class="keyword1" id="AbstractTransform-supp_transform"><span class="command">lemma</span></span> supp_transform<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>transform <span class="free">a</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> PropApp_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLam_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLetBody_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span>  AnalLet_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLetHeap_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> TransVar_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>  TransApp_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>  TransLam_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span> TransLet_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> transform.eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> supp_fun_app_eqvt<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eqvtI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">perm_simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> reflexive<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="AbstractTransform-fv_transform"><span class="command">lemma</span></span> fv_transform<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>transform <span class="free">a</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> supp_transform<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> AbstractTransformSubst <span class="main">=</span> AbstractTransform <span class="main">+</span> AbstractAnalPropSubst <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> TransVar_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">TransVar</span> <span class="free">a</span> <span class="free">v</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">TransVar</span> <span class="free">a</span> <span class="free">v</span><span class="main">[</span><span class="free">x</span> <span class="keyword1">::v=</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> TransApp_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">TransApp</span> <span class="free">a</span> <span class="free">e</span> <span class="free">v</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">TransApp</span> <span class="free">a</span> <span class="free">e</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span> <span class="free">v</span><span class="main">[</span><span class="free">x</span> <span class="keyword1">::v=</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> TransLam_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">v</span> <span class="main">♯</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">TransLam</span> <span class="free">a</span> <span class="free">v</span> <span class="free">e</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">TransLam</span> <span class="free">a</span> <span class="free">v</span><span class="main">[</span><span class="free">x</span> <span class="keyword1">::v=</span> <span class="free">y</span><span class="main">]</span> <span class="free">e</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> TransLet_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Γ</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">TransLet</span> <span class="free">b</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">TransLet</span> <span class="free">b</span> <span class="free">Γ</span><span class="main">[</span><span class="free">x</span> <span class="keyword1">::h=</span> <span class="free">y</span><span class="main">]</span> <span class="free">e</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1" id="AbstractTransform-subst_transform"><span class="command">lemma</span></span> subst_transform<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transform <span class="free">a</span> <span class="free">e</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> transform <span class="free">a</span> <span class="free">e</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exp_strong_induct_set<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">body</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Δ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> domA <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_at_base<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">AnalLet</span> <span class="skolem">Δ</span><span class="main">[</span><span class="skolem">x</span><span class="keyword1">::h=</span><span class="skolem">y</span><span class="main">]</span> <span class="skolem">body</span><span class="main">[</span><span class="skolem">x</span><span class="main">::=</span><span class="skolem">y</span><span class="main">]</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">AnalLet</span> <span class="skolem">Δ</span> <span class="skolem">body</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AnalLet_subst<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Let
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair TransLet_subst <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Let_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arg_cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">TransLet</span></span> <span class="skolem"><span class="skolem">b</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span></span> <span class="skolem"><span class="skolem">b</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_map_transform<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> TransVar_subst TransApp_subst TransLam_subst<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> AbstractTransformBound <span class="main">=</span> AbstractAnalProp <span class="main">+</span> supp_bounded_transform  <span class="main">+</span>
  <span class="keyword2"><span class="keyword">constrains</span></span> PropApp <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>pure_cont_pt"</span></span>
  <span class="keyword2"><span class="keyword">constrains</span></span> PropLetHeap <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">::</span>cont_pt <span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">constrains</span></span> trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span><span class="main">::</span>cont_pt <span class="main">⇒</span> exp <span class="main">⇒</span> exp"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">PropLetHeapTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'c</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PropLetHeapTrans_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">PropLetHeapTrans</span> <span class="main">=</span> <span class="free">PropLetHeapTrans</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> TransBound_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">trans</span> <span class="main">=</span> <span class="free">trans</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">sublocale</span></span> AbstractTransform <span class="quoted"><span class="free">PropApp</span></span> <span class="quoted"><span class="free">PropLam</span></span> <span class="quoted"><span class="free">AnalLet</span></span> <span class="quoted"><span class="free">PropLetBody</span></span> <span class="quoted"><span class="free">PropLetHeap</span></span> <span class="quoted"><span class="free">PropIfScrut</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> Var<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> App<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> Terms.Lam<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">b</span> <span class="bound">Γ</span> <span class="bound">e</span> <span class="main">.</span> Let <span class="main">(</span>map_transform <span class="free">trans</span> <span class="main">(</span><span class="free">PropLetHeapTrans</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">Γ</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">note</span></span> PropApp_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLam_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLetBody_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLetHeap_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropIfScrut_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span>
        AnalLet_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLetHeapTrans_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span> TransBound_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_assn.supp supp_at_base<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_supp supp_Pair supp_at_base <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> supp_map_transform<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="AbstractTransform-isLam_transform"><span class="command">lemma</span></span> isLam_transform<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"isLam <span class="main">(</span>transform <span class="free">a</span> <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> isLam <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>isLam.induct<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="AbstractTransform-isVal_transform"><span class="command">lemma</span></span> isVal_transform<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"isVal <span class="main">(</span>transform <span class="free">a</span> <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> isVal <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>isLam.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> AbstractTransformBoundSubst <span class="main">=</span> AbstractAnalPropSubst <span class="main">+</span> AbstractTransformBound <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> TransBound_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">trans</span> <span class="free">a</span> <span class="free">e</span><span class="main">)</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">trans</span> <span class="free">a</span> <span class="free">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">sublocale</span></span> AbstractTransformSubst <span class="quoted"><span class="free">PropApp</span></span> <span class="quoted"><span class="free">PropLam</span></span> <span class="quoted"><span class="free">AnalLet</span></span> <span class="quoted"><span class="free">PropLetBody</span></span> <span class="quoted"><span class="free">PropLetHeap</span></span> <span class="quoted"><span class="free">PropIfScrut</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> Var<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> App<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> Terms.Lam<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">b</span> <span class="bound">Γ</span> <span class="bound">e</span> <span class="main">.</span> Let <span class="main">(</span>map_transform <span class="free">trans</span> <span class="main">(</span><span class="free">PropLetHeapTrans</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">Γ</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">note</span></span> PropApp_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLam_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLetBody_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropLetHeap_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span> PropIfScrut_eqvt<span class="main">[</span><span class="operator">eqvt_raw</span><span class="main">]</span>
         TransBound_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Let_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> Let <span class="bound"><span class="bound">x</span></span> <span class="skolem"><span class="skolem">y</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_map_transform<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> TransBound_subst<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="EtaExpansion">
<div class="head">
<h1>Theory EtaExpansion</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> EtaExpansion
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../launchbury/theories/#Terms">Launchbury.Terms</a> <a href="../../launchbury/theories/#Substitution">Launchbury.Substitution</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fresh_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> var"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fresh_var</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∉</span> fv <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="EtaExpansion-fresh_var_not_free"><span class="command">lemma</span></span> fresh_var_not_free<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fresh_var <span class="free">e</span> <span class="main">∉</span> fv <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">v</span> <span class="main">♯</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> obtain_fresh<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> fv <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fv_not_fresh<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fresh_var_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EtaExpansion-fresh_var_fresh"><span class="command">lemma</span></span> fresh_var_fresh<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"atom <span class="main">(</span>fresh_var <span class="free">e</span><span class="main">)</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_var_not_free fv_not_fresh<span class="main">)</span>

<span class="keyword1" id="EtaExpansion-fresh_var_subst"><span class="command">lemma</span></span> fresh_var_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">[</span>fresh_var <span class="free">e</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_var_fresh subst_fresh_noop<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eta_expand</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> exp <span class="main">⇒</span> exp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">eta_expand</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">eta_expand</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span>fresh_var <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">].</span> <span class="free">eta_expand</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>fresh_var <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="EtaExpansion-eta_expand_eqvt"><span class="command">lemma</span></span> eta_expand_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>eta_expand <span class="free">n</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> eta_expand <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">π</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair permute_pure<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fresh_at_base_permI fresh_at_base_permute_iff fresh_var_fresh subst_fresh_noop subst_swap_same<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EtaExpansion-fresh_eta_expand"><span class="command">lemma</span></span> fresh_eta_expand<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> eta_expand <span class="free">n</span> <span class="free">e</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span>  <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_at_base<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_var_fresh<span class="main">)</span>

<span class="keyword1" id="EtaExpansion-subst_eta_expand"><span class="command">lemma</span></span> subst_eta_expand<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>eta_expand <span class="free">n</span> <span class="free">e</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> eta_expand <span class="free">n</span> <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">z</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> fresh_var <span class="skolem">e</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> obtain_fresh<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>eta_expand <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span>fresh_var <span class="skolem">e</span><span class="main">].</span> eta_expand <span class="skolem">n</span> <span class="main">(</span>App <span class="skolem">e</span> <span class="main">(</span>fresh_var <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">z</span><span class="main">].</span> eta_expand <span class="skolem">n</span> <span class="main">(</span>App <span class="skolem">e</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> change_Lam_Variable<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹atom <span class="skolem">z</span> <span class="main">♯</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair eta_expand_eqvt pure_fresh permute_pure flip_fresh_fresh <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eqvt_fresh_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">eta_expand</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> eta_expand_eqvt<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">z</span><span class="main">].</span> <span class="main">(</span>eta_expand <span class="skolem">n</span> <span class="main">(</span>App <span class="skolem">e</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹atom <span class="skolem">z</span> <span class="main">♯</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">z</span><span class="main">].</span> eta_expand <span class="skolem">n</span> <span class="main">(</span>App <span class="skolem">e</span> <span class="skolem">z</span><span class="main">)</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Suc.IH<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">z</span><span class="main">].</span> eta_expand <span class="skolem">n</span> <span class="main">(</span>App <span class="skolem">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹atom <span class="skolem">z</span> <span class="main">♯</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span>fresh_var <span class="main">(</span><span class="skolem">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">].</span> eta_expand <span class="skolem">n</span> <span class="main">(</span>App <span class="skolem">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span> <span class="main">(</span>fresh_var <span class="main">(</span><span class="skolem">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> change_Lam_Variable<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"fresh_var <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">e</span></span><span class="main"><span class="main">[</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">::=</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹atom <span class="skolem">z</span> <span class="main">♯</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair eqvt_fresh_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">eta_expand</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> eta_expand_eqvt<span class="main"><span class="main">]</span></span> pure_fresh eta_expand_eqvt  flip_fresh_fresh subst_pres_fresh <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> exp_assn.eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> eta_expand <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EtaExpansion-isLam_eta_expand"><span class="command">lemma</span></span> isLam_eta_expand<span class="main">:</span>
  <span class="quoted"><span class="quoted">"isLam <span class="free">e</span> <span class="main">⟹</span> isLam <span class="main">(</span>eta_expand <span class="free">n</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> isLam <span class="main">(</span>eta_expand <span class="free">n</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="EtaExpansion-isVal_eta_expand"><span class="command">lemma</span></span> isVal_eta_expand<span class="main">:</span>
  <span class="quoted"><span class="quoted">"isVal <span class="free">e</span> <span class="main">⟹</span> isVal <span class="main">(</span>eta_expand <span class="free">n</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> isVal <span class="main">(</span>eta_expand <span class="free">n</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="EtaExpansionSafe">
<div class="head">
<h1>Theory EtaExpansionSafe</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> EtaExpansionSafe
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#EtaExpansion">EtaExpansion</a> <a href="#Sestoft">Sestoft</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> eta_expansion_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">T</span> <span class="main">⊆</span> range Arg"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> eta_expand <span class="main">(</span>length <span class="free">T</span><span class="main">)</span> <span class="free">e</span><span class="main">,</span> <span class="free">T</span><span class="main">@</span><span class="free">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">T</span><span class="main">@</span><span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">se</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">se</span> <span class="main">=</span> Arg <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">T</span> <span class="main">⊆</span> range Arg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> eta_expand <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="skolem">e</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">T</span> <span class="main">@</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span>fresh_var <span class="skolem">e</span><span class="main">].</span> eta_expand <span class="main">(</span>length <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span>App <span class="skolem">e</span> <span class="main">(</span>fresh_var <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">T</span> <span class="main">@</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⇒</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="main">(</span>eta_expand <span class="main">(</span>length <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span>App <span class="skolem">e</span> <span class="main">(</span>fresh_var <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">[</span>fresh_var <span class="skolem">e</span> <span class="main">::=</span> <span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">T</span> <span class="main">@</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> app<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="main">(</span>eta_expand <span class="main">(</span>length <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span>App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">T</span> <span class="main">@</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> subst_eta_expand <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span> <span class="main">@</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⇒</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">T</span> <span class="main">@</span> <span class="free">S</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> app<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">se</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arg_prefix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"stack <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arg_prefix</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">arg_prefix</span> <span class="main">(</span>Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">arg_prefix</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">arg_prefix</span> <span class="main">(</span>Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">arg_prefix</span> <span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">arg_prefix</span> <span class="main">(</span>Dummy <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> eta_expansion_safe'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> arg_prefix <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> eta_expand <span class="free">n</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take <span class="free">n</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> range Arg"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="free">n</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> arg_prefix.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">n</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">S</span> <span class="main">@</span> drop <span class="free">n</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> eta_expansion_safe<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">⊆</span> <span class="main">_</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹length <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ArityStack">
<div class="head">
<h1>Theory ArityStack</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ArityStack
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Arity">Arity</a> <a href="#SestoftConf">SestoftConf</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Astack</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"stack <span class="main">⇒</span> Arity"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Astack</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Astack</span> <span class="main">(</span>Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> inc<span class="main">⋅</span><span class="main">(</span><span class="free">Astack</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Astack</span> <span class="main">(</span>Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Astack</span> <span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Astack</span> <span class="main">(</span>Dummy <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="ArityStack-Astack_restr_stack_below"><span class="command">lemma</span></span> Astack_restr_stack_below<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Astack <span class="main">(</span>restr_stack <span class="free">V</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> Astack <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> restr_stack.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ArityStack-Astack_map_Dummy"><span class="command">lemma</span></span> Astack_map_Dummy<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Astack <span class="main">(</span>map Dummy <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ArityStack-Astack_append_map_Dummy"><span class="command">lemma</span></span> Astack_append_map_Dummy<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Astack <span class="free">S'</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> Astack <span class="main">(</span><span class="free">S</span> <span class="main">@</span> <span class="free">S'</span><span class="main">)</span> <span class="main">=</span> Astack <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Astack.induct<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ArityEtaExpansion">
<div class="head">
<h1>Theory ArityEtaExpansion</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ArityEtaExpansion
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#EtaExpansion">EtaExpansion</a> <span class="quoted">"<a href="Arity-Nominal.html">Arity-Nominal</a>"</span> <a href="#TransformTools">TransformTools</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> Aeta_expand <span class="main">::</span> <span class="quoted"><span class="quoted">"Arity <span class="main">⇒</span> exp <span class="main">⇒</span> exp"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"eta_expand"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="ArityEtaExpansion-Aeta_expand_eqvt"><span class="command">lemma</span></span> Aeta_expand_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> Aeta_expand <span class="free">a</span> <span class="free">e</span> <span class="main">=</span> Aeta_expand <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ArityEtaExpansion-Aeta_expand_0"><span class="command">lemma</span></span> Aeta_expand_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Aeta_expand <span class="main">0</span> <span class="free">e</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="ArityEtaExpansion-Aeta_expand_inc"><span class="command">lemma</span></span> Aeta_expand_inc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Aeta_expand <span class="main">(</span>inc<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span>fresh_var <span class="free">e</span><span class="main">].</span> Aeta_expand <span class="free">n</span> <span class="main">(</span>App <span class="free">e</span> <span class="main">(</span>fresh_var <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="ArityEtaExpansion-subst_Aeta_expand"><span class="command">lemma</span></span> subst_Aeta_expand<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Aeta_expand <span class="free">n</span> <span class="free">e</span><span class="main">)</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> Aeta_expand <span class="free">n</span> <span class="free">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> subst_eta_expand<span class="main">)</span>

<span class="keyword1" id="ArityEtaExpansion-isLam_Aeta_expand"><span class="command">lemma</span></span> isLam_Aeta_expand<span class="main">:</span> <span class="quoted"><span class="quoted">"isLam <span class="free">e</span> <span class="main">⟹</span> isLam <span class="main">(</span>Aeta_expand <span class="free">a</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> isLam_eta_expand<span class="main">)</span>

<span class="keyword1" id="ArityEtaExpansion-isVal_Aeta_expand"><span class="command">lemma</span></span> isVal_Aeta_expand<span class="main">:</span> <span class="quoted"><span class="quoted">"isVal <span class="free">e</span> <span class="main">⟹</span> isVal <span class="main">(</span>Aeta_expand <span class="free">a</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> isVal_eta_expand<span class="main">)</span>

<span class="keyword1" id="ArityEtaExpansion-Aeta_expand_fresh"><span class="command">lemma</span></span> Aeta_expand_fresh<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> Aeta_expand <span class="free">n</span> <span class="free">e</span> <span class="main">=</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
<span class="keyword1" id="ArityEtaExpansion-Aeta_expand_fresh_star"><span class="command">lemma</span></span> Aeta_expand_fresh_star<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> Aeta_expand <span class="free">n</span> <span class="free">e</span> <span class="main">=</span> <span class="free">a</span> <span class="main">♯*</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> supp_bounded_transform <span class="quoted">Aeta_expand</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">using</span></span> Aeta_expand_fresh
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ArityEtaExpansionSafe">
<div class="head">
<h1>Theory ArityEtaExpansionSafe</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ArityEtaExpansionSafe
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#EtaExpansionSafe">EtaExpansionSafe</a> <a href="#ArityStack">ArityStack</a> <a href="#ArityEtaExpansion">ArityEtaExpansion</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="ArityEtaExpansionSafe-Aeta_expand_safe"><span class="command">lemma</span></span> Aeta_expand_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Astack <span class="free">S</span> <span class="main">⊑</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Aeta_expand <span class="free">a</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arg_prefix <span class="free">S</span> <span class="main">=</span> Rep_Arity <span class="main">(</span>Astack <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> arg_prefix.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Arity.zero_Arity.rep_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
 <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_Arity <span class="free">a</span> <span class="main">≤</span> Rep_Arity <span class="main">(</span>Astack <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_Arity.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> eta_expansion_safe'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ArityTransform">
<div class="head">
<h1>Theory ArityTransform</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ArityTransform
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#ArityAnalysisSig">ArityAnalysisSig</a> <a href="#AbstractTransform">AbstractTransform</a> <a href="#ArityEtaExpansionSafe">ArityEtaExpansionSafe</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> ArityAnalysisHeapEqvt
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">sublocale</span></span> AbstractTransformBound
  <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> inc<span class="main">⋅</span><span class="bound">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> pred<span class="main">⋅</span><span class="bound">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">Δ</span> <span class="bound">e</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">Aheap</span> <span class="bound">Δ</span> <span class="bound">e</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"fst"</span></span>
  <span class="quoted"><span class="quoted">"snd"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"Aeta_expand"</span></span>
  <span class="quoted"><span class="quoted">"snd"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">rule</span> eq_reflection<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">transform_syn</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒯⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒯<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">a</span></span></span></sub><span class="hidden">⇙</span> <span class="main">≡</span> transform <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1" id="ArityTransform-transform_simps"><span class="command">lemma</span></span> transform_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝒯<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span>App <span class="free">e</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> App <span class="main">(</span>𝒯<span class="hidden">⇘</span><sub>inc<span class="main">⋅</span><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒯<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> 𝒯<span class="hidden">⇘</span><sub>pred<span class="main">⋅</span><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒯<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Var <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒯<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> Let <span class="main">(</span>map_transform Aeta_expand <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">(</span>map_transform <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> 𝒯<span class="hidden">⇘</span><sub><span class="bound">a</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>𝒯<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒯<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span>Bool <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Bool <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒯<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>𝒯<span class="hidden">⇘</span><sub><span class="main">0</span></sub><span class="hidden">⇙</span> <span class="free">scrut</span> <span class="main">?</span> 𝒯<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e1</span> <span class="main">:</span> 𝒯<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ArityConsistent">
<div class="head">
<h1>Theory ArityConsistent</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ArityConsistent
<span class="keyword2"><span class="keyword">imports</span></span>  <a href="#ArityAnalysisSpec">ArityAnalysisSpec</a>  <a href="#ArityStack">ArityStack</a> <a href="#ArityAnalysisStack">ArityAnalysisStack</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> ArityAnalysisLetSafe
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> astate <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>AEnv <span class="main">×</span> Arity <span class="main">×</span> Arity list<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">stack_consistent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Arity list <span class="main">⇒</span> stack <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">stack_consistent</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"Astack <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="free">stack_consistent</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟹</span> <span class="free">stack_consistent</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">stack_consistent</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟹</span> <span class="free">stack_consistent</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">stack_consistent</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟹</span> <span class="free">stack_consistent</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span>Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_simps</span></span> stack_consistent_foo<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"stack_consistent <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"stack_consistent <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">(</span>Alts <span class="free">e1</span> <span class="free">e2</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"stack_consistent <span class="free">as</span> <span class="main">(</span>Upd <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"stack_consistent <span class="free">as</span> <span class="main">(</span>Arg <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stack_consistent <span class="free">as</span> <span class="main">(</span>Alts <span class="free">e1</span> <span class="free">e2</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">a_consistent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"astate <span class="main">⇒</span> conf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  a_consistentI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"edom <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="main">⊆</span> domA <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">∪</span> upds <span class="free"><span class="bound"><span class="entity">S</span></span></span>
  <span class="main">⟹</span> Astack <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>
  <span class="main">⟹</span> <span class="main">(</span>ABinds <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⊔</span> AEstack <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">∪</span> upds <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">ae</span></span></span>
  <span class="main">⟹</span> stack_consistent <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>
  <span class="main">⟹</span> <span class="free">a_consistent</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>  
<span class="keyword1"><span class="command">inductive_cases</span></span> a_consistentE<span class="main">:</span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ArityConsistent-a_consistent_restrictA"><span class="command">lemma</span></span> a_consistent_restrictA<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"edom <span class="free">ae</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>restrictA <span class="free">V</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">∩</span> <span class="free">V</span> <span class="main">∪</span> upds <span class="free">S</span> <span class="main">⊆</span> domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> below_trans<span class="main">[</span><span class="operator">OF</span> env_restr_mono2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>restrictA <span class="free">V</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_consistent.simps env_restr_join join_below_iff ABinds_restrict_edom
                  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> * below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> env_restr_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> ABinds_restrict_below<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ArityConsistent-a_consistent_edom_subsetD"><span class="command">lemma</span></span> a_consistent_edom_subsetD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> edom <span class="free">ae</span> <span class="main">⊆</span> domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> a_consistentE<span class="main">)</span>

<span class="keyword1" id="ArityConsistent-a_consistent_stackD"><span class="command">lemma</span></span> a_consistent_stackD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> Astack <span class="free">S</span> <span class="main">⊑</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> a_consistentE<span class="main">)</span>


<span class="keyword1" id="ArityConsistent-a_consistent_app"><span class="command">lemma</span></span> a_consistent_app<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>
  <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> App <span class="free">e</span> <span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> inc<span class="main">⋅</span><span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> Arg <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff env_restr_join a_consistent.simps
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> env_restr_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Aexp_App<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
           <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span>

<span class="keyword1" id="ArityConsistent-a_consistent_app"><span class="command">lemma</span></span> a_consistent_app<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span><span class="main">,</span> Arg <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="main">(</span>pred<span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span>  <span class="main">⊑</span> <span class="main">(</span>env_delete <span class="free">y</span> <span class="main">(</span><span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_subst<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  env_delete <span class="free">y</span> <span class="main">(</span><span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊔</span> esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"env_delete <span class="free">y</span> <span class="main">(</span><span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">Aexp</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Aexp_Lam<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff env_restr_join a_consistent.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>edom <span class="free">ae</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join join_below_iff a_consistent.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="main">⊔</span> <span class="free">ae</span> <span class="main">=</span> <span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans edom_mono  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff env_restr_join a_consistent.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ArityConsistent-a_consistent_thunk_0"><span class="command">lemma</span></span> a_consistent_thunk_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Var <span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> Upd <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domI dom_map_of_conv_domA<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> edom <span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> domI dom_map_of_conv_domA<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span>  <span class="main">=</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> Abinds_reorder1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="main">0</span> <span class="main">=</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> join_comm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span> <span class="main">⊔</span> AEstack <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff env_restr_join a_consistent.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ABinds <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊔</span> AEstack <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff env_restr_join  a_consistent.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ArityConsistent-a_consistent_thunk_once"><span class="command">lemma</span></span> a_consistent_thunk_once<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Var <span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span>env_delete <span class="free">x</span> <span class="free">ae</span><span class="main">,</span> <span class="free">u</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domI dom_map_of_conv_domA<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff env_restr_join a_consistent.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fun_belowD<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">⊑</span> up<span class="main">⋅</span><span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> below_trans<span class="main">[</span><span class="operator">OF</span> Aexp_Var this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> upds <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_consistent.simps <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> heap_upds_okE<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Astack <span class="free">S</span> <span class="main">⊑</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">⊑</span> <span class="free">u</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_consistent.simps<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> Abinds_reorder1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="free">u</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">u</span> <span class="main">=</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> join_comm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span> <span class="main">⊔</span> AEstack <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff env_restr_join a_consistent.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ABinds <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">u</span> <span class="main">⊔</span> AEstack <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ABinds <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>env_delete <span class="free">x</span> <span class="free">ae</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">u</span> <span class="main">⊔</span> AEstack <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff env_restr_join <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>  below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> env_restr_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> monofun_cfun_arg<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> env_delete_below_arg<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"env_delete <span class="free">x</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>ABinds <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>env_delete <span class="free">x</span> <span class="free">ae</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">u</span> <span class="main">⊔</span> AEstack <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> env_delete <span class="free">x</span> <span class="free">ae</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_delete_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>ABinds <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>env_delete <span class="free">x</span> <span class="free">ae</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">u</span> <span class="main">⊔</span> AEstack <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> env_delete <span class="free">x</span> <span class="free">ae</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_delete_restr<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="free">u</span>›</span></span> <span class="quoted"><span class="quoted">‹Astack <span class="free">S</span> <span class="main">⊑</span> <span class="free">u</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff env_restr_join  a_consistent.simps <span class="quasi_keyword">elim</span> <span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ArityConsistent-a_consistent_lamvar"><span class="command">lemma</span></span> a_consistent_lamvar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Var <span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">u</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">#</span> delete <span class="free">x</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> domI dom_map_of_conv_domA<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff env_restr_join a_consistent.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fun_belowD<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">⊑</span> up<span class="main">⋅</span><span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> below_trans<span class="main">[</span><span class="operator">OF</span> Aexp_Var this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Astack <span class="free">S</span> <span class="main">⊑</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">⊑</span> <span class="free">u</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_consistent.simps<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> Abinds_reorder1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="free">u</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">u</span> <span class="main">=</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> join_comm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span> <span class="main">⊔</span> AEstack <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff env_restr_join a_consistent.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ABinds <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">u</span> <span class="main">⊔</span> AEstack <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="free">u</span>›</span></span> <span class="quoted"><span class="quoted">‹Astack <span class="free">S</span> <span class="main">⊑</span> <span class="free">u</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff env_restr_join  a_consistent.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> Upd <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> a_consistent_var<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> a_consistent_UpdD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff env_restr_join a_consistent.simps 
               <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> env_restr_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> ABinds_delete_below<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="ArityConsistent-a_consistent_let"><span class="command">lemma</span></span> a_consistent_let<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Let <span class="free">Δ</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Δ</span> <span class="main">♯*</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Δ</span> <span class="main">♯*</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"edom <span class="free">ae</span> <span class="main">∩</span> domA <span class="free">Δ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹
    First some boring stuff about scope:
›</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆</span> domA <span class="free">Δ</span> <span class="main">⟹</span> <span class="free">ae</span> <span class="keyword1">f|`</span> <span class="bound">S</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">ae</span><span class="main">)</span> <span class="main">=</span> ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abinds_env_restr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="keyword1">f|`</span> domA <span class="free">Γ</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> env_restr_empty <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">ae</span><span class="main">)</span> <span class="main">=</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abinds_env_restr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Δ</span> <span class="main">∪</span> domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span>  <span class="main">=</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> env_restr_cong <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_AnalBinds<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"AEstack <span class="free">as</span> <span class="free">S</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Δ</span> <span class="main">∪</span> domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">=</span> AEstack <span class="free">as</span> <span class="free">S</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> env_restr_cong <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_AEstack<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="main">(</span>Let <span class="free">Δ</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Δ</span> <span class="main">∪</span> domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">Aexp</span> <span class="main">(</span>Terms.Let <span class="free">Δ</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Δ</span> <span class="main">∪</span> domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_useless<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ABinds <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊔</span> AEstack <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_consistent.simps join_below_iff env_restr_join<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span><span class="quoted"><span class="quoted">" <span class="free">Aexp</span> <span class="main">(</span>Let <span class="free">Δ</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_consistent.simps join_below_iff env_restr_join<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊑</span> <span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="main">(</span>Let <span class="free">Δ</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Aexp_Let<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ABinds <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">ae</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> AEstack <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="main">(</span><span class="free">Δ</span><span class="main">@</span><span class="free">Γ</span><span class="main">)</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">ae</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join Abinds_append_disjoint<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fresh_distinct<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> join_below_iff
                 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> join_comm
                 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> env_restr_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"domA <span class="free">Δ</span> <span class="main">∩</span> upds <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ups_fv_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_consistent.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> heap_upds_ok_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ArityConsistent-a_consistent_if"><span class="command">lemma</span></span> a_consistent_if<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">scrut</span><span class="main">,</span> Alts <span class="free">e1</span> <span class="free">e2</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_consistent.simps env_restr_join join_below_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aexp</span> <span class="free">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e1</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="free">e2</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="free">Γ</span> <span class="main">∪</span> upds <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ae</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> env_restr_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_IfThenElse<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_consistent.simps join_below_iff env_restr_join<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ArityConsistent-a_consistent_if"><span class="command">lemma</span></span> a_consistent_if<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">a'</span><span class="main">#</span><span class="free">as'</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Bool <span class="free">b</span><span class="main">,</span> Alts <span class="free">e1</span> <span class="free">e2</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a'</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">e1</span> <span class="keyword1">else</span> <span class="free">e2</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_consistent.simps join_below_iff env_restr_join<span class="main">)</span>

<span class="keyword1" id="ArityConsistent-a_consistent_alts_on_stack"><span class="command">lemma</span></span> a_consistent_alts_on_stack<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Bool <span class="free">b</span><span class="main">,</span> Alts <span class="free">e1</span> <span class="free">e2</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a'</span> <span class="free">as'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="free">a'</span> <span class="main">#</span> <span class="free">as'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_consistent.simps<span class="main">)</span>

<span class="keyword1" id="ArityConsistent-closed_a_consistent"><span class="command">lemma</span></span> closed_a_consistent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fv <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">::</span>var set<span class="main">)</span> <span class="main">⟹</span> a_consistent <span class="main">(</span><span class="main">⊥</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_empty_iff_bot a_consistent.simps  <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ArityTransformSafe">
<div class="head">
<h1>Theory ArityTransformSafe</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ArityTransformSafe
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#ArityTransform">ArityTransform</a> <a href="#ArityConsistent">ArityConsistent</a> <a href="#ArityAnalysisSpec">ArityAnalysisSpec</a> <a href="#ArityEtaExpansionSafe">ArityEtaExpansionSafe</a> <a href="#AbstractTransform">AbstractTransform</a> <a href="#ConstOn">ConstOn</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> CardinalityArityTransformation <span class="main">=</span> ArityAnalysisLetSafeNoCard
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">sublocale</span></span> AbstractTransformBoundSubst
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> inc<span class="main">⋅</span><span class="bound">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> pred<span class="main">⋅</span><span class="bound">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">Δ</span> <span class="bound">e</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">Aheap</span> <span class="bound">Δ</span> <span class="bound">e</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"fst"</span></span>
    <span class="quoted"><span class="quoted">"snd"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"Aeta_expand"</span></span>
    <span class="quoted"><span class="quoted">"snd"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aheap_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_Aeta_expand<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ccTransform</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ccTransform</span> <span class="main">≡</span> transform"</span></span>

  <span class="keyword1" id="ArityTransformSafe-supp_transform"><span class="command">lemma</span></span> supp_transform<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>transform <span class="free">a</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> transform.induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_assn.supp Let_supp <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> supp_map_transform<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> supp_map_transform_step<span class="main"><span class="main">]</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">interpretation</span></span> supp_bounded_transform <span class="quoted">transform</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_def supp_transform<span class="main">)</span> 

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">transform_alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Arity list <span class="main">⇒</span> stack <span class="main">⇒</span> stack"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">transform_alts</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transform_alts</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Alts <span class="main">(</span>ccTransform <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span>ccTransform <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free">transform_alts</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transform_alts</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">transform_alts</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

  <span class="keyword1" id="ArityTransformSafe-transform_alts_Nil"><span class="command">lemma</span></span> transform_alts_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transform_alts <span class="main">[]</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span>  <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="ArityTransformSafe-Astack_transform_alts"><span class="command">lemma</span></span> Astack_transform_alts<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Astack <span class="main">(</span>transform_alts <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> Astack <span class="free">S</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> transform_alts.induct<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="ArityTransformSafe-fresh_star_transform_alts"><span class="command">lemma</span></span> fresh_star_transform_alts<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">♯*</span> transform_alts <span class="free">as</span> <span class="free">S</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">S</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> transform_alts.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Cons<span class="main">)</span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">a_transform</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"astate <span class="main">⇒</span> conf <span class="main">⇒</span> conf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a_transform</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>map_transform Aeta_expand <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="main">(</span>map_transform ccTransform <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">,</span> 
     ccTransform <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span>
     transform_alts <span class="free"><span class="bound"><span class="entity">as</span></span></span>  <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">restr_conf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set <span class="main">⇒</span> conf <span class="main">⇒</span> conf"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">restr_conf</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>restrictA <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> restr_stack <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">consistent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"astate <span class="main">⇒</span> conf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    consistentI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> thunks <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⟹</span>  <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="bound">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="free">consistent</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">inductive_cases</span></span> consistentE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="ArityTransformSafe-closed_consistent"><span class="command">lemma</span></span> closed_consistent<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fv <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">::</span>var set<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="main">⊥</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_empty_iff_bot closed_a_consistent<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1" id="ArityTransformSafe-arity_tranform_safe"><span class="command">lemma</span></span> arity_tranform_safe<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="free">c'</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> boring_step <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok_conf <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">as</span><span class="main">)</span> <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ae'</span> <span class="bound">a'</span> <span class="bound">as'</span><span class="main">.</span> consistent <span class="main">(</span><span class="bound">ae'</span><span class="main">,</span><span class="bound">a'</span><span class="main">,</span><span class="bound">as'</span><span class="main">)</span> <span class="free">c'</span> <span class="main">∧</span> a_transform <span class="main">(</span><span class="free">ae</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">as</span><span class="main">)</span> <span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> a_transform <span class="main">(</span><span class="bound">ae'</span><span class="main">,</span><span class="bound">a'</span><span class="main">,</span><span class="bound">as'</span><span class="main">)</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> heap_upds_ok_invariant assms<span class="main">(</span>3-<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ae</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>step_invariant_induction<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> app<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a_consistent_app<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒</span> a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">Γ</span> <span class="skolem">y</span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> pred<span class="main">⋅</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> app<span class="hidden">⇩</span><sub>2</sub>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a_consistent_app<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒</span> a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> pred <span class="main">⋅</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_transform<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span>  <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>thunk <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thunks_domA<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹heap_upds_ok_conf <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> upds <span class="skolem">S</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> heap_upds_okE<span class="main">)</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> edom <span class="skolem">ae</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> thunk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> thunk <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> thunk <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_consistent_thunk_0 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> restr_delete<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> thunk <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  restr_delete_twist<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
  
    <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform ccTransform <span class="skolem">ae</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>transform <span class="main">0</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_map_transform<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> isVal <span class="skolem">e</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒</span> a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_transform_delete restr_delete_twist <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.intros  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> restr_delete<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lamvar <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> lamvar<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domI dom_map_of_conv_domA<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"up<span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> Aexp_Var<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> lamvar <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff env_restr_join a_consistent.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> edom <span class="skolem">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edomIff<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lamvar <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_consistent_lamvar <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> restr_delete<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lamvar <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  thunks_Cons restr_delete_twist <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹a_consistent <span class="main">_</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Astack <span class="main">(</span>transform_alts <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> a_consistent_stackD<span class="main">)</span>
  
    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="skolem">e</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isVal <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"isVal <span class="main">(</span>Aeta_expand <span class="skolem">u</span> <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> isVal_Aeta_expand<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up <span class="main">⋅</span> <span class="skolem">u</span>›</span></span>  <span class="quoted"><span class="quoted">‹isVal <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform transform <span class="skolem">ae</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>Aeta_expand <span class="skolem">u</span> <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_map_transform<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span>
          <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> Aeta_expand <span class="skolem">u</span> <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="main">(</span>map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform transform <span class="skolem">ae</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Aeta_expand <span class="skolem">u</span> <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span><span class="main">,</span> transform_alts <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lambda_var <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> restr_delete<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform transform <span class="skolem">ae</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Aeta_expand <span class="skolem">u</span> <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span><span class="main">,</span> transform_alts <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up <span class="main">⋅</span> <span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_transform_Cons map_transform_delete  <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> restr_delete<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span><span class="main">(</span>subst<span class="main">[</span><span class="operator">rotated</span><span class="main">]</span><span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restr_delete_twist<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> Aeta_expand_safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Astack <span class="main">_</span> <span class="main">⊑</span> <span class="skolem">u</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span><span class="main">(</span>rtranclp_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> var<span class="hidden">⇩</span><sub>2</sub>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> a_consistent_UpdD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> var<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_consistent_var<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> var<span class="hidden">⇩</span><sub>2</sub> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_Cons <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒</span> a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>›</span></span> var<span class="hidden">⇩</span><sub>2</sub>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_transform_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>let<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">Δ</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ae</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Δ</span> <span class="main">∩</span> upds <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ups_fv_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> upds <span class="skolem">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> edom <span class="var">?ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> restr_stack_simp2<span class="main">:</span> <span class="quoted"><span class="quoted">"restr_stack <span class="main">(</span>edom <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span><span class="main">)</span> <span class="skolem">S</span> <span class="main">=</span> restr_stack <span class="main">(</span>edom <span class="skolem">ae</span><span class="main">)</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> restr_stack_cong <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edom <span class="skolem">ae</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> let<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_consistent_edom_subsetD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edom <span class="skolem">ae</span> <span class="main">∩</span> domA <span class="skolem">Δ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ups_fv_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">e'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> let<span class="hidden">⇩</span><sub>1</sub>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">e'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Δ</span>"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aheap_heap3<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> let<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> let<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹edom <span class="skolem">ae</span> <span class="main">∩</span> domA <span class="skolem">Δ</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  a_consistent_let <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> join_comm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> edom <span class="var">?ae</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_transform Aeta_expand <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>map_transform transform <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>
         <span class="main">=</span> map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform transform <span class="skolem">ae</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_transform_cong restrictA_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edomIff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
  
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹edom <span class="skolem">ae</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="skolem">Δ</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> edom <span class="skolem">ae</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ups_fv_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_transform Aeta_expand <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>map_transform transform <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="skolem">Δ</span><span class="main">)</span>
         <span class="main">=</span> map_transform Aeta_expand <span class="var">?ae</span> <span class="main">(</span>map_transform transform <span class="var">?ae</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_transform_cong restrictA_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edomIff<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      
      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒</span> a_transform <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">,</span>  <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> restr_stack_simp2 let<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_transform_append restrictA_append  restr_stack_simp2<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> map_transform_restrA<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step.let<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">Γ</span> <span class="skolem">scrut</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">a</span><span class="main">#</span><span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">,</span> Alts <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> if<span class="hidden">⇩</span><sub>1</sub>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> a_consistent_if<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span>  <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒</span> a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">a</span><span class="main">#</span><span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">,</span> Alts <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">Γ</span> <span class="skolem">b</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Bool <span class="skolem">b</span><span class="main">,</span> Alts <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span>  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">as'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="skolem">a'</span> <span class="main">#</span> <span class="skolem">as'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> a_consistent_alts_on_stack<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e1</span> <span class="keyword1">else</span> <span class="skolem">e2</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> if<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_consistent_if<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Bool <span class="skolem">b</span><span class="main">,</span> Alts <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒</span> a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span>  <span class="skolem">a'</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e1</span> <span class="keyword1">else</span> <span class="skolem">e2</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step.if<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">True</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> step.if<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">False</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> refl <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>trans <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">c''</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> trans<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> trans<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ae'</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">as'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae'</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">)</span> <span class="skolem">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"a_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> a_transform <span class="main">(</span><span class="skolem">ae'</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">)</span> <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> trans<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ae''</span></span> <span class="skolem"><span class="skolem">a''</span></span> <span class="skolem"><span class="skolem">as''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae''</span><span class="main">,</span> <span class="skolem">a''</span><span class="main">,</span> <span class="skolem">as''</span><span class="main">)</span> <span class="skolem">c''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"a_transform <span class="main">(</span><span class="skolem">ae'</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">)</span> <span class="skolem">c'</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> a_transform <span class="main">(</span><span class="skolem">ae''</span><span class="main">,</span> <span class="skolem">a''</span><span class="main">,</span> <span class="skolem">as''</span><span class="main">)</span> <span class="skolem">c''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> rtranclp_trans<span class="main">[</span><span class="operator">OF</span> * **<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Set-Cpo">
<div class="head">
<h1>Theory Set-Cpo</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Set-Cpo"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOLCF/HOLCF.html">HOLCF</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">default_sort</span></span> <span class="quoted">type</span>

<span class="keyword1"><span class="command">instantiation</span></span> set <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">below</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">below_set</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊑)</span> <span class="main">=</span> <span class="main">(⊆)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span><span class="keyword1"><span class="command">..</span></span>  
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> set <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">po</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> below_set_def<span class="main">)</span>

<span class="keyword1" id="Set-Cpo-is_lub_set"><span class="command">lemma</span></span> is_lub_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">&lt;&lt;|</span> <span class="main">⋃</span><span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_lub_def below_set_def is_ub_def<span class="main">)</span>

<span class="keyword1" id="Set-Cpo-lub_set"><span class="command">lemma</span></span> lub_set<span class="main">:</span> <span class="quoted"><span class="quoted">"lub <span class="free">S</span> <span class="main">=</span> <span class="main">⋃</span><span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_lub_set lub_eqI<span class="main">)</span>
  
<span class="keyword1"><span class="command">instance</span></span> set  <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">cpo</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> is_lub_set<span class="main">)</span>

<span class="keyword1" id="Set-Cpo-minimal_set"><span class="command">lemma</span></span> minimal_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⊑</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> below_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instance</span></span> set  <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">pcpo</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> minimal_set<span class="main">)</span>

<span class="keyword1" id="Set-Cpo-set_contI"><span class="command">lemma</span></span> set_contI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Y</span><span class="main">.</span> chain <span class="bound">Y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> range <span class="bound">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> contI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"chain <span class="skolem">Y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> range <span class="skolem">Y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;&lt;|</span> <span class="free">f</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_lub_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set-Cpo-set_set_contI"><span class="command">lemma</span></span> set_set_contI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">S</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_contI assms is_lub_set  lub_eqI<span class="main">)</span>

<span class="keyword1" id="Set-Cpo-adm_subseteq"><span class="command">lemma</span></span> adm_subseteq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">⊆</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> admI<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cont2contlubE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> lub_set<span class="main">)</span>

<span class="keyword1" id="Set-Cpo-adm_Ball"><span class="command">lemma</span></span> adm_Ball<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="bound">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> admI  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lub_set<span class="main">)</span>

<span class="keyword1" id="Set-Cpo-finite_subset_chain"><span class="command">lemma</span></span> finite_subset_chain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="free">Y</span> <span class="main">`</span> UNIV<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="bound">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Y</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Max <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> chain_mono<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">Y</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> below_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> f
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set-Cpo-diff_cont"><span class="command">lemma</span></span> diff_cont<span class="main">[</span><span class="operator">THEN</span> cont_compose<span class="main">,</span> <span class="operator">simp</span><span class="main">,</span> <span class="operator">cont2cont</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">-</span> <span class="free">S'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_set_contI<span class="main">)</span> <span class="operator">simp</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Env-Set-Cpo">
<div class="head">
<h1>Theory Env-Set-Cpo</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Env-Set-Cpo"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../launchbury/theories/#Env">Launchbury.Env</a> <span class="quoted">"<a href="Set-Cpo.html">Set-Cpo</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Env-Set-Cpo-cont_edom"><span class="command">lemma</span></span> cont_edom<span class="main">[</span><span class="operator">THEN</span> cont_compose<span class="main">,</span> <span class="operator">simp</span><span class="main">,</span> <span class="operator">cont2cont</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> edom <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_contI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ch2ch_fun lub_eq_bottom_iff lub_fun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ch2ch_fun lub_eq_bottom_iff lub_fun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CoCallGraph">
<div class="head">
<h1>Theory CoCallGraph</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CoCallGraph
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../launchbury/theories/#Vars">Launchbury.Vars</a> <span class="quoted">"<a href="../Launchbury/HOLCF-Join-Classes.html">Launchbury.HOLCF-Join-Classes</a>"</span> <span class="quoted">"<a href="../Launchbury/HOLCF-Utils.html">Launchbury.HOLCF-Utils</a>"</span> <span class="quoted">"<a href="Set-Cpo.html">Set-Cpo</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">default_sort</span></span> <span class="quoted">type</span>

<span class="keyword1"><span class="command">typedef</span></span> CoCalls <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">G</span> <span class="main">::</span> <span class="main">(</span>var <span class="main">×</span> var<span class="main">)</span> set<span class="main">.</span>  sym <span class="bound">G</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> Rep_CoCall Abs_CoCall
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span> symI<span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_CoCalls

<span class="keyword1"><span class="command">instantiation</span></span> CoCalls <span class="main">::</span> <span class="quoted">po</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">below_CoCalls</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"CoCalls <span class="main">⇒</span> CoCalls <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> coCallsLub <span class="main">::</span> <span class="quoted"><span class="quoted">"CoCalls set <span class="main">⇒</span> CoCalls"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">S</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> symI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> symE<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-coCallsLub_is_lub"><span class="command">lemma</span></span> coCallsLub_is_lub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">&lt;&lt;|</span> coCallsLub <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> is_lubI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">&lt;|</span> coCallsLub <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_ubI<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">&lt;|</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_ubD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"coCallsLub <span class="free">S</span> <span class="main">⊑</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span> CoCalls <span class="main">::</span> <span class="quoted">cpo</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> CoCalls"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> range <span class="skolem">S</span> <span class="main">&lt;&lt;|</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coCallsLub_is_lub<span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-ccLubTransfer"><span class="command">lemma</span></span> ccLubTransfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set pcr_CoCalls <span class="main">===&gt;</span> pcr_CoCalls<span class="main">)</span> Union lub"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lub <span class="main">=</span> coCallsLub"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lub_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> coCallsLub_is_lub<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> coCallsLub.transfer
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> is_cc_lub <span class="main">::</span> <span class="quoted"><span class="quoted">"CoCalls set <span class="main">⇒</span> CoCalls <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">S</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Union <span class="bound">S</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoCallGraph-ccis_lubTransfer"><span class="command">lemma</span></span> ccis_lubTransfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set pcr_CoCalls  <span class="main">===&gt;</span> pcr_CoCalls <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">S</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Union <span class="bound">S</span><span class="main">)</span> <span class="main">(&lt;&lt;|)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">xa</span> <span class="main">.</span> is_cc_lub <span class="bound">x</span> <span class="bound">xa</span> <span class="main">⟷</span> <span class="bound">xa</span> <span class="main">=</span> coCallsLub <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cc_lub <span class="main">=</span> <span class="main">(&lt;&lt;|)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> coCallsLub_is_lub is_lub_unique<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> is_cc_lub.transfer <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> coCallsJoin <span class="main">::</span> <span class="quoted"><span class="quoted">"CoCalls <span class="main">⇒</span> CoCalls  <span class="main">⇒</span> CoCalls"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym_Un<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccJoinTransfer"><span class="command">lemma</span></span> ccJoinTransfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pcr_CoCalls <span class="main">===&gt;</span> pcr_CoCalls <span class="main">===&gt;</span> pcr_CoCalls<span class="main">)</span> <span class="main">(∪)</span> <span class="main">(⊔)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊔)</span> <span class="main">=</span> coCallsJoin"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lub_is_join<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_lub_def is_ub_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> coCallsJoin.transfer
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> ccEmpty <span class="main">::</span> <span class="quoted"><span class="quoted">"CoCalls"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> symI<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccEmpty_below"><span class="command">lemma</span></span> ccEmpty_below<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccEmpty <span class="main">⊑</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span> CoCalls <span class="main">::</span> <span class="quoted">pcpo</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">.</span> ccEmpty <span class="main">⊑</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">::</span>CoCalls<span class="main">)</span> <span class="main">⊑</span> <span class="bound">y</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-ccBotTransfer"><span class="command">lemma</span></span> ccBotTransfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pcr_CoCalls <span class="main">{}</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> ccEmpty <span class="main">⊑</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ccEmpty <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bottomI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ccEmpty.transfer <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-cc_lub_below_iff"><span class="command">lemma</span></span> cc_lub_below_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted">CoCalls</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lub <span class="free">X</span> <span class="main">⊑</span> <span class="free">G</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">G'</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="bound">G'</span> <span class="main">⊑</span> <span class="free">G</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> ccField <span class="main">::</span> <span class="quoted"><span class="quoted">"CoCalls <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">Field</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoCallGraph-ccField_nil"><span class="command">lemma</span></span> ccField_nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccField <span class="main">⊥</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span>
  inCC <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> CoCalls <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">--</span>_<span class="keyword1">∈</span>_"</span> <span class="main">[</span>1000<span class="main">,</span> 1000<span class="main">,</span> 900<span class="main">]</span> 900<span class="main">)</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">s</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">notInCC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> CoCalls <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">--</span>_<span class="keyword1">∉</span>_"</span> <span class="main">[</span>1000<span class="main">,</span> 1000<span class="main">,</span> 900<span class="main">]</span> 900<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">--</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">∉</span></span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">--</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1" id="CoCallGraph-notInCC_bot"><span class="command">lemma</span></span> notInCC_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∈</span><span class="main">⊥</span> <span class="main">⟷</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-below_CoCallsI"><span class="command">lemma</span></span> below_CoCallsI<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">--</span><span class="bound">y</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="bound">x</span><span class="main">--</span><span class="bound">y</span><span class="main">∈</span><span class="free">G'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">⊑</span> <span class="free">G'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-CoCalls_eqI"><span class="command">lemma</span></span> CoCalls_eqI<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">--</span><span class="bound">y</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟷</span> <span class="bound">x</span><span class="main">--</span><span class="bound">y</span><span class="main">∈</span><span class="free">G'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">=</span> <span class="free">G'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-in_join"><span class="command">lemma</span></span> in_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">--</span><span class="free">y</span> <span class="main">∈</span> <span class="main">(</span><span class="free">G</span><span class="main">⊔</span><span class="free">G'</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∈</span><span class="free">G</span> <span class="main">∨</span> <span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∈</span><span class="free">G'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-in_lub"><span class="command">lemma</span></span> in_lub<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∈</span><span class="main">(</span>lub <span class="free">S</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">G</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∈</span><span class="bound">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-in_CoCallsLubI"><span class="command">lemma</span></span> in_CoCallsLubI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∈</span>lub <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-adm_not_in"><span class="command">lemma</span></span> adm_not_in<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∉</span><span class="free">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> admI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cont2contlubE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> cc_delete <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> CoCalls <span class="main">⇒</span> CoCalls"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">z</span><span class="main">.</span> Set.filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">z</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≠</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> symI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> symE<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccField_cc_delete"><span class="command">lemma</span></span> ccField_cc_delete<span class="main">:</span> <span class="quoted"><span class="quoted">"ccField <span class="main">(</span>cc_delete <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> ccField <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Field_def <span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> ccProd <span class="main">::</span> <span class="quoted"><span class="quoted">"var set <span class="main">⇒</span> var set <span class="main">⇒</span> CoCalls"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">G×</span>"</span> 90<span class="main">)</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">S1</span> <span class="bound">S2</span><span class="main">.</span> <span class="bound">S1</span> <span class="main">×</span> <span class="bound">S2</span> <span class="main">∪</span> <span class="bound">S2</span> <span class="main">×</span> <span class="bound">S1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> symI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> symE<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccProd_empty"><span class="command">lemma</span></span> ccProd_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="keyword1">G×</span> <span class="free">S</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccProd_empty'"><span class="command">lemma</span></span> ccProd_empty'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">G×</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccProd_union2"><span class="command">lemma</span></span> ccProd_union2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">G×</span> <span class="main">(</span><span class="free">S'</span> <span class="main">∪</span> <span class="free">S''</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="keyword1">G×</span> <span class="free">S'</span> <span class="main">⊔</span> <span class="free">S</span> <span class="keyword1">G×</span> <span class="free">S''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccProd_Union2"><span class="command">lemma</span></span> ccProd_Union2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">G×</span> <span class="main">⋃</span><span class="free">S'</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">X</span><span class="main">∈</span><span class="free">S'</span><span class="main">.</span> ccProd <span class="free">S</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccProd_Union2'"><span class="command">lemma</span></span> ccProd_Union2'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">G×</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span><span class="main">∈</span><span class="free">S'</span><span class="main">.</span> <span class="free">f</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">X</span><span class="main">∈</span><span class="free">S'</span><span class="main">.</span> ccProd <span class="free">S</span> <span class="main">(</span><span class="free">f</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-in_ccProd"><span class="command">lemma</span></span> in_ccProd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∈</span><span class="main">(</span><span class="free">S</span> <span class="keyword1">G×</span> <span class="free">S'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">S'</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S'</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccProd_union1"><span class="command">lemma</span></span> ccProd_union1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S'</span> <span class="main">∪</span> <span class="free">S''</span><span class="main">)</span> <span class="keyword1">G×</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S'</span> <span class="keyword1">G×</span> <span class="free">S</span> <span class="main">⊔</span> <span class="free">S''</span> <span class="keyword1">G×</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccProd_insert2"><span class="command">lemma</span></span> ccProd_insert2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">G×</span> insert <span class="free">x</span> <span class="free">S'</span> <span class="main">=</span> <span class="free">S</span> <span class="keyword1">G×</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⊔</span> <span class="free">S</span> <span class="keyword1">G×</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccProd_insert1"><span class="command">lemma</span></span> ccProd_insert1<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="free">S'</span> <span class="keyword1">G×</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="keyword1">G×</span> <span class="free">S</span> <span class="main">⊔</span> <span class="free">S'</span> <span class="keyword1">G×</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccProd_mono1"><span class="command">lemma</span></span> ccProd_mono1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">⊆</span> <span class="free">S''</span> <span class="main">⟹</span> <span class="free">S'</span> <span class="keyword1">G×</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">S''</span> <span class="keyword1">G×</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccProd_mono2"><span class="command">lemma</span></span> ccProd_mono2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">⊆</span> <span class="free">S''</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">G×</span> <span class="free">S'</span> <span class="main">⊑</span> <span class="free">S</span> <span class="keyword1">G×</span> <span class="free">S''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccProd_mono"><span class="command">lemma</span></span> ccProd_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">⊆</span> <span class="free">T'</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">G×</span> <span class="free">T</span> <span class="main">⊑</span> <span class="free">S'</span> <span class="keyword1">G×</span> <span class="free">T'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccProd_comm"><span class="command">lemma</span></span> ccProd_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">G×</span> <span class="free">S'</span> <span class="main">=</span> <span class="free">S'</span> <span class="keyword1">G×</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccProd_belowI"><span class="command">lemma</span></span> ccProd_belowI<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S'</span> <span class="main">⟹</span> <span class="bound">x</span><span class="main">--</span><span class="bound">y</span><span class="main">∈</span><span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">G×</span> <span class="free">S'</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> symE<span class="main">)</span>


<span class="keyword1"><span class="command">lift_definition</span></span> cc_restr <span class="main">::</span> <span class="quoted"><span class="quoted">"var set <span class="main">⇒</span> CoCalls <span class="main">⇒</span> CoCalls"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">S</span><span class="main">.</span> Set.filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> symI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> symE<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cc_restr_sym</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">G|`</span>"</span>  110<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">G|`</span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> cc_restr <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span>"</span></span>

<span class="keyword1" id="CoCallGraph-elem_cc_restr"><span class="command">lemma</span></span> elem_cc_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∈</span><span class="main">(</span><span class="free">G</span> <span class="keyword1">G|`</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∈</span><span class="free">G</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccField_cc_restr"><span class="command">lemma</span></span> ccField_cc_restr<span class="main">:</span> <span class="quoted"><span class="quoted">"ccField <span class="main">(</span><span class="free">G</span> <span class="keyword1">G|`</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> ccField <span class="free">G</span> <span class="main">∩</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Field_def<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-cc_restr_empty"><span class="command">lemma</span></span> cc_restr_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"ccField <span class="free">G</span> <span class="main">⊆</span> <span class="main">-</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">G</span> <span class="keyword1">G|`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Field_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> DomainI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallGraph-cc_restr_empty_set"><span class="command">lemma</span></span> cc_restr_empty_set<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cc_restr <span class="main">{}</span> <span class="free">G</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  
<span class="keyword1" id="CoCallGraph-cc_restr_noop"><span class="command">lemma</span></span> cc_restr_noop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccField <span class="free">G</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> cc_restr <span class="free">S</span> <span class="free">G</span> <span class="main">=</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Field_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> DomainI RangeI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-cc_restr_bot"><span class="command">lemma</span></span> cc_restr_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoCallGraph-ccRestr_ccDelete"><span class="command">lemma</span></span> ccRestr_ccDelete<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cc_restr <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">G</span> <span class="main">=</span> cc_delete <span class="free">x</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-cc_restr_join"><span class="command">lemma</span></span> cc_restr_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span><span class="free">G</span> <span class="main">⊔</span> <span class="free">G'</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="free">G</span> <span class="main">⊔</span> cc_restr <span class="free">S</span> <span class="free">G'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-cont_cc_restr"><span class="command">lemma</span></span> cont_cc_restr<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>cc_restr <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> contI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"chain <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> cont_compose<span class="main">[</span><span class="operator">OF</span> cont_cc_restr<span class="main">,</span> <span class="operator">cont2cont</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="CoCallGraph-cc_restr_mono1"><span class="command">lemma</span></span> cc_restr_mono1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">⟹</span> cc_restr <span class="free">S</span> <span class="free">G</span> <span class="main">⊑</span> cc_restr <span class="free">S'</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-cc_restr_mono2"><span class="command">lemma</span></span> cc_restr_mono2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊑</span> <span class="free">G'</span> <span class="main">⟹</span> cc_restr <span class="free">S</span> <span class="free">G</span> <span class="main">⊑</span> cc_restr <span class="free">S</span> <span class="free">G'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-cc_restr_below_arg"><span class="command">lemma</span></span> cc_restr_below_arg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="free">G</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-cc_restr_lub"><span class="command">lemma</span></span> cc_restr_lub<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span>lub <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">G</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> cc_restr <span class="free">S</span> <span class="bound">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-elem_to_ccField"><span class="command">lemma</span></span> elem_to_ccField<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> ccField <span class="free">G</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> ccField <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Field_def<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccField_to_elem"><span class="command">lemma</span></span> ccField_to_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> ccField <span class="free">G</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">y</span><span class="main">.</span> <span class="free">x</span><span class="main">--</span><span class="bound">y</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Field_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> symD<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-cc_restr_intersect"><span class="command">lemma</span></span> cc_restr_intersect<span class="main">:</span> <span class="quoted"><span class="quoted">"ccField <span class="free">G</span> <span class="main">∩</span> <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="free">S'</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S'</span> <span class="main">-</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> cc_restr <span class="free">S</span> <span class="free">G</span> <span class="main">=</span> cc_restr <span class="free">S'</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CoCalls_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> elem_to_ccField<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-cc_restr_cc_restr"><span class="command">lemma</span></span> cc_restr_cc_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span>cc_restr <span class="free">S'</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="free">S'</span><span class="main">)</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-cc_restr_twist"><span class="command">lemma</span></span> cc_restr_twist<span class="main">:</span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span>cc_restr <span class="free">S'</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S'</span> <span class="main">(</span>cc_restr <span class="free">S</span> <span class="free">G</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-cc_restr_cc_delete_twist"><span class="command">lemma</span></span> cc_restr_cc_delete_twist<span class="main">:</span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">x</span> <span class="main">(</span>cc_delete <span class="free">S</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> cc_delete <span class="free">S</span> <span class="main">(</span>cc_restr <span class="free">x</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-cc_restr_ccProd"><span class="command">lemma</span></span> cc_restr_ccProd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span>ccProd <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> ccProd <span class="main">(</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccProd_below_cc_restr"><span class="command">lemma</span></span> ccProd_below_cc_restr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccProd <span class="free">S</span> <span class="free">S'</span> <span class="main">⊑</span> cc_restr <span class="free">S''</span> <span class="free">G</span> <span class="main">⟷</span> ccProd <span class="free">S</span> <span class="free">S'</span> <span class="main">⊑</span> <span class="free">G</span> <span class="main">∧</span> <span class="main">(</span><span class="free">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="free">S'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">S''</span> <span class="main">∧</span> <span class="free">S'</span> <span class="main">⊆</span> <span class="free">S''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-cc_restr_eq_subset"><span class="command">lemma</span></span> cc_restr_eq_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">⟹</span> cc_restr <span class="free">S'</span> <span class="free">G</span> <span class="main">=</span> cc_restr <span class="free">S'</span> <span class="free">G2</span> <span class="main">⟹</span> cc_restr <span class="free">S</span> <span class="free">G</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="free">G2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Set.filter_def<span class="main">)</span>
 
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ccSquare</span> <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="hidden">⇧</span><sup>2</sup></span>"</span> <span class="main">[</span>80<span class="main">]</span> 80<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free"><span class="hidden">⇧</span><sup>2</sup></span></span> <span class="main">=</span> ccProd <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1" id="CoCallGraph-ccField_ccSquare"><span class="command">lemma</span></span> ccField_ccSquare<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccField <span class="main">(</span><span class="free">S</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccSquare_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Field_def<span class="main">)</span>
  
<span class="keyword1" id="CoCallGraph-below_ccSquare"><span class="command">lemma</span></span> below_ccSquare<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">G</span> <span class="main">⊑</span> <span class="free">S</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ccField <span class="free">G</span> <span class="main">⊆</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccSquare_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Field_def<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-cc_restr_ccSquare"><span class="command">lemma</span></span> cc_restr_ccSquare<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S'</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="keyword1">G|`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="free">S'</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccSquare_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccSquare_empty"><span class="command">lemma</span></span> ccSquare_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccSquare_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> ccNeighbors <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> CoCalls <span class="main">⇒</span> var set"</span></span> 
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="bound">G</span><span class="main">.</span> <span class="main">{</span><span class="bound">y</span> <span class="main">.</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">G</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">G</span><span class="main">}</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoCallGraph-ccNeighbors_bot"><span class="command">lemma</span></span> ccNeighbors_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccNeighbors <span class="free">x</span> <span class="main">⊥</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-cont_ccProd1"><span class="command">lemma</span></span> cont_ccProd1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">S</span><span class="main">.</span> ccProd <span class="bound">S</span> <span class="free">S'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> contI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"chain <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lub_set<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallGraph-cont_ccProd2"><span class="command">lemma</span></span> cont_ccProd2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">S'</span><span class="main">.</span> ccProd <span class="free">S</span> <span class="bound">S'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> contI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"chain <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lub_set<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> cont_compose2<span class="main">[</span><span class="operator">OF</span> cont_ccProd1 cont_ccProd2<span class="main">,</span> <span class="operator">simp</span><span class="main">,</span> <span class="operator">cont2cont</span><span class="main">]</span>

<span class="keyword1" id="CoCallGraph-cont_ccNeighbors"><span class="command">lemma</span></span> cont_ccNeighbors<span class="main">[</span><span class="operator">THEN</span> cont_compose<span class="main">,</span> <span class="operator">cont2cont</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> ccNeighbors <span class="free">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_contI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"chain <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 


<span class="keyword1" id="CoCallGraph-ccNeighbors_join"><span class="command">lemma</span></span> ccNeighbors_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccNeighbors <span class="free">x</span> <span class="main">(</span><span class="free">G</span> <span class="main">⊔</span> <span class="free">G'</span><span class="main">)</span> <span class="main">=</span> ccNeighbors <span class="free">x</span> <span class="free">G</span> <span class="main">∪</span> ccNeighbors <span class="free">x</span> <span class="free">G'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccNeighbors_ccProd"><span class="command">lemma</span></span> ccNeighbors_ccProd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccNeighbors <span class="free">x</span> <span class="main">(</span>ccProd <span class="free">S</span> <span class="free">S'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">then</span> <span class="free">S'</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S'</span> <span class="keyword1">then</span> <span class="free">S</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccNeighbors_ccSquare"><span class="command">lemma</span></span> ccNeighbors_ccSquare<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"ccNeighbors <span class="free">x</span> <span class="main">(</span>ccSquare <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">then</span> <span class="free">S</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccSquare_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccNeighbors_ccProd<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccNeighbors_cc_restr"><span class="command">lemma</span></span> ccNeighbors_cc_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccNeighbors <span class="free">x</span> <span class="main">(</span>cc_restr <span class="free">S</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">then</span> ccNeighbors <span class="free">x</span> <span class="free">G</span> <span class="main">∩</span> <span class="free">S</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccNeighbors_mono"><span class="command">lemma</span></span> ccNeighbors_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊑</span> <span class="free">G'</span> <span class="main">⟹</span> ccNeighbors <span class="free">x</span> <span class="free">G</span> <span class="main">⊆</span> ccNeighbors <span class="free">x</span> <span class="free">G'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-subset_ccNeighbors"><span class="command">lemma</span></span> subset_ccNeighbors<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> ccNeighbors <span class="free">x</span> <span class="free">G</span> <span class="main">⟷</span> ccProd <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sym_def<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-elem_ccNeighbors"><span class="command">lemma</span></span> elem_ccNeighbors<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> ccNeighbors <span class="free">x</span> <span class="free">G</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">y</span><span class="main">--</span><span class="free">x</span><span class="main">∈</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sym_def<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccNeighbors_ccField"><span class="command">lemma</span></span> ccNeighbors_ccField<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccNeighbors <span class="free">x</span> <span class="free">G</span> <span class="main">⊆</span> ccField <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Field_def<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccNeighbors_disjoint_empty"><span class="command">lemma</span></span> ccNeighbors_disjoint_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccNeighbors <span class="free">x</span> <span class="free">G</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∉</span> ccField <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Field_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> CoCalls <span class="main">::</span> <span class="quoted">Join_cpo</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">metis</span> coCallsLub_is_lub<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccNeighbors_lub"><span class="command">lemma</span></span> ccNeighbors_lub<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccNeighbors <span class="free">x</span> <span class="main">(</span>lub <span class="free">Gs</span><span class="main">)</span> <span class="main">=</span> lub <span class="main">(</span>ccNeighbors <span class="free">x</span> <span class="main">`</span> <span class="free">Gs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lub_set<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">list_pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">list_pairs</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟹</span> <span class="free">list_pairs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">list_pairs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> ccFromList <span class="main">::</span> <span class="quoted"><span class="quoted">"var list <span class="main">⇒</span> CoCalls"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> list_pairs <span class="bound">xs</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∨</span> list_pairs <span class="bound">xs</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> symI<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccFromList_Nil"><span class="command">lemma</span></span> ccFromList_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">[]</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> list_pairs.cases<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccFromList_Cons"><span class="command">lemma</span></span> ccFromList_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> ccProd <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⊔</span> ccFromList <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> list_pairs.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_pairs.intros<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccFromList_append"><span class="command">lemma</span></span> ccFromList_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">=</span> ccFromList <span class="free">xs</span> <span class="main">⊔</span> ccFromList <span class="free">ys</span> <span class="main">⊔</span> ccProd <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccProd_insert1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccFromList_filter"><span class="command">lemma</span></span> ccFromList_filter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccFromList <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">(</span>ccFromList <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_conj_eq<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccFromList_replicate"><span class="command">lemma</span></span> ccFromList_replicate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">(</span>replicate <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">⊥</span>  <span class="keyword1">else</span> ccProd <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ccLinear</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set <span class="main">⇒</span> CoCalls <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ccLinear</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">y</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="bound">x</span><span class="main">--</span><span class="bound">y</span><span class="main">∉</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallGraph-ccLinear_bottom"><span class="command">lemma</span></span> ccLinear_bottom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccLinear <span class="free">S</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccLinear_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoCallGraph-ccLinear_empty"><span class="command">lemma</span></span> ccLinear_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccLinear <span class="main">{}</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccLinear_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoCallGraph-ccLinear_lub"><span class="command">lemma</span></span> ccLinear_lub<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccLinear <span class="free">S</span> <span class="main">(</span>lub <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">G</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> ccLinear <span class="free">S</span> <span class="bound">G</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> ccLinear_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*
lemma ccLinear_ccNeighbors:
  "ccLinear S G ⟹ ccNeighbors S G ∩ S = {}"
 unfolding ccLinear_def by transfer auto
*)</span>

<span class="keyword1" id="CoCallGraph-ccLinear_cc_restr"><span class="command">lemma</span></span> ccLinear_cc_restr<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccLinear <span class="free">S</span> <span class="free">G</span> <span class="main">⟹</span> ccLinear <span class="free">S</span> <span class="main">(</span>cc_restr <span class="free">S'</span> <span class="free">G</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> ccLinear_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="comment1">(* TODO: Sort *)</span>

<span class="keyword1" id="CoCallGraph-ccLinear_join"><span class="command">lemma</span></span> ccLinear_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccLinear <span class="free">S</span> <span class="main">(</span><span class="free">G</span> <span class="main">⊔</span> <span class="free">G'</span><span class="main">)</span> <span class="main">⟷</span> ccLinear <span class="free">S</span> <span class="free">G</span> <span class="main">∧</span> ccLinear <span class="free">S</span> <span class="free">G'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccLinear_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccLinear_ccProd"><span class="command">lemma</span></span> ccLinear_ccProd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccLinear <span class="free">S</span> <span class="main">(</span>ccProd <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccLinear_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccLinear_mono1"><span class="command">lemma</span></span> ccLinear_mono1<span class="main">:</span> <span class="quoted"><span class="quoted">"ccLinear <span class="free">S'</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">⟹</span> ccLinear <span class="free">S</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccLinear_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccLinear_mono2"><span class="command">lemma</span></span> ccLinear_mono2<span class="main">:</span> <span class="quoted"><span class="quoted">"ccLinear <span class="free">S</span> <span class="free">G'</span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">⊑</span> <span class="free">G'</span> <span class="main">⟹</span> ccLinear <span class="free">S</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccLinear_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccField_join"><span class="command">lemma</span></span> ccField_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccField <span class="main">(</span><span class="free">G</span> <span class="main">⊔</span> <span class="free">G'</span><span class="main">)</span> <span class="main">=</span> ccField <span class="free">G</span> <span class="main">∪</span> ccField <span class="free">G'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccField_lub"><span class="command">lemma</span></span> ccField_lub<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccField <span class="main">(</span>lub <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>ccField <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-ccField_ccProd"><span class="command">lemma</span></span> ccField_ccProd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccField <span class="main">(</span>ccProd <span class="free">S</span> <span class="free">S'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">S'</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span>  <span class="free">S</span> <span class="main">∪</span> <span class="free">S'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Field_def<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-ccField_ccProd_subset"><span class="command">lemma</span></span> ccField_ccProd_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccField <span class="main">(</span>ccProd <span class="free">S</span> <span class="free">S'</span><span class="main">)</span> <span class="main">⊆</span>  <span class="free">S</span> <span class="main">∪</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccField_ccProd<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-cont_ccField"><span class="command">lemma</span></span> cont_ccField<span class="main">[</span><span class="operator">THEN</span> cont_compose<span class="main">,</span> <span class="operator">simp</span><span class="main">,</span> <span class="operator">cont2cont</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont ccField"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_contI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CoCallAnalysisSig">
<div class="head">
<h1>Theory CoCallAnalysisSig</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CoCallAnalysisSig
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../launchbury/theories/#Terms">Launchbury.Terms</a> <a href="#Arity">Arity</a> <a href="#CoCallGraph">CoCallGraph</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> CoCallAnalysis <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ccExp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> Arity <span class="main">→</span> CoCalls"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ccExp_syn</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒢⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">a</span></span></span></sub><span class="hidden">⇙</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="free">ccExp</span> <span class="bound">e</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ccExp_bot_syn</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒢<span class="hidden">⇧</span><sup>⊥</sup>⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇧</span><sup>⊥</sup><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">a</span></span></span></sub><span class="hidden">⇙</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> fup<span class="main">⋅</span><span class="main">(</span><span class="free">ccExp</span> <span class="bound">e</span><span class="main">)</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> CoCallAnalyisHeap <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ccHeap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> exp <span class="main">⇒</span> Arity <span class="main">→</span> CoCalls"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="AList-Utils-HOLCF">
<div class="head">
<h1>Theory AList-Utils-HOLCF</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"AList-Utils-HOLCF"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Launchbury/HOLCF-Utils.html">Launchbury.HOLCF-Utils</a>"</span> <span class="quoted">"<a href="../Launchbury/HOLCF-Join-Classes.html">Launchbury.HOLCF-Join-Classes</a>"</span> <span class="quoted">"<a href="../Launchbury/AList-Utils.html">Launchbury.AList-Utils</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_BLubMap"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> pttrn<span class="main">,</span> <span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">⨆</span><span class="keyword3">/</span>_<span class="keyword3">/</span><span class="keyword1">↦</span><span class="keyword3">/</span>_<span class="keyword3">/</span><span class="keyword1">∈</span><span class="keyword3">/</span>_<span class="keyword3">/</span><span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span>0<span class="main">,</span>0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">⨆</span> <span class="free">k</span><span class="main">↦</span><span class="free">v</span><span class="main">∈</span><span class="free">m</span><span class="main">.</span> <span class="free">e</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> lub <span class="main">(</span><span class="keyword1">CONST</span> mapCollect <span class="main">(</span><span class="main">λ</span><span class="free">k</span> <span class="free">v</span> <span class="main">.</span> <span class="free">e</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span>"</span>

<span class="keyword1" id="AList-Utils-HOLCF-below_lubmapI"><span class="command">lemma</span></span> below_lubmapI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">e</span> <span class="free">k</span> <span class="free">v</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Join_cpo<span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span><span class="free">m</span><span class="main">.</span> <span class="free">e</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> mapCollect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="AList-Utils-HOLCF-lubmap_belowI"><span class="command">lemma</span></span> lubmap_belowI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">.</span> <span class="free">m</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">e</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Join_cpo<span class="main">)</span> <span class="main">⊑</span> <span class="free">u</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span><span class="free">m</span><span class="main">.</span> <span class="free">e</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> mapCollect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="AList-Utils-HOLCF-lubmap_const_bottom"><span class="command">lemma</span></span> lubmap_const_bottom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span> <span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span><span class="free">m</span><span class="main">.</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⊥</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Join_cpo<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> Map.empty"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="AList-Utils-HOLCF-lubmap_map_upd"><span class="command">lemma</span></span> lubmap_map_upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">::</span> Join_cpo<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span><span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span><span class="free">m</span><span class="main">(</span><span class="free">k'</span> <span class="main">↦</span> <span class="free">v'</span><span class="main">)</span><span class="main">.</span> <span class="free">e</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">e</span> <span class="free">k'</span> <span class="free">v'</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span><span class="free">m</span><span class="main">(</span><span class="free">k'</span><span class="main">:=</span>None<span class="main">)</span><span class="main">.</span> <span class="free">e</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="AList-Utils-HOLCF-lubmap_below_cong"><span class="command">lemma</span></span> lubmap_below_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">.</span> <span class="free">m</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">f2</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> Join_cpo<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span> <span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span><span class="free">m</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span><span class="free">m</span><span class="main">.</span> <span class="free">f2</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lubmap_belowI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_lubmapI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="AList-Utils-HOLCF-cont2cont_lubmap"><span class="command">lemma</span></span> cont2cont_lubmap<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">cont2cont</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">k</span> <span class="bound">v</span> <span class="main">.</span> cont <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⨆</span> <span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span><span class="free">m</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> Join_cpo<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> contI2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"monofun <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⨆</span><span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span><span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monofunI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lubmap_below_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> cont2monofunE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'d</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"chain <span class="skolem">Y</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">⨆</span><span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span><span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span><span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span><span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⨆</span><span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span><span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cont2contlubE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lubmap_belowI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lub_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ch2ch_cont<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹chain <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">⨆</span><span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span><span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> below_lubmapI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*
syntax
  "_BLubMapFilter" :: "[pttrn, pttrn, 'a ⇀ 'b, 'b, bool] ⇒ 'b" ("(3⨆/_/↦/_/∈/_/./ _/ |/ _)" [0,0,0,10,10] 10)

translations
  "⨆ k↦v∈m. e | P" == "CONST lub (CONST mapCollectFilter (λk v. (P,e)) m)"
*)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CoCallGraph-Nominal">
<div class="head">
<h1>Theory CoCallGraph-Nominal</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"CoCallGraph-Nominal"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#CoCallGraph">CoCallGraph</a> <span class="quoted">"<a href="../Launchbury/Nominal-HOLCF.html">Launchbury.Nominal-HOLCF</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> CoCalls <span class="main">::</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">permute_CoCalls</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> CoCalls <span class="main">⇒</span> CoCalls"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"permute"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> symI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> symE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_permute_set<span class="main">)</span>
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> CoCalls <span class="main">::</span> <span class="quoted">cont_pt</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> contI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monofunI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> True_eqvt subset_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"chain <span class="main"><span class="main"><span class="main">_</span></span></span>"</span></span></span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> lub_eqvt<span class="main">[</span><span class="operator">OF</span> exists_lub<span class="main">,</span> <span class="operator">simp</span><span class="main">,</span> <span class="operator">eqvt</span><span class="main">]</span>

<span class="keyword1" id="CoCallGraph-Nominal-cc_restr_perm"><span class="command">lemma</span></span> cc_restr_perm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted">CoCalls</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">p</span> <span class="main">♯*</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_permute_set<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> perm_supp_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_minus_perm<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> fresh_def fresh_star_def supp_set_elem_finite<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> perm_supp_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_minus_perm<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> fresh_def fresh_star_def supp_set_elem_finite<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1" id="CoCallGraph-Nominal-inCC_eqvt"><span class="command">lemma</span></span> inCC_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∈</span><span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">π</span><span class="main">∙</span><span class="free">x</span><span class="main">)</span><span class="main">--</span><span class="main">(</span><span class="free">π</span><span class="main">∙</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">π</span><span class="main">∙</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="CoCallGraph-Nominal-cc_restr_eqvt"><span class="command">lemma</span></span> cc_restr_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> cc_restr <span class="free">S</span> <span class="free">G</span> <span class="main">=</span> cc_restr <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
<span class="keyword1" id="CoCallGraph-Nominal-ccProd_eqvt"><span class="command">lemma</span></span> ccProd_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> ccProd <span class="free">S</span> <span class="free">S'</span> <span class="main">=</span> ccProd <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span>  <span class="free">S'</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
<span class="keyword1" id="CoCallGraph-Nominal-ccSquare_eqvt"><span class="command">lemma</span></span> ccSquare_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> ccSquare <span class="free">S</span> <span class="main">=</span> ccSquare <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccSquare_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>
<span class="keyword1" id="CoCallGraph-Nominal-ccNeighbors_eqvt"><span class="command">lemma</span></span> ccNeighbors_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> ccNeighbors <span class="free">S</span> <span class="free">G</span> <span class="main">=</span> ccNeighbors <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CoCallAnalysisBinds">
<div class="head">
<h1>Theory CoCallAnalysisBinds</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CoCallAnalysisBinds
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#CoCallAnalysisSig">CoCallAnalysisSig</a> <a href="#AEnv">AEnv</a>  <span class="quoted">"<a href="AList-Utils-HOLCF.html">AList-Utils-HOLCF</a>"</span> <span class="quoted">"<a href="Arity-Nominal.html">Arity-Nominal</a>"</span> <span class="quoted">"<a href="CoCallGraph-Nominal.html">CoCallGraph-Nominal</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> CoCallAnalysis
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ccBind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> exp <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>AEnv <span class="main">×</span> CoCalls<span class="main">)</span> <span class="main">→</span> CoCalls<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ccBind</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="main">(</span>ae<span class="main">,</span> G<span class="main">)</span><span class="main">.</span>  <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">--</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">∉</span><span class="bound">G</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> isVal <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> cc_restr <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span><span class="free">ccExp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ae</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> ccSquare <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(* paper has:  ∨ ae v = up⋅0, but that is not monotone! But should give the same result. *)</span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBind_eq"><span class="command">lemma</span></span> ccBind_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccBind <span class="free">v</span> <span class="free">e</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">v</span><span class="main">--</span><span class="free">v</span><span class="main">∉</span><span class="free">G</span> <span class="main">∨</span> <span class="main">¬</span> isVal <span class="free">e</span> <span class="keyword1">then</span> 𝒢<span class="hidden">⇧</span><sup>⊥</sup><span class="hidden">⇘</span><sub><span class="free">ae</span> <span class="free">v</span></sub><span class="hidden">⇙</span> <span class="free">e</span> <span class="keyword1">G|`</span> fv <span class="free">e</span> <span class="keyword1">else</span> <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccBind_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_beta_Pair<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont_if_else_above<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_cc_restr<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="comment1">(* Abstraction broken! Fix this. *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> adm_subst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_snd<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> admI<span class="main"><span class="keyword3">,</span></span> <span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"chain <span class="main">_</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBind_strict"><span class="command">lemma</span></span> ccBind_strict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccBind <span class="free">v</span> <span class="free">e</span> <span class="main">⋅</span> <span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inst_prod_pcpo ccBind_eq <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Pair_strict<span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisBinds-ccField_ccBind"><span class="command">lemma</span></span> ccField_ccBind<span class="main">:</span> <span class="quoted"><span class="quoted">"ccField <span class="main">(</span>ccBind <span class="free">v</span> <span class="free">e</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBind_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_cc_restr<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ccBinds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>AEnv <span class="main">×</span> CoCalls<span class="main">)</span> <span class="main">→</span> CoCalls<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ccBinds</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> i<span class="main">.</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">v</span><span class="main">↦</span><span class="bound">e</span><span class="main">∈</span>map_of <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">.</span> ccBind <span class="bound">v</span> <span class="bound">e</span><span class="main">⋅</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBinds_eq"><span class="command">lemma</span></span> ccBinds_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccBinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">v</span><span class="main">↦</span><span class="bound">e</span><span class="main">∈</span>map_of <span class="free">Γ</span><span class="main">.</span> ccBind <span class="bound">v</span> <span class="bound">e</span><span class="main">⋅</span><span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccBinds_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBinds_strict"><span class="command">lemma</span></span> ccBinds_strict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccBinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">=</span><span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccBinds_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBinds_strict'"><span class="command">lemma</span></span> ccBinds_strict'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccBinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="main">⊥</span><span class="main">,</span><span class="main">⊥</span><span class="main">)</span><span class="main">=</span><span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> CoCallAnalysis.ccBinds_strict Pair_bottom_iff<span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBinds_reorder1"><span class="command">lemma</span></span> ccBinds_reorder1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ccBinds <span class="free">Γ</span> <span class="main">=</span> ccBind <span class="free">v</span> <span class="free">e</span> <span class="main">⊔</span> ccBinds <span class="main">(</span>delete <span class="free">v</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="main">=</span> map_of <span class="main">(</span><span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="free">v</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_of_delete_insert<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cfun_eqI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBinds_eq delete_set_none<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBinds_Nil"><span class="command">lemma</span></span> ccBinds_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccBinds <span class="main">[]</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccBinds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBinds_Cons"><span class="command">lemma</span></span> ccBinds_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"ccBinds <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> ccBind <span class="free">x</span> <span class="free">e</span> <span class="main">⊔</span> ccBinds <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ccBinds_reorder1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> e <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBind_below_ccBinds"><span class="command">lemma</span></span> ccBind_below_ccBinds<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span> <span class="main">⟹</span> ccBind <span class="free">x</span> <span class="free">e</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊑</span> <span class="main">(</span>ccBinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBinds_eq<span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisBinds-ccField_ccBinds"><span class="command">lemma</span></span> ccField_ccBinds<span class="main">:</span> <span class="quoted"><span class="quoted">"ccField <span class="main">(</span>ccBinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBinds_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_ccBind<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_of_Some_fv_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ccBindsExtra</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>AEnv <span class="main">×</span> CoCalls<span class="main">)</span> <span class="main">→</span> CoCalls<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ccBindsExtra</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> i<span class="main">.</span>  snd <span class="bound">i</span> <span class="main">⊔</span> ccBinds <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⋅</span> <span class="bound">i</span>  <span class="main">⊔</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">x</span><span class="main">↦</span><span class="bound">e</span><span class="main">∈</span>map_of <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">.</span> ccProd <span class="main">(</span>fv <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="bound">x</span> <span class="main">(</span>snd <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBindsExtra_simp"><span class="command">lemma</span></span> ccBindsExtra_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"ccBindsExtra <span class="free">Γ</span> <span class="main">⋅</span> <span class="free">i</span> <span class="main">=</span>snd <span class="free">i</span> <span class="main">⊔</span> ccBinds <span class="free">Γ</span> <span class="main">⋅</span> <span class="free">i</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">x</span><span class="main">↦</span><span class="bound">e</span><span class="main">∈</span>map_of <span class="free">Γ</span><span class="main">.</span> ccProd <span class="main">(</span>fv <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="bound">x</span> <span class="main">(</span>snd <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccBindsExtra_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBindsExtra_eq"><span class="command">lemma</span></span> ccBindsExtra_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"ccBindsExtra <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span><span class="free">G</span><span class="main">)</span> <span class="main">=</span>
  <span class="free">G</span> <span class="main">⊔</span> ccBinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span><span class="free">G</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">x</span><span class="main">↦</span><span class="bound">e</span><span class="main">∈</span>map_of <span class="free">Γ</span><span class="main">.</span> fv <span class="bound">e</span> <span class="keyword1">G×</span> ccNeighbors <span class="bound">x</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccBindsExtra_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBindsExtra_strict"><span class="command">lemma</span></span> ccBindsExtra_strict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccBindsExtra <span class="free">Γ</span> <span class="main">⋅</span> <span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBindsExtra_simp inst_prod_pcpo <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Pair_strict<span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisBinds-ccField_ccBindsExtra"><span class="command">lemma</span></span> ccField_ccBindsExtra<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccField <span class="main">(</span>ccBindsExtra <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">Γ</span> <span class="main">∪</span> ccField <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBindsExtra_simp elem_to_ccField
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_ccBinds<span class="main"><span class="main">]</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_ccProd_subset<span class="main"><span class="main">]</span></span> map_of_Some_fv_subset<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBind_eqvt"><span class="command">lemma</span></span> ccBind_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>CoCallAnalysis.ccBind <span class="free">cccExp</span> <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> CoCallAnalysis.ccBind <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">cccExp</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="skolem">ae</span> <span class="skolem">G</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">∙</span> <span class="main">(</span><span class="main">(</span>CoCallAnalysis.ccBind <span class="free">cccExp</span> <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span><span class="skolem">G</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> CoCallAnalysis.ccBind <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="free">cccExp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">ae</span><span class="main">,</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> CoCallAnalysis.ccBind_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_cfun_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cfun_eqvtI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBinds_eqvt"><span class="command">lemma</span></span> ccBinds_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>CoCallAnalysis.ccBinds <span class="free">cccExp</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> CoCallAnalysis.ccBinds <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">cccExp</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqvtI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> CoCallAnalysis.ccBinds_eq
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBindsExtra_eqvt"><span class="command">lemma</span></span> ccBindsExtra_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>CoCallAnalysis.ccBindsExtra <span class="free">cccExp</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> CoCallAnalysis.ccBindsExtra <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">cccExp</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqvtI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CoCallAnalysis.ccBindsExtra_def<span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBind_cong"><span class="command">lemma</span></span> ccBind_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">cccexp1</span> <span class="free">e</span> <span class="main">=</span> <span class="free">cccexp2</span> <span class="free">e</span> <span class="main">⟹</span> CoCallAnalysis.ccBind <span class="free">cccexp1</span> <span class="free">x</span> <span class="free">e</span> <span class="main">=</span> CoCallAnalysis.ccBind <span class="free">cccexp2</span> <span class="free">x</span> <span class="free">e</span> "</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xa</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CoCallAnalysis.ccBind_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBinds_cong"><span class="command">lemma</span></span> ccBinds_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">heap2</span> <span class="main">⟹</span> <span class="free">cccexp1</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">cccexp2</span> <span class="bound">e</span><span class="main">)</span><span class="main">;</span> <span class="free">heap1</span> <span class="main">=</span> <span class="free">heap2</span> <span class="main">⟧</span>
      <span class="main">⟹</span> CoCallAnalysis.ccBinds <span class="free">cccexp1</span> <span class="free">heap1</span> <span class="main">=</span> CoCallAnalysis.ccBinds <span class="free">cccexp2</span> <span class="free">heap2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> CoCallAnalysis.ccBinds_eq
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mapCollect_cong<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccBind_cong<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageI map_of_SomeD snd_conv<span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisBinds-ccBindsExtra_cong"><span class="command">lemma</span></span> ccBindsExtra_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">heap2</span> <span class="main">⟹</span> <span class="free">cccexp1</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">cccexp2</span> <span class="bound">e</span><span class="main">)</span><span class="main">;</span> <span class="free">heap1</span> <span class="main">=</span> <span class="free">heap2</span> <span class="main">⟧</span>
      <span class="main">⟹</span> CoCallAnalysis.ccBindsExtra <span class="free">cccexp1</span> <span class="free">heap1</span> <span class="main">=</span> CoCallAnalysis.ccBindsExtra <span class="free">cccexp2</span> <span class="free">heap2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> CoCallAnalysis.ccBindsExtra_simp
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccBinds_cong mapCollect_cong<span class="main"><span class="main">]</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ArityAnalysisFix">
<div class="head">
<h1>Theory ArityAnalysisFix</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ArityAnalysisFix
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#ArityAnalysisSig">ArityAnalysisSig</a> <a href="#ArityAnalysisAbinds">ArityAnalysisAbinds</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> ArityAnalysis
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Afix</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> <span class="main">(</span>AEnv <span class="main">→</span> AEnv<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Afix</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ae<span class="main">.</span> <span class="main">(</span><span class="keyword1">μ</span>  <span class="bound">ae'</span><span class="main">.</span> ABinds <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⋅</span> <span class="bound">ae'</span> <span class="main">⊔</span> <span class="bound">ae</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ArityAnalysisFix-Afix_eq"><span class="command">lemma</span></span> Afix_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Afix <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ae'</span><span class="main">.</span> <span class="main">(</span>ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="bound">ae'</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">ae</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Afix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="ArityAnalysisFix-Afix_strict"><span class="command">lemma</span></span> Afix_strict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Afix_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fix_eqI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ArityAnalysisFix-Afix_least_below"><span class="command">lemma</span></span> Afix_least_below<span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Γ</span> <span class="main">⋅</span> <span class="free">ae'</span> <span class="main">⊑</span> <span class="free">ae'</span> <span class="main">⟹</span> <span class="free">ae</span> <span class="main">⊑</span> <span class="free">ae'</span> <span class="main">⟹</span> Afix <span class="free">Γ</span> <span class="main">⋅</span> <span class="free">ae</span> <span class="main">⊑</span> <span class="free">ae'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Afix_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fix_least_below<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisFix-Afix_unroll"><span class="command">lemma</span></span> Afix_unroll<span class="main">:</span> <span class="quoted"><span class="quoted">"Afix <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> ABinds <span class="free">Γ</span> <span class="main">⋅</span> <span class="main">(</span>Afix <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Afix_eq
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="ArityAnalysisFix-Abinds_below_Afix"><span class="command">lemma</span></span> Abinds_below_Afix<span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Δ</span> <span class="main">⊑</span> Afix <span class="free">Δ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_belowI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Afix_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monofun_cfun_arg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ArityAnalysisFix-Afix_above_arg"><span class="command">lemma</span></span> Afix_above_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="main">⊑</span> Afix <span class="free">Γ</span> <span class="main">⋅</span> <span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Afix_unroll<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="ArityAnalysisFix-Abinds_Afix_below"><span class="command">lemma</span></span> Abinds_Afix_below<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="main">⊑</span> Afix <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Afix_unroll<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">(*lemma Abinds_Afix[simp]: "ABinds Γ⋅(Afix Γ⋅ae) = Afix Γ⋅ae"
  unfolding Afix_eq
  apply (subst fix_eq) back apply simp
  apply (rule below_trans[OF ABinds_above_arg monofun_cfun_arg])
  apply (subst fix_eq) apply simp
  done
*)</span>

<span class="keyword1" id="ArityAnalysisFix-Afix_reorder"><span class="command">lemma</span></span> Afix_reorder<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="main">=</span> map_of <span class="free">Δ</span> <span class="main">⟹</span> Afix <span class="free">Γ</span> <span class="main">=</span> Afix <span class="free">Δ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cfun_eqI<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Afix_eq <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> Abinds_reorder<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisFix-Afix_repeat_singleton"><span class="command">lemma</span></span> Afix_repeat_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">μ</span> <span class="bound">xa</span><span class="main">.</span> Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span><span class="free">n</span> <span class="main">⊔</span> <span class="bound">xa</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">ae</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>esing <span class="free">x</span><span class="main">⋅</span><span class="free">n</span> <span class="main">⊔</span> <span class="free">ae</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun_arg join_mono below_refl join_above1<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_least_below<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Afix_least_below<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> join_below below_refl iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> esing_below_iff<span class="main"><span class="main">]</span></span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fun_belowD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Afix_above_arg<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>  below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Afix_above_arg<span class="main"><span class="main">]</span></span> join_above1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ArityAnalysisFix-Afix_join_fresh"><span class="command">lemma</span></span> Afix_join_fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ae'</span> <span class="main">`</span> <span class="main">(</span>domA <span class="free">Δ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">⊥</span><span class="main">}</span>  <span class="main">⟹</span>  Afix <span class="free">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span> <span class="main">⊔</span> <span class="free">ae'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Afix <span class="free">Δ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">ae'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Afix_least_below<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Abinds_join_fresh<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Abinds_Afix_below join_above1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_below<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Afix_above_arg join_above1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_above2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monofun_cfun_arg <span class="main"><span class="main">[</span></span><span class="operator">OF</span> join_above1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> join_above2 Afix_above_arg<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="ArityAnalysisFix-Afix_restr_fresh"><span class="command">lemma</span></span> Afix_restr_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> <span class="free">S</span> <span class="main">♯*</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Afix <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span>  <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Afix_eq
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="keyword1"><span class="keyword1">f|`</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">-</span></span> <span class="free"><span class="free">S</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">y</span></span>  <span class="keyword1"><span class="keyword1">f|`</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">-</span></span> <span class="free"><span class="free">S</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">aeL</span> <span class="skolem">aeR</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="skolem">aeL</span> <span class="main">⊔</span> <span class="free">ae</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="skolem">aeL</span>  <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">ae</span>  <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">aeL</span>  <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">ae</span>  <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ABinds_restr_fresh<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">aeR</span>  <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">ae</span>  <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prems <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="skolem">aeR</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">ae</span>  <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ABinds_restr_fresh<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="skolem">aeR</span> <span class="main">⊔</span> <span class="free">ae</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ArityAnalysisFix-Afix_restr"><span class="command">lemma</span></span> Afix_restr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Afix <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span>  <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Afix_eq
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="keyword1"><span class="keyword1">f|`</span></span><span class="free"><span class="free">S</span></span> <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">y</span></span>  <span class="keyword1"><span class="keyword1">f|`</span></span> <span class="free"><span class="free">S</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>   <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span>  ABinds_restr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ArityAnalysisFix-Afix_restr_subst'"><span class="command">lemma</span></span> Afix_restr_subst'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x'</span> <span class="bound">e</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">Aexp</span> <span class="bound">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span><span class="main">⋅</span><span class="bound">a</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">Aexp</span> <span class="bound">e</span><span class="main">⋅</span><span class="bound">a</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Afix <span class="free">Γ</span><span class="main">[</span><span class="free">x</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span><span class="main">⋅</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Afix_eq
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="keyword1"><span class="keyword1">f|`</span></span><span class="free"><span class="free">S</span></span> <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">y</span></span>  <span class="keyword1"><span class="keyword1">f|`</span></span> <span class="free"><span class="free">S</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>   <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ABinds_restr_subst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ABinds_restr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

 
<span class="keyword1" id="ArityAnalysisFix-Afix_subst_approx"><span class="command">lemma</span></span> Afix_subst_approx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> domA <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">Aexp</span> <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">⋅</span><span class="bound">n</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Afix <span class="free">Γ</span><span class="main">[</span><span class="free">y</span><span class="keyword1">::h=</span> <span class="free">x</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span>Afix <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Afix_eq
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">aeL</span></span> <span class="bound"><span class="bound">aeR</span></span> <span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">aeL</span></span> <span class="main"><span class="main">⊑</span></span> <span class="bound"><span class="bound">aeR</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">y</span></span> <span class="main"><span class="main">:=</span></span> <span class="main"><span class="main">⊥</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">:=</span></span> up<span class="main"><span class="main">⋅</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">aeL</span> <span class="skolem">aeR</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Γ</span><span class="main">[</span><span class="free">y</span><span class="keyword1">::h=</span><span class="free">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">aeL</span> <span class="main">⊑</span> ABinds <span class="free">Γ</span><span class="main">[</span><span class="free">y</span><span class="keyword1">::h=</span><span class="free">x</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">aeR</span> <span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monofun_cfun_arg<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>  <span class="main">⊑</span> <span class="main">(</span>ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="skolem">aeR</span><span class="main">)</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ABinds.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">v</span> <span class="skolem">e</span> <span class="skolem">Γ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">Aexp</span> <span class="skolem">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">⋅</span><span class="bound">n</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> fup<span class="main">⋅</span><span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">⋅</span><span class="bound">n</span> <span class="main">⊑</span> <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">[</span><span class="free">y</span><span class="keyword1">::h=</span><span class="free">x</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">aeR</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span>ABinds <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">aeR</span><span class="main">)</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prems<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"ABinds <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">Γ</span><span class="main">[</span><span class="free">y</span><span class="keyword1">::h=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">aeR</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span>ABinds <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">aeR</span><span class="main">)</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> subst_heap_delete<span class="keyword1"><span class="command">.</span></span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">aeR</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">aeR</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply join_comm<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> join_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IH1 IH2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Γ</span><span class="main">[</span><span class="free">y</span><span class="keyword1">::h=</span><span class="free">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">aeL</span> <span class="main">⊑</span> <span class="main">(</span>ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="skolem">aeR</span><span class="main">)</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="ArityAnalysisFix-Afix_eqvt"><span class="command">lemma</span></span> Afix_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>ArityAnalysis.Afix <span class="free">Aexp</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> ArityAnalysis.Afix  <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Aexp</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ArityAnalysis.Afix_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_cfun_eqvt<span class="main">)</span>


<span class="keyword1" id="ArityAnalysisFix-Afix_cong"><span class="command">lemma</span></span> Afix_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">heap2</span> <span class="main">⟹</span> <span class="free">aexp1</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">aexp2</span> <span class="bound">e</span><span class="main">)</span><span class="main">;</span> <span class="free">heap1</span> <span class="main">=</span> <span class="free">heap2</span> <span class="main">⟧</span>
      <span class="main">⟹</span> ArityAnalysis.Afix <span class="free">aexp1</span> <span class="free">heap1</span> <span class="main">=</span> ArityAnalysis.Afix <span class="free">aexp2</span> <span class="free">heap2</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> ArityAnalysis.Afix_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Abinds_cong<span class="main">)</span>


<span class="keyword1"><span class="command">context</span></span> EdomArityAnalysis
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="ArityAnalysisFix-Afix_edom"><span class="command">lemma</span></span> Afix_edom<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>Afix <span class="free">Γ</span> <span class="main">⋅</span> <span class="free">ae</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">Γ</span> <span class="main">∪</span> edom <span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Afix_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fix_ind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">ae'</span></span></span> <span class="main"><span class="main"><span class="main">.</span></span></span> edom <span class="bound"><span class="bound"><span class="bound">ae'</span></span></span> <span class="main"><span class="main"><span class="main">⊆</span></span></span> fv <span class="free"><span class="free"><span class="free">Γ</span></span></span> <span class="main"><span class="main"><span class="main">∪</span></span></span> edom <span class="free"><span class="free"><span class="free">ae</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_AnalBinds<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="ArityAnalysisFix-ABinds_lookup_fresh"><span class="command">lemma</span></span> ABinds_lookup_fresh<span class="main">:</span>
  <span class="quoted"><span class="quoted">"atom <span class="free">v</span> <span class="main">♯</span> <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">(</span>ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ABinds.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Cons fresh_Pair fup_Aexp_lookup_fresh fresh_delete<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisFix-Afix_lookup_fresh"><span class="command">lemma</span></span> Afix_lookup_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">v</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Afix <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="free">ae</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Afix_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_ind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>  P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">ae'</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">ae'</span></span> <span class="free"><span class="free">v</span></span> <span class="main"><span class="main">⊑</span></span> <span class="free"><span class="free">ae</span></span> <span class="free"><span class="free">v</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ABinds_lookup_fresh<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> fun_belowD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Afix_above_arg<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ArityAnalysisFix-Afix_comp2join_fresh"><span class="command">lemma</span></span> Afix_comp2join_fresh<span class="main">:</span>
  <span class="quoted"><span class="quoted">"atom <span class="main">`</span> <span class="main">(</span>domA <span class="free">Δ</span><span class="main">)</span> <span class="main">♯*</span> <span class="free">Γ</span> <span class="main">⟹</span> ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="main">=</span> ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ABinds.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Afix_above_arg <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">v</span> <span class="skolem">e</span> <span class="skolem">Δ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">v</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="main">(</span>delete <span class="skolem">v</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">♯*</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Afix_lookup_fresh<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹atom <span class="skolem">v</span> <span class="main">♯</span> <span class="free">Γ</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ArityAnalysisFix-Afix_append_fresh"><span class="command">lemma</span></span> Afix_append_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Δ</span> <span class="main">♯*</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Afix <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="free">Δ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Afix <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊑</span> Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="free">Δ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Afix_least_below<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abinds_append_disjoint<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fresh_distinct<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> Afix_comp2join_fresh<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> join_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Abinds_Afix_below Abinds_Afix_below<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Afix_above_arg  below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Afix_above_arg Afix_above_arg<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="free">Δ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="main">⊑</span> Afix <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Afix_least_below<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="main">⊑</span> Afix <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Abinds_Afix_below<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Abinds_append_disjoint<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fresh_distinct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="free">Δ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="main">⊑</span> Afix <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Abinds_Afix_below<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Abinds_append_disjoint<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fresh_distinct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Afix <span class="free">Δ</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊑</span> Afix <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Afix_least_below<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Afix_above_arg<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="ArityAnalysisFix-Afix_e_to_heap"><span class="command">lemma</span></span> Afix_e_to_heap<span class="main">:</span>
   <span class="quoted"><span class="quoted">"Afix <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span> <span class="main">⊔</span> <span class="free">ae</span><span class="main">)</span> <span class="main">⊑</span> Afix <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>esing <span class="free">x</span><span class="main">⋅</span><span class="free">n</span> <span class="main">⊔</span> <span class="free">ae</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Afix_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_least_below<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> join_below<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monofun_cfun_arg<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ArityAnalysisFix-Afix_e_to_heap'"><span class="command">lemma</span></span> Afix_e_to_heap'<span class="main">:</span>
   <span class="quoted"><span class="quoted">"Afix <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">⊑</span> Afix <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Afix_e_to_heap<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ae <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="main">⊥</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"up<span class="main">⋅</span><span class="free">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="CoCallFix">
<div class="head">
<h1>Theory CoCallFix</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CoCallFix
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#CoCallAnalysisSig">CoCallAnalysisSig</a> <a href="#CoCallAnalysisBinds">CoCallAnalysisBinds</a> <a href="#ArityAnalysisSig">ArityAnalysisSig</a> <span class="quoted">"<a href="../Launchbury/Env-Nominal.html">Launchbury.Env-Nominal</a>"</span>  <a href="#ArityAnalysisFix">ArityAnalysisFix</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">locale</span></span> CoCallArityAnalysis <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cccExp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> <span class="main">(</span>Arity <span class="main">→</span> AEnv <span class="main">×</span> CoCalls<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Aexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> <span class="main">(</span>Arity <span class="main">→</span> AEnv<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> fst <span class="main">(</span><span class="free">cccExp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⋅</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ArityAnalysis <span class="quoted">Aexp</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Aexp_syn'</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒜⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">a</span></span></span></sub><span class="hidden">⇙</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> Aexp <span class="bound">e</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Aexp_bot_syn'</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒜<span class="hidden">⇧</span><sup>⊥</sup>⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇧</span><sup>⊥</sup><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">a</span></span></span></sub><span class="hidden">⇙</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> fup<span class="main">⋅</span><span class="main">(</span>Aexp <span class="bound">e</span><span class="main">)</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallFix-Aexp_eq"><span class="command">lemma</span></span> Aexp_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">cccExp</span> <span class="free">e</span> <span class="main">⋅</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Aexp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> beta_cfun<span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>

<span class="keyword1" id="CoCallFix-fup_Aexp_eq"><span class="command">lemma</span></span> fup_Aexp_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fup<span class="main">⋅</span><span class="main">(</span>Aexp <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> fst <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span><span class="free">cccExp</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aexp_eq<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CCexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> <span class="main">(</span>Arity <span class="main">→</span> CoCalls<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CCexp</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> snd <span class="main">(</span><span class="free">cccExp</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1" id="CoCallFix-CCexp_eq"><span class="command">lemma</span></span> CCexp_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"CCexp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cccExp</span> <span class="free">e</span> <span class="main">⋅</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CCexp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> beta_cfun<span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>

<span class="keyword1" id="CoCallFix-fup_CCexp_eq"><span class="command">lemma</span></span> fup_CCexp_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fup<span class="main">⋅</span><span class="main">(</span>CCexp <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> snd <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span><span class="free">cccExp</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CCexp_eq<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> CoCallAnalysis <span class="quoted">CCexp</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CCfix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> <span class="main">(</span>AEnv <span class="main">×</span> CoCalls<span class="main">)</span> <span class="main">→</span> CoCalls"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CCfix</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> aeG<span class="main">.</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">G'</span><span class="main">.</span> ccBindsExtra <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⋅</span><span class="main">(</span>fst <span class="bound">aeG</span> <span class="main">,</span> <span class="bound">G'</span><span class="main">)</span> <span class="main">⊔</span> snd <span class="bound">aeG</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallFix-CCfix_eq"><span class="command">lemma</span></span> CCfix_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"CCfix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span><span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">G'</span><span class="main">.</span> ccBindsExtra <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="bound">G'</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CCfix_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoCallFix-CCfix_unroll"><span class="command">lemma</span></span> CCfix_unroll<span class="main">:</span> <span class="quoted"><span class="quoted">"CCfix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span><span class="free">G</span><span class="main">)</span> <span class="main">=</span> ccBindsExtra <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span> CCfix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span>  CCfix_eq
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallFix-fup_ccExp_restr_subst'"><span class="command">lemma</span></span> fup_ccExp_restr_subst'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> cc_restr <span class="free">S</span> <span class="main">(</span>CCexp <span class="free">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="main">(</span>CCexp <span class="free">e</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span>CCexp <span class="free">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span>CCexp <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> cc_restr_cc_restr <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cc_restr_cc_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="CoCallFix-ccBindsExtra_restr_subst'"><span class="command">lemma</span></span> ccBindsExtra_restr_subst'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x'</span> <span class="bound">e</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Γ</span> <span class="main">⟹</span> cc_restr <span class="free">S</span> <span class="main">(</span>CCexp <span class="bound">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="main">(</span>CCexp <span class="bound">e</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span>ccBindsExtra  <span class="free">Γ</span><span class="main">[</span><span class="free">x</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> 
       <span class="main">=</span> cc_restr <span class="free">S</span> <span class="main">(</span>ccBindsExtra  <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">,</span> cc_restr <span class="free">S</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBindsExtra_simp ccBinds_eq ccBind_eq Int_absorb2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> fv_subst_int<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(⊔)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> refl  arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mapCollect_cong<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fup_ccExp_restr_subst'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> map_of_SomeD<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subst_int<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span>   fv_subst_int2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> ccSquare_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> contra_subsetD domI dom_map_of_conv_domA<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fup_ccExp_restr_subst'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> map_of_SomeD<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subst_int<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span>   fv_subst_int2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> ccSquare_def cc_restr_twist<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">S</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> cc_restr_cc_restr<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fup_ccExp_restr_subst'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_of_SomeD<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subst_int<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span>   fv_subst_int2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fup_ccExp_restr_subst'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_of_SomeD<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subst_int<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span>   fv_subst_int2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> contra_subsetD domI dom_map_of_conv_domA<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallFix-ccBindsExtra_restr"><span class="command">lemma</span></span> ccBindsExtra_restr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span>ccBindsExtra <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="main">(</span>ccBindsExtra <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">,</span> cc_restr <span class="free">S</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBindsExtra_simp ccBinds_eq ccBind_eq Int_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(⊔)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> refl arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mapCollect_cong<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> contra_subsetD domI dom_map_of_conv_domA<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> contra_subsetD domI dom_map_of_conv_domA<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallFix-CCfix_restr"><span class="command">lemma</span></span> CCfix_restr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span>CCfix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="main">(</span>CCfix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">,</span> cc_restr <span class="free">S</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CCfix_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">.</span></span> cc_restr <span class="free"><span class="free">S</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">=</span></span> cc_restr <span class="free"><span class="free">S</span></span> <span class="bound"><span class="bound">y</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> ccBindsExtra_restr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallFix-ccField_CCfix"><span class="command">lemma</span></span> ccField_CCfix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ccField <span class="main">(</span>CCfix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">Γ</span> <span class="main">∪</span> ccField <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CCfix_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_ind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">.</span></span> ccField <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">⊆</span></span> fv <span class="free"><span class="free">Γ</span></span> <span class="main"><span class="main">∪</span></span> ccField <span class="free"><span class="free">G</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_ccBindsExtra<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="CoCallFix-CCfix_restr_subst'"><span class="command">lemma</span></span> CCfix_restr_subst'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x'</span> <span class="bound">e</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Γ</span> <span class="main">⟹</span> cc_restr <span class="free">S</span> <span class="main">(</span>CCexp <span class="bound">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="main">(</span>CCexp <span class="bound">e</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span>CCfix <span class="free">Γ</span><span class="main">[</span><span class="free">x</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="main">(</span>CCfix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">,</span> cc_restr <span class="free">S</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CCfix_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">.</span></span> cc_restr <span class="free"><span class="free">S</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">=</span></span> cc_restr <span class="free"><span class="free">S</span></span> <span class="bound"><span class="bound">y</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span>  ccBindsExtra_restr_subst'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ccBindsExtra_restr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="CoCallFix-Aexp_eqvt"><span class="command">lemma</span></span> Aexp_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>CoCallArityAnalysis.Aexp <span class="free">cccExp</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> CoCallArityAnalysis.Aexp <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">cccExp</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqvtI<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.Aexp_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1" id="CoCallFix-CCexp_eqvt"><span class="command">lemma</span></span> CCexp_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>CoCallArityAnalysis.CCexp <span class="free">cccExp</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> CoCallArityAnalysis.CCexp <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">cccExp</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqvtI<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.CCexp_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1" id="CoCallFix-CCfix_eqvt"><span class="command">lemma</span></span> CCfix_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>CoCallArityAnalysis.CCfix <span class="free">cccExp</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> CoCallArityAnalysis.CCfix <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">cccExp</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.CCfix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_cfun_eqvt<span class="main">)</span>

<span class="keyword1" id="CoCallFix-ccFix_cong"><span class="command">lemma</span></span> ccFix_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">heap2</span> <span class="main">⟹</span> <span class="free">cccexp1</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">cccexp2</span> <span class="bound">e</span><span class="main">)</span><span class="main">;</span> <span class="free">heap1</span> <span class="main">=</span> <span class="free">heap2</span> <span class="main">⟧</span>
      <span class="main">⟹</span> CoCallArityAnalysis.CCfix <span class="free">cccexp1</span> <span class="free">heap1</span> <span class="main">=</span> CoCallArityAnalysis.CCfix <span class="free">cccexp2</span> <span class="free">heap2</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.CCfix_def
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccBindsExtra_cong<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CoCallArityAnalysis.CCexp_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">context</span></span> CoCallArityAnalysis
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cccFix</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>AEnv <span class="main">×</span> CoCalls<span class="main">)</span> <span class="main">→</span> <span class="main">(</span>AEnv <span class="main">×</span> CoCalls<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cccFix</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> i<span class="main">.</span> <span class="main">(</span>Afix <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⋅</span><span class="main">(</span>fst <span class="bound">i</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> thunks <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">,</span> CCfix <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⋅</span><span class="main">(</span>Afix <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⋅</span><span class="main">(</span>fst <span class="bound">i</span>  <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallFix-cccFix_eq"><span class="command">lemma</span></span> cccFix_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cccFix <span class="free">Γ</span><span class="main">⋅</span><span class="free">i</span> <span class="main">=</span> <span class="main">(</span>Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>fst <span class="free">i</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> thunks <span class="free">Γ</span><span class="main">)</span><span class="main">,</span> CCfix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>fst <span class="free">i</span>  <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="free">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cccFix_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> beta_cfun<span class="main">)</span><span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="CoCallFix-cccFix_eqvt"><span class="command">lemma</span></span> cccFix_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>CoCallArityAnalysis.cccFix <span class="free">cccExp</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> CoCallArityAnalysis.cccFix  <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">cccExp</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqvtI<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.cccFix_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1" id="CoCallFix-cccFix_cong"><span class="command">lemma</span></span> cccFix_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">heap2</span> <span class="main">⟹</span> <span class="free">cccexp1</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">cccexp2</span> <span class="bound">e</span><span class="main">)</span><span class="main">;</span> <span class="free">heap1</span> <span class="main">=</span> <span class="free">heap2</span> <span class="main">⟧</span>
      <span class="main">⟹</span> CoCallArityAnalysis.cccFix <span class="free">cccexp1</span> <span class="free">heap1</span> <span class="main">=</span> CoCallArityAnalysis.cccFix <span class="free">cccexp2</span> <span class="free">heap2</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.cccFix_def
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Afix_cong<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CoCallArityAnalysis.Aexp_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccFix_cong Afix_cong <span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CoCallArityAnalysis.Aexp_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The non-recursive case›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ABind_nonrec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> exp <span class="main">⇒</span> AEnv <span class="main">×</span> CoCalls <span class="main">→</span> Arity<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ABind_nonrec</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> i<span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> isVal <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">--</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">∉</span><span class="main">(</span>snd <span class="bound">i</span><span class="main">)</span> <span class="keyword1">then</span> fst <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallFix-ABind_nonrec_eq"><span class="command">lemma</span></span> ABind_nonrec_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ABind_nonrec <span class="free">x</span> <span class="free">e</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span><span class="main">,</span><span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> isVal <span class="free">e</span> <span class="main">∨</span> <span class="free">x</span><span class="main">--</span><span class="free">x</span><span class="main">∉</span><span class="free">G</span> <span class="keyword1">then</span> <span class="free">ae</span> <span class="free">x</span> <span class="keyword1">else</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ABind_nonrec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> beta_cfun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont_if_else_above<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_join join_self_below<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="CoCallFix-ABind_nonrec_eqvt"><span class="command">lemma</span></span> ABind_nonrec_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>ABind_nonrec <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> ABind_nonrec <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqvtI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xa</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> ABind_nonrec_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1" id="CoCallFix-ABind_nonrec_above_arg"><span class="command">lemma</span></span> ABind_nonrec_above_arg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="free">x</span> <span class="main">⊑</span> ABind_nonrec <span class="free">x</span> <span class="free">e</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ABind_nonrec_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Aheap_nonrec</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Aheap_nonrec</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> i<span class="main">.</span> esing <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="main">(</span>ABind_nonrec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallFix-Aheap_nonrec_simp"><span class="command">lemma</span></span> Aheap_nonrec_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Aheap_nonrec <span class="free">x</span> <span class="free">e</span><span class="main">⋅</span><span class="free">i</span> <span class="main">=</span> esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>ABind_nonrec <span class="free">x</span> <span class="free">e</span><span class="main">⋅</span><span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Aheap_nonrec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoCallFix-Aheap_nonrec_lookup"><span class="command">lemma</span></span> Aheap_nonrec_lookup<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Aheap_nonrec <span class="free">x</span> <span class="free">e</span><span class="main">⋅</span><span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> ABind_nonrec <span class="free">x</span> <span class="free">e</span><span class="main">⋅</span><span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Aheap_nonrec_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoCallFix-Aheap_nonrec_eqvt'"><span class="command">lemma</span></span> Aheap_nonrec_eqvt'<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>Aheap_nonrec <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> Aheap_nonrec <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqvtI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> Aheap_nonrec_simp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>


<span class="keyword1"><span class="command">context</span></span> CoCallArityAnalysis
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">Afix_nonrec</span>
   <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Afix_nonrec</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> i<span class="main">.</span> fup<span class="main">⋅</span><span class="main">(</span>Aexp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>ABind_nonrec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⋅</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊔</span> fst <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="CoCallFix-Afix_nonrec_eq"><span class="command">lemma</span></span> Afix_nonrec_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Afix_nonrec <span class="free">x</span> <span class="free">e</span> <span class="main">⋅</span> <span class="free">i</span> <span class="main">=</span> fup<span class="main">⋅</span><span class="main">(</span>Aexp <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>ABind_nonrec <span class="free">x</span> <span class="free">e</span> <span class="main">⋅</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊔</span> fst <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Afix_nonrec_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> beta_cfun<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">CCfix_nonrec</span>
   <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CCfix_nonrec</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> i<span class="main">.</span> ccBind <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⋅</span> <span class="main">(</span>Aheap_nonrec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">i</span><span class="main">,</span> snd <span class="bound">i</span><span class="main">)</span>  <span class="main">⊔</span> ccProd <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>snd <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> isVal <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> snd <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="CoCallFix-CCfix_nonrec_eq"><span class="command">lemma</span></span> CCfix_nonrec_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"CCfix_nonrec <span class="free">x</span> <span class="free">e</span> <span class="main">⋅</span> <span class="free">i</span> <span class="main">=</span> ccBind <span class="free">x</span> <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>Aheap_nonrec <span class="free">x</span> <span class="free">e</span><span class="main">⋅</span><span class="free">i</span><span class="main">,</span> snd <span class="free">i</span><span class="main">)</span>  <span class="main">⊔</span> ccProd <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="free">x</span> <span class="main">(</span>snd <span class="free">i</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> isVal <span class="free">e</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> snd <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> CCfix_nonrec_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> beta_cfun<span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">cccFix_nonrec</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> exp <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>AEnv <span class="main">×</span> CoCalls<span class="main">)</span> <span class="main">→</span> <span class="main">(</span>AEnv <span class="main">×</span> CoCalls<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cccFix_nonrec</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> i<span class="main">.</span> <span class="main">(</span>Afix_nonrec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⋅</span><span class="bound">i</span> <span class="main">,</span> CCfix_nonrec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⋅</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="CoCallFix-cccFix_nonrec_eq"><span class="command">lemma</span></span> cccFix_nonrec_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"cccFix_nonrec <span class="free">x</span> <span class="free">e</span><span class="main">⋅</span><span class="free">i</span> <span class="main">=</span> <span class="main">(</span>Afix_nonrec <span class="free">x</span> <span class="free">e</span> <span class="main">⋅</span><span class="free">i</span> <span class="main">,</span> CCfix_nonrec <span class="free">x</span> <span class="free">e</span> <span class="main">⋅</span><span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cccFix_nonrec_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> beta_cfun<span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1" id="CoCallFix-AFix_nonrec_eqvt"><span class="command">lemma</span></span> AFix_nonrec_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>CoCallArityAnalysis.Afix_nonrec <span class="free">cccExp</span> <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> CoCallArityAnalysis.Afix_nonrec <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">cccExp</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqvtI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.Afix_nonrec_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>


<span class="keyword1" id="CoCallFix-CCFix_nonrec_eqvt"><span class="command">lemma</span></span> CCFix_nonrec_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>CoCallArityAnalysis.CCfix_nonrec <span class="free">cccExp</span> <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> CoCallArityAnalysis.CCfix_nonrec <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">cccExp</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqvtI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.CCfix_nonrec_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1" id="CoCallFix-cccFix_nonrec_eqvt"><span class="command">lemma</span></span> cccFix_nonrec_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>CoCallArityAnalysis.cccFix_nonrec <span class="free">cccExp</span> <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> CoCallArityAnalysis.cccFix_nonrec <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">cccExp</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqvtI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.cccFix_nonrec_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Combining the cases›</span></span>

<span class="keyword1"><span class="command">context</span></span> CoCallArityAnalysis
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">cccFix_choose</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>AEnv <span class="main">×</span> CoCalls<span class="main">)</span> <span class="main">→</span> <span class="main">(</span>AEnv <span class="main">×</span> CoCalls<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cccFix_choose</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> nonrec <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">then</span> case_prod cccFix_nonrec <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="keyword1">else</span> cccFix <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="CoCallFix-cccFix_choose_simp1"><span class="command">lemma</span></span> cccFix_choose_simp1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> nonrec <span class="free">Γ</span> <span class="main">⟹</span> cccFix_choose <span class="free">Γ</span> <span class="main">=</span> cccFix <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cccFix_choose_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="CoCallFix-cccFix_choose_simp2"><span class="command">lemma</span></span> cccFix_choose_simp2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fv <span class="free">e</span> <span class="main">⟹</span> cccFix_choose <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> cccFix_nonrec <span class="free">x</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cccFix_choose_def nonrec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="CoCallFix-cccFix_choose_eqvt"><span class="command">lemma</span></span> cccFix_choose_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>CoCallArityAnalysis.cccFix_choose <span class="free">cccExp</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> CoCallArityAnalysis.cccFix_choose <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">cccExp</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.cccFix_choose_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted">nonrec</span> <span class="quoted"><span class="free">π</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eqvt_cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> nonrecE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallFix-cccFix_nonrec_cong"><span class="command">lemma</span></span> cccFix_nonrec_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">cccexp1</span> <span class="free">e</span> <span class="main">=</span> <span class="free">cccexp2</span> <span class="free">e</span>  <span class="main">⟹</span> CoCallArityAnalysis.cccFix_nonrec <span class="free">cccexp1</span> <span class="free">x</span> <span class="free">e</span> <span class="main">=</span> CoCallArityAnalysis.cccFix_nonrec <span class="free">cccexp2</span> <span class="free">x</span> <span class="free">e</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
   <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.cccFix_nonrec_eq
   <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.Afix_nonrec_eq
   <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.CCfix_nonrec_eq
   <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.fup_Aexp_eq
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccBind_cong<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.CCexp_def
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallFix-cccFix_choose_cong"><span class="command">lemma</span></span> cccFix_choose_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">heap2</span> <span class="main">⟹</span> <span class="free">cccexp1</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">cccexp2</span> <span class="bound">e</span><span class="main">)</span><span class="main">;</span> <span class="free">heap1</span> <span class="main">=</span> <span class="free">heap2</span> <span class="main">⟧</span>
      <span class="main">⟹</span> CoCallArityAnalysis.cccFix_choose <span class="free">cccexp1</span> <span class="free">heap1</span> <span class="main">=</span> CoCallArityAnalysis.cccFix_choose <span class="free">cccexp2</span> <span class="free">heap2</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> CoCallArityAnalysis.cccFix_choose_def
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonrecE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cccFix_nonrec_cong<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cccFix_cong<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CoCallAnalysisImpl">
<div class="head">
<h1>Theory CoCallAnalysisImpl</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CoCallAnalysisImpl
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Arity-Nominal.html">Arity-Nominal</a>"</span> <span class="quoted">"<a href="../Launchbury/Nominal-HOLCF.html">Launchbury.Nominal-HOLCF</a>"</span> <span class="quoted">"<a href="../Launchbury/Env-Nominal.html">Launchbury.Env-Nominal</a>"</span>  <span class="quoted">"<a href="Env-Set-Cpo.html">Env-Set-Cpo</a>"</span> <span class="quoted">"<a href="../Launchbury/Env-HOLCF.html">Launchbury.Env-HOLCF</a>"</span> <a href="#CoCallFix">CoCallFix</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combined_restrict</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set <span class="main">⇒</span> <span class="main">(</span>AEnv <span class="main">×</span> CoCalls<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>AEnv <span class="main">×</span> CoCalls<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">combined_restrict</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1">f|`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> cc_restr <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallAnalysisImpl-fst_combined_restrict"><span class="command">lemma</span></span> fst_combined_restrict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="main">(</span>combined_restrict <span class="free">S</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">p</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisImpl-snd_combined_restrict"><span class="command">lemma</span></span> snd_combined_restrict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"snd <span class="main">(</span>combined_restrict <span class="free">S</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="main">(</span>snd <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisImpl-combined_restrict_eqvt"><span class="command">lemma</span></span> combined_restrict_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> combined_restrict <span class="free">S</span> <span class="free">p</span> <span class="main">=</span> combined_restrict <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallAnalysisImpl-combined_restrict_cont"><span class="command">lemma</span></span> combined_restrict_cont<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> combined_restrict <span class="free">S</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">G</span><span class="main">)</span><span class="main">.</span> combined_restrict <span class="free">S</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">G</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> case_prod_eta<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> cont_compose<span class="main">[</span><span class="operator">OF</span> combined_restrict_cont<span class="main">,</span> <span class="operator">cont2cont</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="CoCallAnalysisImpl-combined_restrict_perm"><span class="command">lemma</span></span> combined_restrict_perm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">π</span> <span class="main">♯*</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"combined_restrict <span class="free">S</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> combined_restrict <span class="free">S</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">env</span> <span class="main">::</span> <span class="quoted">AEnv</span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="skolem">G</span> <span class="main">::</span> <span class="quoted">CoCalls</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">env</span><span class="main">,</span> <span class="skolem">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"env_restr <span class="free">S</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="skolem">env</span><span class="main">)</span> <span class="main">=</span> env_restr <span class="free">S</span> <span class="skolem">env</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_perm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="skolem">G</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cc_restr_perm<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">predCC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set <span class="main">⇒</span> <span class="main">(</span>Arity <span class="main">→</span> CoCalls<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>Arity <span class="main">→</span> CoCalls<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">predCC</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">0</span> <span class="keyword1">then</span> cc_restr <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> ccSquare <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallAnalysisImpl-predCC_eq"><span class="command">lemma</span></span> predCC_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"predCC <span class="free">S</span> <span class="free">f</span> <span class="main">⋅</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">≠</span> <span class="main">0</span> <span class="keyword1">then</span> cc_restr <span class="free">S</span> <span class="main">(</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> ccSquare <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> predCC_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> beta_cfun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont_if_else_above<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_cc_restr<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallAnalysisImpl-predCC_eqvt"><span class="command">lemma</span></span> predCC_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>predCC <span class="free">S</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> predCC <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqvtI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> predCC_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1" id="CoCallAnalysisImpl-cc_restr_predCC"><span class="command">lemma</span></span> cc_restr_predCC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span>predCC <span class="free">S'</span> <span class="free">f</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>predCC <span class="main">(</span><span class="free">S'</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">Λ</span> n<span class="main">.</span> cc_restr <span class="free">S</span> <span class="main">(</span><span class="free">f</span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> predCC_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_commute ccSquare_def<span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisImpl-cc_restr_predCC'"><span class="command">lemma</span></span> cc_restr_predCC'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span>predCC <span class="free">S</span> <span class="free">f</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> predCC <span class="free">S</span> <span class="free">f</span><span class="main">⋅</span><span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> predCC_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  
<span class="keyword1"><span class="command">nominal_function</span></span>
  <span class="entity">cCCexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> <span class="main">(</span>Arity <span class="main">→</span> AEnv <span class="main">×</span> CoCalls<span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cCCexp</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span>      <span class="main">(</span><span class="keyword1">Λ</span> n <span class="main">.</span> <span class="main">(</span>esing <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="main">(</span>up <span class="main">⋅</span> <span class="bound">n</span><span class="main">)</span><span class="main">,</span>                                   <span class="main">⊥</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cCCexp</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> n <span class="main">.</span> combined_restrict <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> predCC <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> snd<span class="main">(</span><span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cCCexp</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span>    <span class="main">(</span><span class="keyword1">Λ</span> n <span class="main">.</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span>esing <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="main">(</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>          snd <span class="main">(</span><span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> ccProd <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span> <span class="main">(</span>insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cCCexp</span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span>    <span class="main">(</span><span class="keyword1">Λ</span> n <span class="main">.</span> combined_restrict <span class="main">(</span>fv <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>CoCallArityAnalysis.cccFix_choose <span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cCCexp</span> <span class="main">(</span>Bool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span>     <span class="main">⊥</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cCCexp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">scrut</span></span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> n<span class="main">.</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">scrut</span></span></span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="main">⊔</span> fst <span class="main">(</span><span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span> <span class="main">⊔</span> fst <span class="main">(</span><span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">,</span>
     snd <span class="main">(</span><span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">scrut</span></span></span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span> <span class="main">⊔</span> snd <span class="main">(</span><span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> ccProd <span class="main">(</span>edom <span class="main">(</span>fst <span class="main">(</span><span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">scrut</span></span></span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>edom <span class="main">(</span>fst <span class="main">(</span><span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span>fst <span class="main">(</span><span class="free">cCCexp</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eqvt_def cCCexp_graph_aux_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_cfun_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Terms.exp_strong_exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>10 <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">x'</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>9<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> eqvt_lam_case<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="main">::</span> <span class="quoted">perm</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">-</span><span class="skolem">π</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"combined_restrict <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> predCC <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> snd<span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span>
       <span class="main">=</span> combined_restrict <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> predCC <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> snd<span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> combined_restrict_perm<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> combined_restrict <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> predCC <span class="main">(</span><span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> snd<span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="skolem">e</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_apply<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> pemute_minus_self Abs_cfun_eqvt<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> perm_supp_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> calculation
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Λ</span> n<span class="main">.</span> combined_restrict <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> predCC <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> snd<span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>
        <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> n<span class="main">.</span> combined_restrict <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> predCC <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> snd<span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="skolem">e</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>19 <span class="skolem">Γ</span> <span class="skolem">body</span> <span class="skolem">Γ'</span> <span class="skolem">body'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>9<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eqvt_let_case<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="main">::</span> <span class="quoted">perm</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">-</span><span class="skolem">π</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span>fv <span class="main">(</span>Terms.Let <span class="skolem">Γ</span> <span class="skolem">body</span><span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span>
    
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"combined_restrict <span class="main">(</span>fv <span class="main">(</span>Terms.Let <span class="skolem">Γ</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>CoCallArityAnalysis.cccFix_choose <span class="free">cCCexp_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span>  combined_restrict <span class="main">(</span>fv <span class="main">(</span>Terms.Let <span class="skolem">Γ</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="main">(</span>CoCallArityAnalysis.cccFix_choose <span class="free">cCCexp_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> combined_restrict_perm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="main">(</span>CoCallArityAnalysis.cccFix_choose <span class="free">cCCexp_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                       CoCallArityAnalysis.cccFix_choose <span class="main">(</span><span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="free">cCCexp_sumC</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="free">cCCexp_sumC</span><span class="main">)</span> <span class="skolem">body</span><span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pemute_minus_self<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"CoCallArityAnalysis.cccFix_choose <span class="main">(</span><span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="free">cCCexp_sumC</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="main">=</span> CoCallArityAnalysis.cccFix_choose <span class="free">cCCexp_sumC</span> <span class="skolem">Γ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cccFix_choose_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eqvt_at_apply<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="free">cCCexp_sumC</span><span class="main">)</span> <span class="skolem">body</span> <span class="main">=</span> <span class="free">cCCexp_sumC</span> <span class="skolem">body</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eqvt_at_apply<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> calculation
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Λ</span> n<span class="main">.</span> combined_restrict <span class="main">(</span>fv <span class="main">(</span>Terms.Let <span class="skolem">Γ</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>CoCallArityAnalysis.cccFix_choose <span class="free">cCCexp_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="keyword1">Λ</span> n<span class="main">.</span> combined_restrict <span class="main">(</span>fv <span class="main">(</span>Terms.Let <span class="skolem">Γ</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>CoCallArityAnalysis.cccFix_choose <span class="free">cCCexp_sumC</span> <span class="skolem">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">cCCexp_sumC</span> <span class="skolem">body</span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">nominal_termination</span></span> <span class="main">(</span>eqvt<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">locale</span></span> CoCallAnalysisImpl
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">sublocale</span></span> CoCallArityAnalysis <span class="quoted">cCCexp</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">sublocale</span></span> ArityAnalysis <span class="quoted">Aexp</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Aexp_syn''</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒜⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">a</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> Aexp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Aexp_bot_syn''</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒜<span class="hidden">⇧</span><sup>⊥</sup>⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇧</span><sup>⊥</sup><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">a</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> fup<span class="main">⋅</span><span class="main">(</span>Aexp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ccExp_syn''</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒢⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">a</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> CCexp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ccExp_bot_syn''</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒢<span class="hidden">⇧</span><sup>⊥</sup>⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇧</span><sup>⊥</sup><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">a</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> fup<span class="main">⋅</span><span class="main">(</span>CCexp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>


<span class="keyword1" id="CoCallAnalysisImpl-cCCexp_eq"><span class="command">lemma</span></span> cCCexp_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cCCexp <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span>      <span class="main">(</span>esing <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span>up <span class="main">⋅</span> <span class="free">n</span><span class="main">)</span><span class="main">,</span>                                   <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"cCCexp <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span> combined_restrict <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>cCCexp <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> predCC <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> snd<span class="main">(</span>cCCexp <span class="free">e</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"cCCexp <span class="main">(</span>App <span class="free">e</span> <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span>    <span class="main">(</span>fst <span class="main">(</span>cCCexp <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span>esing <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>          snd <span class="main">(</span>cCCexp <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> ccProd <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"cCCexp <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span>    combined_restrict <span class="main">(</span>fv <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>CoCallArityAnalysis.cccFix_choose cCCexp <span class="free">Γ</span> <span class="main">⋅</span> <span class="main">(</span>cCCexp <span class="free">e</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"cCCexp <span class="main">(</span>Bool <span class="free">b</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"cCCexp <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>cCCexp <span class="free">scrut</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="main">⊔</span> fst <span class="main">(</span>cCCexp <span class="free">e1</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">⊔</span> fst <span class="main">(</span>cCCexp <span class="free">e2</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">,</span>
        snd <span class="main">(</span>cCCexp <span class="free">scrut</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span>snd <span class="main">(</span>cCCexp <span class="free">e1</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">⊔</span> snd <span class="main">(</span>cCCexp <span class="free">e2</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> ccProd <span class="main">(</span>edom <span class="main">(</span>fst <span class="main">(</span>cCCexp <span class="free">scrut</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>edom <span class="main">(</span>fst <span class="main">(</span>cCCexp <span class="free">e1</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span>fst <span class="main">(</span>cCCexp <span class="free">e2</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> cCCexp.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span><span class="main">]</span>


<span class="keyword1" id="CoCallAnalysisImpl-Aexp_pre_simps"><span class="command">lemma</span></span> Aexp_pre_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> Aexp <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">f|`</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span>App <span class="free">e</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Aexp <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊔</span> esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> nonrec <span class="free">Γ</span> <span class="main">⟹</span>
     𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> thunks <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fv <span class="free">e</span> <span class="main">⟹</span>
     𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e</span> <span class="keyword1">in</span> <span class="free">exp</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span>Aexp <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>ABind_nonrec <span class="free">x</span> <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">exp</span><span class="main">,</span> CCexp <span class="free">exp</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> 𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">exp</span><span class="main">)</span>
            <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e</span> <span class="keyword1">in</span> <span class="free">exp</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span>Bool <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> 𝒜<span class="hidden">⇘</span><sub><span class="main">0</span></sub><span class="hidden">⇙</span> <span class="free">scrut</span> <span class="main">⊔</span> 𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e1</span> <span class="main">⊔</span> 𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e2</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cccFix_eq Aexp_eq fup_Aexp_eq CCexp_eq fup_CCexp_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1" id="CoCallAnalysisImpl-CCexp_pre_simps"><span class="command">lemma</span></span> CCexp_pre_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"CCexp <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"CCexp <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span> predCC <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>CCexp <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"CCexp <span class="main">(</span>App <span class="free">e</span> <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span> CCexp <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">⊔</span> ccProd <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> nonrec <span class="free">Γ</span> <span class="main">⟹</span>
      CCexp <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span> cc_restr <span class="main">(</span>fv <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>CCfix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="free">e</span><span class="main">⋅</span><span class="free">n</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> thunks <span class="free">Γ</span><span class="main">)</span><span class="main">,</span> CCexp <span class="free">e</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fv <span class="free">e</span> <span class="main">⟹</span> CCexp <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e</span> <span class="keyword1">in</span> <span class="free">exp</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span>
    cc_restr <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e</span> <span class="keyword1">in</span> <span class="free">exp</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>ccBind <span class="free">x</span> <span class="free">e</span> <span class="main">⋅</span><span class="main">(</span>Aheap_nonrec <span class="free">x</span> <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="free">exp</span><span class="main">⋅</span><span class="free">n</span><span class="main">,</span> CCexp <span class="free">exp</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">,</span> CCexp <span class="free">exp</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span>
       <span class="main">⊔</span> ccProd <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="free">x</span> <span class="main">(</span>CCexp <span class="free">exp</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> isVal <span class="free">e</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> CCexp <span class="free">exp</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"CCexp <span class="main">(</span>Bool <span class="free">b</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"CCexp <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span>
       CCexp <span class="free">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊔</span>
       <span class="main">(</span>CCexp <span class="free">e1</span><span class="main">⋅</span><span class="free">n</span> <span class="main">⊔</span> CCexp <span class="free">e2</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">⊔</span>
       ccProd <span class="main">(</span>edom <span class="main">(</span>Aexp <span class="free">scrut</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>edom <span class="main">(</span>Aexp <span class="free">e1</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span>Aexp <span class="free">e2</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cccFix_eq Aexp_eq fup_Aexp_eq CCexp_eq fup_CCexp_eq predCC_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> ccField_CCexp<span class="main">:</span> <span class="quoted"><span class="quoted">"ccField <span class="main">(</span>CCexp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Aexp_edom'<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exp_induct_rec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CCexp_pre_simps predCC_eq Aexp_pre_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_cc_restr<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_ccProd_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallAnalysisImpl-cc_restr_CCexp"><span class="command">lemma</span></span> cc_restr_CCexp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cc_restr <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span> <span class="main">(</span>CCexp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> CCexp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cc_restr_noop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_CCexp<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisImpl-ccField_fup_CCexp"><span class="command">lemma</span></span> ccField_fup_CCexp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccField <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span>CCexp <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_CCexp<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisImpl-cc_restr_fup_ccExp_useless"><span class="command">lemma</span></span> cc_restr_fup_ccExp_useless<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cc_restr <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span> <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span>CCexp <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> fup<span class="main">⋅</span><span class="main">(</span>CCexp <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cc_restr_noop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_fup_CCexp<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> EdomArityAnalysis <span class="quoted">Aexp</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> Aexp_edom'<span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisImpl-CCexp_simps"><span class="command">lemma</span></span> CCexp_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span><span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇘</span><sub><span class="main">0</span></sub><span class="hidden">⇙</span><span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇘</span><sub>inc<span class="main">⋅</span><span class="free">a</span></sub><span class="hidden">⇙</span><span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> cc_delete <span class="free">x</span> <span class="main">(</span>𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span>App <span class="free">e</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> 𝒢<span class="hidden">⇘</span><sub>inc<span class="main">⋅</span><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span> <span class="main">⊔</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="keyword1">G×</span>insert <span class="free">x</span> <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> nonrec <span class="free">Γ</span> <span class="main">⟹</span> 𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>CCfix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> thunks <span class="free">Γ</span><span class="main">)</span><span class="main">,</span> 𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">G|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fv <span class="free">e'</span> <span class="main">⟹</span> 𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e'</span> <span class="keyword1">in</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span>
    cc_delete <span class="free">x</span>
       <span class="main">(</span>ccBind <span class="free">x</span> <span class="free">e'</span> <span class="main">⋅</span><span class="main">(</span>Aheap_nonrec <span class="free">x</span> <span class="free">e'</span><span class="main">⋅</span><span class="main">(</span>𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">,</span> 𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span><span class="main">,</span> 𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span>
       <span class="main">⊔</span> fv <span class="free">e'</span> <span class="keyword1">G×</span> <span class="main">(</span>ccNeighbors <span class="free">x</span> <span class="main">(</span>𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> isVal <span class="free">e'</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> 𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span>Bool <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span>
       𝒢<span class="hidden">⇘</span><sub><span class="main">0</span></sub><span class="hidden">⇙</span> <span class="free">scrut</span> <span class="main">⊔</span> <span class="main">(</span>𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e1</span> <span class="main">⊔</span> 𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e2</span><span class="main">)</span> <span class="main">⊔</span>
       edom <span class="main">(</span>𝒜<span class="hidden">⇘</span><sub><span class="main">0</span></sub><span class="hidden">⇙</span> <span class="free">scrut</span><span class="main">)</span> <span class="keyword1">G×</span> <span class="main">(</span>edom <span class="main">(</span>𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span>𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CCexp_pre_simps Diff_eq cc_restr_cc_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> predCC_eq 
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> cc_restr_cc_restr cc_restr_join
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cc_restr_noop
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_cc_delete<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_cc_restr<span class="main"><span class="main">]</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_CCexp<span class="main"><span class="main">]</span></span>
                   subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_CCfix<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_ccBind<span class="main"><span class="main">]</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_ccProd_subset<span class="main"><span class="main">]</span></span> elem_to_ccField
     <span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Aheap</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Aheap</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> <span class="keyword1">if</span> nonrec <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>case_prod Aheap_nonrec <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">a</span><span class="main">,</span> CCexp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="keyword1">else</span>  <span class="main">(</span>Afix <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⋅</span> <span class="main">(</span>Aexp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> thunks <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallAnalysisImpl-Aheap_simp1"><span class="command">lemma</span></span> Aheap_simp1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> nonrec <span class="free">Γ</span> <span class="main">⟹</span> Aheap <span class="free">Γ</span> <span class="free">e</span> <span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> <span class="main">(</span>Afix <span class="free">Γ</span> <span class="main">⋅</span> <span class="main">(</span>Aexp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> thunks <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Aheap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoCallAnalysisImpl-Aheap_simp2"><span class="command">lemma</span></span> Aheap_simp2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fv <span class="free">e'</span> <span class="main">⟹</span> Aheap <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e'</span><span class="main">)</span><span class="main">]</span> <span class="free">e</span> <span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> Aheap_nonrec <span class="free">x</span> <span class="free">e'</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">,</span> CCexp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Aheap_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonrec_def<span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisImpl-Aheap_eqvt'"><span class="command">lemma</span></span> Aheap_eqvt'<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>Aheap <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> Aheap <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqvtI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted">nonrec</span> <span class="quoted"><span class="free">π</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eqvt_cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> nonrecE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> nonrecE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ArityAnalysisHeap <span class="quoted">Aheap</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ArityAnalysisHeapEqvt <span class="quoted">Aheap</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">∙</span> Aheap <span class="main">=</span> Aheap"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallAnalysisImpl-Aexp_lam_simp"><span class="command">lemma</span></span> Aexp_lam_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"Aexp <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">n</span> <span class="main">=</span> env_delete <span class="free">x</span> <span class="main">(</span>Aexp <span class="free">e</span> <span class="main">⋅</span> <span class="main">(</span>pred <span class="main">⋅</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Aexp <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">n</span> <span class="main">=</span> Aexp <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="free">e</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aexp_pre_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> env_delete <span class="free">x</span> <span class="main">(</span>Aexp <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="free">e</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> env_delete <span class="free">x</span> <span class="main">(</span>Aexp <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_useless<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallAnalysisImpl-Aexp_Let_simp1"><span class="command">lemma</span></span> Aexp_Let_simp1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> nonrec <span class="free">Γ</span> <span class="main">⟹</span> 𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> thunks <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Aexp_pre_simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Afix_edom<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thunks_domA<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisImpl-Aexp_Let_simp2"><span class="command">lemma</span></span> Aexp_Let_simp2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fv <span class="free">e</span> <span class="main">⟹</span> 𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span><span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e</span> <span class="keyword1">in</span> <span class="free">exp</span><span class="main">)</span> <span class="main">=</span> env_delete <span class="free">x</span> <span class="main">(</span>𝒜<span class="hidden">⇧</span><sup>⊥</sup><span class="hidden">⇘</span><sub>ABind_nonrec <span class="free">x</span> <span class="free">e</span> <span class="main">⋅</span> <span class="main">(</span>𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">exp</span><span class="main">,</span> CCexp <span class="free">exp</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="free">e</span> <span class="main">⊔</span> 𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Aexp_pre_simps env_delete_restr
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fup_Aexp_edom<span class="main"><span class="main">]</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="CoCallAnalysisImpl-Aexp_simps"><span class="command">lemma</span></span> Aexp_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span><span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span><span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> env_delete <span class="free">x</span> <span class="main">(</span>𝒜<span class="hidden">⇘</span><sub>pred<span class="main">⋅</span><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span><span class="main">(</span>App <span class="free">e</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Aexp <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊔</span> esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> nonrec <span class="free">Γ</span> <span class="main">⟹</span> 𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span><span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span>Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> thunks <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fv <span class="free">e'</span> <span class="main">⟹</span> 𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span><span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e'</span> <span class="keyword1">in</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span>
      env_delete <span class="free">x</span> <span class="main">(</span>𝒜<span class="hidden">⇧</span><sup>⊥</sup><span class="hidden">⇘</span><sub>ABind_nonrec <span class="free">x</span> <span class="free">e'</span><span class="main">⋅</span><span class="main">(</span>𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">,</span> 𝒢<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="free">e'</span> <span class="main">⊔</span> 𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span><span class="main">(</span>Bool <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span><span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> 𝒜<span class="hidden">⇘</span><sub><span class="main">0</span></sub><span class="hidden">⇙</span> <span class="free">scrut</span> <span class="main">⊔</span> 𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e1</span> <span class="main">⊔</span> 𝒜<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e2</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aexp_lam_simp Aexp_Let_simp1 Aexp_Let_simp2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aexp_pre_simps<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="CallArityEnd2End">
<div class="head">
<h1>Theory CallArityEnd2End</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CallArityEnd2End
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#ArityTransform">ArityTransform</a> <a href="#CoCallAnalysisImpl">CoCallAnalysisImpl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> CallArityEnd2End
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">sublocale</span></span> CoCallAnalysisImpl<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CallArityEnd2End-fresh_var_eqE"><span class="command">lemma</span></span> fresh_var_eqE<span class="main">[</span><span class="operator">elim_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fresh_var <span class="free">e</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span>  fv <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_var_not_free<span class="main">)</span>

<span class="keyword1" id="CallArityEnd2End-example1"><span class="command">lemma</span></span> example1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted">exp</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">::</span> <span class="quoted">var</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Aexp_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> Aexp <span class="free">e</span><span class="main">⋅</span><span class="bound">a</span> <span class="main">=</span> esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="main">⊔</span> esing <span class="free">y</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ccExp_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> CCexp <span class="free">e</span><span class="main">⋅</span><span class="bound">a</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transform <span class="main">1</span> <span class="free">e</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"isVal <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≠</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≠</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">z</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"transform <span class="main">1</span> <span class="main">(</span><span class="keyword1">let</span> <span class="free">y</span> <span class="keyword1">be</span>  App <span class="main">(</span>Var <span class="free">f</span><span class="main">)</span> <span class="free">g</span> <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e</span> <span class="keyword1">in</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
         <span class="keyword1">let</span> <span class="free">y</span> <span class="keyword1">be</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">z</span><span class="main">].</span> App <span class="main">(</span>App <span class="main">(</span>Var <span class="free">f</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">z</span><span class="main">].</span> App <span class="free">e</span> <span class="free">z</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted">edom</span><span class="main">,</span> <span class="operator">OF</span> Aexp_e<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> fv <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> Aexp_edom' insert_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> nonrec <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonrec_def<span class="main">)</span>
 
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="free">e</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"thunks <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_Cons<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"CCfix <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span>esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">1</span><span class="main">)</span> <span class="main">⊔</span> esing <span class="free">y</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> CCfix_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fix_bottom_iff ccBindsExtra_simp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBind_eq disj ccExp_e<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Afix <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span>esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">1</span><span class="main">)</span> <span class="main">⊔</span> esing <span class="free">y</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Afix_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disj Aexp_e<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">z</span> <span class="free">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disj Aexp_e<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Aheap <span class="main">[</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> App <span class="main">(</span>Var <span class="free">f</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e</span> <span class="keyword1">in</span> Var <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="main">1</span> <span class="main">=</span> esing <span class="free">y</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span>Aexp <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e</span> <span class="keyword1">in</span> Var <span class="free">x</span> <span class="main">)</span><span class="main">⋅</span><span class="main">1</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  Aheap_nonrec_simp ABind_nonrec_eq pure_fresh fresh_at_base disj<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Aexp <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e</span> <span class="keyword1">in</span> Var <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> esing <span class="free">y</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join disj<span class="main">)</span>
    
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Aheap <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="main">1</span> <span class="main">=</span> esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join disj<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> inc<span class="main">⋅</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Aeta_expand <span class="main">1</span> <span class="main">(</span>App <span class="main">(</span>Var <span class="free">f</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">z</span><span class="main">].</span> App <span class="main">(</span>App <span class="main">(</span>Var <span class="free">f</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> exp_assn.eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> change_Lam_Variable<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">z</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"fresh_var <span class="main"><span class="main">(</span></span>App <span class="main"><span class="main">(</span></span>Var <span class="free"><span class="free">f</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">g</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_at_base pure_fresh disj <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> flip_fresh_fresh  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fresh_var_eqE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Aeta_expand <span class="main">1</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">z</span><span class="main">].</span> App <span class="free">e</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> exp_assn.eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> change_Lam_Variable<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">z</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"fresh_var <span class="free"><span class="free">e</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_at_base pure_fresh disj fresh <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> flip_fresh_fresh  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fresh_var_eqE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Let_eq_iff <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_transform_Cons map_transform_Nil disj<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SestoftGC">
<div class="head">
<h1>Theory SestoftGC</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> SestoftGC
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Sestoft">Sestoft</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gc_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"conf <span class="main">⇒</span> conf <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  normal<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>G</sub></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span>"</span></span>
<span class="main">|</span> dropUpd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>G</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">@</span> <span class="main">[</span>Dummy <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="comment1">(*
| drop: "x ∈ domA Γ  ⟹ (Γ, e, S) ⇒<span class="hidden">⇩</span><sub>G</sub> (delete x Γ, e, S @ [Dummy x])"
*)</span>

<span class="keyword1"><span class="command">lemmas</span></span> gc_step_intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span>
  normal<span class="main">[</span><span class="operator">OF</span> step.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> normal<span class="main">[</span><span class="operator">OF</span> step.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> normal<span class="main">[</span><span class="operator">OF</span> step.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  normal<span class="main">[</span><span class="operator">OF</span> step.intros<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> normal<span class="main">[</span><span class="operator">OF</span> step.intros<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>  dropUpd

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gc_steps</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gc_steps</span> <span class="main">≡</span> gc_step<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> converse_rtranclp_into_rtranclp<span class="main">[</span><span class="operator">of</span> <span class="quoted">gc_step</span><span class="main">,</span> <span class="operator">OF</span> _ r_into_rtranclp<span class="main">,</span> <span class="operator">trans</span><span class="main">]</span>

<span class="keyword1" id="SestoftGC-var_onceI"><span class="command">lemma</span></span> var_onceI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Var <span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span> <span class="main">,</span> <span class="free">S</span><span class="main">@</span><span class="main">[</span>Dummy <span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Var <span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span> <span class="main">,</span> Upd <span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub></span>  <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">@</span><span class="main">[</span>Dummy <span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ r_into_rtranclp<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*
lemma lam_and_restrict:
  assumes "atom ` domA Δ ♯* Γ" and "atom ` domA Δ ♯* S"
  assumes "V ⊆ domA Δ"
  shows "(Γ, Let Δ e, S) ⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup> (restrictA V Δ @ Γ, e, S)"
proof-
  from assms(1,2) have "(Γ, Let Δ e, S) ⇒<span class="hidden">⇩</span><sub>G</sub> (Δ @ Γ, e, S)"..
  also
  have "… ⇒<span class="hidden">⇩</span><sub>G</sub> (restrictA (V ∪ domA Γ) (Δ @ Γ), e, S)"..
  also
  from fresh_distinct[OF assms(1)]
  have "restrictA (V ∪ domA Γ) Δ = restrictA V Δ" by (induction Δ) auto
  hence "restrictA (V ∪ domA Γ) (Δ @ Γ) = restrictA V Δ @ Γ"
    by (simp add: restrictA_append restrictA_noop)
  finally show ?thesis.
qed
*)</span>

<span class="keyword1" id="SestoftGC-normal_trans"><span class="command">lemma</span></span> normal_trans<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c'</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rtranclp_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> normal rtranclp.rtrancl_into_rtrancl<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">to_gc_conf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var list <span class="main">⇒</span> conf <span class="main">⇒</span> conf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_gc_conf</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> restr_stack <span class="main">(</span><span class="main">-</span> set <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">@</span> <span class="main">(</span>map Dummy <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SestoftGC-restr_stack_map_Dummy"><span class="command">lemma</span></span> restr_stack_map_Dummy<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restr_stack <span class="free">V</span> <span class="main">(</span>map Dummy <span class="free">l</span><span class="main">)</span> <span class="main">=</span> map Dummy <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftGC-restr_stack_append"><span class="command">lemma</span></span> restr_stack_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restr_stack <span class="free">V</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="free">l'</span><span class="main">)</span> <span class="main">=</span> restr_stack <span class="free">V</span> <span class="free">l</span> <span class="main">@</span> restr_stack <span class="free">V</span> <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> restr_stack.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftGC-to_gc_conf_append"><span class="command">lemma</span></span> to_gc_conf_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"to_gc_conf <span class="main">(</span><span class="free">r</span><span class="main">@</span><span class="free">r'</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> to_gc_conf <span class="free">r</span> <span class="main">(</span>to_gc_conf <span class="free">r'</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftGC-to_gc_conf_eqE"><span class="command">lemma</span></span> to_gc_conf_eqE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"to_gc_conf <span class="free">r</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Γ'</span> <span class="free">S'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ'</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> restrictA <span class="main">(</span><span class="main">-</span> set <span class="free">r</span><span class="main">)</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> restr_stack <span class="main">(</span><span class="main">-</span> set <span class="free">r</span><span class="main">)</span> <span class="free">S'</span> <span class="main">@</span> map Dummy <span class="main">(</span>rev <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">safe_hd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">safe_hd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
     <span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">safe_hd</span> <span class="main">[]</span> <span class="main">=</span> None"</span></span>

<span class="keyword1" id="SestoftGC-safe_hd_None"><span class="command">lemma</span></span> safe_hd_None<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="free">xs</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">r_ok</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var list <span class="main">⇒</span> conf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_ok</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> set <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⊆</span> domA <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∪</span> upds <span class="main">(</span>snd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SestoftGC-subset_bound_invariant"><span class="command">lemma</span></span> subset_bound_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invariant step <span class="main">(</span>r_ok <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⇒</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"r_ok <span class="free">r</span> <span class="skolem">x</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"r_ok <span class="free">r</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SestoftGC-safe_hd_restr_stack"><span class="command">lemma</span></span> safe_hd_restr_stack<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Some <span class="free">a</span> <span class="main">=</span> safe_hd <span class="main">(</span>restr_stack <span class="free">V</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> restr_stack <span class="free">V</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> restr_stack <span class="free">V</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> restr_stack.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SestoftGC-sestoftUnGCStack"><span class="command">lemma</span></span> sestoftUnGCStack<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Γ'</span> <span class="free">S'</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">Γ'</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="free">Γ'</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> isVal <span class="free">e</span> <span class="main">∨</span> safe_hd <span class="free">S'</span> <span class="main">=</span> safe_hd <span class="main">(</span>restr_stack <span class="main">(</span><span class="main">-</span> set <span class="free">r</span><span class="main">)</span> <span class="free">S'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"isVal <span class="free">e</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> that assms 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">S</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Some <span class="skolem">s</span> <span class="main">=</span> safe_hd <span class="main">(</span>restr_stack <span class="main">(</span><span class="main">-</span> set <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="free">e</span>›</span></span> <span class="quoted"><span class="quoted">‹heap_upds_ok <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Upd <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">r</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹heap_upds_ok <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">=</span> Upd <span class="skolem">x</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> heap_upds_okE<span class="main">)</span> 

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> step.var<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Γ</span>›</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="free">e</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span>
        <span class="keyword1"><span class="command">from</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹heap_upds_ok <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>›</span></span> <span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span>
                     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> isVal <span class="free">e</span> <span class="main">∨</span> safe_hd <span class="skolem">S'</span> <span class="main">=</span> safe_hd <span class="main">(</span>restr_stack <span class="main">(</span><span class="main">-</span> set <span class="free">r</span><span class="main">)</span> <span class="skolem">S'</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">note</span></span> this<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">using</span></span> res <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SestoftGC-perm_exI_trivial"><span class="command">lemma</span></span> perm_exI_trivial<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">π</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">::</span></span></span>perm"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftGC-upds_list_restr_stack"><span class="command">lemma</span></span> upds_list_restr_stack<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"upds_list <span class="main">(</span>restr_stack <span class="free">V</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">V</span><span class="main">)</span> <span class="main">(</span>upds_list <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> restr_stack.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftGC-heap_upd_ok_to_gc_conf"><span class="command">lemma</span></span> heap_upd_ok_to_gc_conf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ''</span><span class="main">,</span> <span class="free">e''</span><span class="main">,</span> <span class="free">S''</span><span class="main">)</span> <span class="main">⟹</span> heap_upds_ok <span class="main">(</span><span class="free">Γ''</span><span class="main">,</span> <span class="free">S''</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> heap_upds_ok.simps<span class="main">)</span>

<span class="keyword1" id="SestoftGC-delete_restrictA_conv"><span class="command">lemma</span></span> delete_restrictA_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"delete <span class="free">x</span> <span class="free">Γ</span> <span class="main">=</span> restrictA <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SestoftGC-sestoftUnGCstep"><span class="command">lemma</span></span> sestoftUnGCstep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"to_gc_conf <span class="free">r</span> <span class="free">c</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok_conf <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"r_ok <span class="free">r</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r'</span> <span class="bound">c'</span><span class="main">.</span> <span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">c'</span> <span class="main">∧</span> <span class="free">d</span> <span class="main">=</span> to_gc_conf <span class="bound">r'</span> <span class="bound">c'</span> <span class="main">∧</span> r_ok <span class="bound">r'</span> <span class="bound">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"r_ok <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> sestoftUnGCStack<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> isVal <span class="skolem">e</span> <span class="main">∨</span> safe_hd <span class="skolem">S'</span> <span class="main">=</span> safe_hd <span class="main">(</span>restr_stack <span class="main">(</span><span class="main">-</span> set <span class="free">r</span><span class="main">)</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">from</span></span> invariant_starE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">_</span>›</span></span> heap_upds_ok_invariant<span class="main">]</span>  <span class="quoted"><span class="quoted">‹heap_upds_ok <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> invariant_starE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">_</span>›</span></span> closed_invariant  <span class="quoted"><span class="quoted">‹closed <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>›</span></span> <span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> invariant_starE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">_</span>›</span></span> subset_bound_invariant <span class="quoted"><span class="quoted">‹r_ok <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>›</span></span> <span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r_ok <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span><span class="main">_</span> ›</span></span> *<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r'</span> <span class="bound">Γ''</span> <span class="bound">e''</span> <span class="bound">S''</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="bound">Γ''</span><span class="main">,</span> <span class="bound">e''</span><span class="main">,</span> <span class="bound">S''</span><span class="main">)</span> <span class="main">∧</span> <span class="free">d</span> <span class="main">=</span> to_gc_conf <span class="bound">r'</span> <span class="main">(</span><span class="bound">Γ''</span><span class="main">,</span> <span class="bound">e''</span><span class="main">,</span> <span class="bound">S''</span><span class="main">)</span> <span class="main">∧</span> r_ok <span class="bound">r'</span> <span class="main">(</span><span class="bound">Γ''</span><span class="main">,</span> <span class="bound">e''</span><span class="main">,</span> <span class="bound">S''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gc_step.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> normal
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ''</span> <span class="bound">e''</span> <span class="bound">S''</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">Γ''</span><span class="main">,</span> <span class="bound">e''</span><span class="main">,</span> <span class="bound">S''</span><span class="main">)</span> <span class="main">∧</span> <span class="free">d</span> <span class="main">=</span> to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="bound">Γ''</span><span class="main">,</span> <span class="bound">e''</span><span class="main">,</span> <span class="bound">S''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> app<span class="hidden">⇩</span><sub>1</sub>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span>  step.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">Γ</span> <span class="skolem">y</span> <span class="skolem">ea</span> <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> disj 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S'</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> var<span class="hidden">⇩</span><sub>1</sub>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span>  exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restr_delete_twist<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> var<span class="hidden">⇩</span><sub>2</sub>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> disj 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S'</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Upd_eq_restr_stackD2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>let<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">Δ''</span> <span class="skolem">Γ''</span> <span class="skolem">S''</span> <span class="skolem">e'</span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹closed <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>›</span></span> let<span class="hidden">⇩</span><sub>1</sub>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> Let <span class="skolem">Δ''</span> <span class="skolem">e'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">from</span></span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Δ''</span> <span class="main">∩</span> domA <span class="skolem">Γ''</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Δ''</span> <span class="main">∩</span> upds <span class="skolem">S''</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Δ''</span> <span class="main">∩</span> dummies <span class="skolem">S''</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ups_fv_subset<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dummies_fv_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> let<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Γ'</span> <span class="main">∪</span> upds <span class="skolem">S'</span> <span class="main">⊆</span> domA <span class="skolem">Γ''</span> <span class="main">∪</span> upds <span class="skolem">S''</span> <span class="main">∪</span> dummies <span class="skolem">S''</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Δ''</span> <span class="main">∩</span> domA <span class="skolem">Γ'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Δ''</span> <span class="main">∩</span> upds <span class="skolem">S'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹domA <span class="skolem">Δ''</span> <span class="main">∩</span> dummies <span class="skolem">S''</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> let<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Δ''</span> <span class="main">∩</span> set <span class="free">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restrictA <span class="main">(</span><span class="main">-</span> set <span class="free">r</span><span class="main">)</span> <span class="skolem">Δ''</span> <span class="main">=</span> <span class="skolem">Δ''</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> restrictA_noop<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> let<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>1-3<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span>  exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">r</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">Δ''</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">Γ'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">S'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> let<span class="hidden">⇩</span><sub>1</sub>_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹closed <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> Let <span class="skolem">Δ''</span> <span class="skolem">e'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>›</span></span> disj<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrictA_append<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> if<span class="hidden">⇩</span><sub>1</sub>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">0</span></span><span class="main"><span class="main">::</span></span>perm"</span></span></span><span class="main"><span class="main">]</span></span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> permute_zero
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> if<span class="hidden">⇩</span><sub>2</sub>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> disj
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S'</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step.if<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">True</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> step.if<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">False</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Upd_eq_restr_stackD2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step.if<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">True</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> step.if<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">False</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Upd_eq_restr_stackD2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> invariantE<span class="main">[</span><span class="operator">OF</span> subset_bound_invariant _ <span class="quoted"><span class="quoted">‹r_ok <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>dropUpd <span class="skolem">Γ''</span> <span class="skolem">e''</span> <span class="skolem">x</span> <span class="skolem">S''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="skolem">e''</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">upds</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹heap_upds_ok <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="skolem">e''</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> heap_upd_ok_to_gc_conf<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Γ''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> upds <span class="skolem">S''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> heap_upds_ok_upd<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"to_gc_conf <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">=</span> to_gc_conf <span class="main">(</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">@</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> to_gc_conf <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">(</span>to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> to_gc_conf_append<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> to_gc_conf <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="skolem">e''</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="skolem">e''</span><span class="main">,</span> <span class="skolem">S''</span><span class="main">@</span><span class="main">[</span>Dummy <span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> restrictA_noop<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ <span class="free">d</span><span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"to_gc_conf <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">=</span> <span class="free">d</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="skolem">e''</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> upds <span class="skolem">S'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">upds</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹r_ok <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r_ok <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="skolem">e''</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="comment1">(*
  next
    case (drop x Γ'' e'' S'')
    from `to_gc_conf r (Γ', e, S') = (Γ'', e'', S'')` and `x ∈ domA Γ''`
    have "x ∉ set r" by auto

    from `heap_upds_ok (Γ', S')` and  `to_gc_conf r (Γ', e, S') = (Γ'', e'', S'')`
    have "heap_upds_ok (Γ'', S'')" by (rule heap_upd_ok_to_gc_conf)
    with `x ∈ domA Γ''`
    have [simp]: "x ∉ upds S''" by (metis heap_upds_okE)


    have "to_gc_conf (x # r) (Γ', e, S') = to_gc_conf ([x]@ r) (Γ', e, S')" by simp
    also have "… = to_gc_conf [x] (to_gc_conf r (Γ', e, S'))" by (rule to_gc_conf_append)
    also have "… = to_gc_conf [x] (Γ'', e'', S'')" unfolding `to_gc_conf r (Γ', e, S') = _`..
    also have "… = (delete x Γ'', e'', S''@[Dummy x])" by (auto  simp add: delete_restrictA_conv)
    also have "… = d" using ` d= _` by simp
    finally have "to_gc_conf (x # r) (Γ', e, S') = d".
    moreover
    from `to_gc_conf r (Γ', e, S') = _` `x ∈ domA Γ''`
    have "x ∈ domA Γ'" by auto
    with `r_ok r (Γ', e, S')`
    have "r_ok (x # r) (Γ', e, S')" by auto
    moreover
    note `to_gc_conf r (Γ', e, S') = _`
    ultimately
    show ?thesis by fastforce
*)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">Γ''</span></span> <span class="skolem"><span class="skolem">e''</span></span> <span class="skolem"><span class="skolem">S''</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="skolem">e''</span><span class="main">,</span> <span class="skolem">S''</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> to_gc_conf <span class="skolem">r'</span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="skolem">e''</span><span class="main">,</span> <span class="skolem">S''</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"r_ok <span class="skolem">r'</span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="skolem">e''</span><span class="main">,</span> <span class="skolem">S''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 

  <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="skolem">e''</span><span class="main">,</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="skolem">e''</span><span class="main">,</span> <span class="skolem">S''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹r_ok <span class="skolem">r'</span> <span class="main">_</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="SestoftGC-sestoftUnGC"><span class="command">lemma</span></span> sestoftUnGC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_gc_conf <span class="free">r</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok_conf <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"r_ok <span class="free">r</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r'</span> <span class="bound">c'</span><span class="main">.</span> <span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">c'</span> <span class="main">∧</span> <span class="free">d</span> <span class="main">=</span> to_gc_conf <span class="bound">r'</span> <span class="bound">c'</span> <span class="main">∧</span> r_ok <span class="bound">r'</span> <span class="bound">c'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">d'</span> <span class="skolem">d''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span>  <span class="skolem">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">=</span> to_gc_conf <span class="skolem">r'</span> <span class="skolem">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"r_ok <span class="skolem">r'</span> <span class="skolem">c'</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> invariant_starE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">_</span>›</span></span> heap_upds_ok_invariant<span class="main">]</span>  <span class="quoted"><span class="quoted">‹heap_upds_ok <span class="main">_</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok_conf <span class="skolem">c'</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> invariant_starE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">_</span>›</span></span> closed_invariant<span class="main">]</span>  <span class="quoted"><span class="quoted">‹closed <span class="main">_</span>›</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">c'</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> step <span class="quoted"><span class="quoted">‹<span class="skolem">d'</span> <span class="main">=</span> to_gc_conf <span class="skolem">r'</span> <span class="skolem">c'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"to_gc_conf <span class="skolem">r'</span> <span class="skolem">c'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub></span> <span class="skolem">d''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹heap_upds_ok_conf <span class="skolem">c'</span>›</span></span> <span class="quoted"><span class="quoted">‹closed <span class="skolem">c'</span>›</span></span> <span class="quoted"><span class="quoted">‹r_ok <span class="skolem">r'</span> <span class="skolem">c'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r''</span> <span class="bound">c''</span><span class="main">.</span> <span class="skolem">c'</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">c''</span> <span class="main">∧</span> <span class="skolem">d''</span> <span class="main">=</span> to_gc_conf <span class="bound">r''</span> <span class="bound">c''</span> <span class="main">∧</span> r_ok <span class="bound">r''</span> <span class="bound">c''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sestoftUnGCstep<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r''</span></span> <span class="skolem"><span class="skolem">c''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">c''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d''</span> <span class="main">=</span> to_gc_conf <span class="skolem">r''</span> <span class="skolem">c''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"r_ok <span class="skolem">r''</span> <span class="skolem">c''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c'</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span>  <span class="skolem">c''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span>  <span class="skolem">c'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">c''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d''</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹r_ok <span class="skolem">r''</span> <span class="skolem">c''</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SestoftGC-dummies_unchanged_invariant"><span class="command">lemma</span></span> dummies_unchanged_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invariant step <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">.</span> dummies <span class="bound">S</span> <span class="main">=</span> <span class="free">V</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">_</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">c'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⇒</span> <span class="skolem">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="SestoftGC-sestoftUnGC'"><span class="command">lemma</span></span> sestoftUnGC'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> map Dummy <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"isVal <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fv <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">::</span>var set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ''</span><span class="main">.</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="bound">Γ''</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Γ</span> <span class="main">=</span> restrictA <span class="main">(</span><span class="main">-</span> set <span class="free">r</span><span class="main">)</span> <span class="bound">Γ''</span> <span class="main">∧</span> set <span class="free">r</span> <span class="main">⊆</span> domA <span class="bound">Γ''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> sestoftUnGC<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">Γ'</span></span> <span class="skolem"><span class="skolem">S'</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"map Dummy <span class="free">r</span> <span class="main">=</span> restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">S'</span> <span class="main">@</span> map Dummy <span class="main">(</span>rev <span class="skolem">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"r_ok <span class="skolem">r'</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> invariant_starE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>›</span></span> dummies_unchanged_invariant<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dummies <span class="skolem">S'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span>  <span class="quoted"><span class="quoted">‹map Dummy <span class="free">r</span> <span class="main">=</span> restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">S'</span> <span class="main">@</span> map Dummy <span class="main">(</span>rev <span class="skolem">r'</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">S'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> rev <span class="skolem">r'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">S'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> restr_stack.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> invariant_starE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">_</span>›</span></span> heap_upds_ok_invariant<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="free">e'</span>›</span></span> sestoftUnGCStack<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> e <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">e'</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹heap_upds_ok <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>›</span></span> <span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ''</span></span> <span class="skolem"><span class="skolem">S''</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="skolem">S''</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">=</span> to_gc_conf <span class="free">r</span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="skolem">S''</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"safe_hd <span class="skolem">S''</span> <span class="main">=</span> safe_hd <span class="main">(</span>restr_stack <span class="main">(</span><span class="main">-</span> set <span class="free">r</span><span class="main">)</span> <span class="skolem">S''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">from</span></span> this <span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">S'</span> <span class="main">=</span> <span class="main">[]</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S''</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>›</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S''</span> <span class="main">=</span> <span class="main">[]</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span>  <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> restrictA <span class="main">(</span><span class="main">-</span> set <span class="free">r</span><span class="main">)</span> <span class="skolem">Γ''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹to_gc_conf <span class="free">r</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Γ</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> invariant_starE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ''</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span> subset_bound_invariant <span class="quoted"><span class="quoted">‹r_ok <span class="skolem">r'</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="free">e'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">r</span> <span class="main">⊆</span> domA <span class="skolem">Γ''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S''</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="CardArityTransformSafe">
<div class="head">
<h1>Theory CardArityTransformSafe</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CardArityTransformSafe
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#ArityTransform">ArityTransform</a> <a href="#CardinalityAnalysisSpec">CardinalityAnalysisSpec</a> <a href="#AbstractTransform">AbstractTransform</a> <a href="#Sestoft">Sestoft</a> <a href="#SestoftGC">SestoftGC</a> <a href="#ArityEtaExpansionSafe">ArityEtaExpansionSafe</a> <a href="#ArityAnalysisStack">ArityAnalysisStack</a>  <a href="#ArityConsistent">ArityConsistent</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> CardinalityPrognosisSafe
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">sublocale</span></span> AbstractTransformBoundSubst
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> inc<span class="main">⋅</span><span class="bound">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> pred<span class="main">⋅</span><span class="bound">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">Δ</span> <span class="bound">e</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">Aheap</span> <span class="bound">Δ</span> <span class="bound">e</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"fst"</span></span>
    <span class="quoted"><span class="quoted">"snd"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"Aeta_expand"</span></span>
    <span class="quoted"><span class="quoted">"snd"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aheap_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_Aeta_expand<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ccTransform</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ccTransform</span> <span class="main">≡</span> transform"</span></span>

  <span class="keyword1" id="CardArityTransformSafe-supp_transform"><span class="command">lemma</span></span> supp_transform<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>transform <span class="free">a</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> transform.induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_assn.supp Let_supp <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> supp_map_transform<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> supp_map_transform_step<span class="main"><span class="main">]</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">interpretation</span></span> supp_bounded_transform <span class="quoted">transform</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_def supp_transform<span class="main">)</span> 

  <span class="keyword1"><span class="command">type_synonym</span></span> tstate <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>AEnv <span class="main">×</span> <span class="main">(</span>var <span class="main">⇒</span> two<span class="main">)</span> <span class="main">×</span> Arity <span class="main">×</span> Arity list <span class="main">×</span> var list<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">transform_alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Arity list <span class="main">⇒</span> stack <span class="main">⇒</span> stack"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">transform_alts</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transform_alts</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Alts <span class="main">(</span>ccTransform <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span>ccTransform <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free">transform_alts</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transform_alts</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">transform_alts</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

  <span class="keyword1" id="CardArityTransformSafe-transform_alts_Nil"><span class="command">lemma</span></span> transform_alts_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transform_alts <span class="main">[]</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span>  <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="CardArityTransformSafe-Astack_transform_alts"><span class="command">lemma</span></span> Astack_transform_alts<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Astack <span class="main">(</span>transform_alts <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> Astack <span class="free">S</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> transform_alts.induct<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="CardArityTransformSafe-fresh_star_transform_alts"><span class="command">lemma</span></span> fresh_star_transform_alts<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">♯*</span> transform_alts <span class="free">as</span> <span class="free">S</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">S</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> transform_alts.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Cons<span class="main">)</span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">a_transform</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"astate <span class="main">⇒</span> conf <span class="main">⇒</span> conf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a_transform</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>map_transform Aeta_expand <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="main">(</span>map_transform ccTransform <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">,</span> 
     ccTransform <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span>
     transform_alts <span class="free"><span class="bound"><span class="entity">as</span></span></span>  <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">restr_conf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set <span class="main">⇒</span> conf <span class="main">⇒</span> conf"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">restr_conf</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>restrictA <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> restr_stack <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_dummies_conf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var list <span class="main">⇒</span> conf <span class="main">⇒</span> conf"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_dummies_conf</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">@</span> map Dummy <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">conf_transform</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tstate <span class="main">⇒</span> conf <span class="main">⇒</span> conf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">conf_transform</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ce</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> add_dummies_conf <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="main">(</span>a_transform <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>restr_conf <span class="main">(</span><span class="main">-</span> set <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">consistent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tstate <span class="main">⇒</span> conf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    consistentI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>restr_conf <span class="main">(</span><span class="main">-</span> set <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟹</span> edom <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="main">=</span> edom <span class="free"><span class="bound"><span class="entity">ce</span></span></span>
    <span class="main">⟹</span> <span class="free">prognosis</span> <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">ce</span></span></span>
    <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> thunks <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⟹</span> many <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">ce</span></span></span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="bound">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>
    <span class="main">⟹</span> set <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⊆</span> <span class="main">(</span>domA <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">∪</span> upds <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">-</span> edom <span class="free"><span class="bound"><span class="entity">ce</span></span></span>
    <span class="main">⟹</span> <span class="free">consistent</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ce</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">inductive_cases</span></span> consistentE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">ce</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="CardArityTransformSafe-closed_consistent"><span class="command">lemma</span></span> closed_consistent<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fv <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">::</span>var set<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="main">⊥</span><span class="main">,</span> <span class="main">⊥</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">prognosis</span> <span class="main">⊥</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_prognosis<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_empty_iff_bot closed_a_consistent<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="CardArityTransformSafe-card_arity_transform_safe"><span class="command">lemma</span></span> card_arity_transform_safe<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="free">c'</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> boring_step <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok_conf <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span><span class="free">ce</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">as</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ae'</span> <span class="bound">ce'</span> <span class="bound">a'</span> <span class="bound">as'</span> <span class="bound">r'</span><span class="main">.</span> consistent <span class="main">(</span><span class="bound">ae'</span><span class="main">,</span><span class="bound">ce'</span><span class="main">,</span><span class="bound">a'</span><span class="main">,</span><span class="bound">as'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="free">c'</span> <span class="main">∧</span> conf_transform <span class="main">(</span><span class="free">ae</span><span class="main">,</span><span class="free">ce</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">as</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="free">c</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> conf_transform <span class="main">(</span><span class="bound">ae'</span><span class="main">,</span><span class="bound">ce'</span><span class="main">,</span><span class="bound">a'</span><span class="main">,</span><span class="bound">as'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> heap_upds_ok_invariant assms<span class="main">(</span>3-<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ae</span></span> <span class="quoted"><span class="free">ce</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>step_invariant_induction<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prognosis_App<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> app<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a_consistent_app<span class="hidden">⇩</span><sub>1</sub> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub></span> conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">Γ</span> <span class="skolem">y</span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="main">(</span>pred<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prognosis_subst_Lam<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> pred<span class="main">⋅</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> app<span class="hidden">⇩</span><sub>2</sub>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a_consistent_app<span class="hidden">⇩</span><sub>2</sub> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub></span> conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> pred <span class="main">⋅</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_transform<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span>  <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>thunk <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thunks_domA<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> thunk <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> below_trans<span class="main">[</span><span class="operator">OF</span> prognosis_called fun_belowD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span> <span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> edom <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> thunk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹heap_upds_ok_conf <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> upds <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  heap_upds_okE<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> edom <span class="skolem">ae</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> thunk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>
  

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ce</span> <span class="skolem">x</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>two_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> none
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> edom <span class="skolem">ce</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> once

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">ce</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⊑</span> once"</span></span>
        <span class="keyword1"><span class="command">using</span></span> once <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> fun_belowD<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> ap <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prognosis_ap<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ae</span></span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
  
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> isVal <span class="skolem">e</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> record_call <span class="skolem">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prognosis_Var_thunk<span class="main">)</span>
  
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⊑</span> once›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>record_call <span class="skolem">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> none"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_pred_none<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> none"</span></span> <span class="keyword1"><span class="command">using</span></span> fun_belowD<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="main">(</span>env_delete <span class="skolem">x</span> <span class="skolem">ae</span><span class="main">)</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prognosis_env_cong<span class="main">)</span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="skolem">S</span> <span class="main">=</span> restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> upds <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> restr_stack_cong<span class="main">)</span>
    
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="main">(</span>env_delete <span class="skolem">x</span> <span class="skolem">ae</span><span class="main">)</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> env_delete <span class="skolem">x</span> <span class="skolem">ce</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> eq
        <span class="keyword1"><span class="command">using</span></span> ** below_trans<span class="main">[</span><span class="operator">OF</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> * Cfun.monofun_cfun_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">ce</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> record_call_below_arg<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_env_deleteI<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span>env_delete <span class="skolem">x</span> <span class="skolem">ae</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> thunk <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_consistent_thunk_once <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> restr_delete<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span>env_delete <span class="skolem">x</span> <span class="skolem">ae</span><span class="main">,</span> env_delete <span class="skolem">x</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> thunk
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restr_delete_twist Compl_insert <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>below_trans <span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">from</span></span> *
      <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"Astack <span class="main">(</span>transform_alts <span class="skolem">as</span> <span class="main">(</span>restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">@</span> map Dummy <span class="main">(</span>rev <span class="skolem">r</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>Dummy <span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> a_consistent_stackD<span class="main">)</span>
      
      <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>›</span></span> once
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform ccTransform <span class="skolem">ae</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>Aeta_expand <span class="skolem">u</span> <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_map_transform<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub></span>
             add_dummies_conf <span class="skolem">r</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="main">(</span>map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform ccTransform <span class="skolem">ae</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Aeta_expand <span class="skolem">u</span> <span class="main">(</span>ccTransform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> transform_alts <span class="skolem">as</span> <span class="main">(</span>restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  map_transform_delete delete_map_transform_env_delete insert_absorb restr_delete_twist <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> restr_delete<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> add_dummies_conf <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="main">(</span>map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform ccTransform <span class="skolem">ae</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Aeta_expand <span class="skolem">u</span> <span class="main">(</span>ccTransform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span><span class="main">,</span> transform_alts <span class="skolem">as</span> <span class="main">(</span>restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> r_into_rtranclp<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> append_assoc<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dropUpd<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> add_dummies_conf <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="main">(</span>map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform ccTransform <span class="skolem">ae</span>  <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ccTransform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">,</span> transform_alts <span class="skolem">as</span> <span class="main">(</span>restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">intro</span>  normal_trans Aeta_expand_safe **<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span><span class="main">(</span>rtranclp_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> conf_transform <span class="main">(</span>env_delete <span class="skolem">x</span> <span class="skolem">ae</span><span class="main">,</span> env_delete <span class="skolem">x</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_transform_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  map_transform_delete<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  restr_delete_twist Compl_insert<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span><span class="main">(</span>back_subst<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> conf_transform <span class="main">(</span>env_delete <span class="skolem">x</span> <span class="skolem">ae</span><span class="main">,</span> env_delete <span class="skolem">x</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> many
  
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> isVal <span class="skolem">e</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> record_call <span class="skolem">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prognosis_Var_thunk<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> record_call_below_arg
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> thunk many <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="main">0</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span><span class="main">=</span><span class="main">0</span>›</span></span><span class="main">]</span> thunk <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> thunk <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_consistent_thunk_0 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> restr_delete<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> thunk <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  restr_delete_twist<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
  
      <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>›</span></span> many
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform ccTransform <span class="skolem">ae</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>transform <span class="main">0</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_map_transform<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> isVal <span class="skolem">e</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub></span> conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gc_step.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_transform_delete restr_delete_twist <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.intros  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> restr_delete<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lamvar <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> lamvar<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domI dom_map_of_conv_domA<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> lamvar <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> below_trans<span class="main">[</span><span class="operator">OF</span> prognosis_called fun_belowD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span> <span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> edom <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ce</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ce</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> lamvar
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> edom <span class="skolem">ae</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lamvar <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span>  <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>


    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prognosis_reorder<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> record_call <span class="skolem">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="skolem">e</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prognosis_Var_lam<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> record_call_below_arg<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lamvar <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_consistent_lamvar <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> restr_delete<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lamvar edom_mono<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  thunks_Cons restr_delete_twist <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹a_consistent <span class="main">_</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"Astack <span class="main">(</span>transform_alts <span class="skolem">as</span> <span class="main">(</span>restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">@</span> map Dummy <span class="main">(</span>rev <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> a_consistent_stackD<span class="main">)</span> 

    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="skolem">e</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isVal <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"isVal <span class="main">(</span>Aeta_expand <span class="skolem">u</span> <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> isVal_Aeta_expand<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up <span class="main">⋅</span> <span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ce</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform transform <span class="skolem">ae</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>Aeta_expand <span class="skolem">u</span> <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_map_transform<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span>
          add_dummies_conf <span class="skolem">r</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> Aeta_expand <span class="skolem">u</span> <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="main">(</span>map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform transform <span class="skolem">ae</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Aeta_expand <span class="skolem">u</span> <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span><span class="main">,</span> transform_alts <span class="skolem">as</span> <span class="main">(</span>restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> normal_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lambda_var<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_transform_delete <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> restr_delete<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> add_dummies_conf <span class="skolem">r</span> <span class="main">(</span><span class="main">(</span>map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform transform <span class="skolem">ae</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Aeta_expand <span class="skolem">u</span>  <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span><span class="main">,</span> transform_alts <span class="skolem">as</span> <span class="main">(</span>restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up <span class="main">⋅</span> <span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ce</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="main">(</span>transform <span class="skolem">u</span> <span class="skolem">e</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_transform_Cons map_transform_delete restr_delete_twist <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> restr_delete<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span><span class="main">(</span>subst<span class="main">[</span><span class="operator">rotated</span><span class="main">]</span><span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restr_delete_twist<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> normal_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aeta_expand_safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ** <span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span><span class="main">(</span>rtranclp_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">r</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> False

      <span class="keyword1"><span class="command">from</span></span> var<span class="hidden">⇩</span><sub>2</sub>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> restr_stack <span class="main">(</span><span class="main">-</span>set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> a_consistent_UpdD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Γ</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="main">0</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="main">0</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prognosis_Var2<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> var<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_consistent_var<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> var<span class="hidden">⇩</span><sub>2</sub> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_Cons <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub></span> conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>›</span></span> var<span class="hidden">⇩</span><sub>2</sub> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gc_step.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_transform_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ce</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> var<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> edom <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edomIff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> edom <span class="skolem">ae</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> var<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>

      <span class="keyword1"><span class="command">note</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">r</span>›</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prognosis_upd<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⊥</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prognosis_not_called<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"delete <span class="skolem">x</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">e</span><span class="main">)</span><span class="main">#</span><span class="skolem">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Γ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> var<span class="hidden">⇩</span><sub>2</sub>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_Cons  <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>below_trans a_consistent_var<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_transform_restrA<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>conf_transform.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>let<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">Δ</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ae</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ce</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">cHeap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Δ</span> <span class="main">∩</span> upds <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ups_fv_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> upds <span class="skolem">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> edom <span class="var">?ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_cHeap <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> restr_stack_simp2<span class="main">:</span> <span class="quoted"><span class="quoted">"restr_stack <span class="main">(</span>edom <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span><span class="main">)</span> <span class="skolem">S</span> <span class="main">=</span> restr_stack <span class="main">(</span>edom <span class="skolem">ae</span><span class="main">)</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> restr_stack_cong <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edom <span class="skolem">ce</span> <span class="main">=</span> edom <span class="skolem">ae</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> let<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edom <span class="skolem">ae</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> let<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_consistent_edom_subsetD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edom <span class="skolem">ae</span> <span class="main">∩</span> domA <span class="skolem">Δ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ups_fv_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹edom <span class="skolem">ae</span> <span class="main">∩</span> domA <span class="skolem">Δ</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∩</span> edom <span class="skolem">ae</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span><span class="main">)</span> 

    <span class="keyword1"><span class="command">from</span></span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restrictA <span class="main">(</span>edom <span class="skolem">ae</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="main">=</span> restrictA <span class="main">(</span>edom <span class="skolem">ae</span><span class="main">)</span> <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> restrictA_cong <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span><span class="main">)</span> 

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">r</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> let<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Δ</span> <span class="main">=</span> <span class="skolem">Δ</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> restrictA_noop<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntI UnE <span class="quoted"><span class="quoted">‹set <span class="skolem">r</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹domA <span class="skolem">Δ</span> <span class="main">∩</span> domA <span class="skolem">Γ</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹domA <span class="skolem">Δ</span> <span class="main">∩</span> upds <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> contra_subsetD empty_iff<span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="main">=</span> edom <span class="main">(</span><span class="var">?ce</span> <span class="main">⊔</span> <span class="skolem">ce</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> let<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_cHeap<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">e'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> edom <span class="var">?ce</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_cHeap <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thunks_domA<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ce</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> edomIff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"many <span class="main">⊑</span> <span class="main">(</span><span class="var">?ce</span> <span class="main">⊔</span> <span class="skolem">ce</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> let<span class="hidden">⇩</span><sub>1</sub> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up <span class="main">⋅</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">e'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Δ</span>"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> upds <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thunks_domA<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ups_fv_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> edom <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹edom <span class="skolem">ae</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹edom <span class="skolem">ce</span> <span class="main">=</span> edom <span class="skolem">ae</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ce</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edomIff<span class="main">)</span>
  
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"many <span class="main">⊑</span> <span class="main">(</span><span class="var">?ce</span> <span class="main">⊔</span> <span class="skolem">ce</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Δ</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aheap_heap3<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> let<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹edom <span class="skolem">ae</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="var">?ce</span> <span class="main">⊔</span> <span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prognosis_Let<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> let<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="var">?ce</span> <span class="main">⊔</span> <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">,</span> Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">,</span> restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> let<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> let<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹edom <span class="skolem">ae</span> <span class="main">∩</span> domA <span class="skolem">Δ</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  a_consistent_let <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> join_comm<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> restr_stack <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrictA_append<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"set <span class="skolem">r</span> <span class="main">⊆</span> <span class="main">(</span>domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span><span class="main">)</span> <span class="main">-</span> edom <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> let<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"set <span class="skolem">r</span> <span class="main">⊆</span> <span class="main">(</span>domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span><span class="main">)</span> <span class="main">-</span> edom <span class="main">(</span><span class="var">?ce</span> <span class="main">⊔</span> <span class="skolem">ce</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹domA <span class="skolem">Δ</span> <span class="main">∩</span> domA <span class="skolem">Γ</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹domA <span class="skolem">Δ</span> <span class="main">∩</span> upds <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_cHeap <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">,</span> <span class="var">?ce</span> <span class="main">⊔</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> edom <span class="var">?ae</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> edom <span class="var">?ce</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_cHeap <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_transform Aeta_expand <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>map_transform transform <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span>set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span>
         <span class="main">=</span> map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform transform <span class="skolem">ae</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span>set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_transform_cong restrictA_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edomIff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
  
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹edom <span class="skolem">ae</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹edom <span class="skolem">ce</span> <span class="main">=</span> edom <span class="skolem">ae</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="skolem">Δ</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> edom <span class="skolem">ce</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="skolem">Δ</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> edom <span class="skolem">ae</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> fresh_distinct_ups<span class="main">[</span><span class="operator">OF</span> let<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_transform Aeta_expand <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>map_transform transform <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span>
         <span class="main">=</span> map_transform Aeta_expand <span class="var">?ae</span> <span class="main">(</span>map_transform transform <span class="var">?ae</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_transform_cong restrictA_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edomIff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
            
      <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹domA <span class="skolem">Δ</span> <span class="main">∩</span> domA <span class="skolem">Γ</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>   <span class="quoted"><span class="quoted">‹domA <span class="skolem">Δ</span> <span class="main">∩</span> upds <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">Δ</span> <span class="main">♯*</span> set <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_at_base fresh_finite_set_at_base <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">r</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">Δ</span> <span class="main">♯*</span> map Dummy <span class="main">(</span>rev <span class="skolem">r</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eqvt_fresh_star_cong1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"map Dummy"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eqvt_fresh_star_cong1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"rev"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_set<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      
      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub></span> conf_transform <span class="main">(</span><span class="var">?ae</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">,</span> <span class="var">?ce</span> <span class="main">⊔</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> restr_stack_simp2 let<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>  <span class="quoted"><span class="quoted">‹edom <span class="skolem">ce</span> <span class="main">=</span> edom <span class="skolem">ae</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_transform_append restrictA_append edom_cHeap restr_stack_simp2<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> normal<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step.let<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> normal step.let<span class="hidden">⇩</span><sub>1</sub> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_list<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">Γ</span> <span class="skolem">scrut</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> if<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">as</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">,</span> Alts <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">ce</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prognosis_IfThenElse<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">a</span><span class="main">#</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">,</span> Alts <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> if<span class="hidden">⇩</span><sub>1</sub>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> a_consistent_if<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub></span> conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">a</span><span class="main">#</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">,</span> Alts <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> normal step.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">Γ</span> <span class="skolem">b</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"a_consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">,</span> Bool <span class="skolem">b</span><span class="main">,</span> Alts <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">#</span> restr_stack <span class="main">(</span><span class="main">-</span>set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span>  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">as'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="skolem">a'</span> <span class="main">#</span> <span class="skolem">as'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> a_consistent_alts_on_stack<span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="main">(</span><span class="skolem">a'</span><span class="main">#</span><span class="skolem">as'</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Bool <span class="skolem">b</span><span class="main">,</span> Alts <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> if<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="skolem">ae</span> <span class="skolem">as'</span> <span class="skolem">a'</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e1</span> <span class="keyword1">else</span> <span class="skolem">e2</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prognosis_Alts<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e1</span> <span class="keyword1">else</span> <span class="skolem">e2</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> if<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_consistent_if<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Bool <span class="skolem">b</span><span class="main">,</span> Alts <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub></span> conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e1</span> <span class="keyword1">else</span> <span class="skolem">e2</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> normal step.if<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">True</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> step.if<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">False</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consistentI consistentE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> refl <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>trans <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">c''</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> trans<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> trans<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ae'</span></span> <span class="skolem"><span class="skolem">ce'</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">as'</span></span> <span class="skolem"><span class="skolem">r'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae'</span><span class="main">,</span> <span class="skolem">ce'</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">c</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> conf_transform <span class="main">(</span><span class="skolem">ae'</span><span class="main">,</span> <span class="skolem">ce'</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> trans<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ae''</span></span> <span class="skolem"><span class="skolem">ce''</span></span> <span class="skolem"><span class="skolem">a''</span></span> <span class="skolem"><span class="skolem">as''</span></span> <span class="skolem"><span class="skolem">r''</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="skolem">ae''</span><span class="main">,</span> <span class="skolem">ce''</span><span class="main">,</span> <span class="skolem">a''</span><span class="main">,</span> <span class="skolem">as''</span><span class="main">,</span> <span class="skolem">r''</span><span class="main">)</span> <span class="skolem">c''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"conf_transform <span class="main">(</span><span class="skolem">ae'</span><span class="main">,</span> <span class="skolem">ce'</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">c'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> conf_transform <span class="main">(</span><span class="skolem">ae''</span><span class="main">,</span> <span class="skolem">ce''</span><span class="main">,</span> <span class="skolem">a''</span><span class="main">,</span> <span class="skolem">as''</span><span class="main">,</span> <span class="skolem">r''</span><span class="main">)</span> <span class="skolem">c''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> rtranclp_trans<span class="main">[</span><span class="operator">OF</span> * **<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CoCallAritySig">
<div class="head">
<h1>Theory CoCallAritySig</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CoCallAritySig
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#ArityAnalysisSig">ArityAnalysisSig</a> <a href="#CoCallAnalysisSig">CoCallAnalysisSig</a>
<span class="keyword2"><span class="keyword">begin</span></span>
                           
<span class="keyword1"><span class="command">locale</span></span> CoCallArity <span class="main">=</span> CoCallAnalysis <span class="main">+</span> ArityAnalysis

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CoCallAnalysisSpec">
<div class="head">
<h1>Theory CoCallAnalysisSpec</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CoCallAnalysisSpec
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#CoCallAritySig">CoCallAritySig</a> <a href="#ArityAnalysisSpec">ArityAnalysisSpec</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">locale</span></span> CoCallArityEdom <span class="main">=</span> CoCallArity <span class="main">+</span> EdomArityAnalysis

<span class="keyword1"><span class="command">locale</span></span> CoCallAritySafe <span class="main">=</span> CoCallArity <span class="main">+</span> CoCallAnalyisHeap <span class="main">+</span> ArityAnalysisLetSafe <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ccExp_App<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ccExp</span> <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊔</span> ccProd <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ccExp</span> <span class="main">(</span>App <span class="free">e</span> <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ccExp_Lam<span class="main">:</span> <span class="quoted"><span class="quoted">"cc_restr <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ccExp</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ccExp_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span>  <span class="free">S</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> cc_restr <span class="free">S</span> <span class="main">(</span><span class="free">ccExp</span> <span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊑</span> cc_restr <span class="free">S</span> <span class="main">(</span><span class="free">ccExp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ccExp_pap<span class="main">:</span> <span class="quoted"><span class="quoted">"isVal <span class="free">e</span> <span class="main">⟹</span> <span class="free">ccExp</span> <span class="free">e</span><span class="main">⋅</span><span class="main">0</span> <span class="main">=</span> ccSquare <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ccExp_Let<span class="main">:</span> <span class="quoted"><span class="quoted">"cc_restr <span class="main">(</span><span class="main">-</span>domA <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">ccHeap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ccExp</span> <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ccExp_IfThenElse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ccExp</span> <span class="free">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">ccExp</span> <span class="free">e1</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">ccExp</span> <span class="free">e2</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊔</span> ccProd <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="free">scrut</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="free">e1</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="free">e2</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ccExp</span> <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span>"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> ccHeap_Exp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ccExp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊑</span> <span class="free">ccHeap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ccHeap_Heap<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">Δ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">x</span><span class="main">=</span> up<span class="main">⋅</span><span class="free">a'</span> <span class="main">⟹</span> <span class="free">ccExp</span> <span class="free">e'</span><span class="main">⋅</span><span class="free">a'</span> <span class="main">⊑</span> <span class="free">ccHeap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ccHeap_Extra_Edges<span class="main">:</span>
    <span class="quoted"><span class="quoted">"map_of <span class="free">Δ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="free">a'</span> <span class="main">⟹</span> ccProd <span class="main">(</span>fv <span class="free">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="free">x</span> <span class="main">(</span><span class="free">ccHeap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> thunks <span class="free">Δ</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ccHeap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span>"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> aHeap_thunks_rec<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> nonrec <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> thunks <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> aHeap_thunks_nonrec<span class="main">:</span> <span class="quoted"><span class="quoted">"nonrec <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> thunks <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">--</span><span class="free">x</span> <span class="main">∈</span> <span class="free">ccExp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ArityAnalysisFixProps">
<div class="head">
<h1>Theory ArityAnalysisFixProps</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ArityAnalysisFixProps
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#ArityAnalysisFix">ArityAnalysisFix</a> <a href="#ArityAnalysisSpec">ArityAnalysisSpec</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> SubstArityAnalysis
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="ArityAnalysisFixProps-Afix_restr_subst"><span class="command">lemma</span></span> Afix_restr_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Afix <span class="free">Γ</span><span class="main">[</span><span class="free">x</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span><span class="main">⋅</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Afix_restr_subst'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_subst_restr<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CoCallImplSafe">
<div class="head">
<h1>Theory CoCallImplSafe</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CoCallImplSafe
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#CoCallAnalysisImpl">CoCallAnalysisImpl</a> <a href="#CoCallAnalysisSpec">CoCallAnalysisSpec</a> <a href="#ArityAnalysisFixProps">ArityAnalysisFixProps</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> CoCallImplSafe
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">sublocale</span></span> CoCallAnalysisImpl<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoCallImplSafe-ccNeighbors_Int_ccrestr"><span class="command">lemma</span></span> ccNeighbors_Int_ccrestr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ccNeighbors <span class="free">x</span> <span class="free">G</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> ccNeighbors <span class="free">x</span> <span class="main">(</span>cc_restr <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> CCexp_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span>CCexp <span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="main">(</span>CCexp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Aexp_restr_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Aexp <span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span>Aexp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span>  <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span>  <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exp_strong_induct_rec_set<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">b</span> <span class="skolem">v</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">e</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">with</span></span> App <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_insert_left fv_subst_int <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> join_comm <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> join_mono<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">with</span></span> App <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">v</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">with</span></span> Lam
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CCexp_pre_simps cc_restr_predCC  Diff_Int_distrib2 fv_subst_int env_restr_join env_delete_env_restr_swap<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> CCexp_simps<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">with</span></span> Lam
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join env_delete_env_restr_swap<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Γ</span> "</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> domA <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> bn_subst domA_not_fresh fresh_def fresh_star_at_base fresh_star_def obtain_fresh subst_is_fresh<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">note</span></span> Let<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> Let<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> nonrec <span class="main">(</span><span class="skolem">Γ</span><span class="main">[</span><span class="skolem">y</span><span class="keyword1">::h=</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonrec_subst<span class="main">)</span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="main">(</span><span class="skolem">S</span> <span class="main">∪</span> domA <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>CCfix <span class="skolem">Γ</span><span class="main">[</span><span class="skolem">y</span><span class="keyword1">::h=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="skolem">Γ</span><span class="main">[</span><span class="skolem">y</span><span class="keyword1">::h=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> thunks <span class="skolem">Γ</span><span class="main">)</span><span class="main">,</span> CCexp <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        cc_restr <span class="main">(</span><span class="skolem">S</span> <span class="main">∪</span> domA <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>CCfix <span class="skolem">Γ</span><span class="main">⋅</span>        <span class="main">(</span>Afix <span class="skolem">Γ</span><span class="main">⋅</span>        <span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span>       <span class="skolem">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> thunks <span class="skolem">Γ</span><span class="main">)</span><span class="main">,</span> CCexp <span class="skolem">e</span><span class="main">⋅</span>       <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> CCfix_restr_subst'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Let<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>5<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> CCfix_restr<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Afix_restr_subst'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Let<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>5<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Afix_restr<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Let<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Let<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Let<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> nonrec <span class="skolem">Γ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> nonrec <span class="main">(</span><span class="skolem">Γ</span><span class="main">[</span><span class="skolem">y</span><span class="keyword1">::h=</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair  <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cc_restr_eq_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 2
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Afix <span class="skolem">Γ</span><span class="main">[</span><span class="skolem">y</span><span class="keyword1">::h=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="skolem">S</span> <span class="main">∪</span> domA <span class="skolem">Γ</span><span class="main">)</span> <span class="main">=</span> Afix <span class="skolem">Γ</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="skolem">S</span> <span class="main">∪</span> domA <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Afix_restr_subst'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Let<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>5<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Afix_restr<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Let<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Let<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> nonrec <span class="skolem">Γ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> nonrec <span class="main">(</span><span class="skolem">Γ</span><span class="main">[</span><span class="skolem">y</span><span class="keyword1">::h=</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>env_restr_eq_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let_nonrec <span class="skolem">x'</span> <span class="skolem">e</span> <span class="skolem">exp</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> Let_nonrec<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> Let_nonrec<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x'</span> <span class="main">∉</span> fv <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∉</span> fv <span class="main">(</span><span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subst_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x'</span> <span class="main">∉</span> fv <span class="skolem">e</span>›</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x'</span>›</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x'</span>›</span></span>  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 1

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> cc_restr <span class="main">{</span><span class="skolem">x'</span><span class="main">}</span> <span class="main">(</span>CCexp <span class="skolem">exp</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="main">{</span><span class="skolem">x'</span><span class="main">}</span> <span class="main">(</span>CCexp <span class="skolem">exp</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let_nonrec<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span>  <span class="skolem">x'</span><span class="main">--</span><span class="skolem">x'</span><span class="main">∈</span><span class="bound">x</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span><span class="main">--</span><span class="skolem">x'</span><span class="main">∈</span>CCexp  <span class="skolem">exp</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⟷</span> <span class="skolem">x'</span><span class="main">--</span><span class="skolem">x'</span><span class="main">∈</span>CCexp <span class="skolem">exp</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> Aexp <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="bound">a</span> <span class="keyword1">f|`</span> <span class="skolem">S</span> <span class="main">=</span> Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="bound">a</span> <span class="keyword1">f|`</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let_nonrec<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> fup<span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">⋅</span><span class="bound">a</span> <span class="keyword1">f|`</span> <span class="skolem">S</span> <span class="main">=</span> fup<span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="bound">a</span> <span class="keyword1">f|`</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Aexp  <span class="skolem">exp</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span> <span class="keyword1">f|`</span> <span class="skolem">S</span> <span class="main">=</span> Aexp <span class="skolem">exp</span><span class="main">⋅</span><span class="skolem">a</span> <span class="keyword1">f|`</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let_nonrec<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Aexp <span class="skolem">exp</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span> <span class="keyword1">f|`</span> <span class="main">{</span><span class="skolem">x'</span><span class="main">}</span> <span class="main">=</span> Aexp <span class="skolem">exp</span><span class="main">⋅</span><span class="skolem">a</span> <span class="keyword1">f|`</span> <span class="main">{</span><span class="skolem">x'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let_nonrec<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fun_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">x'</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Aexp <span class="skolem">exp</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="main">(</span>Aexp <span class="skolem">exp</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> cc_restr <span class="skolem">S</span> <span class="main">(</span>CCexp <span class="skolem">exp</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="skolem">S</span> <span class="main">(</span>CCexp <span class="skolem">exp</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let_nonrec<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> cc_restr <span class="skolem">S</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="skolem">S</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let_nonrec<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> cc_restr <span class="skolem">S</span> <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="skolem">S</span> <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fup_ccExp_restr_subst'<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∩</span> <span class="skolem">S</span> <span class="main">=</span> fv <span class="skolem">e</span> <span class="main">∩</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subst_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"ccNeighbors <span class="skolem">x'</span> <span class="main">(</span>CCexp <span class="skolem">exp</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∩</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x'</span><span class="main">}</span> <span class="main">∩</span> <span class="skolem">S</span> <span class="main">=</span> ccNeighbors <span class="skolem">x'</span> <span class="main">(</span>CCexp <span class="skolem">exp</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>  <span class="main">∩</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x'</span><span class="main">}</span> <span class="main">∩</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Int_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> ccNeighbors_Int_ccrestr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Let_nonrec<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"ccNeighbors <span class="skolem">x'</span> <span class="main">(</span>CCexp <span class="skolem">exp</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">S</span> <span class="main">=</span> ccNeighbors <span class="skolem">x'</span> <span class="main">(</span>CCexp <span class="skolem">exp</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> ccNeighbors_Int_ccrestr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Let_nonrec<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="skolem">S</span> <span class="main">(</span>CCexp <span class="main">(</span><span class="keyword1">let</span> <span class="skolem">x'</span> <span class="keyword1">be</span> <span class="skolem">e</span> <span class="keyword1">in</span> <span class="skolem">exp</span> <span class="main">)</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="skolem">S</span> <span class="main">(</span>CCexp <span class="main">(</span><span class="keyword1">let</span> <span class="skolem">x'</span> <span class="keyword1">be</span> <span class="skolem">e</span> <span class="keyword1">in</span> <span class="skolem">exp</span> <span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_let_be<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> CCexp_simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> cc_restr_cc_delete_twist<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  Diff_eq ccBind_eq ABind_nonrec_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Aexp <span class="main">(</span><span class="keyword1">let</span> <span class="skolem">x'</span> <span class="keyword1">be</span> <span class="skolem">e</span> <span class="keyword1">in</span> <span class="skolem">exp</span> <span class="main">)</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span> <span class="keyword1">f|`</span> <span class="skolem">S</span> <span class="main">=</span> Aexp <span class="main">(</span><span class="keyword1">let</span> <span class="skolem">x'</span> <span class="keyword1">be</span> <span class="skolem">e</span> <span class="keyword1">in</span> <span class="skolem">exp</span> <span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span> <span class="keyword1">f|`</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join env_delete_env_restr_swap<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ABind_nonrec_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfThenElse <span class="skolem">scrut</span> <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 2
    <span class="keyword1"><span class="command">from</span></span> IfThenElse
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="skolem">S</span> <span class="main">(</span>CCexp <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="skolem">S</span> <span class="main">(</span>CCexp <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> edom_env env_restr_empty env_restr_empty_iff <span class="quasi_keyword">simp</span>  <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_env<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> IfThenElse<span class="main">(</span>2<span class="main">,</span>4<span class="main">,</span>6<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Aexp <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span> <span class="keyword1">f|`</span> <span class="skolem">S</span> <span class="main">=</span> Aexp <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span> <span class="keyword1">f|`</span> <span class="skolem">S</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
   
<span class="keyword1"><span class="command">sublocale</span></span> ArityAnalysisSafe <span class="quoted">Aexp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Aexp_restr_subst<span class="main">)</span>


<span class="keyword1"><span class="command">sublocale</span></span> ArityAnalysisLetSafe <span class="quoted">Aexp</span> <span class="quoted">Aheap</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>Aheap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nonrec <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aheap_nonrec_simp <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_esing_subset<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonrecE<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Γ</span> <span class="main">::</span> <span class="quoted">heap</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted">exp</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Γ</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> domA <span class="skolem">Γ</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> Aexp_restr_subst<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> Aexp <span class="skolem">e</span><span class="main">[</span><span class="skolem">x</span><span class="main">::=</span><span class="skolem">y</span><span class="main">]</span><span class="main">⋅</span><span class="bound">a</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span> <span class="main">=</span> Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="bound">a</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Aheap <span class="skolem">Γ</span><span class="main">[</span><span class="skolem">x</span><span class="keyword1">::h=</span><span class="skolem">y</span><span class="main">]</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">x</span><span class="main">::=</span><span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> Aheap <span class="skolem">Γ</span> <span class="skolem">e</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nonrec <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> False

    <span class="keyword1"><span class="command">from</span></span> assms
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">Γ</span> <span class="main">♯*</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">Γ</span> <span class="main">♯*</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_at_base image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> nonrec <span class="main">(</span><span class="skolem">Γ</span><span class="main">[</span><span class="skolem">x</span><span class="keyword1">::h=</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonrec_subst<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Afix_restr_subst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms subset_refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Afix_restr<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  subset_refl<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> **<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    
    <span class="keyword1"><span class="command">from</span></span> assms
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">Γ</span> <span class="main">♯*</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">Γ</span> <span class="main">♯*</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_at_base image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> True
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"nonrec <span class="main">(</span><span class="skolem">Γ</span><span class="main">[</span><span class="skolem">x</span><span class="keyword1">::h=</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonrec_subst<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x'</span><span class="main">,</span><span class="skolem">e'</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∉</span> fv <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nonrecE<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∉</span> fv <span class="main">(</span><span class="skolem">e'</span><span class="main">[</span><span class="skolem">x</span><span class="main">::=</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonrec_def<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> fun_cong<span class="main">[</span><span class="operator">OF</span> **<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">x'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">[</span><span class="skolem">x</span><span class="main">::=</span><span class="skolem">y</span><span class="main">]</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> CCexp_subst<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span>  cc_restr <span class="main">{</span><span class="skolem">x'</span><span class="main">}</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">[</span><span class="skolem">x</span><span class="main">::=</span><span class="skolem">y</span><span class="main">]</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="main">{</span><span class="skolem">x'</span><span class="main">}</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span>  <span class="skolem">x'</span><span class="main">--</span><span class="skolem">x'</span><span class="main">∈</span><span class="bound">x</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="skolem">x'</span><span class="main">--</span><span class="skolem">x'</span><span class="main">∈</span><span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">[</span><span class="skolem">x</span><span class="main">::=</span><span class="skolem">y</span><span class="main">]</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">x'</span><span class="main">--</span><span class="skolem">x'</span><span class="main">∈</span><span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aheap_nonrec_simp ABind_nonrec_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ABinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="main">(</span>Aheap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊔</span> Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊑</span> Aheap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> Aexp <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nonrec <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aheap_def join_below_iff env_restr_join2 Compl_partition <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>  below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Afix_above_arg<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">e'</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fv <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nonrecE<span class="main">)</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∉</span> edom <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e'</span><span class="main">)</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fup_Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e'</span><span class="main">)</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edomIff<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_below_split<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_belowI2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  Aheap_nonrec_simp  join_below_iff env_restr_join env_delete_restr<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ABind_nonrec_above_arg<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_refl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ccHeap_nonrec</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ccHeap_nonrec</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">exp</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> n<span class="main">.</span> CCfix_nonrec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="free"><span class="bound"><span class="entity">exp</span></span></span><span class="main">⋅</span><span class="bound">n</span><span class="main">,</span> CCexp <span class="free"><span class="bound"><span class="entity">exp</span></span></span><span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallImplSafe-ccHeap_nonrec_eq"><span class="command">lemma</span></span> ccHeap_nonrec_eq<span class="main">:</span>
   <span class="quoted"><span class="quoted">"ccHeap_nonrec <span class="free">x</span> <span class="free">e</span> <span class="free">exp</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span> CCfix_nonrec <span class="free">x</span> <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="free">exp</span><span class="main">⋅</span><span class="free">n</span><span class="main">,</span> CCexp <span class="free">exp</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ccHeap_nonrec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> beta_cfun<span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ccHeap_rec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> exp <span class="main">⇒</span> Arity <span class="main">→</span> CoCalls"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ccHeap_rec</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> CCfix <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⋅</span><span class="main">(</span>Afix <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> CCexp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallImplSafe-ccHeap_rec_eq"><span class="command">lemma</span></span> ccHeap_rec_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccHeap_rec <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> CCfix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="free">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> CCexp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ccHeap_rec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ccHeap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> exp <span class="main">⇒</span> Arity <span class="main">→</span> CoCalls"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ccHeap</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> nonrec <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">then</span> case_prod ccHeap_nonrec <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="keyword1">else</span> ccHeap_rec <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallImplSafe-ccHeap_simp1"><span class="command">lemma</span></span> ccHeap_simp1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> nonrec <span class="free">Γ</span> <span class="main">⟹</span> ccHeap <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> CCfix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="free">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> CCexp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccHeap_def ccHeap_rec_eq<span class="main">)</span>

<span class="keyword1" id="CoCallImplSafe-ccHeap_simp2"><span class="command">lemma</span></span> ccHeap_simp2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fv <span class="free">e</span> <span class="main">⟹</span> ccHeap <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">]</span> <span class="free">exp</span><span class="main">⋅</span><span class="free">n</span> <span class="main">=</span> CCfix_nonrec <span class="free">x</span> <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="free">exp</span><span class="main">⋅</span><span class="free">n</span><span class="main">,</span> CCexp <span class="free">exp</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccHeap_def ccHeap_nonrec_eq nonrec_def<span class="main">)</span>


<span class="keyword1"><span class="command">sublocale</span></span> CoCallAritySafe <span class="quoted">CCexp</span> <span class="quoted">Aexp</span> <span class="quoted">ccHeap</span> <span class="quoted">Aheap</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">a</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊔</span> ccProd <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span>fv <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> CCexp <span class="main">(</span>App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">e</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> CCexp <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CCexp_pre_simps predCC_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_cc_restr<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> CCexp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">S</span> <span class="skolem">e</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="skolem">S</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊑</span> cc_restr <span class="skolem">S</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_imp_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> CCexp_subst<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isVal <span class="skolem">e</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="main">0</span> <span class="main">=</span> ccSquare <span class="main">(</span>fv <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> isVal.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> predCC_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="main">(</span><span class="main">-</span> domA <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>ccHeap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊑</span> CCexp <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nonrec <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="main">(</span><span class="main">-</span> domA <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>ccHeap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊑</span> CCexp <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccHeap_simp1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> False<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> cc_restr_join<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccHeap_simp2 Diff_eq <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonrecE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> cc_restr_join<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Δ</span> <span class="main">::</span> <span class="quoted">heap</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">e</span> <span class="skolem">a</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊑</span> ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nonrec <span class="skolem">Δ</span>"</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccHeap_simp1 ccHeap_simp2 arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> CCfix_unroll<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊑)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span> <span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonrecE<span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">e'</span> <span class="skolem">a'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">Δ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e'</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domI dom_map_of_conv_domA<span class="main">)</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Aheap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"CCexp <span class="skolem">e'</span><span class="main">⋅</span><span class="skolem">a'</span> <span class="main">⊑</span> ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nonrec <span class="skolem">Δ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>Aheap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>›</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Afix <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aheap_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"CCexp <span class="skolem">e'</span><span class="main">⋅</span><span class="skolem">a'</span> <span class="main">⊑</span> ccBind <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> CCfix <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBind_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_CCexp<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccBind <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> CCfix <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span>  ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Δ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e'</span>›</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccHeap_simp1 ccHeap_rec_eq ccBindsExtra_simp  ccBinds_eq  arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> CCfix_unroll<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊑)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span> <span class="main"><span class="main">]</span></span>
                  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"CCexp <span class="skolem">e'</span><span class="main">⋅</span><span class="skolem">a'</span> <span class="main">⊑</span> ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Δ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e'</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">e'</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fv <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonrecE <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">--</span><span class="skolem">x</span><span class="main">∉</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">∨</span> isVal <span class="skolem">e'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>Aheap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>CoCallArityAnalysis.Aexp cCCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aheap_nonrec_simp ABind_nonrec_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"CCexp <span class="skolem">e'</span><span class="main">⋅</span><span class="skolem">a'</span> <span class="main">⊑</span> ccSquare <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> below_ccSquare
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccField_CCexp<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccHeap_simp2 ccBind_eq Aheap_nonrec_simp ABind_nonrec_eq below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> below_ccSquare <span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>Aheap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aheap_nonrec_simp ABind_nonrec_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccHeap_simp2 ccBind_eq Aheap_nonrec_simp ABind_nonrec_eq <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> below_ccSquare <span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">⊑</span> ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nonrec <span class="skolem">Δ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> False

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">⊑</span> ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccProd_mono2<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">x</span><span class="main">↦</span><span class="bound">e'</span><span class="main">∈</span>map_of <span class="skolem">Δ</span><span class="main">.</span> ccProd <span class="main">(</span>fv <span class="bound">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="bound">x</span> <span class="main">(</span>ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Δ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_lubmapI<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> ccBindsExtra <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span>Afix <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBindsExtra_simp  below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccHeap_simp1  arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> CCfix_unroll<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊑)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Δ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e'</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">e'</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fv <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonrecE <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccBind <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">,</span> CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBind_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_cc_restr<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_fup_CCexp<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"isVal <span class="skolem">e'</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">--</span><span class="skolem">x</span><span class="main">∈</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">=</span>
        ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccBind <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="main">(</span>Aheap_nonrec <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">,</span> CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">,</span> CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
        ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> isVal <span class="skolem">e'</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
        ccNeighbors <span class="skolem">x</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccHeap_simp2 <span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccBind  <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="main">(</span>Aheap_nonrec <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">,</span> CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">,</span> CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBind_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_cc_restr<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_fup_CCexp<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> isVal <span class="skolem">e'</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccNeighbors_ccProd<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> fv <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccNeighbors_ccProd<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> thunks <span class="skolem">Δ</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> fv <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">⊑</span> ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> fv <span class="skolem">e'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccProd_mono2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Δ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>Aheap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>›</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccHeap_simp2  below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">=</span> ccSquare <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccSquare_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Δ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>Aheap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>›</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccHeap_simp2  ccBind_eq below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> join_self
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">=</span>
        ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccBind <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="main">(</span>Aheap_nonrec <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">,</span> CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">,</span> CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
        ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> isVal <span class="skolem">e'</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
        ccNeighbors <span class="skolem">x</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccHeap_simp2 <span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccBind  <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="main">(</span>Aheap_nonrec <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">,</span> CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">,</span> CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBind_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_cc_restr<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccField_fup_CCexp<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> isVal <span class="skolem">e'</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccNeighbors_ccProd<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span><span class="quoted"><span class="quoted">"ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>  <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> thunks <span class="skolem">Δ</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>   <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> thunks <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> thunks <span class="skolem">Δ</span> <span class="main">)</span> <span class="main">⊑</span> ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span>CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>  <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> thunks <span class="skolem">Δ</span> <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccProd_mono2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> ccHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Δ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>Aheap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>›</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccHeap_simp2  thunks_Cons below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> nonrec <span class="skolem">Γ</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thunks_domA<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> edom <span class="main">(</span>Aheap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Afix <span class="skolem">Γ</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Afix_unroll<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Aheap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"nonrec <span class="skolem">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x'</span><span class="main">,</span><span class="skolem">e'</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∉</span> fv <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nonrecE<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> isVal <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">--</span><span class="skolem">x</span> <span class="main">∈</span> CCexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span><span class="main">--</span><span class="skolem">x'</span><span class="main">∈</span> CCexp  <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Afix <span class="skolem">Γ</span><span class="main">⋅</span><span class="main">(</span>Aexp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="keyword1">f|`</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Afix_unroll<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Aheap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Aheap_nonrec_simp ABind_nonrec_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">scrut</span> <span class="skolem">e1</span> <span class="skolem">a</span> <span class="skolem">e2</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"CCexp <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊔</span> <span class="main">(</span>CCexp <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> CCexp <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊔</span> ccProd <span class="main">(</span>edom <span class="main">(</span>Aexp <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>edom <span class="main">(</span>Aexp <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span>Aexp <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> CCexp <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="List-Interleavings">
<div class="head">
<h1>Theory List-Interleavings</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"List-Interleavings"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">interleave'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">interleave'</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interleave'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">⟹</span><span class="free">interleave'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interleave'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">⟹</span><span class="free">interleave'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interleave</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⊗</span>"</span> 64<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main"><span class="free">⊗</span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> Collect <span class="main">(</span>interleave' <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1" id="List-Interleavings-elim_interleave'"><span class="command">lemma</span></span> elim_interleave'<span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interleave' <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟷</span> <span class="free">zs</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">⊗</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> interleave_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> interleave_intros<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span> <span class="main">=</span> interleave'.intros<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> interleave_intros<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> interleave_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> interleave<span class="main">,</span> <span class="operator">case_names</span> Nil left right<span class="main">]</span> <span class="main">=</span> interleave'.induct<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> interleave_cases<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">cases</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> interleave<span class="main">]</span> <span class="main">=</span> interleave'.cases<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> interleave_simps <span class="main">=</span> interleave'.simps<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>


<span class="keyword1"><span class="command">inductive_cases</span></span> interleave_ConsE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ys</span> <span class="main">⊗</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> interleave_ConsConsE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> <span class="free">y</span><span class="main">#</span><span class="free">ys</span> <span class="main">⊗</span> <span class="free">z</span><span class="main">#</span><span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> interleave_ConsE2<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> <span class="free">x</span><span class="main">#</span><span class="free">ys</span> <span class="main">⊗</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> interleave_ConsE3<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> <span class="free">ys</span> <span class="main">⊗</span> <span class="free">x</span><span class="main">#</span><span class="free">zs</span>"</span></span>

<span class="keyword1" id="List-Interleavings-interleave_comm"><span class="command">lemma</span></span> interleave_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> <span class="free">ys</span> <span class="main">⊗</span> <span class="free">zs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">zs</span> <span class="main">⊗</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleave_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros<span class="main">)</span>

<span class="keyword1" id="List-Interleavings-interleave_Nil1"><span class="command">lemma</span></span> interleave_Nil1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊗</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">{</span><span class="free">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> interleave_cases<span class="main">)</span>

<span class="keyword1" id="List-Interleavings-interleave_Nil2"><span class="command">lemma</span></span> interleave_Nil2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">⊗</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{</span><span class="free">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> interleave_cases<span class="main">)</span>

<span class="keyword1" id="List-Interleavings-interleave_nil_simp"><span class="command">lemma</span></span> interleave_nil_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">⊗</span> <span class="free">ys</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> interleave_cases<span class="main">)</span>

<span class="keyword1" id="List-Interleavings-append_interleave"><span class="command">lemma</span></span> append_interleave<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">⊗</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros<span class="main">)</span>

<span class="keyword1" id="List-Interleavings-interleave_assoc1"><span class="command">lemma</span></span> interleave_assoc1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">⊗</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">a</span> <span class="main">⊗</span> <span class="free">zs</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">ys</span> <span class="main">⊗</span> <span class="free">zs</span> <span class="main">∧</span>  <span class="free">b</span> <span class="main">∈</span> <span class="free">xs</span>  <span class="main">⊗</span> <span class="bound">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span>  <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> interleave_ConsE <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> interleave_ConsE  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros<span class="main">)</span>

<span class="keyword1" id="List-Interleavings-interleave_assoc2"><span class="command">lemma</span></span> interleave_assoc2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">ys</span> <span class="main">⊗</span> <span class="free">zs</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">⊗</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">⊗</span> <span class="free">ys</span> <span class="main">∧</span>  <span class="free">b</span> <span class="main">∈</span> <span class="bound">c</span> <span class="main">⊗</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span>  <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> interleave_ConsE <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> interleave_ConsE  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros<span class="main">)</span>

<span class="keyword1" id="List-Interleavings-interleave_set"><span class="command">lemma</span></span> interleave_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">⊗</span> <span class="free">ys</span> <span class="main">⟹</span> set <span class="free">zs</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>interleave_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="List-Interleavings-interleave_tl"><span class="command">lemma</span></span> interleave_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> <span class="free">ys</span> <span class="main">⊗</span> <span class="free">zs</span> <span class="main">⟹</span> tl <span class="free">xs</span> <span class="main">∈</span> tl <span class="free">ys</span> <span class="main">⊗</span> <span class="free">zs</span> <span class="main">∨</span> tl <span class="free">xs</span> <span class="main">∈</span> <span class="free">ys</span> <span class="main">⊗</span> <span class="main">(</span>tl <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>interleave_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="List-Interleavings-interleave_butlast"><span class="command">lemma</span></span> interleave_butlast<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> <span class="free">ys</span> <span class="main">⊗</span> <span class="free">zs</span> <span class="main">⟹</span> butlast <span class="free">xs</span> <span class="main">∈</span> butlast <span class="free">ys</span> <span class="main">⊗</span> <span class="free">zs</span> <span class="main">∨</span> butlast <span class="free">xs</span> <span class="main">∈</span> <span class="free">ys</span> <span class="main">⊗</span> <span class="main">(</span>butlast <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>interleave_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros<span class="main">)</span>

<span class="keyword1" id="List-Interleavings-interleave_take"><span class="command">lemma</span></span> interleave_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">⊗</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">n<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">n<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> <span class="bound">n<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="bound">n<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span>  take <span class="free">n</span> <span class="free">zs</span> <span class="main">∈</span> take <span class="bound">n<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">xs</span> <span class="main">⊗</span> take <span class="bound">n<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>interleave_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">nat</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Suc <span class="improper">n<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">nat</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Suc <span class="improper">n<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="List-Interleavings-filter_interleave"><span class="command">lemma</span></span> filter_interleave<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> <span class="free">ys</span> <span class="main">⊗</span> <span class="free">zs</span> <span class="main">⟹</span> filter <span class="free">P</span> <span class="free">xs</span> <span class="main">∈</span> filter <span class="free">P</span> <span class="free">ys</span> <span class="main">⊗</span> filter <span class="free">P</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleave_induct<span class="main">)</span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros<span class="main">)</span>

<span class="keyword1" id="List-Interleavings-interleave_filtered"><span class="command">lemma</span></span> interleave_filtered<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> interleave <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>  <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x'</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros<span class="main">)</span>


<span class="keyword1"><span class="command">function</span></span> <span class="entity">foo</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">foo</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">foo</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">foo</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">foo</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> undefined <span class="main">(</span><span class="free">foo</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">foo</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>
<span class="keyword1"><span class="command">lemmas</span></span> list_induct2'' <span class="main">=</span> foo.induct<span class="main">[</span><span class="operator">case_names</span> NilNil ConsNil NilCons ConsCons<span class="main">]</span>

<span class="keyword1" id="List-Interleavings-interleave_filter"><span class="command">lemma</span></span> interleave_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> filter <span class="free">P</span> <span class="free">ys</span> <span class="main">⊗</span> filter <span class="free">P</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">xs'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">∈</span> <span class="free">ys</span> <span class="main">⊗</span> <span class="free">zs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> filter <span class="free">P</span> <span class="free">xs'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2''<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> NilNil
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ConsNil <span class="skolem">ys</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>NilCons <span class="skolem">zs</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ConsCons <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">z</span> <span class="skolem">zs</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> ConsCons.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter <span class="free">P</span> <span class="skolem">ys</span> <span class="main">⊗</span> filter <span class="free">P</span> <span class="main">(</span><span class="skolem">z</span><span class="main">#</span><span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> ConsCons.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> <span class="skolem">ys</span> <span class="main">⊗</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> filter <span class="free">P</span> <span class="skolem">xs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">#</span><span class="skolem">xs'</span> <span class="main">∈</span> <span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">z</span><span class="main">#</span><span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> filter <span class="free">P</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">xs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">z</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> ConsCons.prems<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter <span class="free">P</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span> <span class="main">⊗</span> filter <span class="free">P</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> ConsCons.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> <span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> filter <span class="free">P</span> <span class="skolem">xs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">#</span><span class="skolem">xs'</span> <span class="main">∈</span> <span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">z</span><span class="main">#</span><span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> filter <span class="free">P</span> <span class="main">(</span><span class="skolem">z</span><span class="main">#</span><span class="skolem">xs'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> ConsCons.prems<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">z</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">y</span> <span class="main">#</span> filter <span class="free">P</span> <span class="skolem">ys</span>  <span class="main">⊗</span> <span class="skolem">z</span> <span class="main">#</span> filter <span class="free">P</span> <span class="skolem">zs</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> interleave_ConsConsE<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> interleave <span class="main">(</span>filter <span class="free">P</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> filter <span class="free">P</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> filter <span class="free">P</span> <span class="skolem">ys</span>  <span class="main">⊗</span> filter <span class="free">P</span> <span class="main">(</span><span class="skolem">z</span><span class="main">#</span><span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> ConsCons.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs''</span> <span class="main">∈</span> <span class="skolem">ys</span> <span class="main">⊗</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">=</span> filter <span class="free">P</span> <span class="skolem">xs''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">#</span><span class="skolem">xs''</span> <span class="main">∈</span> <span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span>  <span class="main">⊗</span> <span class="skolem">z</span><span class="main">#</span><span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">#</span><span class="skolem">xs'</span> <span class="main">=</span> filter <span class="free">P</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">xs''</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">xs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> <span class="skolem">y</span> <span class="main">#</span> filter <span class="free">P</span> <span class="skolem">ys</span>  <span class="main">⊗</span> filter <span class="free">P</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> filter <span class="free">P</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span> <span class="main">⊗</span> filter <span class="free">P</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> ConsCons.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs''</span> <span class="main">∈</span> <span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">=</span> filter <span class="free">P</span> <span class="skolem">xs''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">#</span><span class="skolem">xs''</span> <span class="main">∈</span> <span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">z</span><span class="main">#</span><span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">#</span><span class="skolem">xs'</span> <span class="main">=</span> filter <span class="free">P</span> <span class="main">(</span><span class="skolem">z</span><span class="main">#</span><span class="skolem">xs''</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TTree">
<div class="head">
<h1>Theory TTree</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TTree
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a> <a href="#ConstOn">ConstOn</a> <span class="quoted">"<a href="List-Interleavings.html">List-Interleavings</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Prefix-closed sets of lists›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">downset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">downset</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">⟶</span> take <span class="bound">n</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TTree-downsetE"><span class="command">lemma</span></span> downsetE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"downset <span class="free">xss</span>  <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">xss</span> <span class="main">⟹</span> butlast <span class="free">xs</span> <span class="main">∈</span> <span class="free">xss</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> downset_def butlast_conv_take<span class="main">)</span>

<span class="keyword1" id="TTree-downset_appendE"><span class="command">lemma</span></span> downset_appendE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"downset <span class="free">xss</span> <span class="main">⟹</span> <span class="free">xs</span><span class="main">@</span><span class="free">ys</span> <span class="main">∈</span> <span class="free">xss</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">xss</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> downset_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj<span class="main">)</span>

<span class="keyword1" id="TTree-downset_hdE"><span class="command">lemma</span></span> downset_hdE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"downset <span class="free">xss</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">xss</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">[</span>hd <span class="free">xs</span><span class="main">]</span> <span class="main">∈</span> <span class="free">xss</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> downset_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> take_0 take_Suc<span class="main">)</span>


<span class="keyword1" id="TTree-downsetI"><span class="command">lemma</span></span> downsetI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">xss</span> <span class="main">⟹</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> butlast <span class="bound">xs</span> <span class="main">∈</span> <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"downset <span class="free">xss</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> downset_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> impI allI <span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> butlast<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">xss</span> <span class="main">⟹</span> butlast <span class="bound">xs</span> <span class="main">∈</span> <span class="free">xss</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> butlast.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">xss</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">n</span> <span class="skolem">xs</span> <span class="main">∈</span> <span class="free">xss</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> length <span class="skolem">xs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inc_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">xss</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">n'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> butlast<span class="main">[</span><span class="operator">OF</span> step.IH<span class="main">]</span> step<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_take<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>      
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">xss</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"downset <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-downset_mapI"><span class="command">lemma</span></span> downset_mapI<span class="main">:</span> <span class="quoted"><span class="quoted">"downset <span class="free">xss</span> <span class="main">⟹</span> downset <span class="main">(</span>map <span class="free">f</span> <span class="main">`</span> <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_butlast<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="TTree-downset_filter"><span class="command">lemma</span></span> downset_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"downset <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"downset <span class="main">(</span>filter <span class="free">P</span> <span class="main">`</span> <span class="free">xss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> imageE<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">xss</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span>filter <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> filter <span class="free">P</span> <span class="main">`</span> <span class="free">xss</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> snoc
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹downset <span class="free">xss</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> snoc.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TTree-downset_set_subset"><span class="command">lemma</span></span> downset_set_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"downset <span class="main">(</span><span class="main">{</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">S</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_butlastD<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The type of infinite labeled trees›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> ttree <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">xss</span> <span class="main">::</span> <span class="tfree">'a</span> list set <span class="main">.</span> <span class="main">[]</span> <span class="main">∈</span> <span class="bound">xss</span> <span class="main">∧</span> downset <span class="bound">xss</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_ttree

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Deconstructors›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> possible <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">xss</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">x</span><span class="main">#</span><span class="bound">xs</span> <span class="main">∈</span> <span class="bound">xss</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> nxt <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> ttree"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">xss</span> <span class="bound">x</span><span class="main">.</span> insert <span class="main">[]</span> <span class="main">{</span><span class="bound">xs</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">x</span><span class="main">#</span><span class="bound">xs</span> <span class="main">∈</span> <span class="bound">xss</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> downset_def take_Suc_Cons<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> take_Suc_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Trees as set of paths›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> paths <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="TTree-paths_inj"><span class="command">lemma</span></span> paths_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="free">t</span> <span class="main">=</span> paths <span class="free">t'</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-paths_injs_simps"><span class="command">lemma</span></span> paths_injs_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="free">t</span> <span class="main">=</span> paths <span class="free">t'</span> <span class="main">⟷</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-paths_Nil"><span class="command">lemma</span></span> paths_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="TTree-paths_not_empty"><span class="command">lemma</span></span> paths_not_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>paths <span class="free">t</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">⟷</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-paths_Cons_nxt"><span class="command">lemma</span></span> paths_Cons_nxt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible <span class="free">t</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-paths_Cons_nxt_iff"><span class="command">lemma</span></span> paths_Cons_nxt_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible <span class="free">t</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-possible_mono"><span class="command">lemma</span></span> possible_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"paths <span class="free">t</span> <span class="main">⊆</span> paths <span class="free">t'</span> <span class="main">⟹</span> possible <span class="free">t</span> <span class="free">x</span> <span class="main">⟹</span> possible <span class="free">t'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-nxt_mono"><span class="command">lemma</span></span> nxt_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"paths <span class="free">t</span> <span class="main">⊆</span> paths <span class="free">t'</span> <span class="main">⟹</span> paths <span class="main">(</span>nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> paths <span class="main">(</span>nxt <span class="free">t'</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-ttree_eqI"><span class="command">lemma</span></span> ttree_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">x</span><span class="main">#</span><span class="bound">xs</span> <span class="main">∈</span> paths <span class="free">t</span> <span class="main">⟷</span> <span class="bound">x</span><span class="main">#</span><span class="bound">xs</span> <span class="main">∈</span> paths <span class="free">t'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> paths_inj<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-paths_nxt"><span class="command">lemma</span></span> paths_nxt<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span>"</span></span>
 <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">#</span><span class="free">xs</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span>  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-Cons_path"><span class="command">lemma</span></span> Cons_path<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="free">t</span> <span class="main">⟷</span> possible <span class="free">t</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-Cons_pathI"><span class="command">lemma</span></span> Cons_pathI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"possible <span class="free">t</span> <span class="free">x</span> <span class="main">⟷</span> possible <span class="free">t'</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"possible <span class="free">t</span> <span class="free">x</span> <span class="main">⟹</span> possible <span class="free">t'</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="free">t'</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="free">t</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_path<span class="main">)</span>

<span class="keyword1" id="TTree-paths_nxt_eq"><span class="command">lemma</span></span> paths_nxt_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free">x</span><span class="main">#</span><span class="free">xs</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-ttree_coinduct"><span class="command">lemma</span></span> ttree_coinduct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">⟹</span> possible <span class="bound">t</span> <span class="bound">x</span> <span class="main">⟷</span> possible <span class="bound">t'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">⟹</span> possible <span class="bound">t</span> <span class="bound">x</span> <span class="main">⟹</span> possible <span class="bound">t'</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>nxt <span class="bound">t</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>nxt <span class="bound">t'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> paths_inj<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="free">t</span> <span class="main">⟷</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons_pathI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">t</span> <span class="skolem">t'</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⟷</span> possible <span class="skolem">t'</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t'</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">t</span> <span class="skolem">t'</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>nxt <span class="skolem">t'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="skolem">t'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The carrier of a tree›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> carrier <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">xss</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="bound">xss</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="TTree-carrier_mono"><span class="command">lemma</span></span> carrier_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="free">t</span> <span class="main">⊆</span> paths <span class="free">t'</span> <span class="main">⟹</span> carrier <span class="free">t</span> <span class="main">⊆</span> carrier <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-carrier_possible"><span class="command">lemma</span></span> carrier_possible<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible <span class="free">t</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> carrier <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">force</span>

<span class="keyword1" id="TTree-carrier_possible_subset"><span class="command">lemma</span></span> carrier_possible_subset<span class="main">:</span>
   <span class="quoted"><span class="quoted">"carrier <span class="free">t</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> possible <span class="free">t</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">force</span>

<span class="keyword1" id="TTree-carrier_nxt_subset"><span class="command">lemma</span></span> carrier_nxt_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> carrier <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-Union_paths_carrier"><span class="command">lemma</span></span> Union_paths_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>paths <span class="free">t</span><span class="main">.</span> set <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> carrier <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Repeatable trees›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">repeatable</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">repeatable</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">.</span> possible <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">x</span> <span class="main">⟶</span> nxt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TTree-nxt_repeatable"><span class="command">lemma</span></span> nxt_repeatable<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"repeatable <span class="free">t</span> <span class="main">⟹</span> possible <span class="free">t</span> <span class="free">x</span> <span class="main">⟹</span> nxt <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> repeatable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simple trees›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> empty <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ttree"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-possible_empty"><span class="command">lemma</span></span> possible_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"possible empty <span class="free">x'</span> <span class="main">⟷</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-nxt_not_possible"><span class="command">lemma</span></span> nxt_not_possible<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> possible <span class="free">t</span> <span class="free">x</span> <span class="main">⟹</span> nxt <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-paths_empty"><span class="command">lemma</span></span> paths_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"paths empty <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-carrier_empty"><span class="command">lemma</span></span> carrier_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"carrier empty <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-repeatable_empty"><span class="command">lemma</span></span> repeatable_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"repeatable empty"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> repeatable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  

<span class="keyword1"><span class="command">lift_definition</span></span> single <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> ttree"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-possible_single"><span class="command">lemma</span></span> possible_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="main">(</span>single <span class="free">x</span><span class="main">)</span> <span class="free">x'</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-nxt_single"><span class="command">lemma</span></span> nxt_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nxt <span class="main">(</span>single <span class="free">x</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span>  empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-carrier_single"><span class="command">lemma</span></span> carrier_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>single <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-paths_single"><span class="command">lemma</span></span> paths_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="main">(</span>single <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> many_calls <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> ttree"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> range <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> replicate <span class="bound">n</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> downset_def<span class="main">)</span>

<span class="keyword1" id="TTree-possible_many_calls"><span class="command">lemma</span></span> possible_many_calls<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="main">(</span>many_calls <span class="free">x</span><span class="main">)</span> <span class="free">x'</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_replicate_eq<span class="main">)</span>

<span class="keyword1" id="TTree-nxt_many_calls"><span class="command">lemma</span></span> nxt_many_calls<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nxt <span class="main">(</span>many_calls <span class="free">x</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x'</span> <span class="main">=</span>  <span class="free">x</span> <span class="keyword1">then</span> many_calls <span class="free">x</span> <span class="keyword1">else</span> empty<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_replicate_eq<span class="main">)</span>

<span class="keyword1" id="TTree-repeatable_many_calls"><span class="command">lemma</span></span> repeatable_many_calls<span class="main">:</span> <span class="quoted"><span class="quoted">"repeatable <span class="main">(</span>many_calls <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> repeatable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-carrier_many_calls"><span class="command">lemma</span></span> carrier_many_calls<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>many_calls <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> anything <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ttree"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-possible_anything"><span class="command">lemma</span></span> possible_anything<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"possible anything <span class="free">x'</span> <span class="main">⟷</span> True"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-nxt_anything"><span class="command">lemma</span></span> nxt_anything<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nxt anything <span class="free">x</span> <span class="main">=</span> anything"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-paths_anything"><span class="command">lemma</span></span> paths_anything<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"paths anything <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-carrier_anything"><span class="command">lemma</span></span> carrier_anything<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"carrier anything <span class="main">=</span> UNIV"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Union_paths_carrier<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="improper">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> many_among <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> ttree"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">S</span><span class="main">.</span> <span class="main">{</span><span class="bound">xs</span> <span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="bound">S</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> downset_set_subset<span class="main">)</span>

<span class="keyword1" id="TTree-carrier_many_among"><span class="command">lemma</span></span> carrier_many_among<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>many_among <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> List.set_insert bot.extremum insertCI insert_subset list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Intersection of two trees›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> intersect <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> ttree"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∩∩</span>"</span> 80<span class="main">)</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(∩)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> downset_def<span class="main">)</span>

<span class="keyword1" id="TTree-paths_intersect"><span class="command">lemma</span></span> paths_intersect<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="main">(</span><span class="free">t</span> <span class="main">∩∩</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> paths <span class="free">t</span> <span class="main">∩</span> paths <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-carrier_intersect"><span class="command">lemma</span></span> carrier_intersect<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="free">t</span> <span class="main">∩∩</span> <span class="free">t'</span><span class="main">)</span> <span class="main">⊆</span> carrier <span class="free">t</span> <span class="main">∩</span> carrier <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Union_paths_carrier<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Disjoint union of trees›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> either <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> ttree"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊕⊕</span>"</span> 80<span class="main">)</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> downset_def<span class="main">)</span>
  
<span class="keyword1" id="TTree-either_empty1"><span class="command">lemma</span></span> either_empty1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"empty <span class="main">⊕⊕</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="TTree-either_empty2"><span class="command">lemma</span></span> either_empty2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊕⊕</span> empty <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="TTree-either_sym"><span class="command">lemma</span></span> either_sym<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t2</span> <span class="main">=</span> <span class="free">t2</span> <span class="main">⊕⊕</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="TTree-either_idem"><span class="command">lemma</span></span> either_idem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-possible_either"><span class="command">lemma</span></span> possible_either<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="main">(</span><span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟷</span> possible <span class="free">t</span> <span class="free">x</span> <span class="main">∨</span> possible <span class="free">t'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-nxt_either"><span class="command">lemma</span></span> nxt_either<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nxt <span class="main">(</span><span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> nxt <span class="free">t</span> <span class="free">x</span> <span class="main">⊕⊕</span> nxt <span class="free">t'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-paths_either"><span class="command">lemma</span></span> paths_either<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="main">(</span><span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> paths <span class="free">t</span> <span class="main">∪</span> paths <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="TTree-carrier_either"><span class="command">lemma</span></span> carrier_either<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> carrier <span class="free">t</span> <span class="main">∪</span> carrier <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="TTree-either_contains_arg1"><span class="command">lemma</span></span> either_contains_arg1<span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="free">t</span> <span class="main">⊆</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">fastforce</span>

<span class="keyword1" id="TTree-either_contains_arg2"><span class="command">lemma</span></span> either_contains_arg2<span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="free">t'</span> <span class="main">⊆</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Either <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ttree set <span class="main">⇒</span> <span class="tfree">'a</span> ttree"</span></span>  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">S</span><span class="main">.</span> insert <span class="main">[]</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> downset_def<span class="main">)</span>

<span class="keyword1" id="TTree-paths_Either"><span class="command">lemma</span></span> paths_Either<span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="main">(</span>Either <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">[]</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>paths <span class="main">`</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Merging of trees›</span></span>

<span class="keyword1" id="TTree-ex_ex_eq_hint"><span class="command">lemma</span></span> ex_ex_eq_hint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="free">f</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> both <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> ttree"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊗⊗</span>"</span> 86<span class="main">)</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">xss</span> <span class="bound">yss</span> <span class="main">.</span> <span class="main">⋃</span> <span class="main">{</span><span class="bound">xs</span> <span class="main">⊗</span> <span class="bound">ys</span> <span class="main">|</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="bound">xss</span> <span class="main">∧</span> <span class="bound">ys</span> <span class="main">∈</span> <span class="bound">yss</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ex_ex_eq_hint <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interleave_butlast<span class="main">)</span>

<span class="keyword1" id="TTree-both_assoc"><span class="command">lemma</span></span> both_assoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊗⊗</span> <span class="main">(</span><span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span> <span class="main">⊗⊗</span> <span class="free">t''</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> interleave_assoc2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> interleave_assoc1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-both_comm"><span class="command">lemma</span></span> both_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span> <span class="main">=</span> <span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">metis</span> interleave_comm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="TTree-both_empty1"><span class="command">lemma</span></span> both_empty1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"empty <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-both_empty2"><span class="command">lemma</span></span> both_empty2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊗⊗</span> empty <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-paths_both"><span class="command">lemma</span></span> paths_both<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ys</span> <span class="main">∈</span> paths <span class="free">t</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">zs</span> <span class="main">∈</span> paths <span class="free">t'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">∈</span> <span class="bound">ys</span> <span class="main">⊗</span> <span class="bound">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">fastforce</span>

<span class="keyword1" id="TTree-both_contains_arg1"><span class="command">lemma</span></span> both_contains_arg1<span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="free">t</span> <span class="main">⊆</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">fastforce</span>

<span class="keyword1" id="TTree-both_contains_arg2"><span class="command">lemma</span></span> both_contains_arg2<span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="free">t'</span> <span class="main">⊆</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">fastforce</span>

<span class="keyword1" id="TTree-both_mono1"><span class="command">lemma</span></span> both_mono1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"paths <span class="free">t</span> <span class="main">⊆</span> paths <span class="free">t'</span> <span class="main">⟹</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t''</span><span class="main">)</span> <span class="main">⊆</span> paths <span class="main">(</span><span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-both_mono2"><span class="command">lemma</span></span> both_mono2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"paths <span class="free">t</span> <span class="main">⊆</span> paths <span class="free">t'</span> <span class="main">⟹</span> paths <span class="main">(</span><span class="free">t''</span> <span class="main">⊗⊗</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> paths <span class="main">(</span><span class="free">t''</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-possible_both"><span class="command">lemma</span></span> possible_both<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟷</span> possible <span class="free">t</span> <span class="free">x</span> <span class="main">∨</span> possible <span class="free">t'</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"possible <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">#</span><span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">#</span><span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> paths <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">#</span><span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">#</span><span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">zs</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="skolem">ys</span> <span class="main">=</span> <span class="free">x</span>  <span class="main">∨</span> <span class="skolem">zs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="skolem">zs</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> interleave_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"possible <span class="free">t</span> <span class="free">x</span> <span class="main">∨</span> possible <span class="free">t'</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">∈</span> paths <span class="free">t</span>›</span></span>   <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">∈</span> paths <span class="free">t'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"possible <span class="free">t</span> <span class="free">x</span> <span class="main">∨</span> possible <span class="free">t'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">∈</span> paths <span class="free">t</span> <span class="main">∨</span> <span class="free">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">∈</span> paths <span class="free">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">#</span><span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> both_contains_arg1<span class="main"><span class="main">]</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> both_contains_arg2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"possible <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TTree-nxt_both"><span class="command">lemma</span></span> nxt_both<span class="main">:</span>
    <span class="quoted"><span class="quoted">"nxt <span class="main">(</span><span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> possible <span class="free">t'</span> <span class="free">x</span> <span class="main">∧</span> possible <span class="free">t</span> <span class="free">x</span> <span class="keyword1">then</span> nxt <span class="free">t'</span> <span class="free">x</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span> <span class="main">⊗⊗</span> nxt <span class="free">t</span> <span class="free">x</span> <span class="keyword1">else</span>
                           <span class="keyword1">if</span> possible <span class="free">t'</span> <span class="free">x</span> <span class="keyword1">then</span> nxt <span class="free">t'</span> <span class="free">x</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="keyword1">else</span>
                           <span class="keyword1">if</span> possible <span class="free">t</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">t'</span> <span class="main">⊗⊗</span> nxt <span class="free">t</span> <span class="free">x</span> <span class="keyword1">else</span>
                           empty<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> 4 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_intros<span class="main">)</span>

<span class="keyword1" id="TTree-Cons_both"><span class="command">lemma</span></span> Cons_both<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> possible <span class="free">t'</span> <span class="free">x</span> <span class="main">∧</span> possible <span class="free">t</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="free">t'</span> <span class="free">x</span> <span class="main">⊗⊗</span> <span class="free">t</span><span class="main">)</span> <span class="main">∨</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">t'</span> <span class="main">⊗⊗</span> nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span>
                           <span class="keyword1">if</span> possible <span class="free">t'</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="free">t'</span> <span class="free">x</span> <span class="main">⊗⊗</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">else</span>
                           <span class="keyword1">if</span> possible <span class="free">t</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">t'</span> <span class="main">⊗⊗</span> nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span>
                           False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_Cons_nxt_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nxt_both<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> paths.rep_eq possible.rep_eq possible_both<span class="main">)</span>

<span class="keyword1" id="TTree-Cons_both_possible_leftE"><span class="command">lemma</span></span> Cons_both_possible_leftE<span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="free">t</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="free">t</span> <span class="free">x</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">#</span><span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_both<span class="main">)</span>
<span class="keyword1" id="TTree-Cons_both_possible_rightE"><span class="command">lemma</span></span> Cons_both_possible_rightE<span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="free">t'</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> nxt <span class="free">t'</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">#</span><span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_both<span class="main">)</span>

<span class="keyword1" id="TTree-either_both_distr"><span class="command">lemma</span></span> either_both_distr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t''</span> <span class="main">=</span> <span class="free">t'</span> <span class="main">⊗⊗</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-either_both_distr2"><span class="command">lemma</span></span> either_both_distr2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t''</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span> <span class="main">⊕⊕</span> <span class="free">t''</span><span class="main">)</span> <span class="main">⊗⊗</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-nxt_both_repeatable"><span class="command">lemma</span></span> nxt_both_repeatable<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"repeatable <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="free">t'</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nxt <span class="main">(</span><span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t'</span> <span class="main">⊗⊗</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊕⊕</span> nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nxt_both<span class="main">)</span>

<span class="keyword1" id="TTree-nxt_both_many_calls"><span class="command">lemma</span></span> nxt_both_many_calls<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nxt <span class="main">(</span>many_calls <span class="free">x</span> <span class="main">⊗⊗</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> many_calls <span class="free">x</span> <span class="main">⊗⊗</span> <span class="main">(</span><span class="free">t</span>  <span class="main">⊕⊕</span> nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> repeatable_many_calls<span class="main">)</span>

<span class="keyword1" id="TTree-repeatable_both_self"><span class="command">lemma</span></span> repeatable_both_self<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"repeatable <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> paths_inj set_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_both paths_Cons_nxt_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Cons_both both_empty1 possible_empty<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-repeatable_both_both"><span class="command">lemma</span></span> repeatable_both_both<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"repeatable <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> repeatable_both_self<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span>  both_assoc both_comm<span class="main">)</span>

<span class="keyword1" id="TTree-repeatable_both_both2"><span class="command">lemma</span></span> repeatable_both_both2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"repeatable <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> repeatable_both_self<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span>  both_assoc both_comm<span class="main">)</span>


<span class="keyword1" id="TTree-repeatable_both_nxt"><span class="command">lemma</span></span> repeatable_both_nxt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"repeatable <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"possible <span class="free">t'</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nxt <span class="free">t'</span> <span class="free">x</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">=</span> nxt <span class="free">t'</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"nxt <span class="free">t'</span> <span class="free">x</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">≠</span> nxt <span class="free">t'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nxt <span class="free">t'</span> <span class="free">x</span> <span class="main">⊕⊕</span> <span class="free">t'</span><span class="main">)</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">≠</span> nxt <span class="free">t'</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> both_assoc repeatable_both_self<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"nxt <span class="free">t'</span> <span class="free">x</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">=</span> nxt <span class="free">t'</span> <span class="free">x</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms either_both_distr2 nxt_both nxt_repeatable<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TTree-repeatable_both_both_nxt"><span class="command">lemma</span></span> repeatable_both_both_nxt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t''</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms both_assoc both_comm<span class="main">)</span>


<span class="keyword1" id="TTree-carrier_both"><span class="command">lemma</span></span> carrier_both<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> carrier <span class="free">t</span> <span class="main">∪</span> carrier <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> paths <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> interleave <span class="skolem">ys</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_both<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="skolem">ys</span> <span class="main">∪</span> set <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interleave_set<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="free">t</span> <span class="main">∪</span> carrier <span class="free">t'</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> carrier_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> both_contains_arg1<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> t' <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="free">t'</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
       subsetD<span class="main">[</span><span class="operator">OF</span> carrier_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> both_contains_arg2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> t' <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="free">t'</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Removing elements from a tree›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> without <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> ttree"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="bound">xss</span><span class="main">.</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">≠</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="bound">xss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> downset_filter<span class="main">)</span><span class="main">(</span><span class="operator">metis</span> filter.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> imageI<span class="main">)</span>

<span class="keyword1" id="TTree-paths_withoutI"><span class="command">lemma</span></span> paths_withoutI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>without <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_id_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span><span class="main">`</span> paths <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TTree-carrier_without"><span class="command">lemma</span></span> carrier_without<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>without <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> carrier <span class="free">t</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> ttree_restr <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> ttree"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">S</span> <span class="bound">xss</span><span class="main">.</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">)</span> <span class="main">`</span> <span class="bound">xss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> downset_filter<span class="main">)</span><span class="main">(</span><span class="operator">metis</span> filter.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> imageI<span class="main">)</span>

<span class="keyword1" id="TTree-filter_paths_conv_free_restr"><span class="command">lemma</span></span> filter_paths_conv_free_restr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">`</span> paths <span class="free">t</span> <span class="main">=</span> paths <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-filter_paths_conv_free_restr2"><span class="command">lemma</span></span> filter_paths_conv_free_restr2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∉</span> <span class="free">S</span><span class="main">)</span> <span class="main">`</span> paths <span class="free">t</span> <span class="main">=</span> paths <span class="main">(</span>ttree_restr <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-filter_paths_conv_free_without"><span class="command">lemma</span></span> filter_paths_conv_free_without<span class="main">:</span>
  <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">≠</span> <span class="free">y</span><span class="main">)</span> <span class="main">`</span> paths <span class="free">t</span> <span class="main">=</span> paths <span class="main">(</span>without <span class="free">y</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-ttree_restr_is_empty"><span class="command">lemma</span></span> ttree_restr_is_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="free">t</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> ttree_restr <span class="free">S</span> <span class="free">t</span> <span class="main">=</span> empty"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> iffI <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> SUP_bot_conv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> SUP_inf inf_commute inter_set_filter set_empty<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-ttree_restr_noop"><span class="command">lemma</span></span> ttree_restr_noop<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="free">t</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> ttree_restr <span class="free">S</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> SUP_le_iff contra_subsetD filter_True<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> SUP_upper contra_subsetD filter_True<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-ttree_restr_tree_restr"><span class="command">lemma</span></span> ttree_restr_tree_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ttree_restr <span class="free">S</span> <span class="main">(</span>ttree_restr <span class="free">S'</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> ttree_restr <span class="main">(</span><span class="free">S'</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp comp_def<span class="main">)</span>

<span class="keyword1" id="TTree-ttree_restr_both"><span class="command">lemma</span></span> ttree_restr_both<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ttree_restr <span class="free">S</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> ttree_restr <span class="free">S</span> <span class="free">t</span> <span class="main">⊗⊗</span> ttree_restr <span class="free">S</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_both filter_paths_conv_free_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> paths_inj filter_interleave  <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> interleave_filter<span class="main">)</span>

<span class="keyword1" id="TTree-ttree_restr_nxt_subset"><span class="command">lemma</span></span> ttree_restr_nxt_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> paths <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="main">(</span>nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> paths <span class="main">(</span>nxt <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>

<span class="keyword1" id="TTree-ttree_restr_nxt_subset2"><span class="command">lemma</span></span> ttree_restr_nxt_subset2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> paths <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="main">(</span>nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> paths <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> imageI<span class="main">)</span>

<span class="keyword1" id="TTree-ttree_restr_possible"><span class="command">lemma</span></span> ttree_restr_possible<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> possible <span class="free">t</span> <span class="free">x</span> <span class="main">⟹</span> possible <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">force</span>

<span class="keyword1" id="TTree-ttree_restr_possible2"><span class="command">lemma</span></span> ttree_restr_possible2<span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t'</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> filter_eq_Cons_iff<span class="main">)</span>

<span class="keyword1" id="TTree-carrier_ttree_restr"><span class="command">lemma</span></span> carrier_ttree_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="main">∩</span> carrier <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="comment1">(*
lemma intersect_many_among: "t ∩∩ many_among S = ttree_restr S t"
  apply transfer
  apply auto
*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Multiple variables, each called at most once›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> singles <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> ttree"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">S</span><span class="main">.</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">.</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> downsetI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> append_butlast_last_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> filter_append<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-possible_singles"><span class="command">lemma</span></span> possible_singles<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer'</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-length_filter_mono"><span class="command">lemma</span></span> length_filter_mono<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="free">Q</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1" id="TTree-nxt_singles"><span class="command">lemma</span></span> nxt_singles<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nxt <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1">if</span> <span class="free">x'</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">then</span> without <span class="free">x'</span> <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span> <span class="keyword1">else</span> singles <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer'</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rev_image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> rev_image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_id_conv filter_empty_conv<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">xb</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> length_filter_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-carrier_singles"><span class="command">lemma</span></span> carrier_singles<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="improper">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-singles_mono"><span class="command">lemma</span></span> singles_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">⟹</span> paths <span class="main">(</span>singles <span class="free">S'</span><span class="main">)</span> <span class="main">⊆</span> paths <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>


<span class="keyword1" id="TTree-paths_many_calls_subset"><span class="command">lemma</span></span> paths_many_calls_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"paths <span class="free">t</span> <span class="main">⊆</span> paths <span class="main">(</span>many_calls <span class="free">x</span> <span class="main">⊗⊗</span> without <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>many_calls <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="free">t</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>without <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> interleave <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>  <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interleave_filtered<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>many_calls <span class="free">x</span> <span class="main">⊗⊗</span> without <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Substituting trees for every node›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">f_nxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> ttree<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> ttree<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f_nxt</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">:=</span>empty<span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">substitute'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> ttree<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    substitute'_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">substitute'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span>
  <span class="main">|</span> substitute'_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">substitute'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">⟷</span>
        possible <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free">substitute'</span> <span class="main">(</span>f_nxt <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span>nxt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊗⊗</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="TTree-f_nxt_mono1"><span class="command">lemma</span></span> f_nxt_mono1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> paths <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> paths <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> paths <span class="main">(</span>f_nxt <span class="free">f</span> <span class="free">T</span> <span class="free">x</span> <span class="free">x'</span><span class="main">)</span> <span class="main">⊆</span> paths <span class="main">(</span>f_nxt <span class="free">f'</span> <span class="free">T</span> <span class="free">x</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> f_nxt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1" id="TTree-f_nxt_empty_set"><span class="command">lemma</span></span> f_nxt_empty_set<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"f_nxt <span class="free">f</span> <span class="main">{}</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>

<span class="keyword1" id="TTree-downset_substitute"><span class="command">lemma</span></span> downset_substitute<span class="main">:</span> <span class="quoted"><span class="quoted">"downset <span class="main">(</span>Collect <span class="main">(</span>substitute' <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> mem_Collect_eq
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"substitute' <span class="free">f</span> <span class="free">T</span> <span class="free">t</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"substitute' <span class="free">f</span> <span class="free">T</span> <span class="free">t</span> <span class="main">(</span>butlast <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitute'.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> substitute <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> ttree<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> ttree"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">f</span> <span class="bound">T</span> <span class="bound">t</span><span class="main">.</span> Collect <span class="main">(</span>substitute' <span class="bound">f</span> <span class="bound">T</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> downset_substitute<span class="main">)</span>

<span class="keyword1" id="TTree-elim_substitute'"><span class="command">lemma</span></span> elim_substitute'<span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"substitute' <span class="free">f</span> <span class="free">T</span> <span class="free">t</span> <span class="free">xs</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> substitute_induct<span class="main">[</span><span class="operator">case_names</span> Nil Cons<span class="main">]</span> <span class="main">=</span> substitute'.induct
<span class="keyword1"><span class="command">lemmas</span></span> substitute_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> substitute'.simps<span class="main">[</span><span class="operator">unfolded</span> elim_substitute'<span class="main">]</span>

<span class="keyword1" id="TTree-substitute_mono2"><span class="command">lemma</span></span> substitute_mono2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"paths <span class="free">t</span> <span class="main">⊆</span> paths <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> possible_mono <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> Cons.IH <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  both_mono1 nxt_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TTree-substitute_mono1"><span class="command">lemma</span></span> substitute_mono1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> paths <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> paths <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> paths <span class="main">(</span>substitute <span class="free">f'</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this assms
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f'</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">f'</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons.IH <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f_nxt_mono1<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> substitute_mono2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span>  both_mono2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TTree-substitute_monoT"><span class="command">lemma</span></span> substitute_monoT<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">T'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T'</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T'</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">T'</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitute_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f</span> <span class="skolem">T'</span> <span class="skolem">t</span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="skolem">f</span> <span class="skolem">T'</span> <span class="skolem">t</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="skolem">T'</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">T'</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="skolem">T'</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> substitute_mono1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="TTree-substitute_contains_arg"><span class="command">lemma</span></span> substitute_contains_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="free">t</span> <span class="main">⊆</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="free">t</span> <span class="main">⟹</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="skolem">t</span>›</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_nxt_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> both_contains_arg1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="TTree-possible_substitute"><span class="command">lemma</span></span> possible_substitute<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟷</span> possible <span class="free">t</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_both both_empty2 paths_Nil substitute_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="TTree-nxt_substitute"><span class="command">lemma</span></span> nxt_substitute<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="free">t</span> <span class="free">x</span> <span class="main">⟹</span> nxt <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> substitute <span class="main">(</span>f_nxt <span class="free">f</span> <span class="free">T</span> <span class="free">x</span><span class="main">)</span> <span class="free">T</span> <span class="main">(</span>nxt <span class="free">t</span> <span class="free">x</span> <span class="main">⊗⊗</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ttree_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_nxt_eq<span class="main">)</span>

<span class="keyword1" id="TTree-substitute_either"><span class="command">lemma</span></span> substitute_either<span class="main">:</span> <span class="quoted"><span class="quoted">"substitute <span class="free">f</span> <span class="free">T</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span> <span class="main">⊕⊕</span> substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="bound">x</span> <span class="main">.</span> <span class="main">(</span>nxt <span class="bound">t</span> <span class="bound">x</span> <span class="main">⊕⊕</span> nxt <span class="bound">t'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊗⊗</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> nxt <span class="bound">t</span> <span class="bound">x</span> <span class="main">⊗⊗</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊕⊕</span> nxt <span class="bound">t'</span> <span class="bound">x</span> <span class="main">⊗⊗</span> <span class="free">f</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> both_comm either_both_distr<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span>  <span class="main">⟷</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Cons.IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"nxt <span class="skolem">t'</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> either_both_distr2 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> either_both_distr2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> IH both_comm either_both_distr either_empty2 nxt_not_possible<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> IH both_comm both_empty1 either_both_distr either_empty1 nxt_not_possible<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> paths_inj<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(*
lemma substitute_both: "substitute f (t ⊗⊗ t') = substitute f t ⊗⊗ substitute f t'"
proof (intro paths_inj set_eqI)
  fix xs
  show "(xs ∈ paths (substitute f (t ⊗⊗ t'))) = (xs ∈ paths (substitute f t ⊗⊗ substitute f t'))"
  proof (induction xs arbitrary: t t')
  case Nil thus ?case by simp
  next
  case (Cons x xs)
    have [simp]: "nxt t x ⊗⊗ t' ⊗⊗ f x = nxt t x ⊗⊗ f x ⊗⊗ t'"
      by (metis both_assoc both_comm)
    have [simp]: "t ⊗⊗ nxt t' x ⊗⊗ f x = t ⊗⊗ (nxt t' x ⊗⊗ f x)"
      by (metis both_assoc both_comm)
    note Cons[where t = "nxt t x ⊗⊗ f x" and t' = t', simp]
    note Cons[where t = t and t' = "nxt t' x ⊗⊗ f x", simp]
    show ?case
      by (auto simp add: Cons_both nxt_both either_both_distr2[symmetric] substitute_either
                  simp del: both_assoc )
  qed
qed
*)</span>

<span class="keyword1" id="TTree-f_nxt_T_delete"><span class="command">lemma</span></span> f_nxt_T_delete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> empty"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"f_nxt <span class="free">f</span> <span class="main">(</span><span class="free">T</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> f_nxt <span class="free">f</span> <span class="free">T</span> <span class="free">x'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>

<span class="keyword1" id="TTree-f_nxt_empty"><span class="command">lemma</span></span> f_nxt_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> empty"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"f_nxt <span class="free">f</span> <span class="free">T</span> <span class="free">x'</span> <span class="free">x</span> <span class="main">=</span> empty"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>

<span class="keyword1" id="TTree-f_nxt_empty'"><span class="command">lemma</span></span> f_nxt_empty'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> empty"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"f_nxt <span class="free">f</span> <span class="free">T</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>


<span class="keyword1" id="TTree-substitute_T_delete"><span class="command">lemma</span></span> substitute_T_delete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> empty"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"substitute <span class="free">f</span> <span class="main">(</span><span class="free">T</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> paths_inj  set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="main">(</span><span class="free">T</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_T_delete <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="TTree-substitute_only_empty"><span class="command">lemma</span></span> substitute_only_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"const_on <span class="free">f</span> <span class="main">(</span>carrier <span class="free">t</span><span class="main">)</span> empty"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> paths_inj  set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span>
  
    <span class="keyword1"><span class="command">note</span></span> const_onD<span class="main">[</span><span class="operator">OF</span> Cons.prems carrier_possible<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⟹</span> f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> f_nxt_empty'<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> const_onD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons.prems carrier_possible<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> Cons.prems carrier_nxt_subset
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"const_on <span class="skolem">f</span> <span class="main">(</span>carrier <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> empty"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> const_on_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"const_on <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>carrier <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> empty"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_on_def f_nxt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="skolem">f</span> <span class="free">T</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_path<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TTree-substitute_only_empty_both"><span class="command">lemma</span></span> substitute_only_empty_both<span class="main">:</span> <span class="quoted"><span class="quoted">"const_on <span class="free">f</span> <span class="main">(</span>carrier <span class="free">t'</span><span class="main">)</span> empty <span class="main">⟹</span> substitute <span class="free">f</span> <span class="free">T</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> paths_inj set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"const_on <span class="free">f</span> <span class="main">(</span>carrier <span class="free">t'</span><span class="main">)</span> TTree.empty"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t'</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_possible<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>

      <span class="keyword1"><span class="command">note</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"nxt <span class="skolem">t</span> <span class="skolem">x</span>"</span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

      <span class="keyword1"><span class="command">from</span></span> Cons.prems
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"const_on <span class="skolem">f</span> <span class="main">(</span>carrier <span class="main">(</span>nxt <span class="skolem">t'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_nxt_subset const_on_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_both nxt_both  substitute_either<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False

      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">t'</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> both_assoc both_comm<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> Cons.prems
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"const_on <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>carrier <span class="skolem">t'</span><span class="main">)</span> empty"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_both nxt_both  substitute_either<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="TTree-f_nxt_upd_empty"><span class="command">lemma</span></span> f_nxt_upd_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"f_nxt <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x'</span> <span class="main">:=</span> empty<span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>f_nxt <span class="free">f</span> <span class="free">T</span> <span class="free">x</span><span class="main">)</span><span class="main">(</span><span class="free">x'</span> <span class="main">:=</span> empty<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>

<span class="keyword1" id="TTree-repeatable_f_nxt_upd"><span class="command">lemma</span></span> repeatable_f_nxt_upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"repeatable <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> repeatable <span class="main">(</span>f_nxt <span class="free">f</span> <span class="free">T</span> <span class="free">x'</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>

<span class="keyword1" id="TTree-substitute_remove_anyways_aux"><span class="command">lemma</span></span> substitute_remove_anyways_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"repeatable <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> empty<span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">xs</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitute_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">t</span> <span class="skolem">x'</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> TTree.empty<span class="main">)</span><span class="main">)</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x'</span> <span class="free">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> repeatable_both_nxt repeatable_both_both_nxt   <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> TTree.empty<span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="comment1">(*  have [simp]: "f_nxt f T x' x = f x" using False by (auto simp add: f_nxt_def) *)</span>

    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="free">x</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="free">x</span> <span class="main">∨</span> <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="free">x</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons True
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> repeatable_both_nxt repeatable_both_both_nxt   <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
      

<span class="keyword1" id="TTree-substitute_remove_anyways"><span class="command">lemma</span></span> substitute_remove_anyways<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"repeatable <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"substitute <span class="free">f</span> <span class="free">T</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> substitute <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> empty<span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> paths_inj<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"repeatable <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms both_assoc both_comm repeatable_both_self<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> empty<span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> substitute_remove_anyways_aux<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"paths <span class="main">(</span>substitute <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> empty<span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> substitute_mono1<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="TTree-carrier_f_nxt"><span class="command">lemma</span></span> carrier_f_nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>f_nxt <span class="free">f</span> <span class="free">T</span> <span class="free">x</span> <span class="free">x'</span><span class="main">)</span> <span class="main">⊆</span> carrier <span class="main">(</span><span class="free">f</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>

<span class="keyword1" id="TTree-f_nxt_cong"><span class="command">lemma</span></span> f_nxt_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x'</span> <span class="main">=</span> <span class="free">f'</span> <span class="free">x'</span> <span class="main">⟹</span> f_nxt <span class="free">f</span> <span class="free">T</span> <span class="free">x</span> <span class="free">x'</span> <span class="main">=</span> f_nxt <span class="free">f'</span> <span class="free">T</span> <span class="free">x</span> <span class="free">x'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>

<span class="keyword1" id="TTree-substitute_cong'"><span class="command">lemma</span></span> substitute_cong'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> carrier <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"carrier <span class="free">t</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f'</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitute_induct <span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">t</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_possible<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> Cons.prems<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons.IH
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> carrier_f_nxt<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> carrier_nxt_subset<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹carrier <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> f_nxt_cong
          <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="TTree-substitute_cong_induct"><span class="command">lemma</span></span> substitute_cong_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> carrier <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"carrier <span class="free">t</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span> <span class="main">=</span> substitute <span class="free">f'</span> <span class="free">T</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> paths_inj<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> substitute_cong'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> substitute_cong'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="TTree-carrier_substitute_aux"><span class="command">lemma</span></span> carrier_substitute_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"carrier <span class="free">t</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> carrier <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span>  <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitute_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> carrier_possible_subset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> carrier_f_nxt carrier_nxt_subset carrier_possible_subset contra_subsetD order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-carrier_substitute_below"><span class="command">lemma</span></span> carrier_substitute_below<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> carrier <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"carrier <span class="free">t</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> carrier_substitute_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  Union_paths_carrier<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TTree-f_nxt_eq_empty_iff"><span class="command">lemma</span></span> f_nxt_eq_empty_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"f_nxt <span class="free">f</span> <span class="free">T</span> <span class="free">x</span> <span class="free">x'</span> <span class="main">=</span> empty <span class="main">⟷</span> <span class="free">f</span> <span class="free">x'</span> <span class="main">=</span> empty <span class="main">∨</span> <span class="main">(</span><span class="free">x'</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>

<span class="keyword1" id="TTree-substitute_T_cong'"><span class="command">lemma</span></span> substitute_T_cong'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span>  <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">T'</span><span class="main">)</span> <span class="main">∨</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> empty"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T'</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">xs</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitute_induct <span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">t</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x</span> <span class="main">=</span> f_nxt <span class="skolem">f</span> <span class="free">T'</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x'</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x'</span> <span class="main">∈</span> <span class="free">T'</span><span class="main">)</span> <span class="main">∨</span> f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x</span> <span class="bound">x'</span> <span class="main">=</span> TTree.empty<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_eq_empty_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> Cons.IH<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TTree-substitute_cong_T"><span class="command">lemma</span></span> substitute_cong_T<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span>  <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">T'</span><span class="main">)</span> <span class="main">∨</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> empty"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"substitute <span class="free">f</span> <span class="free">T</span> <span class="main">=</span> substitute <span class="free">f</span> <span class="free">T'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> paths_inj<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> substitute_T_cong'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> substitute_T_cong'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-carrier_substitute1"><span class="command">lemma</span></span> carrier_substitute1<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="free">t</span> <span class="main">⊆</span> carrier <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> carrier_mono<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> substitute_contains_arg<span class="main">)</span>

<span class="keyword1" id="TTree-substitute_cong"><span class="command">lemma</span></span> substitute_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span> <span class="main">=</span> substitute <span class="free">f'</span> <span class="free">T</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> substitute_cong_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="free">t</span> <span class="main">⊆</span> carrier <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> carrier_substitute1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> carrier <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x'</span> <span class="skolem">xs</span> <span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">t</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x'</span><span class="main">)</span> <span class="free">T</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x'</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x'</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> carrier <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x'</span><span class="main">)</span> <span class="free">T</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x'</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">elim</span> conjE disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> carrier <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> carrier <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x'</span><span class="main">)</span> <span class="free">T</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> carrier_substitute1<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span>›</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>

      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="main">_</span> ›</span></span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> carrier <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x'</span><span class="main">)</span> <span class="free">T</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x'</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹possible <span class="skolem">t</span> <span class="skolem">x'</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x'</span><span class="main">)</span> <span class="free">T</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x'</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>  carrier <span class="main">(</span>substitute <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">x'</span><span class="main">#</span><span class="improper">xa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TTree-substitute_substitute"><span class="command">lemma</span></span> substitute_substitute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> const_on <span class="free">f'</span> <span class="main">(</span>carrier <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> empty"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"substitute <span class="free">f</span> <span class="free">T</span> <span class="main">(</span>substitute <span class="free">f'</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> substitute <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊗⊗</span> <span class="free">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="free">T</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> paths_inj<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">f</span> <span class="bound">f'</span> <span class="bound">x'</span><span class="main">.</span> f_nxt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">⊗⊗</span> <span class="bound">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="free">T</span> <span class="bound">x'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> f_nxt <span class="bound">f</span> <span class="free">T</span> <span class="bound">x'</span> <span class="bound">x</span> <span class="main">⊗⊗</span> f_nxt <span class="bound">f'</span> <span class="free">T</span> <span class="bound">x'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span>  assms
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="main">(</span>substitute <span class="free">f'</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊗⊗</span> <span class="free">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">f'</span></span> <span class="quoted"><span class="free">t</span></span> <span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True

      <span class="keyword1"><span class="command">from</span></span> Cons.prems
      <span class="keyword1"><span class="command">have</span></span> prem'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x'</span><span class="main">.</span> const_on <span class="main">(</span>f_nxt <span class="skolem">f'</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>carrier <span class="main">(</span><span class="skolem">f</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span> empty"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> const_on <span class="main">(</span>f_nxt <span class="skolem">f'</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>carrier <span class="main">(</span><span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span> empty"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_empty const_onI emptyE f_nxt_def fun_upd_apply<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> Cons.IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"f_nxt <span class="skolem">f'</span> <span class="free">T</span> <span class="skolem">x</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f'</span> <span class="skolem">x</span> <span class="main">=</span> nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f'</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> both_comm both_assoc<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> iffI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substitute_only_empty_both<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem'<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x' <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> <span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="TTree-ttree_rest_substitute"><span class="command">lemma</span></span> ttree_rest_substitute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> carrier <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ttree_restr <span class="free">S</span> <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> ttree_restr <span class="free">S</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> paths_inj<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">xs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_paths_conv_free_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">xs'</span> <span class="main">∈</span>  paths <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">T</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> carrier <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>
    
    <span class="keyword1"><span class="command">from</span></span>  Cons.IH<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="main">∈</span> paths <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊗⊗</span> ttree_restr <span class="free">S</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ttree_restr_both<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="main">∈</span> paths <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ttree_restr_is_empty<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹possible <span class="skolem">t</span> <span class="skolem">x</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="main">∈</span> paths <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_path ttree_restr_possible  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ttree_restr_nxt_subset2<span class="main"><span class="main">]</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ttree_restr_nxt_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">xs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_paths_conv_free_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> substitute_contains_arg<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_paths_conv_free_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An alternative characterization of substitution›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">substitute''</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> ttree<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  substitute''_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">substitute''</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
  <span class="main">|</span> substitute''_Cons<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">∈</span> paths <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="main">∈</span> interleave <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">⟹</span> <span class="free">substitute''</span> <span class="main">(</span>f_nxt <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>
       <span class="main">⟹</span> <span class="free">substitute''</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> substitute''_NilE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"substitute'' <span class="free">f</span> <span class="free">T</span> <span class="free">xs</span> <span class="main">[]</span>"</span></span>  <span class="quoted"><span class="quoted">"substitute'' <span class="free">f</span> <span class="free">T</span> <span class="main">[]</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> substitute''_ConsE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"substitute'' <span class="free">f</span> <span class="free">T</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">ys</span>"</span></span>

<span class="keyword1" id="TTree-substitute_substitute''"><span class="command">lemma</span></span> substitute_substitute''<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">xs'</span> <span class="main">∈</span> paths <span class="free">t</span><span class="main">.</span> substitute'' <span class="free">f</span> <span class="free">T</span> <span class="bound">xs'</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xs'</span> <span class="main">∈</span> paths <span class="free">t</span><span class="main">.</span> substitute'' <span class="free">f</span> <span class="free">T</span> <span class="bound">xs'</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="skolem">f</span> <span class="free">T</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">t</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">T</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_path<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">T</span> <span class="skolem">xs'</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="skolem"><span class="skolem">zs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys'</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs'</span> <span class="main">∈</span> paths <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> interleave <span class="skolem">ys'</span> <span class="skolem">zs'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_both<span class="main">)</span>
  
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹substitute'' <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">T</span> <span class="skolem">xs'</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="skolem">f</span> <span class="free">T</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys'</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹possible <span class="skolem">t</span> <span class="skolem">x</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys'</span> <span class="main">∈</span> paths <span class="skolem">t</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_path<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xs'</span> <span class="main">∈</span> paths <span class="free">t</span><span class="main">.</span> substitute'' <span class="free">f</span> <span class="free">T</span> <span class="bound">xs'</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"substitute'' <span class="free">f</span> <span class="free">T</span> <span class="skolem">xs'</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitute''.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Nil Cons<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">zs</span> <span class="skolem">x</span> <span class="skolem">xs'</span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems Cons.hyps
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_path paths_both <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TTree-paths_substitute_substitute''"><span class="command">lemma</span></span> paths_substitute_substitute''<span class="main">:</span>
  <span class="quoted"><span class="quoted">"paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span> <span class="main">.</span> Collect <span class="main">(</span>substitute'' <span class="free">f</span> <span class="free">T</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> paths <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substitute_substitute''<span class="main">)</span>

<span class="keyword1" id="TTree-ttree_rest_substitute2"><span class="command">lemma</span></span> ttree_rest_substitute2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> carrier <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"const_on <span class="free">f</span> <span class="main">(</span><span class="main">-</span><span class="free">S</span><span class="main">)</span> empty"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ttree_restr <span class="free">S</span> <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> substitute <span class="free">f</span> <span class="free">T</span> <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> paths_inj<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">xs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_paths_conv_free_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">xs'</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitute_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">t</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> this<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span>  Cons.prems<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x'</span><span class="main">.</span> carrier <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span>  Cons.prems<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"const_on <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">S</span><span class="main">)</span> empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ttree_restr_both<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹possible <span class="skolem">t</span> <span class="skolem">x</span>›</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> * True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ttree_restr_both ttree_restr_noop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ttree_restr_possible
                    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> substitute_mono2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> both_mono1<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> ttree_restr_nxt_subset<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹const_on <span class="skolem">f</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> TTree.empty›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> * False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> substitute_mono2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> ttree_restr_nxt_subset2<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="free">f</span> <span class="free">T</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span><span class="main">∈</span><span class="free">S</span><span class="main">)</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="skolem">xs</span> "</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> substitute_substitute''
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_paths_conv_free_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xs''</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span><span class="main">∈</span><span class="free">S</span><span class="main">)</span> <span class="bound">xs''</span> <span class="main">∧</span> substitute'' <span class="free">f</span> <span class="free">T</span> <span class="skolem">xs'</span> <span class="bound">xs''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs'</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">ys</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> length <span class="main"><span class="main">(</span></span>filter <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x'</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x'</span></span> <span class="main"><span class="main">∉</span></span> <span class="free"><span class="free">S</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">+</span></span> length <span class="bound"><span class="bound">ys</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹substitute'' <span class="skolem">f</span> <span class="free">T</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="skolem">ys</span>›</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> less.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Nil <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span>  <span class="operator">metis</span> filter.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> substitute''_Nil<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> Cons less.prems
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="skolem">f</span> <span class="free">T</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs'</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span><span class="main">)</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> substitute''_ConsE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="skolem"><span class="skolem">xs''</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs''</span> <span class="main">∈</span> interleave <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs'</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">T</span> <span class="skolem">xs''</span> <span class="skolem">ys'</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>›</span></span>  less.prems<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Union_paths_carrier<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">zs</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">zs</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∉</span> <span class="free">S</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnCI Un_subset_iff eq_iff filter_True<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">metis</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">zs</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span> filter_False insert_absorb insert_subset<span class="main">)</span>
        
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs''</span> <span class="main">∈</span> interleave <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs'</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="skolem">zs</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs''</span> <span class="main">∈</span> interleave <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs'</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">zs</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs''</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs'''</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'''</span> <span class="main">∈</span> interleave <span class="skolem">xs'</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interleave_filter<span class="main">)</span>

        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs'''</span> <span class="main">∈</span> interleave <span class="skolem">xs'</span> <span class="skolem">zs</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">P</span><span class="main">.</span> length <span class="main">(</span>filter <span class="bound">P</span> <span class="skolem">xs'''</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="bound">P</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="bound">P</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span> <span class="operator">auto</span>
        
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹substitute'' <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">T</span> <span class="skolem">xs''</span> <span class="skolem">ys'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs''</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">T</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs'''</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="skolem">ys'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> less.prems<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xa</span><span class="main">.</span> carrier <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> less.prems<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"const_on <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> TTree.empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys''</span><span class="main">.</span> <span class="skolem">ys'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="bound">ys''</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="main">∧</span> substitute'' <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">T</span> <span class="skolem">xs'''</span> <span class="bound">ys''</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less.hyps<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">=</span> <span class="main">_</span> ›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">=</span><span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs''</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> l<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">ys''</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">T</span> <span class="skolem">xs'''</span> <span class="skolem">ys''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">ys''</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs'''</span> <span class="main">∈</span> interleave <span class="skolem">xs'</span> <span class="skolem">zs</span>›</span></span> <span class="quoted"><span class="quoted">‹substitute'' <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">T</span> <span class="skolem">xs'''</span> <span class="skolem">ys''</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="skolem">f</span> <span class="free">T</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">ys''</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> Cons less.prems
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="skolem">f</span> <span class="free">T</span> <span class="main">(</span><span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs'</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span><span class="main">)</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys'</span><span class="main">.</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="bound">ys'</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="main">∧</span> substitute'' <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">xs'</span> <span class="bound">ys'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less.hyps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ less.prems<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">=</span><span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span>  <span class="free">S</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">ys'</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">xs'</span> <span class="skolem">ys'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        
        <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">ys'</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> empty"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="free">S</span>›</span></span> less.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"f_nxt <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹substitute'' <span class="skolem">f</span> <span class="free">T</span> <span class="skolem">xs'</span> <span class="skolem">ys'</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="skolem">f</span> <span class="free">T</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">ys'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> substitute''.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span><span class="main">∈</span><span class="free">S</span><span class="main">)</span> <span class="skolem">xs''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="free">f</span> <span class="free">T</span> <span class="skolem">xs'</span> <span class="skolem">xs''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs'</span> <span class="main">∈</span> paths <span class="free">t</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs''</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substitute_substitute''<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  filter_paths_conv_free_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="TTree-HOLCF">
<div class="head">
<h1>Theory TTree-HOLCF</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"TTree-HOLCF"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#TTree">TTree</a> <span class="quoted">"<a href="../Launchbury/HOLCF-Utils.html">Launchbury.HOLCF-Utils</a>"</span> <span class="quoted">"<a href="Set-Cpo.html">Set-Cpo</a>"</span> <span class="quoted">"<a href="../Launchbury/HOLCF-Join-Classes.html">Launchbury.HOLCF-Join-Classes</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ttree <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">below</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">below_ttree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> ttree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">instance</span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="TTree-HOLCF-paths_mono"><span class="command">lemma</span></span> paths_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> <span class="free">t'</span> <span class="main">⟹</span> paths <span class="free">t</span> <span class="main">⊑</span> paths <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> below_set_def<span class="main">)</span>

<span class="keyword1" id="TTree-HOLCF-paths_mono_iff"><span class="command">lemma</span></span> paths_mono_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="free">t</span> <span class="main">⊑</span> paths <span class="free">t'</span> <span class="main">⟷</span> <span class="free">t</span> <span class="main">⊑</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> below_set_def<span class="main">)</span>

<span class="keyword1" id="TTree-HOLCF-ttree_belowI"><span class="command">lemma</span></span> ttree_belowI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> paths <span class="free">t</span> <span class="main">⟹</span> <span class="bound">xs</span> <span class="main">∈</span> paths <span class="free">t'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">⊑</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-HOLCF-paths_belowI"><span class="command">lemma</span></span> paths_belowI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">x</span><span class="main">#</span><span class="bound">xs</span> <span class="main">∈</span> paths <span class="free">t</span> <span class="main">⟹</span> <span class="bound">x</span><span class="main">#</span><span class="bound">xs</span> <span class="main">∈</span> paths <span class="free">t'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">⊑</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ttree_belowI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">instance</span></span> ttree <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">po</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="TTree-HOLCF-is_lub_ttree"><span class="command">lemma</span></span> is_lub_ttree<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">&lt;&lt;|</span> Either <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_lub_def is_ub_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-HOLCF-lub_is_either"><span class="command">lemma</span></span> lub_is_either<span class="main">:</span> <span class="quoted"><span class="quoted">"lub <span class="free">S</span> <span class="main">=</span> Either <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_lub_ttree <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lub_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> ttree <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">cpo</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> is_lub_ttree<span class="main">)</span>

<span class="keyword1" id="TTree-HOLCF-minimal_ttree"><span class="command">lemma</span></span> minimal_ttree<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"empty <span class="main">⊑</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instance</span></span> ttree <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">pcpo</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="TTree-HOLCF-empty_is_bottom"><span class="command">lemma</span></span> empty_is_bottom<span class="main">:</span> <span class="quoted"><span class="quoted">"empty <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_bottom_iff minimal_ttree<span class="main">)</span>

<span class="keyword1" id="TTree-HOLCF-carrier_bottom"><span class="command">lemma</span></span> carrier_bottom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">⊥</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> empty_is_bottom<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="TTree-HOLCF-below_anything"><span class="command">lemma</span></span> below_anything<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> anything"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-HOLCF-carrier_mono"><span class="command">lemma</span></span> carrier_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> <span class="free">t'</span> <span class="main">⟹</span> carrier <span class="free">t</span> <span class="main">⊆</span> carrier <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-HOLCF-nxt_mono"><span class="command">lemma</span></span> nxt_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> <span class="free">t'</span> <span class="main">⟹</span> nxt <span class="free">t</span> <span class="free">x</span> <span class="main">⊑</span> nxt <span class="free">t'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-HOLCF-either_above_arg1"><span class="command">lemma</span></span> either_above_arg1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> <span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">fastforce</span>

<span class="keyword1" id="TTree-HOLCF-either_above_arg2"><span class="command">lemma</span></span> either_above_arg2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">⊑</span> <span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">fastforce</span>

<span class="keyword1" id="TTree-HOLCF-either_belowI"><span class="command">lemma</span></span> either_belowI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> <span class="free">t''</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="main">⊑</span> <span class="free">t''</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span> <span class="main">⊑</span> <span class="free">t''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-HOLCF-both_above_arg1"><span class="command">lemma</span></span> both_above_arg1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> <span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">fastforce</span>

<span class="keyword1" id="TTree-HOLCF-both_above_arg2"><span class="command">lemma</span></span> both_above_arg2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">⊑</span> <span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">fastforce</span>

<span class="keyword1" id="TTree-HOLCF-both_mono1'"><span class="command">lemma</span></span> both_mono1'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t''</span> <span class="main">⊑</span> <span class="free">t'</span> <span class="main">⊗⊗</span> <span class="free">t''</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  both_mono1<span class="main">[</span><span class="operator">folded</span> below_set_def<span class="main">,</span> <span class="operator">unfolded</span> paths_mono_iff<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="TTree-HOLCF-both_mono2'"><span class="command">lemma</span></span> both_mono2'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">t''</span> <span class="main">⊗⊗</span> <span class="free">t</span> <span class="main">⊑</span> <span class="free">t''</span> <span class="main">⊗⊗</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  both_mono2<span class="main">[</span><span class="operator">folded</span> below_set_def<span class="main">,</span> <span class="operator">unfolded</span> paths_mono_iff<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="TTree-HOLCF-nxt_both_left"><span class="command">lemma</span></span> nxt_both_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible <span class="free">t</span> <span class="free">x</span> <span class="main">⟹</span> nxt <span class="free">t</span> <span class="free">x</span> <span class="main">⊗⊗</span> <span class="free">t'</span> <span class="main">⊑</span> nxt <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nxt_both either_above_arg2<span class="main">)</span>

<span class="keyword1" id="TTree-HOLCF-nxt_both_right"><span class="command">lemma</span></span> nxt_both_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible <span class="free">t'</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">⊗⊗</span> nxt <span class="free">t'</span> <span class="free">x</span> <span class="main">⊑</span> nxt <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nxt_both either_above_arg1<span class="main">)</span>



<span class="keyword1" id="TTree-HOLCF-substitute_mono1'"><span class="command">lemma</span></span> substitute_mono1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⊑</span> <span class="free">f'</span><span class="main">⟹</span> substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span> <span class="main">⊑</span> substitute <span class="free">f'</span> <span class="free">T</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  substitute_mono1<span class="main">[</span><span class="operator">folded</span> below_set_def<span class="main">,</span> <span class="operator">unfolded</span> paths_mono_iff<span class="main">]</span> fun_belowD
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="TTree-HOLCF-substitute_mono2'"><span class="command">lemma</span></span> substitute_mono2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> <span class="free">t'</span><span class="main">⟹</span> substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span> <span class="main">⊑</span> substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  substitute_mono2<span class="main">[</span><span class="operator">folded</span> below_set_def<span class="main">,</span> <span class="operator">unfolded</span> paths_mono_iff<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="TTree-HOLCF-substitute_above_arg"><span class="command">lemma</span></span> substitute_above_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  substitute_contains_arg<span class="main">[</span><span class="operator">folded</span> below_set_def<span class="main">,</span> <span class="operator">unfolded</span> paths_mono_iff<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="TTree-HOLCF-ttree_contI"><span class="command">lemma</span></span> ttree_contI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">S</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Either <span class="bound">S</span><span class="main">)</span> <span class="main">=</span> Either <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> contI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> ttree"</span></span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> range <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Either <span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>Either <span class="main">(</span>range <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Either <span class="main">(</span>range <span class="skolem">Y</span><span class="main">)</span> <span class="main">=</span> lub <span class="main">(</span>range <span class="skolem">Y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lub_is_either <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;&lt;|</span> <span class="free">f</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_lub_ttree<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TTree-HOLCF-ttree_contI2"><span class="command">lemma</span></span> ttree_contI2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> paths <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="free">t</span> <span class="main">`</span> paths <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">t</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> contI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> ttree"</span></span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"paths <span class="main">(</span>Either <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">[]</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> paths <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_Either<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> insert <span class="main">[]</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span><span class="free">t</span> <span class="main">`</span> paths <span class="main">(</span><span class="skolem">Y</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="free">t</span> <span class="main">`</span> insert <span class="main">[]</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> paths <span class="main">(</span><span class="skolem">Y</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUP_cong_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="free">t</span> <span class="main">`</span> paths <span class="main">(</span>Either <span class="main">(</span>range <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_Either<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> paths <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Either <span class="main">(</span>range <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> paths <span class="main">(</span><span class="free">f</span> <span class="main">(</span>lub <span class="main">(</span>range <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lub_is_either <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;&lt;|</span> <span class="free">f</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_lub_ttree paths_inj<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="TTree-HOLCF-cont_paths"><span class="command">lemma</span></span> cont_paths<span class="main">[</span><span class="operator">THEN</span> cont_compose<span class="main">,</span> <span class="operator">cont2cont</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont paths"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_contI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="main">_</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> lub_is_either
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-HOLCF-ttree_contI3"><span class="command">lemma</span></span> ttree_contI3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> paths <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> contI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monofunI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> paths_mono_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> cont2monofunE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> paths_mono_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cont2contlubE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_paths<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_id<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cont2contlubE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1" id="TTree-HOLCF-cont_substitute"><span class="command">lemma</span></span> cont_substitute<span class="main">[</span><span class="operator">THEN</span> cont_compose<span class="main">,</span> <span class="operator">cont2cont</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ttree_contI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> paths_substitute_substitute''<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> substitute''.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-HOLCF-cont_both1"><span class="command">lemma</span></span> cont_both1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> both <span class="bound">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ttree_contI2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">xs</span></span> <span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">zs</span></span> <span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">ys</span></span><span class="main"><span class="main">∈</span></span>paths <span class="free"><span class="free">y</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">zs</span></span> <span class="main"><span class="main">∈</span></span> <span class="bound"><span class="bound">xs</span></span> <span class="main"><span class="main">⊗</span></span> <span class="bound"><span class="bound">ys</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_both<span class="main">)</span>

<span class="keyword1" id="TTree-HOLCF-cont_both2"><span class="command">lemma</span></span> cont_both2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> both <span class="free">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ttree_contI2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">ys</span></span> <span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">zs</span></span> <span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">∈</span></span>paths <span class="free"><span class="free">y</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">zs</span></span> <span class="main"><span class="main">∈</span></span> <span class="bound"><span class="bound">xs</span></span> <span class="main"><span class="main">⊗</span></span> <span class="bound"><span class="bound">ys</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_both<span class="main">)</span>

<span class="keyword1" id="TTree-HOLCF-cont_both"><span class="command">lemma</span></span> cont_both<span class="main">[</span><span class="operator">cont2cont</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> cont <span class="free">g</span> <span class="main">⟹</span> cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊗⊗</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cont_compose2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_both1 cont_both2<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="TTree-HOLCF-cont_intersect1"><span class="command">lemma</span></span> cont_intersect1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> intersect <span class="bound">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ttree_contI2 <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">xs</span></span></span> <span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1">if</span></span></span> <span class="bound"><span class="bound"><span class="bound">xs</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> paths <span class="free"><span class="free"><span class="free">y</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">then</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="bound"><span class="bound"><span class="bound">xs</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">else</span></span></span> <span class="main"><span class="main"><span class="main">{}</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="TTree-HOLCF-cont_intersect2"><span class="command">lemma</span></span> cont_intersect2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> intersect <span class="free">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ttree_contI2 <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">xs</span></span></span> <span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1">if</span></span></span> <span class="bound"><span class="bound"><span class="bound">xs</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> paths <span class="free"><span class="free"><span class="free">y</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">then</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="bound"><span class="bound"><span class="bound">xs</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">else</span></span></span> <span class="main"><span class="main"><span class="main">{}</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="TTree-HOLCF-cont_intersect"><span class="command">lemma</span></span> cont_intersect<span class="main">[</span><span class="operator">cont2cont</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> cont <span class="free">g</span> <span class="main">⟹</span> cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∩∩</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cont_compose2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_intersect1 cont_intersect2<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="TTree-HOLCF-cont_without"><span class="command">lemma</span></span> cont_without<span class="main">[</span><span class="operator">THEN</span> cont_compose<span class="main">,</span> <span class="operator">cont2cont</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>without <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ttree_contI2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">xs</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span><span class="main"><span class="main"><span class="main">{</span></span></span>filter <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x'</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">x'</span></span></span> <span class="main"><span class="main"><span class="main">≠</span></span></span> <span class="free"><span class="free"><span class="free">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="bound"><span class="bound"><span class="bound">xs</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="TTree-HOLCF-paths_many_calls_subset"><span class="command">lemma</span></span> paths_many_calls_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> many_calls <span class="free">x</span> <span class="main">⊗⊗</span> without <span class="free">x</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> below_set_def paths_many_calls_subset paths_mono_iff<span class="main">)</span>

<span class="keyword1" id="TTree-HOLCF-single_below"><span class="command">lemma</span></span> single_below<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> paths <span class="free">t</span> <span class="main">⟹</span> single <span class="free">x</span> <span class="main">⊑</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-HOLCF-cont_ttree_restr"><span class="command">lemma</span></span> cont_ttree_restr<span class="main">[</span><span class="operator">THEN</span> cont_compose<span class="main">,</span> <span class="operator">cont2cont</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>ttree_restr <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ttree_contI2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">xs</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span><span class="main"><span class="main"><span class="main">{</span></span></span>filter <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x'</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">x'</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> <span class="free"><span class="free"><span class="free">S</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="bound"><span class="bound"><span class="bound">xs</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> ttree_restr_mono <span class="main">=</span> cont2monofunE<span class="main">[</span><span class="operator">OF</span> cont_ttree_restr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_id<span class="main"><span class="main">]</span></span><span class="main">]</span>


<span class="keyword1" id="TTree-HOLCF-range_filter"><span class="command">lemma</span></span> range_filter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>filter <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> Collect <span class="free">P</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> rev_image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_id_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-HOLCF-ttree_restr_anything_cont"><span class="command">lemma</span></span> ttree_restr_anything_cont<span class="main">[</span><span class="operator">THEN</span> cont_compose<span class="main">,</span> <span class="operator">simp</span><span class="main">,</span> <span class="operator">cont2cont</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">S</span><span class="main">.</span> ttree_restr <span class="bound">S</span> anything<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ttree_contI3<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_contI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_paths_conv_free_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> lub_set<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset_chain<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">instance</span></span> ttree <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">Finite_Join_cpo</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ttree"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compatible <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compatible_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_lub_ttree<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TTree-HOLCF-ttree_join_is_either"><span class="command">lemma</span></span> ttree_join_is_either<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊔</span> <span class="free">t'</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span> <span class="main">=</span> Either <span class="main">{</span><span class="free">t</span><span class="main">,</span> <span class="free">t'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊔</span> <span class="free">t'</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lub_is_join is_lub_ttree<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="TTree-HOLCF-ttree_join_transfer"><span class="command">lemma</span></span> ttree_join_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fun <span class="main">(</span>pcr_ttree <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>rel_fun <span class="main">(</span>pcr_ttree <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>pcr_ttree <span class="main">(=)</span><span class="main">)</span><span class="main">)</span> <span class="main">(∪)</span> <span class="main">(⊔)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊔)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(⊕⊕)</span> <span class="main">::</span> <span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> ttree <span class="main">⇒</span> <span class="tfree">'a</span> ttree<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ttree_join_is_either <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> either.transfer  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TTree-HOLCF-ttree_restr_join"><span class="command">lemma</span></span> ttree_restr_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ttree_restr <span class="free">S</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊔</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> ttree_restr <span class="free">S</span> <span class="free">t</span> <span class="main">⊔</span> ttree_restr <span class="free">S</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="TTree-HOLCF-nxt_singles_below_singles"><span class="command">lemma</span></span> nxt_singles_below_singles<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nxt <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span> <span class="free">x</span> <span class="main">⊑</span> singles <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">xc</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>  ballE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> length_filter_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTree-HOLCF-in_carrier_fup"><span class="command">lemma</span></span> in_carrier_fup<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">∈</span> carrier <span class="main">(</span>fup<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">u</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">u'</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> up<span class="main">⋅</span><span class="bound">u'</span> <span class="main">∧</span> <span class="free">x'</span> <span class="main">∈</span> carrier <span class="main">(</span><span class="free">f</span><span class="main">⋅</span><span class="bound">u'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="AnalBinds">
<div class="head">
<h1>Theory AnalBinds</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> AnalBinds
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../launchbury/theories/#Terms">Launchbury.Terms</a> <span class="quoted">"<a href="../Launchbury/HOLCF-Utils.html">Launchbury.HOLCF-Utils</a>"</span> <a href="../../launchbury/theories/#Env">Launchbury.Env</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> ExpAnalysis <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">exp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>cpo <span class="main">→</span> <span class="tfree">'b</span><span class="main">::</span>pcpo"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">AnalBinds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">AnalBinds</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ae<span class="main">.</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">AnalBinds</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ae<span class="main">.</span> <span class="main">(</span><span class="free">AnalBinds</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⋅</span><span class="bound">ae</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> fup<span class="main">⋅</span><span class="main">(</span><span class="free">exp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ae</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="AnalBinds-AnalBinds_Nil_simp"><span class="command">lemma</span></span> AnalBinds_Nil_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"AnalBinds <span class="main">[]</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="AnalBinds-AnalBinds_Cons"><span class="command">lemma</span></span> AnalBinds_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"AnalBinds <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> <span class="main">(</span>AnalBinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fup<span class="main">⋅</span><span class="main">(</span><span class="free">exp</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> AnalBinds.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1" id="AnalBinds-AnalBinds_not_there"><span class="command">lemma</span></span> AnalBinds_not_there<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">(</span>AnalBinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> AnalBinds.induct<span class="main">)</span> <span class="operator">auto</span>
 
<span class="keyword1" id="AnalBinds-AnalBinds_cong"><span class="command">lemma</span></span> AnalBinds_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="keyword1">f|`</span> domA <span class="free">Γ</span> <span class="main">=</span> <span class="free">ae'</span> <span class="keyword1">f|`</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"AnalBinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> AnalBinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> env_restr_eqD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> AnalBinds.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="AnalBinds-AnalBinds_lookup"><span class="command">lemma</span></span> AnalBinds_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>AnalBinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> map_of <span class="free">Γ</span> <span class="free">x</span> <span class="keyword1">of</span> Some <span class="bound">e</span> <span class="main">⇒</span> fup<span class="main">⋅</span><span class="main">(</span><span class="free">exp</span> <span class="bound">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">ae</span> <span class="free">x</span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> AnalBinds.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="AnalBinds-AnalBinds_delete_bot"><span class="command">lemma</span></span> AnalBinds_delete_bot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> AnalBinds <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> AnalBinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AnalBinds_lookup <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_conv<span class="main">)</span>

<span class="keyword1" id="AnalBinds-AnalBinds_delete_below"><span class="command">lemma</span></span> AnalBinds_delete_below<span class="main">:</span> <span class="quoted"><span class="quoted">"AnalBinds <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">⊑</span> AnalBinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fun_belowI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AnalBinds_lookup <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.split<span class="main">)</span>

<span class="keyword1" id="AnalBinds-AnalBinds_delete_lookup"><span class="command">lemma</span></span> AnalBinds_delete_lookup<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>AnalBinds <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AnalBinds_lookup <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.split<span class="main">)</span>

<span class="keyword1" id="AnalBinds-AnalBinds_delete_to_fun_upd"><span class="command">lemma</span></span> AnalBinds_delete_to_fun_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"AnalBinds <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ae</span> <span class="main">=</span> <span class="main">(</span>AnalBinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AnalBinds_lookup <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.split<span class="main">)</span>
 
<span class="keyword1" id="AnalBinds-edom_AnalBinds"><span class="command">lemma</span></span> edom_AnalBinds<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>AnalBinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="main">⊆</span> domA <span class="free">Γ</span> <span class="main">∩</span> edom <span class="free">ae</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> AnalBinds.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TTreeAnalysisSig">
<div class="head">
<h1>Theory TTreeAnalysisSig</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TTreeAnalysisSig
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Arity">Arity</a>  <span class="quoted">"<a href="TTree-HOLCF.html">TTree-HOLCF</a>"</span>  <a href="#AnalBinds">AnalBinds</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> TTreeAnalysis <span class="main">=</span>
 <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Texp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> Arity <span class="main">→</span> var ttree"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">sublocale</span></span> Texp<span class="main">:</span> ExpAnalysis <span class="quoted"><span class="free">Texp</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">FBinds</span> <span class="main">==</span> Texp.AnalBinds"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CoCallGraph-TTree">
<div class="head">
<h1>Theory CoCallGraph-TTree</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"CoCallGraph-TTree"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#CoCallGraph">CoCallGraph</a> <span class="quoted">"<a href="TTree-HOLCF.html">TTree-HOLCF</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="CoCallGraph-TTree-interleave_ccFromList"><span class="command">lemma</span></span> interleave_ccFromList<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> interleave <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟹</span> ccFromList <span class="free">xs</span> <span class="main">=</span> ccFromList <span class="free">ys</span> <span class="main">⊔</span> ccFromList <span class="free">zs</span> <span class="main">⊔</span> ccProd <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>set <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleave_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleave_set ccProd_comm ccProd_insert2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span>  ccProd_insert1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>


<span class="keyword1"><span class="command">lift_definition</span></span> ccApprox <span class="main">::</span> <span class="quoted"><span class="quoted">"var ttree <span class="main">⇒</span> CoCalls"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">xss</span> <span class="main">.</span>  lub <span class="main">(</span>ccFromList <span class="main">`</span> <span class="bound">xss</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoCallGraph-TTree-ccApprox_paths"><span class="command">lemma</span></span> ccApprox_paths<span class="main">:</span> <span class="quoted"><span class="quoted">"ccApprox <span class="free">t</span> <span class="main">=</span> lub <span class="main">(</span>ccFromList <span class="main">`</span> <span class="main">(</span>paths <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="CoCallGraph-TTree-ccApprox_strict"><span class="command">lemma</span></span> ccApprox_strict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccApprox_paths empty_is_bottom<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-in_ccApprox"><span class="command">lemma</span></span> in_ccApprox<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∈</span><span class="main">(</span>ccApprox <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">xs</span> <span class="main">∈</span> paths <span class="free">t</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">∈</span><span class="main">(</span>ccFromList <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccApprox_paths
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-TTree-ccApprox_mono"><span class="command">lemma</span></span> ccApprox_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="free">t</span> <span class="main">⊆</span> paths <span class="free">t'</span> <span class="main">⟹</span> ccApprox <span class="free">t</span> <span class="main">⊑</span> ccApprox <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_CoCallsI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_ccApprox<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-ccApprox_mono'"><span class="command">lemma</span></span> ccApprox_mono'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span>  <span class="free">t'</span> <span class="main">⟹</span> ccApprox <span class="free">t</span> <span class="main">⊑</span> ccApprox <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_set_def ccApprox_mono paths_mono_iff<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-ccApprox_belowI"><span class="command">lemma</span></span> ccApprox_belowI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> paths <span class="free">t</span> <span class="main">⟹</span> ccFromList <span class="bound">xs</span> <span class="main">⊑</span> <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> ccApprox <span class="free">t</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccApprox_paths
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-TTree-ccApprox_below_iff"><span class="command">lemma</span></span> ccApprox_below_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"ccApprox <span class="free">t</span> <span class="main">⊑</span> <span class="free">G</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">xs</span> <span class="main">∈</span> paths <span class="free">t</span><span class="main">.</span> ccFromList <span class="bound">xs</span> <span class="main">⊑</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccApprox_paths <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-TTree-cc_restr_ccApprox_below_iff"><span class="command">lemma</span></span> cc_restr_ccApprox_below_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="main">(</span>ccApprox <span class="free">t</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">xs</span> <span class="main">∈</span> paths <span class="free">t</span><span class="main">.</span> cc_restr <span class="free">S</span> <span class="main">(</span>ccFromList <span class="bound">xs</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccApprox_paths cc_restr_lub
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-TTree-ccFromList_below_ccApprox"><span class="command">lemma</span></span> ccFromList_below_ccApprox<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="free">t</span> <span class="main">⟹</span> ccFromList <span class="free">xs</span> <span class="main">⊑</span> ccApprox <span class="free">t</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_CoCallsI<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_ccApprox<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-ccApprox_nxt_below"><span class="command">lemma</span></span> ccApprox_nxt_below<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span>nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊑</span> ccApprox <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_CoCallsI<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_ccApprox paths_nxt_eq <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-ccApprox_ttree_restr_nxt_below"><span class="command">lemma</span></span> ccApprox_ttree_restr_nxt_below<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="main">(</span>nxt <span class="free">t</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> ccApprox <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_CoCallsI<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_ccApprox filter_paths_conv_free_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> paths_nxt_eq  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-ccApprox_ttree_restr"><span class="command">lemma</span></span> ccApprox_ttree_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span>ttree_restr <span class="free">S</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="main">(</span>ccApprox <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CoCalls_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_ccApprox filter_paths_conv_free_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-ccApprox_both"><span class="command">lemma</span></span> ccApprox_both<span class="main">:</span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> ccApprox <span class="free">t</span> <span class="main">⊔</span> ccApprox <span class="free">t'</span> <span class="main">⊔</span> ccProd <span class="main">(</span>carrier <span class="free">t</span><span class="main">)</span> <span class="main">(</span>carrier <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span> <span class="main">⊑</span> ccApprox <span class="free">t</span> <span class="main">⊔</span> ccApprox <span class="free">t'</span> <span class="main">⊔</span> ccProd <span class="main">(</span>carrier <span class="free">t</span><span class="main">)</span> <span class="main">(</span>carrier <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_CoCallsI<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> 4 4  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_ccApprox paths_both Union_paths_carrier<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  interleave_ccFromList<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccApprox <span class="free">t</span> <span class="main">⊑</span> ccApprox <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccApprox_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> both_contains_arg1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccApprox <span class="free">t'</span> <span class="main">⊑</span> ccApprox <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccApprox_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> both_contains_arg2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">(</span>carrier <span class="free">t</span><span class="main">)</span> <span class="main">(</span>carrier <span class="free">t'</span><span class="main">)</span> <span class="main">⊑</span> ccApprox <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccProd_belowI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> carrier <span class="free">t'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> paths <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Union_paths_carrier<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> paths_both append_interleave<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> set <span class="skolem">ys</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">--</span><span class="skolem">y</span><span class="main">∈</span><span class="main">(</span>ccFromList <span class="main">(</span><span class="skolem">xs</span><span class="main">@</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">--</span><span class="skolem">y</span><span class="main">∈</span><span class="main">(</span>ccApprox <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_ccApprox <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ccFromList_append<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ccApprox <span class="free">t</span> <span class="main">⊔</span> ccApprox <span class="free">t'</span> <span class="main">⊔</span> ccProd <span class="main">(</span>carrier <span class="free">t</span><span class="main">)</span> <span class="main">(</span>carrier <span class="free">t'</span><span class="main">)</span> <span class="main">⊑</span> ccApprox <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-TTree-ccApprox_many_calls"><span class="command">lemma</span></span> ccApprox_many_calls<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span>many_calls <span class="free">x</span><span class="main">)</span> <span class="main">=</span> ccProd <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> CoCalls_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-ccApprox_single"><span class="command">lemma</span></span> ccApprox_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span>TTree.single <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-TTree-ccApprox_either"><span class="command">lemma</span></span> ccApprox_either<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span><span class="free">t</span> <span class="main">⊕⊕</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> ccApprox <span class="free">t</span> <span class="main">⊔</span> ccApprox <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> CoCalls_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* could work, but tricky
lemma ccApprox_lub_nxt: "ccApprox t = (⨆ x ∈UNIV. ccApprox (nxt t x) ⊔ (ccProd {x} (carrier (nxt t x))))"
*)</span>

<span class="keyword1" id="CoCallGraph-TTree-wild_recursion"><span class="command">lemma</span></span> wild_recursion<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ccApprox  <span class="free">t</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> empty"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> ccApprox <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> ccProd <span class="main">(</span>ccNeighbors <span class="bound">x</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>carrier <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span>ttree_restr <span class="main">(</span><span class="main">-</span><span class="free">S</span><span class="main">)</span> <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccApprox_belowI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">seen</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seen</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>ttree_restr <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="skolem"><span class="skolem">xs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="free">f</span> <span class="free">T</span> <span class="skolem">xs''</span> <span class="skolem">xs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs''</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_paths_conv_free_restr2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> substitute_substitute''<span class="main">)</span>
 
  <span class="keyword1"><span class="command">note</span></span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹ccApprox <span class="free">t</span> <span class="main">⊑</span> <span class="free">G</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs''</span> <span class="main">∈</span> paths <span class="free">t</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"ccFromList <span class="skolem">xs''</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccApprox_below_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">ys</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> ccFromList <span class="bound">ys</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">ys</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> ccProd <span class="main">(</span>ccNeighbors <span class="bound">x</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>set <span class="bound">ys</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccApprox_below_iff Union_paths_carrier<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cc_lub_below_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="skolem">seen</span> <span class="main">(</span>set <span class="skolem">xs''</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> seen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">]</span> <span class="main">⊑</span> <span class="free">G</span> <span class="main">∧</span> ccProd <span class="main">(</span><span class="skolem">seen</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">xs'</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="skolem">xs''</span></span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">seen</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitute''.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Nil Cons<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">zs</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">xs'</span> <span class="skolem">xs</span> <span class="skolem">T</span> <span class="skolem">ys</span><span class="main">)</span>
    
    <span class="keyword1"><span class="command">have</span></span> seen_x<span class="main">:</span> <span class="quoted"><span class="quoted">"ccProd <span class="skolem">seen</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ccProd <span class="skolem">seen</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccProd_insert2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span> join_below_iff<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹ccFromList <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> subset1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹ccProd <span class="skolem">seen</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> subset2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">seen</span>  <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_ccNeighbors ccProd_insert2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span> join_below_iff ccProd_comm<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> subset1 <span class="keyword2"><span class="keyword">and</span></span> subset2
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seen</span> <span class="main">∪</span> set <span class="skolem">xs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">(</span><span class="skolem">seen</span> <span class="main">∪</span> set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">zs</span><span class="main">)</span> <span class="main">⊑</span> ccProd <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">zs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccProd_mono1<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">(</span><span class="skolem">seen</span> <span class="main">∪</span> set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">zs</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp</span>
     
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> Cons.prems Cons.hyps
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ys</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">]</span> <span class="main">⊑</span> <span class="free">G</span> <span class="main">∧</span> ccProd <span class="main">(</span><span class="skolem">seen</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ys</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def  join_below_iff  interleave_ccFromList interleave_set  ccProd_insert2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span>
                  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">with</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span>  seen_x
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">]</span> <span class="main">⊑</span> <span class="free">G</span>  <span class="main">∧</span> ccProd <span class="skolem">seen</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccProd_insert2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span> join_below_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False

      <span class="keyword1"><span class="command">from</span></span> False Cons.prems Cons.hyps
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ys</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">]</span> <span class="main">⊑</span> <span class="free">G</span> <span class="main">∧</span> ccProd <span class="main">(</span><span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">seen</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ys</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> seen <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"insert <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">seen</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccApprox_both join_below_iff ttree_restr_both interleave_ccFromList insert_Diff_if
                   <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  ccProd_insert2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span>
                   <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  ccProd_insert1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seen</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> False *
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">ys</span><span class="main">)</span> <span class="main">⊑</span>  <span class="free">G</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_Diff_if ccProd_insert1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seen</span>"</span></span><span class="main"><span class="main">]</span></span> join_below_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> set <span class="skolem">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">}</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ ccProd_mono2<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">note</span></span> False seen_x
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">]</span> <span class="main">⊑</span> <span class="free">G</span> <span class="main">∧</span> ccProd <span class="main">(</span><span class="skolem">seen</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_Diff_if  ccProd_insert2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span>   ccProd_insert1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seen</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ccFromList <span class="skolem">xs</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-TTree-wild_recursion_thunked"><span class="command">lemma</span></span> wild_recursion_thunked<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ccApprox  <span class="free">t</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> empty"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> ccApprox <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> ccProd <span class="main">(</span>ccNeighbors <span class="bound">x</span> <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∩</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span>carrier <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span>ttree_restr <span class="main">(</span><span class="main">-</span><span class="free">S</span><span class="main">)</span> <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccApprox_belowI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">seen</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seen</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">seen_T</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seen_T</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>ttree_restr <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="skolem"><span class="skolem">xs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"substitute'' <span class="free">f</span> <span class="free">T</span> <span class="skolem">xs''</span> <span class="skolem">xs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs''</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_paths_conv_free_restr2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> substitute_substitute''<span class="main">)</span>
 
  <span class="keyword1"><span class="command">note</span></span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹ccApprox <span class="free">t</span> <span class="main">⊑</span> <span class="free">G</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs''</span> <span class="main">∈</span> paths <span class="free">t</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"ccFromList <span class="skolem">xs''</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccApprox_below_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"ccFromList <span class="skolem">xs''</span> <span class="keyword1">G|`</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">seen_T</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ cc_restr_below_arg<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">ys</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> ccFromList <span class="bound">ys</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">ys</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> ccProd <span class="main">(</span>ccNeighbors <span class="bound">x</span> <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∩</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span>set <span class="bound">ys</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccApprox_below_iff seen_T_def Union_paths_carrier<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cc_lub_below_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="skolem">seen</span> <span class="main">(</span>set <span class="skolem">xs''</span> <span class="main">-</span> <span class="skolem">seen_T</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> seen_def seen_T_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seen</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> seen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seen_T</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> seen_T_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">seen_T</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> empty"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> seen_T_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">]</span> <span class="main">⊑</span> <span class="free">G</span> <span class="main">∧</span> ccProd <span class="main">(</span><span class="skolem">seen</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">xs'</span> <span class="main">-</span> <span class="skolem">seen_T</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="skolem">xs''</span></span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">seen</span></span> <span class="quoted"><span class="skolem">seen_T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitute''.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Nil Cons<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">zs</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">xs'</span> <span class="skolem">xs</span> <span class="skolem">T</span> <span class="skolem">ys</span><span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span>  <span class="var"><span class="quoted"><span class="var">?seen_T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">T</span> <span class="keyword1">then</span> insert <span class="skolem">x</span> <span class="skolem">seen_T</span> <span class="keyword1">else</span> <span class="skolem">seen_T</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> insert <span class="skolem">x</span> <span class="skolem">seen_T</span> <span class="main">⊆</span> <span class="main">-</span> <span class="skolem">seen_T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> subset2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">∩</span> <span class="main">-</span> insert <span class="skolem">x</span> <span class="skolem">seen_T</span> <span class="main">⊆</span> insert <span class="skolem">x</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">-</span> <span class="skolem">seen_T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> subset3<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">∩</span> <span class="main">-</span> insert <span class="skolem">x</span> <span class="skolem">seen_T</span> <span class="main">⊆</span> set <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> subset4<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">∩</span> <span class="main">-</span> <span class="skolem">seen_T</span> <span class="main">⊆</span> insert <span class="skolem">x</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">-</span> <span class="skolem">seen_T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> subset5<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">∩</span> <span class="main">-</span> <span class="skolem">seen_T</span> <span class="main">⊆</span> set <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> subset6<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">-</span> <span class="skolem">seen_T</span> <span class="main">⊆</span> <span class="main">(</span>set <span class="skolem">ys</span> <span class="main">-</span> <span class="var">?seen_T</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">seen_T</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">seen_T</span>"</span></span>
      
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> empty"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">seen_T</span>›</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs'</span> <span class="main">∈</span> <span class="skolem">xs</span> <span class="main">⊗</span> <span class="skolem">zs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">seen_T</span>›</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">from</span></span> Cons.hyps Cons.prems
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ys</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">]</span> <span class="main">⊑</span> <span class="free">G</span> <span class="main">∧</span> ccProd <span class="skolem">seen</span> <span class="main">(</span>set <span class="skolem">ys</span> <span class="main">-</span> <span class="skolem">seen_T</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> seen_T <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">seen_T</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff Diff_eq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccProd_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl subset4<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">seen_T</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">seen_T</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> seen_x<span class="main">:</span> <span class="quoted"><span class="quoted">"ccProd <span class="skolem">seen</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ccProd <span class="skolem">seen</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">seen_T</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">seen_T</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_Diff_if ccProd_insert2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">-</span> <span class="skolem">seen_T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span> join_below_iff<span class="main">)</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
  
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cc_restr <span class="main">(</span><span class="main">-</span> <span class="skolem">seen_T</span><span class="main">)</span> <span class="main">(</span>ccFromList <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">xs</span> <span class="main">-</span> <span class="skolem">seen_T</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">seen_T</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff Diff_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">-</span> <span class="skolem">seen_T</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        
        <span class="keyword1"><span class="command">from</span></span> seen_x
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seen</span>  <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_ccNeighbors   ccProd_comm<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">seen</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">seen</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seen</span> <span class="main">∪</span> <span class="main">(</span>set <span class="skolem">xs</span> <span class="main">∩</span> <span class="main">-</span> <span class="var">?seen_T</span><span class="main">)</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">∩</span><span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">(</span><span class="skolem">seen</span> <span class="main">∪</span> <span class="main">(</span>set <span class="skolem">xs</span> <span class="main">∩</span> <span class="main">-</span> <span class="var">?seen_T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">zs</span><span class="main">)</span> <span class="main">⊑</span> ccProd <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">∩</span><span class="skolem">T</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">zs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccProd_mono1<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">(</span><span class="skolem">seen</span> <span class="main">∪</span> <span class="main">(</span>set <span class="skolem">xs</span> <span class="main">∩</span> <span class="main">-</span> <span class="var">?seen_T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">zs</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp</span>
  
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> Cons.prems Cons.hyps<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ys</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">]</span> <span class="main">⊑</span> <span class="free">G</span> <span class="main">∧</span> ccProd <span class="main">(</span><span class="skolem">seen</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ys</span> <span class="main">-</span> <span class="var">?seen_T</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> seen_T <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?seen_T</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_Diff Int_Un_distrib2 Diff_eq f_nxt_def  join_below_iff  interleave_ccFromList interleave_set  ccProd_insert2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span>
                    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cc_restr_mono1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cc_restr_below_arg<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccProd_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl Int_lower1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cc_restr_below_arg<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccProd_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl Int_lower1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccProd_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl subset2<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccProd_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl subset3<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccProd_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl subset4<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccProd_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl subset5<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">with</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span>  seen_x <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">seen_T</span>›</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">]</span> <span class="main">⊑</span> <span class="free">G</span>  <span class="main">∧</span> ccProd <span class="skolem">seen</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">seen_T</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_Diff_if ccProd_insert2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">-</span> <span class="skolem">seen_T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span> join_below_iff<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccProd_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl subset6<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ccProd_union2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
  
        <span class="keyword1"><span class="command">from</span></span> False Cons.prems Cons.hyps
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ys</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">]</span> <span class="main">⊑</span> <span class="free">G</span> <span class="main">∧</span> ccProd <span class="main">(</span><span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">seen</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ys</span> <span class="main">-</span> <span class="skolem">seen_T</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> seen <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"insert <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">seen</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> seen_T <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">seen_T</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">seen_T</span>›</span></span> Diff_eq ccApprox_both join_below_iff ttree_restr_both interleave_ccFromList insert_Diff_if
                     <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  ccProd_insert2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">∩</span> <span class="main">-</span> <span class="skolem">seen_T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span>
                     <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  ccProd_insert1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seen</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> False *
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">ys</span> <span class="main">-</span> <span class="skolem">seen_T</span><span class="main">)</span> <span class="main">⊑</span>  <span class="free">G</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_Diff_if ccProd_insert1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seen</span>"</span></span><span class="main"><span class="main">]</span></span> join_below_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> set <span class="skolem">ys</span> <span class="main">-</span> <span class="skolem">seen_T</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">}</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ ccProd_mono2<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> set <span class="skolem">ys</span> <span class="main">-</span> <span class="skolem">seen_T</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">}</span> <span class="main">=</span>  <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> set <span class="skolem">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">seen_T</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> set <span class="skolem">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">}</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">note</span></span> False seen_x
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ccFromList <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span><span class="main">]</span> <span class="main">⊑</span> <span class="free">G</span> <span class="main">∧</span> ccProd <span class="main">(</span><span class="skolem">seen</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">seen_T</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_Diff_if  ccProd_insert2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">-</span> <span class="skolem">seen_T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span>   ccProd_insert1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seen</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ccFromList <span class="skolem">xs</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">valid_lists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set <span class="main">⇒</span> CoCalls <span class="main">⇒</span> var list set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">S</span> <span class="entity">G</span>
  <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">valid_lists</span> <span class="free">S</span> <span class="free">G</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⊆</span> ccNeighbors <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free">G</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∈</span> <span class="free">valid_lists</span> <span class="free">S</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∈</span> <span class="free">valid_lists</span> <span class="free">S</span> <span class="free">G</span>"</span></span>

<span class="keyword1"><span class="command">inductive_simps</span></span> valid_lists_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> vald_lists_ConsE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span>

<span class="keyword1" id="CoCallGraph-TTree-valid_lists_downset_aux"><span class="command">lemma</span></span>  valid_lists_downset_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">CoCalls</span> <span class="main">⟹</span> butlast <span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">CoCalls</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_butlastD<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-valid_lists_subset"><span class="command">lemma</span></span> valid_lists_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid_lists.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-TTree-valid_lists_mono1"><span class="command">lemma</span></span> valid_lists_mono1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_lists <span class="free">S</span> <span class="free">G</span> <span class="main">⊆</span> valid_lists <span class="free">S'</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="free">S'</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid_lists.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-TTree-valid_lists_chain1"><span class="command">lemma</span></span> valid_lists_chain1<span class="main">:</span>
   <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">Y</span>"</span></span> 
   <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">Y</span> <span class="main">`</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="free">G</span>"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="free">Y</span> <span class="main">`</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> valid_lists_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset_chain<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="skolem">i</span>"</span></span><span class="keyword1"><span class="command">..</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>valid_lists.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-TTree-valid_lists_chain2"><span class="command">lemma</span></span> valid_lists_chain2<span class="main">:</span>
   <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">Y</span>"</span></span> 
   <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span>  <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>valid_lists.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Nil Cons<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> ccNeighbors <span class="skolem">x</span> <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ch2ch_monofun<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monofunI<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> below_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccNeighbors_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">i</span><span class="main">.</span> ccNeighbors <span class="skolem">x</span> <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  lub_set<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> set <span class="skolem">xs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset_chain<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>

  <span class="keyword1"><span class="command">from</span></span> Cons.IH
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="main">(</span><span class="free">Y</span> <span class="skolem">j</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>

  <span class="keyword1"><span class="command">from</span></span> i
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="main">(</span><span class="free">Y</span> <span class="main">(</span>max <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ccNeighbors_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> chain_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span> max.cobounded1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> j
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="main">(</span><span class="free">Y</span> <span class="main">(</span>max <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid_lists.induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ccNeighbors_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> chain_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span> max.cobounded2<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="main">(</span><span class="free">Y</span> <span class="main">(</span>max <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-TTree-valid_lists_cc_restr"><span class="command">lemma</span></span> valid_lists_cc_restr<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_lists <span class="free">S</span> <span class="free">G</span> <span class="main">=</span> valid_lists <span class="free">S</span> <span class="main">(</span>cc_restr <span class="free">S</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="main">(</span>cc_restr <span class="free">S</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> valid_lists_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-TTree-interleave_valid_list"><span class="command">lemma</span></span> interleave_valid_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> <span class="free">ys</span> <span class="main">⊗</span> <span class="free">zs</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">zs</span> <span class="main">∈</span> valid_lists <span class="free">S'</span> <span class="free">G'</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">S'</span><span class="main">)</span> <span class="main">(</span><span class="free">G</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">G'</span> <span class="main">⊔</span> ccProd <span class="free">S</span> <span class="free">S'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>interleave_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left <span class="skolem">ys</span> <span class="skolem">zs</span> <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">zs</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="skolem">ys</span> <span class="main">∪</span> set <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interleave_set<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">ys</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>›</span></span> valid_lists_subset<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">∈</span> valid_lists <span class="free">S'</span> <span class="free">G'</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="main">(</span><span class="free">G</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">G'</span> <span class="main">⊔</span> ccProd <span class="free">S</span> <span class="free">S'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccNeighbors_ccProd <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">∈</span> valid_lists <span class="free">S'</span> <span class="free">G'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">S'</span><span class="main">)</span> <span class="main">(</span><span class="free">G</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">G'</span> <span class="main">⊔</span> ccProd <span class="free">S</span> <span class="free">S'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> left.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">S'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>right <span class="skolem">ys</span> <span class="skolem">zs</span> <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">zs</span> <span class="main">∈</span> valid_lists <span class="free">S'</span> <span class="free">G'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> valid_lists <span class="free">S'</span> <span class="free">G'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">zs</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="skolem">ys</span> <span class="main">∪</span> set <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interleave_set<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">zs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G'</span>›</span></span> valid_lists_subset<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="main">(</span><span class="free">G</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">G'</span> <span class="main">⊔</span> ccProd <span class="free">S</span> <span class="free">S'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccNeighbors_ccProd <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S'</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">∈</span> valid_lists <span class="free">S'</span> <span class="free">G'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">S'</span><span class="main">)</span> <span class="main">(</span><span class="free">G</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">G'</span> <span class="main">⊔</span> ccProd <span class="free">S</span> <span class="free">S'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> right.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">S'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-TTree-interleave_valid_list'"><span class="command">lemma</span></span> interleave_valid_list'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">S'</span><span class="main">)</span> <span class="free">G</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">∈</span> <span class="bound">ys</span> <span class="main">⊗</span> <span class="bound">zs</span> <span class="main">∧</span> <span class="bound">ys</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span> <span class="main">∧</span> <span class="bound">zs</span> <span class="main">∈</span> valid_lists <span class="free">S'</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid_lists.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Nil Cons<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> valid_lists <span class="free">S'</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">zs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="skolem">ys</span> <span class="main">∪</span> set <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interleave_set<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>›</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">S'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">ys</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">zs</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">x</span><span class="main">#</span><span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">zs</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">∈</span> valid_lists <span class="free">S'</span> <span class="free">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S'</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">zs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">∈</span> valid_lists <span class="free">S'</span> <span class="free">G</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">zs</span> <span class="main">∈</span> valid_lists <span class="free">S'</span> <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">zs</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">x</span><span class="main">#</span><span class="skolem">zs</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-TTree-many_calls_valid_list"><span class="command">lemma</span></span> many_calls_valid_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span>ccProd <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> replicate <span class="bound">n</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid_lists.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> UNIV_I image_iff replicate_Suc<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-filter_valid_lists"><span class="command">lemma</span></span> filter_valid_lists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span> <span class="main">⟹</span> filter <span class="free">P</span> <span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span><span class="main">}</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>valid_lists.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> ccTTree <span class="main">::</span> <span class="quoted"><span class="quoted">"var set <span class="main">⇒</span> CoCalls <span class="main">⇒</span> var ttree"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">S</span> <span class="bound">G</span><span class="main">.</span> valid_lists <span class="bound">S</span> <span class="bound">G</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_lists_downset_aux<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-paths_ccTTree"><span class="command">lemma</span></span> paths_ccTTree<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"paths <span class="main">(</span>ccTTree <span class="free">S</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="CoCallGraph-TTree-carrier_ccTTree"><span class="command">lemma</span></span> carrier_ccTTree<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>ccTTree <span class="free">S</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> valid_lists_subset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="improper">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallGraph-TTree-valid_lists_ccFromList"><span class="command">lemma</span></span> valid_lists_ccFromList<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span> <span class="main">⟹</span> ccFromList <span class="free">xs</span> <span class="main">⊑</span> cc_restr <span class="free">S</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>valid_lists.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff subset_ccNeighbors ccProd_below_cc_restr <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> valid_lists_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-ccApprox_ccTTree"><span class="command">lemma</span></span> ccApprox_ccTTree<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span>ccTTree <span class="free">S</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer'</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">G</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lub <span class="main">(</span>ccFromList <span class="main">`</span> valid_lists <span class="free">S</span> <span class="free">G</span><span class="main">)</span> <span class="main">⊑</span> cc_restr <span class="free">S</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_lub_thelub_ex<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> coCallsLub_is_lub<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_ubI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> valid_lists_ccFromList<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="free">G</span> <span class="main">⊑</span> lub <span class="main">(</span>ccFromList <span class="main">`</span> valid_lists <span class="free">S</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> below_CoCallsI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">--</span><span class="skolem">y</span><span class="main">∈</span><span class="main">(</span>ccFromList <span class="main">[</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">--</span><span class="skolem">y</span><span class="main">∈</span><span class="main">(</span>cc_restr <span class="free">S</span> <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> elem_ccNeighbors<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">--</span><span class="skolem">y</span><span class="main">∈</span><span class="main">(</span>lub <span class="main">(</span>ccFromList <span class="main">`</span> valid_lists <span class="free">S</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_CoCallsLubI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ imageI<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-TTree-below_ccTTreeI"><span class="command">lemma</span></span> below_ccTTreeI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"carrier <span class="free">t</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ccApprox <span class="free">t</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> ccTTree <span class="free">S</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> paths_mono_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> below_set_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="skolem">t</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"possible <span class="skolem">t</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_path<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">⊑</span> ccFromList <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> paths <span class="skolem">t</span>›</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> ccApprox <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccFromList_below_ccApprox<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹ccApprox <span class="skolem">t</span> <span class="main">⊑</span> <span class="free">G</span>›</span></span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> subset_ccNeighbors<span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹carrier <span class="skolem">t</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> carrier_nxt_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹ccApprox <span class="skolem">t</span> <span class="main">⊑</span> <span class="free">G</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccApprox_nxt_below<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹carrier <span class="skolem">t</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹possible <span class="skolem">t</span> <span class="skolem">x</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> carrier_possible_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
    
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>ccTTree <span class="free">S</span> <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> paths_ccTTree<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1" id="CoCallGraph-TTree-ccTTree_mono1"><span class="command">lemma</span></span> ccTTree_mono1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">⟹</span> ccTTree <span class="free">S</span> <span class="free">G</span> <span class="main">⊑</span> ccTTree <span class="free">S'</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_ccTTreeI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  cc_restr_below_arg<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-cont_ccTTree1"><span class="command">lemma</span></span> cont_ccTTree1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">S</span><span class="main">.</span> ccTTree <span class="bound">S</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> contI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monofunI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ccTTree_mono1<span class="main"><span class="main">[</span></span><span class="operator">folded</span> below_set_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ttree_belowI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_Either lub_set lub_is_either<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_lists_chain1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallGraph-TTree-ccTTree_mono2"><span class="command">lemma</span></span> ccTTree_mono2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊑</span> <span class="free">G'</span> <span class="main">⟹</span> ccTTree <span class="free">S</span> <span class="free">G</span> <span class="main">⊑</span> ccTTree <span class="free">S</span> <span class="free">G'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ttree_belowI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>valid_lists.induct<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ccNeighbors_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallGraph-TTree-ccTTree_mono"><span class="command">lemma</span></span> ccTTree_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">⊑</span> <span class="free">G'</span> <span class="main">⟹</span> ccTTree <span class="free">S</span> <span class="free">G</span> <span class="main">⊑</span> ccTTree <span class="free">S'</span> <span class="free">G'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccTTree_mono1 ccTTree_mono2<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1" id="CoCallGraph-TTree-cont_ccTTree2"><span class="command">lemma</span></span> cont_ccTTree2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="main">(</span>ccTTree <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> contI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monofunI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ccTTree_mono2<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ttree_belowI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_Either lub_set lub_is_either<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_lists_chain2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> cont_ccTTree <span class="main">=</span> cont_compose2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted">ccTTree</span><span class="main">,</span> <span class="operator">OF</span> cont_ccTTree1 cont_ccTTree2<span class="main">,</span> <span class="operator">simp</span><span class="main">,</span> <span class="operator">cont2cont</span><span class="main">]</span>

<span class="keyword1" id="CoCallGraph-TTree-ccTTree_below_singleI"><span class="command">lemma</span></span> ccTTree_below_singleI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="free">S'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ccTTree <span class="free">S</span> <span class="free">G</span> <span class="main">⊑</span> singles <span class="free">S'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">≤</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid_lists.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Nil Cons<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="CoCallGraph-TTree-ccTTree_cc_restr"><span class="command">lemma</span></span> ccTTree_cc_restr<span class="main">:</span> <span class="quoted"><span class="quoted">"ccTTree <span class="free">S</span> <span class="free">G</span> <span class="main">=</span> ccTTree <span class="free">S</span> <span class="main">(</span>cc_restr <span class="free">S</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> valid_lists_cc_restr<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-ccTTree_cong_below"><span class="command">lemma</span></span> ccTTree_cong_below<span class="main">:</span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="free">G</span> <span class="main">⊑</span> cc_restr <span class="free">S</span> <span class="free">G'</span> <span class="main">⟹</span> ccTTree <span class="free">S</span> <span class="free">G</span> <span class="main">⊑</span> ccTTree <span class="free">S</span> <span class="free">G'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ccTTree_mono2 ccTTree_cc_restr<span class="main">)</span>
  
<span class="keyword1" id="CoCallGraph-TTree-ccTTree_cong"><span class="command">lemma</span></span> ccTTree_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"cc_restr <span class="free">S</span> <span class="free">G</span> <span class="main">=</span> cc_restr <span class="free">S</span> <span class="free">G'</span> <span class="main">⟹</span> ccTTree <span class="free">S</span> <span class="free">G</span> <span class="main">=</span> ccTTree <span class="free">S</span> <span class="free">G'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ccTTree_cc_restr<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-either_ccTTree"><span class="command">lemma</span></span> either_ccTTree<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccTTree <span class="free">S</span> <span class="free">G</span> <span class="main">⊕⊕</span> ccTTree <span class="free">S'</span> <span class="free">G'</span> <span class="main">⊑</span> ccTTree <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">S'</span><span class="main">)</span> <span class="main">(</span><span class="free">G</span> <span class="main">⊔</span> <span class="free">G'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> either_belowI ccTTree_mono<span class="main">)</span>
 

<span class="keyword1" id="CoCallGraph-TTree-interleave_ccTTree"><span class="command">lemma</span></span> interleave_ccTTree<span class="main">:</span> 
   <span class="quoted"><span class="quoted">"ccTTree <span class="free">S</span> <span class="free">G</span> <span class="main">⊗⊗</span> ccTTree <span class="free">S'</span> <span class="free">G'</span> <span class="main">⊑</span> ccTTree <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">S'</span><span class="main">)</span> <span class="main">(</span><span class="free">G</span> <span class="main">⊔</span> <span class="free">G'</span> <span class="main">⊔</span> ccProd <span class="free">S</span> <span class="free">S'</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> interleave_valid_list<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-interleave_ccTTree'"><span class="command">lemma</span></span> interleave_ccTTree'<span class="main">:</span> 
   <span class="quoted"><span class="quoted">"ccTTree <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">S'</span><span class="main">)</span> <span class="free">G</span> <span class="main">⊑</span> ccTTree <span class="free">S</span> <span class="free">G</span> <span class="main">⊗⊗</span> ccTTree <span class="free">S'</span> <span class="free">G</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  interleave_valid_list'<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-many_calls_ccTTree"><span class="command">lemma</span></span> many_calls_ccTTree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"many_calls <span class="free">x</span> <span class="main">=</span> ccTTree <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span>ccProd <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> many_calls_valid_list<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">n</span></span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccNeighbors_ccProd<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CoCallGraph-TTree-filter_valid_lists'"><span class="command">lemma</span></span> filter_valid_lists'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="main">{</span><span class="bound"><span class="bound">x'</span></span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x'</span><span class="main">}</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> filter <span class="free">P</span> <span class="main">`</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  <span class="main">(</span><span class="operator">metis</span> filter.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> image_iff valid_lists_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="main">{</span><span class="bound"><span class="bound">x'</span></span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x'</span><span class="main">}</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">x'</span></span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> valid_lists_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filter_True<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="main">_</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter <span class="free">P</span> <span class="main">`</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="main">{</span><span class="bound"><span class="bound">x'</span></span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x'</span><span class="main">}</span> <span class="free">G</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> valid_lists_mono1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x</span> <span class="free">G</span>›</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> filter <span class="free">P</span> <span class="main">`</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> imageI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹filter <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span><span class="skolem">xs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-TTree-without_ccTTree"><span class="command">lemma</span></span> without_ccTTree<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"without <span class="free">x</span> <span class="main">(</span>ccTTree <span class="free">S</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> ccTTree <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> filter_valid_lists'  filter_valid_lists<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span><span class="main">≠</span> <span class="free">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_diff_eq<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-ttree_restr_ccTTree"><span class="command">lemma</span></span> ttree_restr_ccTTree<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"ttree_restr <span class="free">S'</span> <span class="main">(</span>ccTTree <span class="free">S</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> ccTTree <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="free">S'</span><span class="main">)</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> filter_valid_lists'  filter_valid_lists<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S'</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Int_def<span class="main">)</span>

<span class="keyword1" id="CoCallGraph-TTree-repeatable_ccTTree_ccSquare"><span class="command">lemma</span></span> repeatable_ccTTree_ccSquare<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">⟹</span> repeatable <span class="main">(</span>ccTTree <span class="free">S</span> <span class="main">(</span>ccSquare <span class="free">S'</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> repeatable_def
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ccNeighbors_ccSquare <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> valid_lists_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An alternative definition›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">valid_lists'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set <span class="main">⇒</span> CoCalls <span class="main">⇒</span> var set <span class="main">⇒</span> var list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">S</span> <span class="entity">G</span>
  <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">valid_lists'</span> <span class="free">S</span> <span class="free">G</span> <span class="free"><span class="bound"><span class="entity">prefix</span></span></span> <span class="main">[]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">prefix</span></span></span> <span class="main">⊆</span> ccNeighbors <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">valid_lists'</span> <span class="free">S</span> <span class="free">G</span> <span class="main">(</span>insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">prefix</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">valid_lists'</span> <span class="free">S</span> <span class="free">G</span> <span class="free"><span class="bound"><span class="entity">prefix</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_simps</span></span> valid_lists'_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valid_lists' <span class="free">S</span> <span class="free">G</span> <span class="free">prefix</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"valid_lists' <span class="free">S</span> <span class="free">G</span> <span class="free">prefix</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> vald_lists'_ConsE<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_lists' <span class="free">S</span> <span class="free">G</span> <span class="free">prefix</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallGraph-TTree-valid_lists_valid_lists'"><span class="command">lemma</span></span> valid_lists_valid_lists'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span> <span class="main">⟹</span> ccProd <span class="free">prefix</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span> <span class="main">⟹</span> valid_lists' <span class="free">S</span> <span class="free">G</span> <span class="free">prefix</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">prefix</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid_lists.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Nil Cons<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> Cons.prems Cons.hyps Cons.IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> prefix <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="skolem">prefix</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_is_Un<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span><span class="main"><span class="main">]</span></span>  insert_is_Un<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">prefix</span></span><span class="main"><span class="main">]</span></span>
                     join_below_iff subset_ccNeighbors elem_ccNeighbors ccProd_comm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Un_insert_left <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-TTree-valid_lists'_valid_lists_aux"><span class="command">lemma</span></span> valid_lists'_valid_lists_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"valid_lists' <span class="free">S</span> <span class="free">G</span> <span class="free">prefix</span> <span class="free">xs</span> <span class="main">⟹</span>  <span class="free">x</span> <span class="main">∈</span> <span class="free">prefix</span> <span class="main">⟹</span> ccProd <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid_lists'.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Nil Cons<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">prefix</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccProd_insert2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">prefix</span></span><span class="main"><span class="main">]</span></span> ccProd_insert1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span><span class="main"><span class="main">]</span></span> join_below_iff subset_ccNeighbors<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dual_order.trans empty_subsetI insert_subset subset_ccNeighbors<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoCallGraph-TTree-valid_lists'_valid_lists"><span class="command">lemma</span></span> valid_lists'_valid_lists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"valid_lists' <span class="free">S</span> <span class="free">G</span> <span class="free">prefix</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid_lists'.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Nil Cons<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">prefix</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_is_Un<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span><span class="main"><span class="main">]</span></span>  insert_is_Un<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">prefix</span></span><span class="main"><span class="main">]</span></span>
                   join_below_iff subset_ccNeighbors elem_ccNeighbors ccProd_comm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Un_insert_left 
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_lists'_valid_lists_aux<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Yet another definition›</span></span>

<span class="keyword1" id="CoCallGraph-TTree-valid_lists_characterization"><span class="command">lemma</span></span> valid_lists_characterization<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span> <span class="main">⟷</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> ccProd <span class="main">(</span>set <span class="main">(</span>take <span class="bound">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>drop <span class="bound">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span>  valid_lists_subset<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">(</span>set <span class="main">(</span>take <span class="skolem">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid_lists.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Nil Cons<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Cons.hyps Cons.IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccProd_insert1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span> join_below_iff subset_ccNeighbors<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.trans set_drop_subset subset_ccNeighbors<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> ccProd <span class="main">(</span>set <span class="main">(</span>take <span class="bound">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>drop <span class="bound">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> ccProd <span class="main">(</span>set <span class="main">(</span>take <span class="bound">n</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>drop <span class="bound">n</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> ccProd <span class="main">(</span>set <span class="main">(</span>take <span class="bound">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>drop <span class="bound">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Suc <span class="improper">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccProd_insert1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span> join_below_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems Cons.IH<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span>  spec<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> ccProd <span class="main">(</span>set <span class="main">(</span>take <span class="bound">n</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>drop <span class="bound">n</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">G</span>›</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_ccNeighbors<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CoCallImplTTree">
<div class="head">
<h1>Theory CoCallImplTTree</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CoCallImplTTree
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#TTreeAnalysisSig">TTreeAnalysisSig</a> <span class="quoted">"<a href="Env-Set-Cpo.html">Env-Set-Cpo</a>"</span> <a href="#CoCallAritySig">CoCallAritySig</a> <span class="quoted">"<a href="CoCallGraph-TTree.html">CoCallGraph-TTree</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> CoCallArity
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">Texp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> Arity <span class="main">→</span> var ttree"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Texp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="CoCallImplTTree-Texp_simp"><span class="command">lemma</span></span> Texp_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"Texp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span> <span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Texp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">sublocale</span></span> TTreeAnalysis <span class="quoted">Texp</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Cardinality-Domain-Lists">
<div class="head">
<h1>Theory Cardinality-Domain-Lists</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Cardinality-Domain-Lists"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../launchbury/theories/#Vars">Launchbury.Vars</a> <span class="quoted">"<a href="../Launchbury/Nominal-HOLCF.html">Launchbury.Nominal-HOLCF</a>"</span> <a href="../../launchbury/theories/#Env">Launchbury.Env</a> <span class="quoted">"<a href="Cardinality-Domain.html">Cardinality-Domain</a>"</span> <span class="quoted">"<a href="Set-Cpo.html">Set-Cpo</a>"</span> <span class="quoted">"<a href="Env-Set-Cpo.html">Env-Set-Cpo</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">no_call_in_path</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">no_call_in_path</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">no_call_in_path</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free">no_call_in_path</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">one_call_in_path</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">one_call_in_path</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">one_call_in_path</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> no_call_in_path <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">else</span> <span class="free">one_call_in_path</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Cardinality-Domain-Lists-no_call_in_path_set_conv"><span class="command">lemma</span></span> no_call_in_path_set_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"no_call_in_path <span class="free">x</span> <span class="free">p</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∉</span> set <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">auto</span> 

<span class="keyword1" id="Cardinality-Domain-Lists-one_call_in_path_filter_conv"><span class="command">lemma</span></span> one_call_in_path_filter_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"one_call_in_path <span class="free">x</span> <span class="free">p</span> <span class="main">⟷</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_call_in_path_set_conv filter_empty_conv<span class="main">)</span>

<span class="keyword1" id="Cardinality-Domain-Lists-no_call_in_tail"><span class="command">lemma</span></span> no_call_in_tail<span class="main">:</span> <span class="quoted"><span class="quoted">"no_call_in_path <span class="free">x</span> <span class="main">(</span>tl <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>no_call_in_path <span class="free">x</span> <span class="free">p</span> <span class="main">∨</span> one_call_in_path <span class="free">x</span> <span class="free">p</span> <span class="main">∧</span> hd <span class="free">p</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Cardinality-Domain-Lists-no_imp_one"><span class="command">lemma</span></span> no_imp_one<span class="main">:</span> <span class="quoted"><span class="quoted">"no_call_in_path <span class="free">x</span> <span class="free">p</span> <span class="main">⟹</span> one_call_in_path <span class="free">x</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Cardinality-Domain-Lists-one_imp_one_tail"><span class="command">lemma</span></span> one_imp_one_tail<span class="main">:</span> <span class="quoted"><span class="quoted">"one_call_in_path <span class="free">x</span> <span class="free">p</span> <span class="main">⟹</span> one_call_in_path <span class="free">x</span> <span class="main">(</span>tl <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> no_imp_one<span class="main">)</span>

<span class="keyword1" id="Cardinality-Domain-Lists-more_than_one_setD"><span class="command">lemma</span></span> more_than_one_setD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> one_call_in_path <span class="free">x</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">p</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Cardinality-Domain-Lists-no_call_in_path"><span class="command">lemma</span></span> no_call_in_path<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"no_call_in_path <span class="free">p</span> <span class="free">x</span> <span class="main">⟹</span> no_call_in_path <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> no_call_in_path.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Cardinality-Domain-Lists-one_call_in_path"><span class="command">lemma</span></span> one_call_in_path<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"one_call_in_path <span class="free">p</span> <span class="free">x</span> <span class="main">⟹</span> one_call_in_path <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> one_call_in_path.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_call_in_path<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pathCard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var list  <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> two<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pathCard</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> no_call_in_path <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> none <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> one_call_in_path <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> once <span class="keyword1">else</span> many<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Cardinality-Domain-Lists-pathCard_Nil"><span class="command">lemma</span></span> pathCard_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pathCard <span class="main">[]</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pathCard_def<span class="main">)</span>

<span class="keyword1" id="Cardinality-Domain-Lists-pathCard_Cons"><span class="command">lemma</span></span> pathCard_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pathCard <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> two_add<span class="main">⋅</span>once<span class="main">⋅</span><span class="main">(</span>pathCard <span class="free">xs</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pathCard_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_add_simp<span class="main">)</span>

<span class="keyword1" id="Cardinality-Domain-Lists-pathCard_Cons_other"><span class="command">lemma</span></span> pathCard_Cons_other<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> pathCard <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> pathCard <span class="free">xs</span> <span class="free">x'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pathCard_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Cardinality-Domain-Lists-no_call_in_path_filter"><span class="command">lemma</span></span> no_call_in_path_filter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"no_call_in_path <span class="free">x</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="main">⟷</span> no_call_in_path <span class="free">x</span> <span class="free">xs</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Cardinality-Domain-Lists-one_call_in_path_filter"><span class="command">lemma</span></span> one_call_in_path_filter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"one_call_in_path <span class="free">x</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">]</span> <span class="main">⟷</span> one_call_in_path <span class="free">x</span> <span class="free">xs</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pathsCard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var list set <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> two<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pathsCard</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">.</span> no_call_in_path <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="keyword1">then</span> none <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">.</span> one_call_in_path <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="keyword1">then</span> once <span class="keyword1">else</span> many<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Cardinality-Domain-Lists-paths_Card_above"><span class="command">lemma</span></span> paths_Card_above<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">ps</span> <span class="main">⟹</span> pathCard <span class="free">p</span> <span class="main">⊑</span> pathsCard <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pathsCard_def pathCard_def<span class="main">)</span>

<span class="keyword1" id="Cardinality-Domain-Lists-pathsCard_below"><span class="command">lemma</span></span> pathsCard_below<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">ps</span> <span class="main">⟹</span> pathCard <span class="bound">p</span> <span class="main">⊑</span> <span class="free">ce</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pathsCard <span class="free">ps</span> <span class="main">⊑</span> <span class="free">ce</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pathsCard <span class="free">ps</span> <span class="skolem">x</span> <span class="main">⊑</span> <span class="free">ce</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pathsCard_def pathCard_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fun_belowD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_imp_one<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Cardinality-Domain-Lists-pathsCard_mono"><span class="command">lemma</span></span> pathsCard_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="free">ps'</span> <span class="main">⟹</span> pathsCard <span class="free">ps</span> <span class="main">⊑</span> pathsCard <span class="free">ps'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pathsCard_below paths_Card_above<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> pathsCard_mono' <span class="main">=</span> pathsCard_mono<span class="main">[</span><span class="operator">folded</span> below_set_def<span class="main">]</span>

<span class="keyword1" id="Cardinality-Domain-Lists-record_call_pathsCard"><span class="command">lemma</span></span> record_call_pathsCard<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"pathsCard <span class="main">(</span><span class="main">{</span> tl <span class="bound">p</span> <span class="main">|</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">fs</span> <span class="main">∧</span> hd <span class="bound">p</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">⊑</span> record_call <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>pathsCard <span class="free">fs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pathsCard_below<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> <span class="main">{</span>tl <span class="bound">p</span> <span class="main">|</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">fs</span> <span class="main">∧</span> hd <span class="bound">p</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> tl <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">p</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pathCard <span class="main">(</span>tl <span class="skolem">p</span><span class="main">)</span> <span class="main">⊑</span> record_call <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>pathCard <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">p</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pathCard_def record_call_simp no_call_in_tail <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> one_imp_one_tail<span class="main">)</span>
    
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pathCard <span class="main">(</span>tl <span class="skolem">p</span><span class="main">)</span> <span class="main">⊑</span> record_call <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>pathsCard <span class="free">fs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ monofun_cfun_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  paths_Card_above<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> <span class="free">fs</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pathCard <span class="skolem">p'</span> <span class="main">⊑</span> record_call <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>pathsCard <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Cardinality-Domain-Lists-pathCards_noneD"><span class="command">lemma</span></span> pathCards_noneD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pathsCard <span class="free">ps</span> <span class="free">x</span> <span class="main">=</span> none <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pathsCard_def no_call_in_path_set_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main">)</span>

<span class="keyword1" id="Cardinality-Domain-Lists-cont_pathsCard"><span class="command">lemma</span></span> cont_pathsCard<span class="main">[</span><span class="operator">THEN</span> cont_compose<span class="main">,</span> <span class="operator">cont2cont</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont pathsCard"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cont2cont_lambda cont_if_else_above <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pathsCard_def below_set_def<span class="main">)</span>

<span class="keyword1" id="Cardinality-Domain-Lists-pathsCard_eqvt"><span class="command">lemma</span></span> pathsCard_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> pathsCard <span class="free">ps</span> <span class="free">x</span> <span class="main">=</span> pathsCard <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pathsCard_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1" id="Cardinality-Domain-Lists-edom_pathsCard"><span class="command">lemma</span></span> edom_pathsCard<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>pathsCard <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> edom_def pathsCard_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  no_call_in_path_set_conv<span class="main">)</span>

<span class="keyword1" id="Cardinality-Domain-Lists-env_restr_pathsCard"><span class="command">lemma</span></span> env_restr_pathsCard<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pathsCard <span class="free">ps</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> pathsCard <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">`</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pathsCard_def lookup_env_restr_eq<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TTreeAnalysisSpec">
<div class="head">
<h1>Theory TTreeAnalysisSpec</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TTreeAnalysisSpec
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#TTreeAnalysisSig">TTreeAnalysisSig</a> <a href="#ArityAnalysisSpec">ArityAnalysisSpec</a> <span class="quoted">"<a href="Cardinality-Domain-Lists.html">Cardinality-Domain-Lists</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> TTreeAnalysisCarrier <span class="main">=</span> TTreeAnalysis <span class="main">+</span> EdomArityAnalysis <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> carrier_Fexp<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="free">Texp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> TTreeAnalysisSafe <span class="main">=</span> TTreeAnalysisCarrier <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Texp_App<span class="main">:</span> <span class="quoted"><span class="quoted">"many_calls <span class="free">x</span> <span class="main">⊗⊗</span> <span class="main">(</span><span class="free">Texp</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">Texp</span> <span class="main">(</span>App <span class="free">e</span> <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Texp_Lam<span class="main">:</span> <span class="quoted"><span class="quoted">"without <span class="free">y</span> <span class="main">(</span><span class="free">Texp</span> <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">Texp</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Texp_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Texp</span> <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊑</span> many_calls <span class="free">x</span> <span class="main">⊗⊗</span> without <span class="free">y</span> <span class="main">(</span><span class="main">(</span><span class="free">Texp</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Texp_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"single <span class="free">v</span> <span class="main">⊑</span> <span class="free">Texp</span> <span class="main">(</span>Var <span class="free">v</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Fun_repeatable<span class="main">:</span> <span class="quoted"><span class="quoted">"isVal <span class="free">e</span> <span class="main">⟹</span> repeatable <span class="main">(</span><span class="free">Texp</span> <span class="free">e</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Texp_IfThenElse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Texp</span> <span class="free">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊗⊗</span> <span class="main">(</span><span class="free">Texp</span> <span class="free">e1</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊕⊕</span> <span class="free">Texp</span> <span class="free">e2</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">Texp</span> <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> TTreeAnalysisCardinalityHeap <span class="main">=</span> 
  TTreeAnalysisSafe <span class="main">+</span> ArityAnalysisLetSafe <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Theap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> exp <span class="main">⇒</span> Arity <span class="main">→</span> var ttree"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> carrier_Fheap<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="free">Theap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Theap_thunk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> thunks <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">Theap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> one_call_in_path <span class="free">x</span> <span class="free">p</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Theap_substitute<span class="main">:</span> <span class="quoted"><span class="quoted">"ttree_restr <span class="main">(</span>domA <span class="free">Δ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="free">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="free">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">Theap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Texp_Let<span class="main">:</span> <span class="quoted"><span class="quoted">"ttree_restr <span class="main">(</span><span class="main">-</span> domA <span class="free">Δ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="free">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>thunks <span class="free">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">Texp</span> <span class="main">(</span>Terms.Let <span class="free">Δ</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span>"</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CoCallImplTTreeSafe">
<div class="head">
<h1>Theory CoCallImplTTreeSafe</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CoCallImplTTreeSafe
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#CoCallImplTTree">CoCallImplTTree</a> <a href="#CoCallAnalysisSpec">CoCallAnalysisSpec</a> <a href="#TTreeAnalysisSpec">TTreeAnalysisSpec</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="CoCallImplTTreeSafe-valid_lists_many_calls"><span class="command">lemma</span></span> valid_lists_many_calls<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> one_call_in_path <span class="free">x</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> valid_lists <span class="free">S</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">--</span><span class="free">x</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>valid_lists.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Nil Cons<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xs</span> <span class="skolem">x'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"one_call_in_path <span class="free">x</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> one_call_in_path <span class="free">x</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"no_call_in_path <span class="free">x</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> no_call_in_path_set_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"one_call_in_path <span class="free">x</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> ccNeighbors <span class="skolem">x'</span> <span class="free">G</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> ccNeighbors <span class="free">x</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> CoCallArityEdom
<span class="keyword2"><span class="keyword">begin</span></span>
 <span class="keyword1" id="CoCallImplTTreeSafe-carrier_Fexp'"><span class="command">lemma</span></span> carrier_Fexp'<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>Texp <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Texp_simp carrier_ccTTree
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Aexp_edom<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">context</span></span> CoCallAritySafe
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="CoCallImplTTreeSafe-carrier_AnalBinds_below"><span class="command">lemma</span></span> carrier_AnalBinds_below<span class="main">:</span>
  <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="main">(</span>Texp.AnalBinds  <span class="free">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> edom <span class="main">(</span><span class="main">(</span>ABinds <span class="free">Δ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Δ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp.AnalBinds_lookup Texp_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits 
         <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> monofun_cfun_fun<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> ABind_below_ABinds<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> TTreeAnalysisCarrier <span class="quoted">Texp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">unfolding</span></span> Texp_simp carrier_ccTTree
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">sublocale</span></span> TTreeAnalysisSafe <span class="quoted">Texp</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">a</span>

  <span class="keyword1"><span class="command">from</span></span> edom_mono<span class="main">[</span><span class="operator">OF</span> Aexp_App<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span>many_calls <span class="skolem">x</span> <span class="main">⊗⊗</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> cc_restr <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊔</span> ccProd <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccApprox_both ccProd_insert2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"edom <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">e</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Aexp_edom<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span><span class="main">(</span>below_trans<span class="main">[</span><span class="operator">OF</span> eq_imp_below join_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below_refl ccProd_mono2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> insert_mono<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">]</span></span><span class="main">]</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cc_restr <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cc_restr_below_arg<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊔</span> ccProd <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span>fv <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ccExp</span> <span class="main">(</span>App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccExp_App<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span>many_calls <span class="skolem">x</span> <span class="main">⊗⊗</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ccExp</span> <span class="main">(</span>App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"many_calls <span class="skolem">x</span> <span class="main">⊗⊗</span> Texp <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊑</span> Texp <span class="main">(</span>App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Texp_simp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> below_ccTTreeI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">e</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"without <span class="skolem">y</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> Texp <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Texp_simp
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span>
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> below_ccTTreeI  below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ccExp_Lam<span class="main"><span class="main">]</span></span> cc_restr_mono1 subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Aexp_Lam<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">y</span> <span class="skolem">x</span> <span class="skolem">a</span>

  <span class="keyword1"><span class="command">from</span></span> edom_mono<span class="main">[</span><span class="operator">OF</span> Aexp_subst<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊆</span> insert <span class="skolem">x</span> <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Texp <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">=</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Texp_simp<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> ccTTree <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccTTree_mono1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> many_calls <span class="skolem">x</span> <span class="main">⊗⊗</span> without <span class="skolem">x</span> <span class="main">(</span><span class="main">…</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> paths_many_calls_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"without <span class="skolem">x</span> <span class="main">(</span>ccTTree <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccTTree_cong_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccExp_subst<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> without <span class="skolem">y</span> <span class="main">(</span>ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> Diff_insert Diff_insert2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊑</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccTTree_mono1<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Texp_simp<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Texp <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊑</span> many_calls <span class="skolem">x</span> <span class="main">⊗⊗</span> without <span class="skolem">y</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">a</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"up<span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Var <span class="skolem">v</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Aexp_Var<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Var <span class="skolem">v</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"single <span class="skolem">v</span> <span class="main">⊑</span> Texp <span class="main">(</span>Var <span class="skolem">v</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Texp_simp
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> below_ccTTreeI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">scrut</span> <span class="skolem">e1</span> <span class="skolem">a</span> <span class="skolem">e2</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊕⊕</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>
    <span class="main">⊑</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">ccExp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> either_ccTTree<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> both_mono2'<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="main">⊗⊗</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">ccExp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>
    <span class="main">⊑</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">ccExp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊔</span> ccProd <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interleave_ccTTree<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊑</span> <span class="free">Aexp</span> <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Aexp_IfThenElse<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ccExp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">ccExp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊔</span> ccProd <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span>
        <span class="free">ccExp</span> <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccExp_IfThenElse<span class="main">)</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Texp <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊗⊗</span> <span class="main">(</span>Texp <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊕⊕</span> Texp <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊑</span> Texp <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Texp_simp
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccApprox_both join_below_iff  below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span>
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> below_ccTTreeI below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cc_restr_below_arg<span class="main"><span class="main">]</span></span>
                     below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ccExp_IfThenElse<span class="main"><span class="main">]</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Aexp_IfThenElse<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isVal <span class="skolem">e</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">0</span> <span class="main">=</span> ccSquare <span class="main">(</span>fv <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccExp_pap<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"repeatable <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Texp_simp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> repeatable_ccTTree_ccSquare<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Theap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> exp <span class="main">⇒</span> Arity <span class="main">→</span> var ttree"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Theap</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> <span class="keyword1">if</span> nonrec <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">then</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aheap</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="keyword1">else</span> ttree_restr <span class="main">(</span>edom <span class="main">(</span><span class="free">Aheap</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span> anything<span class="main">)</span>"</span></span>

<span class="keyword1" id="CoCallImplTTreeSafe-Theap_simp"><span class="command">lemma</span></span> Theap_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"Theap <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> nonrec <span class="free">Γ</span> <span class="keyword1">then</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">else</span> ttree_restr <span class="main">(</span>edom <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> anything<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Theap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoCallImplTTreeSafe-carrier_Fheap'"><span class="command">lemma</span></span> carrier_Fheap'<span class="main">:</span><span class="quoted"><span class="quoted">"carrier <span class="main">(</span>Theap <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Theap_simp carrier_ccTTree <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">sublocale</span></span> TTreeAnalysisCardinalityHeap <span class="quoted">Texp</span> <span class="quoted"><span class="free">Aexp</span></span> <span class="quoted"><span class="free">Aheap</span></span> <span class="quoted">Theap</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>Theap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> carrier_Fheap'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">p</span> <span class="skolem">e</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>"</span></span>
  
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> one_call_in_path <span class="skolem">x</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> more_than_one_setD<span class="main">)</span>
  
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> paths <span class="main">(</span>Theap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">p</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier <span class="main">(</span>Theap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Union_paths_carrier<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Theap_simp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nonrec <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> False <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> aHeap_thunks_rec<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> paths <span class="main">(</span>Theap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> valid_lists <span class="main">(</span>edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Theap_simp<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> one_call_in_path <span class="skolem">x</span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">--</span><span class="skolem">x</span><span class="main">∈</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> valid_lists_many_calls<span class="main">)</span>
  
    <span class="keyword1"><span class="command">from</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>›</span></span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> aHeap_thunks_nonrec<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Δ</span> <span class="skolem">e</span> <span class="skolem">a</span>

  <span class="keyword1"><span class="command">have</span></span> carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>substitute <span class="main">(</span>Texp.AnalBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> carrier_substitute_below<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> edom_mono<span class="main">[</span><span class="operator">OF</span> Aexp_Let<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">Δ</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊆</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">:</span> <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="main">(</span>Texp.AnalBinds  <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="main">(</span>Texp.AnalBinds  <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> edom <span class="main">(</span>ABinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> carrier_AnalBinds_below<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="main">(</span>Terms.Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> edom_mono<span class="main">[</span><span class="operator">OF</span> Aexp_Let<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">Δ</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Terms.Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Texp.AnalBinds  <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Texp.AnalBinds_not_there<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ttree_restr <span class="main">(</span><span class="main">-</span> domA <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>Texp.AnalBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> Texp <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eq_imp_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Texp_simp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> below_ccTTreeI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>ttree_restr <span class="main">(</span><span class="main">-</span> domA <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>Texp.AnalBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">=</span> carrier <span class="main">(</span>substitute <span class="main">(</span>Texp.AnalBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> domA <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> carrier
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Terms.Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> domA <span class="skolem">Δ</span> <span class="main">=</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>ttree_restr <span class="main">(</span><span class="main">-</span> domA <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>Texp.AnalBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span><span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">⊆</span> edom <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Terms.Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span>ttree_restr <span class="main">(</span><span class="main">-</span> domA <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>Texp.AnalBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">=</span> cc_restr <span class="main">(</span><span class="main">-</span> domA <span class="skolem">Δ</span><span class="main">)</span> <span class="var">?x</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> cc_restr <span class="main">(</span><span class="main">-</span> domA <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">ccHeap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> cc_restr_mono2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wild_recursion_thunked<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊑</span> <span class="free">ccHeap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccHeap_Exp<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ccHeap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp_simp <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cc_restr_below_arg<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Δ</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Texp.AnalBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> empty"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Texp.AnalBinds_not_there empty_is_bottom<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Δ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> e'<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">Δ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domA_map_of_Some_the<span class="main">)</span>
      
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span><span class="main">(</span>Texp.AnalBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ccHeap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> e' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp.AnalBinds_lookup<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>up <span class="skolem">a'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> e'
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ccExp</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="skolem">a'</span> <span class="main">⊑</span> <span class="free">ccHeap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccHeap_Heap<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> up e'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp.AnalBinds_lookup Texp_simp  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cc_restr_below_arg<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span><span class="free">ccHeap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>carrier <span class="main">(</span><span class="main">(</span>Texp.AnalBinds  <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ccHeap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> e' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp.AnalBinds_lookup<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>up <span class="skolem">a'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>carrier <span class="main">(</span>fup<span class="main">⋅</span><span class="main">(</span>Texp <span class="skolem">e'</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="skolem">e'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> up e' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp.AnalBinds_lookup carrier_Fexp <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>
        
        <span class="keyword1"><span class="command">from</span></span> e' up
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ccProd <span class="main">(</span>fv <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span>ccNeighbors <span class="skolem">x</span> <span class="main">(</span><span class="free">ccHeap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ccHeap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccHeap_Extra_Edges<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> e'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp.AnalBinds_lookup  Texp_simp ccProd_comm  below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccProd_mono2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> subset<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="free">ccExp</span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccExp_Let<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ccApprox <span class="main">(</span>ttree_restr <span class="main">(</span><span class="main">-</span> domA <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>Texp.AnalBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">⊑</span> <span class="free">ccExp</span> <span class="main">(</span>Terms.Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">note</span></span> carrier
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>substitute <span class="main">(</span>ExpAnalysis.AnalBinds Texp <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span> domA <span class="skolem">Δ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ttree_restr <span class="main">(</span>domA <span class="skolem">Δ</span><span class="main">)</span>            <span class="main">(</span>substitute <span class="main">(</span>Texp.AnalBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> ttree_restr <span class="main">(</span>edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ttree_restr <span class="main">(</span>domA <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>Texp.AnalBinds  <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> ttree_restr_noop<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ttree_restr <span class="main">(</span>edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>Texp.AnalBinds  <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf.absorb2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap <span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> Theap <span class="skolem">Δ</span> <span class="skolem">e</span> <span class="main">⋅</span><span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nonrec <span class="skolem">Δ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ttree_restr <span class="main">(</span>edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>Texp.AnalBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span>
      <span class="main">⊑</span> ttree_restr <span class="main">(</span>edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> anything"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ttree_restr_mono<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Theap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Theap_simp False<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True

    <span class="keyword1"><span class="command">from</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ttree_restr <span class="main">(</span>edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>Texp.AnalBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span>
       <span class="main">=</span> ttree_restr <span class="main">(</span>edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nonrecE<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> ttree_rest_substitute<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> carrier_Fexp fv_def fresh_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_Aheap<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∩</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∩</span> domA <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccTTree_mono1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Int_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl edom_Aheap<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> ccTTree <span class="main">(</span>edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ccExp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccTTree_mono1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Aheap_nonrec<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> True<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> Theap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Theap_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ttree_restr <span class="main">(</span>domA <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>ExpAnalysis.AnalBinds Texp <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>Texp <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> Theap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* TODO: Unused stuff from here, mostly about singles. Might be useful later. *)</span>


<span class="keyword1" id="CoCallImplTTreeSafe-paths_singles"><span class="command">lemma</span></span> paths_singles<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> one_call_in_path <span class="bound">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_call_in_path_filter_conv<span class="main">)</span>

<span class="keyword1" id="CoCallImplTTreeSafe-paths_singles'"><span class="command">lemma</span></span> paths_singles'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">xs</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span><span class="main">.</span> one_call_in_path <span class="bound">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_call_in_path_filter_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> filter_empty_conv le0 length_0_conv<span class="main">)</span>

<span class="keyword1" id="CoCallImplTTreeSafe-both_below_singles1"><span class="command">lemma</span></span> both_below_singles1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> singles <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"carrier <span class="free">t'</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span> <span class="main">⊑</span> singles <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ttree_belowI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">t</span> <span class="main">⊗⊗</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> paths <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> paths <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_both<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> paths <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_ttree.rep_eq contra_subsetD paths.rep_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Union_paths_carrier<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">ys</span> <span class="main">⊗</span> <span class="skolem">zs</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_singles no_call_in_path_set_conv interleave_set <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> more_than_one_setD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="CoCallImplTTreeSafe-paths_ttree_restr_singles"><span class="command">lemma</span></span> paths_ttree_restr_singles<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>ttree_restr <span class="free">S'</span> <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> one_call_in_path <span class="bound">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>ttree_restr <span class="free">S'</span> <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>  set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> one_call_in_path <span class="bound">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_paths_conv_free_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> paths_singles<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> one_call_in_path <span class="bound">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S'</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_id_conv<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> *
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_singles'<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S'</span><span class="main">)</span> <span class="free">xs</span> <span class="main">∈</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">S'</span><span class="main">)</span> <span class="main">`</span> paths <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> imageI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> paths <span class="main">(</span>ttree_restr <span class="free">S'</span> <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_paths_conv_free_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="comment1">(* TODO: unused *)</span>
<span class="keyword1" id="CoCallImplTTreeSafe-substitute_not_carrier"><span class="command">lemma</span></span> substitute_not_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> carrier <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> carrier <span class="main">(</span><span class="free">f</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span>  carrier <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ttree_restr <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> ttree_restr <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ttree_rest_substitute<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> carrier <span class="main">(</span><span class="free">f</span> <span class="skolem">x'</span><span class="main">)</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="free">f</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> carrier <span class="main">(</span>ttree_restr <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∉</span> carrier <span class="main">(</span>ttree_restr <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: unused *)</span>
<span class="keyword1" id="CoCallImplTTreeSafe-substitute_below_singlesI"><span class="command">lemma</span></span> substitute_below_singlesI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊑</span> singles <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> carrier <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span> <span class="main">⊑</span> singles <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ttree_belowI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="free">f</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>singles <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitute_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">t</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span> <span class="main">∈</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">⊑</span> singles <span class="skolem">S</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊑</span> singles <span class="skolem">S</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"TTree-HOLCF.nxt_mono"</span> below_trans nxt_singles_below_singles<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹carrier <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">⊑</span> singles <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> both_below_singles1<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
      <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹carrier <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>singles <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main">)</span> 
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹carrier <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> carrier <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">⊑</span> singles <span class="skolem">S</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊑</span> nxt <span class="main">(</span>singles <span class="skolem">S</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nxt_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> carrier <span class="main">(</span>nxt <span class="main">(</span>singles <span class="skolem">S</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> carrier_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> carrier <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> carrier <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> carrier <span class="main">(</span>substitute <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">(</span>nxt <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> substitute_not_carrier<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>  
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹carrier <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> carrier <span class="main">(</span>f_nxt <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">x</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> xs
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Union_paths_carrier<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> IH
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> paths <span class="main">(</span>without <span class="skolem">x</span> <span class="main">(</span>singles <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> paths_withoutI<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_path<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> IH
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_path<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="TTreeImplCardinality">
<div class="head">
<h1>Theory TTreeImplCardinality</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TTreeImplCardinality
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#TTreeAnalysisSig">TTreeAnalysisSig</a> <a href="#CardinalityAnalysisSig">CardinalityAnalysisSig</a> <span class="quoted">"<a href="Cardinality-Domain-Lists.html">Cardinality-Domain-Lists</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> TTreeAnalysis
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">unstack</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"stack <span class="main">⇒</span> exp <span class="main">⇒</span> exp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unstack</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">unstack</span> <span class="main">(</span>Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free">unstack</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">unstack</span> <span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free">unstack</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">unstack</span> <span class="main">(</span>Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free">unstack</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">unstack</span> <span class="main">(</span>Dummy <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free">unstack</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Fstack</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Arity list <span class="main">⇒</span> stack <span class="main">⇒</span> var ttree"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstack</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Fstack</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>Alts <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Texp</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⊕⊕</span> <span class="free">Texp</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">⊗⊗</span> <span class="free">Fstack</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Fstack</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span>Arg <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> many_calls <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊗⊗</span> <span class="free">Fstack</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Fstack</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Fstack</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>



<span class="comment1">(*
lemma carrier_Fstack[simp]: "carrier (Fstack S) = ap S"
  by (induction S rule: Fstack.induct) (auto simp add: empty_is_bottom[symmetric])
*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">prognosis</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"AEnv <span class="main">⇒</span> Arity list <span class="main">⇒</span> Arity <span class="main">⇒</span> conf <span class="main">⇒</span> var <span class="main">⇒</span> two"</span></span>
   <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prognosis</span> <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ae</span></span></span><span class="main">)</span> <span class="main">(</span>thunks <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⊗⊗</span> Fstack <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TTreeImplCardinalitySafe">
<div class="head">
<h1>Theory TTreeImplCardinalitySafe</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TTreeImplCardinalitySafe
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#TTreeImplCardinality">TTreeImplCardinality</a> <a href="#TTreeAnalysisSpec">TTreeAnalysisSpec</a> <a href="#CardinalityAnalysisSpec">CardinalityAnalysisSpec</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="TTreeImplCardinalitySafe-pathsCard_paths_nxt"><span class="command">lemma</span></span> pathsCard_paths_nxt<span class="main">:</span>  <span class="quoted"><span class="quoted">"pathsCard <span class="main">(</span>paths <span class="main">(</span>nxt <span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> record_call <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>pathsCard <span class="main">(</span>paths <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> pathsCard_below<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ monofun_cfun_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> paths_Card_above<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fun_belowI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> record_call_simp two_pred_two_add_once<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="TTreeImplCardinalitySafe-pathsCards_none"><span class="command">lemma</span></span> pathsCards_none<span class="main">:</span> <span class="quoted"><span class="quoted">"pathsCard <span class="main">(</span>paths <span class="free">t</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> none <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> carrier <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pathCards_noneD<span class="main">)</span>

<span class="keyword1" id="TTreeImplCardinalitySafe-const_on_edom_disj"><span class="command">lemma</span></span> const_on_edom_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"const_on <span class="free">f</span> <span class="free">S</span> empty <span class="main">⟷</span> edom <span class="free">f</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_is_bottom edom_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> TTreeAnalysisCarrier
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1" id="TTreeImplCardinalitySafe-carrier_Fstack"><span class="command">lemma</span></span> carrier_Fstack<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>Fstack <span class="free">as</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Fstack.induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_is_bottom<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> carrier_Fexp <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1" id="TTreeImplCardinalitySafe-carrier_FBinds"><span class="command">lemma</span></span> carrier_FBinds<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span><span class="main">(</span>FBinds <span class="free">Γ</span><span class="main">⋅</span><span class="free">ae</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp.AnalBinds_lookup<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_is_bottom<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_is_bottom<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> carrier_Fexp <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> contra_subsetD domA_from_set map_of_fv_subset map_of_SomeD option.sel<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> TTreeAnalysisSafe
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisShape <span class="quoted">prognosis</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="main">::</span> <span class="quoted">heap</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ae</span> <span class="skolem">ae'</span> <span class="main">::</span> <span class="quoted">AEnv</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">u</span> <span class="skolem">e</span> <span class="skolem">S</span> <span class="skolem">as</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span> <span class="main">=</span> <span class="skolem">ae'</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Texp.AnalBinds_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> prognosis <span class="skolem">ae'</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">S</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"const_on <span class="main">(</span>prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ap <span class="skolem">S</span><span class="main">)</span> many"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ap <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> paths <span class="main">(</span>Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Fstack.induct<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> both_contains_arg1<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> both_contains_arg2<span class="main"><span class="main">]</span></span> paths_Cons_nxt<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> paths <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> both_contains_arg2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> substitute_contains_arg<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pathCard <span class="main">[</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">x</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">⊑</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_belowD paths_Card_above<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pathCard <span class="main">[</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">x</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> many"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pathCard_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> many"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> below_antisym<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="skolem">Δ</span> <span class="main">::</span> <span class="quoted">heap</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted">exp</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ae</span> <span class="main">::</span> <span class="quoted">AEnv</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="skolem">S</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">Γ</span> <span class="main">=</span> map_of <span class="skolem">Δ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"FBinds <span class="skolem">Γ</span> <span class="main">=</span> FBinds <span class="skolem">Δ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"thunks <span class="skolem">Γ</span> <span class="main">=</span> thunks <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cfun_eqI  thunks_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp.AnalBinds_lookup<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="main">::</span> <span class="quoted">heap</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted">exp</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ae</span> <span class="main">::</span> <span class="quoted">AEnv</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="skolem">S</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="main">::</span> <span class="quoted">heap</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted">exp</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ae</span> <span class="main">::</span> <span class="quoted">AEnv</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">S</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"FBinds <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">ae</span> <span class="main">=</span> FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Texp.AnalBinds_delete_bot<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Texp.AnalBinds_delete_lookup<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substitute_T_delete empty_is_bottom<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">S</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"once <span class="main">⊑</span> <span class="main">(</span>pathCard <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_add_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pathCard <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">⊑</span> pathsCard <span class="main">(</span><span class="main">{</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> paths_Card_above<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>single <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"single <span class="skolem">x</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">Texp</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Texp_Var<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="free">Texp</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> both_above_arg1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> substitute  <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> substitute_above_arg<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pathsCard <span class="main">(</span>paths <span class="main">…</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"once <span class="main">⊑</span> prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="main">(</span><span class="operator">rule</span> cont2cont_fun<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisApp <span class="quoted">prognosis</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">S</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>  <span class="main">⊗⊗</span> many_calls <span class="skolem">x</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span> <span class="main">=</span> many_calls <span class="skolem">x</span>  <span class="main">⊗⊗</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> both_assoc both_comm<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">intro</span> pathsCard_mono' paths_mono substitute_mono2' both_mono1' Texp_App<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisLam <span class="quoted">prognosis</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">y</span> <span class="skolem">x</span> <span class="skolem">S</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Texp</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊑</span> many_calls <span class="skolem">x</span>  <span class="main">⊗⊗</span> <span class="free">Texp</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Texp_subst both_mono2'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Texp_Lam<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Texp</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊗⊗</span> many_calls <span class="skolem">x</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span> <span class="main">=</span> many_calls <span class="skolem">x</span>  <span class="main">⊗⊗</span> <span class="free">Texp</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> both_assoc both_comm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>  
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="main">(</span>pred<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e</span><span class="main">,</span> Arg <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">intro</span> pathsCard_mono' paths_mono substitute_mono2' both_mono1'<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisVar <span class="quoted">prognosis</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="main">::</span> <span class="quoted">heap</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted">exp</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ae</span> <span class="main">::</span> <span class="quoted">AEnv</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="skolem">a</span> <span class="skolem">S</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>"</span></span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isVal <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> thunks <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> thunksE<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"f_nxt <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">u</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>nxt <span class="main">(</span>single <span class="skolem">x</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">u</span>  <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>nxt <span class="main">(</span>single <span class="skolem">x</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊗⊗</span> <span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">u</span> <span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> both_assoc both_comm<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>nxt <span class="main">(</span>single <span class="skolem">x</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pathsCard_mono' paths_mono substitute_mono2' both_mono1'  nxt_both_left<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>nxt <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>single <span class="skolem">x</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp.AnalBinds_lookup<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> record_call <span class="skolem">x</span> <span class="main">⋅</span><span class="main">(</span>pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>single <span class="skolem">x</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pathsCard_paths_nxt<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> record_call <span class="skolem">x</span> <span class="main">⋅</span><span class="main">(</span>pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">Texp</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun_arg pathsCard_mono' paths_mono substitute_mono2' both_mono1' Texp_Var<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> record_call <span class="skolem">x</span> <span class="main">⋅</span><span class="main">(</span>prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> record_call <span class="skolem">x</span><span class="main">⋅</span><span class="main">(</span>prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="main">::</span> <span class="quoted">heap</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted">exp</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ae</span> <span class="main">::</span> <span class="quoted">AEnv</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="skolem">a</span> <span class="skolem">S</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> isVal <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> thunksI<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"f_nxt <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> FBinds <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">ae</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_nxt_def Texp.AnalBinds_delete_to_fun_upd empty_is_bottom<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">u</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">u</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> substitute_cong_T<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_is_bottom<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>nxt <span class="main">(</span>single <span class="skolem">x</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">u</span>  <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>nxt <span class="main">(</span>single <span class="skolem">x</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊗⊗</span> <span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">u</span> <span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> both_assoc both_comm<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>nxt <span class="main">(</span>single <span class="skolem">x</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">x</span>  <span class="main">⊗⊗</span> <span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pathsCard_mono' paths_mono substitute_mono2' both_mono1'  nxt_both_left<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>nxt <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>single <span class="skolem">x</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp.AnalBinds_lookup<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> record_call <span class="skolem">x</span> <span class="main">⋅</span><span class="main">(</span>pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>single <span class="skolem">x</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pathsCard_paths_nxt<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> record_call <span class="skolem">x</span> <span class="main">⋅</span><span class="main">(</span>pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">Texp</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun_arg pathsCard_mono' paths_mono substitute_mono2' both_mono1' Texp_Var<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> record_call <span class="skolem">x</span> <span class="main">⋅</span><span class="main">(</span>prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">u</span> <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> record_call <span class="skolem">x</span><span class="main">⋅</span><span class="main">(</span>prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="main">::</span> <span class="quoted">heap</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted">exp</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ae</span> <span class="main">::</span> <span class="quoted">AEnv</span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">as</span> <span class="skolem">S</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isVal <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"repeatable <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Fun_repeatable<span class="main">)</span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Γ</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"thunks <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">=</span> thunks <span class="skolem">Γ</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="skolem">e</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_Cons <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thunks_domA<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fup<span class="main">⋅</span><span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">ae</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fup2 monofun_cfun_arg up_zero_top<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitute <span class="main">(</span><span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> fup<span class="main">⋅</span><span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">ae</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> substitute <span class="main">(</span><span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> substitute_mono1' fun_upd_mono below_refl monofun_cfun_arg<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> substitute <span class="main">(</span><span class="main">(</span><span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> empty<span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹repeatable <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> substitute_remove_anyways<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> empty<span class="main">)</span> <span class="main">=</span> FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_idem Texp.AnalBinds_not_there empty_is_bottom<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="main">0</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="main">0</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> Upd <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> pathsCard_mono' paths_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisIfThenElse <span class="quoted">prognosis</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">Γ</span> <span class="skolem">scrut</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">S</span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Texp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊗⊗</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊕⊕</span> <span class="free">Texp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">Texp</span> <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Texp_IfThenElse<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊗⊗</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊕⊕</span> <span class="free">Texp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> substitute_mono2'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> both_mono1'<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="skolem">ae</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">as</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">,</span> Alts <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">e2</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> pathsCard_mono' paths_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">Γ</span> <span class="skolem">b</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">S</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Texp</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e1</span> <span class="keyword1">else</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊑</span> <span class="free">Texp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊕⊕</span> <span class="free">Texp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> either_above_arg1 either_above_arg2<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e1</span> <span class="keyword1">else</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="main">(</span>Bool <span class="skolem">b</span><span class="main">)</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊗⊗</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e1</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊕⊕</span> <span class="free">Texp</span> <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> substitute_mono2'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> both_mono1'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ both_above_arg2<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e1</span> <span class="keyword1">else</span> <span class="skolem">e2</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> prognosis <span class="skolem">ae</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">as</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Bool <span class="skolem">b</span><span class="main">,</span> Alts <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">#</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pathsCard_mono' paths_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> TTreeAnalysisCardinalityHeap
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">cHeap</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cHeap</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> pathsCard <span class="main">(</span>paths <span class="main">(</span><span class="free">Theap</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="TTreeImplCardinalitySafe-cHeap_simp"><span class="command">lemma</span></span> cHeap_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cHeap <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> pathsCard <span class="main">(</span>paths <span class="main">(</span><span class="free">Theap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cHeap_def  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> beta_cfun<span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">sublocale</span></span> CardinalityHeap <span class="quoted">cHeap</span><span class="keyword1"><span class="command">.</span></span>
 
  <span class="keyword1"><span class="command">sublocale</span></span> CardinalityHeapSafe <span class="quoted">cHeap</span> <span class="quoted"><span class="free">Aheap</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> thunks <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"many <span class="main">⊑</span> <span class="main">(</span>cHeap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"many <span class="main">⊑</span> pathsCard <span class="main">(</span>paths <span class="main">(</span><span class="free">Theap</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cHeap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">∈</span> <span class="main">(</span>paths <span class="main">(</span><span class="free">Theap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span>one_call_in_path <span class="skolem">x</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pathsCard_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Theap_thunk<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>cHeap <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cHeap_def Union_paths_carrier carrier_Fheap<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisEdom <span class="quoted">prognosis</span> 
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">S</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="skolem">Γ</span> <span class="main">∪</span> fv <span class="skolem">e</span> <span class="main">∪</span> fv <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Union_paths_carrier<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> carrier_substitute_below<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> carrier_Fexp <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_edom<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> carrier_Fstack<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ap_fv_subset<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> carrier_FBinds<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisLet <span class="quoted">prognosis</span> <span class="quoted">cHeap</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Δ</span> <span class="skolem">Γ</span> <span class="main">::</span> <span class="quoted">heap</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted">exp</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">S</span> <span class="main">::</span> <span class="quoted">stack</span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="skolem">ae</span> <span class="main">::</span> <span class="quoted">AEnv</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">Arity</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">as</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">Δ</span> <span class="main">♯*</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">Δ</span> <span class="main">♯*</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"edom <span class="skolem">ae</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Δ</span> <span class="main">∩</span> edom <span class="skolem">ae</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹atom <span class="main">`</span> domA <span class="skolem">Δ</span> <span class="main">♯*</span> <span class="skolem">Γ</span>›</span></span><span class="main">]</span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹atom <span class="main">`</span> domA <span class="skolem">Δ</span> <span class="main">♯*</span> <span class="skolem">S</span>›</span></span><span class="main">]</span> 
            <span class="quoted"><span class="quoted">‹edom <span class="skolem">ae</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> upds <span class="skolem">S</span>›</span></span> ups_fv_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> const_on1<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> const_on <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>carrier <span class="main">(</span><span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> empty"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> const_on_edom_disj <span class="keyword1"><span class="command">using</span></span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹atom <span class="main">`</span> domA <span class="skolem">Δ</span> <span class="main">♯*</span> <span class="skolem">Γ</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> carrier_FBinds<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Texp.edom_AnalBinds<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> const_on2<span class="main">:</span>  <span class="quoted"><span class="quoted">"const_on <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>carrier <span class="main">(</span>Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> empty"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> const_on_edom_disj <span class="keyword1"><span class="command">using</span></span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹atom <span class="main">`</span> domA <span class="skolem">Δ</span> <span class="main">♯*</span> <span class="skolem">S</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> carrier_FBinds<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> carrier_Fstack<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Texp.edom_AnalBinds<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ap_fv_subset <span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span>  const_on3<span class="main">:</span> <span class="quoted"><span class="quoted">"const_on <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="main">-</span> domA <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span> TTree.empty"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> const_on4<span class="main">:</span> <span class="quoted"><span class="quoted">"const_on <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>domA <span class="skolem">Γ</span><span class="main">)</span> TTree.empty"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> const_on_edom_disj <span class="keyword1"><span class="command">using</span></span> fresh_distinct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹atom <span class="main">`</span> domA <span class="skolem">Δ</span> <span class="main">♯*</span> <span class="skolem">Γ</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Texp.edom_AnalBinds<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> disj1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> carrier <span class="main">(</span><span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> domA <span class="skolem">Δ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹atom <span class="main">`</span> domA <span class="skolem">Δ</span> <span class="main">♯*</span> <span class="skolem">Γ</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> carrier_FBinds<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> disj1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> carrier <span class="main">(</span><span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">-</span> domA <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> disj2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> carrier <span class="main">(</span>Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∩</span> domA <span class="skolem">Δ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fresh_distinct_fv<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹atom <span class="main">`</span> domA <span class="skolem">Δ</span> <span class="main">♯*</span> <span class="skolem">S</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> carrier_Fstack<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> disj2'<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">-</span> domA <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    

    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>FBinds <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">ae</span> <span class="main">⊔</span> <span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⊗⊗</span> <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Δ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> True fresh_distinct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹atom <span class="main">`</span> domA <span class="skolem">Δ</span> <span class="main">♯*</span> <span class="skolem">Γ</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjoint_iff_not_equal domA_def map_of_eq_None_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ae</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹domA <span class="skolem">Δ</span> <span class="main">∩</span> edom <span class="skolem">ae</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp.AnalBinds_lookup empty_is_bottom<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> option.case_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">Δ</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domA_def map_of_eq_None_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">using</span></span> edom_Aheap <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> contra_subsetD edomIff<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Texp.AnalBinds_lookup empty_is_bottom<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> option.case_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> FBinds <span class="main">=</span> ext<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    
    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>thunks <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substitute_substitute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> const_on1<span class="main"><span class="main">]</span></span> FBinds<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> substitute_cong_T<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> const_on3
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thunks_domA<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"substitute <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> substitute <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> substitute_cong_T<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> const_on4
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thunks_domA<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"substitute <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> substitute <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> substitute_only_empty_both<span class="main"><span class="main">[</span></span><span class="operator">OF</span> const_on2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> calculation
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> eq_imp_below<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">note</span></span> env_restr_split<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Δ</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Δ</span> 
        <span class="main">=</span> pathsCard <span class="main">(</span>paths <span class="main">(</span>ttree_restr <span class="main">(</span>domA <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_paths_conv_free_restr ttree_restr_both ttree_rest_substitute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disj1<span class="main"><span class="main">]</span></span>  ttree_restr_is_empty<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disj2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ttree_restr <span class="main">(</span>domA <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">Theap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Theap_substitute<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="skolem">Δ</span><span class="main">)</span> <span class="main">=</span>
          pathsCard <span class="main">(</span>paths <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Γ</span><span class="main">⋅</span><span class="skolem">ae</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>ttree_restr <span class="main">(</span><span class="main">-</span> domA <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊗⊗</span> Fstack <span class="skolem">as</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_paths_conv_free_restr2 ttree_rest_substitute2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disj1' const_on3<span class="main"><span class="main">]</span></span> ttree_restr_both  ttree_restr_noop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disj2'<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ttree_restr <span class="main">(</span><span class="main">-</span> domA <span class="skolem">Δ</span><span class="main">)</span> <span class="main">(</span>substitute <span class="main">(</span>FBinds <span class="skolem">Δ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>thunks <span class="skolem">Δ</span><span class="main">)</span>  <span class="main">(</span><span class="free">Texp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">Texp</span> <span class="main">(</span>Terms.Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Texp_Let<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prognosis <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="skolem">ae</span><span class="main">)</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊑</span> cHeap <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> prognosis <span class="skolem">ae</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Terms.Let <span class="skolem">Δ</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cHeap_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> CardinalityPrognosisSafe <span class="quoted">prognosis</span> <span class="quoted">cHeap</span> <span class="quoted"><span class="free">Aheap</span></span> <span class="quoted"><span class="free">Aexp</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CallArityEnd2EndSafe">
<div class="head">
<h1>Theory CallArityEnd2EndSafe</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CallArityEnd2EndSafe
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#CallArityEnd2End">CallArityEnd2End</a> <a href="#CardArityTransformSafe">CardArityTransformSafe</a> <a href="#CoCallImplSafe">CoCallImplSafe</a> <a href="#CoCallImplTTreeSafe">CoCallImplTTreeSafe</a> <a href="#TTreeImplCardinalitySafe">TTreeImplCardinalitySafe</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> CallArityEnd2EndSafe
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">sublocale</span></span> CoCallImplSafe<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">sublocale</span></span> CallArityEnd2End<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">transform_syn'</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒯⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒯<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">a</span></span></span></sub><span class="hidden">⇙</span> <span class="main">≡</span> transform <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1" id="CallArityEnd2EndSafe-end2end"><span class="command">lemma</span></span> end2end<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c'</span> <span class="main">⟹</span>
  <span class="main">¬</span> boring_step <span class="free">c'</span> <span class="main">⟹</span>
  heap_upds_ok_conf <span class="free">c</span> <span class="main">⟹</span>
  consistent <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">ce</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="free">c</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">ae'</span> <span class="bound">ce'</span> <span class="bound">a'</span> <span class="bound">as'</span> <span class="bound">r'</span><span class="main">.</span> consistent  <span class="main">(</span><span class="bound">ae'</span><span class="main">,</span> <span class="bound">ce'</span><span class="main">,</span> <span class="bound">a'</span><span class="main">,</span> <span class="bound">as'</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="free">c'</span> <span class="main">∧</span> conf_transform  <span class="main">(</span><span class="free">ae</span><span class="main">,</span> <span class="free">ce</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">as</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="free">c</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> conf_transform  <span class="main">(</span><span class="bound">ae'</span><span class="main">,</span> <span class="bound">ce'</span><span class="main">,</span> <span class="bound">a'</span><span class="main">,</span> <span class="bound">as'</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_arity_transform_safe<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> end2end_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> closed<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span><span class="free">v</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"isVal <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Γ'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">v'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> 𝒯<span class="hidden">⇘</span><sub><span class="main">0</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">Γ'</span><span class="main">,</span><span class="free">v'</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"isVal <span class="free">v'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>domA <span class="free">Γ'</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>domA <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> boring_step <span class="main">(</span><span class="free">Γ</span><span class="main">,</span><span class="free">v</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> boring_step.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"heap_upds_ok_conf <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="main">⊥</span><span class="main">,</span><span class="main">⊥</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> closed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closed_consistent<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ae</span></span> <span class="skolem"><span class="skolem">ce</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    *<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent  <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span><span class="free">v</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    **<span class="main">:</span> <span class="quoted"><span class="quoted">"conf_transform  <span class="main">(</span><span class="main">⊥</span><span class="main">,</span> <span class="main">⊥</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> conf_transform <span class="main">(</span><span class="skolem">ae</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span><span class="free">v</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> end2end<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_transform Aeta_expand <span class="skolem">ae</span> <span class="main">(</span>map_transform transform <span class="skolem">ae</span> <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span>set <span class="skolem">r</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"transform <span class="skolem">a</span> <span class="free">v</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">r</span> <span class="main">⊆</span> domA <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conf_transform  <span class="main">(</span><span class="main">⊥</span><span class="main">,</span> <span class="main">⊥</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span>transform <span class="main">0</span> <span class="free">e</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> **
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> transform <span class="main">0</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="var">?Γ</span><span class="main">,</span> <span class="var">?v</span><span class="main">,</span> map Dummy <span class="main">(</span>rev <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isVal <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="free">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>transform <span class="main">0</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> closed
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fv_transform<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> sestoftUnGC'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[]</span><span class="main">,</span> transform <span class="main">0</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="var">?Γ</span><span class="main">,</span> <span class="var">?v</span><span class="main">,</span> map Dummy <span class="main">(</span>rev <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="var">?v</span>›</span></span> <span class="quoted"><span class="quoted">‹fv <span class="main">(</span>transform <span class="main">0</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> transform <span class="main">0</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="var">?v</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Γ</span> <span class="main">=</span> restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">r</span> <span class="main">⊆</span> domA <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>domA <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>domA <span class="var">?Γ</span> <span class="main">∪</span> <span class="main">(</span>set <span class="skolem">r</span> <span class="main">∩</span> domA <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">card</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span>domA <span class="var">?Γ</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>set <span class="skolem">r</span> <span class="main">∩</span> domA <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_Un_disjoint<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Γ</span> <span class="main">=</span> restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ'</span>›</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">r</span> <span class="main">∩</span> domA <span class="free">Γ</span> <span class="main">=</span> set <span class="skolem">r</span> <span class="main">∩</span> domA <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">r</span> <span class="main">⊆</span> domA <span class="free">Γ</span>›</span></span>  <span class="quoted"><span class="quoted">‹set <span class="skolem">r</span> <span class="main">⊆</span> domA <span class="skolem">Γ'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>domA <span class="main">(</span>restrictA <span class="main">(</span><span class="main">-</span> set <span class="skolem">r</span><span class="main">)</span> <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>set <span class="skolem">r</span> <span class="main">∩</span> domA <span class="skolem">Γ'</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>domA <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Un_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">card</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>domA <span class="skolem">Γ'</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>domA <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[]</span><span class="main">,</span> transform <span class="main">0</span> <span class="free">e</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="var">?v</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>›</span></span>  <span class="quoted"><span class="quoted">‹isVal <span class="var">?v</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CallArityEnd2EndSafe-fresh_var_eqE"><span class="command">lemma</span></span> fresh_var_eqE<span class="main">[</span><span class="operator">elim_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fresh_var <span class="free">e</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span>  fv <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_var_not_free<span class="main">)</span>

<span class="keyword1" id="CallArityEnd2EndSafe-example1"><span class="command">lemma</span></span> example1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted">exp</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">::</span> <span class="quoted">var</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Aexp_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> Aexp <span class="free">e</span><span class="main">⋅</span><span class="bound">a</span> <span class="main">=</span> esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="main">⊔</span> esing <span class="free">y</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ccExp_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> CCexp <span class="free">e</span><span class="main">⋅</span><span class="bound">a</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transform <span class="main">1</span> <span class="free">e</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"isVal <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≠</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≠</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">z</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"transform <span class="main">1</span> <span class="main">(</span><span class="keyword1">let</span> <span class="free">y</span> <span class="keyword1">be</span>  App <span class="main">(</span>Var <span class="free">f</span><span class="main">)</span> <span class="free">g</span> <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e</span> <span class="keyword1">in</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
         <span class="keyword1">let</span> <span class="free">y</span> <span class="keyword1">be</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">z</span><span class="main">].</span> App <span class="main">(</span>App <span class="main">(</span>Var <span class="free">f</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">z</span><span class="main">].</span> App <span class="free">e</span> <span class="free">z</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted">edom</span><span class="main">,</span> <span class="operator">OF</span> Aexp_e<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> fv <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> Aexp_edom' insert_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> nonrec <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonrec_def<span class="main">)</span>
 
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="free">e</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"thunks <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_Cons<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"CCfix <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span>esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">1</span><span class="main">)</span> <span class="main">⊔</span> esing <span class="free">y</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> CCfix_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fix_bottom_iff ccBindsExtra_simp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ccBind_eq disj ccExp_e<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Afix <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span>esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">1</span><span class="main">)</span> <span class="main">⊔</span> esing <span class="free">y</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Afix_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disj Aexp_e<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">z</span> <span class="free">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disj Aexp_e<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Aheap <span class="main">[</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> App <span class="main">(</span>Var <span class="free">f</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e</span> <span class="keyword1">in</span> Var <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="main">1</span> <span class="main">=</span> esing <span class="free">y</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span>Aexp <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e</span> <span class="keyword1">in</span> Var <span class="free">x</span> <span class="main">)</span><span class="main">⋅</span><span class="main">1</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  Aheap_nonrec_simp ABind_nonrec_eq pure_fresh fresh_at_base disj<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Aexp <span class="main">(</span><span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="free">e</span> <span class="keyword1">in</span> Var <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> esing <span class="free">y</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join disj<span class="main">)</span>
    
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Aheap <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="main">1</span> <span class="main">=</span> esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join disj<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Aeta_expand <span class="main">1</span> <span class="main">(</span>App <span class="main">(</span>Var <span class="free">f</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">z</span><span class="main">].</span> App <span class="main">(</span>App <span class="main">(</span>Var <span class="free">f</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_is_inc_zero <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> exp_assn.eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> change_Lam_Variable<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">z</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"fresh_var <span class="main"><span class="main">(</span></span>App <span class="main"><span class="main">(</span></span>Var <span class="free"><span class="free">f</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">g</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_at_base pure_fresh disj <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> flip_fresh_fresh  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fresh_var_eqE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Aeta_expand <span class="main">1</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">z</span><span class="main">].</span> App <span class="free">e</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_is_inc_zero <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> exp_assn.eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> change_Lam_Variable<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">z</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"fresh_var <span class="free"><span class="free">e</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_at_base pure_fresh disj fresh <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> flip_fresh_fresh  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fresh_var_eqE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Let_eq_iff <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_transform_Cons disj<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ArityAnalysisCorrDenotational">
<div class="head">
<h1>Theory ArityAnalysisCorrDenotational</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ArityAnalysisCorrDenotational
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#ArityAnalysisSpec">ArityAnalysisSpec</a> <a href="../../launchbury/theories/#Denotational">Launchbury.Denotational</a> <a href="#ArityTransform">ArityTransform</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> ArityAnalysisLetSafe
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Arity <span class="main">⇒</span> Value <span class="main">⇒</span> Value <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
 <span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> <span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="keyword1">↓Fn</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="keyword1">↓Fn</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">eq</span> <span class="main">(</span>inc<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="main">0</span> <span class="free">v</span> <span class="free">v'</span> <span class="main">⟷</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq.intros<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-eq_inc_simp"><span class="command">lemma</span></span> eq_inc_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq <span class="main">(</span>inc<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="free">v1</span> <span class="free">v2</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">.</span> eq <span class="free">n</span> <span class="main">(</span><span class="free">v1</span> <span class="keyword1">↓Fn</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">v2</span> <span class="keyword1">↓Fn</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq.intros<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-eq_FnI"><span class="command">lemma</span></span> eq_FnI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> eq <span class="main">(</span>pred<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">f1</span><span class="main">⋅</span><span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">f2</span><span class="main">⋅</span><span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> eq <span class="free">n</span> <span class="main">(</span>Fn<span class="main">⋅</span><span class="free">f1</span><span class="main">)</span> <span class="main">(</span>Fn<span class="main">⋅</span><span class="free">f2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Arity_ind<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq.intros cfun_eqI<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-eq_refl"><span class="command">lemma</span></span> eq_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="free">a</span> <span class="free">v</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Arity_ind<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq.intros<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-eq_trans"><span class="command">lemma</span></span> eq_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="free">a</span> <span class="free">v1</span> <span class="free">v2</span> <span class="main">⟹</span> eq <span class="free">a</span> <span class="free">v2</span> <span class="free">v3</span> <span class="main">⟹</span> eq <span class="free">a</span> <span class="free">v1</span> <span class="free">v3</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quoted"><span class="free">v3</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Arity_ind<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-eq_Fn"><span class="command">lemma</span></span> eq_Fn<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="free">a</span> <span class="free">v1</span> <span class="free">v2</span> <span class="main">⟹</span> eq <span class="main">(</span>pred<span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">v1</span> <span class="keyword1">↓Fn</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">v2</span> <span class="keyword1">↓Fn</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Arity_ind<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> 0 inc<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_inc_simp<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-eq_inc_same"><span class="command">lemma</span></span> eq_inc_same<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="free">a</span> <span class="free">v1</span> <span class="free">v2</span> <span class="main">⟹</span> eq <span class="main">(</span>inc<span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">v1</span> <span class="free">v2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span>  <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Arity_ind<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> 0 inc<span class="main"><span class="main">]</span></span><span class="main">)</span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_inc_simp<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-eq_mono"><span class="command">lemma</span></span> eq_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">a'</span> <span class="main">⟹</span> eq <span class="free">a'</span> <span class="free">v1</span> <span class="free">v2</span> <span class="main">⟹</span> eq <span class="free">a</span> <span class="free">v1</span> <span class="free">v2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Arity_ind<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> 0 inc<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>inc <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eq <span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="free">v1</span> <span class="free">v2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"inc<span class="main">⋅</span><span class="skolem">a</span> <span class="main">=</span> <span class="free">a'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> inc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹inc<span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊑</span> <span class="free">a'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">⊑</span> <span class="free">a'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_def<span class="main">)</span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this inc.prems<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq <span class="skolem">a</span> <span class="free">v1</span> <span class="free">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inc.IH<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_inc_same<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-eq_join"><span class="command">lemma</span></span> eq_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="main">(</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">a'</span><span class="main">)</span> <span class="free">v1</span> <span class="free">v2</span> <span class="main">⟷</span> eq <span class="free">a</span> <span class="free">v1</span> <span class="free">v2</span> <span class="main">∧</span> eq <span class="free">a'</span> <span class="free">v1</span> <span class="free">v2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Arity_total<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">a'</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> join_above1<span class="main"><span class="main">]</span></span> eq_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> join_self_below<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> join_self_below<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-eq_adm"><span class="command">lemma</span></span> eq_adm<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> cont <span class="free">g</span> <span class="main">⟹</span> adm <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> eq <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Arity_ind<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> 0 inc<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> inc
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_inc_simp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> adm_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span> inc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">eqρ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"AEnv <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> Value<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> Value<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 eqρI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="bound">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="bound">a</span> <span class="main">⟹</span> eq <span class="bound">a</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ1</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ2</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">eqρ</span> <span class="free"><span class="bound"><span class="entity">ae</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ2</span></span></span>"</span></span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-eqρE"><span class="command">lemma</span></span> eqρE<span class="main">:</span> <span class="quoted"><span class="quoted">"eqρ <span class="free">ae</span> <span class="free">ρ1</span> <span class="free">ρ2</span> <span class="main">⟹</span> <span class="free">ae</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="free">a</span> <span class="main">⟹</span> eq <span class="free">a</span> <span class="main">(</span><span class="free">ρ1</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">ρ2</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqρ.simps<span class="main">)</span> 

<span class="keyword1" id="ArityAnalysisCorrDenotational-eqρ_refl"><span class="command">lemma</span></span> eqρ_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eqρ <span class="free">ae</span> <span class="free">ρ</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqρ.simps<span class="main">)</span> 

<span class="keyword1" id="ArityAnalysisCorrDenotational-eq_esing_up"><span class="command">lemma</span></span> eq_esing_up<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span>esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">ρ1</span> <span class="free">ρ2</span> <span class="main">⟷</span> eq <span class="free">a</span> <span class="main">(</span><span class="free">ρ1</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">ρ2</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqρ.simps<span class="main">)</span> 
 
<span class="keyword1" id="ArityAnalysisCorrDenotational-eqρ_mono"><span class="command">lemma</span></span> eqρ_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="main">⊑</span> <span class="free">ae'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="free">ae'</span> <span class="free">ρ1</span> <span class="free">ρ2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="free">ae</span> <span class="free">ρ1</span> <span class="free">ρ2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eqρI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ae</span> <span class="main">⊑</span> <span class="free">ae'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"up<span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊑</span> <span class="free">ae'</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_belowD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ae'</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Exh_Up below_antisym minimal<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹eqρ <span class="free">ae'</span> <span class="free">ρ1</span> <span class="free">ρ2</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq <span class="skolem">a'</span> <span class="main">(</span><span class="free">ρ1</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">ρ2</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqρ.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹up<span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊑</span> <span class="free">ae'</span> <span class="skolem">x</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ae'</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eq <span class="skolem">a</span> <span class="main">(</span><span class="free">ρ1</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">ρ2</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_mono up_below<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-eqρ_adm"><span class="command">lemma</span></span> eqρ_adm<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> cont <span class="free">g</span> <span class="main">⟹</span> adm <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> eqρ <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqρ.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> adm_lemmas eq_adm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> cont2cont_fun<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
 
<span class="keyword1" id="ArityAnalysisCorrDenotational-up_join_eq_up"><span class="command">lemma</span></span> up_join_eq_up<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"up<span class="main">⋅</span><span class="main">(</span><span class="free">n</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span> <span class="main">⊔</span> up<span class="main">⋅</span><span class="free">n'</span> <span class="main">=</span> up<span class="main">⋅</span><span class="main">(</span><span class="free">n</span> <span class="main">⊔</span> <span class="free">n'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lub_is_join<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_lub_def <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">u</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
 
<span class="keyword1" id="ArityAnalysisCorrDenotational-eqρ_join"><span class="command">lemma</span></span> eqρ_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">ae</span> <span class="main">⊔</span> <span class="free">ae'</span><span class="main">)</span> <span class="free">ρ1</span> <span class="free">ρ2</span> <span class="main">⟷</span> eqρ <span class="free">ae</span> <span class="free">ρ1</span> <span class="free">ρ2</span> <span class="main">∧</span> eqρ <span class="free">ae'</span> <span class="free">ρ1</span> <span class="free">ρ2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eqρ_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> join_above1<span class="main"><span class="main">]</span></span> eqρ_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> join_above2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eqρI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ae</span> <span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eqρE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ae'</span> <span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eqρE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-eqρ_override"><span class="command">lemma</span></span> eqρ_override<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"eqρ <span class="free">ae</span> <span class="main">(</span><span class="free">ρ1</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">ρ2</span><span class="main">)</span> <span class="main">(</span><span class="free">ρ1'</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span><span class="free">ρ2'</span><span class="main">)</span> <span class="main">⟷</span> eqρ <span class="free">ae</span> <span class="main">(</span><span class="free">ρ1</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ρ1'</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>  eqρ <span class="free">ae</span> <span class="main">(</span><span class="free">ρ2</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">ρ2'</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_env_restr_eq eqρ.simps lookup_override_on_eq<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-Aexp_heap_below_Aheap"><span class="command">lemma</span></span> Aexp_heap_below_Aheap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="free">a'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="free">e'</span><span class="main">⋅</span><span class="free">a'</span> <span class="main">⊑</span> <span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="free">e'</span><span class="main">⋅</span><span class="free">a'</span> <span class="main">=</span> ABind <span class="free">x</span> <span class="free">e'</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> join_comm fun_meet_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monofun_cfun_fun<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ABind_below_ABinds<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹map_of <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> ABinds <span class="free">Γ</span><span class="main">⋅</span><span class="main">(</span><span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">⊔</span>  <span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> Aexp_Let
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-Aexp_body_below_Aheap"><span class="command">lemma</span></span> Aexp_body_below_Aheap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊑</span> <span class="free">Aheap</span> <span class="free">Γ</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> join_above2 Aexp_Let<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1" id="ArityAnalysisCorrDenotational-Aexp_correct"><span class="command">lemma</span></span> Aexp_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="free">e</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="free">ρ1</span> <span class="free">ρ2</span> <span class="main">⟹</span> eq <span class="free">a</span> <span class="main">(</span><span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="free">ρ1</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">(</span><span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="free">ρ2</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ1</span></span> <span class="quoted"><span class="free">ρ2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> transform.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> App Lam Var Let Bool IfThenElse<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">a</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">ρ1</span> <span class="skolem">ρ2</span>›</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span>esing <span class="skolem">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ρ1</span> <span class="skolem">ρ2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eqρ_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_Var_singleton<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">a</span> <span class="skolem">e</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">ρ1</span> <span class="skolem">ρ2</span>›</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">⊔</span> esing <span class="skolem">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ρ1</span> <span class="skolem">ρ2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eqρ_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_App<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>inc<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ρ1</span> <span class="skolem">ρ2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ1</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">ρ2</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> App<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq.cases<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">a</span> <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">ρ1</span> <span class="skolem">ρ2</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span>env_delete <span class="skolem">x</span> <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ρ1</span> <span class="skolem">ρ2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eqρ_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_Lam<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>pred<span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ρ1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ρ2</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eqρI <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eqρE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq_FnI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bool <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfThenElse <span class="skolem">a</span> <span class="skolem">scrut</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">ρ1</span> <span class="skolem">ρ2</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">ρ1</span> <span class="skolem">ρ2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eqρ_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_IfThenElse<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">scrut</span><span class="main">⋅</span><span class="main">0</span><span class="main">)</span> <span class="skolem">ρ1</span> <span class="skolem">ρ2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">ρ1</span> <span class="skolem">ρ2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">ρ1</span> <span class="skolem">ρ2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> IfThenElse<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> IfThenElse<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> IfThenElse<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="skolem">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ2</span></sub><span class="hidden">⇙</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">a</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ1</span><span class="main">)</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_HSem_ind<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> adm bottom step<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eqρ_adm <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">ρ1'</span> <span class="skolem">ρ2'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eqρI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">a'</span>
      <span class="keyword3"><span class="command">assume</span></span> ass<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eq <span class="skolem">a'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ρ1</span> ++<span class="hidden">⇘</span><sub>domA <span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span> <span class="skolem">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ1'</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ρ2</span> ++<span class="hidden">⇘</span><sub>domA <span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span> <span class="skolem">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ2'</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domA_map_of_Some_the<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ass <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="skolem">a'</span> <span class="main">⊑</span> <span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Aexp_heap_below_Aheap<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="skolem">a'</span><span class="main">)</span> <span class="skolem">ρ1'</span> <span class="skolem">ρ2'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eqρ_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eq <span class="skolem">a'</span> <span class="main">(</span><span class="main">⟦</span> <span class="skolem">e'</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ1'</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">(</span><span class="main">⟦</span> <span class="skolem">e'</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ2'</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_of_SomeD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹map_of <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookupEvalHeap'<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> False
        <span class="keyword1"><span class="command">with</span></span> edom_Aheap <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> edom <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ass <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edomIff<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">ρ1</span> <span class="skolem">ρ2</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq <span class="skolem">a'</span> <span class="main">(</span><span class="skolem">ρ1</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ρ2</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eqρE<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ1</span><span class="main">)</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eqρ_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_body_below_Aheap<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eq <span class="skolem">a</span> <span class="main">(</span><span class="main">⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ1</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">(</span><span class="main">⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ2</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-ESem_ignores_fresh"><span class="command">lemma</span></span> ESem_ignores_fresh<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span><span class="main">(</span>fresh_var <span class="free">e</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ESem_fresh_cong env_restr_fun_upd_other fresh_var_not_free<span class="main">)</span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-eq_Aeta_expand"><span class="command">lemma</span></span> eq_Aeta_expand<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="free">a</span> <span class="main">(</span><span class="main">⟦</span> Aeta_expand <span class="free">a</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">(</span><span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">ρ</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Arity_ind<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> 0 inc<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_inc_simp <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ArityAnalysisCorrDenotational-Arity_transformation_correct"><span class="command">lemma</span></span> Arity_transformation_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="free">a</span> <span class="main">(</span><span class="main">⟦</span> 𝒯<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">(</span><span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> transform.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> App Lam Var Let Bool IfThenElse<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Var
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">a</span> <span class="skolem">e</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ρ <span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ρ</span></span> <span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq.cases<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq_FnI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bool <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfThenElse <span class="skolem">a</span> <span class="skolem">e</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">a</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq <span class="skolem">a</span> <span class="main">(</span><span class="main">⟦</span> transform <span class="skolem">a</span> <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">(</span><span class="main">⟦</span> transform <span class="skolem">a</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span>map_transform Aeta_expand <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>map_transform transform <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq <span class="skolem">a</span> <span class="main">…</span> <span class="main">(</span><span class="main">⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span>map_transform Aeta_expand <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>map_transform transform <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Let<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq <span class="skolem">a</span> <span class="main">…</span> <span class="main">(</span><span class="main">⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Aexp_correct<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="main">⦃</span>map_transform Aeta_expand <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>map_transform transform <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_HSem_ind<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> adm bottom step<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eqρ_adm <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">ρ1</span> <span class="skolem">ρ2</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>⟦</b></span> map_transform Aeta_expand <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>map_transform transform <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ1</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>⟦</b></span><span class="skolem">Γ</span><span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ2</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> eqρI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">a'</span>
        <span class="keyword3"><span class="command">assume</span></span> ass<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eq <span class="skolem">a'</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>⟦</b></span> map_transform Aeta_expand <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>map_transform transform <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ1</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>⟦</b></span><span class="skolem">Γ</span><span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ2</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domA_map_of_Some_the<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> ass <span class="keyword1"><span class="command">have</span></span> ass'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> up<span class="main">⋅</span><span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>⟦</b></span> map_transform Aeta_expand <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>map_transform transform <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ1</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span>
            <span class="main">⟦</span>Aeta_expand <span class="skolem">a'</span> <span class="main">(</span>transform <span class="skolem">a'</span> <span class="skolem">e'</span><span class="main">)</span>⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ1</span></sub><span class="hidden">⇙</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookupEvalHeap' map_of_map_transform ass'<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq <span class="skolem">a'</span> <span class="main">…</span> <span class="main">(</span><span class="main">⟦</span>transform <span class="skolem">a'</span> <span class="skolem">e'</span>⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ1</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_Aeta_expand<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq <span class="skolem">a'</span> <span class="main">…</span> <span class="main">(</span><span class="main">⟦</span><span class="skolem">e'</span>⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ1</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_of_SomeD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹map_of <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq <span class="skolem">a'</span> <span class="main">…</span> <span class="main">(</span><span class="main">⟦</span><span class="skolem">e'</span>⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ2</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Aexp_correct<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> ass' <span class="quoted"><span class="quoted">‹map_of <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aexp</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="skolem">a'</span> <span class="main">⊑</span> <span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">⊔</span> <span class="free">Aexp</span> <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Aexp_heap_below_Aheap<span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e'</span><span class="main">⋅</span><span class="skolem">a'</span><span class="main">)</span> <span class="skolem">ρ1</span> <span class="skolem">ρ2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eqρ_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>⟦</b></span><span class="skolem">Γ</span><span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ2</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookupEvalHeap'<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_useless  order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  edom_evalHeap_subset<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_meet_simp eqρ_join<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eqρ <span class="main">(</span><span class="free">Aexp</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="main">⦃</span>map_transform Aeta_expand <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>map_transform transform <span class="main">(</span><span class="free">Aheap</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eqρ_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Aexp_body_below_Aheap<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⟦</span> Let <span class="skolem">Γ</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> Arity_transformation_correct'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 𝒯<span class="hidden">⇘</span><sub><span class="main">0</span></sub><span class="hidden">⇙</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Arity_transformation_correct<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>