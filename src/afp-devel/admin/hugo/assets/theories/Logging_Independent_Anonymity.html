<div id="Definitions">
<div class="head">
<h1>Theory Definitions</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Logging-independent Message Anonymity in the Relational Method
    Author:      Pasquale Noce
                 Software Engineer at HID Global, Italy
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at hidglobal dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Logging-independent message anonymity and Restricted Identification"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Definitions
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Introduction"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\emph{Logging-dependent message anonymity} is the property for a message exchanged or otherwise used
in a cryptographic protocol to remain anonymous although the attacker can log the messages generated
or accepted by legitimate agents, and map any two observable messages contained in any such message
to the same agent. An approach to modeling and verifying this security property according to the
\emph{relational method} for formal protocol verification has been described in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Noce20"<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
along with the method itself. This approach makes use of two further type constructors for messages,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">IDInfo</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Log</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, as well as of two functions, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">crypts</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">key_sets</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
Particularly, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">IDInfo</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is used to model message anonymity, while the remaining constants are
used to formalize the property for a message to be observable by the spy within some logged message.

\emph{Logging-independent message anonymity} rather is the property for a given message to remain
anonymous in spite of the attacker's capability of mapping messages of that sort to agents without
resorting to message logging, namely by means of some intrinsic feature of such messages. From the
above observation, it follows that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">IDInfo</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the sole anonymity-related constant required if
the only kind of anonymity of interest for a given protocol is the logging-independent one, whereas
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Log</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">crypts</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">key_sets</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are unnecessary and can be left out of the model.
It is also possible to include both kinds of anonymity in the model, in which case some protocol
rule will enable the spy to map messages of some sort to agents only if they are observable within
logged messages, while some other protocol rule will enable the spy to do so independently of this
condition.

This paper illustrates how logging-independent message anonymity can be formalized according to the
relational method by considering a real-world protocol, namely the Restricted Identification one by
the BSI <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "BSI16-2"<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "BSI16-3"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, whose very purpose is to allow for the exchange of
messages endowed with this security property.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Case study: the Restricted Identification protocol"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{Protocol}

The Restricted Identification protocol enables \emph{user identification tokens} (e.g. electronic
documents) to generate and output unambiguous \emph{pseudonymous identifiers}, distinct for any
given group of terminals of arbitrary granularity, referred to as a \emph{sector}, and usable to
identify the tokens across different sessions taking place within the same sector. For example, such
identifiers allow for the creation of sector-specific revocation lists, at the same time preserving
the anonymity of the holder of any token included in such a list.

This protocol is based on a \emph{Public Key Infrastructure (PKI)} comprising the token issuer,
which owns a \emph{revocation key pair} $(SK_{Rev}, PK_{Rev})$ and generates a \emph{token key pair}
$(SK_{Tok}, PK_{Tok})$ for each token, and sectors, each one endowed with its own \emph{sector key
pair} $(SK_{Sec}, PK_{Sec})$, where $PK_{Sec} = [SK_{Sec}]PK_{Rev}$. This PKI may use either an
integer finite field or an elliptic curve group, as long as the selected domain parameters are
cryptographically secure. In a real-world PKI, each sector has actually two distinct key pairs,
which enables the tokens to generate as many different pseudonymous identifiers per sector, but this
detail is irrelevant to the anonymity of such identifiers and can then be omitted from the model.

According to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "BSI16-2"<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "BSI16-3"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, the Restricted Identification protocol may only be
executed using the session keys established via Chip Authentication version 2/3, after performing
Terminal Authentication version 2 with a terminal certificate containing both sector public keys'
hashes (including domain parameters), whose authenticity is ensured by the certificate's signature.
After requesting to start the protocol, which again is irrelevant and can be left out of the model,
the terminal sends either of its sector public keys $PK_{Sec}$ (including domain parameters) to the
token, which in turn verifies that $PK_{Sec}$'s hash matches the one contained in the certificate
and replies with its pseudonymous identifier $H([SK_{Tok}]PK_{Sec})$, where $H$ is a hash function.
If necessary (for instance, to insert it into a sector-specific revocation list), this identifier
can be recomputed in the external world as $H([SK_{Sec}]([SK_{Rev}]PK_{Tok}))$, with the concurrence
of both the token issuer and the entity responsible for the involved sector.

As a matter of fact, since the only purpose of the protocol model to be developed is to verify the
logging-independent anonymity of token pseudonymous identifiers, without any confidentiality or
authenticity concern, it is sufficient to model a simpler protocol in which the terminal and the
token exchange their messages in plain, without using any session key. Moreover, since both Chip and
Terminal Authentication are out of scope, the Restricted Identification protocol will be modeled as
a stand-alone one. Consequently, although both of them are exchanged during Terminal Authentication
in the real-world protocol, $PK_{Sec}$'s signature will be assumed to be exchanged with $PK_{Sec}$
in the model, while the related verification key will be assumed to be known by the token a priori.
The hash function used to sign $PK_{Sec}$ may differ from the one used to compute token pseudonymous
identifiers, but once more, this is just an omissible functional detail.

A further simplification, admissible for the same reason, is to let the token use domain parameters
known a priori rather than the input ones, whose presence in the input message can then be left out.
Indeed, this prevents the spy from snatching $SK_{Tok}$ by making an element of a smaller group pass
for an authentic sector public key, which could be done by signing it with a compromised signature
generation key. For example, if the PKI used a group of 128-bit order, $SK_{Tok}$ could be disclosed
by first searching the private key $SK'_{Tok}$ associated with a fake identifier ranging in a group
of 64-bit order $n$, and then detecting $SK_{Tok}$ as the unique private key associated with a given
genuine identifier among all those differing from $SK'_{Tok}$ by a multiple of $n$. So, two searches
within as many spaces of $2^{64}$ elements, which is a computationally feasible task nowadays, would
suffice to find $SK_{Tok}$. However, such \emph{small group attacks} can safely be ruled out as long
as the initial state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s<span class="hidden">⇩</span><sub>0</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> comprises an arbitrary set of compromised token private keys, given
that verifying the conditions under which these keys remain secret is out of scope.

As a result of all the simplifications described above, the protocol that is going to be modeled is
as follows.

  <span class="antiquoted"><span class="antiquoted">▸</span></span> Terminal $\rightarrow$ Token: \tabto{10em} $\{PK_{Sec}, \{H(PK_{Sec})\}_{SK_{Sign}}\}$\\

    The terminal sends the token a message consisting of its sector public key and a precomputed
    signature of this key.\\

  <span class="antiquoted"><span class="antiquoted">▸</span></span> Token $\rightarrow$ Terminal: \tabto{10em} $H([SK_{Tok}]PK_{Sec})$\\

    The token verifies that the hash of the received public key matches the signed one, and then
    replies with the pseudonymous identifier resulting from this key.

Unless it is compromised by means other than attacking the protocol, the anonymity of a given token
pseudonymous identifier $H([SK_{Tok}]PK_{Sec})$ is expected to be vulnerable if and only if either
$SK_{Tok}$ is anonymity-compromised, or $SK_{Sec}$ is compromised and there is another compromised
sector private key $SK'_{Sec}$ such that $H([SK_{Tok}]PK'_{Sec})$ is anonymity-compromised. In fact,
the spy can detect the use of $SK_{Tok}$ in $H([SK_{Tok}]PK_{Sec})$ in the former case, whereas in
the latter one he can map $H([SK_{Tok}]PK_{Sec})$ to the same token as $H([SK_{Tok}]PK'_{Sec})$ by
recognizing that $[SK_{Tok}]PK_{Sec} = [SK_{Sec}\times(SK'_{Sec})^{-1}]([SK_{Tok}]PK'_{Sec})$.

The purpose of the following formal development is precisely to formally prove the correctness of
this expectation. In more detail, the \emph{only if} conditional implied by the previous statement
will be proven as an \emph{anonymity property} in the next section, while the \emph{if} conditional
will be proven in the form of two \emph{possibility properties} in the subsequent one. Since both
relevant attack options leverage the intrinsic features of token pseudonymous identifiers, namely
the private keys used to generate them, logging-independent message anonymity has to be considered
rather than logging-dependent one.

For further information about the formal definitions and proofs contained in this paper, see
Isabelle documentation, particularly <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Paulson21"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Nipkow21"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Krauss21"<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Nipkow11"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Agents, messages, protocol rules"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Agents consist of an infinite population of tokens and sectors, identified through natural numbers,
plus the spy. Actually, the model can safely ignore terminals altogether and assume that tokens are
presented to sectors as a whole, since all the terminal-side messages used in the protocol refer to
sectors rather than to individual terminals. The only possible exceptions are signature key pairs.
In fact, although the entity signing terminal certificates is the same for every terminal in a given
sector (in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "BSI16-2"<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "BSI16-3"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, it is named \emph{Document Verifier}), nothing
prevents that entity to use distinct signature generation keys for different terminals (for example,
if their certificates are issued at different times). Nonetheless, the granularity of signature key
pairs is irrelevant to the anonymity of token pseudonymous identifiers according to the previous
considerations, so these key pairs can be associated with sectors as well.

As opposed to what happens in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Noce20"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, there is no correlation here between any two agents
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Token n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Sector n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> marked with the same numeric identifier <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">n</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In fact,
tokens and sectors are independent of each other, and any token may be presented to whatever sector.

\null
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> agent_id <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">datatype</span></span> agent <span class="main">=</span>
  Token <span class="quoted">agent_id</span> <span class="main">|</span>
  Sector <span class="quoted">agent_id</span> <span class="main">|</span>
  Spy

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

As regards the key pairs for key agreement, private keys are identified by natural numbers, whereas
public keys by sets of natural numbers. The implied interpretation is that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"PubK S"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> stands
for public key $[k]G$, where $G$ is the group generator and $k$ is the modular product of all the
private keys referred to by the numeric identifiers in $S$, each one occurring as a factor exactly
once. Using \emph{multisets} of natural numbers instead of sets would have allowed private keys to
be used as factors even more than once, but this option can be left out as the PKI does not provide
for any public key computed in this way. The need for this ad hoc message format, like those used to
represent session keys and Chip Authentication Data in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Noce20"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, confirms that reuse of the
spy's capabilities' model in the inductive method is hindered by the likely need for ad hoc message
formats in case of protocols using nontrivial public key cryptography <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Noce20"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Besides key agreement keys, messages comprise signature generation/verification keys (identified by
the numeric identifiers of the respective sectors), hash values, cryptograms, and compound messages
built via message concatenation. Furthermore, message anonymity is modeled by means of constructor
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">IDInfo</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Noce20"<span class="antiquote"><span class="antiquote">}</span></span></span></span>. Since the anonymity of terminal-side messages is of no concern, the
interpretation of message <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, X⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is "message <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is mapped to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Token <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>",
namely <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">n</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is always interpreted as a token's numeric identifier rather than a sector's one.

\null
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> key_id <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">datatype</span></span> agr_key <span class="main">=</span>
  PriK <span class="quoted">key_id</span> <span class="main">|</span>
  PubK <span class="quoted"><span class="quoted">"key_id set"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> enc_key <span class="main">=</span>
  SigK <span class="quoted">agent_id</span> <span class="main">|</span>
  VerK <span class="quoted">agent_id</span>

<span class="keyword1"><span class="command">datatype</span></span> msg <span class="main">=</span>
  AgrKey <span class="quoted">agr_key</span> <span class="main">|</span>
  EncKey <span class="quoted">enc_key</span> <span class="main">|</span>
  Hash <span class="quoted">msg</span> <span class="main">|</span>
  Crypt <span class="quoted">enc_key</span> <span class="quoted">msg</span> <span class="main">|</span>
  MPair <span class="quoted">msg</span> <span class="quoted">msg</span> <span class="main">|</span>
  IDInfo <span class="quoted">agent_id</span> <span class="quoted">msg</span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_MPair"</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> args<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span>"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">⦃</span>_<span class="keyword1">,</span><span class="keyword3">/ </span>_<span class="keyword1">⦄</span><span class="keyword3">)</span>"</span><span class="main">)</span>
  <span class="quoted">"_IDInfo"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>agent_id<span class="main">,</span> msg<span class="main">]</span> <span class="main">⇒</span> msg"</span></span>      <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">⟨</span>_<span class="keyword1">,</span><span class="keyword3">/ </span>_<span class="keyword1">⟩</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">,</span> <span class="free">Z</span><span class="main">⦄</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="main">⦃</span><span class="free">Y</span><span class="main">,</span> <span class="free">Z</span><span class="main">⦄</span><span class="main">⦄</span>"</span>
  <span class="quoted">"<span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> MPair <span class="free">X</span> <span class="free">Y</span>"</span>
  <span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> IDInfo <span class="free">n</span> <span class="free">X</span>"</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SigKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">SigKey</span> <span class="main">≡</span> EncKey <span class="main">∘</span> SigK"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">VerKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">VerKey</span> <span class="main">≡</span> EncKey <span class="main">∘</span> VerK"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">PriKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"key_id <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">PriKey</span> <span class="main">≡</span> AgrKey <span class="main">∘</span> PriK"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">PubKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"key_id set <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">PubKey</span> <span class="main">≡</span> AgrKey <span class="main">∘</span> PubK"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">InvK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"enc_key <span class="main">⇒</span> enc_key"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">InvK</span> <span class="main">(</span>SigK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> VerK <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">InvK</span> <span class="main">(</span>VerK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> SigK <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">InvKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"enc_key <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">InvKey</span> <span class="main">≡</span> EncKey <span class="main">∘</span> InvK"</span></span>


<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">parts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>

parts_used <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span> <span class="main">|</span>

parts_crypt <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span> <span class="main">|</span>

parts_fst <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span> <span class="main">|</span>

parts_snd <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parts_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> msg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">parts_msg</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> parts <span class="main">{</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Constant <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Rev_PriK</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the numeric identifier of the revocation private key, while functions
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Sec_PriK</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Tok_PriK</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> map the numeric identifiers of sectors and tokens to those of
the respective sector/token private keys. It is assumed that these functions are injective, as well
as that their ranges do not contain <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Rev_PriK</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and are disjoint, and such axioms are proven to
be consistent by showing that there exist three constants satisfying all of them. On the whole,
these axioms just model the assumption that private keys are generated by cryptographically secure
means throughout the PKI, so that the probability for any given private key to occur more than once
within the PKI is negligible.

\null
›</span></span>

<span class="keyword1"><span class="command">consts</span></span> Rev_PriK <span class="main">::</span> <span class="quoted">key_id</span>

<span class="keyword1"><span class="command">consts</span></span> Sec_PriK <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> key_id"</span></span>

<span class="keyword1"><span class="command">consts</span></span> Tok_PriK <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> key_id"</span></span>

<span class="keyword1"><span class="command">specification</span></span> <span class="main">(</span><span class="quoted">Rev_PriK</span> <span class="quoted">Sec_PriK</span> <span class="quoted">Tok_PriK</span><span class="main">)</span>
  sec_prik_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj Sec_PriK"</span></span>
  tok_prik_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj Tok_PriK"</span></span>
  sec_prik_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"Rev_PriK <span class="main">∉</span> range Sec_PriK"</span></span>
  tok_prik_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"Rev_PriK <span class="main">∉</span> range Tok_PriK"</span></span>
  sec_prik_tok_prik<span class="main">:</span> <span class="quoted"><span class="quoted">"range Sec_PriK <span class="main">∩</span> range Tok_PriK <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">n</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">n</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="bound"><span class="bound"><span class="bound">n</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">n</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">n</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="bound"><span class="bound"><span class="bound">n</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">arith</span><span class="main">)</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Gen_PubKey</span> <span class="main">::</span> <span class="quoted">msg</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Gen_PubKey</span> <span class="main">≡</span> PubKey <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Rev_PriKey</span> <span class="main">::</span> <span class="quoted">msg</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Rev_PriKey</span> <span class="main">≡</span> PriKey Rev_PriK"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Rev_PubKey</span> <span class="main">::</span> <span class="quoted">msg</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Rev_PubKey</span> <span class="main">≡</span> PubKey <span class="main">{</span>Rev_PriK<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Tok_PriKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Tok_PriKey</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> PriKey <span class="main">(</span>Tok_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Tok_PubKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Tok_PubKey</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> PubKey <span class="main">{</span>Tok_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Sec_PriKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Sec_PriKey</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> PriKey <span class="main">(</span>Sec_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Sec_PubKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Sec_PubKey</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> PubKey <span class="main">{</span>Sec_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Rev_PriK<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Sign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> msg <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Sign</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> Crypt <span class="main">(</span>SigK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Hash <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ID</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> msg <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ID</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">of</span> AgrKey <span class="main">(</span>PubK <span class="bound">S</span><span class="main">)</span> <span class="main">⇒</span> PubKey <span class="main">(</span>insert <span class="main">(</span>Tok_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">S</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

The spy's starting knowledge, as defined by the initial state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s<span class="hidden">⇩</span><sub>0</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, consists of the following
messages.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> All the public keys used in the PKI (including the group generator).

  <span class="antiquoted"><span class="antiquoted">▪</span></span> All token pseudonymous identifiers (in both hashed and non-hashed formats).

  <span class="antiquoted"><span class="antiquoted">▪</span></span> Compromised private keys used in the PKI (excluding the revocation one, assumed to be secret).

  <span class="antiquoted"><span class="antiquoted">▪</span></span> Mappings of all token public keys, compromised token private keys, and anonymity-compromised
    token pseudonymous identifiers (in both hashed and non-hashed formats) to the respective tokens.

\null
›</span></span>

<span class="keyword1"><span class="command">consts</span></span> bad_sigk <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span>

<span class="keyword1"><span class="command">consts</span></span> bad_sec_prik <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span>

<span class="keyword1"><span class="command">consts</span></span> bad_tok_prik <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span>

<span class="keyword1"><span class="command">consts</span></span> bad_id <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>agent_id <span class="main">×</span> agent_id<span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> event <span class="main">=</span> <span class="quoted"><span class="quoted">"agent <span class="main">×</span> msg"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> state <span class="main">=</span> <span class="quoted"><span class="quoted">"event set"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">used</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> msg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">used</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> Range <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">spied</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> msg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">spied</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">``</span> <span class="main">{</span>Spy<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">state</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≡</span> <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="main">{</span>Gen_PubKey<span class="main">,</span> Rev_PubKey<span class="main">}</span> <span class="main">∪</span>
  SigKey <span class="main">`</span> bad_sigk <span class="main">∪</span> Sec_PriKey <span class="main">`</span> bad_sec_prik <span class="main">∪</span> Tok_PriKey <span class="main">`</span> bad_tok_prik <span class="main">∪</span>
  range VerKey <span class="main">∪</span> range Sec_PubKey <span class="main">∪</span> range Tok_PubKey <span class="main">∪</span>
  range <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> ID <span class="bound">n</span> <span class="main">(</span>Sec_PubKey <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
  range <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> Hash <span class="main">(</span>ID <span class="bound">n</span> <span class="main">(</span>Sec_PubKey <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
  range <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> Tok_PubKey <span class="bound">n</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∪</span>
  <span class="main">{</span><span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> Tok_PriKey <span class="bound">n</span><span class="main">⟩</span> <span class="main">|</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> bad_tok_prik<span class="main">}</span> <span class="main">∪</span>
  <span class="main">{</span><span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> ID <span class="bound">n</span> <span class="main">(</span>Sec_PubKey <span class="bound">m</span><span class="main">)</span><span class="main">⟩</span> <span class="main">|</span> <span class="bound">n</span> <span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">}</span> <span class="main">∪</span>
  <span class="main">{</span><span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="bound">n</span> <span class="main">(</span>Sec_PubKey <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">|</span> <span class="bound">n</span> <span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Protocol rules are defined here below. Particularly, for any public key $[SK_1\times...\times SK_n]
G$ known to the spy, they enable him to generate public key $[SK_1\times...\times SK_n\times
SK_{n+1}]G$ for any additional, compromised private key $SK_{n+1}$, as well as public key
$[SK_1\times...\times SK_{i-1}\times SK_{i+1}\times...\times SK_n]G$ for any compromised private key
$SK_i$, where $1\leq i\leq n$ (which is equivalent to multiplying the original public key by $(SK_i)
^{-1}$). The spy can also map the resulting public keys to the same token, if identified, as the
original public key, in the latter case as long as the related token private key still occurs as a
factor in the resulting modular product. Furthermore, the spy can associate a token with any known
public key whose modular product of private keys contains the corresponding token private key as a
factor, provided that this key is compromised.

\null
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_sector</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_sector</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">m</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Sector <span class="bound">m</span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Sec_PubKey <span class="bound">m</span><span class="main">,</span> Sign <span class="bound">m</span> <span class="main">(</span>Sec_PubKey <span class="bound">m</span><span class="main">)</span><span class="main">⦄</span><span class="main">}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_token</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_token</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">m</span> <span class="bound">n</span> <span class="bound">S</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Token <span class="bound">n</span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Hash <span class="main">(</span>ID <span class="bound">n</span> <span class="main">(</span>PubKey <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∧</span>
  <span class="main">⦃</span>PubKey <span class="bound">S</span><span class="main">,</span> Sign <span class="bound">m</span> <span class="main">(</span>PubKey <span class="bound">S</span><span class="main">)</span><span class="main">⦄</span> <span class="main">∈</span> used <span class="bound">s</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_pubk_less</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_pubk_less</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">A</span> <span class="bound">S</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> PubKey <span class="main">(</span><span class="bound">S</span> <span class="main">-</span> <span class="main">{</span><span class="bound">A</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span>PriKey <span class="bound">A</span><span class="main">,</span> PubKey <span class="bound">S</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_pubk_more</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_pubk_more</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">A</span> <span class="bound">S</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> PubKey <span class="main">(</span>insert <span class="bound">A</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span>PriKey <span class="bound">A</span><span class="main">,</span> PubKey <span class="bound">S</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_hash</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_hash</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">X</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> Hash <span class="bound">X</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="bound">X</span> <span class="main">∈</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_dec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_dec</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">K</span> <span class="bound">X</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span>Crypt <span class="bound">K</span> <span class="bound">X</span><span class="main">,</span> InvKey <span class="bound">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_enc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_enc</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">K</span> <span class="bound">X</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="bound">K</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span><span class="bound">X</span><span class="main">,</span> EncKey <span class="bound">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_sep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_sep</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">}</span> <span class="main">∧</span>
  <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⦄</span> <span class="main">∈</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_con</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_con</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_id_pubk_less</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_id_pubk_less</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">A</span> <span class="bound">S</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> PubKey <span class="main">(</span><span class="bound">S</span> <span class="main">-</span> <span class="main">{</span><span class="bound">A</span><span class="main">}</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span>PriKey <span class="bound">A</span><span class="main">,</span> PubKey <span class="main">(</span><span class="bound">S</span> <span class="main">-</span> <span class="main">{</span><span class="bound">A</span><span class="main">}</span><span class="main">)</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> PubKey <span class="bound">S</span><span class="main">⟩</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span> <span class="main">∧</span>
  Tok_PriK <span class="bound">n</span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">-</span> <span class="main">{</span><span class="bound">A</span><span class="main">}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_id_pubk_more</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_id_pubk_more</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">A</span> <span class="bound">S</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> PubKey <span class="main">(</span>insert <span class="bound">A</span> <span class="bound">S</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span>PriKey <span class="bound">A</span><span class="main">,</span> PubKey <span class="main">(</span>insert <span class="bound">A</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> PubKey <span class="bound">S</span><span class="main">⟩</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_id_pubk_prik</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_id_pubk_prik</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">S</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> PubKey <span class="bound">S</span><span class="main">⟩</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span>Tok_PriKey <span class="bound">n</span><span class="main">,</span> PubKey <span class="bound">S</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span> <span class="main">∧</span>
  Tok_PriK <span class="bound">n</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_id_hash</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_id_hash</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">X</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> Hash <span class="bound">X</span><span class="main">⟩</span><span class="main">}</span> <span class="main">∧</span>
  <span class="main">{</span><span class="bound">X</span><span class="main">,</span> Hash <span class="bound">X</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span> <span class="main">∨</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> Hash <span class="bound">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">≡</span> rel_sector <span class="main">∪</span> rel_token <span class="main">∪</span> rel_pubk_less <span class="main">∪</span> rel_pubk_more <span class="main">∪</span>
  rel_hash <span class="main">∪</span> rel_dec <span class="main">∪</span> rel_enc <span class="main">∪</span> rel_sep <span class="main">∪</span> rel_con <span class="main">∪</span>
  rel_id_pubk_less <span class="main">∪</span> rel_id_pubk_more <span class="main">∪</span> rel_id_pubk_prik <span class="main">∪</span> rel_id_hash"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">in_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">∈</span> rel"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">in_rel_rtrancl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">∈</span> rel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Anonymity">
<div class="head">
<h1>Theory Anonymity</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Logging-independent Message Anonymity in the Relational Method
    Author:      Pasquale Noce
                 Software Engineer at HID Global, Italy
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at hidglobal dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Anonymity of token pseudonymous identifiers"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Anonymity
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Definitions">Definitions</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

This section contains a proof of anonymity property <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">id_anonymous</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which states that a token
pseudonymous identifier remains anonymous if its anonymity is not compromised by means other than
attacking the protocol and neither attack option described in section \ref{Protocol} is viable. As
shown here below, this property can be proven by applying rules <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] rtrancl_induct<span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">rtrancl_start</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in a suitable combination <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Noce20"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

\null
›</span></span>

<span class="keyword1"><span class="command">proposition</span></span> rtrancl_start <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span> <span class="free">x</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">u</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⟶</span> <span class="main">_</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="var">?P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span> <span class="free">y</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">z</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span> <span class="free">x</span> <span class="main">⟶</span><span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="var">?P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span> <span class="skolem">y</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="var">?P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span> <span class="skolem">y</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="var">?P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span> <span class="skolem">z</span> <span class="bound">u</span> <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> D <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span> <span class="skolem">y</span> <span class="skolem">u</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span> <span class="skolem">z</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> state_subset<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊨</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def image_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> spied_subset<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊨</span> <span class="free">s'</span> <span class="main">⟹</span> spied <span class="free">s</span> <span class="main">⊆</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Image_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> state_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> parts_init<span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">(</span>used s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span> <span class="main">=</span> used s<span class="hidden">⇩</span><sub>0</sub>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> parts_used<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_mono<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> <span class="free">H'</span> <span class="main">⟹</span> parts <span class="free">H</span> <span class="main">⊆</span> parts <span class="free">H'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Anonymity-parts_union_1"><span class="command">lemma</span></span> parts_union_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="free">H</span> <span class="main">∪</span> parts <span class="free">H'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Anonymity-parts_union_2"><span class="command">lemma</span></span> parts_union_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="free">H</span> <span class="main">∪</span> parts <span class="free">H'</span> <span class="main">⊆</span> parts <span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> UnE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_union <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">H</span> <span class="main">∪</span> parts <span class="free">H'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> parts_union_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> parts_union_2<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_insert<span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts_msg <span class="free">X</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> insert_def parts_union<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> parts_msg_mono<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">⟹</span> parts_msg <span class="free">X</span> <span class="main">⊆</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">H</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_agrkey <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts_msg <span class="main">(</span>AgrKey <span class="free">K</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>AgrKey <span class="free">K</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_hash <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts_msg <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Hash <span class="free">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Anonymity-parts_crypt_1"><span class="command">lemma</span></span> parts_crypt_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">{</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">}</span> <span class="main">⊆</span> insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>parts <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Anonymity-parts_crypt_2"><span class="command">lemma</span></span> parts_crypt_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>parts <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="main">{</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_crypt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts_msg <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>parts_msg <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> parts_crypt_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> parts_crypt_2<span class="main">)</span>

<span class="keyword1" id="Anonymity-parts_mpair_1"><span class="command">lemma</span></span> parts_mpair_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">{</span><span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">}</span> <span class="main">⊆</span> insert <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>parts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> parts <span class="main">{</span><span class="free">Y</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Anonymity-parts_mpair_2"><span class="command">lemma</span></span> parts_mpair_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"insert <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>parts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> parts <span class="main">{</span><span class="free">Y</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="main">{</span><span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> parts.induct<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_mpair <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts_msg <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">=</span> insert <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>parts_msg <span class="free">X</span> <span class="main">∪</span> parts_msg <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> parts_mpair_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> parts_mpair_2<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_idinfo <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts_msg <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">{</span><span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_parts<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">;</span> <span class="free">Y</span> <span class="main">∈</span> parts_msg <span class="free">X</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_msg_mono <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> prikey_spied<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> PriKey <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> PriKey <span class="free">K</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> parts_init<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_def parts_insert <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_msg_parts<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> prikey_crypt <span class="main">[</span><span class="operator">simplified</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="free">K</span> <span class="main">(</span>PriKey <span class="free">K'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">;</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> PriKey <span class="free">K'</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> prikey_spied<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> prikey_mpair_fst <span class="main">[</span><span class="operator">simplified</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span>PriKey <span class="free">K</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">;</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> PriKey <span class="free">K</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> prikey_spied<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> prikey_mpair_snd <span class="main">[</span><span class="operator">simplified</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="free">Y</span><span class="main">,</span> PriKey <span class="free">K</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">;</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> PriKey <span class="free">K</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> prikey_spied<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> rev_prikey_secret<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> Rev_PriKey <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> sec_prik_rev tok_prik_rev<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prikey_crypt prikey_mpair_fst prikey_mpair_snd<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> sec_prikey_secret<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="free">n</span> <span class="main">∉</span> bad_sec_prik<span class="main">⟧</span> <span class="main">⟹</span> Sec_PriKey <span class="free">n</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> sec_prik_inj sec_prik_tok_prik<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>
 rel_def inj_on_def image_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prikey_crypt prikey_mpair_fst prikey_mpair_snd<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> tok_prikey_secret<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="free">n</span> <span class="main">∉</span> bad_tok_prik<span class="main">⟧</span> <span class="main">⟹</span> Tok_PriKey <span class="free">n</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> tok_prik_inj sec_prik_tok_prik<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>
 rel_def inj_on_def image_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prikey_crypt prikey_mpair_fst prikey_mpair_snd<span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> idinfo_spied<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> parts_init<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_def parts_insert <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_msg_parts<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> idinfo_crypt<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="free">K</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">;</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> idinfo_spied<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> idinfo_mpair_fst<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">;</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> idinfo_spied<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> idinfo_mpair_snd<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="free">Y</span><span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">;</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> idinfo_spied<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> idinfo_hash_hash <span class="main">[</span><span class="operator">rotated</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Hash <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Hash <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_def
 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> idinfo_crypt idinfo_mpair_fst idinfo_mpair_snd<span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> sec_prik_eq<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">{</span>Tok_PriK <span class="free">n</span><span class="main">,</span> Sec_PriK <span class="free">m</span><span class="main">,</span> Rev_PriK<span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span>Tok_PriK <span class="free">n</span><span class="main">,</span> Sec_PriK <span class="free">m'</span><span class="main">,</span> Rev_PriK<span class="main">}</span> <span class="main">⟹</span> <span class="free">m'</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> equalityE<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Sec_PriK <span class="free"><span class="free"><span class="free">m</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span>
 sec_prik_inj sec_prik_rev sec_prik_tok_prik<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def image_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> id_identified<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∉</span> bad_id"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_tok_prik"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> bad_sec_prik <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">m'</span><span class="main">.</span> <span class="bound">m'</span> <span class="main">≠</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">m'</span> <span class="main">∈</span> bad_sec_prik <span class="main">∧</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> PubKey <span class="bound">S</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span> <span class="main">∧</span> Sec_PriK <span class="free">m</span> <span class="main">∈</span> <span class="bound">S</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P<span class="hidden">⇩</span><sub>3</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">S</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Hash <span class="main">(</span>PubKey <span class="bound">S</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P<span class="hidden">⇩</span><sub>4</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">S</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> PubKey <span class="bound">S</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span> <span class="main">∧</span> Rev_PriK <span class="main">∈</span> <span class="bound">S</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">m</span><span class="main">.</span> Sec_PriK <span class="bound">m</span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∉</span> bad_id<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span><span class="main">.</span> Sec_PriK <span class="bound">m</span> <span class="main">≠</span> Rev_PriK"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Rev_PriK <span class="main">∈</span> range Sec_PriK"</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sec_prik_rev<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> range_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊨</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="var">?P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="var">?P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sec_prik_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊢</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="main">¬</span> <span class="var">?P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="var">?P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> idinfo_crypt idinfo_mpair_fst idinfo_mpair_snd
     idinfo_hash_hash<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊨</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="main">¬</span> <span class="var">?P<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="var">?P<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span>
     sec_prik_inj sec_prik_tok_prik<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">¬</span> <span class="var">?P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="var">?P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tok_PriKey <span class="free">n</span> <span class="main">∉</span> spied <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> tok_prikey_secret<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sec_PriKey <span class="free">m</span> <span class="main">∈</span> spied <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> idinfo_crypt idinfo_mpair_fst idinfo_mpair_snd<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Hash <span class="main">(</span>AgrKey <span class="main">(</span>PubK <span class="skolem">S</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"Sec_PriK <span class="free">m</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Hash <span class="main">(</span>PubKey <span class="skolem">S</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∉</span> spied s<span class="hidden">⇩</span><sub>0</sub>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> sec_prik_inj sec_prik_tok_prik<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊨</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">¬</span> <span class="var">?P<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">S</span> <span class="bound">u</span> <span class="main">∧</span> <span class="var">?P<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">S</span> <span class="bound">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">u<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="skolem">u<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⊢</span> <span class="skolem">v<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="skolem">v<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⊨</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span>
      <span class="main">¬</span> <span class="var">?P<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">S</span> <span class="skolem">u<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="var">?P<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">S</span> <span class="skolem">v<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> PubKey <span class="skolem">S</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="skolem">v<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> idinfo_crypt idinfo_mpair_fst idinfo_mpair_snd
       idinfo_hash_hash<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> PubKey <span class="skolem">S</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> subsetD <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"spied <span class="skolem"><span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>3</sub></span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> spied_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sec_PriK <span class="free">m</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> AgrKey <span class="main">(</span>PriK <span class="main">(</span>Sec_PriK <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> bad_sec_prik"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> contrapos_pp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> sec_prikey_secret<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> B <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="var">?P<span class="hidden">⇩</span><sub>4</sub></span> <span class="bound">S</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span>Tok_PriK <span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> Sec_PriK <span class="free"><span class="free"><span class="free">m</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> Rev_PriK<span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">insert</span> sec_prik_inj sec_prik_tok_prik<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="var">?P<span class="hidden">⇩</span><sub>4</sub></span> <span class="bound">S</span> s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> tok_prik_rev<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊨</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span>
    <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="var">?P<span class="hidden">⇩</span><sub>4</sub></span> <span class="bound">S</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="var">?P<span class="hidden">⇩</span><sub>4</sub></span> <span class="bound">S</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>4</sub></span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    J<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">⊢</span> <span class="skolem">v<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="var">?P<span class="hidden">⇩</span><sub>4</sub></span> <span class="bound">S</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="var">?P<span class="hidden">⇩</span><sub>4</sub></span> <span class="skolem">S</span> <span class="skolem">v<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="skolem">S</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span><span class="main">;</span> Rev_PriK <span class="main">∈</span> <span class="skolem">S</span><span class="main">;</span>
    <span class="main">∀</span><span class="bound">m</span><span class="main">.</span> Sec_PriK <span class="bound">m</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∉</span> bad_id<span class="main">;</span>
    <span class="main">∀</span><span class="bound">S</span><span class="main">.</span> Rev_PriK <span class="main">∈</span> <span class="bound">S</span> <span class="main">⟶</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="bound">S</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> Sec_PriK <span class="bound">m</span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">∧</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> K <span class="keyword2"><span class="keyword">and</span></span> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m'</span><span class="main">.</span> <span class="bound">m'</span> <span class="main">≠</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">m'</span> <span class="main">∈</span> bad_sec_prik <span class="main">∧</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">drule_tac</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">drule_tac</span> idinfo_crypt <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ J<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule_tac</span>
   idinfo_mpair_fst <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ J<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule_tac</span> idinfo_mpair_snd <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ J<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> disjE<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n'</span> <span class="skolem">S'</span> <span class="skolem">A</span>
    <span class="keyword3"><span class="command">assume</span></span>
      N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">S</span><span class="main">.</span> Rev_PriK <span class="main">∈</span> <span class="bound">S</span> <span class="main">⟶</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="bound">S</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> Sec_PriK <span class="bound">m</span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">∧</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      O<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span><span class="main">.</span> Sec_PriK <span class="bound">m</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∉</span> bad_id"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      P<span class="main">:</span> <span class="quoted"><span class="quoted">"Rev_PriK <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="skolem">n'</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="skolem">S'</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> AgrKey <span class="main">(</span>PriK <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">n'</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="main">=</span> <span class="skolem">S'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">A</span><span class="main">}</span> <span class="main">∨</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="skolem">S</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> M <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ P O N<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="skolem">S'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">A</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
       <span class="quoted"><span class="quoted">"Sec_PriK <span class="skolem">m'</span> <span class="main">∈</span> <span class="skolem">S'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id"</span></span>
        <span class="keyword1"><span class="command">using</span></span> N <span class="keyword2"><span class="keyword">and</span></span> P <span class="keyword2"><span class="keyword">and</span></span> Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> Sec_PriK <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sec_PriKey <span class="skolem">m'</span> <span class="main">∈</span> spied <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">∈</span> bad_sec_prik"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> contrapos_pp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> sec_prikey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> J<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m'</span><span class="main">.</span> <span class="bound">m'</span> <span class="main">≠</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">m'</span> <span class="main">∈</span> bad_sec_prik <span class="main">∧</span> <span class="main">(</span><span class="skolem">n'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id"</span></span>
        <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword2"><span class="keyword">and</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n'</span> <span class="skolem">S'</span> <span class="skolem">A</span>
    <span class="keyword3"><span class="command">assume</span></span>
      N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">S</span><span class="main">.</span> Rev_PriK <span class="main">∈</span> <span class="bound">S</span> <span class="main">⟶</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="bound">S</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> Sec_PriK <span class="bound">m</span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">∧</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      O<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span><span class="main">.</span> Sec_PriK <span class="bound">m</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∉</span> bad_id"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      P<span class="main">:</span> <span class="quoted"><span class="quoted">"Rev_PriK <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="skolem">n'</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="skolem">S'</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> AgrKey <span class="main">(</span>PriK <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">n'</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="main">=</span> insert <span class="skolem">A</span> <span class="skolem">S'</span> <span class="main">∨</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="skolem">S</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> M <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ P O N<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> insert <span class="skolem">A</span> <span class="skolem">S'</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> Rev_PriK"</span></span>
        <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> contrapos_pn<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> rev_prikey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> J<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Sec_PriK <span class="skolem">m'</span> <span class="main">∈</span> <span class="skolem">S'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id"</span></span>
        <span class="keyword1"><span class="command">using</span></span> N <span class="keyword2"><span class="keyword">and</span></span> P <span class="keyword2"><span class="keyword">and</span></span> Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">∉</span> bad_id"</span></span>
        <span class="keyword1"><span class="command">using</span></span> O <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m'</span><span class="main">.</span> <span class="bound">m'</span> <span class="main">≠</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">m'</span> <span class="main">∈</span> bad_sec_prik <span class="main">∧</span> <span class="main">(</span><span class="skolem">n'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id"</span></span>
        <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n'</span> <span class="skolem">S'</span>
    <span class="keyword3"><span class="command">assume</span></span>
      N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">S</span><span class="main">.</span> Rev_PriK <span class="main">∈</span> <span class="bound">S</span> <span class="main">⟶</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="bound">S</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> Sec_PriK <span class="bound">m</span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">∧</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      O<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span><span class="main">.</span> Sec_PriK <span class="bound">m</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∉</span> bad_id"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      P<span class="main">:</span> <span class="quoted"><span class="quoted">"Rev_PriK <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">n'</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="main">=</span> <span class="skolem">S'</span> <span class="main">∨</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="skolem">S</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> AgrKey <span class="main">(</span>PriK <span class="main">(</span>Tok_PriK <span class="skolem">n'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> M <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ P O N<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
       <span class="operator">insert</span> tok_prikey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> J C<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n'</span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span>
      N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">S</span><span class="main">.</span> Rev_PriK <span class="main">∈</span> <span class="bound">S</span> <span class="main">⟶</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="bound">S</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> Sec_PriK <span class="bound">m</span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">∧</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      O<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span><span class="main">.</span> Sec_PriK <span class="bound">m</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∉</span> bad_id"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      P<span class="main">:</span> <span class="quoted"><span class="quoted">"Rev_PriK <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="skolem">n'</span><span class="main">,</span> <span class="skolem">X</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∨</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="skolem">n'</span><span class="main">,</span> Hash <span class="skolem">X</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">n'</span> <span class="main">∧</span> AgrKey <span class="main">(</span>PubK <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∨</span>
      <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="skolem">S</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> M <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ P O N<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> AgrKey <span class="main">(</span>PubK <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="skolem">n'</span><span class="main">,</span> <span class="skolem">X</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="skolem">S</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="skolem">n'</span><span class="main">,</span> Hash <span class="skolem">X</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">S</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">S</span> s<span class="hidden">⇩</span><sub>0</sub>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊨</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∧</span> <span class="main">¬</span> <span class="var">?P<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">S</span> <span class="bound">u</span> <span class="main">∧</span> <span class="var">?P<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">S</span> <span class="bound">v</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> rtrancl_start<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">u<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="skolem">u<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⊢</span> <span class="skolem">v<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="skolem">v<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⊨</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">∧</span>
          <span class="main">¬</span> <span class="var">?P<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">S</span> <span class="skolem">u<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="var">?P<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">S</span> <span class="skolem">v<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="skolem">S</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="skolem">v<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> idinfo_crypt idinfo_mpair_fst idinfo_mpair_snd
           idinfo_hash_hash<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="skolem">S</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> subsetD <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"spied <span class="skolem"><span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>3</sub></span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> spied_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> AgrKey <span class="main">(</span>PubK <span class="skolem">S</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m'</span><span class="main">.</span> <span class="bound">m'</span> <span class="main">≠</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">m'</span> <span class="main">∈</span> bad_sec_prik <span class="main">∧</span> <span class="main">(</span><span class="skolem">n'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> M <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ P O N<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> id_anonymous <span class="main">[</span><span class="operator">rotated</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">m</span> <span class="main">∉</span> bad_sec_prik <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m'</span><span class="main">.</span> <span class="bound">m'</span> <span class="main">≠</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">m'</span> <span class="main">∈</span> bad_sec_prik <span class="main">∧</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">)</span><span class="main">;</span>
    s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∉</span> bad_id<span class="main">;</span> <span class="free">n</span> <span class="main">∉</span> bad_tok_prik<span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> contrapos_pn<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> id_identified<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Possibility">
<div class="head">
<h1>Theory Possibility</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Logging-independent Message Anonymity in the Relational Method
    Author:      Pasquale Noce
                 Software Engineer at HID Global, Italy
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at hidglobal dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Possibility of anonymity compromise for token pseudonymous identifiers"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Possibility
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Anonymity">Anonymity</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

This section proves possibility properties <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">tok_id_identified</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">sec_id_identified</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
which altogether state that the spy can map a token pseudonymous identifier to the related token if
either attack option described in section \ref{Protocol} is viable. Both properties are proven by
construction, namely by creating as many sample protocol runs such as to satisfy their conclusions
if their assumptions are fulfilled.

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tok_id_pubk_prik</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> agent_id <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">tok_id_pubk_prik</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> ID <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Sec_PubKey <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> s<span class="hidden">⇩</span><sub>0</sub>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tok_id_hash</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> agent_id <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">tok_id_hash</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Sec_PubKey <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>tok_id_pubk_prik <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">proposition</span></span> tok_id_pubk_prik_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_tok_prik <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> tok_id_pubk_prik <span class="free">n</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>s<span class="hidden">⇩</span><sub>0</sub><span class="main">,</span> tok_id_pubk_prik <span class="free">n</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> rel_id_pubk_prik"</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> r_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tok_id_pubk_prik_def rel_def image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> tok_id_pubk_prik_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_tok_prik <span class="main">⟹</span>
    <span class="main">{</span>ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">⟩</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="main">(</span>tok_id_pubk_prik <span class="free">n</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tok_id_pubk_prik_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> tok_id_hash_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_tok_prik <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> tok_id_hash <span class="free">n</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> tok_id_pubk_prik_rel <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tok_id_pubk_prik <span class="free">n</span> <span class="free">m</span><span class="main">,</span> tok_id_hash <span class="free">n</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> rel_id_hash"</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">frule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> tok_id_pubk_prik_msg <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tok_id_hash_def rel_def<span class="main">)</span>


<span class="keyword1"><span class="command">theorem</span></span> tok_id_identified<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_tok_prik <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"tok_id_hash <span class="free"><span class="free"><span class="free">n</span></span></span> <span class="free"><span class="free"><span class="free">m</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> tok_id_hash_rel <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tok_id_hash_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sec_pubk_less</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sec_pubk_less</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> PubKey <span class="main">{</span>Tok_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Rev_PriK<span class="main">}</span><span class="main">)</span> s<span class="hidden">⇩</span><sub>0</sub>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sec_id_pubk_less</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sec_id_pubk_less</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> PubKey <span class="main">{</span>Tok_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Rev_PriK<span class="main">}</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>sec_pubk_less <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sec_id_pubk_more</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> agent_id <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sec_id_pubk_more</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> ID <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Sec_PubKey <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>sec_id_pubk_less <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sec_id_hash</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> agent_id <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sec_id_hash</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Sec_PubKey <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>sec_id_pubk_more <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Possibility-sec_id_identified_1"><span class="command">lemma</span></span> sec_id_identified_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">{</span>Tok_PriK <span class="free">n</span><span class="main">,</span> Sec_PriK <span class="free">m</span><span class="main">,</span> Rev_PriK<span class="main">}</span> <span class="main">≠</span> <span class="main">{</span>Tok_PriK <span class="free">n'</span><span class="main">,</span> Rev_PriK<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Sec_PriK <span class="free"><span class="free"><span class="free">m</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span>
 sec_prik_rev sec_prik_tok_prik<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> spec <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Possibility-sec_id_identified_2"><span class="command">lemma</span></span> sec_id_identified_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> PubKey <span class="main">{</span>Tok_PriK <span class="free">n</span><span class="main">,</span> Rev_PriK<span class="main">}</span><span class="main">)</span> <span class="main">∉</span> s<span class="hidden">⇩</span><sub>0</sub>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> tok_prik_rev sec_id_identified_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> spec <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main">)</span>

<span class="keyword1" id="Possibility-sec_id_identified_3"><span class="command">lemma</span></span> sec_id_identified_3<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">{</span>Tok_PriK <span class="free">n</span><span class="main">,</span> Rev_PriK<span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span>Tok_PriK <span class="free">n</span><span class="main">,</span> Sec_PriK <span class="free">m</span><span class="main">,</span> Rev_PriK<span class="main">}</span> <span class="main">-</span> <span class="main">{</span>Sec_PriK <span class="free">m</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> sec_prik_rev sec_prik_tok_prik<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Possibility-sec_id_identified_4"><span class="command">lemma</span></span> sec_id_identified_4<span class="main">:</span>
 <span class="quoted"><span class="quoted">"PubK <span class="main">{</span>Tok_PriK <span class="free">n</span><span class="main">,</span> Sec_PriK <span class="free">m</span><span class="main">,</span> Rev_PriK<span class="main">}</span> <span class="main">=</span>
    PubK <span class="main">(</span>insert <span class="main">(</span>Sec_PriK <span class="free">m</span><span class="main">)</span> <span class="main">{</span>Tok_PriK <span class="free">n</span><span class="main">,</span> Rev_PriK<span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">proposition</span></span> sec_pubk_less_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">{</span><span class="free">m</span><span class="main">,</span> <span class="free">m'</span><span class="main">}</span> <span class="main">⊆</span> bad_sec_prik<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∉</span> bad_id<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">⟧</span> <span class="main">⟹</span>
    s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> sec_pubk_less <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>s<span class="hidden">⇩</span><sub>0</sub><span class="main">,</span> sec_pubk_less <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> rel_pubk_less"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> r_into_rtrancl<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sec_pubk_less_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sec_id_identified_3 <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> insert_ident<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sec_id_identified_3 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">insert</span> sec_id_identified_2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> sec_pubk_less_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">{</span><span class="free">m</span><span class="main">,</span> <span class="free">m'</span><span class="main">}</span> <span class="main">⊆</span> bad_sec_prik<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∉</span> bad_id<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">{</span>Sec_PriKey <span class="free">m</span><span class="main">,</span> Sec_PriKey <span class="free">m'</span><span class="main">,</span> PubKey <span class="main">{</span>Tok_PriK <span class="free">n</span><span class="main">,</span> Rev_PriK<span class="main">}</span><span class="main">,</span>
      ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m'</span><span class="main">)</span><span class="main">⟩</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="main">(</span>sec_pubk_less <span class="free">n</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">{</span><span class="main">⟨</span><span class="free">n</span><span class="main">,</span> PubKey <span class="main">{</span>Tok_PriK <span class="free">n</span><span class="main">,</span> Rev_PriK<span class="main">}</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">⟩</span><span class="main">,</span>
      <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">}</span> <span class="main">∩</span>
      spied <span class="main">(</span>sec_pubk_less <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> sec_id_identified_2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sec_pubk_less_def image_def
 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sec_prik_eq<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> sec_id_pubk_less_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">{</span><span class="free">m</span><span class="main">,</span> <span class="free">m'</span><span class="main">}</span> <span class="main">⊆</span> bad_sec_prik<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∉</span> bad_id<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">⟧</span> <span class="main">⟹</span>
    s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> sec_id_pubk_less <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> sec_pubk_less_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sec_pubk_less <span class="free">n</span><span class="main">,</span> sec_id_pubk_less <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> rel_id_pubk_less"</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">frule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> sec_pubk_less_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sec_id_pubk_less_def rel_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sec_id_identified_3 <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span>
 sec_id_identified_3<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> insert_ident<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> sec_prik_tok_prik<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> sec_id_pubk_less_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">{</span><span class="free">m</span><span class="main">,</span> <span class="free">m'</span><span class="main">}</span> <span class="main">⊆</span> bad_sec_prik<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∉</span> bad_id<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">{</span>Sec_PriKey <span class="free">m</span><span class="main">,</span> ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> PubKey <span class="main">{</span>Tok_PriK <span class="free">n</span><span class="main">,</span> Rev_PriK<span class="main">}</span><span class="main">⟩</span><span class="main">}</span> <span class="main">⊆</span>
      spied <span class="main">(</span>sec_id_pubk_less <span class="free">n</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">{</span><span class="main">⟨</span><span class="free">n</span><span class="main">,</span> ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">}</span> <span class="main">∩</span>
      spied <span class="main">(</span>sec_id_pubk_less <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> sec_pubk_less_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> sec_id_identified_1<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sec_id_pubk_less_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> sec_id_pubk_more_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">{</span><span class="free">m</span><span class="main">,</span> <span class="free">m'</span><span class="main">}</span> <span class="main">⊆</span> bad_sec_prik<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∉</span> bad_id<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">⟧</span> <span class="main">⟹</span>
    s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> sec_id_pubk_more <span class="free">n</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> sec_id_pubk_less_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sec_id_pubk_less <span class="free">n</span><span class="main">,</span> sec_id_pubk_more <span class="free">n</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> rel_id_pubk_more"</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">frule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> sec_id_pubk_less_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sec_id_pubk_more_def rel_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sec_id_identified_4<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 3<span class="main"><span class="main">)</span></span> sec_id_identified_4<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subst</span> insert_ident<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> sec_id_pubk_more_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">{</span><span class="free">m</span><span class="main">,</span> <span class="free">m'</span><span class="main">}</span> <span class="main">⊆</span> bad_sec_prik<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∉</span> bad_id<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">{</span>ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">⟩</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="main">(</span>sec_id_pubk_more <span class="free">n</span> <span class="free">m</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∉</span> spied <span class="main">(</span>sec_id_pubk_more <span class="free">n</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> sec_id_pubk_less_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sec_id_pubk_more_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> sec_id_hash_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">{</span><span class="free">m</span><span class="main">,</span> <span class="free">m'</span><span class="main">}</span> <span class="main">⊆</span> bad_sec_prik<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∉</span> bad_id<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">⟧</span> <span class="main">⟹</span>
    s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> sec_id_hash <span class="free">n</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> sec_id_pubk_more_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sec_id_pubk_more <span class="free">n</span> <span class="free">m</span><span class="main">,</span> sec_id_hash <span class="free">n</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> rel_id_hash"</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">frule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> sec_id_pubk_more_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sec_id_hash_def rel_def<span class="main">)</span>


<span class="keyword1"><span class="command">theorem</span></span> sec_id_identified<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">{</span><span class="free">m</span><span class="main">,</span> <span class="free">m'</span><span class="main">}</span> <span class="main">⊆</span> bad_sec_prik<span class="main">;</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m'</span><span class="main">)</span> <span class="main">∈</span> bad_id<span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Hash <span class="main">(</span>ID <span class="free">n</span> <span class="main">(</span>Sec_PubKey <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> bad_id"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"sec_id_hash <span class="free"><span class="free"><span class="free">n</span></span></span> <span class="free"><span class="free"><span class="free">m</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> sec_id_hash_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sec_id_hash_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>