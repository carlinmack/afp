<div id="Finite_Map_Extras">
<div class="head">
<h1>Theory Finite_Map_Extras</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Extra Features for Finite Maps ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Finite_Map_Extras
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Finite_Map.html">HOL-Library.Finite_Map</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Extra lemmas and syntactic sugar for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fmap›</span></span></span></span> ›</span></span>

<span class="keyword1"><span class="command">notation</span></span> fmlookup <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">‹<span class="keyword1">$$</span>›</span> 900<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> fmempty <span class="main">(</span><span class="quoted">‹<span class="keyword1">{$$}</span>›</span><span class="main">)</span>

<span class="keyword1"><span class="command">nonterminal</span></span> fmaplets <span class="keyword2"><span class="keyword">and</span></span> fmaplet

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_fmaplet"</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> fmaplet"</span></span>                        <span class="main">(</span><span class="quoted">"_ <span class="keyword3">/</span><span class="keyword1">$$:=</span><span class="keyword3">/ </span>_"</span><span class="main">)</span>
  <span class="quoted">"_fmaplets"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> fmaplet"</span></span>                        <span class="main">(</span><span class="quoted">"_ <span class="keyword3">/</span><span class="keyword1">[$$:=]</span><span class="keyword3">/ </span>_"</span><span class="main">)</span>
  <span class="quoted">""</span>          <span class="main">::</span> <span class="quoted"><span class="quoted">"fmaplet <span class="main">⇒</span> fmaplets"</span></span>                        <span class="main">(</span><span class="quoted">"_"</span><span class="main">)</span>
  <span class="quoted">"_Fmaplets"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>fmaplet<span class="main">,</span> fmaplets<span class="main">]</span> <span class="main">⇒</span> fmaplets"</span></span>            <span class="main">(</span><span class="quoted">"_<span class="keyword1">,</span><span class="keyword3">/ </span>_"</span><span class="main">)</span>
  <span class="quoted">"_FmapUpd"</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap<span class="main">,</span> fmaplets<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/</span><span class="keyword1">'(</span>_<span class="keyword1">')</span>"</span> <span class="main">[</span>900<span class="main">,</span> 0<span class="main">]</span> 900<span class="main">)</span>
  <span class="quoted">"_Fmap"</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"fmaplets <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span>                  <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">{</span>_<span class="keyword1">}</span><span class="keyword3">)</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"_FmapUpd <span class="free">m</span> <span class="main">(</span>_Fmaplets <span class="free">xy</span> <span class="free">ms</span><span class="main">)</span>"</span>  <span class="main">⇌</span> <span class="quoted">"_FmapUpd <span class="main">(</span>_FmapUpd <span class="free">m</span> <span class="free">xy</span><span class="main">)</span> <span class="free">ms</span>"</span>
  <span class="quoted">"_FmapUpd <span class="free">m</span> <span class="main">(</span>_fmaplet  <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span>    <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> fmupd <span class="free">x</span> <span class="free">y</span> <span class="free">m</span>"</span>
  <span class="quoted">"_Fmap <span class="free">ms</span>"</span>                     <span class="main">⇌</span> <span class="quoted">"_FmapUpd <span class="main">(</span><span class="keyword1">CONST</span> fmempty<span class="main">)</span> <span class="free">ms</span>"</span>
  <span class="quoted">"_Fmap <span class="main">(</span>_Fmaplets <span class="free">ms1</span> <span class="free">ms2</span><span class="main">)</span>"</span>     <span class="main">↽</span> <span class="quoted">"_FmapUpd <span class="main">(</span>_Fmap <span class="free">ms1</span><span class="main">)</span> <span class="free">ms2</span>"</span>
  <span class="quoted">"_Fmaplets <span class="free">ms1</span> <span class="main">(</span>_Fmaplets <span class="free">ms2</span> <span class="free">ms3</span><span class="main">)</span>"</span> <span class="main">↽</span> <span class="quoted">"_Fmaplets <span class="main">(</span>_Fmaplets <span class="free">ms1</span> <span class="free">ms2</span><span class="main">)</span> <span class="free">ms3</span>"</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fmap_lookup_the</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">‹<span class="keyword1">$$!</span>›</span> 900<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main"><span class="free">$$!</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Finite_Map_Extras-fmadd_singletons_comm"><span class="command">lemma</span></span> fmadd_singletons_comm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">k<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$:=</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">$$:=</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">$$:=</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$:=</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fmap_ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
  <span class="keyword1"><span class="command">consider</span></span>
    <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">k<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="main">|</span>
    <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">k<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="main">|</span>
    <span class="main">(</span>c<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="free">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="free">k<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="free">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$:=</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">$$:=</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span><span class="main">)</span> <span class="main">$$</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">$$:=</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$:=</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span><span class="main">)</span> <span class="main">$$</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-fmap_singleton_comm"><span class="command">lemma</span></span> fmap_singleton_comm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> fmempty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fmupd <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">(</span><span class="skolem">x</span> <span class="main">$$:=</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">x</span> <span class="main">$$:=</span> <span class="skolem">y</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fmupd.hyps <span class="keyword2"><span class="keyword">and</span></span> fmupd.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span> <span class="main">$$:=</span> <span class="skolem">y</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fmupd.prems <span class="keyword2"><span class="keyword">and</span></span> fmupd.hyps <span class="keyword2"><span class="keyword">and</span></span> fmupd.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span> <span class="main">$$:=</span> <span class="skolem">y</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmadd_assoc fmupd_lookup<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">m</span><span class="main">(</span><span class="skolem">x</span> <span class="main">$$:=</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span> <span class="main">$$:=</span> <span class="skolem">y</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">x</span> <span class="main">$$:=</span> <span class="skolem">y</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fmadd_singletons_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fmupd.prems <span class="keyword2"><span class="keyword">and</span></span> fmupd.hyps <span class="keyword2"><span class="keyword">and</span></span> fmupd.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">x</span> <span class="main">$$:=</span> <span class="skolem">y</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmadd_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> fmupd.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-fmap_disj_comm"><span class="command">lemma</span></span> fmap_disj_comm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> fmempty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fmupd <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$</span> <span class="skolem">k</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> fmupd.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fmupd.prems <span class="keyword2"><span class="keyword">and</span></span> fmupd.hyps <span class="keyword2"><span class="keyword">and</span></span> fmupd.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fmap_singleton_comm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmadd_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> fmupd.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-fmran_singleton"><span class="command">lemma</span></span> fmran_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"fmran <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span> <span class="main">=</span> <span class="main">{|</span><span class="free">v</span><span class="main">|}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">|∈|</span> fmran <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">v'</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">|∈|</span> fmran <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom' <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="free">k</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">|∈|</span> fmran <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> fmdom'I <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹fmdom' <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">|∈|</span> fmran <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> fmdom'I <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">|∈|</span> fmran <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmranI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fsubsetI fsubset_antisym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-fmmap_keys_hom"><span class="command">lemma</span></span> fmmap_keys_hom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmmap_keys <span class="free">f</span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> fmmap_keys <span class="free">f</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmmap_keys <span class="free">f</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmap_ext<span class="main">)</span>

<span class="keyword1" id="Finite_Map_Extras-map_insort_is_insort_key"><span class="command">lemma</span></span> map_insort_is_insort_key<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="bound">k'</span><span class="main">,</span> <span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">$$!</span> <span class="bound">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insort <span class="free">k</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
    insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="bound">k'</span><span class="main">,</span> <span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">$$!</span> <span class="bound">k'</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Finite_Map_Extras-sorted_list_of_fmap_is_insort_key_fst"><span class="command">lemma</span></span> sorted_list_of_fmap_is_insort_key_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_fmap <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_fmap <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    map <span class="main">(</span><span class="main">λ</span><span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="bound">k'</span><span class="main">,</span> <span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">$$!</span> <span class="bound">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fset <span class="main">(</span>fmdom <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sorted_list_of_fmap_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> 	map <span class="main">(</span><span class="main">λ</span><span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="bound">k'</span><span class="main">,</span> <span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">$$!</span> <span class="bound">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fset <span class="main">(</span>finsert <span class="free">k</span> <span class="main">(</span>fmdom <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
    map <span class="main">(</span><span class="main">λ</span><span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="bound">k'</span><span class="main">,</span> <span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">$$!</span> <span class="bound">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insort <span class="free">k</span> <span class="main">(</span>sorted_list_of_fset <span class="main">(</span>fmdom <span class="free">m</span> <span class="main">-</span> <span class="main">{|</span><span class="free">k</span><span class="main">|}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_list_of_fset.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
    map <span class="main">(</span><span class="main">λ</span><span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="bound">k'</span><span class="main">,</span> <span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">$$!</span> <span class="bound">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insort <span class="free">k</span> <span class="main">(</span>sorted_list_of_fset <span class="main">(</span>fmdom <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmdom_notI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
    insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="bound">k'</span><span class="main">,</span> <span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">$$!</span> <span class="bound">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fset <span class="main">(</span>fmdom <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_insort_is_insort_key <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="bound">k'</span><span class="main">,</span> <span class="free">m</span> <span class="main">$$!</span> <span class="bound">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fset <span class="main">(</span>fmdom <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k'</span><span class="main">.</span> <span class="bound">k'</span> <span class="main">∈</span> fmdom' <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">$$!</span> <span class="bound">k'</span> <span class="main">=</span> <span class="free">m</span> <span class="main">$$!</span> <span class="bound">k'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fmdom'_notI <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∉</span> set <span class="main">(</span>sorted_list_of_fset <span class="main">(</span>fmdom <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fmdom'_alt_def <span class="keyword2"><span class="keyword">and</span></span> fmdom'_notI <span class="keyword2"><span class="keyword">and</span></span> in_set_member <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fmdom'_alt_def map_eq_conv sorted_list_of_fset_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sorted_list_of_fmap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-distinct_fst_inj"><span class="command">lemma</span></span> distinct_fst_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>map fst <span class="free">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>map fst <span class="free">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_map inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-distinct_sorted_list_of_fmap"><span class="command">lemma</span></span> distinct_sorted_list_of_fmap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sorted_list_of_fmap_def <span class="keyword2"><span class="keyword">and</span></span> sorted_list_of_fset_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_map inj_on_def<span class="main">)</span>

<span class="keyword1" id="Finite_Map_Extras-map_inj_pair_non_membership"><span class="command">lemma</span></span> map_inj_pair_non_membership<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">k</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_rec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> injD<span class="main">)</span>

<span class="keyword1" id="Finite_Map_Extras-map_insort_key_fst"><span class="command">lemma</span></span> map_insort_key_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span>
    insort_key fst <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> fst <span class="skolem">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f_p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">(</span>fst <span class="skolem">p</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insort_key fst <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?g</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insort_key fst <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="var">?f_p</span> <span class="main">#</span> map <span class="var">?g</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_eq_if<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span>fst <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monoE<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insort_key fst <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="var">?f_p</span> <span class="main">#</span> map <span class="var">?g</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="var">?f_p</span> <span class="main">#</span> map <span class="var">?g</span> <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insort_key fst <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?g</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="var">?f_p</span> <span class="main">#</span> map <span class="var">?g</span> <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="var">?g</span> <span class="main">(</span>insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="var">?f_p</span> <span class="main">#</span> map <span class="var">?g</span> <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f_p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">(</span>fst <span class="skolem">p</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insort_key fst <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?g</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insort_key fst <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="var">?f_p</span> <span class="main">#</span> map <span class="var">?g</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_eq_if<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹mono <span class="free">f</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>fst <span class="skolem">p</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mono_invE<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insort_key fst <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?g</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="var">?f_p</span> <span class="main">#</span> insort_key fst <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?g</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹inj <span class="free">f</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> injD<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.IH <span class="keyword2"><span class="keyword">and</span></span> Cons.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
      <span class="var">?f_p</span> <span class="main">#</span> <span class="main">(</span>map <span class="var">?g</span> <span class="main">(</span>insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="var">?g</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-map_sorted_list_of_fmap"><span class="command">lemma</span></span> map_sorted_list_of_fmap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fmap <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    insort_key fst <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="var">?g</span> <span class="main">(</span>sorted_list_of_fmap <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  	map <span class="var">?g</span> <span class="main">(</span>insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  	<span class="keyword1"><span class="command">using</span></span> sorted_list_of_fmap_is_insort_key_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> insort_key fst <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?g</span> <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_sorted_list_of_fmap<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_set map_of_eq_None_iff map_of_sorted_list<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_insort_key_fst assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-fmap_of_list_insort_key_fst"><span class="command">lemma</span></span> fmap_of_list_insort_key_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmap_of_list <span class="main">(</span>insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fmap_of_list <span class="free">ps</span><span class="main">)</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> fst <span class="skolem">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmap_of_list <span class="main">(</span>insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      fmap_of_list <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>fmap_of_list <span class="main">(</span>insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>fst <span class="skolem">p</span> <span class="main">$$:=</span> snd <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmap_of_list_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> Cons.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>fmap_of_list <span class="skolem">ps</span><span class="main">)</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">(</span>fst <span class="skolem">p</span> <span class="main">$$:=</span> snd <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"fmap_of_list <span class="main">(</span>insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span>fmap_of_list <span class="skolem">ps</span><span class="main">)</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">(</span>fst <span class="skolem">p</span> <span class="main">$$:=</span> snd <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∉</span> set <span class="main">(</span>fst <span class="skolem">p</span> <span class="main">#</span> map fst <span class="skolem">ps</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span> <span class="main">$$</span> <span class="main">(</span>fst <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmap_of_list <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fmap_of_list <span class="skolem">ps</span><span class="main">)</span><span class="main">(</span>fst <span class="skolem">p</span> <span class="main">$$:=</span> snd <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmap_of_list_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword2"><span class="keyword">and</span></span> ** <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> fmap_singleton_comm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmadd_fmupd fmap_of_list_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> fmupd_alt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-fmap_of_list_insort_key_fst_map"><span class="command">lemma</span></span> fmap_of_list_insort_key_fst_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmap_of_list <span class="main">(</span>insort_key fst <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>fmap_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">f</span> <span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="var">?g</span> <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹inj <span class="free">f</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="var">?ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_fst_inj <span class="keyword2"><span class="keyword">and</span></span> distinct_sorted_list_of_fmap <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">k</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="var">?ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_of_eq_None_iff map_of_sorted_list set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹inj <span class="free">f</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> map_inj_pair_non_membership <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fmap_of_list_insort_key_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-fmap_of_list_sorted_list_of_fmap"><span class="command">lemma</span></span> fmap_of_list_sorted_list_of_fmap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>linorder"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmap_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fmap <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>fmap_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">f</span> <span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmap_of_list <span class="main">(</span>map <span class="var">?g</span> <span class="main">(</span>sorted_list_of_fmap <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    fmap_of_list <span class="main">(</span>map <span class="var">?g</span> <span class="main">(</span>insort_key fst <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_list_of_fmap_is_insort_key_fst<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fmap_of_list <span class="main">(</span>insort_key fst <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?g</span> <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword2"><span class="keyword">and</span></span> map_sorted_list_of_fmap <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>fmap_of_list <span class="main">(</span>map <span class="var">?g</span> <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">f</span> <span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmap_of_list_insort_key_fst_map<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Map difference ›</span></span>

<span class="keyword1" id="Finite_Map_Extras-fsubset_antisym"><span class="command">lemma</span></span> fsubset_antisym<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> dom <span class="main">(</span><span class="main">($$)</span> <span class="free">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">($$)</span> <span class="free">m</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">($$)</span> <span class="free">n</span><span class="main">)</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmsubset.rep_eq map_le_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> dom <span class="main">(</span><span class="main">($$)</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">($$)</span> <span class="free">n</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">($$)</span> <span class="free">m</span><span class="main">)</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmsubset.rep_eq map_le_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fmap_ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">consider</span></span>
      <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> dom <span class="main">(</span><span class="main">($$)</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="main">|</span>
      <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> dom <span class="main">(</span><span class="main">($$)</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="main">|</span>
      <span class="main">(</span>c<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∉</span> dom <span class="main">(</span><span class="main">($$)</span> <span class="free">m</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">∉</span> dom <span class="main">(</span><span class="main">($$)</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">$$</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">n</span> <span class="main">$$</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> a
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> dom <span class="main">(</span><span class="main">($$)</span> <span class="free">m</span><span class="main">)</span><span class="main">.</span> <span class="free">m</span> <span class="main">$$</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">n</span> <span class="main">$$</span> <span class="bound">k</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> b
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> dom <span class="main">(</span><span class="main">($$)</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="free">n</span> <span class="main">$$</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">m</span> <span class="main">$$</span> <span class="bound">k</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> c
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmdom'_notD<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">fmdiff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">‹<span class="keyword1">--<span class="hidden">⇩</span><sub>f</sub></span>›</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">--<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> fmfilter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> fmdom' <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span>"</span></span>

<span class="keyword1" id="Finite_Map_Extras-fmdiff_partition"><span class="command">lemma</span></span> fmdiff_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">--<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">--<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">--<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">--<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="skolem">k</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="skolem">k</span> <span class="main">|∈|</span> fmdom <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">--<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">--<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">$$</span> <span class="skolem">k</span> <span class="keyword1">else</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">$$</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$</span> <span class="skolem">k</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">|∈|</span> fmdom <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">--<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> ** <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> ** <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fmpredD fmsubset_alt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">v</span><span class="main">.</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">--<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmpred_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmsubset_alt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">--<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmsubset.rep_eq map_le_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fsubset_antisym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-fmdiff_fmupd"><span class="command">lemma</span></span> fmdiff_fmupd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">--<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k'</span><span class="main">.</span> <span class="bound">k'</span> <span class="main">∉</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">--<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span> <span class="main">=</span> fmfilter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> fmdom' <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fmfilter <span class="var">?P</span> <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="var">?P</span> <span class="free">k</span> <span class="keyword1">then</span> <span class="main">(</span>fmfilter <span class="var">?P</span> <span class="free">m</span><span class="main">)</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">else</span> fmfilter <span class="var">?P</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fmfilter <span class="var">?P</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k'</span> <span class="bound">v'</span><span class="main">.</span> <span class="free">m</span> <span class="main">$$</span> <span class="bound">k'</span> <span class="main">=</span> Some <span class="bound">v'</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="bound">k'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Map symmetric difference ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fmsym_diff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">‹<span class="keyword1">Δ<span class="hidden">⇩</span><sub>f</sub></span>›</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">Δ<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">--<span class="hidden">⇩</span><sub>f</sub></span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="keyword1">--<span class="hidden">⇩</span><sub>f</sub></span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Domain restriction ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">dom_res</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">‹<span class="keyword1">⊲</span>›</span> 150<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> fmfilter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Domain exclusion ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">dom_exc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">‹<span class="keyword1">⊲'/</span>›</span> 150<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">⊲/</span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> fmfilter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Intersection plus ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">intersection_plus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>monoid_add<span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">‹<span class="keyword1">∩<span class="hidden">⇩</span><sub>+</sub></span>›</span> 100<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">∩<span class="hidden">⇩</span><sub>+</sub></span></span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> fmmap_keys <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$$!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>fmdom' <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⊲</span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Union override right ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">union_override_right</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">‹<span class="keyword1">∪<span class="hidden">⇩</span><sub>→</sub></span>›</span> 100<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">∪<span class="hidden">⇩</span><sub>→</sub></span></span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> <span class="main">(</span>fmdom' <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⊲/</span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Union override left ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">union_override_left</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">‹<span class="keyword1">∪<span class="hidden">⇩</span><sub>←</sub></span>›</span> 100<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">∪<span class="hidden">⇩</span><sub>←</sub></span></span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span>fmdom' <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⊲/</span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Union override plus ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">union_override_plus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>monoid_add<span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">‹<span class="keyword1">∪<span class="hidden">⇩</span><sub>+</sub></span>›</span> 100<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">∪<span class="hidden">⇩</span><sub>+</sub></span></span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">Δ<span class="hidden">⇩</span><sub>f</sub></span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∩<span class="hidden">⇩</span><sub>+</sub></span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Extra lemmas for the non-standard map operators ›</span></span>

<span class="keyword1" id="Finite_Map_Extras-dom_res_singleton"><span class="command">lemma</span></span> dom_res_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="main">⊲</span> <span class="free">m</span> <span class="main">=</span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> fmempty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fmupd <span class="skolem">k'</span> <span class="skolem">v'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="skolem">k'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">(</span><span class="skolem">k'</span> <span class="main">$$:=</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="main">⊲</span> <span class="skolem">m</span><span class="main">(</span><span class="skolem">k'</span> <span class="main">$$:=</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="main">⊲</span> <span class="skolem">m</span><span class="main">)</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">$$</span> <span class="skolem">k'</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{$$}</span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmap_ext<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">(</span><span class="skolem">k'</span> <span class="main">$$:=</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="main">⊲</span> <span class="skolem">m</span><span class="main">(</span><span class="skolem">k'</span> <span class="main">$$:=</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="main">⊲</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword2"><span class="keyword">and</span></span> fmupd.IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-dom_res_union_distr"><span class="command">lemma</span></span> dom_res_union_distr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">m</span> <span class="main">=</span> <span class="free">A</span> <span class="main">⊲</span> <span class="free">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">B</span> <span class="main">⊲</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">($$)</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">($$)</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊲</span> <span class="free">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">B</span> <span class="main">⊲</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> map_le_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> dom <span class="main">(</span><span class="main">($$)</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">m</span><span class="main">)</span> <span class="main">$$</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊲</span> <span class="free">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">B</span> <span class="main">⊲</span> <span class="free">m</span><span class="main">)</span> <span class="main">$$</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">($$)</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊲</span> <span class="free">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">B</span> <span class="main">⊲</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">($$)</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> map_le_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> dom <span class="main">(</span><span class="main">($$)</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊲</span> <span class="free">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">B</span> <span class="main">⊲</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">⊲</span> <span class="free">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">B</span> <span class="main">⊲</span> <span class="free">m</span><span class="main">)</span> <span class="main">$$</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">m</span><span class="main">)</span> <span class="main">$$</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fmlookup_inject <span class="keyword2"><span class="keyword">and</span></span> map_le_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-dom_exc_add_distr"><span class="command">lemma</span></span> dom_exc_add_distr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊲/</span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">⊲/</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="free">s</span> <span class="main">⊲/</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmfilter_add_distrib<span class="main">)</span>

<span class="keyword1" id="Finite_Map_Extras-fmap_partition"><span class="command">lemma</span></span> fmap_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⊲/</span> <span class="free">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> fmempty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fmupd <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fmupd.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊲/</span> <span class="skolem">m</span><span class="main">(</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲</span> <span class="skolem">m</span><span class="main">(</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">s</span> <span class="main">⊲/</span> <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲</span> <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⊲/</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲/</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dom_exc_add_distr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊲/</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲/</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span> <span class="main">=</span>
      <span class="free">s</span> <span class="main">⊲/</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{$$}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⊲/</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fmupd.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fmupd.hyps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊲/</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲/</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span> <span class="main">=</span>
      <span class="free">s</span> <span class="main">⊲/</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{$$}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⊲/</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fmupd.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⊲/</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">s</span> <span class="main">⊲</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fmap_singleton_comm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> fmadd_assoc fmlookup_filter<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fmupd.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="skolem">k</span> <span class="main">$$:=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-dom_res_addition_in"><span class="command">lemma</span></span> dom_res_addition_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmdom' <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v'</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom' <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span>fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dom_res_union_distr <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> dom_res_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-dom_res_addition_not_in"><span class="command">lemma</span></span> dom_res_addition_not_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmdom' <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom' <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> fmfilter <span class="main">(</span><span class="main">λ</span><span class="bound">k'</span><span class="main">.</span> <span class="bound">k'</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∨</span> <span class="bound">k'</span> <span class="main">∈</span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fmfilter_cong'<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∈</span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∨</span> <span class="skolem">k'</span> <span class="main">∈</span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">∈</span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="free">k</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmdom'_notI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-inter_plus_addition_in"><span class="command">lemma</span></span> inter_plus_addition_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">∩<span class="hidden">⇩</span><sub>+</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩<span class="hidden">⇩</span><sub>+</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v'</span> <span class="main">+</span> <span class="free">v</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k'</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">+</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">$$!</span> <span class="bound">k'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">∩<span class="hidden">⇩</span><sub>+</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> fmmap_keys <span class="var">?f</span> <span class="main">(</span><span class="main">(</span>fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v'</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dom_res_addition_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fmmap_keys <span class="var">?f</span> <span class="main">(</span>fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmmap_keys <span class="var">?f</span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom' <span class="main">(</span>fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∩</span> fmdom' <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v'</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmdom'_notI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> fmmap_keys_hom <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fmmap_keys <span class="var">?f</span> <span class="main">(</span>fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v'</span> <span class="main">+</span> <span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmmap_keys <span class="var">?f</span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v'</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v'</span> <span class="main">+</span> <span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fmap_ext<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k'</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmmap_keys <span class="var">?f</span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v'</span><span class="main">}</span> <span class="main">$$</span> <span class="skolem">k'</span> <span class="main">=</span> map_option <span class="main">(</span><span class="var">?f</span> <span class="skolem">k'</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v'</span><span class="main">}</span> <span class="main">$$</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fmlookup_fmmap_keys <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_option <span class="main">(</span><span class="var">?f</span> <span class="skolem">k'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="skolem">k'</span> <span class="keyword1">then</span> Some <span class="free">v'</span> <span class="keyword1">else</span> <span class="main">{$$}</span> <span class="main">$$</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v'</span> <span class="main">+</span> <span class="free">v</span><span class="main">}</span> <span class="main">$$</span> <span class="skolem">k'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="free">k</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmmap_keys <span class="var">?f</span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v'</span><span class="main">}</span> <span class="main">$$</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v'</span> <span class="main">+</span> <span class="free">v</span><span class="main">}</span> <span class="main">$$</span> <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fmmap_keys <span class="main">(</span><span class="main">λ</span><span class="bound">k'</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">+</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$!</span> <span class="bound">k'</span><span class="main">)</span> <span class="main">(</span>fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v'</span> <span class="main">+</span> <span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmap_ext<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-inter_plus_addition_notin"><span class="command">lemma</span></span> inter_plus_addition_notin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">∩<span class="hidden">⇩</span><sub>+</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩<span class="hidden">⇩</span><sub>+</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k'</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">+</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">$$!</span> <span class="bound">k'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">∩<span class="hidden">⇩</span><sub>+</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> fmmap_keys <span class="var">?f</span> <span class="main">(</span>fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dom_res_addition_not_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fmmap_keys <span class="main">(</span><span class="main">λ</span><span class="bound">k'</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">+</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$!</span> <span class="bound">k'</span><span class="main">)</span> <span class="main">(</span>fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fmap_ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmmap_keys <span class="var">?f</span> <span class="main">(</span>fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">$$</span> <span class="skolem">k'</span> <span class="main">=</span> map_option <span class="main">(</span><span class="var">?f</span> <span class="skolem">k'</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">$$</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fmlookup_fmmap_keys <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fmmap_keys <span class="main">(</span><span class="main">λ</span><span class="bound">k'</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">+</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$!</span> <span class="bound">k'</span><span class="main">)</span> <span class="main">(</span>fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">$$</span> <span class="skolem">k'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="free">k</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmdom'_notI<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmmap_keys <span class="var">?f</span> <span class="main">(</span>fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">$$</span> <span class="skolem">k'</span> <span class="main">=</span>
      fmmap_keys <span class="main">(</span><span class="main">λ</span><span class="bound">k'</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">+</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$!</span> <span class="bound">k'</span><span class="main">)</span> <span class="main">(</span>fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">$$</span> <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Map_Extras-union_plus_addition_notin"><span class="command">lemma</span></span> union_plus_addition_notin<span class="main">:</span> <span class="comment1">(* TODO: Find nicer proofs for SMT calls. *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">∪<span class="hidden">⇩</span><sub>+</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪<span class="hidden">⇩</span><sub>+</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">$$</span> <span class="free">k</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∪<span class="hidden">⇩</span><sub>+</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span>
    fmdom' <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊲/</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmdom' <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊲/</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">∩<span class="hidden">⇩</span><sub>+</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmdom'_notI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
    fmdom' <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊲/</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲/</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">∩<span class="hidden">⇩</span><sub>+</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fmdom'_fmupd fmfilter_cong insert_iff option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊲/</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲/</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩<span class="hidden">⇩</span><sub>+</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inter_plus_addition_notin <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊲/</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmdom' <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊲/</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩<span class="hidden">⇩</span><sub>+</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">{</span><span class="free">k</span> <span class="main">$$:=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fmap_singleton_comm
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fmadd_assoc fmfilter_fmmap_keys fmlookup_filter fmlookup_fmmap_keys<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>