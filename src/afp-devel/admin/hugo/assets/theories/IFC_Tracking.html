<div id="IFC">
<div class="head">
<h1>Theory IFC</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This section contains all necessary definitions of this development. Section~\ref{sec:pm} contains 
the structural definition of our program model which includes the security specification as well 
as abstractions of control flow and data.  Executions of our program model are defined in 
section~\ref{sec:ex}.  Additional well-formedness properties are defined in section~\ref{sec:wf}. 
Our security property is defined in section~\ref{sec:sec}.  Our characterisation of how information
is propagated by executions of our program model is defined in section~\ref{sec:char-cp}, for which
the correctness result can be found in section~\ref{sec:cor-cp}.  Section~\ref{sec:char-scp} contains
an additional approximation of this characterisation whose correctness result can be found in 
section~\ref{sec:cor-scp}.
›</span></span>


<span class="keyword1"><span class="command">theory</span></span> IFC
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Program Model›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:pm}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our program model contains all necessary components for the remaining development and consists of:›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'n</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">)</span> ifc_problem <span class="main">=</span>  
<span class="comment1">― ‹A set of nodes representing program locations:›</span>
  nodes <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'n</span> set›</span></span>
<span class="comment1">― ‹An initial node where all executions start:›</span>
  entry <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'n</span>›</span></span>
<span class="comment1">― ‹A final node where executions can terminate:›</span>
  return <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'n</span>›</span></span>
<span class="comment1">― ‹An abstraction of control flow in the form of an edge relation:›</span>
  edges <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'n</span> <span class="main">×</span> <span class="tfree">'n</span><span class="main">)</span> set›</span></span>
<span class="comment1">― ‹An abstraction of variables written at program locations:›</span>
  writes <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'var</span> set›</span></span>
<span class="comment1">― ‹An abstraction of variables read at program locations:›</span>
  reads <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'var</span> set›</span></span>
<span class="comment1">― ‹A set of variables containing the confidential information in the initial state:›</span>
  hvars <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'var</span> set›</span></span>
<span class="comment1">― ‹A step function on location state pairs:›</span>
  step <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'n</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'val</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'n</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'val</span><span class="main">)</span><span class="main">)</span>›</span></span>
<span class="comment1">― ‹An attacker model producing observations based on the reached state at certain locations:›</span>
  att <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'n</span> <span class="main">⇀</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'val</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We fix a program in the following in order to define the central concepts.  
The necessary well-formedness assumptions will be made in section~\ref{sec:wf}.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> IFC_def <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">prob</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'n</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">)</span> ifc_problem›</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some short hands to the components of the program which we will utilise exclusively in the following.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nodes</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">nodes</span> <span class="main">=</span> ifc_problem.nodes <span class="free">prob</span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">entry</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">entry</span> <span class="main">=</span> ifc_problem.entry <span class="free">prob</span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">return</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">return</span> <span class="main">=</span> ifc_problem.return <span class="free">prob</span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">edges</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">edges</span> <span class="main">=</span> ifc_problem.edges <span class="free">prob</span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">writes</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">writes</span> <span class="main">=</span> ifc_problem.writes <span class="free">prob</span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reads</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">reads</span> <span class="main">=</span> ifc_problem.reads <span class="free">prob</span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hvars</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">hvars</span> <span class="main">=</span> ifc_problem.hvars <span class="free">prob</span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">step</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">step</span> <span class="main">=</span> ifc_problem.step <span class="free">prob</span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">att</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">att</span> <span class="main">=</span> ifc_problem.att <span class="free">prob</span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The components of the step function for convenience.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">suc</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">suc</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> fst <span class="main">(</span>step <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sem</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sem</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> snd <span class="main">(</span>step <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword1" id="IFC-step_suc_sem"><span class="command">lemma</span></span> step_suc_sem<span class="main">:</span> <span class="quoted"><span class="quoted">‹step <span class="main">(</span><span class="free">n</span><span class="main">,</span><span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>suc <span class="free">n</span> <span class="free">σ</span><span class="main">,</span> sem <span class="free">n</span> <span class="free">σ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> suc_def sem_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Executions›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:ex}›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to define what it means for a program to be well-formed, we first require concepts 
of executions and program paths.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The sequence of nodes visited by the execution corresponding to an input state.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">path</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free">path</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">=</span> fst <span class="main">(</span><span class="main">(</span>step<span class="main">^^</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span>entry<span class="main">,</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The sequence of states visited by the execution corresponding to an input state.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kth_state</span> <span class="main">(</span> <span class="quoted">‹_<span class="keyword1">⇗</span>_<span class="keyword1">⇖</span>›</span> <span class="main">[</span>111<span class="main">,</span>111<span class="main">]</span> 110<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">k</span></span></span></sup><span class="hidden">⇖</span> <span class="main">=</span> snd <span class="main">(</span><span class="main">(</span>step<span class="main">^^</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span>entry<span class="main">,</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A predicate asserting that a sequence of nodes is a valid program path according to the
control flow graph.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_path</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free">is_path</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">n</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> edges<span class="main">)</span>›</span></span> 
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Well-formed Programs›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:wf}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following assumptions define our notion of valid programs.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> IFC <span class="main">=</span> IFC_def <span class="quoted"><span class="quoted">‹<span class="free">prob</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">prob</span><span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'n</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">)</span> ifc_problem›</span></span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> ret_is_node<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹return <span class="main">∈</span> nodes›</span></span>
<span class="keyword2"><span class="keyword">and</span></span> entry_is_node<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹entry <span class="main">∈</span> nodes›</span></span>
<span class="keyword2"><span class="keyword">and</span></span> writes<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">v</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="bound">v</span> <span class="main">≠</span> sem <span class="bound">n</span> <span class="bound">σ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">v</span> <span class="main">∈</span> writes <span class="bound">n</span>›</span></span>
<span class="keyword2"><span class="keyword">and</span></span> writes_return<span class="main">:</span> <span class="quoted"><span class="quoted">‹writes return <span class="main">=</span> <span class="main">{}</span>›</span></span>
<span class="keyword2"><span class="keyword">and</span></span> uses_writes<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> reads <span class="bound">n</span><span class="main">.</span> <span class="bound">σ</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">σ'</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> writes <span class="bound">n</span><span class="main">.</span> sem <span class="bound">n</span> <span class="bound">σ</span> <span class="bound">v</span> <span class="main">=</span> sem <span class="bound">n</span> <span class="bound">σ'</span> <span class="bound">v</span>›</span></span>
<span class="keyword2"><span class="keyword">and</span></span> uses_suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> reads <span class="bound">n</span><span class="main">.</span> <span class="bound">σ</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">σ'</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span> suc <span class="bound">n</span> <span class="bound">σ</span> <span class="main">=</span> suc <span class="bound">n</span> <span class="bound">σ'</span>›</span></span>
<span class="keyword2"><span class="keyword">and</span></span> uses_att<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">f</span> <span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> att <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">f</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> reads <span class="bound">n</span><span class="main">.</span> <span class="bound">σ</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">σ'</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">σ</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">σ'</span>›</span></span>
<span class="keyword2"><span class="keyword">and</span></span> edges_complete<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">m</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span>suc <span class="bound">m</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∈</span> edges›</span></span>
<span class="keyword2"><span class="keyword">and</span></span> edges_return <span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>return<span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> edges <span class="main">⟹</span> <span class="bound">x</span> <span class="main">=</span> return ›</span></span>
<span class="keyword2"><span class="keyword">and</span></span> edges_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">‹edges <span class="main">⊆</span> nodes <span class="main">×</span> nodes›</span></span>    
<span class="keyword2"><span class="keyword">and</span></span> reaching_ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">π</span> <span class="bound">n</span><span class="main">.</span> is_path <span class="bound">π</span> <span class="main">∧</span> <span class="bound">π</span> <span class="main">0</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">π</span> <span class="bound">n</span> <span class="main">=</span> return›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Security›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:sec}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define our notion of security, which corresponds to what Bohannon et al.~\cite{Bohannon:2009:RN:1653662.1653673} 
refer to as indistinguishable security.  In order to do so we require notions of observations made
by the attacker, termination and equivalence of input states.›</span></span>

<span class="keyword1"><span class="command">context</span></span> IFC_def
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Observations›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:obs}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The observation made at a given index within an execution.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">obsp</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free">obsp</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> att<span class="main">(</span>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">of</span> Some <span class="bound">f</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">f</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">k</span></span></span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> None<span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The indices within a path where an observation is made.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">obs_ids</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'n</span><span class="main">)</span> <span class="main">⇒</span> nat set›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free">obs_ids</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> att <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">k</span><span class="main">)</span> <span class="main">≠</span> None<span class="main">}</span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A predicate relating an observable index to the number of observations made before.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_kth_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'n</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool›</span></span><span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free">is_kth_obs</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span>card <span class="main">(</span>obs_ids <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> att <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">≠</span>  None<span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The final sequence of observations made for an execution.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">obs</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free">obs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> is_kth_obs <span class="main">(</span>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">then</span> obsp <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">i</span><span class="main">.</span> is_kth_obs <span class="main">(</span>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Comparability of observations.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">obs_prefix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'obs</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'obs</span> option<span class="main">)</span> <span class="main">⇒</span> bool›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">‹<span class="keyword1">≲</span>›</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">≲</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">i</span> <span class="main">≠</span> None <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">i</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">obs_comp</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">‹<span class="keyword1">≈</span>›</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≲</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≲</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Low equivalence of input states›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">restrict</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">‹<span class="keyword1">↾</span>›</span> 100 <span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">↾</span></span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n</span> <span class="keyword1">else</span> undefined<span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two input states are low equivalent if they coincide on the non high variables.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">loweq</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">‹<span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span>›</span> 50<span class="main">)</span> 
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">↾</span><span class="main">(</span><span class="main">-</span>hvars<span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">↾</span><span class="main">(</span><span class="main">-</span>hvars<span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Termination›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An execution terminates iff it reaches the terminal node at any point.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">terminates</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free">terminates</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> path <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">=</span> return›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Security Property›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The fixed program is secure if and only if for all pairs of low equivalent inputs the observation
sequences are comparable and if the execution for an input state terminates then the observation sequence 
is not missing any observations.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">secure</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free">secure</span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="bound">σ</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">σ'</span> <span class="main">⟶</span> <span class="main">(</span>obs <span class="bound">σ</span> <span class="main">≈</span> obs <span class="bound">σ'</span> <span class="main">∧</span> <span class="main">(</span>terminates <span class="bound">σ</span> <span class="main">⟶</span> obs <span class="bound">σ'</span> <span class="main">≲</span> obs <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>›</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Characterisation of Information Flows›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now define our characterisation of information flows which tracks data and control dependencies 
within executions. To do so we first require some additional concepts.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Post Dominance›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We utilise the post dominance relation in order to define control dependence.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The basic post dominance relation.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_pd</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">‹<span class="keyword1">pd→</span>›</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1"><span class="free">pd→</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> nodes <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">π</span> <span class="bound">n</span><span class="main">.</span> is_path <span class="bound">π</span> <span class="main">∧</span> <span class="bound">π</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="bound">π</span> <span class="bound">n</span> <span class="main">=</span> return <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="bound">n</span><span class="main">.</span> <span class="bound">π</span> <span class="bound">k</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The immediate post dominance relation.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ipd</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">‹<span class="keyword1">ipd→</span>›</span> 50<span class="main">)</span><span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1"><span class="free">ipd→</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">pd→</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span><span class="main">≠</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">pd→</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟶</span> <span class="bound">z</span> <span class="keyword1">pd→</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ipd</span> <span class="keyword2"><span class="keyword">where</span></span> 
<span class="quoted"><span class="quoted">‹<span class="free">ipd</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">ipd→</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The post dominance tree.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pdt</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free">pdt</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">≠</span><span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="keyword1">pd→</span> <span class="bound">x</span><span class="main">}</span>›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Control Dependence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An index on an execution path is control dependent upon another if the path does not visit
the immediate post domiator of the node reached by the smaller index.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_cdi</span> <span class="main">(</span><span class="quoted">‹_ <span class="keyword1">cd⇗</span>_<span class="keyword1">⇖→</span> _›</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">,</span>51<span class="main">]</span>50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">i</span></span></span> cd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⟷</span> is_path <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≠</span> return <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">j</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span>›</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The largest control dependency of an index is the immediate control dependency.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_icdi</span> <span class="main">(</span><span class="quoted">‹_ <span class="keyword1">icd⇗</span>_<span class="keyword1">⇖→</span> _›</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">,</span>51<span class="main">]</span>50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">n</span></span></span> icd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="main">⟷</span> is_path <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> cd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">&lt;..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">.</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> cd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span></sup><span class="hidden">⇖</span>→ <span class="bound">m</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the definition of the control slice, which we will define next, we require the uniqueness 
of the immediate control dependency.›</span></span>

<span class="keyword1" id="IFC-icd_uniq"><span class="command">lemma</span></span> icd_uniq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">m</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹ <span class="free">m</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">n'</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="free">n'</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">n'</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹ <span class="free">m</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">n'</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span><span class="main">&lt;</span><span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">m</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linorder_neqE_nat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Control Slice›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We utilise the control slice, that is the sequence of nodes visited by the control dependencies 
of an index, to match indices between executions.›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">cs</span><span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'n</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'n</span> list›</span></span> <span class="main">(</span><span class="quoted">‹<span class="keyword1">cs⇗</span>_<span class="keyword1">⇖</span> _›</span> <span class="main">[</span>51<span class="main">,</span>70<span class="main">]</span> 71<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> icd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span></sup><span class="hidden">⇖</span>→ <span class="bound">m</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">cs</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">m</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> icd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span></sup><span class="hidden">⇖</span>→ <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">)</span>›</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>  
<span class="keyword1"><span class="command">termination</span></span> <span class="quoted"><span class="quoted">‹cs›</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹wf <span class="main">(</span>measure snd<span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="skolem">n</span>  
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">==</span> <span class="main">(</span>The <span class="main">(</span>is_icdi <span class="skolem">n</span> <span class="skolem">π</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹Ex <span class="main">(</span>is_icdi <span class="skolem">n</span> <span class="skolem">π</span><span class="main">)</span>›</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> m_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> icd_uniq theI'<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="skolem">π</span><span class="main">,</span> The <span class="main">(</span>is_icdi <span class="skolem">n</span> <span class="skolem">π</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">π</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> measure snd›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_measure m_def snd_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">cs_less</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">‹<span class="keyword1">≺</span>›</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟹</span> take <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main"><span class="free">≺</span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>›</span></span>     

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cs_select</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">‹<span class="keyword1">¡</span>›</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">¡</span></span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">k</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span></sup><span class="hidden">⇖</span> <span class="bound">k</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Data Dependence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Data dependence is defined straight forward. An index is data dependent upon another, 
if the index reads a variable written by the earlier index and the variable in question has not 
been written by any index in between.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ddi</span> <span class="main">(</span><span class="quoted">‹_ <span class="keyword1">dd⇗</span>_<span class="keyword1">,</span>_<span class="keyword1">⇖→</span> _›</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">,</span>51<span class="main">,</span>51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">n</span></span></span> dd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">v</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⟷</span> is_path <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> reads <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>writes <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">&lt;..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∉</span> writes <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>›</span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Characterisation via Critical Paths›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:char-cp}›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹With the above we define the set of critical paths which as we will prove characterise the matching
points in executions where diverging data is read.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">cp</span> <span class="keyword2"><span class="keyword">where</span></span>

<span class="comment1">― ‹Any pair of low equivalent input states and indices where a diverging high variable is first
read is critical.›</span>

<span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">;</span> 
  cs<span class="hidden">⇗</span><sup>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free"><span class="bound"><span class="entity">σ'</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">;</span> 
  <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">∈</span> reads<span class="main">(</span>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">;</span> 
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">n</span></span></span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">≠</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">n'</span></span></span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">;</span> 
  <span class="main">∀</span> <span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">∉</span>writes<span class="main">(</span>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">k</span><span class="main">)</span><span class="main">;</span> 
  <span class="main">∀</span> <span class="bound"><span class="bound">k'</span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">∉</span>writes<span class="main">(</span>path <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="bound">k'</span><span class="main">)</span>
 <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">cp</span>›</span></span> <span class="main">|</span>

<span class="comment1">― ‹If from a pair of critical indices in two executions there exist data dependencies from both
indices to a pair of matching indices where the variable diverges, the later pair of indices is critical.›</span>

<span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">cp</span><span class="main">;</span> 
  <span class="free"><span class="bound"><span class="entity">n</span></span></span> dd<span class="hidden">⇗</span><sup>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
  <span class="free"><span class="bound"><span class="entity">n'</span></span></span> dd<span class="hidden">⇗</span><sup>path <span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">;</span> 
  cs<span class="hidden">⇗</span><sup>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free"><span class="bound"><span class="entity">σ'</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">;</span> 
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">n</span></span></span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≠</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">n'</span></span></span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>
 <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">cp</span>›</span></span> <span class="main">|</span>

<span class="comment1">― ‹If from a pair of critical indices the executions take different branches and one of the critical 
indices is a control dependency of an index that is data dependency of a matched index where diverging 
data is read and the variable in question is not written by the other execution after the executions
first reached matching indices again, then the later matching pair of indices is critical.›</span>

<span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">cp</span><span class="main">;</span> 
  <span class="free"><span class="bound"><span class="entity">n</span></span></span> dd<span class="hidden">⇗</span><sup>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span> 
  <span class="free"><span class="bound"><span class="entity">l</span></span></span> cd<span class="hidden">⇗</span><sup>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span> 
  cs<span class="hidden">⇗</span><sup>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free"><span class="bound"><span class="entity">σ'</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">;</span> 
  path <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">≠</span> path <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span><span class="main">;</span> 
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">n</span></span></span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≠</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">n'</span></span></span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span> 
  <span class="main">∀</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free"><span class="bound"><span class="entity">σ'</span></span></span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">∉</span>writes <span class="main">(</span>path <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="bound">j'</span><span class="main">)</span>
 <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">cp</span>›</span></span> <span class="main">|</span> 

<span class="comment1">― ‹The relation is symmetric.›</span>

<span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">cp</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">cp</span>›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Based on the set of critical paths, the critical observable paths are those that either directly 
reach observable nodes or are diverging control dependencies of an observable index.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">cop</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp<span class="main">;</span>
  path <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> dom att
 <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">cop</span>›</span></span> <span class="main">|</span>

<span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp<span class="main">;</span> 
  <span class="free"><span class="bound"><span class="entity">n</span></span></span> cd<span class="hidden">⇗</span><sup>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span> 
  path <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">≠</span> path <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span><span class="main">;</span> 
  path <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> dom att
 <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">cop</span>›</span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Approximation via Single Critical Paths›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:char-scp}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For applications we also define a single execution approximation.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_dcdi_via</span> <span class="main">(</span><span class="quoted">‹_ <span class="keyword1">dcd⇗</span>_<span class="keyword1">,</span>_<span class="keyword1">⇖→</span> _ <span class="keyword1">via</span> _ _›</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">,</span>51<span class="main">,</span>51<span class="main">,</span>51<span class="main">,</span>51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">n</span></span></span> dcd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">v</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1"><span class="free">via</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> <span class="main">(</span>is_path <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">l'</span> <span class="bound">n'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π'</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">∧</span> cs<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π'</span></span></span></sup><span class="hidden">⇖</span> <span class="bound">n'</span> <span class="main">∧</span> <span class="bound">n'</span> dd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span></sup><span class="hidden">⇖</span>→ <span class="bound">l'</span> <span class="main">∧</span> <span class="bound">l'</span> cd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π'</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">∉</span> writes<span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">scp</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">∈</span> hvars<span class="main">;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">∈</span> reads <span class="main">(</span>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">∉</span> writes<span class="main">(</span>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>path <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">scp</span>›</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">scp</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> cd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">scp</span>›</span></span><span class="main">|</span>
<span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">scp</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> dd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">scp</span>›</span></span><span class="main">|</span>
<span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">scp</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">scp</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> dcd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">via</span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">scp</span>›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">scop</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∈</span> scp<span class="main">;</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> dom att<span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">scop</span>›</span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Further Definitions›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following concepts are utilised by the proofs.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">contradicts</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">‹<span class="keyword1">𝔠</span>›</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="main">⟦</span>cs<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π'</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="main">≺</span> cs<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">=</span> path <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">;</span>  <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="main">=</span> path <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>Suc <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">¡</span>cs<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π'</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">𝔠</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>›</span></span><span class="main">|</span>
<span class="quoted"><span class="quoted">‹<span class="main">⟦</span>cs<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π'</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">=</span> path <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">;</span>  <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="main">=</span> path <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">k</span></span></span></sup><span class="hidden">⇖</span> <span class="main">↾</span> <span class="main">(</span>reads <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">k'</span></span></span></sup><span class="hidden">⇖</span> <span class="main">↾</span> <span class="main">(</span>reads <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">𝔠</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">path_shift</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">‹<span class="keyword1">«</span>›</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">+</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>›</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">path_append</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'n</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'n</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'n</span><span class="main">)</span>›</span></span> <span class="main">(</span><span class="quoted">‹_ <span class="keyword1">@⇗</span>_<span class="keyword1">⇖</span> _›</span> <span class="main">[</span>0<span class="main">,</span>0<span class="main">,</span>999<span class="main">]</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">π</span></span></span> @<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">m</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span><span class="main">(</span><span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">n</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="main">(</span><span class="bound">n</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq_up_to</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'n</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'n</span><span class="main">)</span> <span class="main">⇒</span> bool›</span></span> <span class="main">(</span><span class="quoted">‹_ <span class="keyword1">=⇘</span>_<span class="keyword1">⇙</span> _›</span> <span class="main">[</span>55<span class="main">,</span>55<span class="main">,</span>55<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">π</span></span></span> =<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">k</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="bound">i</span><span class="main">)</span>›</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* End of locale IFC_def *)</span>




<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Proofs›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:proofs}›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous Facts›</span></span>

<span class="keyword1" id="IFC-option_neq_cases"><span class="command">lemma</span></span> option_neq_cases<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>none1<span class="main">)</span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> None›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">=</span> Some <span class="free">a</span>›</span></span> <span class="main">|</span> <span class="main">(</span>none2<span class="main">)</span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> Some <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">=</span> None›</span></span> <span class="main">|</span> <span class="main">(</span>some<span class="main">)</span> <span class="free">a</span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> Some <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">=</span> Some <span class="free">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemmas</span></span> nat_sym_cases<span class="main">[</span><span class="operator">case_names</span> less sym eq<span class="main">]</span> <span class="main">=</span> linorder_less_wlog

<span class="keyword1" id="IFC-mod_bound_instance"><span class="command">lemma</span></span> mod_bound_instance<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">i</span><span class="main">::</span>nat<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">j'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j'</span> <span class="keyword1">mod</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span>›</span></span>  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> Suc <span class="free">k</span> <span class="main">*</span> <span class="free">i</span> <span class="main">+</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms less_imp_Suc_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>Suc <span class="free">k</span> <span class="main">*</span> <span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms mod_less mod_mult_self3<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-list_neq_prefix_cases"><span class="command">lemma</span></span> list_neq_prefix_cases<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ls</span> <span class="main">≠</span> <span class="free">ls'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ls</span> <span class="main">≠</span> Nil›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ls'</span> <span class="main">≠</span> Nil›</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>diverge<span class="main">)</span> <span class="free">xs</span> <span class="free">x</span> <span class="free">x'</span> <span class="free">ys</span> <span class="free">ys'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ls</span> <span class="main">=</span> <span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">@</span><span class="free">ys</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ls'</span> <span class="main">=</span> <span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x'</span><span class="main">]</span><span class="main">@</span><span class="free">ys'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">x'</span>›</span></span> <span class="main">|</span>
   <span class="main">(</span>prefix1<span class="main">)</span> <span class="free">xs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ls</span> <span class="main">=</span> <span class="free">ls'</span><span class="main">@</span><span class="free">xs</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">≠</span> Nil›</span></span> <span class="main">|</span>
   <span class="main">(</span>prefix2<span class="main">)</span> <span class="free">xs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ls</span><span class="main">@</span><span class="free">xs</span> <span class="main">=</span> <span class="free">ls'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">≠</span> Nil›</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">‹length <span class="free">ls</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ls</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ls'</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">ls</span> <span class="skolem">ls'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="skolem"><span class="skolem">zs'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  lz<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ls</span> <span class="main">=</span> <span class="skolem">z</span><span class="main">#</span><span class="skolem">zs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ls'</span> <span class="main">=</span> <span class="skolem">z'</span><span class="main">#</span><span class="skolem">zs'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust less<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> zz<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">z'</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> zsz<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">≠</span> <span class="skolem">zs'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>5<span class="main">)</span> lz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> lenz<span class="main">:</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">zs</span> <span class="main">&lt;</span> length <span class="skolem">ls</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">=</span> Nil›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> zs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">=</span> Nil›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs'</span> <span class="main">≠</span> Nil›</span></span> <span class="keyword1"><span class="command">using</span></span> zsz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ls</span><span class="main">@</span><span class="skolem">zs'</span> <span class="main">=</span> <span class="skolem">ls'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> zs lz zz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> zs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">≠</span> Nil›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs'</span> <span class="main">=</span> Nil›</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs'</span> <span class="main">=</span> Nil›</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ls</span> <span class="main">=</span> <span class="skolem">ls'</span><span class="main">@</span><span class="skolem">zs</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lz zz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> zs less<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> zs'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs'</span> <span class="main">≠</span> Nil›</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">x</span> <span class="skolem">ys</span> <span class="skolem">x'</span> <span class="skolem">ys'</span> 
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs'</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> xx<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x'</span>›</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ls</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">z</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ls'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">z</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lz zz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>2<span class="main">)</span> xx <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> 
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">zs'</span> <span class="main">@</span> <span class="skolem">xs</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ls</span> <span class="main">=</span> <span class="skolem">ls'</span> <span class="main">@</span> <span class="skolem">xs</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lz zz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> xs less<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> ** <span class="main">=</span> this
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> 
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span><span class="main">@</span><span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">zs'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ls</span><span class="main">@</span><span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ls'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lz zz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> xs less<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> *** <span class="main">=</span> this
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">ys</span> <span class="bound">x'</span> <span class="bound">ys'</span><span class="main">.</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="skolem">zs'</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x'</span><span class="main">]</span> <span class="main">@</span> <span class="bound">ys'</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">⟹</span> 
              <span class="main">(</span><span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">zs'</span> <span class="main">@</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">⟹</span> 
              <span class="main">(</span><span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="bound">xs</span> <span class="main">=</span> <span class="skolem">zs'</span> <span class="main">⟹</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">thesis</span>›</span></span> 
        <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> lenz _ _ _ zsz zs zs' <span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * ** *** <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">≠</span> <span class="skolem">z'</span>›</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ls</span> <span class="main">=</span> <span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">@</span><span class="skolem">zs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ls'</span> <span class="main">=</span> <span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="skolem">z'</span><span class="main">]</span><span class="main">@</span><span class="skolem">zs'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-three_cases"><span class="command">lemma</span></span> three_cases<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∨</span> <span class="free">C</span>›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span>›</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">B</span>›</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">C</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-insort_greater"><span class="command">lemma</span></span> insort_greater<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">ls</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">⟹</span> insort <span class="free">y</span> <span class="free">ls</span> <span class="main">=</span> <span class="free">ls</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">ls</span>›</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1" id="IFC-insort_append_first"><span class="command">lemma</span></span> insort_append_first<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="free">x</span> <span class="main">≤</span> <span class="bound">y</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹insort <span class="free">x</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">=</span> insort <span class="free">x</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span>›</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span> insort_is_Cons<span class="main">)</span>

<span class="keyword1" id="IFC-sorted_list_of_set_append"><span class="command">lemma</span></span> sorted_list_of_set_append<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">ys</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹sorted_list_of_set <span class="main">(</span><span class="free">xs</span> <span class="main">∪</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> sorted_list_of_set <span class="free">xs</span> <span class="main">@</span> <span class="main">(</span>sorted_list_of_set <span class="free">ys</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> iv<span class="main">:</span> <span class="quoted"><span class="quoted">‹sorted_list_of_set <span class="main">(</span><span class="skolem">xs</span> <span class="main">∪</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> sorted_list_of_set <span class="skolem">xs</span> <span class="main">@</span> sorted_list_of_set <span class="free">ys</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>sorted_list_of_set <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="bound">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> sorted_list_of_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹sorted_list_of_set <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">xs</span> <span class="main">∪</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">∪</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> insort <span class="skolem">x</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="skolem">xs</span> <span class="main">∪</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finite_Un insert.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insert.prems insertI1 less_irrefl sorted_list_of_set.insert<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> insort <span class="skolem">x</span> <span class="main">(</span>sorted_list_of_set <span class="skolem">xs</span> <span class="main">@</span> sorted_list_of_set <span class="free">ys</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> iv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> insort <span class="skolem">x</span> <span class="main">(</span>sorted_list_of_set <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> sorted_list_of_set <span class="free">ys</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le insort_append_first less_le_not_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> sorted_list_of_set <span class="free">ys</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> sorted_list_of_set_insert<span class="main">[</span><span class="operator">OF</span> insert<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span>›</span></span><span class="main">]</span> insert<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-filter_insort"><span class="command">lemma</span></span> filter_insort<span class="main">:</span> <span class="quoted"><span class="quoted">‹sorted <span class="free">xs</span> <span class="main">⟹</span> filter <span class="free">P</span> <span class="main">(</span>insort <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="free">x</span> <span class="keyword1">then</span> insort <span class="free">x</span> <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="keyword1">else</span> filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> filter_insort filter_insort_triv map_ident<span class="main">)</span> 

<span class="keyword1" id="IFC-filter_sorted_list_of_set"><span class="command">lemma</span></span> filter_sorted_list_of_set<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">xs</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹filter <span class="free">P</span> <span class="main">(</span>sorted_list_of_set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> sorted_list_of_set <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>  
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span>sorted_list_of_set <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹sorted <span class="main">(</span>sorted_list_of_set <span class="skolem">xs</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span>sorted_list_of_set <span class="skolem">xs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="skolem">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">P</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="skolem">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> filter_insort<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span>›</span></span><span class="main">]</span> sorted_list_of_set_insert<span class="main">[</span><span class="operator">OF</span> insert<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span>›</span></span><span class="main">]</span> insert<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> ** ***  
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> <span class="quoted">"*"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> List.finite_set distinct_filter distinct_insort distinct_sorted_list_of_set set_filter sorted_list_of_set.insert<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-unbounded_nat_set_infinite"><span class="command">lemma</span></span> unbounded_nat_set_infinite<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="main">(</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> finite <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_nat_set_iff_bounded_le not_less_eq_eq<span class="main">)</span>

<span class="keyword1" id="IFC-infinite_ascending"><span class="command">lemma</span></span> infinite_ascending<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> finite <span class="main">(</span><span class="free">A</span><span class="main">::</span>nat set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">f</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹range <span class="free">f</span> <span class="main">=</span> <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>›</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?a0</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?a0</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeastI empty_iff finite.emptyI nf set_eq_iff<span class="main">)</span>      
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="var">?a0</span> <span class="main">≤</span> <span class="bound">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Least_le<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="var">?a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> card<span class="main">:</span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> nf'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> finite <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{..</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?b</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">LEAST</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{..</span><span class="skolem">a</span><span class="main">}</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> bin<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?b</span> <span class="main">∈</span> <span class="free">A</span><span class="main">-</span><span class="main">{..</span><span class="skolem">a</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeastI empty_iff finite.emptyI nf' set_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">A</span><span class="main">-</span><span class="main">{..</span><span class="skolem">a</span><span class="main">}</span> <span class="main">⟹</span> <span class="var">?b</span> <span class="main">≤</span> <span class="bound">c</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Least_le<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">&lt;</span> <span class="var">?b</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> bin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">c</span> <span class="main">&lt;</span> <span class="var">?b</span> <span class="main">⟹</span> <span class="bound">c</span> <span class="main">≤</span> <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> le <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="var">?b</span><span class="main">}</span> <span class="main">=</span> insert <span class="skolem">a</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> bin ab aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="var">?b</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> card <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems bin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">thesis</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="bound">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">thesis</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> ex <span class="main">=</span> this
    
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>›</span></span>  <span class="keyword1"><span class="command">using</span></span> ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> ina<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> card<span class="main">:</span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="var">?f</span> <span class="skolem">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> a<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">i</span>›</span></span>  <span class="keyword1"><span class="command">using</span></span> ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> inab<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cardb<span class="main">:</span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="var">?f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> b<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?f</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="var">?f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="var">?f</span> <span class="skolem">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="var">?f</span> <span class="skolem">i</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹card<span class="main">(</span><span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="var">?f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="var">?f</span> <span class="skolem">i</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> card_mono<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> card cardb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">note</span></span> this ina
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> b <span class="main">=</span> this
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹range <span class="var">?f</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> ina<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="var">?i</span>›</span></span>  <span class="keyword1"><span class="command">using</span></span> ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> inab<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="var">?i</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cardb<span class="main">:</span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="var">?f</span> <span class="var">?i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="var">?i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="var">?i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> b<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="var">?i</span> <span class="main">≤</span> <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span><span class="main">{..&lt;</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="var">?i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span>›</span></span><span class="main">]</span> ina <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="var">?f</span> <span class="var">?i</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="var">?f</span> <span class="var">?i</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="var">?i</span> <span class="main">&lt;</span> <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="var">?i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">a</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> inab <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="var">?f</span> <span class="var">?i</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">a</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="var">?f</span> <span class="var">?i</span><span class="main">}</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">a</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cardb card_subset_eq<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>      
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> range <span class="var">?f</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊆</span> range <span class="var">?f</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹range <span class="var">?f</span> <span class="main">=</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-mono_ge_id"><span class="command">lemma</span></span> mono_ge_id<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">i</span>›</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span>›</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_le not_less_eq_eq order_trans<span class="main">)</span>

<span class="keyword1" id="IFC-insort_map_mono"><span class="command">lemma</span></span> insort_map_mono<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">n</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">m</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹map <span class="free">f</span> <span class="main">(</span>insort <span class="free">n</span> <span class="free">ns</span><span class="main">)</span> <span class="main">=</span> insort <span class="main">(</span><span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">ns</span>›</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> not_less not_less_iff_gr_or_eq mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> antisym_conv1 less_imp_le mono<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> mono not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mono not_less<span class="main">)</span>  

<span class="keyword1" id="IFC-sorted_list_of_set_map_mono"><span class="command">lemma</span></span> sorted_list_of_set_map_mono<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">n</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">m</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹map <span class="free">f</span> <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">‹sorted_list_of_set <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> insort <span class="skolem">x</span> <span class="main">(</span>sorted_list_of_set <span class="skolem">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> insert sorted_list_of_set.insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">`</span> insert <span class="skolem">x</span> <span class="skolem">A</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="free">f</span><span class="main">`</span><span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>2<span class="main">)</span> mono <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mono neq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹sorted_list_of_set <span class="main">(</span><span class="free">f</span> <span class="main">`</span> insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> insort <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="skolem">A</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>1<span class="main">)</span> sorted_list_of_set.insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> insort <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>sorted_list_of_set <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> insert.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>insort <span class="skolem">x</span> <span class="main">(</span>sorted_list_of_set <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> insort_map_mono<span class="main">[</span><span class="operator">OF</span> mono<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹map <span class="free">f</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span><span class="free">f</span> <span class="main">`</span> insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-GreatestIB"><span class="command">lemma</span></span> GreatestIB<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹nat›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span>›</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> GreatestBI<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> GreatestB<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> GreatestI_ex_nat<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> GreatestI_ex_nat<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-GreatestB_le"><span class="command">lemma</span></span> GreatestB_le<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹nat›</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">≤</span><span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">x</span>›</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span><span class="main">&lt;</span>Suc <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Greatest_le_nat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-LeastBI_ex"><span class="command">lemma</span></span> LeastBI_ex<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound"><span class="bound">k</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">::</span><span class="tfree">'c</span><span class="main">::</span>wellorder<span class="main">.</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> k <span class="keyword1"><span class="command">..</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>     
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span>›</span></span><span class="main">]</span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-allB_atLeastLessThan_lower"><span class="command">lemma</span></span> allB_atLeastLessThan_lower<span class="main">:</span>  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">i</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">∈</span><span class="main">{</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Facts about Paths›</span></span>

<span class="keyword1"><span class="command">context</span></span> IFC
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="IFC-path0"><span class="command">lemma</span></span> path0<span class="main">:</span> <span class="quoted"><span class="quoted">‹path <span class="free">σ</span> <span class="main">0</span> <span class="main">=</span> entry›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> path_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-path_in_nodes"><span class="command">lemma</span></span> path_in_nodes<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹path <span class="free">σ</span> <span class="free">k</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">(</span>path <span class="free">σ</span> <span class="skolem">k</span><span class="main">,</span> suc <span class="main">(</span>path <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">σ'</span><span class="main">)</span> <span class="main">∈</span> edges›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>path <span class="free">σ</span> <span class="skolem">k</span><span class="main">,</span> path <span class="free">σ</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> edges›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> path_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> suc_def comp_apply funpow.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> edges_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_def<span class="main">)</span>

<span class="keyword1" id="IFC-path_is_path"><span class="command">lemma</span></span> path_is_path<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span>path <span class="free">σ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_path_def path_def <span class="keyword1"><span class="command">using</span></span> step_suc_sem <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_def suc_def edges_complete path_in_nodes prod.collapse<span class="main">)</span>

<span class="keyword1" id="IFC-term_path_stable"><span class="command">lemma</span></span> term_path_stable<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">=</span> return›</span></span> 
<span class="keyword1"><span class="command">using</span></span> le <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">≤</span><span class="skolem">j</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">j</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>return<span class="main">,</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> edges›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_path_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> edges_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="IFC-path_path_shift"><span class="command">lemma</span></span> path_path_shift<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">m</span><span class="main">)</span>›</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_path_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="IFC-path_cons"><span class="command">lemma</span></span> path_cons<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">m</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">m</span></sup><span class="hidden">⇖</span> <span class="free">π'</span><span class="main">)</span>›</span></span> 
<span class="keyword1"><span class="command">unfolding</span></span> is_path_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">m</span></sup><span class="hidden">⇖</span> <span class="free">π'</span><span class="main">)</span> <span class="skolem">n</span><span class="main">,</span> <span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">m</span></sup><span class="hidden">⇖</span>  <span class="free">π'</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> edges›</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_path_def path_append_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span> Suc_diff_Suc diff_Suc_Suc less_SucI<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span>  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">m</span></sup><span class="hidden">⇖</span>  <span class="free">π'</span><span class="main">)</span> <span class="skolem">n</span><span class="main">,</span> <span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">m</span></sup><span class="hidden">⇖</span>  <span class="free">π'</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> edges›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> <span class="free">m</span>›</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_path_def path_append_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≠</span> <span class="free">m</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="main">≤</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">≤</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_path_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-is_path_loop"><span class="command">lemma</span></span> is_path_loop<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> <span class="free">π</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="free">π</span> <span class="main">(</span><span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_path_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">i</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">i</span> <span class="main">=</span> Suc <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_Suc neq0_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">i</span><span class="main">)</span><span class="main">,</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> edges›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_path_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">i</span><span class="main">)</span><span class="main">,</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> edges›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">i</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Zero_neq_Suc diff_Suc_1 mod_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">(</span><span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">i</span><span class="main">)</span><span class="main">,</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> edges›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_path_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mod_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-path_nodes"><span class="command">lemma</span></span> path_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span> <span class="main">⟹</span> <span class="free">π</span> <span class="free">k</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_path_def <span class="keyword1"><span class="command">using</span></span> edges_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 

<span class="keyword1" id="IFC-direct_path_return'"><span class="command">lemma</span></span> direct_path_return'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span> ›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π'</span> <span class="free">n'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">n'</span> <span class="main">=</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span> <span class="main">0</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">x</span>›</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span> <span class="skolem">π</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">n'</span> <span class="bound">π'</span><span class="main">.</span> <span class="bound">n'</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">⟹</span> is_path <span class="bound">π'</span> <span class="main">⟹</span> <span class="bound">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="bound">π'</span> <span class="bound">n'</span> <span class="main">=</span> return <span class="main">⟹</span> <span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">x</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">&lt;</span><span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linorder_neqE_nat term_path_stable less_imp_le<span class="main">)</span>    
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_path_shift<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">-</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">&lt;</span><span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-direct_path_return"><span class="command">lemma</span></span> direct_path_return<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> nodes›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> return›</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π</span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span> <span class="main">0</span><span class="main">.</span> <span class="free">π</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">x</span>›</span></span>
<span class="keyword1"><span class="command">using</span></span> direct_path_return'<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span>›</span></span><span class="main">]</span> reaching_ret<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="IFC-path_append_eq_up_to"><span class="command">lemma</span></span> path_append_eq_up_to<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">π'</span><span class="main">)</span> =<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="free">π</span>›</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> eq_up_to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-eq_up_to_le"><span class="command">lemma</span></span> eq_up_to_le<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span>  <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="free">π'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eq_up_to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="IFC-eq_up_to_refl"><span class="command">lemma</span></span> eq_up_to_refl<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq_up_to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="IFC-eq_up_to_sym"><span class="command">lemma</span></span> eq_up_to_sym<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> =<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eq_up_to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-eq_up_to_apply"><span class="command">lemma</span></span> eq_up_to_apply<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">=</span> <span class="free">π'</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eq_up_to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-path_swap_ret"><span class="command">lemma</span></span> path_swap_ret<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π'</span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">n</span> <span class="main">=</span> return›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> nd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword1"><span class="command">using</span></span> assms path_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> reaching_ret<span class="main">[</span><span class="operator">OF</span> nd<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_up_to_sym path_append_eq_up_to<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms * path_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-path_suc"><span class="command">lemma</span></span> path_suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹path <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>step <span class="main">(</span>path <span class="free">σ</span> <span class="free">k</span><span class="main">,</span> <span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_def kth_state_def<span class="main">)</span>

<span class="keyword1" id="IFC-kth_state_suc"><span class="command">lemma</span></span> kth_state_suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup>Suc <span class="free">k</span></sup><span class="hidden">⇖</span>  <span class="main">=</span> snd <span class="main">(</span>step <span class="main">(</span>path <span class="free">σ</span> <span class="free">k</span><span class="main">,</span> <span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_def kth_state_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Facts about Post Dominators›</span></span>

<span class="keyword1" id="IFC-pd_trans"><span class="command">lemma</span></span> pd_trans<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="keyword1">pd→</span><span class="free">y</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="keyword1">pd→</span><span class="free">x</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">n</span> <span class="main">=</span> return›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path_path_shift<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="free">z</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">-</span><span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span><span class="main">+</span><span class="skolem">k'</span><span class="main">≤</span><span class="skolem">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span> <span class="skolem">k'</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">z</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-pd_path"><span class="command">lemma</span></span> pd_path<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π</span> <span class="free">n</span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span>   
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">using</span></span> reaching_ret<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="IFC-pd_antisym"><span class="command">lemma</span></span> pd_antisym<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> xpdy<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="keyword1">pd→</span> <span class="free">y</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ypdx<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">n</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> pd_path<span class="main">[</span><span class="operator">OF</span> ypdx<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> kex<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ypdx <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">≤</span><span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">π</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> πk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> kn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k kex <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> GreatestIB<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> kpath<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_path_shift path<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> k0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> πk <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> kreturn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> kn πn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> ky'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound"><span class="bound">k'</span></span><span class="main">≤</span><span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span> <span class="bound">k'</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> xpdy <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>      

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k'</span><span class="main">.</span> <span class="bound">k'</span><span class="main">≤</span><span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span> <span class="bound">k'</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">with</span></span> ky' <span class="keyword1"><span class="command">have</span></span> πk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> kn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> GreatestIB<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> k'path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">«</span><span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kpath <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> path_path_shift<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> k'0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">«</span><span class="skolem">k'</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> πk' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> k'return<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">«</span><span class="skolem">k'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">-</span><span class="skolem">k'</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> kn' kreturn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_shift_def le_add_diff_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> ky''<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound"><span class="bound">k''</span></span><span class="main">≤</span><span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">-</span><span class="skolem">k'</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">«</span><span class="skolem">k'</span><span class="main">)</span> <span class="bound">k''</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ypdx <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k''</span></span> <span class="keyword2"><span class="keyword">where</span></span> k''<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k''</span><span class="main">=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k''</span><span class="main">.</span> <span class="bound">k''</span><span class="main">≤</span><span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">-</span><span class="skolem">k'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">«</span><span class="skolem">k'</span><span class="main">)</span> <span class="bound">k''</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> ky'' <span class="keyword1"><span class="command">have</span></span> πk''<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">«</span><span class="skolem">k'</span><span class="main">)</span> <span class="skolem">k''</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> kn''<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k''</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">-</span><span class="skolem">k'</span><span class="main">)</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> GreatestIB<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_shift_def add.commute add.left_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">+</span><span class="skolem">k''</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kn'' kn' kn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">≤</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> GreatestB_le<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> k0 πk' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-pd_refl"><span class="command">lemma</span></span> pd_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="IFC-pdt_trans_in_pdt"><span class="command">lemma</span></span> pdt_trans_in_pdt<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> pdt<span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> pdt›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pdt_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="keyword1">pd→</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">unfolding</span></span> pdt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pd_trans<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="skolem">y</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> z<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="skolem">z</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">≠</span><span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="keyword1">pd→</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">pd→</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pd_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> pdt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="skolem">z</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-pdt_trancl_pdt"><span class="command">lemma</span></span> pdt_trancl_pdt<span class="main">:</span> <span class="quoted"><span class="quoted">‹pdt<span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> pdt›</span></span> <span class="keyword1"><span class="command">using</span></span> pdt_trans_in_pdt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="IFC-trans_pdt"><span class="command">lemma</span></span> trans_pdt<span class="main">:</span> <span class="quoted"><span class="quoted">‹trans pdt›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pdt_trancl_pdt trans_trancl<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">pdt_inv</span> <span class="main">=</span> pdt<span class="main">¯</span>›</span></span>

<span class="keyword1" id="IFC-wf_pdt_inv"><span class="command">lemma</span></span> wf_pdt_inv<span class="main">:</span> <span class="quoted"><span class="quoted">‹wf <span class="main">(</span>pdt_inv<span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> wf <span class="main">(</span>pdt_inv<span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> pdt<span class="main">¯</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> wf_iff_no_infinite_down_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> pdt›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> pdt›</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">j</span><span class="main">::</span>nat<span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> pdt›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> k<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="skolem">k</span><span class="main">-</span><span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">-</span><span class="main">1</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> sk<span class="main">:</span> <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> k<span class="main">]</span> *<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span><span class="main">-</span><span class="main">1</span>›</span></span><span class="main">,</span><span class="operator">unfolded</span> sk<span class="main">]</span> trans_pdt<span class="main">[</span><span class="operator">unfolded</span> trans_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> ***<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&gt;</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">j</span> <span class="keyword1">pd→</span> <span class="skolem">f</span> <span class="bound">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&gt;</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span>  <span class="skolem">f</span> <span class="bound">j</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pdt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> ****<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="keyword1">pd→</span> <span class="skolem">f</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">0</span> <span class="main">∈</span> nodes›</span></span>  <span class="keyword1"><span class="command">using</span></span> * is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> π<span class="main">:</span><span class="quoted"><span class="quoted">‹is_path <span class="skolem">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">n</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> reaching_ret <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ***<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">0</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> πf<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> π<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le0 not_gr_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹range <span class="skolem">f</span> <span class="main">⊆</span> <span class="skolem">π</span> <span class="main">`</span> <span class="main">{..</span><span class="skolem">n</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> range <span class="skolem">f</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">π</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> πf <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">π</span> <span class="main">`</span> <span class="main">{..</span><span class="skolem">n</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> f<span class="main">:</span><span class="quoted"><span class="quoted">‹finite <span class="main">(</span>range <span class="skolem">f</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> finite_surj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> fi<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> infinite <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">}</span>›</span></span>  <span class="keyword1"><span class="command">using</span></span> pigeonhole_infinite<span class="main">[</span><span class="operator">OF</span> _ f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹infinite <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> fi <span class="keyword1"><span class="command">..</span></span>    
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"***"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bounded_nat_set_is_finite gt_ex mem_Collect_eq nat_neq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-return_pd"><span class="command">lemma</span></span> return_pd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹return <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="IFC-pd_total"><span class="command">lemma</span></span> pd_total<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> xz<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="keyword1">pd→</span> <span class="free">z</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> yz<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="keyword1">pd→</span> <span class="free">z</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="keyword1">pd→</span> <span class="free">y</span> <span class="main">∨</span> <span class="free">y</span> <span class="keyword1">pd→</span><span class="free">x</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">z</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">n</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> xz reaching_ret <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">π</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∨</span> <span class="skolem">π</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">k</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> path π0 πn xz yz <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∨</span> <span class="skolem">π</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> kn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span><span class="main">≤</span><span class="skolem">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∨</span> <span class="skolem">π</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> LeastBI_ex<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">note</span></span> k_le <span class="main">=</span> Least_le<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> kx<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">x</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> k_min<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">k'</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">k'</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="bound">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k_le <span class="keyword1"><span class="command">unfolding</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π'</span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">n'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹nat›</span></span>
      <span class="keyword3"><span class="command">assume</span></span> path'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π'0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π'n'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">=</span> return›</span></span>
      <span class="keyword1"><span class="command">have</span></span> path''<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="skolem">π</span> @<span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path_cons<span class="main">[</span><span class="operator">OF</span> path path'<span class="main">]</span> kx π'0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> π''0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span> @<span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">z</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> π0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> π''n<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span> @<span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">n'</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> π'n' kx π'0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span> @<span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> yz path'' π''0 π''n <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">k'</span>›</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> 
        <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> k_min <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
     <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k' π'0 kx  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">k'</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">ultimately</span></span> 
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound"><span class="bound">k</span></span><span class="main">≤</span> <span class="skolem">n'</span><span class="main">.</span> <span class="skolem">π'</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kx path_nodes path <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">..</span></span>
 <span class="keyword1"><span class="command">next</span></span> <span class="comment1">― ‹This is analogous argument›</span>
   <span class="keyword3"><span class="command">assume</span></span> kx<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="free">x</span>›</span></span>
   <span class="keyword1"><span class="command">hence</span></span> ky<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> πk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> k_min<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">k'</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">k'</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="bound">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k_le <span class="keyword1"><span class="command">unfolding</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π'</span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">n'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹nat›</span></span>
      <span class="keyword3"><span class="command">assume</span></span> path'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π'0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π'n'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">=</span> return›</span></span>
      <span class="keyword1"><span class="command">have</span></span> path''<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="skolem">π</span> @<span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path_cons<span class="main">[</span><span class="operator">OF</span> path path'<span class="main">]</span> ky π'0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> π''0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span> @<span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">z</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> π0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> π''n<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span> @<span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">n'</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> π'n' ky π'0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span> @<span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> xz path'' π''0 π''n <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">k'</span>›</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> 
        <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> k_min <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
     <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k' π'0 ky  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">k'</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">ultimately</span></span> 
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound"><span class="bound">k</span></span><span class="main">≤</span> <span class="skolem">n'</span><span class="main">.</span> <span class="skolem">π'</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="keyword1">pd→</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ky path_nodes path <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1" id="IFC-pds_finite"><span class="command">lemma</span></span> pds_finite<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="bound">y</span> <span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> pdt<span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> nodes›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> π<span class="main">:</span><span class="quoted"><span class="quoted">‹is_path <span class="skolem">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">n</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> reaching_ret <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span> pdt<span class="main">}</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pdt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span> pdt<span class="main">}</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">y</span>›</span></span>  <span class="keyword1"><span class="command">using</span></span> * π is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span> pdt<span class="main">}</span> <span class="main">⊆</span> <span class="skolem">π</span> <span class="main">`</span> <span class="main">{..</span><span class="skolem">n</span><span class="main">}</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> finite_surj <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">x</span><span class="main">∈</span> nodes›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span>pdt<span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pdt_def is_pd_def <span class="keyword1"><span class="command">using</span></span> path_nodes reaching_ret <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-ipd_exists"><span class="command">lemma</span></span> ipd_exists<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> node<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword2"><span class="keyword">and</span></span> not_ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">≠</span>return›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">ipd→</span> <span class="free">x</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span><span class="main">≠</span><span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="keyword1">pd→</span> <span class="free">x</span><span class="main">}</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹return <span class="main">∈</span> <span class="var">?Q</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms return_pd <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>    
  <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span> <span class="var">?Q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="var">?Q</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pds_finite <span class="keyword1"><span class="command">unfolding</span></span> pdt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> tot<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">y</span><span class="main">∈</span><span class="var">?Q</span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">∈</span> <span class="var">?Q</span> <span class="main">⟶</span> <span class="bound">z</span> <span class="keyword1">pd→</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">y</span> <span class="keyword1">pd→</span> <span class="bound">z</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pd_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> ymax<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span><span class="main">∈</span> <span class="var">?Q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">z</span><span class="main">∈</span><span class="var">?Q</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="bound">z</span> <span class="keyword1">pd→</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> fin ** tot <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">F</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">F</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>  
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">F</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span> <span class="skolem">F</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">z</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">z</span> <span class="keyword1">pd→</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">F</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">z</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="bound">z</span> <span class="keyword1">pd→</span> <span class="skolem">y</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> insert a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="keyword1">pd→</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="keyword1">pd→</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>6<span class="main">)</span> a<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="keyword1">pd→</span> <span class="skolem">y</span>›</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">z</span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="bound">z</span> <span class="keyword1">pd→</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> a<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> a<span class="main">(</span>1<span class="main">)</span> insert<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">pd→</span> <span class="skolem">x</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">z</span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="bound">z</span> <span class="keyword1">pd→</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span><span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">F</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="skolem">z</span> <span class="keyword1">pd→</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span><span class="main">∈</span><span class="skolem">F</span>›</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">z</span> <span class="keyword1">pd→</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> a<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="skolem">z</span> <span class="keyword1">pd→</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">pd→</span> <span class="skolem">x</span>›</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="keyword1">pd→</span> <span class="skolem">y</span>›</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="skolem">z</span> <span class="keyword1">pd→</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">pd→</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="keyword1">pd→</span> <span class="skolem">y</span>›</span></span> pd_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span> 
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>    
  <span class="keyword1"><span class="command">hence</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">≠</span><span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">pd→</span> <span class="free">x</span> <span class="main">⟶</span> <span class="bound">z</span> <span class="keyword1">pd→</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> 
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹ <span class="skolem">z</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">∧</span> <span class="skolem">z</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> <span class="var">?Q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">pd→</span> <span class="skolem">z</span> <span class="main">∨</span> <span class="skolem">z</span> <span class="keyword1">pd→</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pd_total ***<span class="main">(</span>1<span class="main">)</span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="keyword1">pd→</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">pd→</span> <span class="skolem">z</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> b ymax pdt_def pd_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="keyword1">pd→</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> *** <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">ipd→</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_ipd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-ipd_unique"><span class="command">lemma</span></span> ipd_unique<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> yipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="keyword1">ipd→</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> y'ipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">y'</span> <span class="keyword1">ipd→</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">=</span> <span class="free">y'</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="keyword1">pd→</span> <span class="free">y'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>  2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">y'</span> <span class="keyword1">pd→</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> yipd y'ipd <span class="keyword1"><span class="command">unfolding</span></span> is_ipd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pd_antisym<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-ipd_is_ipd"><span class="command">lemma</span></span> ipd_is_ipd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">≠</span>return›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="free">x</span> <span class="keyword1">ipd→</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">ipd→</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ipd_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="keyword1">ipd→</span><span class="free">x</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ipd_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ipd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> theI2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-is_ipd_in_pdt"><span class="command">lemma</span></span> is_ipd_in_pdt<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="keyword1">ipd→</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> pdt›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_ipd_def pdt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-ipd_in_pdt"><span class="command">lemma</span></span> ipd_in_pdt<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="free">x</span><span class="main">≠</span>return <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span>ipd <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> pdt›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ipd_is_ipd is_ipd_in_pdt<span class="main">)</span>

<span class="keyword1" id="IFC-no_pd_path"><span class="command">lemma</span></span> no_pd_path<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">y</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π</span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> <span class="free">π</span> <span class="bound">k</span> <span class="main">≠</span> <span class="free">y</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">thesis</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">π</span> <span class="bound">n</span><span class="main">.</span>  is_path <span class="bound">π</span> <span class="main">∧</span> <span class="bound">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">π</span> <span class="bound">n</span> <span class="main">=</span> return <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="bound">n</span> <span class="main">.</span> <span class="bound">π</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-pd_pd_ipd"><span class="command">lemma</span></span> pd_pd_ipd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> nodes›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">≠</span>return›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span><span class="main">≠</span><span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="keyword1">pd→</span> ipd <span class="free">x</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="free">x</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> ipd_is_ipd is_ipd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="keyword1">pd→</span> ipd <span class="free">x</span> <span class="main">∨</span> ipd <span class="free">x</span> <span class="keyword1">pd→</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> pd_total<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹ipd <span class="free">x</span> <span class="keyword1">ipd→</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> ipd_is_ipd<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="free">x</span> <span class="keyword1">pd→</span> <span class="free">y</span>›</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="keyword1">pd→</span> ipd <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_ipd_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-pd_nodes"><span class="command">lemma</span></span> pd_nodes<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="keyword1">pd→</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> pd_node1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword2"><span class="keyword">and</span></span> pd_node2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> nodes›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">using</span></span> reaching_ret <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword1"><span class="command">using</span></span> path_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-pd_ret_is_ret"><span class="command">lemma</span></span> pd_ret_is_ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="keyword1">pd→</span> return <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pd_antisym pd_node1 return_pd<span class="main">)</span>

<span class="keyword1" id="IFC-ret_path_none_pd"><span class="command">lemma</span></span> ret_path_none_pd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> nodes›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">≠</span>return›</span></span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π</span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">¬</span> <span class="free">x</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="bound">i</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="free">thesis</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">π</span> <span class="bound">n</span><span class="main">.</span> <span class="main">⟦</span>is_path <span class="bound">π</span><span class="main">;</span> <span class="bound">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span><span class="main">;</span> <span class="bound">π</span> <span class="bound">n</span> <span class="main">=</span> return<span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="free">x</span> <span class="keyword1">pd→</span> <span class="bound">π</span> <span class="bound">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">n</span> <span class="main">=</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> direct_path_return<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">&gt;</span><span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="keyword1">pd→</span> <span class="skolem">π</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> pd_ret_is_ret assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> term_path_stable ** <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linorder_neqE_nat less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span><span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> **<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">π</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> **<span class="main">(</span>1<span class="main">)</span> path_path_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ***<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> **<span class="main">(</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">&gt;</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-path_pd_ipd0'"><span class="command">lemma</span></span> path_pd_ipd0'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">≠</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">≠</span> <span class="free">π</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="main">0</span>›</span></span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">=</span> ipd<span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>  
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="keyword1">pd→</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_pd_def assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> pd_pd_ipd pd_ret_is_ret<span class="main">)</span>  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">=</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">¬</span> <span class="free">π</span> <span class="free">n</span> <span class="keyword1">pd→</span> <span class="skolem">π'</span> <span class="bound">i</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> pd_node1 ret_path_none_pd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="skolem">π'</span> <span class="bound">i</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">thesis</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="free">π</span> <span class="bound">k</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span><span class="main">)</span> <span class="bound">i</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_is_0_eq neq0_conv path_append_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">=</span> return›</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">=</span> return›</span></span> add_diff_cancel_left' assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff_is_0_eq path_append_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le0 path_append_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> **<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> ipd_is_ipd is_ipd_def neq0_conv pd_node2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path_nodes<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-path_pd_ipd0"><span class="command">lemma</span></span> path_pd_ipd0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">≠</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">≠</span> <span class="free">π</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="main">0</span>›</span></span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">=</span> ipd<span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span> 
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ipd_def is_pd_def assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> ipd_is_ipd<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> that<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">≠</span> return›</span></span> 
  <span class="keyword1"><span class="command">from</span></span> path_pd_ipd0' <span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> that <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-path_pd_ipd"><span class="command">lemma</span></span> path_pd_ipd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">≠</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> kn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="main">=</span> ipd<span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">k</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">k</span><span class="main">)</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">k</span><span class="main">)</span> <span class="main">0</span>›</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms path_path_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">with</span></span> path_pd_ipd0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span><span class="main">«</span><span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span><span class="main">-</span><span class="free">k</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ka</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ka</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">-</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">ka</span> <span class="main">=</span> ipd <span class="main">(</span><span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">k</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">+</span> <span class="skolem">ka</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="skolem">ka</span><span class="main">)</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="skolem">ka</span><span class="main">)</span> <span class="keyword1">ipd→</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ipd_is_ipd path_nodes<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">+</span> <span class="skolem">ka</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_ipd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_neq_iff not_add_less1<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="skolem">ka</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-path_ret_ipd"><span class="command">lemma</span></span> path_ret_ipd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">≠</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="main">=</span> ipd<span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> term_path_stable assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> dual_order.order_iff_strict<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> path_nodes return_pd<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">l</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms path_pd_ipd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-pd_intro"><span class="command">lemma</span></span> pd_intro<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="keyword1">pd→</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="IFC-path_pd_pd0"><span class="command">lemma</span></span> path_pd_pd0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span>  <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lpdn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="keyword1">pd→</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> npd0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="main">0</span>›</span></span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">=</span> <span class="free">n</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">thesis</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> notn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">⟹</span> <span class="free">π</span> <span class="bound">k</span> <span class="main">≠</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_pd_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> notn<span class="main">)</span>
  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> path'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π0'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> nonepd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">¬</span> <span class="free">π</span> <span class="free">l</span> <span class="keyword1">pd→</span> <span class="skolem">π'</span> <span class="bound">i</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> nret path path_nodes ret_path_none_pd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="main">≠</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> notn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">π'</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nonepd π0' lpdn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> neq0_conv<span class="main">)</span>
  
  <span class="keyword1"><span class="command">hence</span></span> notn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> notn π0' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path path' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> π0' path_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n'</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> π0' πn' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> notn' npd0 <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Facts about Control Dependencies›</span></span>

<span class="keyword1" id="IFC-icd_imp_cd"><span class="command">lemma</span></span> icd_imp_cd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span> <span class="main">⟹</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_icdi_def<span class="main">)</span>

<span class="keyword1" id="IFC-ipd_impl_not_cd"><span class="command">lemma</span></span> ipd_impl_not_cd<span class="main">:</span>  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..</span><span class="free">i</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_cdi_def<span class="main">)</span>

<span class="keyword1" id="IFC-cd_not_ret"><span class="command">lemma</span></span> cd_not_ret<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span> ›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def assms nat_less_le term_path_stable<span class="main">)</span>

<span class="keyword1" id="IFC-cd_path_shift"><span class="command">lemma</span></span> cd_path_shift<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span> ›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">j</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span><span class="main">-</span><span class="free">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">j</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">-</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> path_path_shift<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> b diff_less_mono<span class="main">)</span>  
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">j</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a ipd_impl_not_cd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">ja</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span> <span class="main">-</span> <span class="free">j</span><span class="main">..</span><span class="free">i</span> <span class="main">-</span> <span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">j</span><span class="main">)</span> <span class="bound">ja</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> b assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">-</span> <span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">j</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span><span class="main">-</span><span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">-</span> <span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">j</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span><span class="main">-</span><span class="free">j</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">-</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">-</span><span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">ja</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span> <span class="main">-</span> <span class="free">j</span><span class="main">..</span><span class="free">i</span> <span class="main">-</span> <span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">j</span><span class="main">)</span> <span class="bound">ja</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a ipd_impl_not_cd<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">j</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">goal_cases</span><span class="main">)</span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">-</span><span class="free">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">-</span><span class="free">j</span><span class="main">..</span><span class="free">i</span><span class="main">-</span><span class="free">j</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> ipd<span class="main">(</span><span class="free">π</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> c path_shift_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 1 assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff_is_0_eq' le_diff_iff nat_le_linear nat_less_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="IFC-cd_path_shift0"><span class="command">lemma</span></span> cd_path_shift0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→<span class="main">0</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> cd_path_shift<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_self_eq_0 le_refl<span class="main">)</span>

<span class="keyword1" id="IFC-icd_path_shift"><span class="command">lemma</span></span> icd_path_shift<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≤</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">l</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">l</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path_path_shift assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">l</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms cd_path_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">∀</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">&lt;..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span> <span class="main">-</span> <span class="free">l</span><span class="main">&lt;..&lt;</span><span class="free">i</span> <span class="main">-</span> <span class="free">l</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="free">i</span> <span class="main">-</span> <span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span> <span class="main">«</span> <span class="free">l</span></sup><span class="hidden">⇖</span>→ <span class="bound">m</span><span class="main">)</span>›</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span> <span class="main">-</span> <span class="free">l</span><span class="main">&lt;..&lt;</span><span class="free">i</span> <span class="main">-</span> <span class="free">l</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="free">i</span> <span class="main">-</span> <span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span> <span class="main">«</span> <span class="free">l</span></sup><span class="hidden">⇖</span>→ <span class="bound">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">&lt;..&lt;</span><span class="free">i</span><span class="main">}</span>›</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">-</span><span class="free">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">-</span><span class="free">l</span><span class="main">&lt;..&lt;</span><span class="free">i</span><span class="main">-</span><span class="free">l</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> <span class="main">-</span> <span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">l</span></sup><span class="hidden">⇖</span>→<span class="main">(</span><span class="skolem">m</span><span class="main">-</span><span class="free">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> cd_path_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">&lt;..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">-</span><span class="free">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">-</span><span class="free">l</span><span class="main">&lt;..&lt;</span><span class="free">i</span><span class="main">-</span><span class="free">l</span><span class="main">}</span>›</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">&lt;..&lt;</span><span class="free">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> <span class="main">-</span> <span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">l</span></sup><span class="hidden">⇖</span>→<span class="main">(</span><span class="skolem">m</span><span class="main">-</span><span class="free">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> cd_path_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> diff_add_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-icd_path_shift0"><span class="command">lemma</span></span> icd_path_shift0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="free">k</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→<span class="main">0</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> icd_path_shift<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_self_eq_0 le_refl<span class="main">)</span>

<span class="keyword1" id="IFC-cdi_path_swap"><span class="command">lemma</span></span> cdi_path_swap<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">j</span></sub><span class="hidden">⇙</span>  <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→<span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eq_up_to_def is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-cdi_path_swap_le"><span class="command">lemma</span></span> cdi_path_swap_le<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span>  <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→<span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms cdi_path_swap eq_up_to_le<span class="main">)</span>

<span class="keyword1" id="IFC-not_cd_impl_ipd"><span class="command">lemma</span></span> not_cd_impl_ipd<span class="main">:</span>  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">j</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..</span><span class="free">i</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> is_cdi_def<span class="main">)</span>

<span class="keyword1" id="IFC-icd_is_the_icd"><span class="command">lemma</span></span> icd_is_the_icd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">k</span><span class="main">.</span> <span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms icd_uniq 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> the1_equality<span class="main">)</span>

<span class="keyword1" id="IFC-all_ipd_imp_ret"><span class="command">lemma</span></span> all_ipd_imp_ret<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">π</span> <span class="bound">i</span> <span class="main">≠</span> return <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="free">π</span> <span class="bound">j</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">π</span> <span class="bound">j</span> <span class="main">=</span> return›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> wf_pdt_inv * assms  
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct_rule <span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">x</span> <span class="skolem">π</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> return›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> not_ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> return›</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_ipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">k</span> <span class="main">=</span> ipd <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_nodes<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">π</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> pdt›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ipd_in_pdt<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span> <span class="skolem">k</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> pdt_inv›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pdt_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>     
      <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="skolem">π</span> <span class="main">«</span> <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path_path_shift<span class="main">)</span>    
      <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span> <span class="bound">i</span> <span class="main">≠</span> return <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span> <span class="bound">j</span> <span class="main">=</span> ipd <span class="main">(</span><span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> ab_semigroup_add_class.add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_add_same_cancel1 less_imp_add_positive<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> a _ b c<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span> <span class="bound">j</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">j</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-loop_has_cd"><span class="command">lemma</span></span> loop_has_cd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> <span class="free">π</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">≠</span> return›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="free">π</span> <span class="main">(</span><span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>›</span></span>  
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="main">¬</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">k</span><span class="main">..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">j</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> not_cd_impl_ipd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&gt;</span> <span class="bound">k</span><span class="main">.</span> <span class="var">?π</span> <span class="bound">j</span> <span class="main">=</span> ipd <span class="main">(</span><span class="var">?π</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="keyword1">mod</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="skolem">k</span> <span class="keyword1">mod</span> <span class="free">i</span><span class="main">)</span><span class="main">..</span><span class="free">i</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">j</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">(</span><span class="skolem">k</span> <span class="keyword1">mod</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">j'</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">(</span><span class="skolem">k</span> <span class="keyword1">mod</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span> le_neq_implies_less<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j''</span> <span class="main">&gt;</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j''</span> <span class="keyword1">mod</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_bound_instance<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="skolem">j''</span> <span class="main">=</span> ipd <span class="main">(</span><span class="var">?π</span> <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&gt;</span> <span class="skolem">k</span><span class="main">.</span> <span class="var">?π</span> <span class="bound">j</span> <span class="main">=</span> ipd <span class="main">(</span><span class="var">?π</span> <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="var">?π</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> is_path_loop<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="skolem">k</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> all_ipd_imp_ret<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="keyword1">mod</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> term_path_stable less_imp_le<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-loop_has_cd'"><span class="command">lemma</span></span> loop_has_cd'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> <span class="free">π</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">≠</span> return›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound"><span class="bound">k'</span></span><span class="main">&lt;</span> <span class="free">i</span><span class="main">-</span><span class="free">j</span><span class="main">.</span> <span class="free">i</span><span class="main">-</span><span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">j</span></sup><span class="hidden">⇖</span>→<span class="bound">k'</span>›</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> loop_has_cd<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path_path_shift<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms less_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span><span class="main">&lt;</span><span class="free">i</span><span class="main">-</span><span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">-</span><span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">j</span></sup><span class="hidden">⇖</span>→<span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="free">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">-</span><span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">j</span></sup><span class="hidden">⇖</span>→ <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="free">j</span><span class="main">)</span><span class="main">-</span><span class="free">j</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> cd_path_shift<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k</span><span class="main">+</span><span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add1 add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> k'<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="IFC-claim''"><span class="command">lemma</span></span> claim''<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> pathπ<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> pathπ'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> πi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> <span class="free">π'</span> <span class="free">i'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">=</span> <span class="free">π'</span> <span class="free">j'</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> not_cd<span class="main">:</span>  <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">i'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return›</span></span>
<span class="keyword2"><span class="keyword">and</span></span> ilj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span>  
  <span class="keyword1"><span class="command">hence</span></span> jlei<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j'</span> <span class="main">≤</span> <span class="free">i'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> j'li'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j'</span> <span class="main">&lt;</span> <span class="free">i'</span>›</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π''</span> <span class="main">≡</span> <span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">j</span></sup><span class="hidden">⇖</span><span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">j'</span><span class="main">)</span><span class="main">)</span><span class="main">«</span><span class="free">i</span>›</span></span>
  <span class="keyword1"><span class="command">note</span></span> π''_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="free">π'</span> <span class="main">«</span> <span class="free">j'</span><span class="main">)</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_shift_def Nat.add_0_right πj<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π''</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pathπ pathπ' π''_def path_path_shift path_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π''</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="free">i</span><span class="main">+</span><span class="main">(</span><span class="free">i'</span><span class="main">-</span><span class="free">j'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">π''</span> <span class="main">0</span>›</span></span>  <span class="keyword1"><span class="command">using</span></span> ilj jlei πi πj 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> add_diff_cancel_left' le_antisym le_diff_conv le_eq_less_or_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π''</span> <span class="main">0</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ilj less_or_eq_imp_le nret<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">-</span><span class="free">i</span><span class="main">+</span><span class="main">(</span><span class="free">i'</span><span class="main">-</span><span class="free">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_is_0 ilj neq0_conv zero_less_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">-</span><span class="free">i</span><span class="main">+</span><span class="main">(</span><span class="free">i'</span><span class="main">-</span><span class="free">j'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span><span class="main">-</span><span class="free">i</span><span class="main">+</span><span class="main">(</span><span class="free">i'</span><span class="main">-</span><span class="free">j'</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π''</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k</span>›</span></span>   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loop_has_cd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">..</span><span class="free">j</span><span class="main">-</span><span class="free">i</span><span class="main">+</span><span class="main">(</span><span class="free">i'</span><span class="main">-</span><span class="free">j'</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="skolem">π''</span> <span class="bound">l</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="skolem">π''</span> <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">-</span><span class="free">i</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">-</span> <span class="free">i</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π''</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">π</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="skolem">k</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">l</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">π''</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> 
      <span class="keyword1"><span class="command">from</span></span> a l <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">-</span><span class="free">i</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">..</span> <span class="free">j</span><span class="main">-</span><span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="free">i'</span><span class="main">-</span><span class="free">j'</span><span class="main">)</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">l</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> πi πj j'li' nret pathπ' term_path_stable less_imp_le<span class="main">)</span> 
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">i</span><span class="main">+</span><span class="skolem">k</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_cd_impl_ipd pathπ<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_cd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">-</span> <span class="free">i</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">-</span> <span class="free">i</span> <span class="main">≤</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π''</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span><span class="free">j'</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> π''_def path_shift_def path_append_def <span class="keyword1"><span class="command">using</span></span> ilj 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span> πj add_diff_cancel_left' le_antisym le_diff_conv add.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">j'</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">j</span><span class="main">..</span><span class="free">i'</span><span class="main">}</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">l</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π'</span> <span class="main">(</span><span class="free">j'</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">j'</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">j</span><span class="main">..</span><span class="free">i'</span><span class="main">}</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">π''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="skolem">l</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="free">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> π''_def path_shift_def path_append_def <span class="keyword1"><span class="command">using</span></span> ilj
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Nat.diff_add_assoc πj a add.commute add_diff_cancel_left' add_leD1 le_antisym le_diff_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> 
      <span class="keyword1"><span class="command">from</span></span> a l <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">+</span> <span class="skolem">l</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="free">j'</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">..</span> <span class="free">j</span><span class="main">-</span><span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="free">i'</span><span class="main">-</span><span class="free">j'</span><span class="main">)</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">l</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π'</span> <span class="main">(</span><span class="free">j'</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j'</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> a  j'li' ilj k<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>      
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">i'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> πi nret<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="free">j'</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_cd_impl_ipd pathπ'<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_cd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">j'</span> <span class="main">&lt;</span> <span class="free">i'</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j'</span> <span class="main">=</span> <span class="free">i'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> linorder_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> <span class="free">π</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> πi πj<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ilj loop_has_cd' not_cd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nret pathπ<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-other_claim'"><span class="command">lemma</span></span> other_claim'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> <span class="free">π</span> <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> icd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>›</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> assms claim'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>›</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> assms claim'' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loop_has_cd'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="IFC-icd_no_cd_path_shift"><span class="command">lemma</span></span> icd_no_cd_path_shift<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="main">1</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span><span class="main">)</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span><span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span> <span class="main">«</span> <span class="main">1</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms is_icdi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k</span><span class="main">+</span><span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_path_shift<span class="main">[</span><span class="operator">OF</span> ** ***<span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> is_icdi_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-claim'"><span class="command">lemma</span></span> claim'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> pathπ<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> pathπ'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  πi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> <span class="free">π'</span> <span class="free">i'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">=</span> <span class="free">π'</span> <span class="free">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> not_cd<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">i'</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j'</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> ilj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> g0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span><span class="keyword1"><span class="command">using</span></span> not_cd<span class="main">[</span><span class="operator">unfolded</span> is_icdi_def is_cdi_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">π'</span> <span class="main">«</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">i'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">π'</span> <span class="main">«</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> πi πj g0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="main">1</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">i'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="main">1</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> icd_no_cd_path_shift not_cd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> icd_no_cd_path_shift not_cd<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="main">1</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="main">1</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pathπ pathπ' path_path_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> g0 nret <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> g0 ilj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">j'</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> claim'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span><span class="main">&lt;</span><span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-other_claim"><span class="command">lemma</span></span> other_claim<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> <span class="free">π</span> <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> icd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>›</span></span>  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> assms claim' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>›</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> assms claim' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_not_refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cd_trans0"><span class="command">lemma</span></span> cd_trans0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>    
  <span class="keyword1"><span class="command">have</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">≠</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">≠</span> return›</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> noipdi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">l</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> noipdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">l</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">l</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">using</span></span> path ij jk nret <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">l</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> jl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span><span class="main">&lt;</span><span class="skolem">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≤</span><span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> noipdi ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> pdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword1"><span class="command">using</span></span> path <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_nodes<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">j</span>›</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n</span> <span class="main">=</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">π'</span> <span class="bound">k</span> <span class="main">≠</span> ipd<span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> no_pd_path <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> path'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">j</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path path_cons<span class="main">)</span> 
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">≤</span> <span class="free">j</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">j</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span><span class="main">)</span> <span class="bound">k</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> noipdi *<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">j</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">j</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ipd_def ij ipd_is_ipd nret<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path path_nodes term_path_stable less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">l</span><span class="main">-</span><span class="free">j</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">j</span><span class="main">)</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jl l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path path_path_shift<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">l</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lk nret<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path term_path_stable<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">l</span><span class="main">-</span><span class="free">j</span><span class="main">)</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> jl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> noipdi <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">l</span><span class="main">-</span><span class="free">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">j</span><span class="main">)</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jl l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">≤</span> <span class="skolem">l</span><span class="main">-</span><span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">j</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">=</span> ipd <span class="main">(</span><span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">j</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path_pd_ipd0' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="skolem">k'</span><span class="main">)</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jl lk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> noipdj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cd_trans"><span class="command">lemma</span></span> cd_trans<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span><span class="main">«</span><span class="free">i</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span><span class="main">-</span><span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="var">?π</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> cd_path_shift0 path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">-</span><span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="var">?π</span></sup><span class="hidden">⇖</span>→<span class="free">j</span><span class="main">-</span><span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cd_path_shift is_cdi_def ij less_imp_le_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">-</span><span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="var">?π</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_trans0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path cd_path_shift0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-excd_impl_exicd"><span class="command">lemma</span></span> excd_impl_exicd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="bound">k</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="bound">k</span>›</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">i</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→<span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> ip<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">i</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">m</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→<span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k ip <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">i</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">m</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..&lt;</span><span class="skolem">i</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">-</span> <span class="skolem">m</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span><span class="main">«</span><span class="skolem">m</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_path_shift0 is_cdi_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">-</span> <span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">-</span> <span class="skolem">m</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span><span class="main">«</span><span class="skolem">m</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span> <span class="main">+</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ip 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_diff_cancel_right' icd_path_shift le_add1<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cd_split"><span class="command">lemma</span></span> cd_split<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">m</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">m</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ki<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> excd_impl_exicd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def <span class="keyword1"><span class="command">using</span></span> ki assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> km<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">m</span>›</span></span><span class="keyword1"><span class="command">using</span></span> m assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_eq_less_or_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">m</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> term_path_stable less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">&lt;</span><span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def is_icdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> m that <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cd_induct"><span class="command">lemma</span></span> cd_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> base IS<span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="free">k</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">i</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">k'</span> <span class="bound">i'</span><span class="main">.</span> <span class="bound">k'</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">k'</span> <span class="main">⟹</span> <span class="bound">i'</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">i'</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">i</span>›</span></span> 
<span class="keyword1"><span class="command">using</span></span> prem IH <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">i</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> base <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">i'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">i'</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">‹ <span class="skolem">i'</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less cd_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> icdk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> is_icdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> ih<span class="main">=</span>less<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> k'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>  _ k'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> ki<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k' is_icdi_def is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ki k'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="main">]</span> less<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cdi_prefix"><span class="command">lemma</span></span> cdi_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n'</span> <span class="main">⟹</span> <span class="free">n'</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">m</span>›</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> term_path_stable<span class="main">)</span>

<span class="keyword1" id="IFC-cr_wn'"><span class="command">lemma</span></span> cr_wn'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">m</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> nc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">m'</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">m</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">&lt;</span> <span class="free">m'</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&lt;</span> <span class="free">m'</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">m'</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m'</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m'</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 3 cdi_prefix<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> nc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cr_wn''"><span class="command">lemma</span></span> cr_wn''<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">m</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">m</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="free">m</span><span class="main">≤</span><span class="free">n</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> nm<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span><span class="main">&lt;</span><span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> cdi_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-ret_no_cd"><span class="command">lemma</span></span> ret_no_cd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms is_cdi_def<span class="main">)</span>

<span class="keyword1" id="IFC-ipd_not_self"><span class="command">lemma</span></span> ipd_not_self<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> nodes›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">≠</span> return›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> ipd <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ipd_def assms ipd_is_ipd<span class="main">)</span>

<span class="keyword1" id="IFC-icd_cs"><span class="command">lemma</span></span> icd_cs<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">l</span><span class="main">]</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">k</span><span class="main">.</span> <span class="free">l</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> icd_is_the_icd<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cd_not_pd"><span class="command">lemma</span></span> cd_not_pd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">π</span> <span class="free">l</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> pd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">k</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pd pd_ret_is_ret ret_no_cd<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> kl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> path_pd_ipd<span class="main">[</span><span class="operator">OF</span> path nret assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> pd kl<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≤</span> <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">n</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cd_ipd_is_cd"><span class="command">lemma</span></span> cd_ipd_is_cd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">&lt;</span><span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">m</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">n</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> mcdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mcdj assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cdi_prefix less_imp_le_nat<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> kj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> kj assms mcdj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> is_cdi_def is_ipd_def cd_not_pd ipd_is_ipd path_nodes term_path_stable less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> mcdj is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">n</span> <span class="main">≠</span> ipd<span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mcdj is_cdi_def term_path_stable less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mcdj cd_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def is_ipd_def assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cd_not_pd ipd_is_ipd path_nodes term_path_stable less_imp_le<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-ipd_pd_cd0"><span class="command">lemma</span></span> ipd_pd_cd0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> lcd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="main">(</span><span class="free">π</span> <span class="free">n</span><span class="main">)</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> π0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cdi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcd <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def π0 cdi term_path_stable less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span>  path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="free">π</span> <span class="bound">i</span> <span class="main">≠</span> ipd <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdi <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def π0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π'</span> <span class="skolem">n'</span>
    <span class="keyword3"><span class="command">assume</span></span> path'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π'</span>›</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> π'0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">l</span>›</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">=</span> return›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path path' πn π'0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">n'</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> ret πn π'0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> π0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="skolem">k</span> <span class="keyword1">pd→</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ipd_def path π0 ipd_is_ipd nret path_nodes<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">≤</span> <span class="free">n</span><span class="main">+</span><span class="skolem">n'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">=</span> ipd <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pd_intro<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">k'</span><span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="free">π</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> k'<span class="main">(</span>2<span class="main">)</span> ipd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">π'</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">k'</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound"><span class="bound">k'</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="skolem">π'</span> <span class="bound">k'</span> <span class="main">=</span> ipd <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> πn path path_nodes<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="main">(</span><span class="free">π</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π0 πn<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-ipd_pd_cd"><span class="command">lemma</span></span> ipd_pd_cd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> lcd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="main">(</span><span class="free">π</span> <span class="free">l</span><span class="main">)</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span><span class="main">-</span><span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→<span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcd cd_path_shift0 is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> ipd_pd_cd0<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">k</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcd <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> <span class="main">«</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cd_is_cd_ipd"><span class="command">lemma</span></span> cd_is_cd_ipd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> km<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">&lt;</span><span class="free">m</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">m</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">n</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> nipdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> jk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> nretj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">≠</span> return›</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> nipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">l</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span>  cdj is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> pd<span class="main">:</span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastAtMost_iff cdj ipd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ipd_pd_cd jk le_refl less_imp_le nipd nretj path path_nodes pd_pd_ipd<span class="main">)</span>  
  <span class="keyword1"><span class="command">have</span></span> nretm<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">m</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nipdj pd pd_ret_is_ret<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> jm<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jk km <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> ncdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">m</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span>›</span></span>     
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">l</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> jm nretm path<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> jl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="skolem">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≤</span> <span class="free">m</span>›</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> lipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">l</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> lm<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nipdj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_eq_less_or_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> npd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ipd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> lipd nipdj pd pd_antisym<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> nd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">l</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword1"><span class="command">using</span></span> path path_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> no_pd_path<span class="main">[</span><span class="operator">OF</span> nd npd<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> path'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π'0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="skolem">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π'n<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> nipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">ka</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">π'</span> <span class="bound">ka</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="skolem">l</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span><span class="main">)</span> <span class="main">«</span> <span class="free">k</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> path''<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="var">?π</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> π'0 path path' path_cons path_path_shift<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> kl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lipd cdj jl <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> π'n π'0 kl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ipd_def ipd_is_ipd nretj path path_nodes<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> l'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="skolem">l'</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">+</span> <span class="skolem">l'</span> <span class="main">≤</span> <span class="skolem">l</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> l' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">+</span> <span class="skolem">l'</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> dual_order.strict_trans2 lm<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ipd<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">k</span> <span class="main">+</span> <span class="skolem">l'</span> <span class="main">≤</span> <span class="skolem">l</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="skolem">l'</span> <span class="main">-</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> l' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">+</span> <span class="skolem">l'</span> <span class="main">-</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> l' kl <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>  
      <span class="keyword1"><span class="command">ultimately</span></span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> nipd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-ipd_icd_greatest_cd_not_ipd"><span class="command">lemma</span></span> ipd_icd_greatest_cd_not_ipd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> ipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">m</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">n</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span>
<span class="keyword2"><span class="keyword">and</span></span> km<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> icdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">∧</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?j</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">∧</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> kcdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms cd_ipd_is_cd is_icdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
  <span class="keyword1"><span class="command">have</span></span> nipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icdj <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">∧</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> exists<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span> <span class="main">∧</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="free">j</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> kcdj nipd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> GreatestI_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> exists<span class="main">]</span> Greatest_le_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> exists<span class="main">]</span>
  <span class="keyword1"><span class="command">hence</span></span> kcdj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="var">?j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ipd'<span class="main">:</span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="var">?j</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="var">?j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> mcdj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="var">?j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ipd km cd_is_cd_ipd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">=</span> <span class="var">?j</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≠</span> <span class="var">?j</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> jlj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="var">?j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?j</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kcdj' km <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> icdj mcdj' <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cd_impl_icd_cd"><span class="command">lemma</span></span> cd_impl_icd_cd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">l</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms cd_split icd_uniq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="IFC-cdi_is_cd_icdi"><span class="command">lemma</span></span> cdi_is_cd_icdi<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">i</span> <span class="main">⟷</span> <span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">i</span> <span class="main">∨</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span>›</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms cd_impl_icd_cd cd_trans icd_imp_cd icd_uniq<span class="main">)</span>

<span class="keyword1" id="IFC-same_ipd_stable"><span class="command">lemma</span></span> same_ipd_stable<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> jcdi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> cr_wn' le_antisym less_imp_le_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">k</span> ›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ipd_pd_cd<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">j</span> ›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> ipd_pd_cd jcdi<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="main">(</span>ipd <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 2 IFC_def.is_cdi_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> atLeastAtMost_iff jcdi less_imp_le pd_node2 pd_pd_ipd<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="main">(</span>ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 2 IFC_def.is_ipd_def assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cd_not_pd ipd_is_ipd jcdi pd_node2 ret_no_cd<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 3 4 pd_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-icd_pd_intermediate'"><span class="command">lemma</span></span> icd_pd_intermediate'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> icd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span>  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="keyword1">pd→</span> <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">-</span> <span class="free">j</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less.prems icd <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_icdi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> icd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_icdi_def ret_no_cd<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">l</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">π</span> <span class="bound">l</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">using</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≤</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">l</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> lpd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">l</span> <span class="keyword1">pd→</span> <span class="main">(</span><span class="free">π</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ipd_def <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> ipd_is_ipd path_nodes term_path_stable<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">=</span> <span class="free">i</span>›</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lpd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≠</span> <span class="free">i</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≠</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ipd_def <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> ipd_is_ipd path_nodes term_path_stable<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">-</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_less_mono2 less.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> linorder_neqE_nat not_le order.strict_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="keyword1">pd→</span> <span class="main">(</span><span class="free">π</span> <span class="skolem">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lpd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pd_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-icd_pd_intermediate"><span class="command">lemma</span></span> icd_pd_intermediate<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> icd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span>  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="keyword1">pd→</span> <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span>›</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms icd_pd_intermediate'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_icdi_def le_neq_trans path_nodes pd_refl<span class="main">)</span>

<span class="keyword1" id="IFC-no_icd_pd"><span class="command">lemma</span></span> no_icd_pd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> noicd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">l</span></span><span class="main">≥</span><span class="free">n</span><span class="main">.</span> <span class="main">¬</span> <span class="free">k</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> nk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">n</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">=</span> return›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path path_nodes return_pd<span class="main">)</span>  
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">≠</span> return›</span></span>
  <span class="keyword1"><span class="command">have</span></span> nocd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> <span class="free">n</span><span class="main">≤</span><span class="bound">l</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">l</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> kcd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> nl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="skolem">l</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">n</span></sup><span class="hidden">⇖</span>→ <span class="main">(</span><span class="skolem">l</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_path_shift<span class="main">[</span><span class="operator">OF</span> nl path<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">n</span></sup><span class="hidden">⇖</span>→ <span class="bound">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> excd_impl_exicd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> l' <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="main">(</span><span class="skolem">l'</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icd_path_shift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">+</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span><span class="main">]</span> path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> noicd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>    
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="free">n</span> <span class="main">≤</span> <span class="bound">l</span> <span class="main">⟹</span> <span class="bound">l</span><span class="main">&lt;</span><span class="free">k</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">l</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">j</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path nret <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nk <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">-</span> <span class="free">n</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> <span class="free">k</span>›</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pd_refl path path_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≠</span> <span class="free">k</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> nk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> less<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> jnk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">n</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ipdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">j</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> nretn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">n</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> nk nret term_path_stable path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> ipd_is_ipd path path_nodes is_ipd_def ipdj
    <span class="keyword1"><span class="command">have</span></span> jpdn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">j</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">k</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jpdn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≠</span> <span class="free">k</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> jk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jnk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≠</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ipdj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ipd_not_self nretn path path_nodes<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> nj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jnk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">-</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">-</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jk nj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">with</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> less<span class="main">(</span>2<span class="main">)</span> jk nj
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jpdn pd_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="IFC-first_pd_no_cd"><span class="command">lemma</span></span> first_pd_no_cd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> pd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> first<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="free">π</span> <span class="bound">l</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span><span class="main">.</span> <span class="main">¬</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">l</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> ncdl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> ln<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">π</span> <span class="free">n</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ncdl cd_not_pd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ln first<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> path'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="skolem">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> notπn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span><span class="main">≤</span> <span class="skolem">n'</span><span class="main">.</span> <span class="skolem">π'</span> <span class="bound">j</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">using</span></span> path path_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="skolem">l</span></sup><span class="hidden">⇖</span> <span class="skolem">π'</span>›</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="var">?π</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> π0 path path' path_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="main">(</span><span class="skolem">n'</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> π0 πn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="skolem">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">π</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pd <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">l</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> jn first ln <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">l</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> j jn notπn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-first_pd_no_icd"><span class="command">lemma</span></span> first_pd_no_icd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> pd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> first<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="free">π</span> <span class="bound">l</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span><span class="main">.</span> <span class="main">¬</span> <span class="free">n</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">l</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> first first_pd_no_cd icd_imp_cd path pd<span class="main">)</span>

<span class="keyword1" id="IFC-path_nret_ex_nipd"><span class="command">lemma</span></span> path_nret_ex_nipd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">π</span> <span class="bound">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="bound">j</span><span class="main">.</span> <span class="free">π</span> <span class="bound">k</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="bound">j</span><span class="main">.</span> <span class="free">π</span> <span class="bound">k</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="bound">j</span><span class="main">.</span> <span class="free">π</span> <span class="bound">k</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> ipd <span class="main">(</span><span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span><span class="main">&gt;</span><span class="skolem">i</span><span class="main">+</span><span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">k</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> ipd <span class="main">(</span><span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">-</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="skolem">j</span><span class="main">.</span> <span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> ipd <span class="main">(</span><span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> path_path_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="skolem">i</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> all_ipd_imp_ret <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-path_nret_ex_all_cd"><span class="command">lemma</span></span> path_nret_ex_all_cd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">π</span> <span class="bound">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="bound">j</span><span class="main">.</span> <span class="bound">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span><span class="main">)</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">using</span></span> assms path_nret_ex_nipd<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastAtMost_iff ipd_not_self linorder_neqE_nat not_le path_nodes<span class="main">)</span>


<span class="keyword1" id="IFC-path_nret_inf_all_cd"><span class="command">lemma</span></span> path_nret_inf_all_cd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">π</span> <span class="bound">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> finite <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="bound">j</span><span class="main">.</span> <span class="bound">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span><span class="main">}</span>›</span></span> 
<span class="keyword1"><span class="command">using</span></span> unbounded_nat_set_infinite path_nret_ex_all_cd<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-path_nret_inf_icd_seq"><span class="command">lemma</span></span> path_nret_inf_icd_seq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">π</span> <span class="bound">i</span> <span class="main">≠</span> return›</span></span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">f</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">f</span> <span class="bound">i</span>›</span></span> <span class="quoted"><span class="quoted">‹range <span class="free">f</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="bound">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">0</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> path_nret_inf_all_cd<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> ran<span class="main">:</span> <span class="quoted"><span class="quoted">‹range <span class="skolem">f</span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="bound">j</span><span class="main">.</span> <span class="bound">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> asc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> infinite_ascending <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">f</span> <span class="bound">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> asc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lift_Suc_mono_less<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> cd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">f</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ran asc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">f</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">f</span> <span class="skolem">i</span>›</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span>  im<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">m</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> mi<span class="main">:</span> <span class="quoted"><span class="quoted">‹ <span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cdm<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> cd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="skolem">m</span><span class="main">.</span> <span class="bound">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ran <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdm cd_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> mk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span>
        <span class="keyword1"><span class="command">hence</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cdi_prefix mk<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">∈</span> range <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ran <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> im mi mono <span class="keyword1"><span class="command">unfolding</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessI le_less not_le<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>  
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword3"><span class="command">assume</span></span> cdm<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">0</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="skolem">m</span><span class="main">.</span> <span class="bound">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">f</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ran <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdm cd_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> mk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">f</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cdi_prefix mk<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">∈</span> range <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ran <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> fj0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">f</span> <span class="main">0</span>›</span></span>  <span class="keyword1"><span class="command">using</span></span> cdm m is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_irrefl neq0_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> fj0 mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that ran <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cdi_iff_no_strict_pd"><span class="command">lemma</span></span> cdi_iff_no_strict_pd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span> <span class="main">⟷</span> is_path <span class="free">π</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">,</span> <span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> pdt<span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> cd<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> cd <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">,</span> <span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> pdt›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹ <span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="free">k</span><span class="main">..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">,</span> <span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∉</span> pdt<span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..</span><span class="free">i</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">,</span> <span class="free">π</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> pdt›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">j</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pdt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> path_pd_ipd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..</span><span class="free">i</span><span class="main">}</span>›</span></span> atLeastAtMost_iff cd cd_not_pd cdi_prefix le_eq_less_or_eq<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">,</span> <span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> pdt<span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">,</span> <span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> pdt<span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ipd_in_pdt term_path_stable less_or_eq_imp_le not_cd_impl_ipd path_nodes<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Facts about Control Slices›</span></span>

<span class="keyword1" id="IFC-last_cs"><span class="command">lemma</span></span> last_cs<span class="main">:</span> <span class="quoted"><span class="quoted">‹last <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-cs_not_nil"><span class="command">lemma</span></span> cs_not_nil<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="IFC-cs_return"><span class="command">lemma</span></span> cs_return<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> <span class="main">[</span><span class="free">π</span> <span class="free">n</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms cs.elims icd_imp_cd ret_no_cd<span class="main">)</span>

<span class="keyword1" id="IFC-cs_0"><span class="command">lemma</span></span> cs_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">0</span> <span class="main">=</span> <span class="main">[</span><span class="free">π</span> <span class="main">0</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> is_icdi_def is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-cs_inj"><span class="command">lemma</span></span> cs_inj<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">≠</span> return›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="free">n'</span>›</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_not_nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">π</span> <span class="skolem">n</span> <span class="skolem">n'</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil 
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">n</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→<span class="bound">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>2<span class="main">)</span> cs_not_nil 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span> append1_eq_conv append_Nil cs_not_nil<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Nil snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">n'</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→<span class="bound">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_not_nil
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span> append1_eq_conv append_Nil cs_not_nil<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">n</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">n'</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> excd_impl_exicd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">π</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>5<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> * ** list.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> other_claim' snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">n</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→<span class="bound">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> append_is_Nil_conv list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→<span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">k</span> <span class="main">.</span> <span class="skolem">n</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> icd_is_the_icd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> xsk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * k snoc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> cs.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">n'</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→<span class="bound">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> snoc<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> Cons append1_eq_conv append_Nil list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">k</span> <span class="main">.</span> <span class="skolem">n'</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> icd_is_the_icd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> xsk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ** k' snoc<span class="main">(</span>5<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> cs.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> xsk <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> kn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_icdi_def is_cdi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">k</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> term_path_stable less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> kk'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>1<span class="main">)</span> xsk snoc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> nk0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">-</span> <span class="skolem">k</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">-</span> <span class="skolem">k</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k k' icd_path_shift0 snoc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> nkr<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span><span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>4<span class="main">)</span> kn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_path_shift snoc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> kn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> k' kk' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_icdi_def is_cdi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">π</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>5<span class="main">)</span> * ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span><span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">π</span><span class="main">«</span><span class="skolem">k</span><span class="main">)</span><span class="main">(</span><span class="skolem">n'</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kn kn' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">ultimately</span></span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">-</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">n'</span> <span class="main">-</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> other_claim  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kn kn' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_cases"><span class="command">lemma</span></span> cs_cases<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">π</span> <span class="free">i</span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>base<span class="main">)</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="main">[</span><span class="free">π</span> <span class="free">i</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> <span class="main">|</span> 
<span class="main">(</span>depend<span class="main">)</span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">π</span> <span class="free">i</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">k</span><span class="main">.</span> <span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span><span class="main">)</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> icd_is_the_icd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">π</span> <span class="free">i</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> k that <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> excd_impl_exicd<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="main">[</span><span class="free">π</span> <span class="free">i</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_length_one"><span class="command">lemma</span></span> cs_length_one<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="main">[</span><span class="free">π</span> <span class="free">i</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cs_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms cs_not_nil 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cs_cases<span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> assms cs_not_nil 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-cs_length_g_one"><span class="command">lemma</span></span> cs_length_g_one<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">π</span> <span class="free">i</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cs_cases<span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> assms cs_not_nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-claim"><span class="command">lemma</span></span> claim<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>  path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>  ii<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">j'</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> bl<span class="main">:</span> <span class="quoted"><span class="quoted">‹butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ilj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">j'</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>›</span></span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> bl butlast.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_snoc cs_length_g_one cs_length_one<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs_not_nil<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> ii<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> bl butlast.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_snoc cs_length_g_one cs_length_one<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs_not_nil jj<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="main">[</span><span class="free">π</span> <span class="free">i</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">=</span> <span class="main">[</span><span class="free">π</span> <span class="free">j</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">j'</span> <span class="main">=</span> <span class="main">[</span><span class="free">π'</span> <span class="free">j'</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span><span class="main">=</span> <span class="main">[</span><span class="free">π'</span> <span class="free">i'</span><span class="main">]</span>›</span></span> 
    <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">i'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cs_length_one ** <span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> <span class="free">π'</span> <span class="free">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">=</span> <span class="free">π'</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span>  assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nret ilj path claim'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">j'</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span>›</span></span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> bl butlast.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_snoc cs_length_g_one cs_length_one<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs_not_nil<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> ii<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> bl butlast.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_snoc cs_length_g_one cs_length_one<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs_not_nil jj<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ***<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">π</span> <span class="free">i</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">π</span> <span class="free">j</span><span class="main">]</span>›</span></span>  <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span> <span class="main">=</span> <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">π'</span> <span class="free">i'</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">j'</span> <span class="main">=</span> <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">π'</span> <span class="free">j'</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    icds<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j'</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ** cs_length_g_one<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">k</span> <span class="main">≠</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">k'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> nret 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> is_icdi_def icds<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> is_cdi_def term_path_stable less_imp_le<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def is_icdi_def icds<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> term_path_stable less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>  
  <span class="keyword1"><span class="command">have</span></span> lk<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">=</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path cs_inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">«</span> <span class="skolem">k</span>›</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π'</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span><span class="main">«</span><span class="skolem">k'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">-</span><span class="skolem">k</span> icd<span class="hidden">⇗</span><sup><span class="var">?π</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span><span class="main">-</span><span class="skolem">k</span> icd<span class="hidden">⇗</span><sup><span class="var">?π</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span><span class="main">-</span><span class="skolem">k'</span> icd<span class="hidden">⇗</span><sup><span class="var">?π'</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j'</span><span class="main">-</span><span class="skolem">k'</span> icd<span class="hidden">⇗</span><sup><span class="var">?π'</span></sup><span class="hidden">⇖</span>→ <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icd_path_shift0 path icds <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> ki<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icds <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_icdi_def is_cdi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">-</span><span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">-</span><span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_is_0_eq diff_less_mono ilj nat_le_linear order.strict_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> πi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> <span class="free">π'</span> <span class="free">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">=</span> <span class="free">π'</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms *** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="free">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icds <span class="keyword1"><span class="command">unfolding</span></span> lk <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def is_icdi_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="var">?π'</span> <span class="main">(</span><span class="free">i'</span><span class="main">-</span><span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="var">?π'</span> <span class="main">(</span><span class="free">j'</span><span class="main">-</span><span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> πi ki ilj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> nret ki <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="var">?π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="var">?π'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path path_path_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span><span class="main">-</span><span class="skolem">k'</span> <span class="main">&lt;</span> <span class="free">j'</span> <span class="main">-</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> claim' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_is_0_eq diff_less_mono less_nat_zero_code linorder_neqE_nat nat_le_linear<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_split'"><span class="command">lemma</span></span> cs_split'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">]</span><span class="main">@</span><span class="free">ys</span>›</span></span>  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∧</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">m</span>›</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">ys</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rev_induct <span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="skolem">i</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_length_g_one<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">]</span><span class="main">@</span><span class="skolem">ys</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append1_eq_conv append_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">m</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * cd_trans <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_icdi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ** <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="skolem">i</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_length_g_one<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">x'</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> append1_eq_conv a <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>  
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_split"><span class="command">lemma</span></span> cs_split<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">@</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">π</span> <span class="free">i</span><span class="main">]</span>›</span></span>  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∧</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">m</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">π</span> <span class="free">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">@</span><span class="skolem">ys'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil neq_Nil_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_split'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys'</span>›</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_less_split"><span class="command">lemma</span></span> cs_less_split<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">≺</span> <span class="free">ys</span>›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">as</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span><span class="main">@</span><span class="free">a</span><span class="main">#</span><span class="free">as</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cs_less.simps <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_nth_drop_Suc append_take_drop_id<span class="main">)</span>

<span class="keyword1" id="IFC-cs_select_is_cs"><span class="command">lemma</span></span> cs_select_is_cs<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">≠</span> Nil›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">≺</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">π</span><span class="main">¡</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="main">(</span><span class="free">π</span><span class="main">¡</span><span class="free">xs</span><span class="main">)</span>›</span></span><span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> <span class="free">xs</span><span class="main">@</span><span class="skolem">b</span><span class="main">#</span><span class="skolem">bs</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms cs_less_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> a b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="free">xs</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> is_cd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_split' a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">k'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def term_path_stable less_imp_le<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">π</span><span class="main">¡</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cs_select_def <span class="keyword1"><span class="command">using</span></span> cs_inj<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nret<span class="main">]</span> csk the_equality<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="main">(</span><span class="free">π</span><span class="main">¡</span><span class="free">xs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cs_select_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs_inj cs_select_def csk is_cd nret<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cd_in_cs"><span class="command">lemma</span></span> cd_in_cs<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">m</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">ns</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span><span class="main">)</span> <span class="main">@</span> <span class="bound">ns</span> <span class="main">@</span><span class="main">[</span><span class="free">π</span> <span class="free">n</span><span class="main">]</span>›</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cd_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base  <span class="skolem">n</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil cs.simps icd_is_the_icd<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IS <span class="skolem">k</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="skolem">n</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cs.simps icd_is_the_icd<span class="main">)</span>  
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> IS <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-butlast_cs_not_cd"><span class="command">lemma</span></span> butlast_cs_not_cd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">m</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="free">n</span>›</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil append_assoc assms cd_in_cs cs_not_nil list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> self_append_conv snoc_eq_iff_butlast<span class="main">)</span>

<span class="keyword1" id="IFC-wn_cs_butlast"><span class="command">lemma</span></span> wn_cs_butlast<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span><span class="main">&lt;</span><span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> butlast_cs_not_cd<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> cr_wn'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is the central theorem making the control slice suitable for matching indices between executions.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> cs_order<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> csj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ilj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span>   
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span><span class="main">&lt;</span><span class="free">j'</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">≠</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_inj<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nret<span class="main">]</span> ilj <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">≠</span> Nil›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">≠</span> Nil›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cs_not_nil<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_neq_prefix_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>diverge <span class="skolem">xs</span> <span class="skolem">x</span> <span class="skolem">x'</span> <span class="skolem">ys</span> <span class="skolem">ys'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> csx <span class="main">=</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span>›</span></span>
    <span class="keyword1"><span class="command">note</span></span> csx' <span class="main">=</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys'</span>›</span></span>
    <span class="keyword1"><span class="command">note</span></span> xx <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x'</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span>›</span></span><span class="main">)</span> 
      <span class="keyword3"><span class="command">assume</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">=</span> Nil›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys'</span>›</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> ys'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys'</span> <span class="main">=</span> Nil›</span></span>
        <span class="keyword1"><span class="command">have</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 csx ys<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> append_Nil2 csx' ys'<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> bl<span class="main">:</span> <span class="quoted"><span class="quoted">‹butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>        
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> claim<span class="main">[</span><span class="operator">OF</span> path csi csj bl nret ilj<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y'</span> <span class="skolem">zs'</span>
        <span class="keyword3"><span class="command">assume</span></span> ys'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys'</span> <span class="main">=</span> <span class="skolem">y'</span><span class="main">#</span><span class="skolem">zs'</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">,</span><span class="skolem">y'</span><span class="main">]</span><span class="main">@</span> <span class="skolem">zs'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 csx ys<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> append_Cons append_Nil csx' ys'<span class="main">)</span>         
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs cs_split' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs cs_split' <span class="keyword1"><span class="command">unfolding</span></span> csj <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> csn <span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> bl<span class="main">:</span> <span class="quoted"><span class="quoted">‹butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> n n' cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> bl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> notcd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> butlast_cs_not_cd bl<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> nin<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs n xx <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> iln<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cr_wn'<span class="main">[</span><span class="operator">OF</span> jn notcd<span class="main">]</span> nin ilj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> claim<span class="main">[</span><span class="operator">OF</span> path csi csn bl nret iln<span class="main">]</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> <span class="main">&lt;</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jn' <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">zs</span>
      <span class="keyword3"><span class="command">assume</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">#</span><span class="skolem">zs</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys'</span>›</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> ys' <span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys'</span> <span class="main">=</span> Nil›</span></span>
        <span class="keyword1"><span class="command">have</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">]</span><span class="main">@</span><span class="skolem">zs</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil csx ys<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> append_Nil2 csx' ys'<span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs cs_split' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs cs_split' <span class="keyword1"><span class="command">unfolding</span></span> csi <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> csn <span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> bl<span class="main">:</span> <span class="quoted"><span class="quoted">‹butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> n n' cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> bl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">j'</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> notcd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> butlast_cs_not_cd bl'<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> nin<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jn <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> nlj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nin ilj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> claim<span class="main">[</span><span class="operator">OF</span> path csn csj bl _ nlj<span class="main">]</span>
        <span class="keyword1"><span class="command">hence</span></span> nj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> term_path_stable<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _<span class="main">]</span> less_imp_le nin nret <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cdi_prefix<span class="main">[</span><span class="operator">OF</span> jn' nj'<span class="main">]</span> notcd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y'</span> <span class="skolem">zs'</span>
        <span class="keyword3"><span class="command">assume</span></span> ys' <span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys'</span> <span class="main">=</span> <span class="skolem">y'</span><span class="main">#</span><span class="skolem">zs'</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">]</span><span class="main">@</span><span class="skolem">zs</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x'</span><span class="main">,</span><span class="skolem">y'</span><span class="main">]</span><span class="main">@</span><span class="skolem">zs'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil csx ys<span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span> append_Cons append_Nil csx' ys'<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">≠</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_inj path nret ilj <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> im<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs cs_split' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs cs_split' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">m'</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> im'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs cs_split' <span class="keyword1"><span class="command">unfolding</span></span> csi <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs cs_split' <span class="keyword1"><span class="command">unfolding</span></span> csj <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ilj m n wn_cs_butlast<span class="main">[</span><span class="operator">OF</span> _ jn im<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">≠</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> m n xx <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_snoc<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> 
        <span class="keyword1"><span class="command">have</span></span> mn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">m</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_cs last_snoc m mn n path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> term_path_stable xx less_imp_le<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>  
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">m'</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> m n n' m' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m'</span> <span class="main">&lt;</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> claim path <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> m' n' im' jn' wn_cs_butlast <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> butlast_snoc<span class="main">)</span>        
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>prefix1 <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> pfx <span class="main">=</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">@</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">note</span></span> xs <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">#</span><span class="skolem">as</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> xs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> bj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">=</span> <span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_not_nil <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">a</span><span class="main">]</span><span class="main">@</span><span class="skolem">as</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pfx <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cdep<span class="main">:</span>  <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_split' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> mi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">=</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> bj cs_inj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def term_path_stable less_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdep <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ilj <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>prefix2 <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> pfx <span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> prefix2 csi csj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> xs <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
     <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">#</span><span class="skolem">as</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> xs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> bj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span>  <span class="main">=</span> <span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_not_nil <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">j'</span> <span class="main">=</span> <span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">a</span><span class="main">]</span><span class="main">@</span><span class="skolem">as</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pfx <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cdep<span class="main">:</span>  <span class="quoted"><span class="quoted">‹<span class="free">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_split' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> mi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">=</span> <span class="free">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> bj cs_inj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def term_path_stable less_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="free">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdep <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_order_le"><span class="command">lemma</span></span> cs_order_le<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> csj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ilj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span>   
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span><span class="main">≤</span><span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">with</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ilj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> csij<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csi csj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">have</span></span> nret'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">i'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> nret last_cs csi <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_inj<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nret' csij<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> cs_induct<span class="main">[</span><span class="operator">case_names</span> cs<span class="main">]</span> <span class="main">=</span> cs.induct

<span class="keyword1" id="IFC-icdi_path_swap"><span class="command">lemma</span></span> icdi_path_swap<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">j</span></sub><span class="hidden">⇙</span>  <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→<span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eq_up_to_def is_icdi_def is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-icdi_path_swap_le"><span class="command">lemma</span></span> icdi_path_swap_le<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span>  <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→<span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms icdi_path_swap eq_up_to_le<span class="main">)</span>

<span class="keyword1" id="IFC-cs_path_swap"><span class="command">lemma</span></span> cs_path_swap<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>cs_induct<span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cs <span class="skolem">π</span> <span class="skolem">k</span><span class="main">)</span>     
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">l</span><span class="main">.</span> <span class="skolem">k</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">l</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="skolem">k</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">l</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> kicd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="var">?l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> icd_is_the_icd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span>›</span></span><span class="main">]</span> is_icdi_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">≤</span><span class="var">?l</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">π'</span> <span class="bound">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> eq_up_to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> csl<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="var">?l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="var">?l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> * <span class="keyword1"><span class="command">unfolding</span></span> eq_up_to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> kicd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="var">?l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> icd_is_the_icd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="var">?l</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">π</span> <span class="skolem">k</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kicd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> kicd'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="var">?l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kicd icdi_path_swap<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ cs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">l</span><span class="main">.</span> <span class="skolem">k</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> icd_is_the_icd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> csk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="var">?l</span> <span class="main">@</span> <span class="main">[</span><span class="free">π'</span> <span class="skolem">k</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kicd' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">π</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> eq_up_to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> csl csk csk'  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cs <span class="skolem">π</span> <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="skolem">k</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">l</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">π</span> <span class="skolem">k</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="skolem">k</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> * icdi_path_swap_le<span class="main">[</span><span class="operator">OF</span> cs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span>›</span></span><span class="main">]</span> cs<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_up_to_sym le_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> csk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">[</span><span class="free">π'</span> <span class="skolem">k</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> csk <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs<span class="main">(</span>3<span class="main">)</span> eq_up_to_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_path_swap_le"><span class="command">lemma</span></span> cs_path_swap_le<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span>  <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms cs_path_swap eq_up_to_le<span class="main">)</span>

<span class="keyword1" id="IFC-cs_path_swap_cd"><span class="command">lemma</span></span> cs_path_swap_cd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="free">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> cd_in_cs<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">@</span> <span class="skolem">ns</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">n</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cs_not_nil rev_exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> <span class="free">π'</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">@</span><span class="skolem">ns</span><span class="main">@</span><span class="main">[</span><span class="free">π'</span> <span class="free">n'</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * assms<span class="main">(</span>3<span class="main">)</span> csk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> cs_split<span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that csk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-path_ipd_swap"><span class="command">lemma</span></span> path_ipd_swap<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">≠</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π'</span> <span class="free">m</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span>  <span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">m</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π'</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">l</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π'</span> <span class="free">k</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">r</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path_nodes reaching_ret<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span>  <span class="skolem">π'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="var">?π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> equpto<span class="main">:</span>  <span class="quoted"><span class="quoted">‹<span class="var">?π</span> =<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span>  <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms path_cons * path_append_eq_up_to <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> πk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="free">k</span> <span class="main">=</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_imp_le_nat path_append_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?π</span> <span class="skolem">j</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">j</span>›</span></span> <span class="main">)</span><span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> πk assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path path_ret_ipd ret<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">≡</span> <span class="keyword1">LEAST</span> <span class="bound">m</span> <span class="main">.</span> <span class="var">?P</span> <span class="bound">m</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> Pm<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span>›</span></span><span class="main">]</span> j m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> km<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">≤</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="skolem">m</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">l</span> <span class="main">⟹</span> <span class="skolem">m</span> <span class="main">≤</span> <span class="bound">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">]</span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> πknipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="free">k</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> πk assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ipd_not_self path_nodes<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nipd'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="bound">l</span> <span class="main">⟹</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">⟹</span> <span class="var">?π</span> <span class="bound">l</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> le km<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..&lt;</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span> <span class="var">?π</span> <span class="bound">l</span> <span class="main">≠</span> ipd<span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> πknipd nipd' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> le_eq_less_or_eq<span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span> le_eq_less_or_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> πk eq_up_to_sym km<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> km<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> path path_append_eq_up_to<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_sorted_list_of_cd'"><span class="command">lemma</span></span> cs_sorted_list_of_cd'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span> <span class="bound">i</span> <span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">k</span><span class="main">]</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">π</span> <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="skolem">k</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> j <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">note</span></span> j <span class="main">=</span> this
  <span class="keyword1"><span class="command">hence</span></span> csj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> map <span class="skolem">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">j</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">π</span> <span class="skolem">j</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.IH"</span> icd_is_the_icd<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">k</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> insert <span class="skolem">j</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">j</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdi_is_cd_icdi<span class="main">[</span><span class="operator">OF</span> j<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">j</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∉</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">j</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹sorted_list_of_set <span class="main">{</span> <span class="bound">i</span> <span class="main">.</span> <span class="skolem">k</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> insort <span class="skolem">j</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span> <span class="bound">i</span> <span class="main">.</span> <span class="skolem">j</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> sorted_list_of_set_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span>  <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">j</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">j</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹sorted_list_of_set <span class="main">{</span> <span class="bound">i</span> <span class="main">.</span> <span class="skolem">k</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span> <span class="bound">i</span> <span class="main">.</span> <span class="skolem">j</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="skolem">j</span><span class="main">]</span>›</span></span>  <span class="keyword1"><span class="command">using</span></span> insort_greater <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> map <span class="skolem">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span> <span class="bound">i</span> <span class="main">.</span> <span class="skolem">k</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> icd_cs j<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">π</span> <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="skolem">k</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">π</span> <span class="skolem">k</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cs_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span> <span class="bound">i</span> <span class="main">.</span> <span class="skolem">k</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> * excd_impl_exicd<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil list.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> sorted_list_of_set_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_sorted_list_of_cd"><span class="command">lemma</span></span> cs_sorted_list_of_cd<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="main">{</span> <span class="bound">i</span> <span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="bound">i</span><span class="main">}</span><span class="main">.</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="bound">i</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="free">k</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cs_sorted_list_of_cd'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span><span class="main">]</span> sorted_list_of_set_append<span class="main">[</span><span class="operator">OF</span> fin le<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_not_ipd"><span class="command">lemma</span></span> cs_not_ipd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span> <span class="main">∧</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="free">j</span>›</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">∧</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="bound">n</span><span class="main">←</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">.</span> ipd <span class="bound">n</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span><span class="main">]</span>›</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="var">?j</span> <span class="main">=</span> filter <span class="var">?P</span> <span class="main">_</span>›</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword1"><span class="command">have</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="main">{</span> <span class="bound">i</span> <span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cs_sorted_list_of_cd<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> csj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="var">?j</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="var">?j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?j</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cs_sorted_list_of_cd<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">j</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">∧</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> ipd<span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
  <span class="keyword1"><span class="command">have</span></span> kcdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="var">?j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ipd'<span class="main">:</span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="var">?j</span><span class="main">)</span> <span class="main">≠</span> ipd<span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> GreatestI_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span> bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   
  <span class="keyword1"><span class="command">have</span></span> greatest<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">⟹</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">≤</span> <span class="var">?j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Greatest_le_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span>›</span></span>  <span class="main">_</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span><span class="main">]</span> bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> less_not_ipdk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="var">?j</span> <span class="main">⟹</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span>   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ipd' kcdj same_ipd_stable<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> le_not_ipdk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">≤</span> <span class="var">?j</span> <span class="main">⟹</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kcdj ipd' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">‹<span class="improper">j</span> <span class="main">=</span> <span class="var">?j</span>›</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> insert <span class="var">?j</span> <span class="main">{</span> <span class="bound">i</span> <span class="main">.</span> <span class="var">?j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> ›</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> greatest cr_wn'' kcdj le_antisym le_refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> kcdj<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ipd'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> cd_trans kcdj<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="improper">x</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> is_cdi_def less_not_ipdk<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> cd_trans kcdj<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">{</span><span class="bound">i</span> <span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> filter_sorted_list_of_set<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="keyword1">o</span> <span class="free">π</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="bound">n</span><span class="main">←</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">.</span> ipd <span class="bound">n</span> <span class="main">≠</span> ipd<span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> csk filter_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span>  map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>insert <span class="var">?j</span> <span class="main">{</span> <span class="bound">i</span> <span class="main">.</span> <span class="var">?j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="var">?j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_ipd"><span class="command">lemma</span></span> cs_ipd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> ipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">m</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">n</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span>
<span class="keyword2"><span class="keyword">and</span></span> km<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span> <span class="main">=</span> <span class="main">[</span><span class="bound">n</span><span class="main">←</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">.</span> ipd <span class="bound">n</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">m</span><span class="main">]</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="free">m</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span>›</span></span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> jicd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">m</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> icd_cs<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">∧</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jicd assms ipd_icd_greatest_cd_not_ipd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def is_icdi_def is_ipd_def cd_not_pd ipd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ipd_is_ipd jicd path_nodes less_imp_le term_path_stable<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> cd_ipd_is_cd icd_imp_cd ipd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ipd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> j jicd<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">[</span><span class="bound">n</span><span class="main">←</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">.</span> ipd <span class="bound">n</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_not_ipd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span>›</span></span><span class="main">]</span> ipd<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> noicd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="free">m</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span><span class="main">)</span>›</span></span>  
  <span class="keyword1"><span class="command">hence</span></span> csm<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span> <span class="main">=</span> <span class="main">[</span><span class="free">π</span> <span class="free">m</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→<span class="bound">j</span> <span class="main">⟹</span> ipd<span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_is_cd_ipd<span class="main">[</span><span class="operator">OF</span> km ipd<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> excd_impl_exicd noicd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ipd<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ipd <span class="bound">n</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">o</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> csk <span class="main">=</span> cs_sorted_list_of_cd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="bound">n</span><span class="main">←</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">.</span> ipd <span class="bound">n</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">n</span><span class="main">←</span> <span class="main">(</span>map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> ipd <span class="bound">n</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">[</span><span class="bound">n</span> <span class="main">&lt;-</span> sorted_list_of_set <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span><span class="main">]</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_map **<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> * filter_sorted_list_of_set<span class="main">[</span><span class="operator">OF</span> fin<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ipd <span class="main">(</span><span class="free">π</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">m</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-converged_ipd_same_icd"><span class="command">lemma</span></span> converged_ipd_same_icd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>  converge<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">m'</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> icd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span>›</span></span>
<span class="keyword2"><span class="keyword">and</span></span> ipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">m'</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k'</span><span class="main">..&lt;</span><span class="free">m'</span><span class="main">}</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">n</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">l'</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">=</span> Suc <span class="free">k</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_icdi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π'</span> <span class="free">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> csk last_cs suc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹Suc <span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> ret_no_cd suc<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="free">k'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">using</span></span> path<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ipd_not_self le_Suc_eq le_antisym path_nodes term_path_stable<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="free">k'</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def <span class="keyword1"><span class="command">using</span></span> path<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span> <span class="main">@</span><span class="main">[</span><span class="free">π'</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icd_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">l</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icd icd_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> csk l suc<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> nsuck<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> Suc <span class="free">k</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> kk'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">k'</span> <span class="main">=</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> csk last_cs<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> kl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icd <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> skl<span class="main">:</span> <span class="quoted"><span class="quoted">‹Suc <span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessI nsuck<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> lpd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icd icd_pd_intermediate <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> km<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converge<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> kl order.strict_trans<span class="main">)</span>  
  <span class="keyword1"><span class="command">have</span></span> lcd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icd is_icdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> ipdk_pdl<span class="main">:</span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="main">(</span><span class="free">π</span> <span class="free">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ipd_pd_cd<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ipdk_pdl pd_node1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nretk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kl lcd path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ret_no_cd term_path_stable less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="free">π</span> <span class="free">l</span><span class="main">)</span> <span class="keyword1">pd→</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="keyword1">pd→</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="keyword1">pd→</span> <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ipd_def <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span> ipd_is_ipd ipdk_pdl path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path_nodes pd_antisym term_path_stable less_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="main">≠</span> <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> a ipd_not_self ipdk_pdl lcd pd_antisym ret_no_cd<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> lcd cd_not_pd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> km'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">&lt;</span> <span class="free">m'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> path csk converge<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nretk km<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span> 

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π''</span></span> <span class="skolem"><span class="skolem">n''</span></span> <span class="keyword2"><span class="keyword">where</span></span> path''<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π''</span>›</span></span>  <span class="keyword2"><span class="keyword">and</span></span> π''0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π''</span> <span class="main">0</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π''n<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π''</span> <span class="skolem">n''</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> notπl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">≤</span><span class="skolem">n''</span><span class="main">.</span> <span class="skolem">π''</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> no_pd_path<span class="main">[</span><span class="operator">OF</span> * **<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π'</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π'</span> @<span class="hidden">⇗</span><sup><span class="free">m'</span></sup><span class="hidden">⇖</span> <span class="skolem">π''</span><span class="main">)</span> <span class="main">«</span> Suc <span class="free">k'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="var">?π'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> π''0 ipd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path'' path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path_cons path_path_shift<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> km' suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π'</span> <span class="main">(</span><span class="free">m'</span> <span class="main">-</span> Suc <span class="free">k'</span> <span class="main">+</span> <span class="skolem">n''</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> π''n km' π''0 ipd<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l''</span></span> <span class="keyword2"><span class="keyword">where</span></span> l''<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l''</span> <span class="main">≤</span> <span class="free">m'</span> <span class="main">-</span> Suc <span class="free">k'</span> <span class="main">+</span> <span class="skolem">n''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π'</span> <span class="skolem">l''</span> <span class="main">=</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lpd <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> l''m<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l''</span> <span class="main">≤</span> <span class="free">m'</span> <span class="main">-</span> Suc <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> l'' notπl km' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span><span class="free">k'</span> <span class="main">+</span> <span class="skolem">l''</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m'</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l'</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span> <span class="free">k'</span> <span class="main">+</span> <span class="skolem">l''</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> lm'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?l'</span> <span class="main">≤</span> <span class="free">m'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> l''m km' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="comment1">― ‹Now we have found our desired l'›</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="var">?l'</span> <span class="main">=</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span>  l'' l''m lm' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">&lt;</span> <span class="var">?l'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?l'</span> <span class="main">&lt;</span> <span class="free">m'</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> lm' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="quoted">"**"</span> 1 ipd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ipdk_pdl<span class="main">)</span>  
  
  <span class="comment1">― ‹Need the least such l'›</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">λ</span> <span class="bound">l'</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">π</span> <span class="free">l</span> <span class="main">∧</span> <span class="free">k'</span> <span class="main">&lt;</span> <span class="bound">l'</span> <span class="main">∧</span> <span class="bound">l'</span> <span class="main">&lt;</span> <span class="free">m'</span>›</span></span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="var">?l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> l'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">==</span> <span class="keyword1">LEAST</span> <span class="bound">l'</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">l'</span>›</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> πl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">l'</span> <span class="main">=</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> l' 1 2 3 LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">have</span></span> kl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">&lt;</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> l' 1 2 3 LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> lm'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">&lt;</span> <span class="free">m'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> l' 1 2 3 LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  

  <span class="keyword1"><span class="command">have</span></span> nretl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">l'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> π''n πl' le_refl notπl<span class="main">)</span>
 
  <span class="keyword1"><span class="command">have</span></span> nipd'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k'</span><span class="main">..</span><span class="skolem">l'</span><span class="main">}</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">j</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π'</span> <span class="free">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lm' kk' ipd<span class="main">(</span>2<span class="main">)</span> kl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
 
  <span class="keyword1"><span class="command">have</span></span> lcd'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def kl' nipd' nretl' path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> licd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k'</span><span class="main">&lt;..&lt;</span><span class="skolem">l'</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">m</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k'</span><span class="main">&lt;..&lt;</span><span class="skolem">l'</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">m</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> kj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">&lt;</span> <span class="skolem">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="skolem">l'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lcdj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> jm'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span><span class="main">&lt;</span><span class="free">m'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> jl' lm' order.strict_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">j'</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> l' kj' jm' jl' Least_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>       
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">π'</span> <span class="skolem">l'</span> <span class="keyword1">pd→</span> <span class="free">π'</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_not_pd lcdj' πl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">j'</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword1"><span class="command">using</span></span> path<span class="main">(</span>2<span class="main">)</span> path_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> path<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π0<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">0</span> <span class="main">=</span> <span class="free">π'</span> <span class="skolem">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πn<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> nl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">l</span></span> <span class="main">≤</span><span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">l</span> <span class="main">≠</span> <span class="free">π'</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π''</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π'</span>@<span class="hidden">⇗</span><sup><span class="skolem">j'</span></sup><span class="hidden">⇖</span> <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">«</span> Suc <span class="free">k'</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="var">?π''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> π0<span class="hidden">⇩</span><sub>1</sub> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path<span class="hidden">⇩</span><sub>1</sub> path_cons path_path_shift<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π''</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> kj' less_eq_Suc_le suc<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> kj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹Suc <span class="free">k'</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kj' less_eq_Suc_le<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π''</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> Suc <span class="free">k'</span> <span class="main">+</span> <span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> π0<span class="hidden">⇩</span><sub>1</sub> πn<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l''</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?π''</span> <span class="skolem">l''</span> <span class="main">=</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l''</span> <span class="main">≤</span><span class="skolem">j'</span> <span class="main">-</span> Suc <span class="free">k'</span> <span class="main">+</span> <span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lpd is_pd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l''</span> <span class="main">≤</span> <span class="skolem">j'</span> <span class="main">-</span> Suc <span class="free">k'</span>›</span></span>        
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span><span class="skolem">l''</span> <span class="main">+</span> Suc <span class="free">k'</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * kj' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Nat.le_diff_conv2 add_Suc diff_add_inverse le_add1 le_add_diff_inverse2<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l''</span> <span class="main">+</span> Suc <span class="free">k'</span> <span class="main">&lt;</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a jl' add_diff_cancel_right' kj' le_add_diff_inverse less_imp_diff_less ordered_cancel_comm_monoid_diff_class.le_diff_conv2<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l''</span> <span class="main">+</span> Suc <span class="free">k'</span> <span class="main">&lt;</span> <span class="free">m'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessD calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_trans_Suc lm'<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">&lt;</span> <span class="skolem">l''</span> <span class="main">+</span> Suc <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l''</span> <span class="main">+</span> Suc <span class="free">k'</span>›</span></span><span class="main">]</span> l' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">l''</span> <span class="main">≤</span> <span class="skolem">j'</span> <span class="main">-</span> Suc <span class="free">k'</span>›</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Suc <span class="main">(</span><span class="free">k'</span> <span class="main">+</span> <span class="skolem">l''</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">k'</span> <span class="main">+</span> <span class="skolem">l''</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * kj' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
        <span class="keyword1"><span class="command">moreover</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span><span class="free">k'</span> <span class="main">+</span> <span class="skolem">l''</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">j'</span> <span class="main">≤</span> <span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ** kj' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> nl' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> πl'<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def <span class="keyword1"><span class="command">using</span></span> lcd' path<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span> <span class="main">@</span> <span class="main">[</span><span class="free">π'</span> <span class="skolem">l'</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> icd_cs<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> πl' csk icd icd_cs<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-converged_same_icd"><span class="command">lemma</span></span> converged_same_icd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> converge<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> icd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span>›</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">l'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  
  <span class="keyword1"><span class="command">have</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> icd <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def is_cdi_def <span class="keyword1"><span class="command">using</span></span> term_path_stable less_imp_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">have</span></span> kl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icd <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> kn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> converge kl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> path_ipd_swap<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nret kn<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> pathρ<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">ρ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πρ<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span>  <span class="skolem">ρ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> km<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">m</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ</span> <span class="skolem">m</span> <span class="main">=</span> ipd <span class="main">(</span><span class="skolem">ρ</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..&lt;</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span> <span class="skolem">ρ</span> <span class="bound">l</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="skolem">ρ</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> csk1<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">ρ</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_swap_le path pathρ πρ kn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sucρ<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> πρ eq_up_to_def kn less_eq_Suc_le<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> nret'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">k'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> csk last_cs nret<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> kn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">&lt;</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> path csk converge<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nret kn<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> path_ipd_swap<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nret' kn'<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ'</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> pathρ'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">ρ'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πρ'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> =<span class="hidden">⇘</span><sub><span class="free">n'</span></sub><span class="hidden">⇙</span> <span class="skolem">ρ'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> km'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">&lt;</span> <span class="skolem">m'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ipd'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ'</span> <span class="skolem">m'</span> <span class="main">=</span> ipd <span class="main">(</span><span class="skolem">ρ'</span> <span class="free">k'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k'</span><span class="main">..&lt;</span><span class="skolem">m'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">ρ'</span> <span class="bound">l</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="skolem">ρ'</span> <span class="free">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> csk1'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">ρ'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_swap_le path pathρ' πρ' kn' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sucρ'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ'</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> πρ' eq_up_to_def kn' less_eq_Suc_le<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> icdρ<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> icd<span class="hidden">⇗</span><sup><span class="skolem">ρ</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icdi_path_swap_le<span class="main">[</span><span class="operator">OF</span> pathρ icd πρ<span class="main">]</span> converge <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> lm<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">&lt;</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ipd<span class="main">(</span>1<span class="main">)</span> icdρ km <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> csk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">ρ</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">ρ'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csk1 csk1' csk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">hence</span></span> kk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ'</span> <span class="free">k'</span> <span class="main">=</span> <span class="skolem">ρ</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> suc'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ρ'</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> suc sucρ sucρ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> mm'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ'</span> <span class="skolem">m'</span> <span class="main">=</span> <span class="skolem">ρ</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ipd<span class="main">(</span>1<span class="main">)</span> ipd'<span class="main">(</span>1<span class="main">)</span> kk' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> cs_ipd<span class="main">[</span><span class="operator">OF</span> ipd km<span class="main">]</span> cs_ipd<span class="main">[</span><span class="operator">OF</span> ipd' km'<span class="main">,</span><span class="operator">unfolded</span> mm'<span class="main">,</span> <span class="operator">folded</span> csk'<span class="main">]</span>  
  <span class="keyword1"><span class="command">have</span></span> csm<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">ρ</span></sup><span class="hidden">⇖</span> <span class="skolem">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">ρ'</span></sup><span class="hidden">⇖</span> <span class="skolem">m'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">from</span></span> converged_ipd_same_icd<span class="main">[</span><span class="operator">OF</span> pathρ pathρ' lm  csm csk' icdρ suc' ipd'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> kk'<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csl<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">ρ</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">ρ'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1"><span class="command">have</span></span> cslρ<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">ρ</span></sup><span class="hidden">⇖</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> πρ converge<span class="main">(</span>1<span class="main">)</span> cs_path_swap_le less_imp_le_nat path<span class="main">(</span>1<span class="main">)</span> pathρ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

  <span class="keyword1"><span class="command">have</span></span> nretl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ</span> <span class="free">l</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> icdρ icd_imp_cd ret_no_cd<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> csn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">ρ</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">ρ'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> converge<span class="main">(</span>2<span class="main">)</span> cs_path_swap path pathρ pathρ' πρ πρ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> ln'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">&lt;</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> pathρ pathρ' csl csn' nretl converge<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    
  <span class="keyword1"><span class="command">have</span></span> cslρ'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">ρ'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_swap_le<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> pathρ' πρ'<span class="main">]</span> ln' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> csl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cslρ cslρ' csl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cd_is_cs_less"><span class="command">lemma</span></span> cd_is_cs_less<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">≺</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> csl<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">@</span><span class="main">[</span><span class="free">π</span> <span class="free">l</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_in_cs<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">‹length<span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> take<span class="main">:</span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span>length <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_less.intros<span class="main">[</span><span class="operator">OF</span> len take<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_select_id"><span class="command">lemma</span></span> cs_select_id<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">≠</span> return›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span><span class="main">¡</span>cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">=</span> <span class="free">k</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">i</span> <span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span>  <span class="main">⟹</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_inj<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="var">?k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cs_select_def <span class="keyword1"><span class="command">using</span></span> theI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">=</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_single_nocd"><span class="command">lemma</span></span> cs_single_nocd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">i</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms cs_not_nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> excd_impl_exicd<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_single_pd_intermed"><span class="command">lemma</span></span> cs_single_pd_intermed<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> <span class="main">[</span><span class="free">π</span> <span class="free">n</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span><span class="main">.</span> <span class="main">¬</span> <span class="free">n</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cs_single_nocd icd_imp_cd<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> no_icd_pd<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="IFC-cs_first_pd"><span class="command">lemma</span></span> cs_first_pd<span class="main">:</span>  <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> pd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> first<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="free">π</span> <span class="bound">l</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> <span class="main">[</span><span class="free">π</span> <span class="free">n</span><span class="main">]</span>›</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cs_cases first first_pd_no_cd icd_imp_cd path pd<span class="main">)</span>

<span class="keyword1" id="IFC-converged_pd_cs_single"><span class="command">lemma</span></span> converged_pd_cs_single<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>  converge<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">m'</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> π0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> mpdl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">m</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csl<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> <span class="main">[</span><span class="free">π</span> <span class="free">l</span><span class="main">]</span>›</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">l'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="keyword1">pd→</span> <span class="free">π'</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_single_pd_intermed<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> csl<span class="main">]</span> π0<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> πm<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">m</span> <span class="main">=</span> <span class="free">π'</span> <span class="free">m'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converge<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> last_cs<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">m'</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> mpdl <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> lm'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">≤</span> <span class="free">m'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πl<span class="main">:</span>  <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">l'</span> <span class="main">=</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">l'</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> path_pd_pd0<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ** *<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">l'</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">π</span> <span class="free">l</span><span class="main">)</span>›</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> πl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="var">?l</span> <span class="main">=</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">,</span><span class="operator">OF</span> πl<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span><span class="var">?l</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span><span class="var">?l</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">π'</span> <span class="var">?l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> πl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="var">?l</span> <span class="keyword1">pd→</span> <span class="free">π'</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * πl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="var">?l</span> <span class="main">=</span> <span class="main">[</span><span class="free">π'</span> <span class="var">?l</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_first_pd<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csl πl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-converged_cs_single"><span class="command">lemma</span></span> converged_cs_single<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>  converge<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">m'</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> π0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csl<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> <span class="main">[</span><span class="free">π</span> <span class="free">l</span><span class="main">]</span>›</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">l'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="main">=</span> return›</span></span>  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">m</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converge<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> term_path_stable less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span> <span class="main">=</span> <span class="main">[</span>return<span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">m'</span> <span class="main">=</span> <span class="main">[</span>return<span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> converge <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> <span class="main">[</span>return<span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * cs_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="main">≠</span> return›</span></span>
  <span class="keyword1"><span class="command">have</span></span> πm<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">m</span> <span class="main">=</span> <span class="free">π'</span> <span class="free">m'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converge<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> last_cs<span class="main">)</span>
  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> path1<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> upto<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> =<span class="hidden">⇘</span><sub><span class="free">m</span></sub><span class="hidden">⇙</span> <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">n</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> path<span class="main">(</span>1<span class="main">)</span> path_swap_ret <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> path1'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub>'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> upto'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> =<span class="hidden">⇘</span><sub><span class="free">m'</span></sub><span class="hidden">⇙</span>  <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub>'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">n'</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> path<span class="main">(</span>2<span class="main">)</span> path_swap_ret <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> π1l<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">l</span> <span class="main">=</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> upto converge<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_up_to_def nat_less_le<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> cs1l<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_swap_le upto path1 path<span class="main">(</span>1<span class="main">)</span> converge<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> csl1<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">l</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> π1l cs1l csl<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> converge1<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub>'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> πn πn' cs_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> ln<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nret πn π1l term_path_stable<span class="main">[</span><span class="operator">OF</span> path1 πn<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> linorder_neqE_nat less_imp_le<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> π01<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> π0 eq_up_to_apply<span class="main">[</span><span class="operator">OF</span> upto<span class="main">]</span> eq_up_to_apply<span class="main">[</span><span class="operator">OF</span> upto'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> pd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">n</span> <span class="keyword1">pd→</span> <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> πn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path1 path_nodes return_pd<span class="main">)</span>
  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csl<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub>'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> converged_pd_cs_single<span class="main">[</span><span class="operator">OF</span> path1 path1' ln converge1 π01 pd csl1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> cs1m<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span></sup><span class="hidden">⇖</span> <span class="free">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_swap upto path1 path<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cs1m'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub>'</span></sup><span class="hidden">⇖</span> <span class="free">m'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">m'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_swap upto' path1' path<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> converge1<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span></sup><span class="hidden">⇖</span> <span class="free">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub>'</span></sup><span class="hidden">⇖</span> <span class="free">m'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> converge<span class="main">(</span>2<span class="main">)</span> cs1m <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
  <span class="keyword1"><span class="command">have</span></span> nret1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">l</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> nret π1l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> lm'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">&lt;</span> <span class="free">m'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> path1 path1' csl converge1 nret1 converge<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub>'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_swap_le<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path1' upto'<span class="main">]</span> lm' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span></sup><span class="hidden">⇖</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_swap_le<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path1 upto<span class="main">]</span> converge<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-converged_cd_same_suc"><span class="command">lemma</span></span> converged_cd_same_suc<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">0</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> cd_suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span> <span class="bound">k'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">k'</span> <span class="main">∧</span> <span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span> <span class="main">⟶</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="bound">k'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> converge<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">m'</span>›</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">l'</span>›</span></span>
<span class="keyword1"><span class="command">using</span></span> path init cd_suc converge <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cs_induct<span class="main"><span class="keyword3">,</span></span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cs <span class="skolem">π</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">l</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">THE</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">l</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> icd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="var">?k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> icd_is_the_icd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> lcdk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="var">?k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_icdi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> kl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span><span class="main">&lt;</span><span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?k</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">⟹</span> <span class="skolem">l</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icd cd_trans is_icdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">hence</span></span> suc'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">j</span> <span class="bound">j'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span> <span class="main">∧</span> <span class="var">?k</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">⟶</span> <span class="skolem">π</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> cs.IH<span class="main">[</span><span class="operator">OF</span> * cs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cs<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> suc'<span class="main">]</span> cs.prems kl 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">k'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">l</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">k'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessD less_trans_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="var">?k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1"><span class="command">have</span></span> suc2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="var">?k</span><span class="main">)</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs.prems<span class="main">(</span>4<span class="main">)</span> lcdk csk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> km<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kl cs.prems<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">from</span></span> converged_same_icd<span class="main">[</span><span class="operator">OF</span> cs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cs.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> cs.prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> csk icd suc2<span class="main">]</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cs <span class="skolem">π</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">l</span> icd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">π</span> <span class="skolem">l</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> cs converged_cs_single
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-converged_cd_diverge"><span class="command">lemma</span></span> converged_cd_diverge<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> notin<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">l'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> converge<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">m'</span>›</span></span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="free">k'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">using</span></span> assms converged_cd_same_suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>



<span class="keyword1" id="IFC-converged_cd_same_suc_return"><span class="command">lemma</span></span> converged_cd_same_suc_return<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">0</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> cd_suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span> <span class="bound">k'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">k'</span> <span class="main">∧</span> <span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span> <span class="main">⟶</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="bound">k'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">n'</span> <span class="main">=</span> return›</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">l'</span>›</span></span><span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="main">=</span> return›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ret cs_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> nretl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="main">≠</span> return›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="main">∈</span> nodes›</span></span> <span class="keyword1"><span class="command">using</span></span> path path_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">πl</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> ipl<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">πl</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πl<span class="main">:</span>  <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="main">=</span> <span class="skolem">πl</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> retn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">πl</span> <span class="skolem">n</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> notl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="skolem">πl</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> direct_path_return nretl<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ip<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> retl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> nl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="free">l</span><span class="main">.</span> <span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span><span class="main">)</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">π</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path_cons<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ipl πl<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> π0'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">0</span>›</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> cs_0 <span class="keyword1"><span class="command">using</span></span>  πl π0  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> csn<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span></sup><span class="hidden">⇖</span>  <span class="main">(</span><span class="free">l</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ret retl cs_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> eql<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span><span class="main">)</span> =<span class="hidden">⇘</span><sub><span class="free">l</span></sub><span class="hidden">⇙</span> <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_append_eq_up_to<span class="main">)</span>    

  <span class="keyword1"><span class="command">have</span></span> csl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span></sup><span class="hidden">⇖</span>  <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> eql cs_path_swap ip path<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nretl<span class="main">[</span><span class="operator">unfolded</span> πl<span class="main">]</span> retn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> neq0_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ln<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">+</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">k</span> <span class="bound">k'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span></sup><span class="hidden">⇖</span>  <span class="bound">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">k'</span> <span class="main">∧</span> <span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span></sup><span class="hidden">⇖</span>→ <span class="bound">k</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="bound">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main">)</span>  
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">k'</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span></sup><span class="hidden">⇖</span>  <span class="skolem">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span> <span class="main">∧</span> <span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> kl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span> <span class="main">∧</span> <span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> eql * cs_path_swap_le<span class="main">[</span><span class="operator">OF</span> ip path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eql<span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span>›</span></span><span class="main">]</span> cdi_path_swap_le<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ eql<span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_swap_le<span class="main">[</span><span class="operator">OF</span> ip path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eql<span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">k</span>›</span></span><span class="main">]</span> kl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span></sup><span class="hidden">⇖</span>  <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> converged_cd_same_suc<span class="main">[</span><span class="operator">OF</span> ip path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> π0' * ln csn<span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span></sup><span class="hidden">⇖</span>  <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> eql <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cs_path_swap ip path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-converged_cd_diverge_return"><span class="command">lemma</span></span> converged_cd_diverge_return<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">0</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> notin<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">l'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">m'</span> <span class="main">=</span> return›</span></span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="free">k'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> converged_cd_same_suc_return<span class="main">[</span><span class="operator">OF</span> path init _ ret<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span>›</span></span><span class="main">]</span> notin <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="IFC-returned_missing_cd_or_loop"><span class="command">lemma</span></span> returned_missing_cd_or_loop<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">0</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> notin'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="main">(</span><span class="main">∃</span> <span class="bound">k'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">k'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">n'</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">n'</span> <span class="main">≠</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="free">i'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span><span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="free">i'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">i</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j'</span></span><span class="main">&gt;</span> <span class="free">i'</span><span class="main">.</span> <span class="bound">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="free">i'</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> icdf<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i'</span><span class="main">)</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">f</span> <span class="bound">i'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ran<span class="main">:</span> <span class="quoted"><span class="quoted">‹range <span class="skolem">f</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i'</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j'</span></span><span class="main">&gt;</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">i'</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> icdf0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">0</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">i'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path<span class="main">(</span>2<span class="main">)</span> path_nret_inf_icd_seq nret <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> niπ<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">note</span></span> converged_cd_diverge_return<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> π0<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> niπ ret<span class="main">]</span> that
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> div<span class="main">:</span>  <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">∈</span> range <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdj <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icdf0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> icdfj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">f</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icdf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icdfj  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> icd_uniq<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_impl_icd_cd<span class="main">[</span><span class="operator">OF</span> Suc.prems icdfj<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> alldep<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i'</span></span><span class="main">&gt;</span><span class="skolem">k'</span><span class="main">.</span> <span class="bound">i'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ran <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">with</span></span> alldep that<span class="main">[</span><span class="operator">OF</span> _ csk div<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> ki<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">≤</span><span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≠</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> notin' csk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> ki'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">&lt;</span><span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ki <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ka</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">ka</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">ka</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">ka</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> converged_cd_diverge<span class="main">[</span><span class="operator">OF</span> path π0 notin' ki' csk<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ka</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="main">(</span><span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> allin<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f'</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">f'</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">f'</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">have</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f' <span class="keyword1"><span class="command">using</span></span> allin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> someI_ex<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> cssuci<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="skolem">f'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f' <span class="keyword1"><span class="command">using</span></span> allin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> someI_ex<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icdf <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">f</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> icdf <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> nreti<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_not_ret<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f'</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">f'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csi cssuci nreti fi<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> kle<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">f'</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> mono_ge_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f'</span>›</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="free">k</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> cssk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="skolem">f'</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f' <span class="keyword1"><span class="command">using</span></span> allin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> someI_ex<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ka</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">ka</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">ka</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">ka</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> converged_cd_diverge<span class="main">[</span><span class="operator">OF</span> path π0 notin' kle cssk<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ka</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-missing_cd_or_loop"><span class="command">lemma</span></span> missing_cd_or_loop<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> notin'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="main">(</span><span class="main">∃</span> <span class="bound">k'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">k'</span><span class="main">)</span>›</span></span>  
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="free">i'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="free">i'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">i</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j'</span></span><span class="main">&gt;</span> <span class="free">i'</span><span class="main">.</span> <span class="bound">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="free">i'</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">n'</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">n'</span> <span class="main">=</span> return›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> retn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">n'</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> converged_cd_diverge_return<span class="main">[</span><span class="operator">OF</span> path π0 notin' retn<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ka</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">ka</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">ka</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">ka</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ka</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">n'</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">n'</span> <span class="main">=</span> return<span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> notret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">n'</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">n'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">πl</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> ipl<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">πl</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> πl<span class="main">:</span>  <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">=</span> <span class="skolem">πl</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> retn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">πl</span> <span class="skolem">n</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> reaching_ret path<span class="main">(</span>1<span class="main">)</span> path_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> ip<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="skolem">πl</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="skolem">πl</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="free">π</span> <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> retl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="skolem">πl</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> path_cons<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ipl πl<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> π0'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="skolem">πl</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">0</span>›</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> cs_0 <span class="keyword1"><span class="command">using</span></span>  πl π0  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> eql<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="skolem">πl</span><span class="main">)</span> =<span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_append_eq_up_to<span class="main">)</span>    

  <span class="keyword1"><span class="command">have</span></span> csl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="skolem">πl</span></sup><span class="hidden">⇖</span>  <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> eql cs_path_swap ip path<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
  <span class="keyword1"><span class="command">hence</span></span> notin<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="main">(</span><span class="main">∃</span> <span class="bound">k'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="skolem">πl</span></sup><span class="hidden">⇖</span>  <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> notin' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="skolem">πl</span></sup><span class="hidden">⇖</span>  <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> suci<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> @<span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="skolem">πl</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>›</span></span>  <span class="keyword2"><span class="keyword">and</span></span> cdloop<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span>@<span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="skolem">πl</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j'</span></span><span class="main">&gt;</span><span class="skolem">i'</span><span class="main">.</span> <span class="bound">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i'</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> returned_missing_cd_or_loop<span class="main">[</span><span class="operator">OF</span> ip path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> π0' notin notret retl<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> notin csi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csi cs_path_swap_le<span class="main">[</span><span class="operator">OF</span> ip path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eql<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ik eq_up_to_apply<span class="main">[</span><span class="operator">OF</span> eql<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i</span>›</span></span><span class="main">]</span> suci <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j'</span></span><span class="main">&gt;</span><span class="skolem">i'</span><span class="main">.</span> <span class="bound">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdloop cdi_path_swap_le<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ eql<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="IFC-path_shift_set_cd"><span class="command">lemma</span></span> path_shift_set_cd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">k</span> <span class="main">+</span> <span class="bound">j</span><span class="main">|</span> <span class="bound">j</span> <span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">}</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span><span class="main">{</span><span class="free">k</span><span class="main">+</span><span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span> <span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">}</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span><span class="main">+</span><span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_path_shift<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span><span class="main">{</span> <span class="bound">i</span><span class="main">.</span> <span class="free">k</span><span class="main">+</span><span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span><span class="main">{</span> <span class="bound">i</span><span class="main">.</span> <span class="free">k</span><span class="main">+</span><span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">}</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span><span class="main">+</span><span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_Suc_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span><span class="main">+</span><span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_path_shift<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span><span class="main">{</span><span class="free">k</span><span class="main">+</span><span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span> <span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_path_shift_set_cd"><span class="command">lemma</span></span> cs_path_shift_set_cd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">k</span><span class="main">+</span><span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span><span class="main">]</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">n</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">⟶</span> <span class="free">k</span> <span class="main">+</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">+</span> <span class="bound">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span> <span class="main">«</span> <span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">k</span><span class="main">+</span><span class="bound">x</span><span class="main">)</span><span class="main">`</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">k</span> <span class="main">+</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> map <span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="free">n</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_sorted_list_of_cd' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">k</span><span class="main">+</span><span class="bound">x</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">k</span><span class="main">+</span><span class="bound">x</span><span class="main">)</span><span class="main">`</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> sorted_list_of_set_map_mono<span class="main">[</span><span class="operator">OF</span> mono fin<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="main">{</span><span class="free">k</span> <span class="main">+</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">k</span><span class="main">+</span><span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path_shift_set_cd<span class="main">[</span><span class="operator">OF</span> path<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_split_shift_cd"><span class="command">lemma</span></span> cs_split_shift_cd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">j'</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j'</span> <span class="main">⟶</span> <span class="bound">j'</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">@</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">k</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">j</span><span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">}</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span> <span class="main">.</span> <span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">j</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>›</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> cd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ik<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span> <span class="main">.</span> <span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">j</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cdi_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cd cdi_prefix nat_less_le<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> ik cd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span> <span class="main">.</span> <span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">j</span><span class="main">}</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i</span> <span class="main">∨</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> cd_trans<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> diff_diff_cancel diff_is_0_eq le_refl le_trans nat_less_le<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">n</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_sorted_list_of_cd' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">n</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span><span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">n</span><span class="main">]</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_list_of_set_append<span class="main">[</span><span class="operator">OF</span> _ _ le<span class="main">]</span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">n</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">@</span> <span class="main">(</span>map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">n</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">using</span></span> cs_sorted_list_of_cd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">@</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_shift_set_cd<span class="main">[</span><span class="operator">OF</span> path<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span><span class="main">-</span><span class="free">k</span>›</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_split_shift_nocd"><span class="command">lemma</span></span> cs_split_shift_nocd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">⟶</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">j</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">k</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">j</span><span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">}</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">n</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_sorted_list_of_cd' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">n</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> map <span class="free">π</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">n</span><span class="main">]</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_shift_set_cd<span class="main">[</span><span class="operator">OF</span> path<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span><span class="main">-</span><span class="free">k</span>›</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-shifted_cs_eq_is_eq"><span class="command">lemma</span></span> shifted_cs_eq_is_eq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> path <span class="main">=</span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> csk <span class="main">=</span> assms<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> csn <span class="main">=</span> assms<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="main">≠</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> nretkn<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> return›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="free">n'</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> last_cs assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span><span class="free">k'</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ne 1 cs_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> nretk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> term_path_stable<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">+</span><span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nretkn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> <span class="main">=</span> return›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="free">n'</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> last_cs assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ne 1 cs_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> nretk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">k'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> term_path_stable<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">+</span><span class="free">n'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span>    
    <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="main">0</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> last_cs path_shift_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> monoid_add_class.add.right_neutral<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="main">0</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 1 cs_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> n0'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_inj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span><span class="main">«</span><span class="free">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span>›</span></span> <span class="main">]</span> * assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_shift_def assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> last_cs nretkn path_path_shift<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ne * assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> n0'<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">n'</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n'</span>›</span></span>    
    <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="main">0</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> last_cs path_shift_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> monoid_add_class.add.right_neutral<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="main">0</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 1 cs_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_inj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span><span class="main">«</span><span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span>›</span></span> <span class="main">]</span> * assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_shift_def assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> last_cs nretkn path_path_shift<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ne * assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> cdleswap'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">j'</span></span><span class="main">&lt;</span><span class="free">k'</span><span class="main">.</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">j'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">∧</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j'</span> <span class="keyword3"><span class="command">assume</span></span> jk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span><span class="main">&lt;</span><span class="free">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ncdj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">∧</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> kcdj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cr_wn' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> kcdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csk cs_path_swap_cd path <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">hence</span></span> jk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">have</span></span> ncdn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ne csj jk <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> lnocd'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">=</span> <span class="free">n'</span> <span class="main">∨</span> <span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cslsing'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="skolem">l'</span><span class="main">]</span>›</span></span>        
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="free">n'</span><span class="main">]</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span> <span class="main">≠</span> <span class="main">[</span><span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="free">n'</span><span class="main">]</span>›</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">@</span><span class="skolem">ys</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="free">n'</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil cs_length_g_one cs_length_one<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> neq_Nil_conv<span class="main">)</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cdl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span><span class="main">«</span><span class="free">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span>›</span></span> <span class="quoted"><span class="quoted">‹Nil›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="skolem">l'</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> last_cs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last.simps<span class="main">)</span> 
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that cdl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> ln'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span><span class="main">≤</span><span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> lcdj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span><span class="main">+</span><span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jk' ncdj'  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_le_cancel_left cdi_prefix trans_less_add1<span class="main">)</span>
            
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> lnocd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∨</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csl<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lnocd' <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">=</span> <span class="free">n'</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l'</span>›</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_swap_cd path csn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_path_shift<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      
      <span class="keyword1"><span class="command">have</span></span> cslsing<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="skolem">l</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cslsing' last_cs csl last.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      
      <span class="keyword1"><span class="command">have</span></span> ln<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≤</span><span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lnocd <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> nretkl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> term_path_stable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="free">n</span>›</span></span><span class="main">]</span> nretkn path<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
      
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l</span> <span class="main">⟹</span> <span class="free">k</span><span class="main">+</span><span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span><span class="main">+</span><span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_path_shift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="free">n</span>›</span></span><span class="main">]</span> path<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">have</span></span> ncdl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="skolem">l</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span> <span class="keyword1"><span class="command">using</span></span> lnocd <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span> <span class="keyword1"><span class="command">using</span></span> ncdn <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">using</span></span> cd_trans ncdn * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
      
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">i</span><span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">..</span><span class="free">k</span><span class="main">+</span><span class="skolem">l</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">i</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">using</span></span> path<span class="main">(</span>1<span class="main">)</span> jk nretkl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">i</span><span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">&lt;..</span><span class="free">k</span><span class="main">+</span><span class="skolem">l</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">i</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kcdj <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> ki<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> il<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="free">k</span><span class="main">+</span><span class="skolem">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ipdi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">i</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i</span><span class="main">-</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">-</span><span class="free">k</span> <span class="main">≤</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> pd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="skolem">l</span> <span class="keyword1">pd→</span> ipd <span class="main">(</span><span class="free">π</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_single_pd_intermed<span class="main">[</span><span class="operator">OF</span> _ cslsing<span class="main">]</span> path<span class="main">(</span>1<span class="main">)</span> path_path_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span><span class="free">k'</span> <span class="main">+</span> <span class="skolem">l'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csl last_cs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_shift_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">π'</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csj last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="skolem">l'</span><span class="main">)</span> <span class="keyword1">pd→</span> ipd <span class="main">(</span><span class="free">π'</span> <span class="skolem">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π'</span> <span class="skolem">j'</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="free">π'</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="skolem">l'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ipd_pd_cd<span class="main">[</span><span class="operator">OF</span> lcdj'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="skolem">l'</span><span class="main">)</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π'</span> <span class="skolem">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pd_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdj' <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="comment1">― ‹Symmetric version of the above statement›</span>
  <span class="keyword1"><span class="command">have</span></span> cdleswap<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j'</span></span><span class="main">&lt;</span><span class="free">k'</span><span class="main">.</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">j'</span> <span class="main">∧</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> jk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span><span class="main">&lt;</span><span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ncdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j'</span></span><span class="main">&lt;</span><span class="free">k'</span><span class="main">.</span> <span class="free">k'</span> <span class="main">+</span> <span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">j'</span> <span class="main">∧</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> kcdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cr_wn' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> kcdj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csk cs_path_swap_cd path <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">hence</span></span> jk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">have</span></span> ncdn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ne csj jk' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> lnocd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∨</span> <span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cslsing<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="skolem">l</span><span class="main">]</span>›</span></span>        
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="free">n</span><span class="main">]</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">[</span><span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="free">n</span><span class="main">]</span>›</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">@</span><span class="skolem">ys</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="free">n</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil cs_length_g_one cs_length_one<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> neq_Nil_conv<span class="main">)</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cdl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span><span class="main">«</span><span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹Nil›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="skolem">l</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> last_cs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last.simps<span class="main">)</span> 
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that cdl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> ln<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≤</span><span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> lcdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="skolem">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jk ncdj  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_le_cancel_left cdi_prefix trans_less_add1<span class="main">)</span>
            
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> lnocd'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">=</span> <span class="free">n'</span> <span class="main">∨</span> <span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csl<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lnocd <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">=</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l</span>›</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l'</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_swap_cd path csn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_path_shift<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      
      <span class="keyword1"><span class="command">have</span></span> cslsing'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="skolem">l'</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cslsing last_cs csl last.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      
      <span class="keyword1"><span class="command">have</span></span> ln'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span><span class="main">≤</span><span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lnocd' <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> nretkl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span><span class="free">k'</span> <span class="main">+</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> term_path_stable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span><span class="main">+</span><span class="skolem">l'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span><span class="main">+</span><span class="free">n'</span>›</span></span><span class="main">]</span> nretkn' path<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
      
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l'</span> <span class="main">⟹</span> <span class="free">k'</span><span class="main">+</span><span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="free">k'</span><span class="main">+</span><span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_path_shift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span><span class="main">+</span><span class="skolem">l'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span><span class="main">+</span><span class="free">n'</span>›</span></span><span class="main">]</span> path<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">have</span></span> ncdl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="skolem">l'</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span> <span class="keyword1"><span class="command">using</span></span> lnocd' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span> <span class="keyword1"><span class="command">using</span></span> ncdn' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">using</span></span> cd_trans ncdn' * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
      
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">i'</span><span class="main">∈</span> <span class="main">{</span><span class="skolem">j'</span><span class="main">..</span><span class="free">k'</span><span class="main">+</span><span class="skolem">l'</span><span class="main">}</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">i'</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π'</span> <span class="skolem">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">using</span></span> path<span class="main">(</span>2<span class="main">)</span> jk' nretkl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">i'</span><span class="main">∈</span> <span class="main">{</span><span class="free">k'</span><span class="main">&lt;..</span><span class="free">k'</span><span class="main">+</span><span class="skolem">l'</span><span class="main">}</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">i'</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π'</span> <span class="skolem">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kcdj' <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ki'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> il'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="free">k'</span><span class="main">+</span><span class="skolem">l'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ipdi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">i'</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π'</span> <span class="skolem">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i'</span><span class="main">-</span><span class="free">k'</span><span class="main">)</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π'</span> <span class="skolem">j'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span><span class="main">-</span><span class="free">k'</span> <span class="main">≤</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> pd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="skolem">l'</span> <span class="keyword1">pd→</span> ipd <span class="main">(</span><span class="free">π'</span> <span class="skolem">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_single_pd_intermed<span class="main">[</span><span class="operator">OF</span> _ cslsing'<span class="main">]</span> path<span class="main">(</span>2<span class="main">)</span> path_path_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="skolem">l'</span> <span class="main">=</span> <span class="free">π</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csl last_cs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_shift_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">j'</span> <span class="main">=</span> <span class="free">π</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csj last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="skolem">l</span><span class="main">)</span> <span class="keyword1">pd→</span> ipd <span class="main">(</span><span class="free">π</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹ipd <span class="main">(</span><span class="free">π</span> <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">pd→</span> <span class="free">π</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="skolem">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ipd_pd_cd<span class="main">[</span><span class="operator">OF</span> lcdj<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pd_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdj <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> cdle<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> allge<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">⟶</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> allge'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j'</span><span class="main">.</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">j'</span> <span class="main">⟶</span> <span class="free">k'</span> <span class="main">≤</span> <span class="bound">j'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j'</span> 
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">+</span> <span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">k'</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span><span class="main">&lt;</span><span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdleswap' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_neq_implies_less nat_le_linear<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> allge <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span> <span class="main">«</span> <span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_split_shift_nocd<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ allge<span class="main">]</span> n0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k'</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span> <span class="main">«</span> <span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_split_shift_nocd<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ allge'<span class="main">]</span> n0' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ne assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">==</span> <span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span>  
  <span class="keyword1"><span class="command">have</span></span> cdj<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jge<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">j'</span></span><span class="main">&lt;</span> <span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j'</span> <span class="main">⟶</span> <span class="bound">j'</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> GreatestI_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">]</span> j_def bound cdle <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> GreatestI_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">]</span> bound j_def cdle <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">j'</span></span><span class="main">&lt;</span> <span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j'</span> <span class="main">⟶</span> <span class="bound">j'</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Greatest_le_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">]</span> bound j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
    
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> cdj'<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j'</span>›</span></span>  <span class="keyword2"><span class="keyword">and</span></span> jk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdleswap cdj jk <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> jge'<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i'</span></span><span class="main">&lt;</span> <span class="free">k'</span><span class="main">.</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">i'</span> <span class="main">⟶</span> <span class="bound">i'</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span>
    <span class="keyword3"><span class="command">assume</span></span> ik'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="free">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cdi'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">+</span> <span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i'</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> cdi<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹ cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">&lt;</span><span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdleswap' <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
    <span class="keyword1"><span class="command">have</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jge cdi ik <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order_le<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> csi<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> csj _ ij<span class="main">]</span> cd_not_ret<span class="main">[</span><span class="operator">OF</span> cdi<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">@</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span> <span class="main">«</span> <span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span>  cs_split_shift_cd<span class="main">[</span><span class="operator">OF</span> cdj jk _ jge<span class="main">]</span> n0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k'</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j'</span> <span class="main">@</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span> <span class="main">«</span> <span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span>  cs_split_shift_cd<span class="main">[</span><span class="operator">OF</span> cdj' jk' _ jge'<span class="main">]</span> n0' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csj assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-cs_eq_is_eq_shifted"><span class="command">lemma</span></span> cs_eq_is_eq_shifted<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span> <span class="main">«</span> <span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">≠</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span> <span class="main">«</span> <span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> nretkn<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> return›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="free">n'</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span> <span class="main">«</span> <span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span> <span class="main">«</span> <span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> nretk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> term_path_stable<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">+</span><span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nretkn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> <span class="main">=</span> return›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">k</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">k'</span><span class="main">)</span> <span class="free">n'</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span> <span class="main">«</span> <span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span> <span class="main">«</span> <span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> nretk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">k'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> term_path_stable<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">+</span><span class="free">n'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span>    
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span> <span class="free">n'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_inj<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nretkn'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span>›</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span> <span class="main">«</span> <span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span> <span class="main">«</span> <span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n0 cs_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> last_cs assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> n0'<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">n'</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n'</span>›</span></span>    
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_inj<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nretkn<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span> <span class="main">«</span> <span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span> <span class="main">«</span> <span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n0 cs_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> last_cs assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> cdle<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> allge<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">⟶</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> allge'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j'</span><span class="main">.</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">j'</span> <span class="main">⟶</span> <span class="free">k'</span> <span class="main">≤</span> <span class="bound">j'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j'</span> 
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">+</span> <span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j'</span>›</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> cdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="free">n</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_swap_cd<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">hence</span></span> kj<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> allge <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> kj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order_le<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> csj nretk<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span> <span class="main">«</span> <span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_split_shift_nocd<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ allge<span class="main">]</span> n0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k'</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span> <span class="main">«</span> <span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_split_shift_nocd<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ allge'<span class="main">]</span> n0' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ne assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">==</span> <span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span>  
  <span class="keyword1"><span class="command">have</span></span> cdj<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> jge<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">j'</span></span><span class="main">&lt;</span> <span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j'</span> <span class="main">⟶</span> <span class="bound">j'</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> GreatestI_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">]</span> bound j_def cdle <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> GreatestI_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">]</span> bound j_def cdle <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">j'</span></span><span class="main">&lt;</span> <span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">j'</span> <span class="main">⟶</span> <span class="bound">j'</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Greatest_le_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">]</span> bound j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> cdj'<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_swap_cd assms cdj <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> jge'<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">i'</span></span><span class="main">&lt;</span> <span class="free">k'</span><span class="main">.</span> <span class="main">(</span><span class="free">k'</span><span class="main">+</span><span class="free">n'</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">i'</span> <span class="main">⟶</span> <span class="bound">i'</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span>
    <span class="keyword3"><span class="command">assume</span></span> ik'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="free">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cdi'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">+</span> <span class="free">n'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i'</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> cdi<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹ cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_path_swap_cd<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> nreti'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">i'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_not_ret cdi'<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csi _ nreti' ik'<span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jge cdi ik <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order_le<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> csi<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> csj _ ij<span class="main">]</span> cd_not_ret<span class="main">[</span><span class="operator">OF</span> cdi<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> jk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> csj assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> cd_not_ret<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cdj<span class="main"><span class="main">]</span></span> jk<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">@</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span> <span class="main">«</span> <span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span>  cs_split_shift_cd<span class="main">[</span><span class="operator">OF</span> cdj jk _ jge<span class="main">]</span> n0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">k'</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j'</span> <span class="main">@</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span> <span class="main">«</span> <span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span>  cs_split_shift_cd<span class="main">[</span><span class="operator">OF</span> cdj' jk' _ jge'<span class="main">]</span> n0' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csj assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-converged_cd_diverge_cs"><span class="command">lemma</span></span> converged_cd_diverge_cs<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span>  <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span><span class="main">&lt;</span><span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">l'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">m'</span>›</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="free">k'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span><span class="main">≤</span><span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">j</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> path_path_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">j</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">j'</span><span class="main">)</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> last_cs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_shift_def add.right_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">j</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">l</span><span class="main">-</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">j'</span></sup><span class="hidden">⇖</span> <span class="bound">l'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span> <span class="main">«</span> <span class="free">j</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span> <span class="main">«</span> <span class="free">j'</span></sup><span class="hidden">⇖</span> <span class="bound">l'</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csl<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">j</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">j'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">j'</span> <span class="main">+</span> <span class="skolem">l'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> shifted_cs_eq_is_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> csl<span class="main">]</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span><span class="main">-</span><span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">-</span><span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">j</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_return assms<span class="main">(</span>1-5<span class="main">)</span> term_path_stable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_less_le<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j'</span><span class="main">&lt;</span><span class="free">m'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">j</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">j'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">m'</span><span class="main">-</span><span class="free">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_eq_is_eq_shifted<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span><span class="main">-</span><span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m'</span><span class="main">-</span><span class="free">j'</span>›</span></span><span class="main">]</span> assms<span class="main">(</span>4<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">j</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">«</span><span class="free">j'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lcdk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span><span class="main">-</span><span class="free">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">«</span><span class="free">j</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">«</span><span class="free">j</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="free">π'</span><span class="main">«</span><span class="free">j'</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> converged_cd_diverge <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="main">(</span><span class="free">j'</span><span class="main">+</span><span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> shifted_cs_eq_is_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> csk<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">j</span><span class="main">+</span><span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdk assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_diff_cancel_right' cd_path_shift le_add1<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">j'</span><span class="main">+</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j</span><span class="main">+</span><span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span><span class="main">+</span><span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j'</span><span class="main">+</span><span class="skolem">k'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="IFC-cs_ipd_conv"><span class="command">lemma</span></span> cs_ipd_conv<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="main">=</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">l'</span> <span class="main">=</span> ipd<span class="main">(</span><span class="free">π'</span> <span class="free">k'</span><span class="main">)</span>›</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> nipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="free">k</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">}</span><span class="main">.</span> <span class="free">π</span> <span class="bound">n</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">n'</span><span class="main">∈</span><span class="main">{</span><span class="free">k'</span><span class="main">..&lt;</span><span class="free">l'</span><span class="main">}</span><span class="main">.</span> <span class="free">π'</span> <span class="bound">n'</span> <span class="main">≠</span> ipd <span class="main">(</span><span class="free">π'</span> <span class="free">k'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> kl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">&lt;</span> <span class="free">l'</span>›</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_ipd<span class="main">[</span><span class="operator">OF</span> ipd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nipd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> kl<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> cs_ipd<span class="main">[</span><span class="operator">OF</span> ipd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nipd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> kl<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> csk ipd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> last_cs<span class="main">)</span>

<span class="keyword1" id="IFC-cp_eq_cs"><span class="command">lemma</span></span> cp_eq_cs<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>cp›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup>path <span class="free">σ</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cp.induct<span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 

<span class="keyword1" id="IFC-cd_cs_swap"><span class="command">lemma</span></span> cd_cs_swap<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">l'</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="free">l</span> icd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> excd_impl_exicd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">≠</span> <span class="main">[</span><span class="free">π</span> <span class="free">l</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">l'</span> <span class="main">≠</span> <span class="main">[</span><span class="free">π'</span> <span class="free">l'</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">i'</span><span class="main">.</span> <span class="free">l'</span> icd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">i'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cs_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> path'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_icdi_def is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> cd_in_cs<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> csl<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">l</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="free">π</span> <span class="free">k</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id cs_not_nil last_cs<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> πl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">l</span> <span class="main">=</span> <span class="free">π'</span> <span class="free">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> csl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">l'</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="free">π</span> <span class="free">k</span><span class="main">]</span><span class="main">@</span><span class="skolem">ys</span><span class="main">@</span><span class="main">[</span><span class="free">π'</span> <span class="free">l'</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> πl append_eq_appendI assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> csk csl<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> cs_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> csm<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span> <span class="free">k</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lcdm<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">l'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">have</span></span> csm'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> csk csm<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">m</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdm <span class="keyword1"><span class="command">unfolding</span></span> is_cdi_def <span class="keyword1"><span class="command">using</span></span> term_path_stable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_less_le<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">=</span> <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_inj path' csm' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Facts about Observations›</span></span>
<span class="keyword1" id="IFC-kth_obs_not_none"><span class="command">lemma</span></span> kth_obs_not_none<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="main">(</span>path <span class="free">σ</span><span class="main">)</span> <span class="free">k</span> <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹obsp <span class="free">σ</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_kth_obs_def obsp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-kth_obs_unique"><span class="command">lemma</span></span> kth_obs_unique<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">k</span> <span class="free">i</span> <span class="main">⟹</span> is_kth_obs <span class="free">π</span> <span class="free">k</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_sym_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> sym <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> eq <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span> <span class="main">⊆</span> obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">j</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">j</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">unfolding</span></span> is_kth_obs_def obs_ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">j</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less.prems <span class="keyword1"><span class="command">unfolding</span></span> is_kth_obs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">j</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_subset_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-obs_none_no_kth_obs"><span class="command">lemma</span></span> obs_none_no_kth_obs<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ</span> <span class="free">k</span> <span class="main">=</span> None›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> is_kth_obs <span class="main">(</span>path <span class="free">σ</span><span class="main">)</span> <span class="free">k</span> <span class="bound">i</span><span class="main">)</span>›</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">unfolding</span></span> obs_def obsp_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms kth_obs_not_none kth_obs_unique obs_def option.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> the_equality<span class="main">)</span>

<span class="keyword1" id="IFC-obs_some_kth_obs"><span class="command">lemma</span></span> obs_some_kth_obs <span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ</span> <span class="free">k</span> <span class="main">≠</span> None›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="main">(</span>path <span class="free">σ</span><span class="main">)</span> <span class="free">k</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> obs_def assms<span class="main">)</span>

<span class="keyword1" id="IFC-not_none_is_obs"><span class="command">lemma</span></span> not_none_is_obs<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹att<span class="main">(</span><span class="free">π</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> None›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="main">(</span>card <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span>›</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> is_kth_obs_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-in_obs_ids_is_kth_obs"><span class="command">lemma</span></span> in_obs_ids_is_kth_obs<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> obs_ids <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">k</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹att <span class="main">(</span><span class="free">π</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> None›</span></span> <span class="keyword1"><span class="command">using</span></span> assms obs_ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="main">(</span>card <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> not_none_is_obs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-kth_obs_stable"><span class="command">lemma</span></span> kth_obs_stable<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">l</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> is_kth_obs <span class="free">π</span> <span class="free">k</span> <span class="bound">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct <span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">l</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cardl<span class="main">:</span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">j</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less is_kth_obs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>  ex<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">j</span><span class="main">}</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">i</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card.empty empty_iff less_irrefl subsetI subset_antisym zero_diff zero_less_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">j</span><span class="main">}</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">j</span><span class="main">}</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="main">∈</span> obs_ids <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> GreatestI_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span>›</span></span><span class="main">]</span> ex bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> obs_ids <span class="free">π</span> <span class="main">∧</span> <span class="bound">i</span><span class="main">&lt;</span><span class="skolem">j</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">≤</span> <span class="var">?i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Greatest_le_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span>›</span></span><span class="main">]</span> ex bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="var">?i</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?i</span><span class="main">}</span> <span class="main">=</span> obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">j</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command">using</span></span> **<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="main">∉</span> <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="var">?i</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span>card <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="var">?i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cardl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_empty_right Un_insert_right card_insert_disjoint finite_Int finite_lessThan<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="var">?i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> iko<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="var">?i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_kth_obs_def obs_ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ll<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def diff_Suc_less less.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> not_gr0 not_less0<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IV<span class="main">=</span>less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ll iko<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> IV <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> iko <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-kth_obs_mono"><span class="command">lemma</span></span> kth_obs_mono<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">k</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">l</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{..&lt;</span><span class="free">j</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="free">j</span><span class="main">}</span> <span class="main">⊆</span> obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_mono<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_kth_obs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-kth_obs_le_iff"><span class="command">lemma</span></span> kth_obs_le_iff<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">k</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">l</span> <span class="free">j</span>›</span></span>  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms kth_obs_unique kth_obs_mono not_less_iff_gr_or_eq<span class="main">)</span>

<span class="keyword1" id="IFC-ret_obs_all_obs"><span class="command">lemma</span></span> ret_obs_all_obs<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> iki<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">k</span> <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> kl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">j</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">l</span> <span class="free">j</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> kl iki ret <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">-</span> <span class="free">k</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">k</span> <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> kl <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span>
    <span class="keyword1"><span class="command">note</span></span> iki <span class="main">=</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="skolem">k</span> <span class="skolem">i</span>›</span></span>
    <span class="keyword1"><span class="command">note</span></span> ret <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">i</span> <span class="main">=</span> return›</span></span>  
    <span class="keyword1"><span class="command">have</span></span> card<span class="main">:</span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> att_ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹att return <span class="main">≠</span> None›</span></span><span class="keyword1"><span class="command">using</span></span> iki ret <span class="keyword1"><span class="command">unfolding</span></span> is_kth_obs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> rets<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> path ret term_path_stable <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> attsuc<span class="main">:</span> <span class="quoted"><span class="quoted">‹att <span class="main">(</span><span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> None›</span></span> <span class="keyword1"><span class="command">using</span></span> att_ret <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> obs_ids <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> att_ret ret <span class="keyword1"><span class="command">unfolding</span></span> obs_ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{..&lt;</span> Suc <span class="skolem">i</span><span class="main">}</span> <span class="main">=</span> insert <span class="skolem">i</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span> Suc <span class="skolem">i</span><span class="main">}</span> <span class="main">=</span> insert <span class="skolem">i</span> <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span>obs_ids <span class="free">π</span> <span class="main">∩</span> <span class="main">{..&lt;</span>Suc <span class="skolem">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card card_insert_disjoint a b<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> iksuc<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> attsuc <span class="keyword1"><span class="command">unfolding</span></span> is_kth_obs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> suckl<span class="main">:</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">k</span> <span class="main">≤</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> less
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span><span class="main">)</span> 
      <span class="keyword3"><span class="command">assume</span></span> skl<span class="main">:</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span> 
      <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ skl iksuc rets<span class="main">]</span> skl
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Suc <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">l</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">k</span> <span class="main">=</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> suckl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> iksuc that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-no_kth_obs_missing_cs"><span class="command">lemma</span></span> no_kth_obs_missing_cs<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> iki<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">k</span> <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> not_in_π'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> is_kth_obs <span class="free">π'</span> <span class="free">k</span> <span class="bound">i'</span><span class="main">)</span>›</span></span>  <span class="keyword2"><span class="keyword">obtains</span></span>  <span class="free">l</span> <span class="free">j</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">l</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">thesis</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> all_in_π'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span> <span class="bound">j</span><span class="main">.</span> is_kth_obs <span class="free">π</span> <span class="bound">l</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j'</span> <span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹att<span class="main">(</span><span class="free">π'</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">≠</span> None›</span></span> <span class="keyword1"><span class="command">using</span></span> iki <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_kth_obs_def last_cs<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ik'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">k'</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_none_is_obs<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> kk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> not_in_π' kth_obs_stable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> not_less_iff_gr_or_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> return›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">≠</span> return›</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> kk' ik' csi iki <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span>›</span></span> <span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">i'</span> <span class="skolem">k'</span><span class="main">)</span>      
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> ikj<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="skolem">k</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kth_obs_stable lessI<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> all_in_π' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹att<span class="main">(</span><span class="free">π'</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">≠</span> None›</span></span> <span class="keyword1"><span class="command">using</span></span> ikj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_kth_obs_def last_cs<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k2</span></span> <span class="keyword2"><span class="keyword">where</span></span> ik2<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">k2</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_none_is_obs<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kth_obs_mono <span class="main">[</span><span class="operator">OF</span> ikj <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">i</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> nretj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">j</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> term_path_stable less_imp_le path<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>    
      <span class="keyword1"><span class="command">have</span></span> ji'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> path _ _ nretj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span>›</span></span><span class="main">]</span> csj <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span>  ji <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k2</span> <span class="main">≠</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ik2 Suc<span class="main">(</span>4<span class="main">)</span> ji' kth_obs_unique<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_irrefl<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> k2k'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k2</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kth_obs_mono<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">k'</span> <span class="skolem">i'</span>›</span></span> ik2<span class="main">]</span> ji' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_less_iff_gr_or_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> k2k<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k2</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Suc.IH<span class="main">[</span><span class="operator">OF</span> nretj k2k ik2 csj ikj<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">i</span> <span class="main">=</span> return›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> reti'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">i'</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> csi last_cs<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ret_obs_all_obs<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ik' reti' kk'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹False›</span></span><span class="main">]</span> not_in_π'
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-kth_obs_cs_missing_cs"><span class="command">lemma</span></span> kth_obs_cs_missing_cs<span class="main">:</span>  <span class="keyword2"><span class="keyword">assumes</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> iki<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">k</span> <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> iki'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="free">k</span> <span class="free">i'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">≠</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span>›</span></span> 
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="free">j</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">l</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="main">|</span> <span class="free">l'</span> <span class="free">j'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j'</span> <span class="main">≤</span> <span class="free">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="free">l'</span> <span class="free">j'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">j'</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> nt<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">thesis</span>›</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> iki iki' csi that <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">i'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> all_in_π'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">≤</span><span class="skolem">i</span> <span class="main">∧</span> is_kth_obs <span class="free">π</span> <span class="bound">l</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j'</span> <span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> all_in_π<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l'</span> <span class="bound">j'</span><span class="main">.</span> <span class="bound">j'</span> <span class="main">≤</span> <span class="skolem">i'</span> <span class="main">∧</span> is_kth_obs <span class="free">π'</span> <span class="bound">l'</span> <span class="bound">j'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j</span> <span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nt<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> nt less<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csji<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csij<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> all_in_π all_in_π' less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ilj<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="skolem">l</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ilj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">l'</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_kth_obs_def last_cs less.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> lnk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≠</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ilj csji less<span class="main">(</span>2<span class="main">)</span> less<span class="main">(</span>4<span class="main">)</span> kth_obs_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> lnk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">≠</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ilj' csij less<span class="main">(</span>3<span class="main">)</span> less<span class="main">(</span>4<span class="main">)</span> kth_obs_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> cseq<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span> <span class="bound">j</span> <span class="bound">j'</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∧</span>  is_kth_obs <span class="free">π</span> <span class="bound">l</span> <span class="bound">j</span> <span class="main">∧</span> is_kth_obs <span class="free">π'</span> <span class="bound">l</span> <span class="bound">j'</span> <span class="main">⟶</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">p</span> <span class="skolem">p'</span> <span class="keyword3"><span class="command">assume</span></span> tk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ikp<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="skolem">t</span> <span class="skolem">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ikp'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">t</span> <span class="skolem">p'</span>›</span></span> 
        <span class="keyword1"><span class="command">hence</span></span> pi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> pi'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kth_obs_mono less.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> kth_obs_mono less.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tk ikp'<span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">j</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="skolem">p</span> <span class="main">⟹</span> is_kth_obs <span class="free">π</span> <span class="bound">l</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pi all_in_π' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">j'</span> <span class="bound">l'</span><span class="main">.</span> <span class="bound">j'</span> <span class="main">≤</span> <span class="skolem">p'</span> <span class="main">⟹</span> is_kth_obs <span class="free">π'</span> <span class="bound">l'</span> <span class="bound">j'</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> pi' all_in_π <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">p</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">p'</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> tk ikp ikp'<span class="main">]</span> * ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> ii'nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">i</span> <span class="main">≠</span> return <span class="main">∨</span> <span class="free">π'</span> <span class="skolem">i'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> less cs_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">∨</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="main">(</span><span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">∨</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l'</span><span class="main">)</span>›</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lnk lnk' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ji'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ilj ilj' less<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> kth_obs_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ii'nret <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> nreti<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">i</span> <span class="main">≠</span> return›</span></span>
        <span class="keyword1"><span class="command">hence</span></span> nretj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">j'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> last_cs csij <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csij<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> csji<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nretj' ji'<span class="main">]</span> ji <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> nreti'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">i'</span> <span class="main">≠</span> return›</span></span>
        <span class="keyword1"><span class="command">hence</span></span> nretj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">j</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> last_cs csji <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> path csji csij nretj' ji<span class="main">]</span> ji' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∨</span> <span class="skolem">l'</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="skolem">l</span><span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∨</span> <span class="skolem">l'</span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lnk lnk' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ji'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ilj ilj' less<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> kth_obs_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ii'nret <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> nreti<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">i</span> <span class="main">≠</span> return›</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> path csij csji nreti ji<span class="main">]</span>  ji' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> nreti'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">i'</span> <span class="main">≠</span> return›</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csji<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> csij<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nreti' ji'<span class="main">]</span> ji <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>    
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∨</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l'</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> kl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
      <span class="keyword1"><span class="command">hence</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ji'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> ilj ilj' kth_obs_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
      <span class="keyword1"><span class="command">have</span></span> nreti<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> csji ii'nret ij last_cs path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> term_path_stable less_imp_le<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> ilh<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="skolem">l'</span> <span class="skolem">h</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ji' all_in_π ilj' no_kth_obs_missing_cs path<span class="main">(</span>1<span class="main">)</span> path<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kl lk' ilj kth_obs_stable<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">h</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cseq lk' ilj' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">h</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csij <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> hi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span> <span class="main">=</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_inj nreti path<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>2<span class="main">)</span> ilh <span class="keyword1"><span class="command">unfolding</span></span> hi <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_kth_obs_def<span class="main">)</span>      
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> lk' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l'</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> kl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
      <span class="keyword1"><span class="command">hence</span></span> ij'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> ilj ilj' kth_obs_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
      <span class="keyword1"><span class="command">have</span></span> nreti'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">i'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> csij ii'nret ij' last_cs path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> term_path_stable less_imp_le<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ilh'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">l</span> <span class="skolem">h'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> all_in_π' ilj no_kth_obs_missing_cs path<span class="main">(</span>1<span class="main">)</span> path<span class="main">(</span>2<span class="main">)</span> kl' lk ilj' kth_obs_stable <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">h'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cseq lk ilj <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">h'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csji <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> hi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">h'</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_inj nreti' path<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>3<span class="main">)</span> ilh' <span class="keyword1"><span class="command">unfolding</span></span> hi <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_kth_obs_def<span class="main">)</span>      
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> lk <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Facts about Data›</span></span>

<span class="keyword1" id="IFC-reads_restrict1"><span class="command">lemma</span></span> reads_restrict1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span> <span class="main">↾</span> <span class="main">(</span>reads <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ'</span> <span class="main">↾</span> <span class="main">(</span>reads <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> reads <span class="free">n</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">σ'</span> <span class="bound">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> restrict_def<span class="main">)</span>

<span class="keyword1" id="IFC-reads_restrict2"><span class="command">lemma</span></span> reads_restrict2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> reads <span class="free">n</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">σ'</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="main">↾</span> <span class="main">(</span>reads <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ'</span> <span class="main">↾</span> <span class="main">(</span>reads <span class="free">n</span><span class="main">)</span>›</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-reads_restrict"><span class="command">lemma</span></span> reads_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span> <span class="main">↾</span> <span class="main">(</span>reads <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ'</span> <span class="main">↾</span> <span class="main">(</span>reads <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> reads <span class="free">n</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">σ'</span> <span class="bound">x</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> reads_restrict1 reads_restrict2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="IFC-reads_restr_suc"><span class="command">lemma</span></span> reads_restr_suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span> <span class="main">↾</span> <span class="main">(</span>reads <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ'</span> <span class="main">↾</span> <span class="main">(</span>reads <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> suc <span class="free">n</span> <span class="free">σ</span> <span class="main">=</span> suc <span class="free">n</span> <span class="free">σ'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> reads_restrict uses_suc<span class="main">)</span>

<span class="keyword1" id="IFC-reads_restr_sem"><span class="command">lemma</span></span> reads_restr_sem<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span> <span class="main">↾</span> <span class="main">(</span>reads <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ'</span> <span class="main">↾</span> <span class="main">(</span>reads <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> writes <span class="free">n</span><span class="main">.</span> sem <span class="free">n</span> <span class="free">σ</span> <span class="bound">v</span> <span class="main">=</span> sem <span class="free">n</span> <span class="free">σ'</span> <span class="bound">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> reads_restrict1 uses_writes<span class="main">)</span>

<span class="keyword1" id="IFC-reads_obsp"><span class="command">lemma</span></span> reads_obsp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹path <span class="free">σ</span> <span class="free">k</span> <span class="main">=</span> path <span class="free">σ'</span> <span class="free">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> <span class="main">(</span>reads <span class="main">(</span>path <span class="free">σ</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="free">k'</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> <span class="main">(</span>reads <span class="main">(</span>path <span class="free">σ</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹obsp <span class="free">σ</span> <span class="free">k</span> <span class="main">=</span> obsp <span class="free">σ'</span> <span class="free">k'</span>›</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> uses_att 
  <span class="keyword1"><span class="command">unfolding</span></span> obsp_def assms<span class="main">(</span>1<span class="main">)</span> reads_restrict 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹att <span class="main">(</span>path <span class="free">σ'</span> <span class="free">k'</span><span class="main">)</span>›</span></span><span class="main">)</span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-no_writes_unchanged0"><span class="command">lemma</span></span> no_writes_unchanged0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">l</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">v</span><span class="main">∉</span> writes<span class="main">(</span>path <span class="free">σ</span> <span class="bound">l</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="free">σ</span> <span class="free">v</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kth_state_def<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="free">σ</span> <span class="free">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup>Suc <span class="skolem">k</span></sup><span class="hidden">⇖</span>  <span class="main">=</span> snd <span class="main">(</span> step <span class="main">(</span>path <span class="free">σ</span> <span class="skolem">k</span><span class="main">,</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kth_state_suc<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup>Suc <span class="skolem">k</span></sup><span class="hidden">⇖</span>  <span class="main">=</span> sem <span class="main">(</span>path <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step_suc_sem snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">∉</span> writes <span class="main">(</span>path <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> writes <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-written_read_dd"><span class="command">lemma</span></span> written_read_dd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">∈</span> reads <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span> ›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">∈</span> writes <span class="main">(</span><span class="free">π</span> <span class="free">j</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span><span class="main">&lt;</span><span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> dd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">,</span><span class="free">v</span></sup><span class="hidden">⇖</span>→ <span class="free">l</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">GREATEST</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">∈</span> writes <span class="main">(</span><span class="free">π</span> <span class="bound">l</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> GreatestI_ex_nat assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> less_or_eq_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">∈</span> writes <span class="main">(</span><span class="free">π</span> <span class="var">?l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> GreatestI_nat assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> less_or_eq_imp_le<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">∈</span> reads <span class="main">(</span><span class="free">π</span> <span class="free">k</span><span class="main">)</span> <span class="main">∩</span> writes <span class="main">(</span><span class="free">π</span> <span class="var">?l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> is_ddi_def
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?l</span><span class="main">&lt;..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="free">v</span> <span class="main">∉</span> writes <span class="main">(</span><span class="free">π</span> <span class="bound">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> Greatest_le_nat le_antisym nat_less_le<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> dd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">,</span><span class="free">v</span></sup><span class="hidden">⇖</span>→ <span class="var">?l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-no_writes_unchanged"><span class="command">lemma</span></span> no_writes_unchanged<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">}</span><span class="main">.</span> <span class="free">v</span><span class="main">∉</span> writes<span class="main">(</span>path <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free">v</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">-</span> <span class="free">k</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">lk</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> kl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> lsuc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">=</span> Suc <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lessE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">lk</span> <span class="main">=</span> <span class="skolem">l'</span> <span class="main">-</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span><span class="main">..&lt;</span><span class="skolem">l'</span><span class="main">}</span><span class="main">.</span> <span class="free">v</span> <span class="main">∉</span> writes <span class="main">(</span>path <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>4<span class="main">)</span> lsuc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">l'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free">v</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span>›</span></span><span class="main">]</span> lsuc kl <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">l</span></sup><span class="hidden">⇖</span> <span class="main">=</span> snd <span class="main">(</span> step <span class="main">(</span>path <span class="free">σ</span> <span class="skolem">l'</span><span class="main">,</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">l'</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kth_state_suc lsuc<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">l</span></sup><span class="hidden">⇖</span> <span class="main">=</span> sem <span class="main">(</span>path <span class="free">σ</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">l'</span></sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step_suc_sem snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kl lsuc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">∉</span> writes <span class="main">(</span>path <span class="free">σ</span> <span class="skolem">l'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> writes <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-ddi_value"><span class="command">lemma</span></span> ddi_value<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> dd<span class="hidden">⇗</span><sup><span class="main">(</span>path <span class="free">σ</span><span class="main">)</span><span class="main">,</span><span class="free">v</span></sup><span class="hidden">⇖</span>→ <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup>Suc <span class="free">k</span></sup><span class="hidden">⇖</span> <span class="main">)</span> <span class="free">v</span>›</span></span>
<span class="keyword1"><span class="command">using</span></span> assms no_writes_unchanged<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹Suc <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="IFC-written_value"><span class="command">lemma</span></span> written_value<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹path <span class="free">σ</span> <span class="free">l</span> <span class="main">=</span> path <span class="free">σ'</span> <span class="free">l'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">l</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span>path <span class="free">σ</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="free">l'</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span>path <span class="free">σ</span> <span class="free">l</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">∈</span> writes <span class="main">(</span>path <span class="free">σ</span> <span class="free">l</span><span class="main">)</span>›</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup>Suc <span class="free">l</span></sup><span class="hidden">⇖</span> <span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup>Suc <span class="free">l'</span></sup><span class="hidden">⇖</span> <span class="main">)</span> <span class="free">v</span>›</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms reads_restr_sem snd_conv step_suc_sem kth_state_suc<span class="main">)</span> 


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Facts about Contradicting Paths›</span></span>

<span class="keyword1" id="IFC-obsp_contradict"><span class="command">lemma</span></span> obsp_contradict<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup>path <span class="free">σ</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">‹obsp <span class="free">σ</span> <span class="free">k</span> <span class="main">≠</span> obsp <span class="free">σ'</span> <span class="free">k'</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">k'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> pk<span class="main">:</span> <span class="quoted"><span class="quoted">‹path <span class="free">σ</span> <span class="free">k</span> <span class="main">=</span> path <span class="free">σ'</span> <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="main">↾</span><span class="main">(</span>reads <span class="main">(</span>path <span class="free">σ</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="free">k'</span></sup><span class="hidden">⇖</span><span class="main">↾</span><span class="main">(</span>reads <span class="main">(</span>path <span class="free">σ</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> obs reads_obsp<span class="main">[</span><span class="operator">OF</span> pk<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> contradicts.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> csk<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-missing_cs_contradicts"><span class="command">lemma</span></span> missing_cs_contradicts<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> notin<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="main">(</span><span class="main">∃</span> <span class="bound">k'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ'</span></sup><span class="hidden">⇖</span> <span class="bound">k'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> converge<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">&lt;</span><span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup>path <span class="free">σ</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">j'</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">j'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹path <span class="free">σ</span>›</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π'</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹path <span class="free">σ'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="main">0</span> <span class="main">=</span> <span class="var">?π'</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> path_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="var">?π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="var">?π'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path_is_path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="var">?π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="var">?π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="var">?π</span></sup><span class="hidden">⇖</span>→<span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?π'</span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> converged_cd_diverge<span class="main">[</span><span class="operator">OF</span> path init notin converge<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="var">?π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">≺</span> cs<span class="hidden">⇗</span><sup><span class="var">?π</span></sup><span class="hidden">⇖</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cd cd_is_cs_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nretj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="skolem">j</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd is_cdi_def term_path_stable less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span> <span class="main">¡</span> cs<span class="hidden">⇗</span><sup><span class="var">?π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j'</span> <span class="main">=</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csj cs_select_id nretj path_is_path <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">j'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> contradicts.intros<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ'</span>›</span></span><span class="main">,</span><span class="operator">unfolded</span> cs<span class="main">]</span> less suc csj <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> obs_neq_contradicts_term<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="free">σ'</span> <span class="keyword2"><span class="keyword">defines</span></span> π<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">≡</span> path <span class="free">σ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">≡</span> path <span class="free">σ'</span>›</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">n'</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> obsne<span class="main">:</span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ</span> <span class="main">≠</span> obs <span class="free">σ'</span>›</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span> <span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">k'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span> <span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="main">∧</span> <span class="free">π</span> <span class="bound">k</span> <span class="main">∈</span> dom <span class="main">(</span>att<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ'</span> <span class="main">,</span><span class="bound">k'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">π'</span> <span class="bound">k'</span> <span class="main">∈</span> dom <span class="main">(</span>att<span class="main">)</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> π π' path_is_path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k1</span></span> <span class="keyword2"><span class="keyword">where</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ</span> <span class="skolem">k1</span> <span class="main">≠</span> obs <span class="free">σ'</span> <span class="skolem">k1</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> obsne ext<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ</span>›</span></span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="bound">i</span> <span class="bound">i'</span><span class="main">.</span> is_kth_obs <span class="free">π</span> <span class="bound">k</span> <span class="bound">i</span> <span class="main">∧</span> is_kth_obs <span class="free">π'</span> <span class="bound">k</span> <span class="bound">i'</span> <span class="main">∧</span> obsp <span class="free">σ</span> <span class="bound">i</span> <span class="main">≠</span> obsp <span class="free">σ'</span> <span class="bound">i'</span> <span class="main">∧</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span> 
  <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span> <span class="bound">i</span><span class="main">.</span> is_kth_obs <span class="free">π</span> <span class="bound">k</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span> <span class="bound">i'</span><span class="main">.</span> is_kth_obs <span class="free">π'</span> <span class="bound">k</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> option_neq_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>none2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> notinπ'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> is_kth_obs <span class="free">π'</span> <span class="skolem">k1</span> <span class="bound">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> none2<span class="main">(</span>2<span class="main">)</span> π' obs_none_no_kth_obs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> inπ<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="skolem">k1</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> obs_some_kth_obs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k1</span>›</span></span><span class="main">]</span> none2<span class="main">(</span>1<span class="main">)</span> π <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>            
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="skolem">l</span> <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path inπ notinπ' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> no_kth_obs_missing_cs<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>none1 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> notinπ<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> is_kth_obs <span class="free">π</span> <span class="skolem">k1</span> <span class="bound">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> none1<span class="main">(</span>1<span class="main">)</span> π obs_none_no_kth_obs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> inπ'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">k1</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> obs_some_kth_obs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">σ'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k1</span>›</span></span><span class="main">]</span> none1<span class="main">(</span>2<span class="main">)</span> π' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>            
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">l</span> <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path inπ' notinπ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> no_kth_obs_missing_cs<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>  
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>some <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> inπ<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="skolem">k1</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> obs_some_kth_obs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k1</span>›</span></span><span class="main">]</span> some π <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> inπ'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">k1</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> obs_some_kth_obs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">σ'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k1</span>›</span></span><span class="main">]</span> some π' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹obsp <span class="free">σ</span> <span class="skolem">i</span> <span class="main">=</span> obs <span class="free">σ</span> <span class="skolem">k1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> obs_def π inπ kth_obs_unique the_equality<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹obsp <span class="free">σ'</span> <span class="skolem">i'</span> <span class="main">=</span> obs <span class="free">σ'</span> <span class="skolem">k1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> obs_def π' inπ' kth_obs_unique the_equality<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹obsp <span class="free">σ</span> <span class="skolem">i</span> <span class="main">≠</span> obsp <span class="free">σ'</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> neq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * inπ inπ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">≠</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span>
      <span class="keyword1"><span class="command">note</span></span> kth_obs_cs_missing_cs<span class="main">[</span><span class="operator">OF</span> path inπ inπ' *<span class="main">]</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> three_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> iki<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="skolem">k</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">k</span> <span class="skolem">i'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> obsne<span class="main">:</span> <span class="quoted"><span class="quoted">‹obsp <span class="free">σ</span> <span class="skolem">i</span> <span class="main">≠</span> obsp <span class="free">σ'</span> <span class="skolem">i'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> obsp_contradict<span class="main">[</span><span class="operator">OF</span> csi<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> π π'<span class="main"><span class="main">]</span></span> obsne<span class="main">]</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">i</span> <span class="main">∈</span> dom att›</span></span> <span class="keyword1"><span class="command">using</span></span> iki <span class="keyword1"><span class="command">unfolding</span></span> is_kth_obs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> iki<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="skolem">k</span> <span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> notinπ'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?n</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span>max <span class="free">n</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> nn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&lt;</span> <span class="var">?n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> iln<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> retn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="var">?n</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> ret term_path_stable path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="var">?n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ret<span class="main">(</span>2<span class="main">)</span> cs_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> missing_cs_contradicts<span class="main">[</span><span class="operator">OF</span> notinπ'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> π π'<span class="main"><span class="main">]</span></span> iln<span class="main">]</span> π π' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">i</span> <span class="main">∈</span> dom att›</span></span> <span class="keyword1"><span class="command">using</span></span> iki is_kth_obs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> iki<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">k</span> <span class="skolem">i'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> notinπ'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?n</span>›</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span>max <span class="free">n'</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> nn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">n'</span> <span class="main">&lt;</span> <span class="var">?n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> iln<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="var">?n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> retn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="var">?n</span> <span class="main">=</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> ret term_path_stable path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="var">?n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ret<span class="main">(</span>1<span class="main">)</span> cs_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> missing_cs_contradicts notinπ' iln π π' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">i'</span> <span class="main">∈</span> dom att›</span></span> <span class="keyword1"><span class="command">using</span></span> iki is_kth_obs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IFC-obs_neq_some_contradicts'"><span class="command">lemma</span></span> obs_neq_some_contradicts'<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="free">σ'</span> <span class="keyword2"><span class="keyword">defines</span></span> π<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">≡</span> path <span class="free">σ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">≡</span> path <span class="free">σ'</span>›</span></span> 
<span class="keyword2"><span class="keyword">assumes</span></span> obsnecs<span class="main">:</span> <span class="quoted"><span class="quoted">‹obsp <span class="free">σ</span> <span class="free">i</span> <span class="main">≠</span> obsp <span class="free">σ'</span> <span class="free">i'</span> <span class="main">∨</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">i</span> <span class="main">≠</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">i'</span>›</span></span>
<span class="keyword2"><span class="keyword">and</span></span> iki<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">k</span> <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> iki'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="free">k</span> <span class="free">i'</span>›</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span> <span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">k'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span> <span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="main">∧</span> <span class="free">π</span> <span class="bound">k</span> <span class="main">∈</span> dom att<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ'</span> <span class="main">,</span><span class="bound">k'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">π'</span> <span class="bound">k'</span> <span class="main">∈</span> dom att<span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">using</span></span> obsnecs iki iki' <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i'</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct <span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">i'</span><span class="main">)</span>  
  <span class="keyword1"><span class="command">note</span></span> iki <span class="main">=</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="skolem">k</span> <span class="skolem">i</span>›</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> iki' <span class="main">=</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">k</span> <span class="skolem">i'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> domi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">i</span> <span class="main">∈</span> dom att›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_kth_obs_def domIff iki<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> domi'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">i'</span> <span class="main">∈</span> dom att›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_kth_obs_def domIff iki'<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> obsnecs <span class="main">=</span> <span class="quoted"><span class="quoted">‹obsp <span class="free">σ</span> <span class="skolem">i</span> <span class="main">≠</span> obsp <span class="free">σ'</span> <span class="skolem">i'</span> <span class="main">∨</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">≠</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹obsp <span class="free">σ</span> <span class="skolem">i</span> <span class="main">≠</span> obsp <span class="free">σ'</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> obsnecs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> obsp_contradict<span class="main">[</span><span class="operator">OF</span> _ *<span class="main">]</span> csi domi π π'
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    
  <span class="keyword1"><span class="command">next</span></span>      
    <span class="keyword3"><span class="command">assume</span></span> ncsi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">≠</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span>  
    <span class="keyword1"><span class="command">have</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="free">π'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> π π' path_is_path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> π0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> π π' path_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> kth_obs_cs_missing_cs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span>›</span></span><span class="main">]</span> π π' path_is_path iki iki' ncsi 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">∃</span> <span class="bound">l</span> <span class="bound">j</span> <span class="main">.</span><span class="bound">j</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> is_kth_obs <span class="free">π</span> <span class="bound">l</span> <span class="bound">j</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">l'</span> <span class="bound">j'</span><span class="main">.</span> <span class="bound">j'</span> <span class="main">≤</span> <span class="skolem">i'</span> <span class="main">∧</span> is_kth_obs <span class="free">π'</span> <span class="bound">l'</span> <span class="bound">j'</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> is_kth_obs <span class="free">π</span> <span class="bound">l</span> <span class="bound">j</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span><span class="main">≤</span><span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> iobs<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="skolem">l</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> notin<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> dom<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">j</span> <span class="main">∈</span> dom att›</span></span> <span class="keyword1"><span class="command">using</span></span> iobs is_kth_obs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> nj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csn<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> sucn<span class="main">:</span>  <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cdloop<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j'</span></span><span class="main">&gt;</span> <span class="skolem">n'</span><span class="main">.</span> <span class="bound">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> missing_cd_or_loop<span class="main">[</span><span class="operator">OF</span> path π0 notin<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdloop <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> cdjn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span>›</span></span>
        <span class="keyword1"><span class="command">hence</span></span> csnj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span> <span class="main">≺</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_is_cs_less<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> cssel<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">π</span> <span class="main">¡</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cdjn cd_not_ret cs_select_id path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">n'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csnj <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> contradicts.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cssel π π' sucn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> dom <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> loop<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">j'</span></span><span class="main">&gt;</span><span class="skolem">n'</span><span class="main">.</span> <span class="bound">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">assume</span></span> in'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">n'</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> nreti'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">i'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span> <span class="operator">metis</span> le_eq_less_or_eq lessI loop not_le path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ret_no_cd term_path_stable<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">ι</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">ι</span>›</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ι</span></span> <span class="keyword2"><span class="keyword">where</span></span> csι<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">ι</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>            
            <span class="keyword1"><span class="command">have</span></span> ιn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order_le<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csι<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> csn<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nreti' in'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">hence</span></span> ιi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι</span> <span class="main">&lt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nj ji <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword1"><span class="command">have</span></span> domι<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">ι</span> <span class="main">∈</span> dom att›</span></span> <span class="keyword1"><span class="command">using</span></span> domi' csι last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">κ</span></span> <span class="keyword2"><span class="keyword">where</span></span> iκι<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="skolem">κ</span> <span class="skolem">ι</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> domι <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_kth_obs_def domIff<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> κk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">κ</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ιi iki <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kth_obs_le_iff<span class="main">)</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ι'</span></span> <span class="keyword2"><span class="keyword">where</span></span> iκι'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">κ</span> <span class="skolem">ι'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> κk iki' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kth_obs_stable<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι'</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> κk iki' iκι' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kth_obs_le_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> csι'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">ι</span> <span class="main">≠</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">ι'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> csι <span class="keyword1"><span class="command">using</span></span> cs_inj<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nreti'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>           
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> κk _ iκι iκι'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> notin''<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="main">(</span><span class="main">∃</span> <span class="bound">ι</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">ι</span><span class="main">)</span>›</span></span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ι</span></span> <span class="skolem"><span class="skolem">ι'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ιi'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι'</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csι<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">ι</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">ι'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> sucι<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">ι</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">ι'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cdloop'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">ι'</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="skolem">ι</span><span class="main">.</span> <span class="bound">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">ι</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> missing_cd_or_loop<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> π0<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> notin''<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdloop' <span class="keyword1"><span class="command">proof</span></span>
              <span class="keyword3"><span class="command">assume</span></span> cdjn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">ι'</span>›</span></span>
              <span class="keyword1"><span class="command">hence</span></span> csnj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">ι</span> <span class="main">≺</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csι <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_is_cs_less<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> cssel<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">π'</span> <span class="main">¡</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">ι</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">ι'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csι <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cdjn cd_not_ret cs_select_id path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="skolem">ι</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csnj <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> contradicts.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cssel π π' sucι <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> domi' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> loop'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="skolem">ι</span><span class="main">.</span> <span class="bound">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">ι</span>›</span></span>
              <span class="keyword1"><span class="command">have</span></span> ιn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι'</span> <span class="main">&lt;</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> in' ιi' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> nretι'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">ι'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> csι last_cs le_eq_less_or_eq lessI path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sucι term_path_stable<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csι<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> csn<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nretι' ιn'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι</span> <span class="main">&lt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nj ji <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">hence</span></span> cdiι<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">ι</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> loop' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">hence</span></span> csιi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">ι'</span> <span class="main">≺</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csι <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_is_cs_less<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> cssel<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">π</span> <span class="main">¡</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">ι'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">ι</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csι <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cdiι cd_not_ret cs_select_id path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">ι'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csιi <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> contradicts.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cssel π π' sucι <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> domi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">n'</span>›</span></span>
          <span class="keyword1"><span class="command">hence</span></span> ni'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span><span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> cdin<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> loop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> csni<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">≺</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_is_cs_less<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> cssel<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">π'</span> <span class="main">¡</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cdin cd_not_ret cs_select_id path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csni <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> contradicts.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cssel π π' sucn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> domi' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="comment1">― ‹Symmetric case as above, indices might be messy.›</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="skolem">i'</span> <span class="main">∧</span> is_kth_obs <span class="free">π'</span> <span class="bound">l</span> <span class="bound">j</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> ji'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span><span class="main">≤</span><span class="skolem">i'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> iobs<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">l</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> notin<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> dom<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">j</span> <span class="main">∈</span> dom att›</span></span> <span class="keyword1"><span class="command">using</span></span> iobs is_kth_obs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> nj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csn<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> sucn<span class="main">:</span>  <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cdloop<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j'</span></span><span class="main">&gt;</span> <span class="skolem">n'</span><span class="main">.</span> <span class="bound">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> missing_cd_or_loop<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> π0<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main">]</span> notin <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdloop <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> cdjn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span>›</span></span>
        <span class="keyword1"><span class="command">hence</span></span> csnj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span> <span class="main">≺</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_is_cs_less<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> cssel<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">π'</span> <span class="main">¡</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cdjn cd_not_ret cs_select_id path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="skolem">n'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csnj <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> contradicts.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cssel π' π sucn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> dom <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> loop<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">j'</span></span><span class="main">&gt;</span><span class="skolem">n'</span><span class="main">.</span> <span class="bound">j'</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">assume</span></span> in'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">n'</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> nreti<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_eq_less_or_eq lessI loop not_le path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ret_no_cd term_path_stable<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">ι</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">ι</span>›</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ι</span></span> <span class="keyword2"><span class="keyword">where</span></span> csι<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">ι</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>            
            <span class="keyword1"><span class="command">have</span></span> ιn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order_le<span class="main">[</span><span class="operator">OF</span> path csι<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> csn<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nreti in'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">hence</span></span> ιi'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nj ji' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword1"><span class="command">have</span></span> domι<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">ι</span> <span class="main">∈</span> dom att›</span></span> <span class="keyword1"><span class="command">using</span></span> domi csι last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">κ</span></span> <span class="keyword2"><span class="keyword">where</span></span> iκι<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">κ</span> <span class="skolem">ι</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> domι <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_kth_obs_def domIff<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> κk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">κ</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ιi' iki' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kth_obs_le_iff<span class="main">)</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ι'</span></span> <span class="keyword2"><span class="keyword">where</span></span> iκι'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="skolem">κ</span> <span class="skolem">ι'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> κk iki <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kth_obs_stable<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι'</span> <span class="main">&lt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> κk iki iκι' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kth_obs_le_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> csι'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">ι</span> <span class="main">≠</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">ι'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> csι <span class="keyword1"><span class="command">using</span></span> cs_inj<span class="main">[</span><span class="operator">OF</span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nreti<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>           
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> κk _ iκι' iκι<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> notin''<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="main">(</span><span class="main">∃</span> <span class="bound">ι</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">ι</span><span class="main">)</span>›</span></span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ι</span></span> <span class="skolem"><span class="skolem">ι'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ιi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι'</span> <span class="main">&lt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csι<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">ι</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">ι'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> sucι<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">ι</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">ι'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cdloop'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">ι'</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="skolem">ι</span><span class="main">.</span> <span class="bound">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">ι</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> missing_cd_or_loop<span class="main">[</span><span class="operator">OF</span> path π0 notin''<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdloop' <span class="keyword1"><span class="command">proof</span></span>
              <span class="keyword3"><span class="command">assume</span></span> cdjn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">ι'</span>›</span></span>
              <span class="keyword1"><span class="command">hence</span></span> csnj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">ι</span> <span class="main">≺</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csι <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_is_cs_less<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> cssel<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">π</span> <span class="main">¡</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">ι</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">ι'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csι <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cdjn cd_not_ret cs_select_id path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">ι</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csnj <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> contradicts.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cssel π' π sucι <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> domi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> loop'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="skolem">ι</span><span class="main">.</span> <span class="bound">j</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">ι</span>›</span></span>
              <span class="keyword1"><span class="command">have</span></span> ιn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι'</span> <span class="main">&lt;</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> in' ιi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> nretι'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="skolem">ι'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> csι last_cs le_eq_less_or_eq lessI path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sucι term_path_stable<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> path csι<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> csn<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nretι' ιn'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ι</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nj ji' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">hence</span></span> cdiι<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">ι</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> loop' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">hence</span></span> csιi'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">ι'</span> <span class="main">≺</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csι <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_is_cs_less<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> cssel<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">π'</span> <span class="main">¡</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">ι'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">ι</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csι <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cdiι cd_not_ret cs_select_id path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="skolem">ι'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csιi' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> contradicts.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cssel π' π sucι <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> domi' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">n'</span>›</span></span>
          <span class="keyword1"><span class="command">hence</span></span> ni<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span><span class="main">&lt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> cdin<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> cd<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> loop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> csni'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">≺</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_is_cs_less<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> cssel<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">π</span> <span class="main">¡</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cdin cd_not_ret cs_select_id path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csni' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> contradicts.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cssel π' π sucn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> domi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> obs_neq_some_contradicts<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="free">σ'</span> <span class="keyword2"><span class="keyword">defines</span></span> π<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">≡</span> path <span class="free">σ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">≡</span> path <span class="free">σ'</span>›</span></span> 
<span class="keyword2"><span class="keyword">assumes</span></span> obsne<span class="main">:</span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ</span> <span class="free">k</span> <span class="main">≠</span> obs <span class="free">σ'</span> <span class="free">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> not_none<span class="main">:</span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ</span> <span class="free">k</span> <span class="main">≠</span> None›</span></span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ'</span> <span class="free">k</span> <span class="main">≠</span> None›</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span> <span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">k'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span> <span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="main">∧</span> <span class="free">π</span> <span class="bound">k</span> <span class="main">∈</span> dom att<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ'</span> <span class="main">,</span><span class="bound">k'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">π'</span> <span class="bound">k'</span> <span class="main">∈</span> dom att<span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> iki<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">k</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> not_none<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> π obs_some_kth_obs<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> iki'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="free">k</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> not_none<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> π' obs_some_kth_obs<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹obsp <span class="free">σ</span> <span class="skolem">i</span> <span class="main">=</span> obs <span class="free">σ</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> π iki kth_obs_unique obs_def the_equality<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹obsp <span class="free">σ'</span> <span class="skolem">i'</span> <span class="main">=</span> obs <span class="free">σ'</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> π' iki' kth_obs_unique obs_def the_equality<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> obspne<span class="main">:</span> <span class="quoted"><span class="quoted">‹obsp <span class="free">σ</span> <span class="skolem">i</span> <span class="main">≠</span> obsp <span class="free">σ'</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> obsne <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> obs_neq_some_contradicts'<span class="main">[</span><span class="operator">OF</span> _ iki<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> π<span class="main"><span class="main">]</span></span> iki'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> π'<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> obspne π π' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> obs_neq_ret_contradicts<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="free">σ'</span> <span class="keyword2"><span class="keyword">defines</span></span> π<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">≡</span> path <span class="free">σ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">≡</span> path <span class="free">σ'</span>›</span></span> 
<span class="keyword2"><span class="keyword">assumes</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> obsne<span class="main">:</span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ'</span> <span class="free">i</span> <span class="main">≠</span> obs <span class="free">σ</span> <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> obs<span class="main">:</span><span class="quoted"><span class="quoted">‹obs <span class="free">σ'</span> <span class="free">i</span> <span class="main">≠</span> None›</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span> <span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">k'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span> <span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="main">∧</span> <span class="free">π</span> <span class="bound">k</span> <span class="main">∈</span> dom <span class="main">(</span>att<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ'</span> <span class="main">,</span><span class="bound">k'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">π'</span> <span class="bound">k'</span> <span class="main">∈</span> dom <span class="main">(</span>att<span class="main">)</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">j</span> <span class="bound">k'</span><span class="main">.</span> is_kth_obs <span class="free">π'</span> <span class="bound">j</span> <span class="bound">k'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∄</span> <span class="bound">k</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">k'</span><span class="main">)</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> jk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="skolem">l</span> <span class="skolem">k'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> unmatched<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">∄</span> <span class="bound">k</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> π0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">0</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> π π' path0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→<span class="skolem">j'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">≠</span> <span class="free">π'</span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> converged_cd_diverge_return<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span>›</span></span><span class="main">]</span> ret unmatched path_is_path π π' π0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ'</span> <span class="main">,</span><span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> contradicts.intros<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> csj<span class="main">]</span> π π'
    <span class="keyword1"><span class="command">using</span></span> cd_is_cs_less cd_not_ret cs_select_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="skolem">k'</span> <span class="main">∈</span> dom<span class="main">(</span>att<span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jk' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> domIff is_kth_obs_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">j</span> <span class="bound">k'</span><span class="main">.</span> is_kth_obs <span class="free">π'</span> <span class="bound">j</span> <span class="bound">k'</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="bound">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="bound">k'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π'</span> <span class="free">i</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> obs π' obs_some_kth_obs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹is_kth_obs <span class="free">π</span> <span class="free">i</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * π π' k' no_kth_obs_missing_cs path_is_path <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> π π' obs obs_neq_some_contradicts obs_none_no_kth_obs obsne <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Facts about Critical Observable Paths›</span></span>

<span class="keyword1" id="IFC-contradicting_in_cp"><span class="command">lemma</span></span> contradicting_in_cp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> leq<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">σ</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">σ'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cseq<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup>path <span class="free">σ</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> readv<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span><span class="main">∈</span>reads<span class="main">(</span>path <span class="free">σ</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> vneq<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free">v</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="free">k'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="free">v</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span>
  <span class="keyword1"><span class="command">using</span></span> cseq readv vneq <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">+</span><span class="free">k'</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">k'</span> <span class="skolem">v</span>     
  <span class="keyword3"><span class="command">assume</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup>path <span class="free">σ</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span>›</span></span>
  <span class="keyword3"><span class="command">assume</span></span> vread<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> reads <span class="main">(</span>path <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">assume</span></span> vneq<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">k'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span>›</span></span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">ka</span> <span class="bound">k'a</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">ka</span> <span class="main">+</span> <span class="bound">k'a</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">⟹</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ</span></sup><span class="hidden">⇖</span> <span class="bound">ka</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ'</span></sup><span class="hidden">⇖</span> <span class="bound">k'a</span> <span class="main">⟹</span> <span class="bound">v</span> <span class="main">∈</span> reads <span class="main">(</span>path <span class="free">σ</span> <span class="bound">ka</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="bound">ka</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="bound">k'a</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="bound">ka</span><span class="main">)</span><span class="main">,</span> <span class="free">σ'</span><span class="main">,</span> <span class="bound">k'a</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> 
  
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">≡</span> path <span class="free">σ</span>›</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">≡</span> path <span class="free">σ'</span>›</span></span> 
  <span class="keyword1"><span class="command">have</span></span> path<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">=</span> path <span class="free">σ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">=</span> path <span class="free">σ'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> π_def π'_def path_is_path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">have</span></span> ip<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π</span>›</span></span> <span class="quoted"><span class="quoted">‹is_path <span class="skolem">π'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path path_is_path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            
  <span class="keyword1"><span class="command">have</span></span> π0<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">π</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> path path_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> vread'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> reads <span class="main">(</span>path <span class="free">σ'</span> <span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csk vread <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_cs<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cseq<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csk path <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> <span class="free">σ'</span><span class="main">,</span> <span class="skolem">k'</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> vnw<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π</span> <span class="bound">l</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> σv<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">σ</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> no_writes_unchanged0 path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> vnw'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> <span class="skolem">k'</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π'</span> <span class="bound">l</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> σv'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">k'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">σ'</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> no_writes_unchanged0 path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> σv vneq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="free">σ'</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> vhigh<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> hvars›</span></span> <span class="keyword1"><span class="command">using</span></span> leq <span class="keyword1"><span class="command">unfolding</span></span> loweq_def restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cp.intros<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> leq csk vread vneq<span class="main">]</span> vnw vnw' path <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> <span class="skolem">k'</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> kddl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> dd<span class="hidden">⇗</span><sup><span class="skolem">π'</span><span class="main">,</span><span class="skolem">v</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path<span class="main">(</span>2<span class="main">)</span> path_is_path written_read_dd vread' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> lv'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> writes <span class="main">(</span><span class="skolem">π'</span> <span class="skolem">l'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> lk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ddi_def kddl'<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">l'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> lv' writes_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">have</span></span> notinπ<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">l</span>›</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> l <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">note</span></span> csl <span class="main">=</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> lk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lk' cseq ip cs_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span>›</span></span><span class="main">]</span> csl nret path <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                  
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> writes <span class="main">(</span><span class="skolem">π</span> <span class="skolem">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csl lv' last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> lk vnw <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">from</span></span> converged_cd_diverge<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> π0 notinπ lk' cseq<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span>  csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lcdi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i'</span>›</span></span>  <span class="keyword2"><span class="keyword">and</span></span> div<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
      
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> suc <span class="main">(</span><span class="skolem">π</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">i</span></sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step_suc_sem fst_conv path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path_suc<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="main">=</span> suc <span class="main">(</span><span class="skolem">π'</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">i'</span></sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step_suc_sem fst_conv path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path_suc<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">π</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csi last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> nreads<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">i</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">i'</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 2 3 div reads_restr_suc<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> v'read<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span><span class="main">∈</span> reads<span class="main">(</span>path <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">i</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v'</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">i'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> path <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> reads_restrict<span class="main">)</span>
      
      <span class="keyword1"><span class="command">have</span></span> nreti<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">i'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> csi div ip<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> last_cs lessI term_path_stable less_imp_le<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> ik'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdi lk' is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>            
      <span class="keyword1"><span class="command">have</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csi cseq nreti ik'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      
      <span class="keyword1"><span class="command">have</span></span> cpi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">using</span></span> IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span>›</span></span><span class="main">]</span> v'read csi ik ik' path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">hence</span></span> cpi'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">using</span></span> cp.intros<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      
      <span class="keyword1"><span class="command">have</span></span> nwvi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ'</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> writes <span class="main">(</span>path <span class="free">σ</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> vnw<span class="main">[</span><span class="operator">unfolded</span> path<span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> atLeastLessThan_iff<span class="main">)</span>
      
      <span class="keyword1"><span class="command">from</span></span> cp.intros<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> cpi' kddl'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> path<span class="main"><span class="main">]</span></span> lcdi<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> path<span class="main"><span class="main">]</span></span> csk<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> div<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> path<span class="main"><span class="main">]</span></span> vneq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nwvi<span class="main">]</span> 
      
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cp.intros<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> wv<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">l</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> writes <span class="main">(</span><span class="skolem">π</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>›</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> kddl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> dd<span class="hidden">⇗</span><sup><span class="skolem">π</span><span class="main">,</span><span class="skolem">v</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path<span class="main">(</span>1<span class="main">)</span> path_is_path written_read_dd vread <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> lv<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> writes <span class="main">(</span><span class="skolem">π</span> <span class="skolem">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> lk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ddi_def kddl<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">l</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> lv writes_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> nwb<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="skolem">l</span><span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes<span class="main">(</span><span class="skolem">π</span> <span class="bound">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kddl <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> σvk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup>Suc <span class="skolem">l</span></sup><span class="hidden">⇖</span> <span class="main">)</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kddl ddi_value path<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> vnw'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> <span class="skolem">k'</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π'</span> <span class="bound">l</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> σv'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">k'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">σ'</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> no_writes_unchanged0 path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> notinπ'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">l'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">l'</span>›</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> l' <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">note</span></span> csl <span class="main">=</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> lk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lk cseq ip cs_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span>›</span></span><span class="main">]</span> csl nret <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                  
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> writes <span class="main">(</span><span class="skolem">π'</span> <span class="skolem">l'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csl lv last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> lk vnw' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">from</span></span> converged_cd_diverge<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> π0<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> notinπ' lk cseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span>  csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lcdi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">i</span>›</span></span>  <span class="keyword2"><span class="keyword">and</span></span> div<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> suc <span class="main">(</span><span class="skolem">π</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">i</span></sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step_suc_sem fst_conv path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path_suc<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="main">=</span> suc <span class="main">(</span><span class="skolem">π'</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">i'</span></sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step_suc_sem fst_conv path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path_suc<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">π</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csi last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> nreads<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">i</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">i'</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 2 3 div reads_restr_suc<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> contri<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> contradicts.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> csi path nreads<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      
      <span class="keyword1"><span class="command">have</span></span> nreti<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> csi div ip<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> last_cs lessI term_path_stable less_imp_le<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdi lk is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>            
      <span class="keyword1"><span class="command">have</span></span> ik'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> csi<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nreti ik<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> nreads<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">i</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">i'</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 2 3 div reads_restr_suc<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> v'read<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span><span class="main">∈</span> reads<span class="main">(</span>path <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">i</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v'</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">i'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> path <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> reads_restrict<span class="main">)</span>
      
      
      <span class="keyword1"><span class="command">have</span></span> cpi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">using</span></span> IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span>›</span></span><span class="main">]</span> v'read csi ik ik' path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">hence</span></span> cpi'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">using</span></span> cp.intros<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      
      <span class="keyword1"><span class="command">have</span></span> vnwi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="keyword1">LEAST</span> <span class="bound">i'a</span><span class="main">.</span> <span class="skolem">i'</span> <span class="main">&lt;</span> <span class="bound">i'a</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ'</span></sup><span class="hidden">⇖</span> <span class="bound">i'a</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> writes <span class="main">(</span>path <span class="free">σ'</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> vnw'<span class="main">[</span><span class="operator">unfolded</span> path<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> atLeastLessThan_iff<span class="main">)</span>
        
      <span class="keyword1"><span class="command">from</span></span> cp.intros<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> cpi kddl<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> path<span class="main"><span class="main">]</span></span> lcdi<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> path<span class="main"><span class="main">]</span></span> csk div<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> path<span class="main"><span class="main">]</span></span> vneq vnwi<span class="main">]</span>   
      
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cp.intros<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">l</span></span><span class="main">&lt;</span><span class="skolem">k'</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> writes <span class="main">(</span><span class="skolem">π'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> kddl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> dd<span class="hidden">⇗</span><sup><span class="skolem">π'</span><span class="main">,</span><span class="skolem">v</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path<span class="main">(</span>2<span class="main">)</span> path_is_path written_read_dd vread' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> lv'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> writes <span class="main">(</span><span class="skolem">π'</span> <span class="skolem">l'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> lk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ddi_def kddl'<span class="main">)</span>            
      <span class="keyword1"><span class="command">have</span></span> nretl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">l'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> lv' writes_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> nwb'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i'</span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="skolem">l'</span><span class="main">..&lt;</span> <span class="skolem">k'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes<span class="main">(</span><span class="skolem">π'</span> <span class="bound">i'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kddl' <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> σvk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">k'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup>Suc <span class="skolem">l'</span></sup><span class="hidden">⇖</span> <span class="main">)</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kddl' ddi_value path<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span> 
        <span class="keyword3"><span class="command">assume</span></span> csl<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span>
        <span class="keyword1"><span class="command">hence</span></span> πl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">π'</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_cs<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> σvls<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup>Suc <span class="skolem">l</span></sup><span class="hidden">⇖</span> <span class="main">)</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup>Suc <span class="skolem">l'</span></sup><span class="hidden">⇖</span> <span class="main">)</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> σvk σvk' vneq<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> rσ<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">l</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">l'</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> path πl σvls written_value lv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> v'read<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span><span class="main">∈</span> reads<span class="main">(</span>path <span class="free">σ</span> <span class="skolem">l</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">l</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v'</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">l'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> path <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> reads_restrict<span class="main">)</span>
      
      
        <span class="keyword1"><span class="command">have</span></span> cpl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">using</span></span> IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span>›</span></span><span class="main">]</span> v'read csl lk lk' path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">using</span></span> cp.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> cpl kddl<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> path<span class="main"><span class="main">]</span></span> kddl'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> path<span class="main"><span class="main">]</span></span> csk vneq<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>        
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> csl<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">≠</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">i'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span>›</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csli'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> ilne'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csl csli' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> ij'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip csli' cseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nret lk<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">have</span></span> iv'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> writes<span class="main">(</span><span class="skolem">π'</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lv csli' last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">have</span></span> il'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kddl' ilne' ij' iv' <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> nreti'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">i'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> csli' nret last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

          <span class="keyword1"><span class="command">have</span></span> l'notinπ<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span>›</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> csil<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">have</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csil<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cseq nretl' lk'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">have</span></span> li<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csli'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> csil<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nreti' il'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">have</span></span> iv<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> writes<span class="main">(</span><span class="skolem">π</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lv' csil last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> kddl ik li iv is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csn<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lcdn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span>  <span class="keyword2"><span class="keyword">and</span></span> sucn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> in'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">n'</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> converged_cd_diverge_cs <span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csli'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> il' l'notinπ lk' cseq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
          
          <span class="comment1">― ‹Can apply the IH to n and n'›</span>
          
          <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> suc <span class="main">(</span><span class="skolem">π</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">n</span></sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step_suc_sem fst_conv path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path_suc<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span> <span class="main">=</span> suc <span class="main">(</span><span class="skolem">π'</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">n'</span></sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step_suc_sem fst_conv path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path_suc<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">π</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">have</span></span> nreads<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">n</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">n'</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 2 3 sucn reads_restr_suc<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> v'read<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span><span class="main">∈</span>reads <span class="main">(</span>path <span class="free">σ</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">n</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v'</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">n'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> reads_restrict<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> nl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdn' is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> nk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nl' lk' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> nretn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nl' nretl' term_path_stable less_imp_le<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> nk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csn<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cseq nretn' nk'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">hence</span></span> lenn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">+</span><span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">+</span><span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nk' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span>  
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">using</span></span> IH csn path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> ncp<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">using</span></span> cp.intros<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          
          <span class="keyword1"><span class="command">have</span></span> nles<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span><span class="main">)</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> nk cseq LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> ln<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order_le<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csli'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> csn<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nreti' in'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> 
          <span class="keyword1"><span class="command">have</span></span> lles<span class="main">:</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">l</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          
          <span class="keyword1"><span class="command">have</span></span> nwcseq<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> writes <span class="main">(</span><span class="skolem">π</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j'</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">∈</span> <span class="main">{</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>›</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> atLeastLessThan_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lles <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> atLeastLessThan_iff<span class="main">)</span> 
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span><span class="main">∈</span> <span class="main">{</span>Suc <span class="skolem">l</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> atLeastLessThan_iff<span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π</span> <span class="skolem">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nwb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          
          <span class="keyword1"><span class="command">from</span></span> cp.intros<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ncp<span class="main">,</span><span class="operator">folded</span> path<span class="main">,</span><span class="operator">OF</span> kddl' lcdn' cseq sucn<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> vneq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nwcseq<span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">,</span> <span class="free">σ</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">using</span></span> cp.intros<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> lnotinπ'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">l</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span>›</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> csli<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> ilne<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csl csli <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csli<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cseq nretl' lk'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">have</span></span> iv<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> writes<span class="main">(</span><span class="skolem">π</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lv' csli last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">have</span></span> il<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kddl ilne ij iv <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> nreti<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> csli nretl' last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csn<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lcdn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span>›</span></span>  <span class="keyword2"><span class="keyword">and</span></span> sucn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ilen<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> converged_cd_diverge_cs <span class="main">[</span><span class="operator">OF</span> ip csli il lnotinπ' lk cseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
          
            <span class="comment1">― ‹Can apply the IH to n and n'›</span>
          
            <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> suc <span class="main">(</span><span class="skolem">π</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">n</span></sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step_suc_sem fst_conv path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path_suc<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span> <span class="main">=</span> suc <span class="main">(</span><span class="skolem">π'</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">n'</span></sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step_suc_sem fst_conv path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path_suc<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">π</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">have</span></span> nreads<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">n</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">n'</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 2 3 sucn reads_restr_suc<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> v'read<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span><span class="main">∈</span>reads <span class="main">(</span>path <span class="free">σ</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">n</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v'</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">n'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> reads_restrict<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>  
            <span class="keyword1"><span class="command">have</span></span> nl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdn is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> nk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nl lk <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> nretn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">n</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ip<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nl nret term_path_stable less_imp_le<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> nk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip csn cseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nretn nk<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">hence</span></span> lenn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">+</span><span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">+</span><span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span>  
            <span class="keyword1"><span class="command">have</span></span> ncp<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">using</span></span> IH csn path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            
            <span class="keyword1"><span class="command">have</span></span> nles'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span><span class="main">)</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> nk' cseq LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> ln'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">≤</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order_le<span class="main">[</span><span class="operator">OF</span> ip csli csn nreti ilen<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> 
            <span class="keyword1"><span class="command">have</span></span> lles'<span class="main">:</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">l'</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          
            <span class="keyword1"><span class="command">have</span></span> nwcseq'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> writes <span class="main">(</span><span class="skolem">π'</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> 
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j'</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k'</span><span class="main">}</span>›</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> atLeastLessThan_iff<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">l'</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lles' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> atLeastLessThan_iff<span class="main">)</span> 
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span><span class="main">∈</span> <span class="main">{</span>Suc <span class="skolem">l'</span><span class="main">..&lt;</span><span class="skolem">k'</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> atLeastLessThan_iff<span class="main">)</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π'</span> <span class="skolem">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nwb' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
            
            <span class="keyword1"><span class="command">from</span></span> cp.intros<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ncp<span class="main">,</span><span class="operator">folded</span> path<span class="main">,</span> <span class="operator">OF</span> kddl lcdn cseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sucn vneq nwcseq'<span class="main">]</span>
            
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> l'notinπ<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span><span class="main">)</span>›</span></span>
            <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">≡</span> <span class="main">0</span><span class="main">::</span>nat›</span></span>
            <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m'</span> <span class="main">≡</span> <span class="main">0</span><span class="main">::</span>nat›</span></span>
            <span class="keyword1"><span class="command">have</span></span> csm<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">m'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> m_def m'_def cs_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> π0<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> ml<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">&lt;</span><span class="skolem">l</span> <span class="main">∨</span> <span class="skolem">m'</span><span class="main">&lt;</span><span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csm csl <span class="keyword1"><span class="command">unfolding</span></span> m_def m'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> neq0_conv<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">n</span> <span class="bound">n'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">n'</span> <span class="main">∧</span> <span class="skolem">π</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">π'</span> <span class="main">(</span>Suc <span class="bound">n'</span><span class="main">)</span> <span class="main">∧</span> 
            <span class="main">(</span><span class="skolem">l</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="bound">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="bound">n'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π'</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∨</span> <span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span>→ <span class="bound">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> csm ml <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span><span class="main">+</span><span class="skolem">k'</span><span class="main">-</span><span class="main">(</span><span class="skolem">m</span><span class="main">+</span><span class="skolem">m'</span><span class="main">)</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m'</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>
              <span class="keyword1"><span class="command">note</span></span> csm <span class="main">=</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">m'</span>›</span></span>
              <span class="keyword1"><span class="command">note</span></span> lm <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">∨</span> <span class="skolem">m'</span> <span class="main">&lt;</span> <span class="skolem">l'</span>›</span></span>
              <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">n'</span><span class="main">.</span> 
                <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">-</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">⟹</span>
                cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">n'</span> <span class="main">⟹</span>
                <span class="bound">n</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">∨</span> <span class="bound">n'</span> <span class="main">&lt;</span> <span class="skolem">l'</span> <span class="main">⟹</span> <span class="var">?thesis</span>›</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lm <span class="keyword1"><span class="command">proof</span></span>
                <span class="keyword3"><span class="command">assume</span></span> ml<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> mn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csn<span class="main">:</span> <span class="quoted"><span class="quoted">‹ cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lcdn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>›</span></span>
                  <span class="keyword1"><span class="command">using</span></span>  converged_cd_diverge_cs<span class="main">[</span><span class="operator">OF</span> ip csm ml lnotinπ' lk cseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword1"><span class="command">have</span></span> nl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdn is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">hence</span></span> nk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">&lt;</span><span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> nretn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">n</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_not_ret<span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> nk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span><span class="main">&lt;</span><span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip csn cseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nretn nk<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π'</span> <span class="bound">j'</span><span class="main">)</span>›</span></span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdn csn suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π'</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span>›</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> jin'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k'</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> vwrite<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">∈</span>writes <span class="main">(</span><span class="skolem">π'</span> <span class="skolem">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≡</span> <span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span>›</span></span>
                  <span class="keyword1"><span class="command">have</span></span> Pk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">k'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">k'</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> nk' cseq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">have</span></span> ni'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> Pk'<span class="main">]</span> i'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> Pk'<span class="main">]</span> i'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">have</span></span> ij'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span><span class="main">≤</span><span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jin'<span class="main">[</span><span class="operator">folded</span> i'_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">have</span></span> jk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span><span class="main">&lt;</span><span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jin'<span class="main">[</span><span class="operator">folded</span> i'_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">have</span></span> jl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">≤</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kddl' jk' vwrite <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">have</span></span> nretn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> nretn csn last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                  <span class="keyword1"><span class="command">have</span></span> iln<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">&lt;</span><span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csn<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> csi<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nretn' ni'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
                  <span class="keyword1"><span class="command">hence</span></span> mi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> mn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">have</span></span> nretm<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">m</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ip<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mn nretn term_path_stable<span class="main">)</span>
                  <span class="keyword1"><span class="command">have</span></span> mi'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m'</span><span class="main">&lt;</span><span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip csm csi nretm mi<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
                  <span class="keyword1"><span class="command">have</span></span> ik'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ij' jk' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">have</span></span> nreti'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">i'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ij' jl' nretl' ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> term_path_stable<span class="main">)</span>
                  <span class="keyword1"><span class="command">have</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csi<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cseq nreti' ik'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
                    <span class="keyword3"><span class="command">assume</span></span> il<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span>
                    <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span><span class="skolem">i'</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">+</span><span class="skolem">k'</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">m</span><span class="main">+</span><span class="skolem">m'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> mi mi' ik ik' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> IH<span class="main">[</span><span class="operator">OF</span> le<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> csi il <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">next</span></span>
                    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span>
                    <span class="keyword1"><span class="command">hence</span></span> li<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ij' jl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">hence</span></span> il'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span>  csi l'notinπ <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
                    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> in'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csn<span class="main">:</span> <span class="quoted"><span class="quoted">‹ cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lcdn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>›</span></span>
                      <span class="keyword1"><span class="command">using</span></span>  converged_cd_diverge_cs<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csi<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> il' _ lk' cseq<span class="main">]</span> l'notinπ <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                    <span class="keyword1"><span class="command">have</span></span> nk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdn' is_cdi_def lk' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">have</span></span> nretn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_not_ret lcdn'<span class="main">)</span>
                    <span class="keyword1"><span class="command">have</span></span> nk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csn<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cseq nretn' nk'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span> 
                    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≡</span> <span class="keyword1">LEAST</span> <span class="bound">j</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span><span class="main">)</span>›</span></span>
                    <span class="keyword1"><span class="command">have</span></span> Pk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">k</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> nk cseq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                    <span class="keyword1"><span class="command">have</span></span> nj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">&lt;</span><span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> Pk<span class="main">]</span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">have</span></span> ilen<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order_le<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csi<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> csn<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nreti' in'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span> 
                    <span class="keyword1"><span class="command">hence</span></span> lj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">&lt;</span><span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> li nj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="main">{</span><span class="skolem">l</span><span class="main">&lt;..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> writes <span class="main">(</span><span class="skolem">π</span> <span class="bound">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span>  kddl <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">hence</span></span> nw<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="main">{</span><span class="skolem">j</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> writes <span class="main">(</span><span class="skolem">π</span> <span class="bound">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn lcdn' suc nw<span class="main">[</span><span class="operator">unfolded</span> j_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">assume</span></span> ml'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m'</span> <span class="main">&lt;</span> <span class="skolem">l'</span>›</span></span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> mn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m'</span> <span class="main">≤</span> <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csn<span class="main">:</span> <span class="quoted"><span class="quoted">‹ cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lcdn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>›</span></span>
                  <span class="keyword1"><span class="command">using</span></span>  converged_cd_diverge_cs<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csm<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ml' _ lk' cseq<span class="main">]</span> l'notinπ <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                <span class="keyword1"><span class="command">have</span></span> nl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdn' is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">hence</span></span> nk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span><span class="main">&lt;</span><span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lk' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> nretn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdn' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_not_ret<span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> nk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">&lt;</span><span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csn<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cseq nretn' nk'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π</span> <span class="bound">j</span><span class="main">)</span>›</span></span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdn' csn suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>›</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> jin<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> vwrite<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">∈</span>writes <span class="main">(</span><span class="skolem">π</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≡</span> <span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span><span class="main">)</span>›</span></span>
                  <span class="keyword1"><span class="command">have</span></span> Pk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">k'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">k</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> nk cseq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">have</span></span> ni<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> Pk<span class="main">]</span> i_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> Pk<span class="main">]</span> i_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                  <span class="keyword1"><span class="command">have</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">≤</span><span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jin<span class="main">[</span><span class="operator">folded</span> i_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">have</span></span> jk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span><span class="main">&lt;</span><span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> jin<span class="main">[</span><span class="operator">folded</span> i_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">have</span></span> jl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kddl jk vwrite <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">have</span></span> nretn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">n</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> nretn' csn last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                  <span class="keyword1"><span class="command">have</span></span> iln'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span><span class="main">&lt;</span><span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip csn csi nretn ni<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
                  <span class="keyword1"><span class="command">hence</span></span> mi'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m'</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> mn' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">have</span></span> nretm'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">m'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mn' nretn' term_path_stable<span class="main">)</span>
                  <span class="keyword1"><span class="command">have</span></span> mi<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">&lt;</span><span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csm<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> csi<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nretm' mi'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
                  <span class="keyword1"><span class="command">have</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ij jk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">have</span></span> nreti<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">i</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ij ip<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> jl nret term_path_stable<span class="main">)</span>
                  <span class="keyword1"><span class="command">have</span></span> ik'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip csi cseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nreti ik<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
                    <span class="keyword3"><span class="command">assume</span></span> il'<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">l'</span>›</span></span>
                    <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span><span class="skolem">i'</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">+</span><span class="skolem">k'</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">m</span><span class="main">+</span><span class="skolem">m'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> mi mi' ik ik' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> IH<span class="main">[</span><span class="operator">OF</span> le<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> csi il' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">next</span></span>
                    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">l'</span>›</span></span>
                    <span class="keyword1"><span class="command">hence</span></span> li'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">≤</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ij jl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">hence</span></span> il<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span>  csi lnotinπ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
                    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ilen<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> csn<span class="main">:</span> <span class="quoted"><span class="quoted">‹ cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lcdn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>›</span></span>
                      <span class="keyword1"><span class="command">using</span></span>  converged_cd_diverge_cs<span class="main">[</span><span class="operator">OF</span> ip csi il _ lk cseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> lnotinπ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                    <span class="keyword1"><span class="command">have</span></span> nk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdn is_cdi_def lk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">have</span></span> nretn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">n</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_not_ret lcdn<span class="main">)</span>
                    <span class="keyword1"><span class="command">have</span></span> nk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip csn cseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nretn nk<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span> 
                    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">≡</span> <span class="keyword1">LEAST</span> <span class="bound">j'</span><span class="main">.</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="bound">j'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">j'</span><span class="main">)</span>›</span></span>
                    <span class="keyword1"><span class="command">have</span></span> Pk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">k'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">k'</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> nk' cseq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                    <span class="keyword1"><span class="command">have</span></span> nj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span><span class="main">&lt;</span><span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> Pk'<span class="main">]</span> j'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">have</span></span> in'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order_le<span class="main">[</span><span class="operator">OF</span> ip csi csn nreti ilen<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span> 
                    <span class="keyword1"><span class="command">hence</span></span> lj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span><span class="main">&lt;</span><span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> li' nj' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="main">{</span><span class="skolem">l'</span><span class="main">&lt;..&lt;</span><span class="skolem">k'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> writes <span class="main">(</span><span class="skolem">π'</span> <span class="bound">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span>  kddl' <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">hence</span></span> nw'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="main">{</span><span class="skolem">j'</span><span class="main">..&lt;</span><span class="skolem">k'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> writes <span class="main">(</span><span class="skolem">π'</span> <span class="bound">l</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lj' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn lcdn suc nw'<span class="main">[</span><span class="operator">unfolded</span> j'_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> csn<span class="main">:</span> <span class="quoted"><span class="quoted">‹ cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>›</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> cdor<span class="main">:</span> 
            <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">l</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π'</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∨</span> <span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cdor <span class="keyword1"><span class="command">proof</span></span>
              <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> local.writes <span class="main">(</span><span class="skolem">π'</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">hence</span></span> lcdn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
              <span class="keyword1"><span class="command">have</span></span> nowrite<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> local.writes <span class="main">(</span><span class="skolem">π'</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cp.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">σ</span></span>›</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">n</span></span>›</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">σ'</span></span>›</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">n'</span></span>›</span></span></span><span class="main"><span class="main">,</span></span><span class="operator">folded</span> path<span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdn <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> dd<span class="hidden">⇗</span><sup><span class="skolem">π</span><span class="main">,</span><span class="skolem">v</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kddl <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cseq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> local.writes <span class="main">(</span><span class="skolem">π'</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nowrite <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">k'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> vneq <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword1"><span class="command">have</span></span> nk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdn lk is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> nretn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="skolem">n</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_not_ret lcdn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                <span class="keyword1"><span class="command">have</span></span> nk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip csn cseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nretn nk<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword1"><span class="command">hence</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">+</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> suc <span class="main">(</span><span class="skolem">π</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">n</span></sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step_suc_sem fst_conv path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path_suc<span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span> <span class="main">=</span> suc <span class="main">(</span><span class="skolem">π'</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">n'</span></sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step_suc_sem fst_conv path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path_suc<span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">π</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                <span class="keyword1"><span class="command">have</span></span> nreads<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">n</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">n'</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 2 3 suc reads_restr_suc<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> v'read<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span><span class="main">∈</span>reads <span class="main">(</span>path <span class="free">σ</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">n</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v'</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">n'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> reads_restrict<span class="main">)</span>
                <span class="keyword1"><span class="command">ultimately</span></span>  
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">using</span></span> IH csn path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">hence</span></span> lcdn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
              <span class="keyword1"><span class="command">have</span></span> nowrite<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π</span> <span class="bound">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cp.intros<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cp.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">σ'</span></span>›</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">n'</span></span>›</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">σ</span></span>›</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">n</span></span>›</span></span></span><span class="main"><span class="main">,</span></span><span class="operator">folded</span> path<span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdn' <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> dd<span class="hidden">⇗</span><sup><span class="skolem">π'</span><span class="main">,</span><span class="skolem">v</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kddl' <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cseq <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span><span class="main">∉</span>writes <span class="main">(</span><span class="skolem">π</span> <span class="bound">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nowrite <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">k'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> vneq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">have</span></span> nk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> lcdn' lk' is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> nretn'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_not_ret lcdn' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                <span class="keyword1"><span class="command">have</span></span> nk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cs_order<span class="main">[</span><span class="operator">OF</span> ip<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> csn<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cseq nretn' nk'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword1"><span class="command">hence</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">+</span> <span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nk' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> suc <span class="main">(</span><span class="skolem">π</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">n</span></sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step_suc_sem fst_conv path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path_suc<span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span> <span class="main">=</span> suc <span class="main">(</span><span class="skolem">π'</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">n'</span></sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step_suc_sem fst_conv path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path_suc<span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π'</span> <span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">π</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csn last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                <span class="keyword1"><span class="command">have</span></span> nreads<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">n</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">n'</span></sup><span class="hidden">⇖</span> <span class="main">↾</span> reads <span class="main">(</span><span class="skolem">π</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 2 3 suc reads_restr_suc<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> v'read<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span><span class="main">∈</span>reads <span class="main">(</span>path <span class="free">σ</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">n</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v'</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">n'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> reads_restrict<span class="main">)</span>
                <span class="keyword1"><span class="command">ultimately</span></span>  
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">using</span></span> IH csn path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span><span class="main">,</span> <span class="free">σ</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">using</span></span> cp.intros<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>                
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> contradicting_in_cop<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">σ'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹path <span class="free">σ</span> <span class="free">k</span> <span class="main">∈</span> dom att›</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">∈</span> cop›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">π'</span> <span class="skolem">π</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≡</span> <span class="skolem">π</span> <span class="main">¡</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> csj<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span> <span class="skolem">j</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="skolem">π'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> j_def <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cs_not_nil cs_select_is_cs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> path_is_path<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">π'</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 1 j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> kcdj<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> cd<span class="hidden">⇗</span><sup><span class="skolem">π</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cs_not_nil cs_select_is_cs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> j_def path_is_path<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> readv<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">∈</span>reads<span class="main">(</span>path <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> vneq<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="skolem">j</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="free">k'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> suc csj <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IFC_def.suc_def 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> last_cs path_suc reads_restr_suc reads_restrict<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> contradicting_in_cp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> readv vneq csj 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">∈</span> cop›</span></span> <span class="keyword1"><span class="command">using</span></span> kcdj suc assms<span class="main">(</span>3<span class="main">)</span> cop.intros<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">π'</span> <span class="skolem">π</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> readv<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">∈</span>reads<span class="main">(</span>path <span class="free">σ</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> vneq<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="free">k'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> reads_restrict<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> contradicting_in_cp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> readv vneq 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">∈</span> cop›</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> cop.intros<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> cop_correct_term<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="free">σ'</span> <span class="keyword2"><span class="keyword">defines</span></span> π<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">≡</span> path <span class="free">σ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">≡</span> path <span class="free">σ'</span>›</span></span> 
<span class="keyword2"><span class="keyword">assumes</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">n'</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> obsne<span class="main">:</span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ</span> <span class="main">≠</span> obs <span class="free">σ'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">σ'</span>›</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span> <span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="bound">k'</span><span class="main">)</span><span class="main">∈</span> cop <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="bound">k'</span><span class="main">)</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">∈</span> cop›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span> <span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">k'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span> <span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="main">∧</span> <span class="free">π</span> <span class="bound">k</span> <span class="main">∈</span> dom <span class="main">(</span>att<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ'</span> <span class="main">,</span><span class="bound">k'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">π'</span> <span class="bound">k'</span> <span class="main">∈</span> dom <span class="main">(</span>att<span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span>  obs_neq_contradicts_term ret obsne π π' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> leq' <span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">σ'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">σ</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> leq <span class="keyword1"><span class="command">unfolding</span></span> loweq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> * contradicting_in_cop<span class="main">[</span><span class="operator">OF</span> leq<span class="main">]</span> contradicting_in_cop<span class="main">[</span><span class="operator">OF</span> leq'<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> π π' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> cop_correct_ret<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="free">σ'</span> <span class="keyword2"><span class="keyword">defines</span></span> π<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="main">≡</span> path <span class="free">σ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> π'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="main">≡</span> path <span class="free">σ'</span>›</span></span> 
<span class="keyword2"><span class="keyword">assumes</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π</span> <span class="free">n</span> <span class="main">=</span> return›</span></span> <span class="keyword2"><span class="keyword">and</span></span> obsne<span class="main">:</span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ</span> <span class="free">i</span> <span class="main">≠</span> obs <span class="free">σ'</span> <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ'</span> <span class="free">i</span> <span class="main">≠</span> None›</span></span> <span class="keyword2"><span class="keyword">and</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">σ'</span>›</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span> <span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="bound">k'</span><span class="main">)</span><span class="main">∈</span> cop <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="bound">k'</span><span class="main">)</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">∈</span> cop›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span> <span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">k'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span> <span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="main">∧</span> <span class="free">π</span> <span class="bound">k</span> <span class="main">∈</span> dom <span class="main">(</span>att<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ'</span> <span class="main">,</span><span class="bound">k'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">π'</span> <span class="bound">k'</span> <span class="main">∈</span> dom <span class="main">(</span>att<span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> π π' obs obs_neq_ret_contradicts obsne ret<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> leq' <span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="free">σ'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">σ</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> leq <span class="keyword1"><span class="command">unfolding</span></span> loweq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> * contradicting_in_cop<span class="main">[</span><span class="operator">OF</span> leq<span class="main">]</span> contradicting_in_cop<span class="main">[</span><span class="operator">OF</span> leq'<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> π π' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> cop_correct_nterm<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> obsne<span class="main">:</span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ</span> <span class="free">k</span> <span class="main">≠</span> obs <span class="free">σ'</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ</span> <span class="free">k</span> <span class="main">≠</span> None›</span></span> <span class="quoted"><span class="quoted">‹obs <span class="free">σ'</span> <span class="free">k</span> <span class="main">≠</span> None›</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">σ'</span>›</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">k</span> <span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="bound">k'</span><span class="main">)</span><span class="main">∈</span> cop <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="bound">k'</span><span class="main">)</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">∈</span> cop›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">k'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span> <span class="main">,</span><span class="skolem">k</span><span class="main">)</span> <span class="main">∧</span> path <span class="free">σ</span> <span class="skolem">k</span> <span class="main">∈</span> dom att<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ'</span> <span class="main">,</span><span class="skolem">k'</span><span class="main">)</span> <span class="main">∧</span> path <span class="free">σ'</span> <span class="skolem">k'</span> <span class="main">∈</span> dom att<span class="main">)</span>›</span></span> 
  <span class="keyword1"><span class="command">using</span></span> obs_neq_some_contradicts<span class="main">[</span><span class="operator">OF</span> obsne<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">k'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span> <span class="main">,</span><span class="skolem">k</span><span class="main">)</span> <span class="main">∧</span> path <span class="free">σ</span> <span class="skolem">k</span> <span class="main">∈</span> dom att›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="skolem">k</span><span class="main">)</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">k'</span><span class="main">)</span> <span class="main">∈</span> cop›</span></span> <span class="keyword1"><span class="command">using</span></span> leq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> contradicting_in_cop<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ'</span> <span class="main">,</span><span class="skolem">k'</span><span class="main">)</span> <span class="main">∧</span> path <span class="free">σ'</span> <span class="skolem">k'</span> <span class="main">∈</span> dom att›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">k'</span><span class="main">)</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> cop›</span></span> <span class="keyword1"><span class="command">using</span></span> leq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> contradicting_in_cop loweq_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of the Characterisation›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:cor-cp}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following is our main correctness result. If there exist no critical observable paths,
then the program is secure.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> cop_correct<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹cop <span class="main">=</span> empty›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹secure›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> secure›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">‹ <span class="skolem">σ</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">σ'</span>›</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> obs <span class="skolem">σ</span> <span class="main">≈</span> obs <span class="skolem">σ'</span> <span class="main">∨</span> <span class="main">(</span>terminates <span class="skolem">σ</span> <span class="main">∧</span> <span class="main">¬</span> obs <span class="skolem">σ'</span> <span class="main">≲</span> obs <span class="skolem">σ</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> secure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> obs <span class="skolem">σ</span> <span class="main">≈</span> obs <span class="skolem">σ'</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹obs <span class="skolem">σ</span> <span class="skolem">k</span> <span class="main">≠</span> obs <span class="skolem">σ'</span> <span class="skolem">k</span> <span class="main">∧</span> obs <span class="skolem">σ</span> <span class="skolem">k</span> <span class="main">≠</span> None <span class="main">∧</span> obs <span class="skolem">σ'</span> <span class="skolem">k</span> <span class="main">≠</span> None›</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> obs_comp_def obs_prefix_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kth_obs_stable linorder_neqE_nat obs_none_no_kth_obs obs_some_kth_obs<span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> cop_correct_nterm leq assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹terminates <span class="skolem">σ</span> <span class="main">∧</span> <span class="main">¬</span> obs <span class="skolem">σ'</span> <span class="main">≲</span> obs <span class="skolem">σ</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">‹path <span class="skolem">σ</span> <span class="skolem">n</span> <span class="main">=</span> return›</span></span>  
      <span class="keyword1"><span class="command">unfolding</span></span> terminates_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹obs <span class="skolem">σ</span> <span class="skolem">k</span> <span class="main">≠</span> obs <span class="skolem">σ'</span> <span class="skolem">k</span> <span class="main">∧</span> obs <span class="skolem">σ'</span> <span class="skolem">k</span> <span class="main">≠</span> None›</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> obs_prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> cop_correct_ret ret leq assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our characterisation is not only correct, it is also precise in the way that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>cp›</span></span></span></span> characterises 
exactly the matching indices in executions for low equivalent input states where diverging data is read. 
This follows easily as the inverse implication to lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>contradicting_in_cp›</span></span></span></span> can be shown by simple induction.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> cp_iff_reads_contradict<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cp <span class="main">⟷</span> <span class="free">σ</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">σ'</span> <span class="main">∧</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">∈</span>reads<span class="main">(</span>path <span class="free">σ</span> <span class="free">k</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="free">k'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span>›</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">σ'</span> <span class="main">∧</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">∈</span>reads <span class="main">(</span>path <span class="free">σ</span> <span class="free">k</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="free">k'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span><span class="main">,</span> <span class="free">σ'</span><span class="main">,</span> <span class="free">k'</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> <span class="keyword1"><span class="command">using</span></span> contradicting_in_cp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span><span class="main">,</span> <span class="free">σ'</span><span class="main">,</span> <span class="free">k'</span><span class="main">)</span> <span class="main">∈</span> cp›</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">σ'</span> <span class="main">∧</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ</span></sup><span class="hidden">⇖</span> <span class="free">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="free">σ'</span></sup><span class="hidden">⇖</span> <span class="free">k'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">∈</span>reads <span class="main">(</span>path <span class="free">σ</span> <span class="free">k</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">σ</span><span class="hidden">⇗</span><sup><span class="free">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ'</span><span class="hidden">⇗</span><sup><span class="free">k'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">σ</span> <span class="skolem">σ'</span> <span class="skolem">n</span> <span class="skolem">n'</span> <span class="skolem">h</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">σ</span> <span class="skolem">k</span> <span class="skolem">σ'</span> <span class="skolem">k'</span> <span class="skolem">n</span> <span class="skolem">v</span> <span class="skolem">n'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">∈</span>reads <span class="main">(</span>path <span class="skolem">σ</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">σ</span> <span class="skolem">k</span> <span class="skolem">σ'</span> <span class="skolem">k'</span> <span class="skolem">n</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">n'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">∈</span>reads <span class="main">(</span>path <span class="skolem">σ</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">,</span>6<span class="main">,</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">σ</span> <span class="skolem">k</span> <span class="skolem">σ'</span> <span class="skolem">k'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup>path <span class="skolem">σ</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="skolem">σ'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹path <span class="skolem">σ'</span> <span class="skolem">k'</span> <span class="main">=</span> path <span class="skolem">σ</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_cs<span class="main">)</span> 
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">σ</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> loweq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the same way the inverse implication to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>contradicting_in_cop›</span></span></span></span> follows easily 
such that we obtain the following characterisation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>cop›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> cop_iff_contradicting<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cop <span class="main">⟷</span> <span class="free">σ</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">σ'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">∧</span> path <span class="free">σ</span> <span class="free">k</span> <span class="main">∈</span> dom att›</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">σ'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">k'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">∧</span> path <span class="free">σ</span> <span class="free">k</span> <span class="main">∈</span> dom att›</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cop›</span></span> <span class="keyword1"><span class="command">using</span></span> contradicting_in_cop <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> cop›</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹ <span class="free">σ</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">σ'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="keyword1">𝔠</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">∧</span> path <span class="free">σ</span> <span class="free">k</span> <span class="main">∈</span> dom att›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cop.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cp_iff_reads_contradict contradicts.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> reads_restrict1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cp_iff_reads_contradict contradicts.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cd_is_cs_less cd_not_ret contradicts.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs_select_id path_is_path<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of the Single Path Approximation›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:cor-scp}›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> cp_in_scp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>cp›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>path <span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">∈</span>scp <span class="main">∧</span> <span class="main">(</span>path <span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span><span class="main">∈</span>scp›</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span>›</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>cp.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> read_high dd dcd sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>read_high <span class="skolem">σ</span> <span class="skolem">σ'</span> <span class="skolem">k</span> <span class="skolem">k'</span> <span class="skolem">h</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ</span><span class="hidden">⇗</span><sup><span class="skolem">k</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">h</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> read_high<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_writes_unchanged0<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ'</span> <span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ'</span><span class="hidden">⇗</span><sup><span class="skolem">k'</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="skolem">h</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> read_high<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_writes_unchanged0<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="skolem">h</span> <span class="main">≠</span> <span class="skolem">σ'</span> <span class="skolem">h</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> read_high<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span><span class="main">∈</span>hvars›</span></span> <span class="keyword1"><span class="command">using</span></span> read_high<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> loweq_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Compl_iff IFC_def.restrict_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>path <span class="skolem">σ</span><span class="main">,</span><span class="skolem">k</span><span class="main">)</span><span class="main">∈</span>scp›</span></span> <span class="keyword1"><span class="command">using</span></span> scp.intros<span class="main">(</span>1<span class="main">)</span> read_high<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹path <span class="skolem">σ</span> <span class="skolem">k</span> <span class="main">=</span> path <span class="skolem">σ'</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> read_high<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_cs<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>path <span class="skolem">σ'</span><span class="main">,</span><span class="skolem">k'</span><span class="main">)</span><span class="main">∈</span>scp›</span></span> <span class="keyword1"><span class="command">using</span></span> scp.intros<span class="main">(</span>1<span class="main">)</span> read_high<span class="main">(</span>3<span class="main">,</span>6<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dd <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> scp.intros<span class="main">(</span>3<span class="main">)</span> dd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> sym <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>dcd <span class="skolem">σ</span> <span class="skolem">k</span> <span class="skolem">σ'</span> <span class="skolem">k'</span> <span class="skolem">n</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">n'</span><span class="main">)</span>   
  <span class="keyword1"><span class="command">note</span></span> scp.intros<span class="main">(</span>4<span class="main">)</span> is_dcdi_via_def cd_cs_swap cs_ipd
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>path <span class="skolem">σ</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">∈</span>scp›</span></span> <span class="keyword1"><span class="command">using</span></span> dcd.IH dcd.hyps<span class="main">(</span>2<span class="main">)</span> dcd.hyps<span class="main">(</span>3<span class="main">)</span> scp.intros<span class="main">(</span>2<span class="main">)</span> scp.intros<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> csk<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup>path <span class="skolem">σ</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="skolem">σ'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cp_eq_cs<span class="main">[</span><span class="operator">OF</span> dcd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> kn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span><span class="main">&lt;</span><span class="skolem">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> kl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span><span class="main">&lt;</span><span class="skolem">l</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ln<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">&lt;</span><span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> dcd<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nret<span class="main">:</span> <span class="quoted"><span class="quoted">‹path <span class="skolem">σ</span> <span class="skolem">k</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_not_ret dcd.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> kn csk dcd<span class="main">(</span>4<span class="main">)</span> cs_order nret path_is_path last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>path <span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span><span class="main">∈</span>scp›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>    
    <span class="keyword3"><span class="command">assume</span></span> j'ex<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k'</span><span class="main">..&lt;</span><span class="skolem">n'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∈</span> writes <span class="main">(</span>path <span class="skolem">σ'</span> <span class="bound">j'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> <span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k'</span><span class="main">..&lt;</span><span class="skolem">n'</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">∈</span> writes <span class="main">(</span>path <span class="skolem">σ'</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> GreatestI_ex_nat<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">==</span> <span class="keyword1">GREATEST</span> <span class="bound">j'</span><span class="main">.</span> <span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k'</span><span class="main">..&lt;</span><span class="skolem">n'</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">∈</span> writes <span class="main">(</span>path <span class="skolem">σ'</span> <span class="bound">j'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">note</span></span> ** <span class="main">=</span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span>›</span></span><span class="main">,</span><span class="operator">folded</span> j'_def<span class="main">]</span>  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span><span class="main">&lt;</span><span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> j'write<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> writes <span class="main">(</span>path <span class="skolem">σ'</span> <span class="skolem">j'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> atLeastLessThan_iff j'_def nat_less_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> nowrite<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i'</span><span class="main">∈</span><span class="main">{</span><span class="skolem">j'</span><span class="main">&lt;..&lt;</span><span class="skolem">n'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> writes<span class="main">(</span>path <span class="skolem">σ'</span> <span class="bound">i'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j'</span><span class="main">&lt;..&lt;</span><span class="skolem">n'</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v</span> <span class="main">∉</span> local.writes <span class="main">(</span>path <span class="skolem">σ'</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k'</span><span class="main">..&lt;</span><span class="skolem">n'</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">∈</span> local.writes <span class="main">(</span>path <span class="skolem">σ'</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> Greatest_le_nat
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> atLeastLessThan_iff j'_def nat_less_le<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j'</span><span class="main">&lt;..&lt;</span><span class="skolem">n'</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹path <span class="skolem">σ'</span> <span class="skolem">n'</span> <span class="main">=</span> path <span class="skolem">σ</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> dcd<span class="main">(</span>4<span class="main">)</span> last_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">∈</span>reads<span class="main">(</span>path <span class="skolem">σ'</span> <span class="skolem">n'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> dcd<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">hence</span></span> nddj'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> dd<span class="hidden">⇗</span><sup>path <span class="skolem">σ'</span><span class="main">,</span><span class="skolem">v</span></sup><span class="hidden">⇖</span>→ <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> dcd<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">using</span></span> nowrite <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span><span class="main">&lt;</span><span class="skolem">n'</span>›</span></span> j'write <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> cd<span class="hidden">⇗</span><sup>path <span class="skolem">σ'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>path <span class="skolem">σ'</span><span class="main">,</span><span class="skolem">n'</span><span class="main">)</span> <span class="main">∈</span> scp›</span></span> <span class="keyword1"><span class="command">using</span></span> scp.intros<span class="main">(</span>2<span class="main">)</span> scp.intros<span class="main">(</span>3<span class="main">)</span> dcd.IH nddj' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> jcdk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">j'</span> cd<span class="hidden">⇗</span><sup>path <span class="skolem">σ'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">=</span> <span class="skolem">k'</span>›</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> scp.intros<span class="main">(</span>3<span class="main">)</span> dcd.IH nddj' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">≠</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹path <span class="skolem">σ'</span> <span class="skolem">j'</span> <span class="main">≠</span> return›</span></span> <span class="keyword1"><span class="command">using</span></span> j'write writes_return <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> ipdex'<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span><span class="main">{</span><span class="skolem">k'</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span> <span class="main">∧</span> path <span class="skolem">σ'</span> <span class="bound">j</span> <span class="main">=</span> ipd <span class="main">(</span>path <span class="skolem">σ'</span> <span class="skolem">k'</span><span class="main">)</span> ›</span></span> <span class="keyword1"><span class="command">using</span></span> path_is_path <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="skolem">j'</span>›</span></span> jcdk' is_cdi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">==</span> <span class="keyword1">LEAST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">∈</span> <span class="main">{</span><span class="skolem">k'</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span> <span class="main">∧</span> path <span class="skolem">σ'</span> <span class="bound">j</span> <span class="main">=</span> ipd <span class="main">(</span>path <span class="skolem">σ'</span> <span class="skolem">k'</span><span class="main">)</span>›</span></span>        
        <span class="keyword1"><span class="command">have</span></span> iipd'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span><span class="main">∈</span> <span class="main">{</span><span class="skolem">k'</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹path <span class="skolem">σ'</span> <span class="skolem">i'</span> <span class="main">=</span> ipd <span class="main">(</span>path <span class="skolem">σ'</span> <span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i'_def <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">OF</span> ipdex'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k'</span><span class="main">..&lt;</span><span class="skolem">i'</span><span class="main">}</span><span class="main">.</span> path <span class="skolem">σ'</span> <span class="bound">i</span> <span class="main">≠</span> ipd <span class="main">(</span>path <span class="skolem">σ'</span> <span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span>  *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k'</span><span class="main">..&lt;</span><span class="skolem">i'</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> path <span class="skolem">σ'</span> <span class="skolem">i</span> <span class="main">≠</span> ipd <span class="main">(</span>path <span class="skolem">σ'</span> <span class="skolem">k'</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span><span class="main">{</span><span class="skolem">k'</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span> <span class="main">∧</span> path <span class="skolem">σ'</span> <span class="skolem">i</span> <span class="main">=</span> ipd <span class="main">(</span>path <span class="skolem">σ'</span> <span class="skolem">k'</span><span class="main">)</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">i</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> iipd'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span>›</span></span><span class="main">]</span> i'_def * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> iipd'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> csk last_cs nret path_in_nodes ipd_not_self<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span><span class="main">&lt;</span><span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> iipd'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> csi'<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup>path <span class="skolem">σ'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">n</span><span class="main">←</span>cs<span class="hidden">⇗</span><sup>path <span class="skolem">σ'</span></sup><span class="hidden">⇖</span> <span class="skolem">k'</span> <span class="main">.</span> ipd <span class="bound">n</span> <span class="main">≠</span> path <span class="skolem">σ'</span> <span class="skolem">i'</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>path <span class="skolem">σ'</span> <span class="skolem">i'</span><span class="main">]</span>›</span></span><span class="keyword1"><span class="command">using</span></span> cs_ipd<span class="main">[</span><span class="operator">OF</span> iipd'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
        
        <span class="keyword1"><span class="command">have</span></span> ncdk'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">n'</span> cd<span class="hidden">⇗</span><sup>path <span class="skolem">σ'</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="skolem">n'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="skolem">j'</span>›</span></span> cdi_prefix jcdk' less_imp_le_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> ncdk<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">n</span> cd<span class="hidden">⇗</span><sup>path <span class="skolem">σ</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> cd_cs_swap csk dcd<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>        
        <span class="keyword1"><span class="command">have</span></span> ipdex<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">∧</span> path <span class="skolem">σ</span> <span class="bound">i</span> <span class="main">=</span> ipd <span class="main">(</span>path <span class="skolem">σ</span> <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">‹path <span class="skolem">σ</span> <span class="skolem">n</span> <span class="main">=</span> return›</span></span> 
          <span class="keyword1"><span class="command">from</span></span> path_ret_ipd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹path <span class="skolem">σ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span>›</span></span><span class="main">,</span><span class="operator">OF</span> path_is_path nret *<span class="main">]</span>          
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">‹path <span class="skolem">σ</span> <span class="skolem">n</span> <span class="main">≠</span> return›</span></span>           
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> not_cd_impl_ipd <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹path <span class="skolem">σ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> path_is_path <span class="quoted"><span class="quoted">‹<span class="skolem">k</span><span class="main">&lt;</span><span class="skolem">n</span>›</span></span> ncdk *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">==</span> <span class="keyword1">LEAST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">∧</span> path <span class="skolem">σ</span> <span class="bound">j</span> <span class="main">=</span> ipd <span class="main">(</span>path <span class="skolem">σ</span> <span class="skolem">k</span><span class="main">)</span>›</span></span>        
        <span class="keyword1"><span class="command">have</span></span> iipd<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹path <span class="skolem">σ</span> <span class="skolem">i</span> <span class="main">=</span> ipd <span class="main">(</span>path <span class="skolem">σ</span> <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i_def <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">OF</span> ipdex<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span><span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">i'</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">.</span> path <span class="skolem">σ</span> <span class="bound">i'</span> <span class="main">≠</span> ipd <span class="main">(</span>path <span class="skolem">σ</span> <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="keyword3"><span class="command">assume</span></span>  *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> path <span class="skolem">σ</span> <span class="skolem">i'</span> <span class="main">≠</span> ipd <span class="main">(</span>path <span class="skolem">σ</span> <span class="skolem">k</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∈</span><span class="main">{</span><span class="skolem">k</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">∧</span> path <span class="skolem">σ</span> <span class="skolem">i'</span> <span class="main">=</span> ipd <span class="main">(</span>path <span class="skolem">σ</span> <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">i'</span>›</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> iipd<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span>›</span></span><span class="main">]</span> i_def * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> iipd<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nret path_in_nodes ipd_not_self<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span><span class="main">&lt;</span><span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> iipd<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup>path <span class="skolem">σ</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">[</span><span class="bound">n</span><span class="main">←</span>cs<span class="hidden">⇗</span><sup>path <span class="skolem">σ</span></sup><span class="hidden">⇖</span> <span class="skolem">k</span> <span class="main">.</span> ipd <span class="bound">n</span> <span class="main">≠</span> path <span class="skolem">σ</span> <span class="skolem">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>path <span class="skolem">σ</span> <span class="skolem">i</span><span class="main">]</span>›</span></span><span class="keyword1"><span class="command">using</span></span> cs_ipd<span class="main">[</span><span class="operator">OF</span> iipd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> **<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
        <span class="keyword1"><span class="command">hence</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup>path <span class="skolem">σ</span></sup><span class="hidden">⇖</span> <span class="skolem">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="skolem">σ'</span></sup><span class="hidden">⇖</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> csi' csk <span class="keyword1"><span class="command">unfolding</span></span> iipd'<span class="main">(</span>2<span class="main">)</span> iipd<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_cs<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i'</span><span class="main">.</span> <span class="skolem">k'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> cs<span class="hidden">⇗</span><sup>path <span class="skolem">σ</span></sup><span class="hidden">⇖</span> <span class="bound">i</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup>path <span class="skolem">σ'</span></sup><span class="hidden">⇖</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">i'</span>›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">_</span>›</span></span><span class="main">)</span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> nw<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i'</span><span class="main">..&lt;</span><span class="skolem">n'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∉</span> writes <span class="main">(</span>path <span class="skolem">σ'</span> <span class="bound">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> dcd<span class="main">(</span>7<span class="main">)</span> allB_atLeastLessThan_lower <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> writes <span class="main">(</span>path <span class="skolem">σ'</span> <span class="skolem">j'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nddj' <span class="keyword1"><span class="command">unfolding</span></span> is_ddi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> iipd'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹False›</span></span>  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j'</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k'</span><span class="main">..&lt;</span><span class="skolem">n'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">∈</span> writes <span class="main">(</span>path <span class="skolem">σ'</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span>›</span></span>
    
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> dcd<span class="hidden">⇗</span><sup>path <span class="skolem">σ'</span><span class="main">,</span><span class="skolem">v</span></sup><span class="hidden">⇖</span>→ <span class="skolem">k'</span> <span class="keyword1">via</span> <span class="main">(</span>path <span class="skolem">σ</span><span class="main">)</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_dcdi_via_def <span class="keyword1"><span class="command">using</span></span> dcd<span class="main">(</span>2-4<span class="main">)</span> csk <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span><span class="main">&lt;</span><span class="skolem">n'</span>›</span></span> path_is_path <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>    
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thesis</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> dcd.IH scp.intros<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span>›</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>   


<span class="keyword1"><span class="command">theorem</span></span> cop_in_scop<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>cop›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>path <span class="free">σ</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">∈</span>scop <span class="main">∧</span> <span class="main">(</span>path <span class="free">σ'</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span><span class="main">∈</span>scp›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cop.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cp_in_scp<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> cp_in_scp scop.intros scp.intros<span class="main">(</span>2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> cp_in_scp scop.intros scp.intros<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main correctness result for out single execution approximation follows directly.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> scop_correct<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹scop <span class="main">=</span> empty›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹secure›</span></span> 
  <span class="keyword1"><span class="command">using</span></span> cop_correct assms cop_in_scop <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="PDG">
<div class="head">
<h1>Theory PDG</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Example: Program Dependence Graphs›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:pdg}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Program dependence graph (PDG) based slicing provides a very crude but direct approximation of 
our characterisation. As such we can easily derive a corresponding correctness result.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PDG <span class="keyword2"><span class="keyword">imports</span></span> <a href="IFC.html">IFC</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> IFC 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We utilise our established dependencies on program paths to define the PDG. Note that PDGs 
usually only contain immediate control dependencies instead of the transitive ones we use here.
However as slicing is considering reachability questions this does not affect the result.›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">pdg</span> <span class="keyword2"><span class="keyword">where</span></span> 
<span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> cd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">pdg</span>›</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> dd<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span></sup><span class="hidden">⇖</span>→ <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">pdg</span>›</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of sources is the set of nodes reading high variables.›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">sources</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">∈</span> hvars <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">∈</span> reads <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">∈</span> <span class="free">sources</span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The forward slice is the set of nodes reachable in the PDG from the set of sources.  To ensure 
security slicing aims to prove that no observable node is contained in the ›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">slice</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">∈</span> sources <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> <span class="free">slice</span>›</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∈</span> <span class="free">slice</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">∈</span>pdg <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> <span class="free">slice</span>›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As the PDG does not contain data control dependencies themselves we have to decompose these.›</span></span>
<span class="keyword1" id="PDG-dcd_pdg"><span class="command">lemma</span></span> dcd_pdg<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> dcd<span class="hidden">⇗</span><sup><span class="free">π</span><span class="main">,</span><span class="free">v</span></sup><span class="hidden">⇖</span>→ <span class="free">m</span> <span class="keyword1">via</span> <span class="free">π'</span> <span class="free">m'</span>›</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> <span class="free">m</span><span class="main">,</span><span class="free">l</span><span class="main">)</span><span class="main">∈</span> pdg›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">π</span> <span class="free">n</span><span class="main">)</span><span class="main">∈</span>pdg›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="free">π</span> <span class="free">m</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∈</span> pdg <span class="main">⟹</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">π</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> pdg <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ln<span class="main">:</span> <span class="quoted"><span class="quoted">‹cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">m</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="free">m'</span> <span class="main">∧</span> cs<span class="hidden">⇗</span><sup><span class="free">π</span></sup><span class="hidden">⇖</span> <span class="free">n</span> <span class="main">=</span> cs<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span> <span class="skolem">n'</span> <span class="main">∧</span> <span class="skolem">n'</span> dd<span class="hidden">⇗</span><sup><span class="free">π'</span><span class="main">,</span><span class="free">v</span></sup><span class="hidden">⇖</span>→ <span class="skolem">l'</span> <span class="main">∧</span> <span class="skolem">l'</span> cd<span class="hidden">⇗</span><sup><span class="free">π'</span></sup><span class="hidden">⇖</span>→ <span class="free">m'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_dcdi_via_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span>  mn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">π'</span> <span class="free">m'</span> <span class="main">=</span> <span class="free">π</span> <span class="free">m</span> <span class="main">∧</span> <span class="free">π'</span> <span class="skolem">n'</span> <span class="main">=</span> <span class="free">π</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_cs ln<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span> <span class="free">m</span><span class="main">,</span> <span class="free">π'</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">∈</span> pdg›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ln mn pdg.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π'</span> <span class="skolem">l'</span><span class="main">,</span> <span class="free">π</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> pdg›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ln mn pdg.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹By induction it directly follows that the slice is an approximation of the single critical paths.›</span></span>
<span class="keyword1" id="PDG-scp_slice"><span class="command">lemma</span></span> scp_slice<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">∈</span> scp <span class="main">⟹</span> <span class="free">π</span> <span class="free">i</span> <span class="main">∈</span> slice›</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> scp.induct<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_in_nodes slice.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sources.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> pdg.intros<span class="main">(</span>1<span class="main">)</span> slice.intros<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> pdg.intros<span class="main">(</span>2<span class="main">)</span> slice.intros<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dcd_pdg slice.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="PDG-scop_slice"><span class="command">lemma</span></span> scop_slice<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">π</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> scop <span class="main">⟹</span> <span class="free">π</span> <span class="free">i</span> <span class="main">∈</span> slice <span class="main">∩</span> dom<span class="main">(</span>att<span class="main">)</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntI scop.cases scp_slice<span class="main">)</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The requirement targeted by slicing, that no observable node is contained in the slice, 
is thereby a sound criteria for security.›</span></span>
<span class="keyword1" id="PDG-pdg_correct"><span class="command">lemma</span></span> pdg_correct<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹slice <span class="main">∩</span> dom<span class="main">(</span>att<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹secure›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> secure›</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">π</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> scop›</span></span> <span class="keyword1"><span class="command">using</span></span> scop_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">‹False›</span></span> <span class="keyword1"><span class="command">using</span></span> scop_slice assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>