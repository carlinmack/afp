<div id="Weighted_Path_Length">
<div class="head">
<h1>Theory Weighted_Path_Length</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Weighted Path Length of BST"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Weighted_Path_Length
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Tree.html">HOL-Library.Tree</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory presents two definitions of the \emph{weighted path length} of a BST,
the objective function we want to minimize,
and proves them equivalent. Function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Wpl›</span></span></span></span> is the intuitive global definition
that sums <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a›</span></span></span></span> over all leaves and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>b›</span></span></span></span> over all nodes, taking their depth (= number of
comparisons to reach that point) into account. Function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>wpl›</span></span></span></span> is a recursive definition
and thus suitable for the later dynamic programming approaches
to building a BST with the minimal weighted path length.
›</span></span>

<span class="keyword1" id="Weighted_Path_Length-inorder_upto_split"><span class="command">lemma</span></span> inorder_upto_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inorder <span class="main">⟨</span><span class="free">l</span><span class="main">,</span><span class="free">k</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inorder <span class="free">l</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"inorder <span class="free">r</span> <span class="main">=</span> <span class="main">[</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">∈</span>set<span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_inorder tree.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">@</span> <span class="free">k</span> <span class="main">#</span> <span class="main">[</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> k upto_rec1 upto_split1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastAtMost_iff set_upto<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder <span class="free">l</span> <span class="main">@</span> <span class="free">k</span> <span class="main">#</span> inorder <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inorder <span class="free">l</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">∧</span> inorder <span class="free">r</span> <span class="main">=</span> <span class="main">[</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">]</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∧</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> append_Cons_eq_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">incr2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">×</span> nat <span class="main">⇒</span> int <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">incr2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">leaves</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int tree <span class="main">⇒</span> <span class="main">(</span>int <span class="main">*</span> nat<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">leaves</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> Leaf <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">leaves</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> incr2 <span class="main">`</span> <span class="main">(</span><span class="free">leaves</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∪</span> <span class="free">leaves</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int tree <span class="main">⇒</span> <span class="main">(</span>int <span class="main">*</span> nat<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nodes</span> Leaf <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nodes</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span><span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> incr2 <span class="main">`</span> <span class="main">(</span><span class="free">nodes</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∪</span> <span class="free">nodes</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Weighted_Path_Length-finite_nodes"><span class="command">lemma</span></span> finite_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Weighted_Path_Length-finite_leaves"><span class="command">lemma</span></span> finite_leaves<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>leaves <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> leaves.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Weighted_Path_Length-notin_nodes0"><span class="command">lemma</span></span> notin_nodes0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∉</span> nodes <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Weighted_Path_Length-sum_incr2"><span class="command">lemma</span></span> sum_incr2<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span>incr2 <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">xy</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span>fst <span class="bound">xy</span><span class="main">,</span>snd <span class="bound">xy</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span>incr2 <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> incr2<span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> sum.reindex<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">o</span> incr2 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xy</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span>fst <span class="bound">xy</span><span class="main">,</span>snd <span class="bound">xy</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Weighted_Path_Length-fst_nodes"><span class="command">lemma</span></span> fst_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> nodes <span class="free">t</span> <span class="main">=</span> set_tree <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def set_eq_iff ball_Un<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Weighted_Path_Length-fst_leaves"><span class="command">lemma</span></span> fst_leaves<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inorder <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span><span class="main">;</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">⟧</span> <span class="main">⟹</span> fst <span class="main">`</span> leaves <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">t1</span> <span class="skolem">k</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> inorder <span class="main">=</span> inorder_upto_split<span class="main">[</span><span class="operator">OF</span> Node.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span>  Node.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inorder<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> Node.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inorder<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> inorder<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> Node.prems<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def set_eq_iff bex_Un<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Weighted_Path_Length-sum_leaves"><span class="command">lemma</span></span> sum_leaves<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inorder <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span><span class="main">;</span>  <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>leaves <span class="free">i</span> <span class="free">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">k</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> inorder <span class="main">=</span> inorder_upto_split<span class="main">[</span><span class="operator">OF</span> Node.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ll</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"leaves <span class="skolem">i</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Lr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"leaves <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?Ll</span> <span class="main">∪</span> <span class="var">?Lr</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="var">?Ll</span> <span class="main">∩</span> fst <span class="main">`</span> <span class="var">?Lr</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inorder
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst_leaves <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> set_inorder <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_inorder<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> l0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Ll</span> <span class="main">∩</span> <span class="var">?Lr</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inorder<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inorder<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> Node.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inorder<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> inorder<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> Node.prems<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_incr2 sum_Un_nat finite_leaves l0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Weighted_Path_Length-sum_nodes"><span class="command">lemma</span></span> sum_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"inorder <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">xy</span><span class="main">∈</span>nodes <span class="free">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span>fst <span class="bound">xy</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">k</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> inorder <span class="main">=</span> inorder_upto_split<span class="main">[</span><span class="operator">OF</span> Node.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Nl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nodes <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Nr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nodes <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?Nl</span> <span class="main">∪</span> <span class="var">?Nr</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">`</span> <span class="var">?Nl</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>fst <span class="main">`</span> <span class="var">?Nr</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inorder<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst_nodes <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> set_inorder <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_inorder<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Nl</span> <span class="main">∩</span> <span class="var">?Nr</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">xy</span><span class="main">∈</span>nodes<span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">k</span> <span class="skolem">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>fst <span class="bound">xy</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">xy</span><span class="main">∈</span>insert <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span>incr2 <span class="main">`</span> <span class="main">(</span>nodes <span class="skolem">l</span> <span class="main">∪</span> nodes <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span>fst <span class="bound">xy</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">xy</span><span class="main">∈</span><span class="main">(</span>incr2 <span class="main">`</span> <span class="main">(</span>nodes <span class="skolem">l</span> <span class="main">∪</span> nodes <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span>fst <span class="bound">xy</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_nodes notin_nodes0<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inorder<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inorder<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> Node.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inorder<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> inorder<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_incr2 sum_Un_nat finite_nodes n0<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> wpl <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wpl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wpl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wpl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wpl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="free">wpl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">+</span> <span class="free">w</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> Wpl <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Wpl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Wpl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">c</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">+</span> sum <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">c</span> <span class="main">*</span> <span class="free">a</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>leaves <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> sum <span class="free">a</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">+</span> sum <span class="free">b</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> wpl <span class="keyword2"><span class="keyword">where</span></span> w <span class="main">=</span> <span class="quoted">w</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"inorder <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span> <span class="main">⟹</span> wpl <span class="free">i</span> <span class="free">j</span> <span class="free">t</span> <span class="main">=</span> Wpl <span class="free">i</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Wpl_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">k</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">c</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">c</span> <span class="main">*</span> <span class="free">a</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> inorder <span class="main">=</span> inorder_upto_split<span class="main">[</span><span class="operator">OF</span> Node.prems<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Nl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nodes <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Nr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nodes <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?Nl</span> <span class="main">∪</span> <span class="var">?Nr</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ll</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"leaves <span class="skolem">i</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Lr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"leaves <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?Ll</span> <span class="main">∪</span> <span class="var">?Lr</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">`</span> <span class="var">?Nl</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>fst <span class="main">`</span> <span class="var">?Nr</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inorder<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst_nodes <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> set_inorder <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_inorder<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Nl</span> <span class="main">∩</span> <span class="var">?Nr</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="var">?Ll</span> <span class="main">∩</span> fst <span class="main">`</span> <span class="var">?Lr</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inorder
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst_leaves <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> set_inorder <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_inorder<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> l0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Ll</span> <span class="main">∩</span> <span class="var">?Lr</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpl <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">k</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span>  Wpl <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">+</span> Wpl <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">+</span> w <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node.IH inorder <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?b</span> <span class="main">(</span>nodes <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> sum <span class="var">?a</span> <span class="main">(</span>leaves <span class="skolem">i</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span>
    sum <span class="var">?b</span> <span class="main">(</span>nodes <span class="skolem">r</span><span class="main">)</span> <span class="main">+</span> sum <span class="var">?a</span> <span class="main">(</span>leaves <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">+</span> w <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Wpl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>sum <span class="var">?b</span> <span class="main">(</span>nodes <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> sum <span class="var">?b</span> <span class="main">(</span>nodes <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>
    <span class="main">+</span> <span class="main">(</span>sum <span class="var">?a</span> <span class="main">(</span>leaves <span class="skolem">i</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> sum <span class="var">?a</span> <span class="main">(</span>leaves <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> w <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?b</span> <span class="var">?N</span> <span class="main">+</span> sum <span class="var">?a</span> <span class="var">?L</span> <span class="main">+</span> w <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_Un_nat finite_nodes finite_leaves l0 n0<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?b</span> <span class="var">?N</span> <span class="main">+</span> sum <span class="var">?a</span> <span class="var">?L</span> <span class="main">+</span> sum <span class="free">a</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">+</span> sum <span class="free">b</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> w_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?b</span> <span class="var">?N</span> <span class="main">+</span> sum <span class="free">b</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span> <span class="main">+</span> <span class="main">(</span>sum <span class="var">?a</span> <span class="var">?L</span> <span class="main">+</span> sum <span class="free">a</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?a</span> <span class="var">?L</span> <span class="main">+</span> sum <span class="free">a</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?a</span> <span class="main">(</span>incr2 <span class="main">`</span> <span class="var">?L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inorder<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inorder<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_incr2 split_def sum.distrib sum_Un_nat finite_leaves l0
        sum_leaves<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inorder<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> sum_leaves<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inorder<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?b</span> <span class="var">?N</span> <span class="main">+</span> sum <span class="free">b</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>
     <span class="main">=</span> sum <span class="var">?b</span> <span class="var">?N</span> <span class="main">+</span> sum <span class="free">b</span> <span class="main">(</span><span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="free">b</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inorder<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?b</span> <span class="var">?N</span> <span class="main">+</span> sum <span class="free">b</span> <span class="main">(</span><span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> sum <span class="var">?b</span> <span class="main">(</span>incr2 <span class="main">`</span> <span class="var">?N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_incr2 split_def sum.distrib sum_Un_nat finite_nodes n0
        sum_nodes<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inorder<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> sum_nodes<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inorder<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?b</span> <span class="main">(</span>incr2 <span class="main">`</span> <span class="var">?N</span><span class="main">)</span> <span class="main">+</span> <span class="free">b</span> <span class="skolem">k</span> <span class="main">=</span> sum <span class="var">?b</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="skolem">k</span><span class="main">,</span><span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> incr2 <span class="main">`</span> <span class="var">?N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sum.insert<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_nodes notin_nodes0<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?b</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="skolem">k</span><span class="main">,</span><span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> incr2 <span class="main">`</span> <span class="var">?N</span><span class="main">)</span> <span class="main">+</span> sum <span class="var">?a</span> <span class="main">(</span>incr2 <span class="main">`</span> <span class="var">?L</span><span class="main">)</span> <span class="main">=</span> Wpl <span class="skolem">i</span> <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">k</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Wpl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Optimal_BST">
<div class="head">
<h1>Theory Optimal_BST</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow, based on work by Daniel Somogyi *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Optimal BSTs: The `Cubic' Algorithm\label{sec:cubic}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Optimal_BST
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Weighted_Path_Length">Weighted_Path_Length</a> <a href="../../monad_memo_dp/theories/#OptBST">Monad_Memo_DP.OptBST</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>argmin›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>argmin›</span></span></span></span> was moved to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Monad_Memo_DP.argmin›</span></span></span></span>.
It iterates over a list and returns the rightmost element that minimizes a given function:

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] argmin.simps<span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An optimized version that avoids repeated computation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f x›</span></span></span></span>:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">argmin2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">argmin2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">fx</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>
   <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">fx</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">mfm</span> <span class="main">=</span> <span class="free">argmin2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
           <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">fx</span> <span class="main">&lt;</span> snd <span class="bound">mfm</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">fx</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">mfm</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Optimal_BST-argmin2_argmin"><span class="command">lemma</span></span> argmin2_argmin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> argmin2 <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>argmin <span class="free">f</span> <span class="free">xs</span><span class="main">,</span> <span class="free">f</span><span class="main">(</span>argmin <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Optimal_BST-argmin_argmin2"><span class="command">lemma</span></span> argmin_argmin2<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"argmin <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> undefined <span class="keyword1">else</span> fst<span class="main">(</span>argmin2 <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> argmin2_argmin<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> argmin.elims list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1" id="Optimal_BST-argmin_in"><span class="command">lemma</span></span> argmin_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> argmin <span class="free">f</span> <span class="free">xs</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> argmin_forall<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Optimal_BST-argmin_pairs"><span class="command">lemma</span></span> argmin_pairs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
  <span class="main">(</span>argmin <span class="free">f</span> <span class="free">xs</span><span class="main">,</span><span class="free">f</span> <span class="main">(</span>argmin <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> argmin snd <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>argmin.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">smt</span> snd_conv<span class="main">)</span>

<span class="keyword1" id="Optimal_BST-argmin_map"><span class="command">lemma</span></span> argmin_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> argmin <span class="free">c</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span>argmin <span class="main">(</span><span class="free">c</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The `Cubic' Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We hide the details of the access frequencies <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>b›</span></span></span></span> by working with an abstract
version of function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>w›</span></span></span></span> definied above (summing <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>b›</span></span></span></span>). Later we interpret <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>w›</span></span></span></span> accordingly.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Optimal_BST <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>wpl›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>min_wpl›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> wpl <span class="keyword2"><span class="keyword">where</span></span> w <span class="main">=</span> <span class="quoted"><span class="free">w</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>min_wpl i j›</span></span></span></span> computes the minimal weighted path length of any tree <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span>
where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"inorder <span class="free"><span class="free">t</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">[</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">..</span></span><span class="free"><span class="free">j</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. It simply tries all possible indices between <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span>
as the root. Thus it implicitly constructs all possible trees.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> conj_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">min_wpl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">min_wpl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> <span class="main">0</span>
   <span class="keyword1">else</span> Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">min_wpl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">min_wpl</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> nat<span class="main">(</span><span class="bound">j</span><span class="main">-</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">declare</span></span> min_wpl.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that for efficiency reasons we have pulled <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>+ w i j›</span></span></span></span> out of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Min›</span></span></span></span>.
In the lemma below this is reversed because it simplifies the proofs.
Similar optimizations are possible in other functions below.›</span></span>

<span class="keyword1" id="Optimal_BST-min_wpl_simps"><span class="command">lemma</span></span> min_wpl_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="free">j</span> <span class="main">⟹</span> min_wpl <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> min_wpl <span class="free">i</span> <span class="free">j</span> <span class="main">=</span>
     Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> min_wpl <span class="free">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> min_wpl <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> <span class="free">w</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_wpl.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main"><span class="main">]</span></span> Min_add_commute<span class="main">)</span>

<span class="keyword1" id="Optimal_BST-upto_split1"><span class="command">lemma</span></span> upto_split1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span>  <span class="free">j</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">j</span><span class="main">..</span><span class="free">k</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> int_ge_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upto_rec1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> upto_rec1 upto_rec2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> min_wpl<span class="antiquote"><span class="antiquote">}</span></span></span></span> returns a lower bound for all possible BSTs:›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> min_wpl_is_optimal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inorder <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span> <span class="main">⟹</span> min_wpl <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> wpl <span class="free">i</span> <span class="free">j</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wpl.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upto.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">l</span> <span class="skolem">k</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span>

    <span class="keyword1"><span class="command">note</span></span> inorder <span class="main">=</span> inorder_upto_split<span class="main">[</span><span class="operator">OF</span> <span class="quoted">"2.prems"</span><span class="main">]</span>
        
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> min_wpl <span class="skolem">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> min_wpl <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"min_wpl <span class="skolem">i</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> min_wpl <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
 
    <span class="keyword1"><span class="command">have</span></span> aux_min<span class="main">:</span><span class="quoted"><span class="quoted">"Min <span class="var">?M</span> <span class="main">≤</span> <span class="var">?w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Min_le<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">∈</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inorder<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min_wpl <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> Min <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="var">?w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> aux_min<span class="main">)</span>    
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> wpl <span class="skolem">i</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">+</span> wpl <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">r</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inorder<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="quoted">"2.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> wpl <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">k</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we show that the lower bound computed by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> min_wpl<span class="antiquote"><span class="antiquote">}</span></span></span></span>
is the wpl of an optimal tree that can be computed in the same manner.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>opt_bst›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This is the functional equivalent of the standard cubic imperative algorithm.
Unless it is memoized, the complexity is again exponential.
The pattern of recursion is the same as for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> min_wpl<span class="antiquote"><span class="antiquote">}</span></span></span></span> but instead of the minimal weight
it computes a tree with the minimal weight:›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">opt_bst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">opt_bst</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> Leaf
   <span class="keyword1">else</span> argmin <span class="main">(</span>wpl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">⟨</span><span class="free">opt_bst</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> <span class="free">opt_bst</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">⟩</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">.</span> nat<span class="main">(</span><span class="bound">j</span><span class="main">-</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">declare</span></span> opt_bst.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">corollary</span></span> opt_bst_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="free">j</span> <span class="main">⟹</span> opt_bst <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Leaf"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> opt_bst <span class="free">i</span> <span class="free">j</span> <span class="main">=</span>
     <span class="main">(</span>argmin <span class="main">(</span>wpl <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">[</span><span class="main">⟨</span>opt_bst <span class="free">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> opt_bst <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">j</span><span class="main">⟩</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_bst.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As promised, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> opt_bst<span class="antiquote"><span class="antiquote">}</span></span></span></span> computes a tree with the minimal wpl:›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> wpl_opt_bst<span class="main">:</span> <span class="quoted"><span class="quoted">"wpl <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>opt_bst <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> min_wpl <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> min_wpl.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">⟨</span>opt_bst <span class="skolem">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> opt_bst <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">⟩</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">]</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> min_wpl <span class="skolem">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> min_wpl <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upto.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpl <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">(</span>opt_bst <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> wpl <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">(</span>argmin <span class="main">(</span>wpl <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="var">?ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Min <span class="main">(</span>wpl <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">`</span> <span class="main">(</span>set <span class="var">?ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> argmin_Min<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Min <span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Min</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wpl <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">`</span> <span class="main">(</span>set <span class="var">?ts</span><span class="main">)</span> <span class="main">=</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Bex_def image_iff <span class="quoted">"1.IH"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> min_wpl <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> opt_bst_is_optimal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inorder <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span> <span class="main">⟹</span> wpl <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>opt_bst <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> wpl <span class="free">i</span> <span class="free">j</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_wpl_is_optimal wpl_opt_bst<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>opt_bst_wpl›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> opt_bst<span class="antiquote"><span class="antiquote">}</span></span></span></span> is simplistic because it computes the wpl
of each tree anew rather than returning it with the tree. That is what <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>opt_bst_wpl›</span></span></span></span> does:›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">opt_bst_wpl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int tree <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">opt_bst_wpl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="main">0</span><span class="main">)</span>
   <span class="keyword1">else</span> argmin snd <span class="main">[</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">t1</span><span class="main">,</span><span class="bound">c1</span><span class="main">)</span> <span class="main">=</span> <span class="free">opt_bst_wpl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">;</span>
                        <span class="main">(</span><span class="bound">t2</span><span class="main">,</span><span class="bound">c2</span><span class="main">)</span> <span class="main">=</span> <span class="free">opt_bst_wpl</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>
                     <span class="keyword1">in</span> <span class="main">(</span><span class="main">⟨</span><span class="bound">t1</span><span class="main">,</span><span class="bound">k</span><span class="main">,</span><span class="bound">t2</span><span class="main">⟩</span><span class="main">,</span> <span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span> <span class="main">+</span> <span class="free">w</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> nat<span class="main">(</span><span class="bound">j</span><span class="main">-</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> opt_bst_wpl.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> opt_bst_wpl<span class="antiquote"><span class="antiquote">}</span></span></span></span> returns an optimal tree and its wpl:›</span></span>

<span class="keyword1" id="Optimal_BST-opt_bst_wpl_eq_pair"><span class="command">lemma</span></span> opt_bst_wpl_eq_pair<span class="main">:</span>
  <span class="quoted"><span class="quoted">"opt_bst_wpl <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span>opt_bst <span class="free">i</span> <span class="free">j</span><span class="main">,</span> wpl <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>opt_bst <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> opt_bst_wpl.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> opt_bst_wpl.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> argmin_pairs comp_def <span class="quoted">"1.IH"</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> list.map_cong_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> opt_bst_wpl_eq_pair'<span class="main">:</span> <span class="quoted"><span class="quoted">"opt_bst_wpl <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span>opt_bst <span class="free">i</span> <span class="free">j</span><span class="main">,</span> min_wpl <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_bst_wpl_eq_pair wpl_opt_bst<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* locale Optimal_BST *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Quadrilateral_Inequality">
<div class="head">
<h1>Theory Quadrilateral_Inequality</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Quadrangle Inequality›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Quadrilateral_Inequality
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* did not use @{const is_arg_min} because no benefit *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_arg_min_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_arg_min_on</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Args_min_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> int set <span class="main">⇒</span> int set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Args_min_on</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> is_arg_min_on <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">k</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Args_min_simps <span class="main">=</span> Args_min_on_def is_arg_min_on_def

<span class="keyword1" id="Quadrilateral_Inequality-is_arg_min_on_antimono"><span class="command">lemma</span></span> is_arg_min_on_antimono<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">::</span>order"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> is_arg_min_on <span class="free">f</span> <span class="free">S</span> <span class="free">x</span><span class="main">;</span> <span class="free">f</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">x</span><span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span> is_arg_min_on <span class="free">f</span> <span class="free">S</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym is_arg_min_on_def<span class="main">)</span>

<span class="keyword1" id="Quadrilateral_Inequality-ex_is_arg_min_on_if_finite"><span class="command">lemma</span></span> ex_is_arg_min_on_if_finite<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">S</span><span class="main">;</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> is_arg_min_on <span class="free">f</span> <span class="free">S</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_arg_min_on_def <span class="keyword1"><span class="command">using</span></span> ex_min_if_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">S</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>


<span class="keyword1"><span class="command">locale</span></span> QI <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c_k</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> QI_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">≤</span> <span class="free">i'</span><span class="main">;</span> <span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">w</span> <span class="free">i</span> <span class="free">j</span> <span class="main">+</span> <span class="free">w</span> <span class="free">i'</span> <span class="free">j'</span><span class="main">≤</span> <span class="free">w</span> <span class="free">i'</span> <span class="free">j</span> <span class="main">+</span> <span class="free">w</span> <span class="free">i</span> <span class="free">j'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> monotone_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">≤</span> <span class="free">i'</span><span class="main">;</span> <span class="free">i'</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">w</span> <span class="free">i'</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">w</span> <span class="free">i</span> <span class="free">j'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> c_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">c</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Min <span class="main">(</span><span class="main">(</span><span class="free">c_k</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> c_k_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">;</span>  <span class="free">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">c_k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="main">=</span> <span class="free">w</span> <span class="free">i</span> <span class="free">j</span> <span class="main">+</span> <span class="free">c</span> <span class="free">i</span> <span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="free">k</span> <span class="free">j</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mins</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> Args_min_on <span class="main">(</span><span class="free">c_k</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> Max <span class="main">(</span>mins <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Quadrilateral_Inequality-c_def_rec"><span class="command">lemma</span></span> c_def_rec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">c</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">c</span> <span class="free">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="bound">k</span> <span class="free">j</span> <span class="main">+</span> <span class="free">w</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> c_def c_k_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> image_def<span class="main">)</span>

<span class="keyword1" id="Quadrilateral_Inequality-mins_subset"><span class="command">lemma</span></span> mins_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"mins <span class="free">i</span> <span class="free">j</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Args_min_simps<span class="main">)</span>

<span class="keyword1" id="Quadrilateral_Inequality-mins_nonempty"><span class="command">lemma</span></span> mins_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> mins <span class="free">i</span> <span class="free">j</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> ex_is_arg_min_on_if_finite<span class="main">[</span><span class="operator">OF</span> finite_atLeastAtMost_int<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_k</span> <span class="free">i</span> <span class="free">j</span>"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Args_min_simps<span class="main">)</span>

<span class="keyword1" id="Quadrilateral_Inequality-finite_mins"><span class="command">lemma</span></span> finite_mins<span class="main">:</span> <span class="quoted"><span class="quoted">"finite<span class="main">(</span>mins <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mins_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Quadrilateral_Inequality-is_arg_min_on_Min"><span class="command">lemma</span></span> is_arg_min_on_Min<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"is_arg_min_on <span class="free">f</span> <span class="free">A</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_arg_min_on_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> antisym is_arg_min_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Quadrilateral_Inequality-c_k_with_K"><span class="command">lemma</span></span> c_k_with_K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">c</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="free">c_k</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>K <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Max_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mins <span class="free">i</span> <span class="free">j</span>"</span></span><span class="main">]</span> finite_mins<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> mins_nonempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span>
  is_arg_min_on_Min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_k</span> <span class="free">i</span> <span class="free">j</span>"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Args_min_simps c_def K_def<span class="main">)</span>

<span class="keyword1" id="Quadrilateral_Inequality-K_subset"><span class="command">lemma</span></span> K_subset<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"K <span class="free">i</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mins_subset K_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> K_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"K <span class="free">i</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mins_subset K_def <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_in finite_mins less_le mins_nonempty subsetCE<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Quadrilateral_Inequality-lemma_2"><span class="command">lemma</span></span> lemma_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">l</span> <span class="main">=</span> nat <span class="main">(</span><span class="free">j'</span><span class="main">-</span> <span class="free">i</span><span class="main">)</span><span class="main">;</span>  <span class="free">i</span> <span class="main">≤</span> <span class="free">i'</span><span class="main">;</span>  <span class="free">i'</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span>  <span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span> <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">c</span> <span class="free">i</span> <span class="free">j</span> <span class="main">+</span> <span class="free">c</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">≤</span> <span class="free">c</span> <span class="free">i</span> <span class="free">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="free">i'</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">i'</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">j'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">∨</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">i'</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">i'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">j'</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">j'</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="comment1">(*-----------------------case 1: i' = j --------------------------------------------------*)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span> 
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"K <span class="skolem">i</span> <span class="skolem">j'</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> K_def
            <span class="keyword1"><span class="command">using</span></span> mins_subset Max_in<span class="main">[</span><span class="operator">OF</span> finite_mins mins_nonempty<span class="main">]</span> less.prems <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">i</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> subsetCE<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="comment1">(*---------------------case 1.1: i' = j ∧ k ≤ j ----------------------------------------*)</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>

            <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?k</span> <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="bound">k</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> c_def_rec <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?k</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="var">?k</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?k</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="skolem">j'</span> <span class="main">≤</span> <span class="free">c</span> <span class="var">?k</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> less.prems
                less.IH <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">=</span> <span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">j</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">≤</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?k</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="skolem">j'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j'</span><span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?k</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="skolem">j'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> less.prems monotone_w <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j'</span><span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?k</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_k_def c_k_with_K<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">j</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="comment1">(*---------------------case 1.2: i' = j ∧ k ≥ j ----------------------------------------*)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?k</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">j</span> <span class="skolem">j'</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">j</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?k</span> <span class="skolem">j'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">j</span> <span class="skolem">j'</span> <span class="main">=</span> Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">c</span> <span class="skolem">j</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="bound">k</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">j</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> c_def_rec <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">j'</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">c</span> <span class="skolem">j</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?k</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">j</span> <span class="skolem">j'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">j</span> <span class="skolem">j'</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">j</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?k</span> <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span><span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> less.prems <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?k</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span>
                less.IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">=</span> <span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">j</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">j</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?k</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j'</span><span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?k</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> less.prems monotone_w <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j'</span><span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?k</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">j</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_k_def c_k_with_K<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">j</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="comment1">(*---------------------case 2 i' ≠ j ---------------------------------------------------*)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"K <span class="skolem">i'</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"K <span class="skolem">i</span> <span class="skolem">j'</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mins_subset less.prems <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">j</span>›</span></span> Max_in<span class="main">[</span><span class="operator">OF</span> finite_mins mins_nonempty<span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> K_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_less subsetCE<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mins_subset less.prems <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">j</span>›</span></span> Max_in<span class="main">[</span><span class="operator">OF</span> finite_mins mins_nonempty<span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> K_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> subsetCE<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> w_mon<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i'</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> less.prems QI_w <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">j'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">j</span>›</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="comment1">(*---------------------case 2.1 i' ≠ j ∧ z ≤ y ----------------------------------------*)</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">≤</span> <span class="var">?y</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less.prems <span class="quoted"><span class="quoted">‹<span class="var">?y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?z</span> <span class="main">≤</span> <span class="var">?y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

            <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="main">(</span><span class="var">?y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?y</span> <span class="skolem">j'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">=</span> Min<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="bound">k</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i'</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_def_rec<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">j'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="main">(</span><span class="var">?y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?y</span> <span class="skolem">j'</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">qed</span></span>

            <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?z</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?z</span> <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="bound">k</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>  <span class="main">`</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_def_rec<span class="main">)</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?z</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?z</span> <span class="skolem">j</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">qed</span></span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="var">?z</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>›</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">hence</span></span> IH_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?z</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?y</span> <span class="skolem">j'</span> <span class="main">≤</span> <span class="free">c</span> <span class="var">?z</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?y</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?z</span> <span class="main">≤</span> <span class="var">?y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">j'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>›</span></span>
               less.IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?z</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i' <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span>
              <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i'</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="main">(</span><span class="var">?y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?z</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?y</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?z</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> a b w_mon <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i'</span> <span class="skolem">j</span> <span class="main">+</span>  <span class="free">c</span> <span class="skolem">i'</span> <span class="main">(</span><span class="var">?y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?z</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?y</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?z</span> <span class="skolem">j'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> IH_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_k_def c_k_with_K<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="comment1">(*---------------------case 2.1 i' ≠ j ∧ z &gt; y ---------------------------------------*)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?z</span> <span class="main">≤</span> <span class="var">?y</span>"</span></span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less.prems <span class="quoted"><span class="quoted">‹<span class="var">?y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="var">?z</span> <span class="main">≤</span> <span class="var">?y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

            <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="main">(</span><span class="var">?z</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?z</span> <span class="skolem">j'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">=</span>  Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="bound">k</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i'</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_def_rec<span class="main">)</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="main">(</span><span class="var">?z</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?z</span> <span class="skolem">j'</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">qed</span></span>

            <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?y</span> <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="bound">k</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>  <span class="main">`</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_def_rec<span class="main">)</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?y</span> <span class="skolem">j</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
            
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="var">?z</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">hence</span></span> IH_Step<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="main">(</span><span class="var">?z</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="main">(</span><span class="var">?y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?z</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="var">?z</span> <span class="main">≤</span> <span class="var">?y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">i'</span>›</span></span>
                less.IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?y</span><span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?z</span><span class="main">-</span><span class="main">1</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j</span>
              <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i'</span> <span class="skolem">j</span> <span class="main">+</span>  <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="main">(</span><span class="var">?z</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?z</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?y</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> a b w_mon <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">w</span> <span class="skolem">i'</span> <span class="skolem">j</span> <span class="main">+</span>  <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i</span> <span class="main">(</span><span class="var">?z</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="main">(</span><span class="var">?y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?z</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="var">?y</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> IH_Step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">c</span> <span class="skolem">i</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="free">c</span> <span class="skolem">i'</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_k_def c_k_with_K<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> QI'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">" <span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">≤</span> <span class="free">j</span> "</span></span>  <span class="quoted"><span class="quoted">"<span class="free">c_k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">c_k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="free">k</span> <span class="free">j</span> <span class="main">+</span> <span class="free">c</span> <span class="free">k'</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="free">k'</span> <span class="free">j</span> <span class="main">+</span> <span class="free">c</span> <span class="free">k</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lemma_2<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> assms<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="main">+</span> <span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">c_k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k'</span> <span class="main">+</span> <span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> c_k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> QI''<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">≤</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_k</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">c_k</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="free">i</span> <span class="free">k</span> <span class="main">+</span> <span class="free">c</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">c</span> <span class="free">i</span> <span class="free">k'</span> <span class="main">+</span> <span class="free">c</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lemma_2<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">k'</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k</span> <span class="main">+</span> <span class="free">c_k</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k'</span> <span class="main">+</span> <span class="free">c_k</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_k_def assms<span class="main">(</span>1-3<span class="main">)</span> lemma_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_k</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">c_k</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Quadrilateral_Inequality-lemma_3_1"><span class="command">lemma</span></span> lemma_3_1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"K <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> K <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> K_def K_subset atLeastAtMost_iff less_add_one less_le<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≠</span><span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"K <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"K <span class="free">i</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> K_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_in <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> mins_nonempty<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span><span class="main"><span class="main">]</span></span> finite_mins less_le mins_subset subsetCE<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"K <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_in K_def mins_nonempty<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>›</span></span><span class="main"><span class="main">]</span></span> finite_mins less_le mins_subset subsetCE<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"is_arg_min_on <span class="main">(</span><span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="var">?k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"K <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> mins <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_mins mins_nonempty <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> K_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_arg_min_on <span class="main">(</span><span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">(</span>K <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Args_min_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">=</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹K <span class="free">i</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">≠</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹K <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≠</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≠</span><span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> K_simps<span class="main">:</span> <span class="quoted"><span class="quoted">"K <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Max <span class="main">(</span>mins <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"K <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span>mins <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> K_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> K_simps
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Max.boundedI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_mins mins_nonempty<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k'</span> <span class="keyword3"><span class="command">assume</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∈</span> mins <span class="free">i</span> <span class="free">j</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≤</span> Max <span class="main">(</span>mins <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> 
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">k'</span> <span class="main">≤</span> Max <span class="main">(</span>mins <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">≤</span> <span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> K_simps
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> QI'<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> Max <span class="main">(</span>mins <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹K <span class="free">i</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span>›</span></span> K_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>mins <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="skolem">k'</span> <span class="main">≤</span> Max <span class="main">(</span>mins <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mins_subset atLeastAtMost_iff k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_k</span> <span class="free">i</span> <span class="free">j</span> <span class="skolem">k'</span> <span class="main">≤</span> <span class="free">c_k</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>Max <span class="main">(</span>mins <span class="free">i</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span> 
            <span class="keyword1"><span class="command">using</span></span> k' <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> K_simps Args_min_simps<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_arg_min_on <span class="main">(</span><span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="skolem">k'</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> is_arg_min_on_antimono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> mins_subset k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∈</span> mins <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Args_min_on_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> finite_mins <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">k'</span> <span class="main">≤</span> Max <span class="main">(</span>mins <span class="free">i</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Quadrilateral_Inequality-lemma_3_2"><span class="command">lemma</span></span> lemma_3_2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"K <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> K <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> K_def K_subset atLeastAtMost_iff less_add_one less_le<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"K <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"K <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> K_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_in <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> finite_mins less_irrefl mins_nonempty mins_subset subsetCE zless_add1_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"K <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mins_nonempty<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>›</span></span><span class="main">]</span> mins_subset Max_in K_def finite_mins
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastatMost_empty atLeastatMost_empty_iff2 contra_subsetD empty_subsetI less_add_one psubsetI<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"is_arg_min_on <span class="main">(</span><span class="free">c_k</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="var">?k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"K <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> mins <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_mins mins_nonempty <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> K_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_in not_less_iff_gr_or_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_arg_min_on <span class="main">(</span><span class="free">c_k</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">(</span>K <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Args_min_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">=</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹K <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">≠</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹K <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≠</span><span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≠</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> K_simps<span class="main">:</span> <span class="quoted"><span class="quoted">"K <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span>mins <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                      <span class="quoted"><span class="quoted">"K <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span>mins <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> K_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> K_simps
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Max.boundedI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_mins mins_nonempty<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k'</span> <span class="keyword3"><span class="command">assume</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∈</span> mins <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≤</span> Max <span class="main">(</span>mins <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">k'</span> <span class="main">≤</span> Max <span class="main">(</span>mins <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_k</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">≤</span> <span class="free">c_k</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> K_simps
          <span class="keyword1"><span class="command">thm</span></span> QI'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"Max<span class="main">(</span>mins <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">k'</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> QI''<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span>  <span class="main">&lt;</span> Max <span class="main">(</span>mins <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹K <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>›</span></span> K_simps 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>mins <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">k'</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="skolem">k'</span> <span class="main">≤</span> Max <span class="main">(</span>mins <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> K_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≤</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mins_subset k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">≤</span> <span class="free">c_k</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Max <span class="main">(</span>mins <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> k' <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span>›</span></span> K_simps
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Args_min_simps<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_arg_min_on <span class="main">(</span><span class="free">c_k</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="skolem">k'</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> is_arg_min_on_antimono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> mins_subset k' K_simps <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>›</span></span>
            <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">k'</span> <span class="main">≤</span> Max <span class="main">(</span>mins <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> atLeastAtMost_iff
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∈</span> mins <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k' Args_min_on_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> finite_mins <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">k'</span> <span class="main">≤</span> Max <span class="main">(</span>mins <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> Max_ge
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Quadrilateral_Inequality-lemma_3"><span class="command">lemma</span></span> lemma_3<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"K <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> K <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"K <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> K <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms lemma_3_1 lemma_3_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* locale QI *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Optimal_BST2">
<div class="head">
<h1>Theory Optimal_BST2</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow, based on work by Daniel Somogyi *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Optimal BSTs: The `Quadratic' Algorithm\label{sec:quadratic}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Optimal_BST2
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Optimal_BST">Optimal_BST</a>
  <a href="#Quadrilateral_Inequality">Quadrilateral_Inequality</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Knuth presented an optimization of the previously known cubic dynamic programming algorithm
to a quadratic one. A simplified proof of this optimization was found by Yao~\cite{Yao80}.
Mehlhorn follows Yao closely. The core of the optimization argument is given abstractly
in theory <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Quadrilateral_Inequality.html"></a><a href="Quadrilateral_Inequality.html">Optimal_BST.Quadrilateral_Inequality</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In addition we first need to establish some more
properties of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> argmin<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹An index-based specification of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> argmin<span class="antiquote"><span class="antiquote">}</span></span></span></span>
expressing that the last minimal list-element is picked:›</span></span>

<span class="keyword1" id="Optimal_BST2-argmin_takes_last"><span class="command">lemma</span></span> argmin_takes_last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
  argmin <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> Max <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">!</span> Max <span class="main">(</span><span class="var">?M</span> <span class="free">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> less_Suc_eq_0_disj<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>argmin <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 1 argmin_Min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> 1 Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> 2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>argmin <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 argmin_Min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"argmin <span class="free">f</span> <span class="skolem">xs</span> <span class="main">:</span> <span class="main">{</span><span class="bound"><span class="bound">u</span></span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 0 argmin_Min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> argmin_in<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">u</span></span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="skolem">xs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="var">?M</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span><span class="var">?M</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(+)</span> <span class="main">1</span> <span class="main">`</span> <span class="var">?M</span> <span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' image_def less_Suc_eq_0_disj<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> mono_Max_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(+)</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="skolem">xs</span>"</span></span><span class="main">]</span> ne <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">0</span> <span class="main">(</span><span class="main">(+)</span> <span class="main">1</span> <span class="main">`</span> <span class="var">?M</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' image_def less_Suc_eq_0_disj<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="var">?M</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span><span class="main">(+)</span> <span class="main">1</span> <span class="main">`</span> <span class="var">?M</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Max_insert ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mono_Max_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(+)</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="skolem">xs</span>"</span></span><span class="main">]</span> ne <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> Cons 2 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Optimal_BST2-Min_ex"><span class="command">lemma</span></span> Min_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">F</span><span class="main">;</span> <span class="free">F</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">m</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> <span class="main">(</span><span class="bound">n</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>linorder<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> eq_Min_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="quoted">"Min <span class="free">F</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A consequence of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] argmin_takes_last<span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>

<span class="keyword1" id="Optimal_BST2-argmin_Max_Args_min_on"><span class="command">lemma</span></span> argmin_Max_Args_min_on<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"argmin <span class="free">f</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> Max <span class="main">(</span>Args_min_on <span class="free">f</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?min</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nat<span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?min</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Max</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="var">?M</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Min_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_upto<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="improper">m</span><span class="main">-</span><span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Max</span> <span class="main">&lt;</span> nat<span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_upto<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> int <span class="var">?Max</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"argmin <span class="free">f</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span> <span class="main">!</span> <span class="var">?Max</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> argmin_takes_last<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> int <span class="var">?Max</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_upto<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> Max<span class="main">(</span>int <span class="main">`</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nat<span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?min</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?M</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoI mono_Max_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">i</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>int <span class="main">`</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nat<span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?min</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?M</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoI mono_Max_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">i</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>int <span class="main">`</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nat<span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?min</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">{</span><span class="bound">k</span><span class="main">.</span> is_arg_min_on <span class="free">f</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">}</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_arg_min_on_def Ball_def nth_upto image_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">x</span><span class="main">-</span><span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"nat<span class="main">(</span><span class="improper">x</span><span class="main">-</span><span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Args_min_simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As a consequence of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] argmin_Max_Args_min_on<span class="antiquote"><span class="antiquote">}</span></span></span></span> the following lemma
allows us to justify the restriction of the index range of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> argmin<span class="antiquote"><span class="antiquote">}</span></span></span></span>
used below in the optimized (quadratic) algorithm.›</span></span>

<span class="keyword1" id="Optimal_BST2-argmin_red_ivl"><span class="command">lemma</span></span> argmin_red_ivl<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">i'</span>"</span></span> <span class="quoted"><span class="quoted">"argmin <span class="free">f</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i'</span><span class="main">..</span><span class="free">j'</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"argmin <span class="free">f</span> <span class="main">[</span><span class="free">i'</span><span class="main">..</span><span class="free">j'</span><span class="main">]</span> <span class="main">=</span> argmin <span class="free">f</span> <span class="main">[</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ij<span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ij'<span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Min_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> argmin_Max_Args_min_on<span class="main">[</span><span class="operator">OF</span> ij<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> ** <span class="main">=</span> argmin_Max_Args_min_on<span class="main">[</span><span class="operator">OF</span> ij'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Args_min_on <span class="free">f</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Args_min_on <span class="free">f</span> <span class="main">{</span><span class="free">i'</span><span class="main">..</span><span class="free">j'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Args_min_simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> atLeastAtMost_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?M</span> <span class="main">∈</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?M</span> <span class="main">∈</span> <span class="var">?M'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Max_in<span class="main">[</span><span class="operator">OF</span> M<span class="main">]</span> assms * <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Args_min_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M'</span> <span class="main">⊆</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Max <span class="var">?M</span> <span class="main">∈</span> <span class="var">?M</span>›</span></span> <span class="quoted"><span class="quoted">‹Max <span class="var">?M</span> <span class="main">∈</span> <span class="var">?M'</span>›</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Args_min_simps Ball_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?M'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> M<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="var">?M'</span> <span class="main">⊆</span> <span class="var">?M</span>›</span></span> infinite_super <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?M</span> <span class="main">≤</span> Max <span class="var">?M'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹Max <span class="var">?M</span> <span class="main">∈</span> <span class="var">?M'</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?M'</span> <span class="main">≤</span> Max <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Max.subset_imp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?M'</span> <span class="main">⊆</span> <span class="var">?M</span>›</span></span> _ M<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹Max <span class="var">?M</span> <span class="main">∈</span> <span class="var">?M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * ** <span class="quoted"><span class="quoted">‹Max <span class="var">?M</span> <span class="main">≤</span> Max <span class="var">?M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">root</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">root</span> <span class="main">⟨</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">⟩</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can formulate and verify the improved algorithm. This requires two
assumptions on the weight function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>w›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Optimal_BST2 <span class="main">=</span> Optimal_BST <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> monotone_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">≤</span> <span class="free">i'</span><span class="main">;</span> <span class="free">i'</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">w</span> <span class="free">i'</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">w</span> <span class="free">i</span> <span class="free">j'</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> QI_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">≤</span> <span class="free">i'</span><span class="main">;</span> <span class="free">i'</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span><span class="main">⟧</span><span class="main">⟹</span> <span class="free">w</span> <span class="free">i</span> <span class="free">j</span> <span class="main">+</span> <span class="free">w</span> <span class="free">i'</span> <span class="free">j'</span><span class="main">≤</span> <span class="free">w</span> <span class="free">i'</span> <span class="free">j</span> <span class="main">+</span> <span class="free">w</span> <span class="free">i</span> <span class="free">j'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹When finding an optimal tree for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">..</span></span><span class="free"><span class="free">j</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> the optimization consists in reducing
the search for the root from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">..</span></span><span class="free"><span class="free">j</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span>root <span class="main"><span class="main">(</span></span><span class="free"><span class="free">opt_bst2</span></span> <span class="free"><span class="free">i</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">j</span></span><span class="main"><span class="main">-</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">..</span></span> root <span class="main"><span class="main">(</span></span><span class="free"><span class="free">opt_bst2</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">+</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">j</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">opt_bst2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">opt_bst2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> Leaf <span class="keyword1">else</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> Node Leaf <span class="free"><span class="bound"><span class="entity">i</span></span></span> Leaf <span class="keyword1">else</span>
   <span class="keyword1">let</span> <span class="bound">left</span> <span class="main">=</span> root <span class="main">(</span><span class="free">opt_bst2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
   <span class="keyword1">let</span> <span class="bound">right</span><span class="main">=</span> root <span class="main">(</span><span class="free">opt_bst2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
     argmin <span class="main">(</span>wpl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">⟨</span><span class="free">opt_bst2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> <span class="free">opt_bst2</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">⟩</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="bound">left</span><span class="main">..</span><span class="bound">right</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The termination of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> opt_bst2<span class="antiquote"><span class="antiquote">}</span></span></span></span> is not completely obvious.
We first need to establish some functional properties of the terminating computations.
We start by showing that the root of the returned tree is always between <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>left›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>right›</span></span></span></span>.
This is essentially equivalent to proving that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>left ≤ right›</span></span></span></span>
because otherwise <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> argmin<span class="antiquote"><span class="antiquote">}</span></span></span></span> is applied to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[]›</span></span></span></span>, which is undefined.›</span></span>

<span class="keyword1" id="Optimal_BST2-left_le_right"><span class="command">lemma</span></span> left_le_right<span class="main">:</span>
 <span class="quoted"><span class="quoted">"opt_bst2_dom<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">i</span><span class="main">=</span><span class="free">j</span> <span class="main">⟶</span> root<span class="main">(</span>opt_bst2 <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="free">i</span><span class="main">&lt;</span><span class="free">j</span> <span class="main">⟶</span> root<span class="main">(</span>opt_bst2 <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>root<span class="main">(</span>opt_bst2 <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">..</span> root<span class="main">(</span>opt_bst2 <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> opt_bst2.pinduct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?left</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>opt_bst2 <span class="skolem">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?right</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>opt_bst2 <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">⟨</span>opt_bst2 <span class="skolem">i</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> opt_bst2 <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> opt_bst2.psimps<span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.hyps"</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> left_le_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?left</span> <span class="main">≤</span> <span class="var">?right</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span><span class="main">-</span><span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>opt_bst2 <span class="skolem">i</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>opt_bst2 <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> l r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span><span class="main">-</span><span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span><span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span><span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?left</span> <span class="main">≤</span> root <span class="main">(</span>opt_bst2 <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> root <span class="main">(</span>opt_bst2 <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?left</span> <span class="main">≤</span> <span class="var">?right</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lambda</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> root <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?left</span> <span class="main">..</span> <span class="var">?right</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> argmin_forall<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹map <span class="var">?f</span> <span class="main">[</span><span class="var">?left</span><span class="main">..</span><span class="var">?right</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lambda</span>›</span></span> <span class="quoted"><span class="quoted">‹wpl <span class="skolem">i</span> <span class="skolem">j</span>›</span></span><span class="main">]</span> left_le_right
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_bst2.psimps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted">"1.hyps"</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can bound the result of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> opt_bst2<span class="antiquote"><span class="antiquote">}</span></span></span></span> easily:›</span></span>

<span class="keyword1" id="Optimal_BST2-root_opt_bst2_bound"><span class="command">lemma</span></span> root_opt_bst2_bound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"opt_bst2_dom <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> root <span class="main">(</span>opt_bst2 <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>opt_bst2.pinduct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted">"1.prems"</span> <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> left_le_right<span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.hyps"</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>                                                                           

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now termination follows easily:›</span></span>

<span class="keyword1" id="Optimal_BST2-opt_bst2_dom"><span class="command">lemma</span></span> opt_bst2_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">args</span><span class="main">.</span> opt_bst2_dom <span class="bound">args</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> nat <span class="main">(</span><span class="bound">j</span><span class="main">-</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> root_opt_bst2_bound<span class="main">)</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> opt_bst2_dom<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> opt_bst2.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">min_wpl3</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> min_wpl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> min_wpl <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">+</span> <span class="free">w</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The correctness proof \cite{Yao} is based on a general theory of `quatrilateral inequalities'
developed in locale QI that we now instantiate:›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> QI
  <span class="keyword2"><span class="keyword">where</span></span>
    c <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> min_wpl <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c_k <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> min_wpl3 <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> w <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">w</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">i'</span> <span class="skolem">j</span> <span class="skolem">j'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> QI_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span> <span class="skolem">i'</span> <span class="skolem">j</span> <span class="skolem">j'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> monotone_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Optimal_BST2-K_argmin"><span class="command">lemma</span></span> K_argmin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> K <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> argmin <span class="main">(</span>min_wpl3 <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> K_def argmin_Max_Args_min_on Args_min_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> opt_bst2_opt_bst<span class="main">:</span> <span class="quoted"><span class="quoted">"opt_bst2 <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> opt_bst <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> opt_bst2.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">j</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="skolem">j</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> opt_bst2.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> min_wpl <span class="skolem">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> min_wpl <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?opt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">⟨</span>opt_bst <span class="skolem">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> opt_bst <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> K <span class="main">(</span><span class="skolem">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> argmin_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> K_argmin<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"argmin <span class="var">?c</span> <span class="main">[</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">]</span> <span class="main">∈</span> <span class="main">{</span>K <span class="main">(</span><span class="skolem">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..</span>K <span class="skolem">i</span> <span class="skolem">j</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lemma_3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">-</span></span><span class="main"><span class="main">1</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">j</span></span><span class="main"><span class="main">-</span></span><span class="main"><span class="main">1</span></span>"</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> K_argmin<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"K <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> argmin_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> K_argmin<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"argmin <span class="var">?c</span> <span class="main">[</span>K <span class="main">(</span><span class="skolem">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..</span>K <span class="skolem">i</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">=</span> argmin <span class="var">?c</span> <span class="main">[</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> argmin_red_ivl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1 2 3<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"opt_bst2 <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span>
     argmin <span class="main">(</span>wpl <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?opt</span> <span class="main">[</span>root<span class="main">(</span>opt_bst2 <span class="skolem">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">..</span>root<span class="main">(</span>opt_bst2 <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simp_depth_limit</span><span class="main"><span class="main">=</span></span>3<span class="main">]</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1.IH"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ refl refl<span class="main"><span class="main">]</span></span> opt_bst2.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> list.map_cong_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> argmin <span class="main">(</span>wpl <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?opt</span> <span class="main">[</span>root<span class="main">(</span>opt_bst <span class="skolem">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">..</span>root<span class="main">(</span>opt_bst <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1.IH"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root<span class="main">(</span>opt_bst <span class="skolem">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> K <span class="main">(</span><span class="skolem">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> argmin_map wpl_opt_bst comp_def K_argmin<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root<span class="main">(</span>opt_bst <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> K <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> argmin_map wpl_opt_bst comp_def K_argmin<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"argmin <span class="main">(</span>wpl <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?opt</span> <span class="main">[</span>K <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">..</span>K <span class="skolem">i</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>
       <span class="main">=</span> <span class="var">?opt</span> <span class="main">(</span>argmin <span class="main">(</span>wpl <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword1">o</span> <span class="var">?opt</span><span class="main">)</span> <span class="main">[</span>K <span class="main">(</span><span class="skolem">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..</span>K <span class="skolem">i</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lemma_3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">-</span></span><span class="main"><span class="main">1</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">j</span></span><span class="main"><span class="main">-</span></span><span class="main"><span class="main">1</span></span>"</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> argmin_map<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?opt</span> <span class="main">(</span>argmin <span class="var">?c</span> <span class="main">[</span>K <span class="main">(</span><span class="skolem">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..</span>K <span class="skolem">i</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def wpl_opt_bst<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?opt</span><span class="main">(</span>argmin <span class="var">?c</span> <span class="main">[</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"*"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?opt</span><span class="main">(</span>argmin <span class="main">(</span>wpl <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword1">o</span> <span class="var">?opt</span><span class="main">)</span> <span class="main">[</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def wpl_opt_bst<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> argmin <span class="main">(</span>wpl <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?opt</span> <span class="main">[</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> argmin_map<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> opt_bst <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> opt_bst2_is_optimal<span class="main">:</span> <span class="quoted"><span class="quoted">"wpl <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>opt_bst2 <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> min_wpl <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_bst2_opt_bst wpl_opt_bst<span class="main">)</span>


<span class="keyword1"><span class="command">function</span></span> <span class="entity">opt_bst_wpl2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int tree <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">opt_bst_wpl2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>Leaf<span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">i</span></span></span> Leaf<span class="main">,</span> <span class="free">w</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
   <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> root<span class="main">(</span>fst<span class="main">(</span><span class="free">opt_bst_wpl2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">r</span> <span class="main">=</span> root<span class="main">(</span>fst<span class="main">(</span><span class="free">opt_bst_wpl2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
     argmin snd
       <span class="main">[</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">tl</span><span class="main">,</span><span class="bound">wl</span><span class="main">)</span> <span class="main">=</span> <span class="free">opt_bst_wpl2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">tr</span><span class="main">,</span><span class="bound">wr</span><span class="main">)</span> <span class="main">=</span> <span class="free">opt_bst_wpl2</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>
        <span class="keyword1">in</span> <span class="main">(</span><span class="main">⟨</span><span class="bound">tl</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">tr</span><span class="main">⟩</span><span class="main">,</span> <span class="bound">wl</span> <span class="main">+</span> <span class="bound">wr</span> <span class="main">+</span> <span class="free">w</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="bound">l</span><span class="main">..</span><span class="bound">r</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Optimal_BST2-left_le_right2"><span class="command">lemma</span></span> left_le_right2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"opt_bst_wpl2_dom<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">i</span><span class="main">=</span><span class="free">j</span> <span class="main">⟶</span> root<span class="main">(</span>fst<span class="main">(</span>opt_bst_wpl2 <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="free">i</span><span class="main">&lt;</span><span class="free">j</span> <span class="main">⟶</span> root<span class="main">(</span>fst<span class="main">(</span>opt_bst_wpl2 <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
    <span class="main">{</span>root<span class="main">(</span>fst<span class="main">(</span>opt_bst_wpl2 <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">..</span> root<span class="main">(</span>fst<span class="main">(</span>opt_bst_wpl2 <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> opt_bst_wpl2.pinduct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>fst<span class="main">(</span>opt_bst_wpl2 <span class="skolem">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>fst<span class="main">(</span>opt_bst_wpl2 <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">tl</span><span class="main">,</span><span class="bound">wl</span><span class="main">)</span> <span class="main">=</span> opt_bst_wpl2 <span class="skolem">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">tr</span><span class="main">,</span><span class="bound">wr</span><span class="main">)</span> <span class="main">=</span> opt_bst_wpl2 <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span>
               <span class="keyword1">in</span> <span class="main">(</span><span class="main">⟨</span><span class="bound">tl</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">tr</span><span class="main">⟩</span><span class="main">,</span> <span class="bound">wl</span> <span class="main">+</span> <span class="bound">wr</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> opt_bst_wpl2.psimps<span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.hyps"</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> left_le_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≤</span> <span class="var">?r</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span><span class="main">-</span><span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>fst<span class="main">(</span>opt_bst_wpl2 <span class="skolem">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>fst<span class="main">(</span>opt_bst_wpl2 <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span><span class="main">-</span><span class="main">1</span>›</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> l r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span><span class="main">-</span><span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span><span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span><span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≤</span> root <span class="main">(</span>fst<span class="main">(</span>opt_bst_wpl2 <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> root <span class="main">(</span>fst<span class="main">(</span>opt_bst_wpl2 <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≤</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> root <span class="main">(</span>fst <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?l</span> <span class="main">..</span> <span class="var">?r</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> argmin_forall<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹map <span class="var">?f</span> <span class="main">[</span><span class="var">?l</span><span class="main">..</span><span class="var">?r</span><span class="main">]</span>›</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="quoted">snd</span><span class="main">]</span> left_le_right
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_bst_wpl2.psimps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted">"1.hyps"</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can bound the result of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> opt_bst_wpl2<span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>

<span class="keyword1" id="Optimal_BST2-root_opt_bst_wpl2_bound"><span class="command">lemma</span></span> root_opt_bst_wpl2_bound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"opt_bst_wpl2_dom <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> root <span class="main">(</span>fst<span class="main">(</span>opt_bst_wpl2 <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>opt_bst_wpl2.pinduct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted">"1.prems"</span> <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">)</span>  <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ _ refl<span class="main">]</span> left_le_right2<span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.hyps"</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now termination follows easily:›</span></span>

<span class="keyword1" id="Optimal_BST2-opt_bst_wpl2_dom"><span class="command">lemma</span></span> opt_bst_wpl2_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">args</span><span class="main">.</span> opt_bst_wpl2_dom <span class="bound">args</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> nat <span class="main">(</span><span class="bound">j</span><span class="main">-</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> root_opt_bst_wpl2_bound<span class="main">)</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> opt_bst_wpl2_dom<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> opt_bst_wpl2.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Optimal_BST2-opt_bst_wpl2_eq_pair"><span class="command">lemma</span></span> opt_bst_wpl2_eq_pair<span class="main">:</span>
  <span class="quoted"><span class="quoted">"opt_bst_wpl2 <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span>opt_bst2 <span class="free">i</span> <span class="free">j</span><span class="main">,</span> wpl <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>opt_bst2 <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> opt_bst_wpl2.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> opt_bst2.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> opt_bst_wpl2.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="comment1">(*opt_bst2_opt_bst*)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>opt_bst2 <span class="skolem">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>opt_bst2 <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≤</span> <span class="var">?r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> left_le_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> opt_bst2_opt_bst opt_bst2_dom<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">case</span> opt_bst_wpl2 <span class="skolem">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">of</span>
             <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">wl</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">case</span> opt_bst_wpl2 <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="keyword1">of</span>
                         <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">wr</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">⟨</span><span class="bound">l</span><span class="main">,</span><span class="bound">k</span><span class="main">,</span><span class="bound">r</span><span class="main">⟩</span><span class="main">,</span> <span class="bound">wl</span> <span class="main">+</span> <span class="bound">wr</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span>opt_bst2 <span class="skolem">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> opt_bst2 <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">⟩</span><span class="main">,</span>
                    wpl <span class="skolem">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>opt_bst2 <span class="skolem">i</span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> wpl <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">(</span>opt_bst2 <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?g</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?l</span><span class="main">..</span><span class="var">?r</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"opt_bst_wpl2 <span class="skolem">i</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>opt_bst2 <span class="skolem">i</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> wpl <span class="skolem">i</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>opt_bst2 <span class="skolem">i</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k <span class="quoted">"1.IH"</span><span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1.IH"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"opt_bst_wpl2 <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span>opt_bst2 <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">,</span> wpl <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">(</span>opt_bst2 <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 k <span class="quoted">"1.IH"</span><span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1.IH"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"opt_bst_wpl2 <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span>
        argmin snd <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span>root<span class="main">(</span>fst<span class="main">(</span>opt_bst_wpl2 <span class="skolem">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">..</span>root<span class="main">(</span>fst<span class="main">(</span>opt_bst_wpl2 <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> argmin snd <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span><span class="var">?l</span><span class="main">..</span><span class="var">?r</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1.IH"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> argmin snd <span class="main">(</span>map <span class="var">?g</span> <span class="main">[</span><span class="var">?l</span><span class="main">..</span><span class="var">?r</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> list.map_cong_simp<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>opt_bst2 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">,</span> wpl <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">(</span>opt_bst2 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> argmin_pairs comp_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> opt_bst_wpl2_eq_pair'<span class="main">:</span> <span class="quoted"><span class="quoted">"opt_bst_wpl2 <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span>opt_bst <span class="free">i</span> <span class="free">j</span><span class="main">,</span> min_wpl <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_bst_wpl2_eq_pair opt_bst2_opt_bst wpl_opt_bst<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* locale Optimal_BST2 *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Optimal_BST_Examples">
<div class="head">
<h1>Theory Optimal_BST_Examples</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">theory</span></span> Optimal_BST_Examples
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Tree.html">HOL-Library.Tree</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Example by Mehlhorn:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">a_ex1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">a_ex1</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="numeral">4</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">10</span><span class="main">]</span> <span class="main">!</span> nat <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">b_ex1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">b_ex1</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="main">0</span><span class="main">]</span> <span class="main">!</span> nat <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">t_opt_ex1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">t_opt_ex1</span> <span class="main">=</span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">⟩</span><span class="main">⟩</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">⟩</span><span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Example by Knuth:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">a_ex2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">a_ex2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">b_ex2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">b_ex2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="numeral">32</span><span class="main">,</span><span class="numeral">7</span><span class="main">,</span><span class="numeral">69</span><span class="main">,</span><span class="numeral">13</span><span class="main">,</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">15</span><span class="main">,</span><span class="numeral">10</span><span class="main">,</span><span class="numeral">8</span><span class="main">,</span><span class="numeral">64</span><span class="main">,</span><span class="numeral">142</span><span class="main">,</span><span class="numeral">22</span><span class="main">,</span><span class="numeral">79</span><span class="main">,</span><span class="numeral">18</span><span class="main">,</span><span class="numeral">9</span><span class="main">]</span> <span class="main">!</span> nat <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">t_opt_ex2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">t_opt_ex2</span> <span class="main">=</span>
  <span class="main">⟨</span>
   <span class="main">⟨</span>
    <span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">⟩</span><span class="main">⟩</span><span class="main">,</span>
    <span class="numeral">2</span><span class="main">,</span>
    <span class="main">⟨</span>
     <span class="main">⟨</span>
      <span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="numeral">4</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">⟩</span><span class="main">⟩</span><span class="main">,</span>
      <span class="numeral">5</span><span class="main">,</span>
      <span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="numeral">6</span><span class="main">,</span> <span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="numeral">7</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">⟩</span><span class="main">⟩</span>
     <span class="main">⟩</span><span class="main">,</span>
     <span class="numeral">8</span><span class="main">,</span>
     <span class="main">⟨⟩</span>
    <span class="main">⟩</span>
   <span class="main">⟩</span><span class="main">,</span>
   <span class="numeral">9</span><span class="main">,</span>
   <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="numeral">10</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">⟩</span><span class="main">,</span>
    <span class="numeral">11</span><span class="main">,</span>
    <span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="numeral">12</span><span class="main">,</span> <span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="numeral">13</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">⟩</span>
    <span class="main">⟩</span>
   <span class="main">⟩</span>
  <span class="main">⟩</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Optimal_BST_Code">
<div class="head">
<h1>Theory Optimal_BST_Code</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Code Generation (unmemoized)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Optimal_BST_Code
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Optimal_BST2">Optimal_BST2</a>
  <a href="#Optimal_BST_Examples">Optimal_BST_Examples</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> Wpl_Optimal_BST <span class="main">=</span> Wpl <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="main">+</span> Optimal_BST <span class="keyword2"><span class="keyword">where</span></span> w <span class="main">=</span> <span class="quoted"><span class="quoted">"Wpl.w <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span>

<span class="keyword1"><span class="command">locale</span></span> Wpl_Optimal_BST2 <span class="main">=</span> Wpl <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="main">+</span> Optimal_BST2 <span class="keyword2"><span class="keyword">where</span></span> w <span class="main">=</span> <span class="quoted"><span class="quoted">"Wpl.w <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span>

<span class="comment1">(* Simultaneous interpretation to avoid technical problem *)</span>
<span class="keyword1"><span class="command">global_interpretation</span></span> Wpl_Optimal_BST <span class="main">+</span> Wpl_Optimal_BST2
<span class="keyword2"><span class="keyword">defines</span></span> wpl_ab <span class="main">=</span> <span class="quoted">wpl</span> <span class="keyword2"><span class="keyword">and</span></span> opt_bst_ab <span class="main">=</span> <span class="quoted">opt_bst</span> <span class="keyword2"><span class="keyword">and</span></span> opt_bst2_ab <span class="main">=</span> <span class="quoted">opt_bst2</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> Wpl.w_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">i'</span> <span class="skolem">j</span> <span class="skolem">j'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mono_thms_linordered_semiring<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sum_mono2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">note</span></span> un1 <span class="main">=</span> ivl_disj_un_two<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> un2 <span class="main">=</span> ivl_disj_un_two<span class="main">(</span>8<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span> <span class="skolem">i'</span> <span class="skolem">j</span> <span class="skolem">j'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">i'</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">j</span><span class="main">&lt;..</span><span class="skolem">ub</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ub</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> un2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i'</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">]</span> un1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">i'</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> un1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">i'</span></span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">]</span>
          un2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i'</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span> un1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">i'</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span> un1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">i'</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_Un_nat <span class="dynamic"><span class="dynamic">algebra_simps</span></span> ivl_disj_int Int_Un_distrib<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Examples:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"opt_bst_ab a_ex1 b_ex1 <span class="main">0</span> <span class="numeral">3</span> <span class="main">=</span> t_opt_ex1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"opt_bst2_ab a_ex2 b_ex2 <span class="main">0</span> <span class="numeral">13</span> <span class="main">=</span> t_opt_ex2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Optimal_BST_Memo">
<div class="head">
<h1>Theory Optimal_BST_Memo</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Memoization\label{sec:memo}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Optimal_BST_Memo
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Optimal_BST">Optimal_BST</a>
  <span class="quoted">"<a href="../../monad_memo_dp/theories/#State_Main">Monad_Memo_DP.State_Main</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Product_Lexorder.html">HOL-Library.Product_Lexorder</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/RBT_Mapping.html">HOL-Library.RBT_Mapping</a>"</span>
  <a href="#Optimal_BST_Examples">Optimal_BST_Examples</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory memoizes the recursive algorithms with the help of our generic memoization
framework. Note that currently only the tree building (function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Optimal_BST.opt_bst<span class="antiquote"><span class="antiquote">}</span></span></span></span>) is memoized but not the computation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>w›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Wpl
<span class="keyword2"><span class="keyword">where</span></span> a <span class="main">=</span> <span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword">and</span></span> b <span class="main">=</span> <span class="quoted"><span class="free">b</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span>
<span class="keyword2"><span class="keyword">defines</span></span> w_ab <span class="main">=</span> <span class="quoted">w</span> <span class="keyword2"><span class="keyword">and</span></span> wpl_ab <span class="main">=</span> <span class="quoted"><span class="quoted">"wpl.wpl <span class="free">w_ab</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First we express <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> argmin<span class="antiquote"><span class="antiquote">}</span></span></span></span> via <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> fold<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
Primarily because we have a monadic version of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> fold<span class="antiquote"><span class="antiquote">}</span></span></span></span> already.
At the same time we improve efficiency.›</span></span>

<span class="keyword1" id="Optimal_BST_Memo-fold_argmin"><span class="command">lemma</span></span> fold_argmin<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span><span class="bound">fm</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">fx</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">fx</span> <span class="main">≤</span> <span class="bound">fm</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">fx</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span><span class="bound">fm</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>
 <span class="main">=</span> <span class="main">(</span>argmin <span class="free">f</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span><span class="main">(</span>argmin <span class="free">f</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1" id="Optimal_BST_Memo-argmin_fold"><span class="command">lemma</span></span> argmin_fold<span class="main">:</span> <span class="quoted"><span class="quoted">"argmin <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">xs</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> undefined <span class="main">|</span>
  <span class="bound">x</span><span class="main">#</span><span class="bound">xs</span> <span class="main">⇒</span> fst<span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span><span class="bound">fm</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">fx</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">fx</span> <span class="main">≤</span> <span class="bound">fm</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">fx</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span><span class="bound">fm</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>fold_argmin <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> argmin.elims list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The actual memoization of the cubic algorithm:›</span></span>

<span class="keyword1"><span class="command">context</span></span> Optimal_BST
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">memoize_fun</span></span> opt_bst<span class="hidden">⇩</span><sub>m</sub><span class="main">:</span> <span class="quoted">opt_bst</span> <span class="keyword2"><span class="keyword">with_memory</span></span> dp_consistency_mapping
<span class="keyword1"><span class="command">monadifies</span></span> <span class="main">(</span>state<span class="main">)</span> opt_bst.simps<span class="main">[</span><span class="operator">unfolded</span> argmin_fold<span class="main">]</span>
<span class="comment1">(* FIXME why not argmin_argmin2? memoize_prover breaks!
How about opt_bst_wpl?
*)</span>
<span class="keyword1"><span class="command">thm</span></span> opt_bst<span class="hidden">⇩</span><sub>m</sub>'.simps

<span class="keyword1"><span class="command">memoize_correct</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">memoize_prover</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span> opt_bst<span class="hidden">⇩</span><sub>m</sub>.memoized_correct

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Code generation:›</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Optimal_BST
<span class="keyword2"><span class="keyword">where</span></span> w <span class="main">=</span> <span class="quoted"><span class="quoted">"w_ab <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"wpl.wpl <span class="main">(</span>w_ab <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> wpl_ab <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span>
<span class="keyword2"><span class="keyword">defines</span></span> opt_bst_ab <span class="main">=</span> <span class="quoted">opt_bst</span> <span class="keyword2"><span class="keyword">and</span></span> opt_bst_ab' <span class="main">=</span> <span class="quoted">opt_bst<span class="hidden">⇩</span><sub>m</sub>'</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wpl_ab_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Examples:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"opt_bst_ab a_ex1 b_ex1 <span class="main">0</span> <span class="numeral">3</span> <span class="main">=</span> t_opt_ex1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"opt_bst_ab a_ex2 b_ex2 <span class="main">0</span> <span class="numeral">13</span> <span class="main">=</span> t_opt_ex2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>