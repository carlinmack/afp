<div id="Core">
<div class="head">
<h1>Theory Core</h1>
</div>
<pre class="source">
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Core Inference system›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Contains just the stuff necessary for the definition of the Inference system›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Core
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic types ›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> name <span class="main">=</span> <span class="quoted">String.literal</span>
<span class="keyword1"><span class="command">type_synonym</span></span> indexname <span class="main">=</span> <span class="quoted"><span class="quoted">"name <span class="main">×</span> int"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="quoted">"class"</span> <span class="main">=</span> <span class="quoted">String.literal</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="quoted">"sort"</span> <span class="main">=</span> <span class="quoted"><span class="quoted">"class set"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">full_sort</span> <span class="main">≡</span> <span class="main">(</span><span class="main">{}</span><span class="main">::</span>sort<span class="main">)</span>"</span></span>

<span class="comment1">(* Name duplication with Fv in term, change later*)</span>
<span class="keyword1"><span class="command">datatype</span></span> variable <span class="main">=</span> Free <span class="quoted">name</span> <span class="main">|</span> Var <span class="quoted">indexname</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"typ"</span> <span class="main">=</span>
  <span class="entity">is_Ty</span><span class="main">:</span> Ty <span class="quoted">name</span> <span class="quoted"><span class="quoted">"typ list"</span></span> <span class="main">|</span>
  <span class="entity">is_Tv</span><span class="main">:</span> Tv <span class="quoted">variable</span> <span class="quoted">sort</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"term"</span> <span class="main">=</span>
  <span class="entity">is_Ct</span><span class="main">:</span> Ct <span class="quoted">name</span> <span class="quoted"><span class="quoted">"typ"</span></span> <span class="main">|</span>
  <span class="entity">is_Fv</span><span class="main">:</span> Fv <span class="quoted">variable</span> <span class="quoted"><span class="quoted">"typ"</span></span> <span class="main">|</span>
  <span class="entity">is_Bv</span><span class="main">:</span> Bv <span class="quoted">nat</span> <span class="main">|</span>
  <span class="entity">is_Abs</span><span class="main">:</span> Abs <span class="quoted"><span class="quoted">"typ"</span></span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">|</span>
  <span class="entity">is_App</span><span class="main">:</span> App <span class="quoted"><span class="quoted">"term"</span></span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">$</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 100<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_fun_typ</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span> Ty <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span>"</span></span> 
<span class="keyword1"><span class="command">notation</span></span> mk_fun_typ <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 100<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Collect variables in a term›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> <span class="main">(</span>variable <span class="main">×</span> typ<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span>Ct <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span>Bv <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span>Abs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fv</span> <span class="free"><span class="bound"><span class="entity">body</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fv</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∪</span> <span class="free">fv</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">s</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">.</span> fv <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Typ/term instantiations›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tsubstT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"typ <span class="main">⇒</span> <span class="main">(</span>variable <span class="main">⇒</span> sort <span class="main">⇒</span> typ<span class="main">)</span> <span class="main">⇒</span> typ"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">tsubstT</span> <span class="main">(</span>Tv <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tsubstT</span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">σs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> Ty <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">tsubstT</span> <span class="bound">σ</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tinstT</span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">ρ</span><span class="main">.</span> tsubstT <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="bound">ρ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tsubst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> <span class="main">(</span>variable <span class="main">⇒</span> sort <span class="main">⇒</span> typ<span class="main">)</span> <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tsubst</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> Ct <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>tsubstT <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tsubst</span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> Fv <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>tsubstT <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tsubst</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tsubst</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> Abs <span class="main">(</span>tsubstT <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">tsubst</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tsubst</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="free">tsubst</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">$</span> <span class="free">tsubst</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Typ of a term›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">has_typ1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"typ list <span class="main">⇒</span> term <span class="main">⇒</span> typ <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>τ</sub></span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>51<span class="main">,</span> 51<span class="main">,</span> 51<span class="main">]</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">has_typ1</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Ct <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">⟹</span> <span class="free">has_typ1</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>nth <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">has_typ1</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Fv <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">has_typ1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">T'</span></span></span> <span class="main">⟹</span> <span class="free">has_typ1</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">T'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">has_typ1</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⟹</span> <span class="free">has_typ1</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">⟹</span>
      <span class="free">has_typ1</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_typ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> typ <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>τ</sub></span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>51<span class="main">,</span> 51<span class="main">]</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">has_typ</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> has_typ1 <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">typ_of</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">T</span> <span class="main">.</span> has_typ <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">T</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">T</span> <span class="main">.</span> has_typ <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">T</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹More operations on terms›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> nat <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> Bv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> App <span class="main">(</span><span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst_bv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> nat <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_bv2</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>
    <span class="keyword1">else</span> <span class="main">(</span>Bv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_bv2</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free">subst_bv2</span> <span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>lift <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_bv2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free">subst_bv2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">$</span> <span class="free">subst_bv2</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_bv2</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst_bv</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> subst_bv2 <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bind_fv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>variable <span class="main">×</span> typ<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bind_fv2</span> <span class="free"><span class="bound"><span class="entity">vT</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">vT</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="keyword1">then</span> Bv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> Fv <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bind_fv2</span> <span class="free"><span class="bound"><span class="entity">vT</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free">bind_fv2</span> <span class="free"><span class="bound"><span class="entity">vT</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bind_fv2</span> <span class="free"><span class="bound"><span class="entity">vT</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">bind_fv2</span> <span class="free"><span class="bound"><span class="entity">vT</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="free">bind_fv2</span> <span class="free"><span class="bound"><span class="entity">vT</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bind_fv2</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bind_fv</span> <span class="free"><span class="bound"><span class="entity">vT</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> bind_fv2 <span class="free"><span class="bound"><span class="entity">vT</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Abs_fv</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some typ/term constants›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">itselfT</span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="main">≡</span> Ty <span class="keyword1">STR</span> <span class="inner_quoted">''itself''</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">ty</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">constT</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">≡</span> Ty <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">propT</span> <span class="main">≡</span> constT <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_eq</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">≡</span> Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.eq''</span> 
  <span class="main">(</span>the <span class="main">(</span>typ_of <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span>the <span class="main">(</span>typ_of <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="comment1">(* Because mk_eq works only with closed terms *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_eq'</span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">≡</span> Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.eq''</span> 
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="main">→</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="main">→</span> propT<span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mk_imp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⟼</span>"</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.imp''</span> <span class="main">(</span>propT <span class="main">→</span> <span class="main">(</span>propT <span class="main">→</span> propT<span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_all</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
  Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs_fv <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Order sorted signature›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> osig <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>class rel <span class="main">×</span> <span class="main">(</span>name <span class="main">⇀</span> <span class="main">(</span>class <span class="main">⇀</span> sort list<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="quoted">"<span class="entity">subclass</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"osig <span class="main">⇒</span> class rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">subclass</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tcsigs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"osig <span class="main">⇒</span> <span class="main">(</span>name <span class="main">⇀</span> <span class="main">(</span>class <span class="main">⇀</span> sort list<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">tcsigs</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relation in sorts›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">class_leq</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">class_les</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">=</span> <span class="main">(</span>class_leq <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">∧</span> <span class="main">¬</span> class_leq <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sort_leq</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">.</span> <span class="main">∃</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">.</span> class_leq <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Is a class/sort defined›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">class_ex</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∈</span> Field <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sort_ex</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⊆</span> Field <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Normalizing sorts›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">normalize_sort</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">::</span>sort<span class="main">)</span>
  <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">c</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> class_les <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="bound">c'</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">normalized_sort</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> normalize_sort <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf_sort</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span>normalized_sort <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> sort_ex <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Wellformedness of osig›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_subclass</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">=</span> <span class="main">(</span>trans <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">∧</span> antisym <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">∧</span> Refl <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">complete_tcsigs</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">tcs</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> ran <span class="free"><span class="bound"><span class="entity">tcs</span></span></span> <span class="main">.</span> 
  <span class="main">∀</span><span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">.</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∈</span>dom <span class="bound">ars</span> <span class="main">⟶</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∈</span>dom <span class="bound">ars</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">coregular_tcsigs</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">tcs</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> ran <span class="free"><span class="bound"><span class="entity">tcs</span></span></span> <span class="main">.</span>
  <span class="main">∀</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> dom <span class="bound">ars</span><span class="main">.</span> <span class="main">∀</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> dom <span class="bound">ars</span><span class="main">.</span>
    <span class="main">(</span>class_leq <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> list_all2 <span class="main">(</span>sort_leq <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">ars</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">ars</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">consistent_length_tcsigs</span> <span class="free"><span class="bound"><span class="entity">tcs</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> ran <span class="free"><span class="bound"><span class="entity">tcs</span></span></span> <span class="main">.</span> 
  <span class="main">∀</span><span class="bound">ss<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> ran <span class="bound">ars</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ss<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> ran <span class="bound">ars</span><span class="main">.</span> length <span class="bound">ss<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="bound">ss<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">all_normalized_and_ex_tcsigs</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">tcs</span></span></span> <span class="main">≡</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> ran <span class="free"><span class="bound"><span class="entity">tcs</span></span></span> <span class="main">.</span> <span class="main">∀</span><span class="bound">ss</span> <span class="main">∈</span> ran <span class="bound">ars</span> <span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="bound">ss</span><span class="main">.</span> wf_sort <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_tcsigs</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">tcs</span></span></span> <span class="main">⟷</span>
    coregular_tcsigs <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">tcs</span></span></span>
  <span class="main">∧</span> complete_tcsigs <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">tcs</span></span></span>
  <span class="main">∧</span> consistent_length_tcsigs <span class="free"><span class="bound"><span class="entity">tcs</span></span></span>
  <span class="main">∧</span> all_normalized_and_ex_tcsigs <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">tcs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wf_osig</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf_osig</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tcs</span></span></span><span class="main">)</span> <span class="main">⟷</span> wf_subclass <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">∧</span> wf_tcsigs <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">tcs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Embedding typs into terms/Encoding of type classes›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_type</span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="main">=</span> Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.type''</span> <span class="main">(</span>Core.itselfT <span class="free"><span class="bound"><span class="entity">ty</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_suffix</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">str</span></span></span><span class="main">::</span>name<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">suff</span></span></span> <span class="main">≡</span> String.implode <span class="main">(</span>String.explode <span class="free"><span class="bound"><span class="entity">str</span></span></span> <span class="main">@</span> String.explode <span class="free"><span class="bound"><span class="entity">suff</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">classN</span> <span class="main">≡</span> <span class="keyword1">STR</span> <span class="inner_quoted">''_class''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">const_of_class</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">≡</span> mk_suffix <span class="free"><span class="bound"><span class="entity">name</span></span></span> classN"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_of_class</span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span>
  Ct <span class="main">(</span>const_of_class <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>Core.itselfT <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> mk_type <span class="free"><span class="bound"><span class="entity">ty</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Checking if a typ belongs to a sort›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">has_sort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"osig <span class="main">⇒</span> typ <span class="main">⇒</span> sort <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  has_sort_Tv<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sort_leq <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span> <span class="main">⟹</span> <span class="free">has_sort</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tcs</span></span></span><span class="main">)</span> <span class="main">(</span>Tv <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span>"</span></span>
<span class="main">|</span> has_sort_Ty<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">tcs</span></span></span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">c</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">Ss</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="bound">c</span> <span class="main">=</span> Some <span class="bound">Ss</span> <span class="main">∧</span> list_all2 <span class="main">(</span><span class="free">has_sort</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tcs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="bound">Ss</span>
    <span class="main">⟹</span> <span class="free">has_sort</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tcs</span></span></span><span class="main">)</span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Signatures ›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> signature <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">⇀</span> typ<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>name <span class="main">⇀</span> nat<span class="main">)</span> <span class="main">×</span> osig"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">const_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"signature <span class="main">⇒</span> <span class="main">(</span>name <span class="main">⇀</span> typ<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">const_type</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ctf</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ctf</span></span></span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">type_arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"signature <span class="main">⇒</span> <span class="main">(</span>name <span class="main">⇀</span> nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_arity</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">arf</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">arf</span></span></span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">osig</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"signature <span class="main">⇒</span> osig"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">osig</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">oss</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">oss</span></span></span>"</span></span>

<span class="comment1">(* Which typs and consts must be defined in a signature*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_std_sig</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_std_sig</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ctf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">arf</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">⟷</span>
    <span class="free"><span class="bound"><span class="entity">arf</span></span></span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> <span class="main">=</span> Some <span class="numeral">2</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">arf</span></span></span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">=</span> Some <span class="main">0</span> 
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">arf</span></span></span> <span class="keyword1">STR</span> <span class="inner_quoted">''itself''</span> <span class="main">=</span> Some <span class="main">1</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">ctf</span></span></span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.eq''</span> 
    <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span>Tv <span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">(</span>Tv <span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">ctf</span></span></span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span>Tv <span class="main">(</span>Var  <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">ctf</span></span></span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.imp''</span> <span class="main">=</span> Some <span class="main">(</span>propT <span class="main">→</span> <span class="main">(</span>propT <span class="main">→</span> propT<span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">ctf</span></span></span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.type''</span> <span class="main">=</span> Some <span class="main">(</span>itselfT <span class="main">(</span>Tv <span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Wellformedness checks›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">class_ok_sig</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> class_ex <span class="main">(</span>subclass <span class="main">(</span>osig <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">wf_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"signature <span class="main">⇒</span> typ <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  typ_ok_Ty<span class="main">:</span> <span class="quoted"><span class="quoted">"type_arity <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="main">=</span> Some <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">T</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">.</span> <span class="free">wf_type</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="bound">T</span>
    <span class="main">⟹</span> <span class="free">wf_type</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> typ_ok_Tv<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_sort <span class="main">(</span>subclass <span class="main">(</span>osig <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟹</span> <span class="free">wf_type</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Tv <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">wf_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"signature <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"wf_type <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟹</span> <span class="free">wf_term</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf_term</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"const_type <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="main">⟹</span> wf_type <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟹</span> tinstT <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="main">⟹</span> <span class="free">wf_term</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf_term</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free">wf_term</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟹</span> <span class="free">wf_term</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"wf_type <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟹</span> <span class="free">wf_term</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free">wf_term</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">wt_term</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> wf_term <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">T</span><span class="main">.</span> has_typ <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">T</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wf_sig</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"signature <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>                
  <span class="quoted"><span class="quoted">"<span class="free">wf_sig</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ctf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">arf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">oss</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>wf_osig <span class="free"><span class="bound"><span class="entity">oss</span></span></span>
  <span class="main">∧</span> dom <span class="main">(</span>tcsigs <span class="free"><span class="bound"><span class="entity">oss</span></span></span><span class="main">)</span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">arf</span></span></span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">type</span> <span class="main">∈</span> dom <span class="main">(</span>tcsigs <span class="free"><span class="bound"><span class="entity">oss</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> ran <span class="main">(</span>the <span class="main">(</span>tcsigs <span class="free"><span class="bound"><span class="entity">oss</span></span></span> <span class="bound">type</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">arf</span></span></span> <span class="bound">type</span><span class="main">)</span> <span class="main">=</span> length <span class="bound">ars</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ty</span> <span class="main">∈</span> Map.ran <span class="free"><span class="bound"><span class="entity">ctf</span></span></span> <span class="main">.</span> wf_type <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ctf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">arf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">oss</span></span></span><span class="main">)</span> <span class="bound">ty</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theories›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="quoted">"theory"</span> <span class="main">=</span> <span class="quoted"><span class="quoted">"signature <span class="main">×</span> term set"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sig</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"theory <span class="main">⇒</span> signature"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sig</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">axioms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"theory <span class="main">⇒</span> term set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">axioms</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">axs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">axs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Equality axioms, stated directly›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">tvariable</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">(</span>Tv <span class="main">(</span>Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">variable</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span> Fv <span class="main">(</span>Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">aT</span> <span class="main">≡</span> tvariable <span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">bT</span> <span class="main">≡</span> tvariable <span class="keyword1">STR</span> <span class="inner_quoted">'''b''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≡</span> variable <span class="keyword1">STR</span> <span class="inner_quoted">''x''</span> aT"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≡</span> variable <span class="keyword1">STR</span> <span class="inner_quoted">''y''</span> aT"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≡</span> variable <span class="keyword1">STR</span> <span class="inner_quoted">''z''</span> aT"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> variable <span class="keyword1">STR</span> <span class="inner_quoted">''f''</span> <span class="main">(</span>aT <span class="main">→</span> bT<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≡</span> variable <span class="keyword1">STR</span> <span class="inner_quoted">''g''</span> <span class="main">(</span>aT <span class="main">→</span> bT<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≡</span> variable <span class="keyword1">STR</span> <span class="inner_quoted">''P''</span> <span class="main">(</span>aT <span class="main">→</span> propT<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">≡</span> variable <span class="keyword1">STR</span> <span class="inner_quoted">''Q''</span> <span class="main">(</span>aT <span class="main">→</span> propT<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≡</span> variable <span class="keyword1">STR</span> <span class="inner_quoted">''A''</span> propT"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≡</span> variable <span class="keyword1">STR</span> <span class="inner_quoted">''B''</span> propT"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eq_reflexive_ax</span> <span class="main">≡</span> mk_eq x x"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eq_symmetric_ax</span> <span class="main">≡</span> mk_eq x y <span class="main">⟼</span> mk_eq y x"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eq_transitive_ax</span> <span class="main">≡</span> mk_eq x y <span class="main">⟼</span> mk_eq y z <span class="main">⟼</span> mk_eq x z"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eq_intr_ax</span> <span class="main">≡</span> <span class="main">(</span>A <span class="main">⟼</span> B<span class="main">)</span> <span class="main">⟼</span> <span class="main">(</span>B <span class="main">⟼</span> A<span class="main">)</span> <span class="main">⟼</span> mk_eq A B"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eq_elim_ax</span> <span class="main">≡</span> mk_eq A B <span class="main">⟼</span> A <span class="main">⟼</span> B"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eq_combination_ax</span> <span class="main">≡</span> mk_eq f g <span class="main">⟼</span> mk_eq x y <span class="main">⟼</span> mk_eq <span class="main">(</span>f <span class="main">$</span> x<span class="main">)</span> <span class="main">(</span>g <span class="main">$</span> y<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eq_abstract_rule_ax</span> <span class="main">≡</span> 
      <span class="main">(</span>Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span>aT <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs aT <span class="main">(</span>mk_eq' bT <span class="main">(</span>f <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span>g <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⟼</span> mk_eq <span class="main">(</span>Abs aT <span class="main">(</span>f <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Abs aT <span class="main">(</span>g <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> x y z f g P Q A B

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">eq_axs</span> <span class="main">≡</span> <span class="main">{</span>eq_reflexive_ax<span class="main">,</span> eq_symmetric_ax<span class="main">,</span> eq_transitive_ax<span class="main">,</span> eq_intr_ax<span class="main">,</span> eq_elim_ax<span class="main">,</span>
  eq_combination_ax<span class="main">,</span> eq_abstract_rule_ax<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Wellformedness of theories›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wf_theory</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf_theory</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">axs</span></span></span><span class="main">)</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">axs</span></span></span> <span class="main">.</span> wt_term <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="bound">p</span> <span class="main">∧</span> has_typ <span class="bound">p</span> propT<span class="main">)</span>
  <span class="main">∧</span> is_std_sig <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> 
  <span class="main">∧</span> wf_sig <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>
  <span class="main">∧</span> eq_axs <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">axs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Wellformedness of typ antiations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_inst</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">≡</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="bound">S</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">v</span> <span class="bound">S</span> <span class="main">≠</span> Tv <span class="bound">v</span> <span class="bound">S</span> <span class="main">⟶</span>
    <span class="main">(</span>has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">v</span> <span class="bound">S</span><span class="main">)</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∧</span> wf_type <span class="main">(</span>sig <span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">v</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Inference system›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">proves</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"theory <span class="main">⇒</span> term set <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword1">,</span>_<span class="keyword3">)</span> <span class="keyword1">⊢</span> <span class="keyword3">(</span>_<span class="keyword3">)</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">Θ</span> <span class="keyword2"><span class="keyword">where</span></span>
  axiom<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">∈</span>axioms <span class="free">Θ</span> <span class="main">⟹</span> wf_inst <span class="free">Θ</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span>
  <span class="main">⟹</span> <span class="free">Θ</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> tsubst <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted">"assume"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_term <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟹</span> has_typ <span class="free"><span class="bound"><span class="entity">A</span></span></span> propT <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⟹</span> <span class="free">Θ</span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>
<span class="main">|</span> forall_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> <span class="free">Θ</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="main">∉</span> FV <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⟹</span> wf_type <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span>  <span class="free"><span class="bound"><span class="entity">τ</span></span></span>
  <span class="main">⟹</span> <span class="free">Θ</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> mk_all <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
<span class="main">|</span> forall_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>
  <span class="main">⟹</span> has_typ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟹</span> wf_term <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>
  <span class="main">⟹</span> <span class="free">Θ</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> subst_bv <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
<span class="main">|</span> implies_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> <span class="free">Θ</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟹</span> wf_term <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟹</span> has_typ <span class="free"><span class="bound"><span class="entity">A</span></span></span> propT 
  <span class="main">⟹</span> <span class="free">Θ</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟼</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
<span class="main">|</span> implies_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟼</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟹</span> <span class="free">Θ</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟹</span> <span class="free">Θ</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
<span class="main">|</span> of_class<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>
  <span class="main">⟹</span> const_type <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>const_of_class <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>Core.itselfT aT <span class="main">→</span> propT<span class="main">)</span>
  <span class="main">⟹</span> wf_type <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>
  <span class="main">⟹</span> has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">}</span>
  <span class="main">⟹</span> <span class="free">Θ</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> mk_of_class <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="comment1">(* Stuff about equality that cannot be expressed as an axiom*)</span>
<span class="main">|</span> β_conversion<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> wt_term <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">⟹</span> wf_term <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟹</span> has_typ <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> 
  <span class="main">⟹</span> <span class="free">Θ</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> mk_eq <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> eta<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> wf_term <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> has_typ <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">τ'</span></span></span><span class="main">)</span>
  <span class="main">⟹</span> <span class="free">Θ</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> mk_eq <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Ensure no garbage in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Θ,Γ›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">proves'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"theory <span class="main">⇒</span> term set <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword1">,</span>_<span class="keyword3">)</span> <span class="keyword1">⊩</span> <span class="keyword3">(</span>_<span class="keyword3">)</span>"</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proves'</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> wf_theory <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">h</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">.</span> wf_term <span class="main">(</span>sig <span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">)</span> <span class="bound">h</span> <span class="main">∧</span> has_typ <span class="bound">h</span> propT<span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> aT bT

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Preliminaries">
<div class="head">
<h1>Theory Preliminaries</h1>
</div>
<pre class="source">
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Preliminaries"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Preliminaries
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Complex_Main.html">Complex_Main</a> 
    <span class="quoted">"<a href="../List-Index/List_Index.html">List-Index.List_Index</a>"</span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/AList.html">HOL-Library.AList</a>"</span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span> 
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Simps_Case_Conv.html">HOL-Library.Simps_Case_Conv</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Stuff about options›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">the_default</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">the_default</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> None <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">the_default</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Or</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">OR</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1"><span class="free">OR</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">|</span> <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span>"</span></span>

<span class="keyword1" id="Preliminaries-Or_Some"><span class="command">lemma</span></span> Or_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">e1</span> <span class="keyword1">OR</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟷</span> <span class="free">e1</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">∨</span> <span class="main">(</span><span class="free">e1</span> <span class="main">=</span> None <span class="main">∧</span> <span class="free">e2</span> <span class="main">=</span> Some <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1" id="Preliminaries-Or_None"><span class="command">lemma</span></span> Or_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">e1</span> <span class="keyword1">OR</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="free">e1</span> <span class="main">=</span> None <span class="main">∧</span> <span class="free">e2</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lift2_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'b</span> option <span class="main">⇒</span> <span class="tfree">'c</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift2_option</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> None <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lift2_option</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> None <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lift2_option</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Preliminaries-lift2_option_not_None"><span class="command">lemma</span></span> lift2_option_not_None<span class="main">:</span> <span class="quoted"><span class="quoted">"lift2_option <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">≠</span> None <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="free">y</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lift2_option.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1" id="Preliminaries-lift2_option_None"><span class="command">lemma</span></span> lift2_option_None<span class="main">:</span> <span class="quoted"><span class="quoted">"lift2_option <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">y</span> <span class="main">=</span> None<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lift2_option.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lookup functions for assoc lists›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">find</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">find</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">OR</span> <span class="free">find</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="Preliminaries-findD"><span class="command">lemma</span></span> findD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"find <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">p</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Preliminaries-find_None"><span class="command">lemma</span></span> find_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"find <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Preliminaries-find_ListFind"><span class="command">lemma</span></span> find_ListFind<span class="main">:</span> <span class="quoted"><span class="quoted">"find <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> Option.bind <span class="main">(</span>List.find <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="free">f</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
     
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"List.find <span class="free">P</span> <span class="free">l</span> <span class="main">=</span> Some <span class="free">p</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">l</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Preliminaries-find_the_pair"><span class="command">lemma</span></span> find_the_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">pairs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>map fst <span class="free">pairs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">y</span><span class="main">∈</span>set <span class="main">(</span>map fst <span class="free">pairs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">pairs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"List.find <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="free">pairs</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pairs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">pair</span> <span class="skolem">pairs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">thm</span></span> Cons.prems

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">pair</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> eq_key_imp_eq_value<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pairs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">pairs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">pairs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"List.find <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">pairs</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">pair</span> <span class="main">#</span> <span class="skolem">pairs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_zip_leftD zip_map_fst_snd<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remdups_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remdups_on</span>  <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remdups_on</span> <span class="free"><span class="bound"><span class="entity">cmp</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">x'</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">cmp</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">x'</span> <span class="keyword1">then</span> <span class="free">remdups_on</span> <span class="free"><span class="bound"><span class="entity">cmp</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">remdups_on</span> <span class="free"><span class="bound"><span class="entity">cmp</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">distinct_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">distinct_on</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">distinct_on</span> <span class="free"><span class="bound"><span class="entity">cmp</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">x'</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">cmp</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">distinct_on</span> <span class="free"><span class="bound"><span class="entity">cmp</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"remdups_on <span class="main">(=)</span> <span class="free">xs</span> <span class="main">=</span> remdups <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Preliminaries-remdups_on_antimono"><span class="command">lemma</span></span> remdups_on_antimono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> set <span class="main">(</span>remdups_on <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>remdups_on <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Preliminaries-remdups_on_subset_input"><span class="command">lemma</span></span> remdups_on_subset_input<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remdups_on <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Preliminaries-distinct_on_remdups_on"><span class="command">lemma</span></span> distinct_on_remdups_on<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_on <span class="free">f</span> <span class="main">(</span>remdups_on <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> remdups_on_subset_input <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1" id="Preliminaries-distinct_on_no_compare"><span class="command">lemma</span></span> distinct_on_no_compare<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span><span class="main">⟹</span> 
  distinct_on <span class="free">f</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span>set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">y</span><span class="main">∈</span>set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">≠</span><span class="free">y</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">f</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">else</span> <span class="free">lookup</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Preliminaries-lookup_present_eq_key"><span class="command">lemma</span></span> lookup_present_eq_key<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">al</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">al</span> <span class="main">⟷</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">k</span><span class="main">)</span> <span class="free">al</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">al</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_image_eqI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Preliminaries-lookup_None_iff"><span class="command">lemma</span></span> lookup_None_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Preliminaries-find_Some"><span class="command">lemma</span></span> find_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"List.find <span class="free">P</span> <span class="free">l</span> <span class="main">=</span> Some <span class="free">p</span> <span class="main">⟹</span> <span class="free">p</span><span class="main">∈</span>set <span class="free">l</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> 

<span class="comment1">(* This means lookup seems somewhat superflouus *)</span>
<span class="keyword1" id="Preliminaries-find_Some_imp_lookup_Some"><span class="command">lemma</span></span> find_Some_imp_lookup_Some<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"List.find <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> lookup <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Preliminaries-lookup_Some_imp_find_Some"><span class="command">lemma</span></span> lookup_Some_imp_find_Some<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"lookup <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> List.find <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Preliminaries-lookup_None_iff_find_None"><span class="command">lemma</span></span> lookup_None_iff_find_None<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> None <span class="main">⟷</span> List.find <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Preliminaries-lookup_eq_order_irrelevant"><span class="command">lemma</span></span> lookup_eq_order_irrelevant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">pairs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">pairs'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">pairs</span> <span class="main">=</span> set <span class="free">pairs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">k</span><span class="main">)</span> <span class="free">pairs</span> <span class="main">=</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">k</span><span class="main">)</span> <span class="free">pairs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">k</span><span class="main">)</span> <span class="free">pairs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lookup_None_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> set_map<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span>set <span class="free">pairs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_present_eq_key<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> el<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span>set <span class="free">pairs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lookup_present_eq_key<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> el Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Preliminaries-lookup_Some_append_back"><span class="command">lemma</span></span> lookup_Some_append_back<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">k</span><span class="main">)</span> <span class="free">insts</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">insts</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Preliminaries-lookup_eq_key_not_present"><span class="command">lemma</span></span> lookup_eq_key_not_present<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">inst</span><span class="main">)</span> <span class="main">⟹</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">key</span><span class="main">)</span> <span class="free">inst</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">inst</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Preliminaries-lookup_in_empty"><span class="command">lemma</span></span> lookup_in_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="free">f</span> <span class="main">[]</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Preliminaries-lookup_in_single"><span class="command">lemma</span></span> lookup_in_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="free">f</span> <span class="main">[</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">f</span> <span class="free">k</span> <span class="keyword1">then</span> Some <span class="free">v</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Preliminaries-lookup_present_eq_key'"><span class="command">lemma</span></span> lookup_present_eq_key'<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">k</span><span class="main">)</span> <span class="free">al</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">al</span> "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">al</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_image_eqI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Preliminaries-lookup_present_eq_key''"><span class="command">lemma</span></span> lookup_present_eq_key''<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">al</span><span class="main">)</span> <span class="main">⟹</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">k</span><span class="main">)</span> <span class="free">al</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">al</span> "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">al</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_image_eqI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Preliminaries-key_present_imp_eq_lookup_finds_value"><span class="command">lemma</span></span> key_present_imp_eq_lookup_finds_value<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">al</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">.</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">k</span><span class="main">)</span> <span class="free">al</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">al</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>

<span class="keyword1" id="Preliminaries-list_allI"><span class="command">lemma</span></span> list_allI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">l</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> list_all <span class="free">P</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Preliminaries-map2_sym"><span class="command">lemma</span></span> map2_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> map2 <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> map2 <span class="free">f</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Preliminaries-idem_map2"><span class="command">lemma</span></span> idem_map2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map2 <span class="free">f</span> <span class="free">l</span> <span class="free">l</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> length <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map2 <span class="free">f</span> <span class="free">l</span> <span class="free">l</span> <span class="main">=</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Preliminaries-rev_induct2"><span class="command">lemma</span></span> rev_induct2<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Nil snoc<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> length <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>rev <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>rev <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">(</span>rev <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">ys</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Preliminaries-alist_map_corr"><span class="command">lemma</span></span> alist_map_corr<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">al</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">al</span> <span class="main">⟷</span> map_of <span class="free">al</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Preliminaries-distinct_fst_imp_distinct"><span class="command">lemma</span></span> distinct_fst_imp_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">l</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Preliminaries-length_alist"><span class="command">lemma</span></span> length_alist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">al</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">al'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">al</span> <span class="main">=</span> set <span class="free">al'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">al</span> <span class="main">=</span> length <span class="free">al'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_card length_map set_map<span class="main">)</span>

<span class="keyword1" id="Preliminaries-same_map_of_imp_same_length"><span class="command">lemma</span></span> same_map_of_imp_same_length<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">ars1</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>map fst <span class="free">ars2</span><span class="main">)</span> <span class="main">⟹</span> map_of <span class="free">ars1</span> <span class="main">=</span> map_of <span class="free">ars2</span>
  <span class="main">⟹</span> length <span class="free">ars1</span> <span class="main">=</span> length <span class="free">ars2</span>"</span></span>
  <span class="comment1">(* Name is a bit to specific*)</span>
  <span class="keyword1"><span class="command">using</span></span> length_alist map_of_inject_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Preliminaries-in_range_if_ex_key"><span class="command">lemma</span></span> in_range_if_ex_key<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> ran <span class="free">m</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">m</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ranI ran_def<span class="main">)</span>

<span class="keyword1" id="Preliminaries-set_AList_delete_bound"><span class="command">lemma</span></span> set_AList_delete_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>AList.delete <span class="free">a</span> <span class="free">l</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Preliminaries-list_all_clearjunk_cons"><span class="command">lemma</span></span> list_all_clearjunk_cons<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="main">(</span>AList.clearjunk <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> list_all <span class="free">P</span> <span class="main">(</span>AList.clearjunk <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> AList.clearjunk.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_twist<span class="main">)</span>

<span class="keyword1" id="Preliminaries-lookup_AList_delete"><span class="command">lemma</span></span> lookup_AList_delete<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k'</span><span class="main">≠</span><span class="free">k</span> <span class="main">⟹</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span> <span class="free">al</span> <span class="main">=</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>AList.delete <span class="free">k'</span> <span class="free">al</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">al</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Preliminaries-lookup_AList_clearjunk"><span class="command">lemma</span></span> lookup_AList_clearjunk<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span> <span class="free">al</span> <span class="main">=</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>AList.clearjunk <span class="free">al</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">al</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">al</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span><span class="main">=</span><span class="free">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> clearjunk.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lookup.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>AList.clearjunk <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">al</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> AList.clearjunk <span class="main">(</span>AList.delete <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span> <span class="skolem">al</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>AList.clearjunk <span class="main">(</span>AList.delete <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span> <span class="skolem">al</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> False lookup.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> surjective_pairing<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>AList.clearjunk <span class="skolem">al</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False clearjunk_delete lookup_AList_delete<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">al</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">al</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> False lookup.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> surjective_pairing<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">diff_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> fold removeAll <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="Preliminaries-diff_list_set"><span class="command">lemma</span></span> diff_list_set<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>diff_list <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">-</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Preliminaries-diff_list_set_from_Nil"><span class="command">lemma</span></span> diff_list_set_from_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"diff_list <span class="main">[]</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> last_in_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Preliminaries-diff_list_set_remove_Nil"><span class="command">lemma</span></span> diff_list_set_remove_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"diff_list <span class="free">xs</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Preliminaries-diff_list_rec"><span class="command">lemma</span></span> diff_list_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_list <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span><span class="main">∈</span>set <span class="free">ys</span> <span class="keyword1">then</span> diff_list <span class="free">xs</span> <span class="free">ys</span> <span class="keyword1">else</span> <span class="free">x</span><span class="main">#</span>diff_list <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Preliminaries-diff_list_order_irr"><span class="command">lemma</span></span> diff_list_order_irr<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">=</span> set <span class="free">ys'</span> <span class="main">⟹</span> diff_list <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> diff_list <span class="free">xs</span> <span class="free">ys'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys'</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quoted"><span class="skolem">ys'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_list_rec<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Folding lists with option return typs. probably no longer relevant, was for implementing sorts by lists *)</span>
<span class="keyword1" id="Preliminaries-fold_Option_bind_eq_Some_start_not_None"><span class="command">lemma</span></span> fold_Option_bind_eq_Some_start_not_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">new</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">new</span><span class="main">)</span><span class="main">)</span> <span class="free">list</span> <span class="free">start</span> <span class="main">=</span> Some <span class="free">res</span>
  <span class="main">⟹</span> <span class="free">start</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">list</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Preliminaries-fold_Option_bind_eq_Some_at_point_not_None"><span class="command">lemma</span></span> fold_Option_bind_eq_Some_at_point_not_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">new</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">new</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">l2</span><span class="main">)</span> <span class="free">start</span> <span class="main">=</span> Some <span class="free">res</span>
  <span class="main">⟹</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">new</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">new</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">l1</span><span class="main">)</span> <span class="free">start</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">l2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> fold_Option_bind_eq_Some_start_not_None <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> 
      <span class="quoted">‹<span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> bind_eq_Some_conv›</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Preliminaries-fold_Option_bind_eq_Some_start_not_None'"><span class="command">lemma</span></span> fold_Option_bind_eq_Some_start_not_None'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">list</span> <span class="free">start</span> <span class="main">=</span> Some <span class="free">res</span>
  <span class="main">⟹</span> <span class="free">start</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">list</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">list</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Preliminaries-fold_Option_bind_eq_None_start_None"><span class="command">lemma</span></span> fold_Option_bind_eq_None_start_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">list</span> None <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">list</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits prod.splits<span class="main">)</span>

<span class="keyword1" id="Preliminaries-fold_Option_bind_at_some_point_None_eq_None"><span class="command">lemma</span></span> fold_Option_bind_at_some_point_None_eq_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">l1</span> <span class="free">start</span> <span class="main">=</span> None <span class="main">⟹</span>
  fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">l2</span><span class="main">)</span> <span class="free">start</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">start</span></span>  <span class="quoted"><span class="free">l2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fold_Option_bind_eq_Some_start_not_None' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Preliminaries-fold_Option_bind_eq_Some_at_each_point_Some"><span class="command">lemma</span></span> fold_Option_bind_eq_Some_at_each_point_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">l2</span><span class="main">)</span> <span class="free">start</span> <span class="main">=</span> Some <span class="free">res</span>
  <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">point</span> <span class="main">.</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">l1</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">point</span>
    <span class="main">∧</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">l2</span> <span class="main">(</span>Some <span class="bound">point</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">res</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">l2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> fold_Option_bind_eq_Some_start_not_None' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Preliminaries-fold_Option_bind_eq_Some_at_each_point_Some'"><span class="command">lemma</span></span> fold_Option_bind_eq_Some_at_each_point_Some'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="free">start</span> <span class="main">=</span> Some <span class="free">res</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">point</span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">start</span> <span class="main">=</span> Some <span class="free">point</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span> <span class="main">(</span>Some <span class="free">point</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fold_Option_bind_eq_Some_at_each_point_Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="comment1">(* Legacy *)</span>
<span class="keyword1"><span class="command">corollary</span></span> fold_Option_bind_eq_Some_at_point_not_None'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">l2</span><span class="main">)</span> <span class="free">start</span> <span class="main">=</span> Some <span class="free">res</span>
  <span class="main">⟹</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="bound">option</span> <span class="main">.</span> Option.bind <span class="bound">option</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">l1</span><span class="main">)</span> <span class="free">start</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fold_Option_bind_eq_Some_at_each_point_Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="comment1">(* Interestingly no longer need helper... *)</span>
<span class="keyword1" id="Preliminaries-fold_matches_first_step_not_None"><span class="command">lemma</span></span> fold_matches_first_step_not_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="bound">subs</span> <span class="main">.</span> Option.bind <span class="bound">subs</span> <span class="main">(</span><span class="free">f</span> <span class="bound">T</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">subs</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">point</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">point</span>"</span></span>
    <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="bound">subs</span> <span class="main">.</span> Option.bind <span class="bound">subs</span> <span class="main">(</span><span class="free">f</span> <span class="bound">T</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">point</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fold_Option_bind_eq_Some_start_not_None' not_None_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Preliminaries-fold_matches_last_step_not_None"><span class="command">lemma</span></span> fold_matches_last_step_not_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="bound">subs</span> <span class="main">.</span> Option.bind <span class="bound">subs</span> <span class="main">(</span><span class="free">f</span> <span class="bound">T</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">subs</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">point</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="bound">subs</span> <span class="main">.</span> Option.bind <span class="bound">subs</span> <span class="main">(</span><span class="free">f</span> <span class="bound">T</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">subs</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">point</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="free">point</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fold_Option_bind_eq_Some_at_each_point_Some'<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"zip <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">]</span>"</span></span> 
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> start<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Some <span class="free">subs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> res<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">subs'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">f</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Term">
<div class="head">
<h1>Theory Term</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Terms"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  Originally based on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> "~~/src/Pure/term.ML"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  Diverged substantially, but some influences are still visible.
  Further influences from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">dir</span></span> "~~/src/HOL/Proofs/Lambda/"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Term
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a> <a href="#Core">Core</a> <a href="#Preliminaries">Preliminaries</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Collecting parts of typs/terms and more substitutions›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tvsT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"typ <span class="main">⇒</span> <span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">tvsT</span> <span class="main">(</span>Tv <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tvsT</span> <span class="main">(</span>Ty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map <span class="free">tvsT</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tvs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> <span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tvs</span> <span class="main">(</span>Ct <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> tvsT <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tvs</span> <span class="main">(</span>Fv <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> tvsT <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tvs</span> <span class="main">(</span>Bv <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tvs</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> tvsT <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∪</span> <span class="free">tvs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tvs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">tvs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∪</span> <span class="free">tvs</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">tvs_set</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">.</span> tvs <span class="bound">t</span>"</span></span>

<span class="keyword1" id="Term-tvsT_tsubstT"><span class="command">lemma</span></span> tvsT_tsubstT<span class="main">:</span> <span class="quoted"><span class="quoted">"tvsT <span class="main">(</span>tsubstT <span class="free">σ</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span>tvsT <span class="main">(</span><span class="free">ρ</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> tvsT <span class="free">σ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span> 

<span class="keyword1" id="Term-tsubstT_cong"><span class="command">lemma</span></span> tsubstT_cong<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> tvsT <span class="free">σ</span><span class="main">.</span> <span class="free">ρ1</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">ρ2</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span> tsubstT <span class="free">σ</span> <span class="free">ρ1</span> <span class="main">=</span> tsubstT <span class="free">σ</span> <span class="free">ρ2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span> 

<span class="keyword1" id="Term-tsubstT_ith"><span class="command">lemma</span></span> tsubstT_ith<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">Ts</span> <span class="main">⟹</span>  map <span class="main">(</span><span class="main">λ</span><span class="bound">T</span> <span class="main">.</span> tsubstT <span class="bound">T</span> <span class="free">ρ</span><span class="main">)</span> <span class="free">Ts</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> tsubstT <span class="main">(</span><span class="free">Ts</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">ρ</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-tsubstT_fun_typ_dist"><span class="command">lemma</span></span> tsubstT_fun_typ_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"tsubstT <span class="main">(</span><span class="free">T</span> <span class="main">→</span> <span class="free">T1</span><span class="main">)</span> <span class="free">ρ</span> <span class="main">=</span> tsubstT <span class="free">T</span> <span class="free">ρ</span> <span class="main">→</span> tsubstT <span class="free">T1</span> <span class="free">ρ</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> <span class="main">(</span>variable <span class="main">⇒</span> typ <span class="main">⇒</span> term<span class="main">)</span> <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> Ct <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">$</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tinst</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">ρ</span><span class="main">.</span> tsubst <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="bound">ρ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inst</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">ρ</span><span class="main">.</span> subst <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="bound">ρ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">SortsT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"typ <span class="main">⇒</span> sort set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SortsT</span> <span class="main">(</span>Tv <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SortsT</span> <span class="main">(</span>Ty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">T</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">.</span> <span class="free">SortsT</span> <span class="bound">T</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Sorts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> sort set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Sorts</span> <span class="main">(</span>Ct <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> SortsT <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Sorts</span> <span class="main">(</span>Fv <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> SortsT <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Sorts</span> <span class="main">(</span>Bv <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Sorts</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> SortsT <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∪</span> <span class="free">Sorts</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Sorts</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Sorts</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∪</span> <span class="free">Sorts</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Types</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> typ set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Types</span> <span class="main">(</span>Ct <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Types</span> <span class="main">(</span>Fv <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Types</span> <span class="main">(</span>Bv <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Types</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span>  insert <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free">Types</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Types</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Types</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∪</span> <span class="free">Types</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">tvs_Set</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">s</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">.</span> tvs <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">tvsT_Set</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">s</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">.</span> tvsT <span class="bound">s</span>"</span></span>

<span class="comment1">(* All those sets are finite *)</span>
<span class="keyword1" id="Term-finite_SortsT"><span class="command">lemma</span></span> finite_SortsT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>SortsT <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-finite_Sorts"><span class="command">lemma</span></span> finite_Sorts<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Sorts <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-finite_Types"><span class="command">lemma</span></span> finite_Types<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Types <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-finite_tvsT"><span class="command">lemma</span></span> finite_tvsT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>tvsT <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-no_tvsT_imp_tsubsT_unchanged"><span class="command">lemma</span></span> no_tvsT_imp_tsubsT_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"tvsT <span class="free">T</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> tsubstT <span class="free">T</span> <span class="free">ρ</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_idI<span class="main">)</span>
<span class="keyword1" id="Term-finite_fv"><span class="command">lemma</span></span> finite_fv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fv <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-finite_tvs"><span class="command">lemma</span></span> finite_tvs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>tvs <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-finite_FV"><span class="command">lemma</span></span> finite_FV<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> finite <span class="main">(</span>FV <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-finite_tvs_Set"><span class="command">lemma</span></span> finite_tvs_Set<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> finite <span class="main">(</span>tvs_Set <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-finite_tvsT_Set"><span class="command">lemma</span></span> finite_tvsT_Set<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> finite <span class="main">(</span>tvsT_Set <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-no_tvs_imp_tsubst_unchanged"><span class="command">lemma</span></span> no_tvs_imp_tsubst_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"tvs <span class="free">t</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> tsubst <span class="free">t</span> <span class="free">ρ</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_idI no_tvsT_imp_tsubsT_unchanged<span class="main">)</span> 
<span class="keyword1" id="Term-no_fv_imp_subst_unchanged"><span class="command">lemma</span></span> no_fv_imp_subst_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="free">t</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> subst <span class="free">t</span> <span class="free">ρ</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_idI<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Functional(also executable) version of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">has_typ</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">typ_of1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"typ list <span class="main">⇒</span> term <span class="main">⇒</span> typ option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">typ_of1</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span> Ct <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">typ_of1</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>nth <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">typ_of1</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Fv <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">typ_of1</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span> <span class="main">=</span> Option.bind <span class="main">(</span><span class="free">typ_of1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">typ_of1</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> Option.bind <span class="main">(</span><span class="free">typ_of1</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">U</span><span class="main">.</span> Option.bind <span class="main">(</span><span class="free">typ_of1</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> 
    <span class="keyword1">case</span> <span class="bound">T</span> <span class="keyword1">of</span>
          Ty <span class="bound">fun</span> <span class="main">[</span><span class="bound">T1</span><span class="main">,</span><span class="bound">T2</span><span class="main">]</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">fun</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> <span class="keyword1">then</span>
            <span class="keyword1">if</span> <span class="bound">T1</span><span class="main">=</span><span class="bound">U</span> <span class="keyword1">then</span> Some <span class="bound">T2</span> <span class="keyword1">else</span> None
            <span class="keyword1">else</span> None
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None
    <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For historic reasons a lot of proofs/definitions are still in terms of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">typ_of1</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> instead of
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">has_typ1</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Term-has_typ1_weaken_Ts"><span class="command">lemma</span></span> has_typ1_weaken_Ts<span class="main">:</span> <span class="quoted"><span class="quoted">"has_typ1 <span class="free">Ts</span> <span class="free">t</span> <span class="free">rT</span> <span class="main">⟹</span> has_typ1 <span class="main">(</span><span class="free">Ts</span><span class="main">@</span><span class="main">[</span><span class="free">T</span><span class="main">]</span><span class="main">)</span> <span class="free">t</span> <span class="free">rT</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_typ1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"has_typ1 <span class="main">(</span><span class="skolem">Ts</span> <span class="main">@</span> <span class="main">[</span><span class="free">T</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Bv <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">Ts</span><span class="main">@</span><span class="main">[</span><span class="free">T</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> has_typ1.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2.hyps"</span> nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> has_typ1.intros<span class="main">)</span> <span class="keyword1"><span class="command">thm</span></span> less_Suc_eq nth_butlast

<span class="keyword1" id="Term-has_typ1_imp_typ_of1"><span class="command">lemma</span></span> has_typ1_imp_typ_of1<span class="main">:</span> <span class="quoted"><span class="quoted">"has_typ1 <span class="free">Ts</span> <span class="free">t</span> <span class="free">ty</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_typ1.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-typ_of1_imp_has_typ1"><span class="command">lemma</span></span> typ_of1_imp_has_typ1<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span> <span class="main">⟹</span> has_typ1 <span class="free">Ts</span> <span class="free">t</span> <span class="free">ty</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">ty</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>  
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="skolem">Ts</span> <span class="skolem">u</span> <span class="main">=</span> Some <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> this App <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="skolem">Ts</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> U T App <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> Ty <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> <span class="main">[</span><span class="skolem">U</span><span class="main">,</span> <span class="skolem">T2</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_typ1.intros 
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits typ.splits list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this U T <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> App <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_typ1.intros<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_typ1.intros <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> has_typ1_iff_typ_of1<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_typ1 <span class="free">Ts</span> <span class="free">t</span> <span class="free">ty</span> <span class="main">⟷</span> typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> has_typ1_imp_typ_of1 typ_of1_imp_has_typ1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">corollary</span></span> has_typ_iff_typ_of<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_typ <span class="free">t</span> <span class="free">ty</span> <span class="main">⟷</span> typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_typ_def typ_of_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> typ_of_imp_has_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span> <span class="main">⟹</span> has_typ <span class="free">t</span> <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-typ_of1_weaken_Ts"><span class="command">lemma</span></span> typ_of1_weaken_Ts<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span> <span class="main">⟹</span> typ_of1 <span class="main">(</span><span class="free">Ts</span><span class="main">@</span><span class="main">[</span><span class="free">T</span><span class="main">]</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> has_typ1_weaken_Ts <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-typ_of1_weaken"><span class="command">lemma</span></span> typ_of1_weaken<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="free">Ts</span><span class="main">@</span><span class="free">Ts'</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Ts'</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typ_of1.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append bind_eq_Some_conv<span class="main">)</span>

<span class="comment1">(* Instantiation of type variables produces instantiated types *)</span>
<span class="keyword1" id="Term-has_typ1_tsubst"><span class="command">lemma</span></span> has_typ1_tsubst<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"has_typ1 <span class="free">Ts</span> <span class="free">t</span> <span class="free">T</span> <span class="main">⟹</span> has_typ1 <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> tsubstT <span class="bound">T</span> <span class="free">ρ</span><span class="main">)</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">(</span>tsubst <span class="free">t</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>tsubstT <span class="free">T</span> <span class="free">ρ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_typ1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="comment1">(* tsubst_ith must be applied reversed, in this direction it can cause simplifier to loop *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> tsubstT_ith <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> has_typ1.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_map tsubst.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tsubstT_fun_typ_dist <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> has_typ1.intros<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> has_typ1_unique<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_typ1 <span class="free">τs</span> <span class="free">t</span> <span class="free">τ1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"has_typ1 <span class="free">τs</span> <span class="free">t</span> <span class="free">τ2</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ1</span> <span class="main">=</span> <span class="free">τ2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> has_typ1_imp_typ_of1 option.inject<span class="main">)</span>

<span class="keyword1"><span class="command">hide_fact</span></span> typ_of_def

<span class="keyword1" id="Term-typ_of_def"><span class="command">lemma</span></span> typ_of_def<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">≡</span> typ_of1 <span class="main">[]</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> has_typ1_iff_typ_of1 has_typ_def has_typ_iff_typ_of not_None_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Loose bound variables›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">loose_bvar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">loose_bvar</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">loose_bvar</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⟷</span> <span class="free">loose_bvar</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∨</span> <span class="free">loose_bvar</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">loose_bvar</span> <span class="main">(</span>Abs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">loose_bvar</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">loose_bvar</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">loose_bvar1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">loose_bvar1</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">loose_bvar1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⟷</span> <span class="free">loose_bvar1</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∨</span> <span class="free">loose_bvar1</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">loose_bvar1</span> <span class="main">(</span>Abs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">loose_bvar1</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">loose_bvar1</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>


<span class="keyword1" id="Term-loose_bvar1_imp_loose_bvar"><span class="command">lemma</span></span> loose_bvar1_imp_loose_bvar<span class="main">:</span> <span class="quoted"><span class="quoted">"loose_bvar1 <span class="free">t</span> <span class="free">n</span> <span class="main">⟹</span> loose_bvar <span class="free">t</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-not_loose_bvar_imp_not_loose_bvar1"><span class="command">lemma</span></span> not_loose_bvar_imp_not_loose_bvar1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-loose_bvar_iff_exist_loose_bvar1"><span class="command">lemma</span></span> loose_bvar_iff_exist_loose_bvar1<span class="main">:</span> <span class="quoted"><span class="quoted">"loose_bvar <span class="free">t</span> <span class="free">lev</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">lev'</span></span><span class="main">≥</span><span class="free">lev</span><span class="main">.</span> loose_bvar1 <span class="free">t</span> <span class="bound">lev'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Suc_le_D<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_open</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> loose_bvar <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_closed</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">¬</span> is_open <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_dependent</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> loose_bvar1 <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="Term-loose_bvar_Suc"><span class="command">lemma</span></span> loose_bvar_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"loose_bvar <span class="free">t</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span> loose_bvar <span class="free">t</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-loose_bvar_leq"><span class="command">lemma</span></span> loose_bvar_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">≥</span><span class="free">p</span> <span class="main">⟹</span> loose_bvar <span class="free">t</span> <span class="free">k</span> <span class="main">⟹</span> loose_bvar <span class="free">t</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inc_induct<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> loose_bvar_Suc <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Term-has_typ1_imp_no_loose_bvar"><span class="command">lemma</span></span> has_typ1_imp_no_loose_bvar<span class="main">:</span> <span class="quoted"><span class="quoted">"has_typ1 <span class="free">Ts</span> <span class="free">t</span> <span class="free">ty</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="main">(</span>length <span class="free">Ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_typ1.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> has_typ_imp_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"has_typ <span class="free">t</span> <span class="free">ty</span> <span class="main">⟹</span> <span class="main">¬</span> is_open <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_open_def has_typ_def <span class="keyword1"><span class="command">using</span></span> has_typ1_imp_no_loose_bvar <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> typ_of_imp_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span> <span class="main">⟹</span> <span class="main">¬</span> is_open <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_typ_imp_closed<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Subterms›</span></span>

<span class="comment1">(* probably ugly for proofs... *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exists_subterm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exists_subterm</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">t</span> <span class="main">$</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">exists_subterm</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">t</span> <span class="main">∨</span> <span class="free">exists_subterm</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">u</span>
    <span class="main">|</span> Abs <span class="bound">ty</span> <span class="bound">body</span> <span class="main">⇒</span> <span class="free">exists_subterm</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">body</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
<span class="comment1">(* Is this better? *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exists_subterm'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exists_subterm'</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="free">exists_subterm'</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∨</span> <span class="free">exists_subterm'</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exists_subterm'</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="free">exists_subterm'</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exists_subterm'</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span>  <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Term-exists_subterm_iff_exists_subterm'"><span class="command">lemma</span></span> exists_subterm_iff_exists_subterm'<span class="main">:</span> <span class="quoted"><span class="quoted">"exists_subterm <span class="free">P</span> <span class="free">t</span> <span class="main">⟷</span> exists_subterm' <span class="free">P</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"exists_subterm <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span><span class="main">=</span>Fv <span class="free">idx</span> <span class="free">T</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">idx</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">∈</span> fv <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* Fairly old, however still needed for some proofs about "subterms" *)</span>
<span class="comment1">(* Must have no loose bounds in t, from Logic.ML*)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">occs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> exists_subterm <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1" id="Term-occs_Fv_eq_elem_fv"><span class="command">lemma</span></span> occs_Fv_eq_elem_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"occs <span class="main">(</span>Fv <span class="free">v</span> <span class="free">S</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> fv <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-bind_fv2_unchanged"><span class="command">lemma</span></span> bind_fv2_unchanged<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>loose_bvar <span class="free">tm</span> <span class="free">lev</span> <span class="main">⟹</span> bind_fv2 <span class="free">v</span> <span class="free">lev</span> <span class="free">tm</span> <span class="main">=</span> <span class="free">tm</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∉</span> fv <span class="free">tm</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">tm</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bind_fv2.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-bind_fv2_unchanged'"><span class="command">lemma</span></span> bind_fv2_unchanged'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>loose_bvar <span class="free">tm</span> <span class="free">lev</span> <span class="main">⟹</span> bind_fv2 <span class="free">v</span> <span class="free">lev</span> <span class="free">tm</span> <span class="main">=</span> <span class="free">tm</span> <span class="main">⟹</span> <span class="main">¬</span> occs <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span> <span class="free">tm</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">tm</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bind_fv2.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-bind_fv2_changed"><span class="command">lemma</span></span> bind_fv2_changed<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"bind_fv2 <span class="free">v</span> <span class="free">lev</span> <span class="free">tm</span> <span class="main">≠</span> <span class="free">tm</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> fv <span class="free">tm</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">tm</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bind_fv2.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1" id="Term-bind_fv2_changed'"><span class="command">lemma</span></span> bind_fv2_changed'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"bind_fv2 <span class="free">v</span> <span class="free">lev</span> <span class="free">tm</span> <span class="main">≠</span> <span class="free">tm</span> <span class="main">⟹</span> occs <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span> <span class="free">tm</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">tm</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bind_fv2.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> bind_fv_changed<span class="main">:</span> <span class="quoted"><span class="quoted">"bind_fv <span class="free">v</span> <span class="free">tm</span> <span class="main">≠</span> <span class="free">tm</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> fv <span class="free">tm</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_open_def bind_fv_def <span class="keyword1"><span class="command">using</span></span> bind_fv2_changed <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">corollary</span></span> bind_fv_changed'<span class="main">:</span> <span class="quoted"><span class="quoted">"bind_fv <span class="free">v</span> <span class="free">tm</span> <span class="main">≠</span> <span class="free">tm</span> <span class="main">⟹</span> occs <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span> <span class="free">tm</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_open_def bind_fv_def <span class="keyword1"><span class="command">using</span></span> bind_fv2_changed' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> bind_fv_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="free">t</span> <span class="main">⟹</span> bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bind_fv_changed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> has_typ1_app_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"has_typ1 <span class="free">Ts</span> <span class="main">(</span><span class="free">t</span> <span class="main">$</span> <span class="free">u</span><span class="main">)</span> <span class="free">R</span>"</span></span>
<span class="keyword1" id="Term-has_typ1_arg_typ"><span class="command">lemma</span></span> has_typ1_arg_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"has_typ1 <span class="free">Ts</span> <span class="main">(</span><span class="free">t</span> <span class="main">$</span> <span class="free">u</span><span class="main">)</span> <span class="free">R</span> <span class="main">⟹</span> has_typ1 <span class="free">Ts</span> <span class="free">u</span> <span class="free">U</span> <span class="main">⟹</span> has_typ1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">(</span><span class="free">U</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> has_typ1_app_elim
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> has_typ1_imp_typ_of1 option.inject typ_of1_imp_has_typ1<span class="main">)</span>
 
<span class="keyword1" id="Term-has_typ1_fun_typ"><span class="command">lemma</span></span> has_typ1_fun_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"has_typ1 <span class="free">Ts</span> <span class="main">(</span><span class="free">t</span> <span class="main">$</span> <span class="free">u</span><span class="main">)</span> <span class="free">R</span> <span class="main">⟹</span> has_typ1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">(</span><span class="free">U</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> has_typ1 <span class="free">Ts</span> <span class="free">u</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_typ1_app_elim<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="quoted">"has_typ1 <span class="free">Ts</span> <span class="free">u</span> <span class="free">U</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> has_typ1_unique <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Term-typ_of1_arg_typ"><span class="command">lemma</span></span> typ_of1_arg_typ<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="main">(</span><span class="free">t</span> <span class="main">$</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">R</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">U</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">U</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> has_typ1_iff_typ_of1 has_typ1_arg_typ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> typ_of_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span><span class="free">t</span><span class="main">$</span><span class="free">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">R</span> <span class="main">⟹</span> typ_of <span class="free">u</span> <span class="main">=</span> Some <span class="free">T</span> <span class="main">⟹</span> typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">T</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> typ_of1_arg_typ typ_of_def<span class="main">)</span>

<span class="keyword1" id="Term-typ_of1_fun_typ"><span class="command">lemma</span></span> typ_of1_fun_typ<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="main">(</span><span class="free">t</span> <span class="main">$</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">R</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">U</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> has_typ1_iff_typ_of1 has_typ1_fun_typ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> typ_of_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span><span class="free">t</span><span class="main">$</span><span class="free">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">R</span> <span class="main">⟹</span> typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">U</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> typ_of <span class="free">u</span> <span class="main">=</span> Some <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> typ_of1_fun_typ typ_of_def<span class="main">)</span>

<span class="keyword1" id="Term-typ_of_eta_expand"><span class="command">lemma</span></span> typ_of_eta_expand<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">⟹</span> typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typ_of1_weaken <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv typ_of_def<span class="main">)</span>

<span class="keyword1" id="Term-bind_fv2_preserves_type"><span class="command">lemma</span></span> bind_fv2_preserves_type<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="free">Ts</span><span class="main">@</span><span class="main">[</span><span class="free">T</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span>length <span class="free">Ts</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Ts</span>"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">ty</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bind_fv2.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv nth_append <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Term-typ_of_Abs_bind_fv"><span class="command">lemma</span></span> typ_of_Abs_bind_fv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">A</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="free">bT</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">bT</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">bT</span> <span class="main">→</span> <span class="free">ty</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bind_fv2_preserves_type bind_fv_def assms typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> typ_of_Abs_fv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">A</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs_fv <span class="free">v</span> <span class="free">bT</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">bT</span> <span class="main">→</span> <span class="free">ty</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms typ_of_Abs_bind_fv typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-typ_of_mk_all"><span class="command">lemma</span></span> typ_of_mk_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">A</span> <span class="main">=</span> Some propT"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>mk_all <span class="free">x</span> <span class="free">ty</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typ_of_Abs_bind_fv<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ty</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typ_of_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">incr_bv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">incr_bv</span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> Bv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">inc</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">incr_bv</span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span> <span class="main">=</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free">incr_bv</span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">incr_bv</span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> App <span class="main">(</span><span class="free">incr_bv</span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">incr_bv</span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">incr_bv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span>   <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="comment1">(* Bridging *)</span>
<span class="keyword1" id="Term-lift_def"><span class="command">lemma</span></span> lift_def<span class="main">:</span> <span class="quoted"><span class="quoted">"lift <span class="free">t</span> <span class="free">n</span> <span class="main">=</span> incr_bv <span class="main">1</span> <span class="free">n</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lift.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> lift.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> lift_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">incr_boundvars</span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> incr_bv <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">decr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="keyword1">then</span> Bv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free">decr</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Term-incr_bv_0"><span class="command">lemma</span></span> incr_bv_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"incr_bv <span class="main">0</span> <span class="free">lev</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-loose_bvar_incr_bvar"><span class="command">lemma</span></span> loose_bvar_incr_bvar<span class="main">:</span> <span class="quoted"><span class="quoted">"loose_bvar <span class="free">t</span> <span class="free">lev</span> <span class="main">⟷</span> loose_bvar <span class="main">(</span>incr_bv <span class="free">inc</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">lev</span><span class="main">+</span><span class="free">inc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">inc</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Term-no_loose_bvar_no_incr"><span class="command">lemma</span></span> no_loose_bvar_no_incr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="free">lev</span> <span class="main">⟹</span> incr_bv <span class="free">inc</span> <span class="free">lev</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">inc</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-is_close_no_incr_boundvars"><span class="command">lemma</span></span> is_close_no_incr_boundvars<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">t</span> <span class="main">⟹</span> incr_boundvars <span class="free">inc</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> no_loose_bvar_no_incr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incr_boundvars_def is_open_def<span class="main">)</span>

<span class="keyword1" id="Term-fv_incr_bv"><span class="command">lemma</span></span> fv_incr_bv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>incr_bv <span class="free">inc</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">inc</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> incr_bv.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-fv_incr_boundvars"><span class="command">lemma</span></span> fv_incr_boundvars <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>incr_boundvars <span class="free">inc</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incr_boundvars_def<span class="main">)</span>

<span class="keyword1" id="Term-loose_bvar_decr"><span class="command">lemma</span></span> loose_bvar_decr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="free">k</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar <span class="main">(</span>decr <span class="free">k</span> <span class="free">t</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loose_bvar.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-loose_bvar_decr_unchanged"><span class="command">lemma</span></span> loose_bvar_decr_unchanged<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="free">k</span> <span class="main">⟹</span> decr <span class="free">k</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loose_bvar.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-is_closed_decr_unchanged"><span class="command">lemma</span></span> is_closed_decr_unchanged<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">t</span> <span class="main">⟹</span> decr <span class="main">0</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst_bv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> nat <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_bv1</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="keyword1">then</span> Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>incr_boundvars <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span>Bv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_bv1</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free">subst_bv1</span> <span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_bv1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free">subst_bv1</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">$</span> <span class="free">subst_bv1</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_bv1</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Term-incr_bv_combine"><span class="command">lemma</span></span> incr_bv_combine<span class="main">:</span> <span class="quoted"><span class="quoted">"incr_bv <span class="free">m</span> <span class="free">k</span> <span class="main">(</span>incr_bv <span class="free">n</span> <span class="free">k</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> incr_bv <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="free">k</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-substn_subst_n"><span class="command">lemma</span></span> substn_subst_n <span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bv1 <span class="free">t</span> <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> subst_bv2 <span class="free">t</span> <span class="free">n</span> <span class="main">(</span>incr_bv <span class="free">n</span> <span class="main">0</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incr_boundvars_def incr_bv_combine<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> substn_subst_0<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bv1 <span class="free">t</span> <span class="main">0</span> <span class="free">s</span> <span class="main">=</span> subst_bv2 <span class="free">t</span> <span class="main">0</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substn_subst_n<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> substn_subst_0'<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bv <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> subst_bv2 <span class="free">t</span> <span class="main">0</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subst_bv_def substn_subst_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-subst_bv2_eq"><span class="command">lemma</span></span> subst_bv2_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bv2 <span class="main">(</span>Bv <span class="free">k</span><span class="main">)</span> <span class="free">k</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>

<span class="keyword1" id="Term-subst_bv2_gt"><span class="command">lemma</span></span> subst_bv2_gt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> subst_bv2 <span class="main">(</span>Bv <span class="free">j</span><span class="main">)</span> <span class="free">i</span> <span class="free">u</span> <span class="main">=</span> Bv <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>

<span class="keyword1" id="Term-subst_bv2_subst_lt"><span class="command">lemma</span></span> subst_bv2_subst_lt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> subst_bv2 <span class="main">(</span>Bv <span class="free">j</span><span class="main">)</span> <span class="free">i</span> <span class="free">u</span> <span class="main">=</span> Bv <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>

<span class="keyword1" id="Term-lift_lift"><span class="command">lemma</span></span> lift_lift<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> lift <span class="main">(</span>lift <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> lift <span class="main">(</span>lift <span class="free">t</span> <span class="free">k</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-lift_subst"><span class="command">lemma</span></span> lift_subst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> lift <span class="main">(</span>subst_bv2 <span class="free">t</span> <span class="free">j</span> <span class="free">s</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> subst_bv2 <span class="main">(</span>lift <span class="free">t</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="main">(</span>lift <span class="free">s</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_Suc lift_lift <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span> 
      <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 lift_def lift_lift zero_less_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_Suc lift_lift <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span> 

<span class="keyword1" id="Term-lift_subst_bv2_subst_lt"><span class="command">lemma</span></span> lift_subst_bv2_subst_lt<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> lift <span class="main">(</span>subst_bv2 <span class="free">t</span> <span class="free">j</span> <span class="free">s</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> subst_bv2 <span class="main">(</span>lift <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>lift <span class="free">s</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">x1</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lift_lift <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_lift<span class="main">)</span>

<span class="keyword1" id="Term-subst_bv2_lift"><span class="command">lemma</span></span> subst_bv2_lift <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"subst_bv2 <span class="main">(</span>lift <span class="free">t</span> <span class="free">k</span><span class="main">)</span> <span class="free">k</span> <span class="free">s</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Term-subst_bv2_subst_bv2"><span class="command">lemma</span></span> subst_bv2_subst_bv2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> subst_bv2 <span class="main">(</span>subst_bv2 <span class="free">t</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">(</span>lift <span class="free">v</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span>subst_bv2 <span class="free">u</span> <span class="free">j</span> <span class="free">v</span><span class="main">)</span> 
    <span class="main">=</span> subst_bv2 <span class="main">(</span>subst_bv2 <span class="free">t</span> <span class="free">i</span> <span class="free">u</span><span class="main">)</span> <span class="free">j</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">s</span> <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Suc_mono add.commute lift_lift lift_subst_bv2_subst_lt plus_1_eq_Suc subst_bv2.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_less_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> subst_bv2_lift <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> diff_Suc lift_lift <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> lift_subst_bv2_subst_lt <span class="quasi_keyword">split</span><span class="main">:</span> nat.split›</span><span class="main">)</span>

<span class="comment1">(* Bridging *)</span>
<span class="keyword1"><span class="command">hide_fact</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> subst_bv_def
<span class="keyword1" id="Term-subst_bv_def"><span class="command">lemma</span></span> subst_bv_def<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bv <span class="free">u</span> <span class="free">t</span> <span class="main">≡</span> subst_bv1 <span class="free">t</span> <span class="main">0</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substn_subst_0' substn_subst_n<span class="main">)</span>

<span class="comment1">(* Probably not necessary *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst_bvs1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> nat <span class="main">⇒</span> term list <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_bvs1</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> 
    <span class="keyword1">then</span> Bv <span class="free"><span class="bound"><span class="entity">n</span></span></span> 
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">args</span></span></span> 
      <span class="keyword1">then</span> incr_boundvars <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">(</span>nth <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">lev</span></span></span><span class="main">)</span><span class="main">)</span> 
      <span class="keyword1">else</span> Bv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> length <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_bvs1</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free">subst_bvs1</span> <span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lev</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_bvs1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> <span class="free">subst_bvs1</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">$</span> <span class="free">subst_bvs1</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_bvs1</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst_bvs</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> subst_bvs1 <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span>"</span></span>

<span class="keyword1" id="Term-subst_bvs_App"><span class="command">lemma</span></span> subst_bvs_App<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bvs <span class="free">args</span> <span class="main">(</span><span class="free">s</span><span class="main">$</span><span class="free">t</span><span class="main">)</span> <span class="main">=</span> subst_bvs <span class="free">args</span> <span class="free">s</span> <span class="main">$</span> subst_bvs <span class="free">args</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_bvs_def<span class="main">)</span>

<span class="keyword1" id="Term-subst_bv1_special_case_subst_bvs1"><span class="command">lemma</span></span> subst_bv1_special_case_subst_bvs1<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bvs1 <span class="free">t</span> <span class="free">lev</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> subst_bv1 <span class="free">t</span> <span class="free">lev</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bvs1.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-no_loose_bvar_imp_no_subst_bv1"><span class="command">lemma</span></span> no_loose_bvar_imp_no_subst_bv1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>loose_bvar <span class="free">t</span> <span class="free">lev</span> <span class="main">⟹</span> subst_bv1 <span class="free">t</span> <span class="free">lev</span> <span class="free">u</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-no_loose_bvar_imp_no_subst_bvs1"><span class="command">lemma</span></span> no_loose_bvar_imp_no_subst_bvs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>loose_bvar <span class="free">t</span> <span class="free">lev</span> <span class="main">⟹</span> subst_bvs1 <span class="free">t</span> <span class="free">lev</span> <span class="free">us</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* The precondition in the following lemmas makes them fairly useless *)</span>
<span class="keyword1" id="Term-subst_bvs1_step"><span class="command">lemma</span></span> subst_bvs1_step<span class="main">:</span>             
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="free">lev</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_bvs1 <span class="free">t</span> <span class="free">lev</span> <span class="main">(</span><span class="free">args</span><span class="main">@</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> subst_bv1 <span class="main">(</span>subst_bvs1 <span class="free">t</span> <span class="free">lev</span> <span class="free">args</span><span class="main">)</span> <span class="free">lev</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> closed_subst_bv_no_change<span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">t</span> <span class="main">⟹</span> subst_bv <span class="free">u</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_open_def subst_bv_def no_loose_bvar_imp_no_subst_bv1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-is_variable_imp_incr_bv_unchanged"><span class="command">lemma</span></span> is_variable_imp_incr_bv_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"incr_bv <span class="free">inc</span> <span class="free">lev</span> <span class="main">(</span>Fv <span class="free">v</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Fv <span class="free">v</span> <span class="free">T</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Term-is_variable_imp_incr_boundvars_unchganged"><span class="command">lemma</span></span> is_variable_imp_incr_boundvars_unchganged<span class="main">:</span> <span class="quoted"><span class="quoted">"incr_boundvars <span class="free">inc</span> <span class="main">(</span>Fv <span class="free">v</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Fv <span class="free">v</span> <span class="free">T</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> is_variable_imp_incr_bv_unchanged incr_boundvars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-loose_bvar_subst_bv1"><span class="command">lemma</span></span> loose_bvar_subst_bv1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="main">(</span>subst_bv1 <span class="free">t</span> <span class="free">lev</span> <span class="free">u</span><span class="main">)</span> <span class="free">lev</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="main">(</span>Suc <span class="free">lev</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bv1.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-is_closed_subst_bv"><span class="command">lemma</span></span> is_closed_subst_bv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="main">(</span>subst_bv <span class="free">u</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def loose_bvar_subst_bv1 subst_bv_def<span class="main">)</span>

<span class="keyword1" id="Term-subst_bv1_bind_fv2"><span class="command">lemma</span></span> subst_bv1_bind_fv2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="free">lev</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_bv1 <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="free">lev</span> <span class="main">(</span>Fv <span class="free">v</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> is_variable_imp_incr_boundvars_unchganged <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> subst_bv_bind_fv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_bv <span class="main">(</span>Fv <span class="free">v</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bind_fv_def subst_bv_def <span class="keyword1"><span class="command">using</span></span> assms subst_bv1_bind_fv2 is_open_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">betapply</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∙</span>"</span> 52<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">betapply</span> <span class="main">(</span>Abs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> subst_bv <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">betapply</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1" id="Term-betapply_Abs_fv"><span class="command">lemma</span></span> betapply_Abs_fv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"betapply <span class="main">(</span>Abs_fv <span class="free">v</span> <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>Fv <span class="free">v</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms subst_bv_bind_fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-typ_of1_imp_no_loose_bvar"><span class="command">lemma</span></span> typ_of1_imp_no_loose_bvar<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="main">(</span>length <span class="free">Ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_typ1_imp_no_loose_bvar<span class="main">)</span>

<span class="keyword1" id="Term-typ_of1_subst_bv"><span class="command">lemma</span></span> typ_of1_subst_bv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="free">Ts</span><span class="main">@</span><span class="main">[</span><span class="free">uty</span><span class="main">]</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">fty</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">u</span> <span class="main">=</span> Some <span class="free">uty</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="main">(</span>subst_bv1 <span class="free">f</span> <span class="main">(</span>length <span class="free">Ts</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">fty</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Ts</span>"</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">uty</span></span> <span class="quoted"><span class="free">fty</span></span> <span class="quoted"><span class="free">Ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bv1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">arg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> no_loose_bvar_no_incr typ_of1_imp_no_loose_bvar typ_of1_weaken
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv incr_boundvars_def nth_append typ_of_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">T</span> <span class="skolem">body</span> <span class="skolem">arg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv typ_of_def<span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> append_Cons bind_eq_Some_conv length_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>

<span class="keyword1" id="Term-typ_of1_split_App"><span class="command">lemma</span></span> typ_of1_split_App<span class="main">:</span>
  <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="main">(</span><span class="free">t</span> <span class="main">$</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">ty</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">uty</span> <span class="main">.</span> typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">uty</span> <span class="main">→</span> <span class="free">ty</span><span class="main">)</span> <span class="main">∧</span> typ_of1 <span class="free">Ts</span> <span class="free">u</span> <span class="main">=</span> Some <span class="bound">uty</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bind.bind_lzero the_default.elims typ_of1.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> typ_of1_arg_typ<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> typ_of1_split_App_obtains<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="main">(</span><span class="free">t</span> <span class="main">$</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">uty</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">uty</span> <span class="main">→</span> <span class="free">ty</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">uty</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typ_of1_split_App assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Term-typ_of1_incr_bv"><span class="command">lemma</span></span> typ_of1_incr_bv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">lev</span> <span class="main">≤</span> length <span class="free">Ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span>take <span class="free">lev</span> <span class="free">Ts</span> <span class="main">@</span> <span class="free">Ts'</span> <span class="main">@</span> drop <span class="free">lev</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">(</span>incr_bv <span class="main">(</span>length <span class="free">Ts'</span><span class="main">)</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ty</span></span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">Ts'</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span> 
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append bind_eq_Some_conv min_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">corollary</span></span> typ_of1_incr_bv_lev0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="free">Ts'</span> <span class="main">@</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">(</span>incr_bv <span class="main">(</span>length <span class="free">Ts'</span><span class="main">)</span> <span class="main">0</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms typ_of1_incr_bv<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> lev<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-typ_of1_subst_bv_gen"><span class="command">lemma</span></span> typ_of1_subst_bv_gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="free">Ts'</span><span class="main">@</span><span class="main">[</span><span class="free">uty</span><span class="main">]</span><span class="main">@</span><span class="free">Ts</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">tty</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">uty</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="free">Ts'</span> <span class="main">@</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">(</span>subst_bv1 <span class="free">t</span> <span class="main">(</span>length <span class="free">Ts'</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">tty</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Ts'</span>"</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">tty</span></span> <span class="quoted"><span class="free">uty</span></span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">Ts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bv1.induct<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">T</span> <span class="skolem">body</span> <span class="skolem">arg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> append_Cons length_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv nth_append incr_boundvars_def 
    typ_of1_incr_bv_lev0 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="comment1">(* This is the correct version, the other one inserts "at the wrong side of the bounds" *)</span>
<span class="keyword1" id="Term-typ_of1_subst_bv_gen_depre"><span class="command">lemma</span></span> typ_of1_subst_bv_gen_depre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="free">Ts'</span><span class="main">@</span><span class="free">Ts</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">fty</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="free">Ts</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">uty</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"last <span class="free">Ts'</span> <span class="main">=</span> <span class="free">uty</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ts'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span>butlast <span class="free">Ts'</span> <span class="main">@</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">(</span>subst_bv1 <span class="free">f</span> <span class="main">(</span>length <span class="free">Ts'</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">fty</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Ts'</span>"</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">fty</span></span> <span class="quoted"><span class="free">uty</span></span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">Ts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bv1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">arg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>LT<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="skolem">Ts'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="main">|</span> <span class="main">(</span>EQ<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="skolem">Ts'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="main">|</span> <span class="main">(</span>GT<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="skolem">Ts'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&gt;</span> <span class="skolem">i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> linorder_neqE_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.prems"</span> append_assoc append_butlast_last_id length_butlast typ_of1_subst_bv_gen<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">T</span> <span class="skolem">body</span> <span class="skolem">arg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc append_butlast_last_id length_butlast typ_of1_subst_bv_gen<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">t</span> <span class="skolem">arg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv nth_append incr_boundvars_def subst_bv_def 
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> typ_of1_subst_bv_gen'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="free">uty</span><span class="main">#</span><span class="free">Ts</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">tty</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">uty</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="main">(</span>subst_bv1 <span class="free">t</span> <span class="main">0</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">tty</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms typ_of1_subst_bv_gen
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.left_neutral append_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Term-typ_of_betapply"><span class="command">lemma</span></span> typ_of_betapply<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="main">(</span>Abs <span class="free">uty</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">uty</span> <span class="main">→</span> <span class="free">tty</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">uty</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="main">(</span><span class="main">(</span>Abs <span class="free">uty</span> <span class="free">t</span><span class="main">)</span> <span class="main">∙</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">tty</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms typ_of1_subst_bv_gen'
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv subst_bv_def<span class="main">)</span>

<span class="keyword1" id="Term-no_Bv_Type_param_irrelevant_typ_of"><span class="command">lemma</span></span> no_Bv_Type_param_irrelevant_typ_of<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>exists_subterm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Bv <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="free">t</span> 
  <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> typ_of1 <span class="free">Ts'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">Ts'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Term-typ_of1_drop_extra_bounds"><span class="command">lemma</span></span> typ_of1_drop_extra_bounds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>loose_bvar <span class="free">t</span> <span class="main">(</span>length <span class="free">Ts</span><span class="main">)</span> 
  <span class="main">⟹</span> typ_of1 <span class="main">(</span><span class="free">Ts</span><span class="main">@</span><span class="free">rest</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> typ_of1 <span class="free">Ts</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rest</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typ_of1.induct<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Term-typ_of_betaply"><span class="command">lemma</span></span> typ_of_betaply<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">uty</span> <span class="main">→</span> <span class="free">tty</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">u</span> <span class="main">=</span> Some <span class="free">uty</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span><span class="free">t</span> <span class="main">∙</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">tty</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_open <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_open_def <span class="keyword1"><span class="command">using</span></span> assms Abs typ_of1_subst_bv
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv subst_bv_def typ_of_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> typ_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">[</span><span class="free">uty</span><span class="main">]</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="free">tty</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>   
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv typ_of_def is_open_def Abs<span class="main">)</span>
      
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms False no_loose_bvar_imp_no_subst_bv1 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv typ_of_def is_open_def subst_bv_def Abs<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> no_Bv_Type_param_irrelevant_typ_of
      <span class="keyword1"><span class="command">using</span></span> typ_of1_drop_extra_bounds 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> self_append_conv2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main">:</span> typ_of_def›</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">beta_reducible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">beta_reducible</span> <span class="main">(</span>App <span class="main">(</span>Abs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">beta_reducible</span> <span class="main">(</span>Abs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">beta_reducible</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">beta_reducible</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">beta_reducible</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∨</span> <span class="free">beta_reducible</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">beta_reducible</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eta_reducible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eta_reducible</span> <span class="main">(</span>Abs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> is_dependent <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∨</span> <span class="free">eta_reducible</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eta_reducible</span> <span class="main">(</span>Abs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">eta_reducible</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eta_reducible</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">eta_reducible</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∨</span> <span class="free">eta_reducible</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eta_reducible</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="free">lev</span> <span class="main">⟹</span> decr <span class="free">lev</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-decr_incr_bv1"><span class="command">lemma</span></span> decr_incr_bv1<span class="main">:</span> <span class="quoted"><span class="quoted">"decr <span class="free">lev</span> <span class="main">(</span>incr_bv <span class="main">1</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* For termination proofs *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">depth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>Abs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">+</span><span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="Term-depth_decr"><span class="command">lemma</span></span> depth_decr<span class="main">:</span> <span class="quoted"><span class="quoted">"depth <span class="main">(</span>decr <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> depth <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> decr.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-loose_bvar1_decr"><span class="command">lemma</span></span> loose_bvar1_decr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lev</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="main">(</span>Suc <span class="free">lev</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="main">(</span>decr <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="free">lev</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> decr.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-loose_bvar1_decr'"><span class="command">lemma</span></span> loose_bvar1_decr'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="main">(</span>Suc <span class="free">lev</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="free">lev</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="main">(</span>decr <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="free">lev</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> decr.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-eta_reducible_Abs1"><span class="command">lemma</span></span> eta_reducible_Abs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eta_reducible <span class="main">(</span>Abs <span class="free">T</span> <span class="main">(</span><span class="free">t</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> eta_reducible <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-eta_reducible_Abs2"><span class="command">lemma</span></span> eta_reducible_Abs2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="free">t</span><span class="main">=</span><span class="bound">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eta_reducible <span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eta_reducible <span class="free">t</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">body</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms less_imp_Suc_add <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span> 
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term-eta_reducible_Abs"><span class="command">lemma</span></span> eta_reducible_Abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eta_reducible <span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> eta_reducible <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> eta_reducible_Abs1 eta_reducible_Abs2
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eta_reducible.simps<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> eta_reducible.simps<span class="main"><span class="main">(</span></span>14<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Term-loose_bvar1_decr''"><span class="command">lemma</span></span> loose_bvar1_decr''<span class="main">:</span> <span class="quoted"><span class="quoted">"loose_bvar1 <span class="free">t</span> <span class="free">lev</span> <span class="main">⟹</span> <span class="free">lev</span> <span class="main">&lt;</span> <span class="free">lev'</span><span class="main">⟹</span> loose_bvar1 <span class="main">(</span>decr <span class="free">lev'</span> <span class="free">t</span><span class="main">)</span> <span class="free">lev</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">lev'</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term-loose_bvar1_decr'''"><span class="command">lemma</span></span> loose_bvar1_decr'''<span class="main">:</span> <span class="quoted"><span class="quoted">"loose_bvar1 <span class="free">t</span> <span class="main">(</span>Suc <span class="free">lev</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">lev'</span> <span class="main">≤</span> <span class="free">lev</span> <span class="main">⟹</span> loose_bvar1 <span class="main">(</span>decr <span class="free">lev'</span> <span class="free">t</span><span class="main">)</span> <span class="free">lev</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">lev'</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-loose_bvar1_decr''''"><span class="command">lemma</span></span> loose_bvar1_decr''''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="free">lev'</span> <span class="main">⟹</span> <span class="free">lev'</span> <span class="main">≤</span> <span class="free">lev</span>  <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="main">(</span>Suc <span class="free">lev</span><span class="main">)</span> 
  <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="main">(</span>decr <span class="free">lev'</span> <span class="free">t</span><span class="main">)</span> <span class="free">lev</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> decr.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-not_eta_reducible_decr"><span class="command">lemma</span></span> not_eta_reducible_decr<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> eta_reducible <span class="free">t</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="free">lev</span> <span class="main">⟹</span> <span class="main">¬</span> eta_reducible <span class="main">(</span>decr <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> "</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> decr.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">lev</span> <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eta_reducible <span class="skolem">body</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eta_reducible_Abs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eta_reducible <span class="main">(</span>decr <span class="main">(</span><span class="skolem">lev</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">body</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.IH"</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">body</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> app <span class="main">=</span> this
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bv <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_dependent <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eta_reducible <span class="skolem">f</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0"</span> <span class="quoted">"2.prems"</span><span class="main">(</span>1<span class="main">)</span> App Bv eta_reducible.simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"loose_bvar1 <span class="skolem">f</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_dependent_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"loose_bvar1 <span class="main">(</span>decr <span class="main">(</span>Suc <span class="skolem">lev</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> loose_bvar1_decr'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 0 Bv App is_dependent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">nat</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> 2 App Bv 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eta_reducible.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc Bv App is_dependent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> App is_dependent_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> I <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main">:</span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> App is_dependent_def›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_dependent_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span> domintros<span class="main">)</span> <span class="entity">eta_norm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eta_norm</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">eta_norm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> 
    <span class="bound">f</span> <span class="main">$</span> Bv <span class="main">0</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> is_dependent <span class="bound">f</span> <span class="keyword1">then</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="bound">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span> decr <span class="main">0</span> <span class="main">(</span><span class="free">eta_norm</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">body</span> <span class="main">⇒</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="bound">body</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eta_norm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">eta_norm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free">eta_norm</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eta_norm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-eta_norm_reduces_depth"><span class="command">lemma</span></span> eta_norm_reduces_depth<span class="main">:</span> <span class="quoted"><span class="quoted">"eta_norm_dom <span class="free">t</span> <span class="main">⟹</span> depth <span class="main">(</span>eta_norm <span class="free">t</span><span class="main">)</span> <span class="main">&lt;=</span> depth <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eta_norm.pinduct<span class="main">)</span>
    <span class="main">(</span><span class="operator">use</span> depth_decr <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> eta_norm.psimps eta_norm.domintros is_dependent_def 
      <span class="quasi_keyword">split</span><span class="main">:</span> term.splits nat.splits›</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">eta_norm</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure depth"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">T</span> <span class="skolem">body</span> <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> asms<span class="main">:</span> <span class="quoted"><span class="quoted">"eta_norm <span class="skolem">body</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">$</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> Bv <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_dependent <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"eta_norm_dom <span class="skolem">body</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"depth <span class="skolem">t</span> <span class="main">&lt;</span> depth <span class="main">(</span><span class="skolem">t</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"depth <span class="main">(</span>eta_norm <span class="skolem">body</span><span class="main">)</span> <span class="main">≤</span> depth <span class="skolem">body</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asms eta_norm_reduces_depth <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> Abs <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span> <span class="main">∈</span> measure depth"</span></span> <span class="keyword1"><span class="command">using</span></span> asms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_norm.psimps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Term-loose_bvar1_eta_norm"><span class="command">lemma</span></span> loose_bvar1_eta_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"loose_bvar1 <span class="free">t</span> <span class="free">lev</span> <span class="main">⟹</span> loose_bvar1 <span class="main">(</span>eta_norm <span class="free">t</span><span class="main">)</span> <span class="free">lev</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eta_norm.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">use</span> loose_bvar1_decr''' <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main">:</span> term.splits nat.splits)<span class="keyword3">+</span>›</span><span class="main">)</span>

<span class="keyword1" id="Term-loose_bvar1_eta_norm'"><span class="command">lemma</span></span> loose_bvar1_eta_norm'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="free">lev</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="main">(</span>eta_norm <span class="free">t</span><span class="main">)</span> <span class="free">lev</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eta_norm.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar1 <span class="skolem">body</span> <span class="main">(</span>Suc <span class="skolem">lev</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar1 <span class="main">(</span>eta_norm <span class="skolem">body</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">lev</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">body</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">ty</span> <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> I loose_bvar1_decr''''
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits nat.splits if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1.IH"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_dependent_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 I loose_bvar1_decr''''
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits nat.splits if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_dependent_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits nat.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_dependent_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits nat.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_dependent_def<span class="main">)</span>

<span class="keyword1" id="Term-not_eta_reducible_eta_norm"><span class="command">lemma</span></span> not_eta_reducible_eta_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eta_reducible <span class="main">(</span>eta_norm <span class="free">t</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eta_norm.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eta_norm <span class="main">(</span><span class="skolem">body</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> Bv <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">note</span></span> u <span class="main">=</span> this
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_dependent <span class="skolem">f</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> 1 App u <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_dependent_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits nat.splits if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eta_reducible <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 App u <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eta_reducible <span class="main">(</span>eta_norm <span class="skolem">f</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1.IH"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> App False u<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar1 <span class="skolem">f</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False is_dependent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar1 <span class="main">(</span>eta_norm <span class="skolem">f</span><span class="main">)</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span>  loose_bvar1_eta_norm' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 App u False not_eta_reducible_decr loose_bvar1_eta_norm <span class="quoted"><span class="quoted">‹<span class="main">¬</span> loose_bvar1 <span class="main">(</span>eta_norm <span class="skolem">f</span><span class="main">)</span> <span class="main">0</span>›</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_dependent_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits nat.splits if_splits<span class="main">)</span> 
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 App <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_dependent_def
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits nat.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term-not_eta_reducible_imp_eta_norm_no_change"><span class="command">lemma</span></span> not_eta_reducible_imp_eta_norm_no_change<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eta_reducible <span class="free">t</span> <span class="main">⟹</span> eta_norm <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eta_norm.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_reducible_Abs is_dependent_def 
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits nat.splits<span class="main">)</span>

<span class="keyword1" id="Term-eta_norm_collapse"><span class="command">lemma</span></span> eta_norm_collapse<span class="main">:</span> <span class="quoted"><span class="quoted">"eta_norm <span class="main">(</span>eta_norm <span class="free">t</span><span class="main">)</span> <span class="main">=</span> eta_norm <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_eta_reducible_imp_eta_norm_no_change not_eta_reducible_eta_norm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Term-typ_of1_decr"><span class="command">lemma</span></span> typ_of1_decr<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="free">Ts</span><span class="main">@</span><span class="main">[</span><span class="free">T</span><span class="main">]</span><span class="main">@</span><span class="free">Ts'</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="main">(</span>length <span class="free">Ts</span><span class="main">)</span> 
  <span class="main">⟹</span> typ_of1 <span class="main">(</span><span class="free">Ts</span><span class="main">@</span><span class="free">Ts'</span><span class="main">)</span> <span class="main">(</span>decr <span class="main">(</span>length <span class="free">Ts</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">Ts'</span></span> <span class="quoted"><span class="free">ty</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">bT</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> append_Cons length_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv nth_append<span class="main">)</span>

<span class="keyword1" id="Term-typ_of1_decr_gen"><span class="command">lemma</span></span> typ_of1_decr_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="free">Ts</span><span class="main">@</span><span class="main">[</span><span class="free">T</span><span class="main">]</span><span class="main">@</span><span class="free">Ts'</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="free">tyo</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="main">(</span>length <span class="free">Ts</span><span class="main">)</span>
  <span class="main">⟹</span> typ_of1 <span class="main">(</span><span class="free">Ts</span><span class="main">@</span><span class="free">Ts'</span><span class="main">)</span> <span class="main">(</span>decr <span class="main">(</span>length <span class="free">Ts</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">tyo</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">Ts'</span></span> <span class="quoted"><span class="free">tyo</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> append_Cons length_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv nth_append
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Term-typ_of1_decr_gen'"><span class="command">lemma</span></span> typ_of1_decr_gen'<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="free">Ts</span><span class="main">@</span><span class="free">Ts'</span><span class="main">)</span> <span class="main">(</span>decr <span class="main">(</span>length <span class="free">Ts</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">tyo</span><span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="main">(</span>length <span class="free">Ts</span><span class="main">)</span>
  <span class="main">⟹</span> typ_of1 <span class="main">(</span><span class="free">Ts</span><span class="main">@</span><span class="main">[</span><span class="free">T</span><span class="main">]</span><span class="main">@</span><span class="free">Ts'</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="free">tyo</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">Ts'</span></span> <span class="quoted"><span class="free">tyo</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> append_Cons length_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv nth_append
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="comment1">(* Other direction does not necessarily hold, eta_norm could remove incorrect abstractions *)</span>
<span class="keyword1" id="Term-typ_of1_eta_norm"><span class="command">lemma</span></span> typ_of1_eta_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="main">(</span>eta_norm <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ty</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typ_of1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eta_norm <span class="skolem">body</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="comment1">(* In dire need of cleanup *)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bv <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_dependent <span class="skolem">f</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eta_norm <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span> <span class="main">=</span> Abs <span class="skolem">T</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> App 0 <span class="quoted">"4.IH"</span> Bv bind_eq_Some_conv is_dependent_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"0"</span> Bv App is_dependent_def bind_eq_Some_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          
          <span class="keyword1"><span class="command">hence</span></span> simp<span class="main">:</span> <span class="quoted"><span class="quoted">"eta_norm <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span> <span class="main">=</span> decr <span class="main">0</span> <span class="main">(</span>eta_norm <span class="skolem">f</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> App 0 <span class="quoted">"4.IH"</span> Bv bind_eq_Some_conv bind_eq_None_conv
                is_dependent_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bT</span></span> <span class="keyword2"><span class="keyword">where</span></span> bT<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="skolem">T</span> <span class="main">#</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="skolem">body</span> <span class="main">=</span> Some <span class="skolem">bT</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="skolem">T</span> <span class="main">#</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="main">(</span>eta_norm <span class="skolem">body</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">bT</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">→</span> <span class="skolem">bT</span> <span class="main">=</span> <span class="skolem">ty</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span> bT <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="skolem">T</span><span class="main">#</span><span class="skolem">Ts</span><span class="main">)</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">ty</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0"</span> App Bv length_Cons nth_Cons_0 typ_of1.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> typ_of1_arg_typ zero_less_Suc<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="skolem">Ts</span> <span class="main">(</span>decr <span class="main">0</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">ty</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False append_Cons append_Nil is_dependent_def list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> typ_of1_decr<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="skolem">Ts</span> <span class="main">(</span>decr <span class="main">0</span> <span class="main">(</span>eta_norm <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">ty</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> App eta_reducible.simps<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> not_eta_reducible_eta_norm not_eta_reducible_imp_eta_norm_no_change<span class="main">)</span>
                    
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> App 0 Bv False<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">nat</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> App <span class="quoted">"4.IH"</span> Bv bind_eq_Some_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> option.sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> 4 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> bind_eq_Some_conv nth_append <span class="quasi_keyword">split</span><span class="main">:</span> if_splits›</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> 4 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> bind_eq_Some_conv nth_append <span class="quasi_keyword">split</span><span class="main">:</span> if_splits›</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">Ts</span> <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits typ.splits if_splits nat.splits option.splits
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits typ.splits if_splits nat.splits option.splits 
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> typ_of_eta_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span> <span class="main">⟹</span> typ_of <span class="main">(</span>eta_norm <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typ_of1_eta_norm typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-typ_of_Abs_body_typ"><span class="command">lemma</span></span> typ_of_Abs_body_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">ty</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">rty</span><span class="main">.</span> <span class="free">ty</span> <span class="main">=</span> <span class="main">(</span><span class="free">T</span> <span class="main">→</span> <span class="bound">rty</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bind_eq_Some_conv option.sel typ_of1.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1" id="Term-typ_of_Abs_body_typ'"><span class="command">lemma</span></span> typ_of_Abs_body_typ'<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">ty</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">rty</span><span class="main">.</span> <span class="free">ty</span> <span class="main">=</span> <span class="main">(</span><span class="free">T</span> <span class="main">→</span> <span class="bound">rty</span><span class="main">)</span> <span class="main">∧</span> typ_of1 <span class="main">(</span><span class="free">T</span><span class="main">#</span><span class="free">Ts</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="bound">rty</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bind_eq_Some_conv option.sel typ_of1.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Term-typ_of_beta_redex_arg"><span class="command">lemma</span></span> typ_of_beta_redex_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="free">T</span> <span class="free">s</span> <span class="main">$</span> <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> None <span class="main">⟹</span> typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.inject not_Some_eq typ.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> typ_of1_split_App typ_of_Abs_body_typ' typ_of_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"option.mono_body
          <span class="main">(</span><span class="main">λ</span><span class="bound">beta_norm</span><span class="main">.</span> map_option <span class="main">(</span>Abs <span class="free">T</span><span class="main">)</span> <span class="main">(</span><span class="bound">beta_norm</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> flat_ord_def fun_ord_def map_option_is_None monotone_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"option.mono_body
          <span class="main">(</span><span class="main">λ</span><span class="bound">beta_norm</span><span class="main">.</span>
              <span class="keyword1">case</span> <span class="bound">beta_norm</span> <span class="free">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None
              <span class="main">|</span> Some <span class="main">(</span>Ct <span class="bound">list</span> <span class="bound">typ</span><span class="main">)</span> <span class="main">⇒</span>
                  map_option <span class="main">(</span><span class="main">($)</span> <span class="main">(</span>Ct <span class="bound">list</span> <span class="bound">typ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">beta_norm</span> <span class="free">u</span><span class="main">)</span>
              <span class="main">|</span> Some <span class="main">(</span>Fv <span class="bound">p</span> <span class="bound">typ</span><span class="main">)</span> <span class="main">⇒</span>
                  map_option <span class="main">(</span><span class="main">($)</span> <span class="main">(</span>Fv <span class="bound">p</span> <span class="bound">typ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">beta_norm</span> <span class="free">u</span><span class="main">)</span>
              <span class="main">|</span> Some <span class="main">(</span>Bv <span class="bound">n</span><span class="main">)</span> <span class="main">⇒</span>
                  map_option <span class="main">(</span><span class="main">($)</span> <span class="main">(</span>Bv <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">beta_norm</span> <span class="free">u</span><span class="main">)</span>
              <span class="main">|</span> Some <span class="main">(</span>Abs <span class="bound">T</span> <span class="bound">body</span><span class="main">)</span> <span class="main">⇒</span>
                  <span class="bound">beta_norm</span> <span class="main">(</span>subst_bv <span class="free">u</span> <span class="bound">body</span><span class="main">)</span>
              <span class="main">|</span> Some <span class="main">(</span><span class="bound">term1</span> <span class="main">$</span> <span class="bound">term2</span><span class="main">)</span> <span class="main">⇒</span>
                  map_option <span class="main">(</span><span class="main">($)</span> <span class="main">(</span><span class="bound">term1</span> <span class="main">$</span> <span class="bound">term2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">beta_norm</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flat_ord_def fun_ord_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.discI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flat_ord_def fun_ord_def<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct option.inject option.sel term.distinct term.inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Does not terminate in general :( *)</span>
<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>option<span class="main">)</span> <span class="entity">beta_norm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">beta_norm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span>Abs <span class="bound">T</span> <span class="bound">body</span><span class="main">)</span> <span class="main">⇒</span> map_option <span class="main">(</span>Abs <span class="bound">T</span><span class="main">)</span> <span class="main">(</span><span class="free">beta_norm</span> <span class="bound">body</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>Abs <span class="bound">T</span> <span class="bound">body</span> <span class="main">$</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">beta_norm</span> <span class="main">(</span>subst_bv <span class="bound">u</span> <span class="bound">body</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span><span class="bound">f</span> <span class="main">$</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">beta_norm</span> <span class="bound">f</span> <span class="keyword1">of</span> 
      Some <span class="main">(</span>Abs <span class="bound">T</span> <span class="bound">body</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">beta_norm</span> <span class="main">(</span>subst_bv <span class="bound">u</span> <span class="bound">body</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">f'</span> <span class="main">⇒</span> map_option <span class="main">(</span>App <span class="bound">f'</span><span class="main">)</span> <span class="main">(</span><span class="free">beta_norm</span> <span class="bound">u</span><span class="main">)</span>
    <span class="main">|</span> None <span class="main">⇒</span> None<span class="main">)</span>
  <span class="main">|</span> <span class="bound">t</span> <span class="main">⇒</span> Some <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">simps_of_case</span></span> beta_norm_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> beta_norm.simps
<span class="keyword1"><span class="command">declare</span></span> beta_norm_simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1" id="Term-not_beta_reducible_imp_beta_norm_unchanged"><span class="command">lemma</span></span> not_beta_reducible_imp_beta_norm_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="free">t</span> <span class="main">⟹</span> beta_norm <span class="free">t</span> <span class="main">=</span> Some <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term-not_beta_reducible_decr"><span class="command">lemma</span></span> not_beta_reducible_decr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="free">t</span> <span class="main">⟹</span> <span class="main">¬</span> beta_reducible <span class="main">(</span>decr <span class="free">n</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta_reducible.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="free">t</span> <span class="main">⟹</span> eta_norm <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="main">¬</span> beta_reducible <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eta_norm.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eta_norm <span class="skolem">body</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T'</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> oApp <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bv <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_dependent <span class="skolem">f</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> 1 oApp Bv 0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">using</span></span> beta_reducible.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">body'</span></span> <span class="keyword2"><span class="keyword">where</span></span> body'<span class="main">:</span> <span class="quoted"><span class="quoted">"eta_norm <span class="skolem">body</span> <span class="main">=</span> <span class="skolem">body'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"eta_norm <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> decr <span class="main">0</span> <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> oApp Bv 0 False f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="main">(</span><span class="skolem">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">)</span> 1 oApp Bv 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="main">(</span>decr <span class="main">0</span> <span class="main">(</span><span class="skolem">f'</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eta_reducible.simps<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> f' not_beta_reducible_decr 
                  not_eta_reducible_eta_norm not_eta_reducible_imp_eta_norm_no_change oApp<span class="main">)</span> 
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="main">(</span>decr <span class="main">0</span> <span class="skolem">f'</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="main">(</span>decr <span class="main">0</span> <span class="skolem">f'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> beta_reducible.elims<span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> t' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">nat</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 oApp Bv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> 1 oApp <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> 1 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> beta_reducible.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"eta_norm <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f'</span>"</span></span> <span class="quoted"><span class="quoted">"eta_norm <span class="skolem">u</span> <span class="main">=</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="skolem">f'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.IH"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"2.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> beta_reducible <span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> beta_reducible <span class="skolem">f'</span>›</span></span> <span class="quoted"><span class="quoted">‹eta_norm <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f'</span>›</span></span> <span class="quoted">"2"</span><span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> beta_reducible.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_variable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_variable</span> <span class="main">(</span>Fv <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_variable</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="Term-fv_occs"><span class="command">lemma</span></span> fv_occs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">∈</span> fv <span class="free">t</span> <span class="main">⟹</span> occs <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-fv_iff_occs"><span class="command">lemma</span></span> fv_iff_occs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">∈</span> fv <span class="free">t</span> <span class="main">⟷</span> occs <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* Next few definitions directly from ML code *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strip_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> typ list <span class="main">*</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strip_abs</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">=</span> <span class="free">strip_abs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">#</span> <span class="bound">a'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strip_abs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(*maps  (x1,...,xn)t   to   t*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strip_abs_body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strip_abs_body</span> <span class="main">(</span>Abs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">strip_abs_body</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strip_abs_body</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="comment1">(*maps  (x1,...,xn)t   to   [x1, ..., xn]*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strip_abs_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> typ list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strip_abs_vars</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">#</span> <span class="free">strip_abs_vars</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strip_abs_vars</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="comment1">(*Dropped inner helper function, instead passing qnt along.  *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strip_qnt_body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strip_qnt_body</span> <span class="free"><span class="bound"><span class="entity">qnt</span></span></span> <span class="main">(</span><span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span>Abs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">qnt</span></span></span> <span class="keyword1">then</span> <span class="free">strip_qnt_body</span> <span class="free"><span class="bound"><span class="entity">qnt</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strip_qnt_body</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="comment1">(*Dropped inner helper function, instead passing qnt along.  *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strip_qnt_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> term <span class="main">⇒</span> typ list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">strip_qnt_vars</span> <span class="free"><span class="bound"><span class="entity">qnt</span></span></span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">$</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">qnt</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">#</span> <span class="free">strip_qnt_vars</span> <span class="free"><span class="bound"><span class="entity">qnt</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strip_qnt_vars</span> <span class="free"><span class="bound"><span class="entity">qnt</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>  <span class="main">=</span>  <span class="main">[]</span>"</span></span>

<span class="comment1">(*maps   (f, [t1,...,tn])  to  f(t1,...,tn)*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_comb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">*</span> term list <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">list_comb</span> <span class="main">=</span> case_prod <span class="main">(</span>foldl <span class="main">($)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*seems more natural curried...*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_comb'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term list <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">list_comb'</span> <span class="main">=</span> foldl <span class="main">($)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"list_comb <span class="main">(</span><span class="free">h</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">=</span> list_comb' <span class="free">h</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_comb_def list_comb'_def<span class="main">)</span>

<span class="comment1">(*curry this... ?*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strip_comb_imp</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strip_comb_imp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">strip_comb_imp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strip_comb_imp</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="comment1">(*maps   f(t1,...,tn)  to  (f, [t1,...,tn]) ; naturally tail-recursive*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strip_comb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">*</span> term list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strip_comb</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> strip_comb_imp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="comment1">(*maps   f(t1,...,tn)  to  f , which is never a combination*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">head_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">head_of</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">head_of</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">head_of</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="comment1">(*some sanity check lemmas*)</span>

<span class="keyword1" id="Term-fst_strip_comb_imp_eq_head_of"><span class="command">lemma</span></span> fst_strip_comb_imp_eq_head_of<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>strip_comb_imp <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> head_of <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_comb_imp.induct<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">corollary</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>strip_comb <span class="free">t</span><span class="main">)</span> <span class="main">=</span> head_of <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fst_strip_comb_imp_eq_head_of <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_comb_def<span class="main">)</span>

<span class="comment1">(*not in ML*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_app</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_app</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">$</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_app</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="Term-not_is_app_imp_strip_com_imp_unchanged"><span class="command">lemma</span></span> not_is_app_imp_strip_com_imp_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_app <span class="free">t</span> <span class="main">⟹</span> strip_comb_imp <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">corollary</span></span> not_is_app_imp_strip_com_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_app <span class="free">t</span> <span class="main">⟹</span> strip_comb <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> strip_comb_def <span class="keyword1"><span class="command">using</span></span> not_is_app_imp_strip_com_imp_unchanged <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Term-list_comb_fuse"><span class="command">lemma</span></span> list_comb_fuse<span class="main">:</span> <span class="quoted"><span class="quoted">"list_comb <span class="main">(</span>list_comb <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span><span class="main">,</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> list_comb <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">ts</span><span class="main">@</span><span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_comb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>        
       
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_size_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> int <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_size_term</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free">add_size_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free">add_size_term</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_size_term</span> <span class="main">(</span>Abs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free">add_size_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_size_term</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">size_of_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> add_size_term <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_size_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"typ <span class="main">⇒</span> int <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_size_type</span> <span class="main">(</span>Ty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">tys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> fold <span class="free">add_size_type</span> <span class="free"><span class="bound"><span class="entity">tys</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_size_type</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">size_of_type</span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="main">=</span> add_size_type <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_types</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>typ <span class="main">⇒</span> typ<span class="main">)</span> <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> Ct <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> Fv <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Abs <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">map_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">map_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free">map_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_atyps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>typ <span class="main">⇒</span> typ<span class="main">)</span> <span class="main">⇒</span> typ <span class="main">⇒</span> typ"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_atyps</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">=</span> Ty <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="free">map_atyps</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_atyps</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"map_atyps id <span class="free">ty</span> <span class="main">=</span> <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typ.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_idI<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_aterms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">⇒</span> term<span class="main">)</span> <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_aterms</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">map_aterms</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free">map_aterms</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_aterms</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free">map_aterms</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_aterms</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"map_aterms id <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_type_tvar</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> map_atyps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Tv <span class="bound">iname</span> <span class="bound">s</span> <span class="main">⇒</span>  <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">iname</span> <span class="bound">s</span> <span class="main">|</span> <span class="bound">T</span> <span class="main">⇒</span> <span class="bound">T</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term-map_types_id"><span class="command">lemma</span></span> map_types_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_types id <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1" id="Term-map_types_id'"><span class="command">lemma</span></span> map_types_id'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_types <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> map_types_id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_def<span class="main">)</span>

<span class="comment1">(* fold types and terms *)</span>                
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fold_atyps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>typ <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> typ <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fold_atyps</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Ty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="free">fold_atyps</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fold_atyps</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fold_atyps_sorts</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span>
  fold_atyps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Tv <span class="bound">vn</span> <span class="bound">S</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Tv <span class="bound">vn</span> <span class="bound">S</span><span class="main">)</span> <span class="bound">S</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fold_aterms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> term <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fold_aterms</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free">fold_aterms</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free">fold_aterms</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fold_aterms</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Abs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free">fold_aterms</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fold_aterms</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fold_term_types</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">⇒</span> typ <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> term <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">fold_term_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fold_term_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">idn</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">idn</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fold_term_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Bv <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fold_term_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free">fold_term_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fold_term_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free">fold_term_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free">fold_term_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fold_types</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> fold_term_types <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Patterns for empty list except with Bv missing. Probably need a precond when using *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">replace_types</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> typ list <span class="main">⇒</span> term <span class="main">×</span> typ list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replace_types</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replace_types</span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">xi</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">xi</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replace_types</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replace_types</span> <span class="main">(</span>Abs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">b'</span><span class="main">,</span> <span class="bound">Ts'</span><span class="main">)</span> <span class="main">=</span> <span class="free">replace_types</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span>
    <span class="keyword1">in</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="bound">b'</span><span class="main">,</span> <span class="bound">Ts'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replace_types</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span>
      <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="bound">Ts'</span><span class="main">)</span> <span class="main">=</span> <span class="free">replace_types</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">u'</span><span class="main">,</span> <span class="bound">Ts''</span><span class="main">)</span> <span class="main">=</span> <span class="free">replace_types</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">t'</span> <span class="main">$</span> <span class="bound">u'</span><span class="main">,</span> <span class="bound">Ts''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* 
  collect variables, is the order important? Or should I just return sets? 
  The set case is basically just (T)fv(T)...
  List.insert should keep order, just no duplicates...
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_tvar_namesT'</span> <span class="main">=</span> fold_atyps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">l</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Tv <span class="bound">xi</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> List.insert <span class="bound">xi</span> <span class="bound">l</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_tvar_names'</span> <span class="main">=</span> fold_types add_tvar_namesT'"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_tvarsT'</span> <span class="main">=</span> fold_atyps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">l</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Tv <span class="bound">idn</span> <span class="bound">s</span> <span class="main">=&gt;</span> List.insert <span class="main">(</span><span class="bound">idn</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="bound">l</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_tvars'</span> <span class="main">=</span> fold_types add_tvarsT'"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_vars'</span> <span class="main">=</span> fold_aterms <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">l</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Fv <span class="bound">idn</span> <span class="bound">s</span> <span class="main">=&gt;</span> List.insert <span class="main">(</span><span class="bound">idn</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="bound">l</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_var_names'</span> <span class="main">=</span> fold_aterms <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">l</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Fv <span class="bound">xi</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> List.insert <span class="bound">xi</span> <span class="bound">l</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> <span class="bound">l</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_const_names'</span> <span class="main">=</span> fold_aterms <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">l</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Ct <span class="bound">c</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> List.insert <span class="bound">c</span> <span class="bound">l</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_consts'</span> <span class="main">=</span> fold_aterms <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">l</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Ct <span class="bound">n</span> <span class="bound">s</span> <span class="main">=&gt;</span> List.insert <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="bound">l</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> <span class="bound">l</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_tvar_namesT</span> <span class="main">=</span> fold_atyps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Tv <span class="bound">xi</span> <span class="main"><span class="bound">_</span></span>  <span class="main">=&gt;</span> insert <span class="bound">xi</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> id<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_tvar_names</span> <span class="main">=</span> fold_types add_tvar_namesT"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_tvarsT</span> <span class="main">=</span> fold_atyps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Tv <span class="bound">idn</span> <span class="bound">s</span> <span class="main">=&gt;</span> insert <span class="main">(</span><span class="bound">idn</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> id<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_tvars</span> <span class="main">=</span> fold_types add_tvarsT"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_var_names</span> <span class="main">=</span> fold_aterms <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Fv <span class="bound">xi</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> insert <span class="bound">xi</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> id<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_vars</span> <span class="main">=</span> fold_aterms <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Fv <span class="bound">idn</span> <span class="bound">s</span> <span class="main">=&gt;</span> insert <span class="main">(</span><span class="bound">idn</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> id<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_const_names</span> <span class="main">=</span> fold_aterms <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Ct <span class="bound">c</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> insert <span class="bound">c</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> id<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_consts</span> <span class="main">=</span> fold_aterms <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Ct <span class="bound">n</span> <span class="bound">s</span> <span class="main">=&gt;</span> insert <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> id<span class="main">)</span>"</span></span>
<span class="comment1">(*which of those do I need ^ *)</span>

<span class="comment1">(* Show that these behave like (T)fv(T)? *)</span>

<span class="keyword1" id="Term-add_tvarsT'_tvsT_pre"><span class="command">lemma</span></span> add_tvarsT'_tvsT_pre<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>add_tvarsT' <span class="free">T</span> <span class="free">acc</span><span class="main">)</span> <span class="main">=</span> set <span class="free">acc</span> <span class="main">∪</span> tvsT <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_tvarsT'_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">acc</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">acc</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term-add_tvars'_tvs_pre"><span class="command">lemma</span></span> add_tvars'_tvs_pre<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>add_tvars' <span class="free">t</span> <span class="free">acc</span><span class="main">)</span> <span class="main">=</span> set <span class="free">acc</span> <span class="main">∪</span> tvs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">acc</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_tvars'_def fold_types_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"add_tvarsT <span class="free">T</span> <span class="free">acc</span> <span class="main">=</span> <span class="free">acc</span> <span class="main">∪</span> tvsT <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_tvarsT_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">acc</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">acc</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term-add_vars'_fv_pre"><span class="command">lemma</span></span> add_vars'_fv_pre<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>add_vars' <span class="free">t</span> <span class="free">acc</span><span class="main">)</span> <span class="main">=</span> set <span class="free">acc</span> <span class="main">∪</span> fv <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_vars'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">acc</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">corollary</span></span> add_vars'_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>add_vars' <span class="free">t</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_vars'_fv_pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="comment1">(*extra type variables in a term, not covered by its type*)</span>

<span class="comment1">(* For some experiments for handling ⋀*)</span>

<span class="comment1">(* I differ from the ML code here, requiring the correct typ for the ⋀*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strip_all_body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strip_all_body</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">all</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">$</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">all</span></span></span><span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">=</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">→</span>propT<span class="main">)</span><span class="main">→</span>propT
    <span class="keyword1">then</span> <span class="free">strip_all_body</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">all</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">$</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strip_all_body</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strip_all_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> typ list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strip_all_vars</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">all</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">$</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">all</span></span></span><span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">=</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">→</span>propT<span class="main">)</span><span class="main">→</span>propT 
    <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">#</span> <span class="free">strip_all_vars</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strip_all_vars</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strip_all_single_body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strip_all_single_body</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">all</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">$</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">all</span></span></span><span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">=</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">→</span>propT<span class="main">)</span><span class="main">→</span>propT 
    <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">all</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">$</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strip_all_single_body</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strip_all_single_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> typ option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strip_all_single_var</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">all</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">$</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">all</span></span></span><span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">=</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">→</span>propT<span class="main">)</span><span class="main">→</span>propT
    <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strip_all_single_var</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strip_all_multiple_body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strip_all_multiple_body</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strip_all_multiple_body</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">all</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">$</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">all</span></span></span><span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">=</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">→</span>propT<span class="main">)</span><span class="main">→</span>propT
    <span class="keyword1">then</span> <span class="free">strip_all_multiple_body</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">all</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">$</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strip_all_multiple_body</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strip_all_multiple_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> term <span class="main">⇒</span> typ list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strip_all_multiple_vars</span> <span class="main">0</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strip_all_multiple_vars</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">all</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">$</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">all</span></span></span><span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">=</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">→</span>propT<span class="main">)</span><span class="main">→</span>propT 
    <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">#</span> <span class="free">strip_all_multiple_vars</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strip_all_multiple_vars</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1" id="Term-strip_all_vars_strip_all_multiple_vars"><span class="command">lemma</span></span> strip_all_vars_strip_all_multiple_vars<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">≥</span>length <span class="main">(</span>strip_all_vars <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> strip_all_multiple_vars <span class="free">n</span> <span class="free">t</span> <span class="main">=</span> strip_all_vars <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_all_multiple_vars.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">≥</span>length <span class="main">(</span>strip_all_vars <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> strip_all_multiple_body <span class="free">n</span> <span class="free">t</span> <span class="main">=</span> strip_all_body <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_all_multiple_vars.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> strip_all_vars.elims<span class="main">)</span>

<span class="keyword1" id="Term-length_strip_all_multiple_vars"><span class="command">lemma</span></span> length_strip_all_multiple_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>strip_all_multiple_vars <span class="free">n</span> <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_all_multiple_vars.induct<span class="main">)</span> <span class="operator">auto</span> 

<span class="keyword1" id="Term-prefix_strip_all_multiple_vars"><span class="command">lemma</span></span> prefix_strip_all_multiple_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span>strip_all_multiple_vars <span class="free">n</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>strip_all_vars <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_all_multiple_vars.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_all_list</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">T</span><span class="main">)</span> <span class="bound">acc</span> <span class="main">.</span> mk_all <span class="bound">n</span> <span class="bound">T</span> <span class="bound">acc</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Term-mk_all_list_empty"><span class="command">lemma</span></span> mk_all_list_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mk_all_list <span class="main">[]</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_all_list_def<span class="main">)</span>
                                         
<span class="comment1">(* Again, need correct typ here *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_all</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">all</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">$</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">all</span></span></span><span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">=</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">→</span>propT<span class="main">)</span><span class="main">→</span>propT<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_all</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="Term-strip_all_single_var_is_all"><span class="command">lemma</span></span> strip_all_single_var_is_all<span class="main">:</span> <span class="quoted"><span class="quoted">"strip_all_single_var <span class="free">t</span> <span class="main">≠</span> None <span class="main">⟷</span> is_all <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> f u <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_all.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"is_all <span class="free">t</span> <span class="main">⟹</span> hd <span class="main">(</span>strip_all_vars <span class="free">t</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>strip_all_single_var <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_all.elims<span class="main">)</span>

<span class="keyword1" id="Term-strip_all_body_single_simp"><span class="command">lemma</span></span> strip_all_body_single_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip_all_body <span class="main">(</span>strip_all_single_body <span class="free">t</span><span class="main">)</span> <span class="main">=</span> strip_all_body <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_all_body.induct<span class="main">)</span> <span class="operator">auto</span> 
<span class="keyword1" id="Term-strip_all_body_single_simp'"><span class="command">lemma</span></span> strip_all_body_single_simp'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip_all_single_body <span class="main">(</span>strip_all_body <span class="free">t</span><span class="main">)</span> <span class="main">=</span> strip_all_body <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_all_body.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-strip_all_vars_step"><span class="command">lemma</span></span> strip_all_vars_step<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"strip_all_single_var <span class="free">t</span> <span class="main">=</span> Some <span class="free">T</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">#</span> strip_all_vars <span class="main">(</span>strip_all_single_body <span class="free">t</span><span class="main">)</span> <span class="main">=</span> strip_all_vars <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_all_vars.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> 

<span class="keyword1" id="Term-is_all_iff_strip_all_vars_not_empty"><span class="command">lemma</span></span> is_all_iff_strip_all_vars_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"is_all <span class="free">t</span> <span class="main">⟷</span> strip_all_vars <span class="free">t</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> f u <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> strip_all_vars.elims is_all.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Term-strip_all_vars_bind_fv"><span class="command">lemma</span></span> strip_all_vars_bind_fv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"strip_all_vars <span class="main">(</span>bind_fv2 <span class="free">v</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>strip_all_vars <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_all_vars.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-strip_all_vars_mk_all"><span class="command">lemma</span></span> strip_all_vars_mk_all<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip_all_vars <span class="main">(</span>mk_all <span class="free">s</span> <span class="free">ty</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">ty</span> <span class="main">#</span> strip_all_vars <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bind_fv_def strip_all_vars_bind_fv typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term-strip_all_vars_mk_all_list"><span class="command">lemma</span></span> strip_all_vars_mk_all_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_all <span class="free">t</span> <span class="main">⟹</span> strip_all_vars <span class="main">(</span>mk_all_list <span class="free">l</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span>map snd <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> is_all_iff_strip_all_vars_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">v</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"strip_all_vars <span class="main">(</span>mk_all_list <span class="skolem">vs</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span>map snd <span class="skolem">vs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ty</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">ty</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strip_all_vars <span class="main">(</span>mk_all_list <span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> 
    <span class="main">=</span> strip_all_vars <span class="main">(</span>mk_all <span class="skolem">s</span> <span class="skolem">ty</span> <span class="main">(</span>mk_all_list <span class="skolem">vs</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_all_list_def v<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">ty</span> <span class="main">#</span> strip_all_vars <span class="main">(</span>mk_all_list <span class="skolem">vs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> strip_all_vars_mk_all<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ty</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="quoted">"mk_all_list <span class="skolem">vs</span> <span class="free">t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">ty</span> <span class="main">#</span> rev <span class="main">(</span>map snd <span class="skolem">vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> rev <span class="main">(</span>map snd <span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Move up *)</span>
<span class="keyword1" id="Term-subst_bv_no_loose_unchanged"><span class="command">lemma</span></span> subst_bv_no_loose_unchanged<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">lev</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_variable <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subst_bv1 <span class="free">t</span> <span class="free">lev</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bv <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> loose_bvar_iff_exist_loose_bvar1 no_loose_bvar_imp_no_subst_bv1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> loose_bvar_iff_exist_loose_bvar1 no_loose_bvar_imp_no_subst_bv1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="comment1">(* Should state those in terms "of ∈ fv", occs is a relict *)</span>
<span class="keyword1" id="Term-bind_fv2_no_occs_unchanged"><span class="command">lemma</span></span> bind_fv2_no_occs_unchanged<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> occs <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bind_fv2 <span class="free">v</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-bind_fv2_subst_bv1_cancel"><span class="command">lemma</span></span> bind_fv2_subst_bv1_cancel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="free">lev</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> occs <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span>  <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind_fv2 <span class="free">v</span> <span class="free">lev</span> <span class="main">(</span>subst_bv1 <span class="free">t</span> <span class="free">lev</span> <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bv <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> linorder_neqE_nat 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_variable_imp_incr_boundvars_unchganged<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bind_fv2 <span class="free">v</span> <span class="main">(</span><span class="skolem">lev</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>subst_bv1 <span class="skolem">t</span> <span class="main">(</span><span class="skolem">lev</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> Suc_lessE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">(* This proof contains so much duplication it makes me vomit... 
    Got even uglier after translation
  *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"loose_bvar1 <span class="skolem">t1</span> <span class="skolem">lev</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"bind_fv2 <span class="free">v</span> <span class="skolem">lev</span> <span class="main">(</span>subst_bv1 <span class="skolem">t1</span> <span class="skolem">lev</span> <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> App <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"loose_bvar1 <span class="skolem">t2</span> <span class="skolem">lev</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bind_fv2 <span class="free">v</span> <span class="skolem">lev</span> <span class="main">(</span>subst_bv1 <span class="skolem">t2</span> <span class="skolem">lev</span> <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> App <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> I1 App.prems is_variable.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bind_fv2 <span class="free">v</span> <span class="skolem">lev</span> <span class="main">(</span>subst_bv1 <span class="skolem">t2</span> <span class="skolem">lev</span>  <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bv1 <span class="skolem">t2</span> <span class="skolem">lev</span>  <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subst_bv_no_loose_unchanged
          <span class="keyword1"><span class="command">using</span></span> App.prems<span class="main">(</span>1-2<span class="main">)</span> False assms le_neq_implies_less loose_bvar1.simps<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loose_bvar_iff_exist_loose_bvar1 no_loose_bvar_imp_no_subst_bv1<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bind_fv2 <span class="free">v</span> <span class="skolem">lev</span> <span class="skolem">t2</span> <span class="main">=</span> <span class="skolem">t2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> App.prems<span class="main">(</span>2<span class="main">)</span> bind_fv2_no_occs_unchanged
          <span class="keyword1"><span class="command">using</span></span> App.prems<span class="main">(</span>2<span class="main">)</span> bind_fv2_changed' exists_subterm'.simps<span class="main">(</span>1<span class="main">)</span> 
            exists_subterm_iff_exists_subterm' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> I1 App.prems is_variable.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"bind_fv2 <span class="free">v</span> <span class="skolem">lev</span> <span class="main">(</span>subst_bv1 <span class="skolem">t1</span> <span class="skolem">lev</span> <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bv1 <span class="skolem">t1</span> <span class="skolem">lev</span> <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subst_bv_no_loose_unchanged
        <span class="keyword1"><span class="command">using</span></span> App.prems<span class="main">(</span>1-2<span class="main">)</span> False le_neq_implies_less loose_bvar1.simps<span class="main">(</span>2<span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loose_bvar_iff_exist_loose_bvar1 no_loose_bvar_imp_no_subst_bv1<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bind_fv2 <span class="free">v</span> <span class="skolem">lev</span> <span class="skolem">t1</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> App.prems<span class="main">(</span>2<span class="main">)</span> bind_fv2_no_occs_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"loose_bvar1 <span class="skolem">t2</span> <span class="skolem">lev</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bind_fv2 <span class="free">v</span> <span class="skolem">lev</span> <span class="main">(</span>subst_bv1 <span class="skolem">t2</span> <span class="skolem">lev</span> <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> App <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> I1 App.prems is_variable.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bind_fv2 <span class="free">v</span> <span class="skolem">lev</span> <span class="main">(</span>subst_bv1 <span class="skolem">t2</span> <span class="skolem">lev</span> <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bv1 <span class="skolem">t2</span> <span class="skolem">lev</span> <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subst_bv_no_loose_unchanged
          <span class="keyword1"><span class="command">using</span></span> App.prems<span class="main">(</span>1-2<span class="main">)</span> False assms le_neq_implies_less loose_bvar1.simps<span class="main">(</span>2<span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loose_bvar_iff_exist_loose_bvar1 no_loose_bvar_imp_no_subst_bv1<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bind_fv2 <span class="free">v</span> <span class="skolem">lev</span> <span class="skolem">t2</span> <span class="main">=</span> <span class="skolem">t2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> App.prems<span class="main">(</span>2<span class="main">)</span> bind_fv2_no_occs_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> I1 App.prems is_variable.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term-bind_fv_subst_bv_cancel"><span class="command">lemma</span></span> bind_fv_subst_bv_cancel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> occs <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind_fv <span class="free">v</span> <span class="main">(</span>subst_bv <span class="main">(</span>case_prod Fv <span class="free">v</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bind_fv2_subst_bv1_cancel bind_fv_def assms subst_bv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1" id="Term-not_loose_bvar_imp_not_loose_bvar1_all_greater"><span class="command">lemma</span></span> not_loose_bvar_imp_not_loose_bvar1_all_greater<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="free">lev</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">&gt;</span><span class="free">lev</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> loose_bvar_iff_exist_loose_bvar1<span class="main">)</span>

<span class="keyword1" id="Term-mk_all'_subst_bv_strip_all_single_body_cancel"><span class="command">lemma</span></span> mk_all'_subst_bv_strip_all_single_body_cancel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"strip_all_single_var <span class="free">t</span> <span class="main">=</span> Some <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">∉</span> fv <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mk_all <span class="free">name</span> <span class="free">T</span> <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">name</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span>strip_all_single_body <span class="free">t</span><span class="main">)</span> <span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">T</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs <span class="free">T</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> strip_all_single_var.elims 
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv typ_of_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits if_splits<span class="main">)</span>
 
  <span class="keyword1"><span class="command">hence</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"strip_all_single_body <span class="free">t</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> is_open_def loose_bvar_iff_exist_loose_bvar1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="skolem">t'</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def t'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> loose_bvar_iff_exist_loose_bvar1 gr0_conv_Suc<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occs <span class="skolem">t'</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bind_fv <span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">name</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span>strip_all_single_body <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>strip_all_single_body <span class="free">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> bind_fv_subst_bv_cancel gr0_conv_Suc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s is_open_def t'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> 
        loose_bvar_iff_exist_loose_bvar1 fv_iff_occs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_fv_subst_bv_cancel<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s typ_of_def t'<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term-not_is_all_imp_strip_all_body_unchanged"><span class="command">lemma</span></span> not_is_all_imp_strip_all_body_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_all <span class="free">t</span> <span class="main">⟹</span> strip_all_body <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_all.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> 

<span class="keyword1" id="Term-no_loose_bvar_imp_no_subst_bvs"><span class="command">lemma</span></span> no_loose_bvar_imp_no_subst_bvs<span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">t</span> <span class="main">⟹</span> subst_bvs <span class="main">[]</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> no_loose_bvar_imp_no_subst_bvs1 subst_bvs_def is_open_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_open_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-bind_fv2_Fv_fv"><span class="command">lemma</span></span> bind_fv2_Fv_fv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">t</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bind_fv2.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits term.splits<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> mk_all_fv_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>mk_all <span class="free">x</span> <span class="free">τ</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bind_fv2_Fv_fv bind_fv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term-mk_all_list_fv_unchanged"><span class="command">lemma</span></span> mk_all_list_fv_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>mk_all_list <span class="free">l</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">B</span> <span class="main">-</span> set <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">(* After translation, look at proof again*)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"mk_all_list <span class="main">(</span><span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">B</span> <span class="main">=</span> case_prod mk_all <span class="skolem">x</span> <span class="main">(</span>mk_all_list <span class="skolem">xs</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_all_list_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> s <span class="quoted">"snoc.IH"</span> mk_all_fv_unchanged <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Hs parameter to check if var is fixed by hypotheses *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">forall_intro_vars</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">≡</span> mk_all_list 
  <span class="main">(</span>diff_list <span class="main">(</span>add_vars' <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>fold <span class="main">(</span>add_vars'<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Sorts">
<div class="head">
<h1>Theory Sorts</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Sorts"</span></span>

<span class="comment1">(* 
  Some stuff on sorts. Mostly from Sort.ML I think.
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Sorts
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Term">Term</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">empty_osig</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> Map.empty<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sort_les</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="main">(</span>sort_leq <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">∧</span> <span class="main">¬</span> sort_leq <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sort_eqv</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="main">(</span>sort_leq <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">∧</span> sort_leq <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> class_defs <span class="main">=</span> class_leq_def class_les_def class_ex_def
<span class="keyword1"><span class="command">lemmas</span></span> sort_defs <span class="main">=</span> sort_leq_def sort_les_def sort_eqv_def sort_ex_def

<span class="keyword1" id="Sorts-sort_ex_class_ex"><span class="command">lemma</span></span> sort_ex_class_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">S</span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">c</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> class_ex <span class="free">cs</span> <span class="bound">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sort_ex_def class_ex_def subset_eq<span class="main">)</span>

<span class="comment1">(* Did not want to write the wf_subclass cs assumption each time + allowed type class instances inside
  Now probably more trouble than help
*)</span>
<span class="keyword1"><span class="command">locale</span></span> wf_subclass_loc <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"class rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_subclass <span class="free">cs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1" id="Sorts-class_les_irrefl"><span class="command">lemma</span></span> class_les_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> class_les <span class="free">cs</span> <span class="free">c</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> class_les_def<span class="main">)</span>
<span class="keyword1" id="Sorts-class_les_trans"><span class="command">lemma</span></span> class_les_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"class_les <span class="free">cs</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> class_les <span class="free">cs</span> <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> class_les <span class="free">cs</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> class_les_def class_leq_def trans_def<span class="main">)</span>

<span class="keyword1" id="Sorts-class_leq_refl"><span class="command">lemma</span></span> class_leq_refl<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"class_ex <span class="free">cs</span> <span class="free">c</span> <span class="main">⟹</span> class_leq <span class="free">cs</span> <span class="free">c</span> <span class="free">c</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> wf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> class_leq_def class_ex_def refl_on_def<span class="main">)</span> 
<span class="keyword1" id="Sorts-class_leq_trans"><span class="command">lemma</span></span> class_leq_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"class_leq <span class="free">cs</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> class_leq <span class="free">cs</span> <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> class_leq <span class="free">cs</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> class_leq_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> transE<span class="main">)</span>
<span class="keyword1" id="Sorts-class_leq_antisym"><span class="command">lemma</span></span> class_leq_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"class_leq <span class="free">cs</span> <span class="free">c1</span> <span class="free">c2</span> <span class="main">⟹</span> class_leq <span class="free">cs</span> <span class="free">c2</span> <span class="free">c1</span> <span class="main">⟹</span> <span class="free">c1</span><span class="main">=</span><span class="free">c2</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> wf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> antisymD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trans_def class_leq_def<span class="main">)</span>

<span class="comment1">(* classes form a ~ partial order with class_les/class_leq a for a well-formed a*)</span>
<span class="keyword1" id="Sorts-sort_leq_refl"><span class="command">lemma</span></span> sort_leq_refl<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s</span> <span class="main">⟹</span> sort_leq <span class="free">cs</span> <span class="free">s</span> <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> class_leq_refl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sort_ex_class_ex sort_leq_def<span class="main">)</span>
<span class="keyword1" id="Sorts-sort_leq_trans"><span class="command">lemma</span></span> sort_leq_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_leq <span class="free">cs</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> sort_leq <span class="free">cs</span> <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> sort_leq <span class="free">cs</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> class_leq_trans sort_leq_def<span class="main">)</span>
<span class="keyword1" id="Sorts-sort_leq_ex"><span class="command">lemma</span></span> sort_leq_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_leq <span class="free">cs</span> <span class="free">s1</span> <span class="free">s2</span> <span class="main">⟹</span> sort_ex <span class="free">cs</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sort_ex_def class_leq_def sort_leq_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> FieldI2<span class="main">)</span>
<span class="comment1">(* ... *)</span>

<span class="keyword1" id="Sorts-sort_leq_minimize"><span class="command">lemma</span></span> sort_leq_minimize<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sort_leq <span class="free">cs</span> <span class="free">s1</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s1'</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c1</span> <span class="main">∈</span> <span class="bound">s1'</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">c2</span> <span class="main">∈</span> <span class="free">s2</span><span class="main">.</span> class_leq <span class="free">cs</span> <span class="bound">c1</span> <span class="bound">c2</span><span class="main">)</span> <span class="main">∧</span> sort_leq <span class="free">cs</span> <span class="bound">s1'</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> class_leq_refl sort_ex_class_ex sort_leq_ex sort_leq_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">s1</span> <span class="main">⊆</span> <span class="free">s2</span> <span class="main">⟹</span> sort_ex <span class="free">cs</span> <span class="free">s1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> sort_ex_def subset_trans<span class="main">)</span>

<span class="keyword1" id="Sorts-superset_imp_sort_leq"><span class="command">lemma</span></span> superset_imp_sort_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">s1</span> <span class="main">⊇</span> <span class="free">s2</span> <span class="main">⟹</span> sort_leq <span class="free">cs</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sort_ex_class_ex sort_leq_def sort_ex_def<span class="main">)</span>
<span class="keyword1" id="Sorts-full_sort_top"><span class="command">lemma</span></span> full_sort_top<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s</span> <span class="main">⟹</span> sort_leq <span class="free">cs</span> <span class="free">s</span> full_sort"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sort_leq_def<span class="main">)</span>

<span class="comment1">(* Is this even useful? *)</span>
<span class="keyword1" id="Sorts-sort_les_trans"><span class="command">lemma</span></span> sort_les_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_les <span class="free">cs</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> sort_les <span class="free">cs</span> <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> sort_les <span class="free">cs</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sort_les_def sort_leq_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                                                               
<span class="keyword1" id="Sorts-sort_eqvI"><span class="command">lemma</span></span> sort_eqvI<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_leq <span class="free">cs</span> <span class="free">s1</span> <span class="free">s2</span> <span class="main">⟹</span> sort_leq <span class="free">cs</span> <span class="free">s2</span> <span class="free">s1</span> <span class="main">⟹</span> sort_eqv <span class="free">cs</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sort_eqv_def<span class="main">)</span>
<span class="keyword1" id="Sorts-sort_eqv_refl"><span class="command">lemma</span></span> sort_eqv_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s</span> <span class="main">⟹</span> sort_eqv <span class="free">cs</span> <span class="free">s</span> <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> sort_leq_refl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sort_eqv_def<span class="main">)</span>
<span class="keyword1" id="Sorts-sort_eqv_trans"><span class="command">lemma</span></span> sort_eqv_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_eqv <span class="free">cs</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> sort_eqv <span class="free">cs</span> <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> sort_eqv <span class="free">cs</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sort_eqv_def sort_leq_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1" id="Sorts-sort_eqv_sym"><span class="command">lemma</span></span> sort_eqv_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_eqv <span class="free">cs</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> sort_eqv <span class="free">cs</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sort_eqv_def<span class="main">)</span>
<span class="comment1">(* sort_eqv a is ~ equivalence relation.. *)</span>

<span class="keyword1" id="Sorts-normalize_sort_empty"><span class="command">lemma</span></span> normalize_sort_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"normalize_sort <span class="free">cs</span> full_sort <span class="main">=</span> full_sort"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def<span class="main">)</span>
<span class="keyword1" id="Sorts-normalize_sort_normalize_sort"><span class="command">lemma</span></span> normalize_sort_normalize_sort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"normalize_sort <span class="free">cs</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> normalize_sort <span class="free">cs</span> <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def<span class="main">)</span>

<span class="keyword1" id="Sorts-sort_ex_norm_sort"><span class="command">lemma</span></span> sort_ex_norm_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s</span> <span class="main">⟹</span> sort_ex <span class="free">cs</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def sort_ex_class_ex<span class="main">)</span>

<span class="keyword1" id="Sorts-normalized_sort_subset"><span class="command">lemma</span></span> normalized_sort_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"normalize_sort <span class="free">cs</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def<span class="main">)</span>

<span class="keyword1" id="Sorts-normalize_sort_removed_elem_irrelevant'"><span class="command">lemma</span></span> normalize_sort_removed_elem_irrelevant'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="main">(</span>insert <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∉</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="main">(</span>insert <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"normalize_sort <span class="free">cs</span> <span class="main">(</span>insert <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> normalize_sort <span class="free">cs</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"class_ex <span class="free">cs</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sort_ex_class_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"class_les <span class="free">cs</span> <span class="skolem">c'</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> class_les_irrefl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹class_ex <span class="free">cs</span> <span class="free">c</span>›</span></span> class_les_irrefl class_les_trans <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> normalize_sort_removed_elem_irrelevant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="main">(</span>insert <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∉</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="main">(</span>insert <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"normalize_sort <span class="free">cs</span> <span class="main">(</span>insert <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> normalize_sort <span class="free">cs</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms normalize_sort_removed_elem_irrelevant' 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def<span class="main">)</span>

<span class="keyword1" id="Sorts-normalize_sort_nempt_is_nempty"><span class="command">lemma</span></span> normalize_sort_nempt_is_nempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> full_sort"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"normalize_sort <span class="free">cs</span> <span class="free">s</span> <span class="main">≠</span> full_sort"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ICons <span class="main">=</span> this
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> emptyI
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"normalize_sort <span class="free">cs</span> <span class="main">(</span>insert <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">c</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert class_les_irrefl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def sort_ex_class_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insertI <span class="skolem">c'</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"normalize_sort <span class="free">cs</span> <span class="skolem">s</span> <span class="main">≠</span> full_sort"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> ICons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def sort_ex_class_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">c</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> normalized_sort_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> ICons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def sort_ex_class_ex class_les_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> normalize_sort_removed_elem_irrelevant
        <span class="keyword1"><span class="command">using</span></span> insert.prems<span class="main">(</span>2<span class="main">)</span> ICons<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹normalize_sort <span class="free">cs</span> <span class="skolem">s</span> <span class="main">≠</span> full_sort›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sorts-choose_smaller_in_sort"><span class="command">lemma</span></span> choose_smaller_in_sort<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nelem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∉</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"class_les <span class="free">cs</span> <span class="free">c'</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def sort_ex_class_ex<span class="main">)</span>

<span class="keyword1" id="Sorts-normalize_ex_bound'"><span class="command">lemma</span></span> normalize_ex_bound'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nelem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∉</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="free">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span> <span class="main">∈</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="free">s</span><span class="main">)</span> <span class="main">.</span> class_les <span class="free">cs</span> <span class="bound">c'</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">ic</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ic</span><span class="main">=</span><span class="skolem">c</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> choose_smaller_in_sort class_les_irrefl class_les_trans insert.IH insert.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
          insert.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> insert_iff insert_subset normalize_sort_removed_elem_irrelevant' sort_ex_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ic</span> <span class="main">∈</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="main">(</span>insert <span class="skolem">ic</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"class_les <span class="free">cs</span> <span class="skolem">ic</span> <span class="skolem">c</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> insert <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">s</span>›</span></span> normalize_sort_removed_elem_irrelevant' sort_ex_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c''</span></span> <span class="keyword2"><span class="keyword">where</span></span> c''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c''</span> <span class="main">∈</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"class_les <span class="free">cs</span> <span class="skolem">c''</span> <span class="skolem">c</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> insert <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">s</span>›</span></span> normalize_sort_removed_elem_irrelevant' sort_ex_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False choose_smaller_in_sort class_les_trans insert_iff insert_subset<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c''</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">c''</span><span class="main">)</span> <span class="main">∉</span> <span class="free">cs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> c'' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> class_leq_def class_les_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> class_les <span class="free">cs</span> <span class="skolem">ic</span> <span class="skolem">c''</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> False class_leq_def class_les_def class_les_trans<span class="main">)</span>

        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def sort_ex_class_ex class_ex_def class_leq_def class_les_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> insert.IH insert.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insert.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">s</span>›</span></span> 
            normalize_sort_removed_elem_irrelevant sort_ex_def insert_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> normalize_ex_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nelem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∉</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="free">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">∈</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"class_les <span class="free">cs</span> <span class="free">c'</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms normalize_ex_bound' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s</span> <span class="main">⟹</span> sort_leq <span class="free">cs</span> <span class="free">s</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def sort_leq_def sort_ex_class_ex<span class="main">)</span>
<span class="keyword1" id="Sorts-sort_eqv_normalize_sort"><span class="command">lemma</span></span> sort_eqv_normalize_sort<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sort_eqv <span class="free">cs</span> <span class="free">s</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sort_eqvI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sort_leq <span class="free">cs</span> <span class="free">s</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="free">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  normalize_sort_def sort_leq_def sort_ex_class_ex<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sort_leq <span class="free">cs</span> <span class="main">(</span>normalize_sort <span class="free">cs</span> <span class="free">s</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> sort_leq_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c2</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span> <span class="main">∈</span> normalize_sort <span class="free">cs</span> <span class="free">s</span><span class="main">.</span> class_leq <span class="free">cs</span> <span class="bound">c1</span> <span class="skolem">c2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">∈</span> normalize_sort <span class="free">cs</span> <span class="free">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c2</span> <span class="main">∈</span> <span class="free">s</span>›</span></span> assms sort_ex_class_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> normalize_sort <span class="free">cs</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"class_les <span class="free">cs</span> <span class="skolem">c'</span> <span class="skolem">c2</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c2</span> <span class="main">∈</span> <span class="free">s</span>›</span></span> normalize_ex_bound assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> class_les_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sorts-normalize_sort_eq_imp_sort_eqv"><span class="command">lemma</span></span> normalize_sort_eq_imp_sort_eqv<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s1</span> <span class="main">⟹</span> sort_ex <span class="free">cs</span> <span class="free">s2</span> <span class="main">⟹</span> finite <span class="free">s1</span> <span class="main">⟹</span> finite <span class="free">s2</span>
  <span class="main">⟹</span> normalize_sort <span class="free">cs</span> <span class="free">s1</span> <span class="main">=</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span>
  <span class="main">⟹</span> sort_eqv <span class="free">cs</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sort_eqv_sym sort_eqv_trans wf_subclass_loc.sort_eqv_normalize_sort wf_subclass_loc_axioms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"class_leq <span class="free">cs</span> <span class="free">c1</span> <span class="free">c2</span> <span class="main">⟷</span> class_les <span class="free">cs</span> <span class="free">c1</span> <span class="free">c2</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c1</span><span class="main">=</span><span class="free">c2</span> <span class="main">∧</span> class_ex <span class="free">cs</span> <span class="free">c1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> FieldI1 class_ex_def class_leq_antisym class_leq_def class_leq_refl class_les_def<span class="main">)</span>

<span class="keyword1" id="Sorts-sort_eqv_imp_normalize_sort_eq"><span class="command">lemma</span></span> sort_eqv_imp_normalize_sort_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s2</span>"</span></span> <span class="quoted"><span class="quoted">"sort_eqv <span class="free">cs</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"normalize_sort <span class="free">cs</span> <span class="free">s1</span> <span class="main">=</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sort_leq <span class="free">cs</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span> <span class="quoted"><span class="quoted">"sort_leq <span class="free">cs</span> <span class="free">s2</span> <span class="free">s1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sort_eqv_def<span class="main">)</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"normalize_sort <span class="free">cs</span> <span class="free">s1</span> <span class="main">≠</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> normalize_sort <span class="free">cs</span> <span class="free">s1</span> <span class="main">⊆</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span> <span class="main">∨</span> 
    <span class="main">¬</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span> <span class="main">⊆</span> normalize_sort <span class="free">cs</span> <span class="free">s1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> normalize_sort <span class="free">cs</span> <span class="free">s1</span> <span class="main">⊆</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"normalize_sort <span class="free">cs</span> <span class="free">s1</span> <span class="main">⊆</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">¬</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span> <span class="main">⊆</span> normalize_sort <span class="free">cs</span> <span class="free">s1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> normalize_sort <span class="free">cs</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∉</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span>"</span></span> <span class="quoted"><span class="quoted">"class_les <span class="free">cs</span> <span class="skolem">c'</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹sort_leq <span class="free">cs</span> <span class="free">s1</span> <span class="free">s2</span>›</span></span> <span class="quoted"><span class="quoted">‹sort_leq <span class="free">cs</span> <span class="free">s2</span> <span class="free">s1</span>›</span></span> class_les_def mem_Collect_eq normalize_sort_def 
          sort_leq_def wf_subclass_loc.class_leq_antisym wf_subclass_loc.class_leq_trans wf_subclass_loc_axioms<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> normalize_sort <span class="free">cs</span> <span class="free">s1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∉</span> normalize_sort <span class="free">cs</span> <span class="free">s1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c c' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> False c' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c''</span></span> <span class="keyword2"><span class="keyword">where</span></span> c''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c''</span> <span class="main">∈</span> normalize_sort <span class="free">cs</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"class_les <span class="free">cs</span> <span class="skolem">c''</span> <span class="skolem">c'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹sort_leq <span class="free">cs</span> <span class="free">s1</span> <span class="free">s2</span>›</span></span> <span class="quoted"><span class="quoted">‹sort_leq <span class="free">cs</span> <span class="free">s2</span> <span class="free">s1</span>›</span></span> class_les_def mem_Collect_eq normalize_sort_def 
          sort_leq_def wf_subclass_loc.class_leq_antisym wf_subclass_loc.class_leq_trans wf_subclass_loc_axioms<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"class_les <span class="free">cs</span> <span class="skolem">c''</span> <span class="skolem">c</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c'<span class="main">(</span>2<span class="main">)</span> class_les_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∉</span> normalize_sort <span class="free">cs</span> <span class="free">s1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c c'' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="comment1">(* Should work analogous, let's see *)</span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∉</span> normalize_sort <span class="free">cs</span> <span class="free">s1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> normalize_sort <span class="free">cs</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"class_les <span class="free">cs</span> <span class="skolem">c'</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹sort_leq <span class="free">cs</span> <span class="free">s1</span> <span class="free">s2</span>›</span></span> <span class="quoted"><span class="quoted">‹sort_leq <span class="free">cs</span> <span class="free">s2</span> <span class="free">s1</span>›</span></span> class_les_def mem_Collect_eq normalize_sort_def 
          sort_leq_def wf_subclass_loc.class_leq_antisym wf_subclass_loc.class_leq_trans wf_subclass_loc_axioms<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∉</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c c' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> False c' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c''</span></span> <span class="keyword2"><span class="keyword">where</span></span> c''<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">c''</span><span class="main">∈</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span>"</span></span> <span class="quoted"><span class="quoted">"class_les <span class="free">cs</span> <span class="skolem">c''</span> <span class="skolem">c'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹sort_leq <span class="free">cs</span> <span class="free">s1</span> <span class="free">s2</span>›</span></span> <span class="quoted"><span class="quoted">‹sort_leq <span class="free">cs</span> <span class="free">s2</span> <span class="free">s1</span>›</span></span> class_les_def mem_Collect_eq normalize_sort_def 
          sort_leq_def wf_subclass_loc.class_leq_antisym wf_subclass_loc.class_leq_trans wf_subclass_loc_axioms<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"class_les <span class="free">cs</span> <span class="skolem">c''</span> <span class="skolem">c</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c'<span class="main">(</span>2<span class="main">)</span> class_les_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∉</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c c'' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> sort_eqv_iff_normalize_sort_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"sort_ex <span class="free">cs</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sort_eqv <span class="free">cs</span> <span class="free">s1</span> <span class="free">s2</span> <span class="main">⟷</span> normalize_sort <span class="free">cs</span> <span class="free">s1</span> <span class="main">=</span> normalize_sort <span class="free">cs</span> <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms normalize_sort_eq_imp_sort_eqv sort_eqv_imp_normalize_sort_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Sorts-tcsigs_sorts_defined"><span class="command">lemma</span></span> tcsigs_sorts_defined<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_osig <span class="free">oss</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> ran <span class="main">(</span>tcsigs <span class="free">oss</span><span class="main">)</span> <span class="main">.</span> <span class="main">∀</span><span class="bound">ss</span> <span class="main">∈</span> ran <span class="bound">ars</span> <span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="bound">ss</span><span class="main">.</span> sort_ex <span class="main">(</span>subclass <span class="free">oss</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">oss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_sort_def all_normalized_and_ex_tcsigs_def<span class="main">)</span>

<span class="keyword1" id="Sorts-osig_subclass_loc"><span class="command">lemma</span></span> osig_subclass_loc<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_osig <span class="free">oss</span> <span class="main">⟹</span> wf_subclass_loc <span class="main">(</span>subclass <span class="free">oss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_subclass_loc.intro <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">oss</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Sorts-wf_osig_imp_wf_subclass_loc"><span class="command">lemma</span></span> wf_osig_imp_wf_subclass_loc<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_osig <span class="free">oss</span> <span class="main">⟹</span> wf_subclass_loc <span class="main">(</span>subclass <span class="free">oss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">oss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_subclass_loc_def<span class="main">)</span>

<span class="keyword1" id="Sorts-has_sort_Tv_imp_sort_leq"><span class="command">lemma</span></span> has_sort_Tv_imp_sort_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"has_sort <span class="free">oss</span> <span class="main">(</span>Tv <span class="free">idn</span> <span class="free">S</span><span class="main">)</span> <span class="free">S'</span> <span class="main">⟹</span> sort_leq <span class="main">(</span>subclass <span class="free">oss</span><span class="main">)</span> <span class="free">S</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_sort.simps<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="SortConstants">
<div class="head">
<h1>Theory SortConstants</h1>
</div>
<pre class="source">
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Constants for encoding class/sort constraints in term language›</span></span>

<span class="comment1">(* Mostly from ML code again *)</span>

<span class="keyword1"><span class="command">theory</span></span> SortConstants
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Sorts">Sorts</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* pattern matching on strings not posigible *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dest_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> typ option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dest_type</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">nc</span></span></span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">ty</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">nc</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.type''</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.type''</span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dest_type</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_map</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> map_option <span class="main">(</span><span class="main">λ</span><span class="bound">ty</span><span class="main">.</span> mk_type <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">ty</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dest_type <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(** type classes **)</span>

<span class="comment1">(* i have implementations for those somewhere, find them, currently not used *)</span>
<span class="keyword1"><span class="command">consts</span></span> unsuffix <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> name <span class="main">⇒</span> name option"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">class_of_const</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">(</span>unsuffix classN <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* class/sort membership *)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dest_of_class</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> <span class="main">(</span>typ <span class="main">*</span> class<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">dest_of_class</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">c_class</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span><span class="main">)</span> <span class="main">=</span> lift2_option Pair <span class="main">(</span>dest_type <span class="free"><span class="bound"><span class="entity">ty</span></span></span><span class="main">)</span> <span class="main">(</span>class_of_const <span class="free"><span class="bound"><span class="entity">c_class</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dest_of_class</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_of_sort</span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">==</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">c</span> <span class="main">.</span> mk_of_class <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="bound">c</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Theory">
<div class="head">
<h1>Theory Theory</h1>
</div>
<pre class="source">
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Wellformed Signature and Theory"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Theory
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Term">Term</a> <a href="#Sorts">Sorts</a> <a href="#SortConstants">SortConstants</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Functional versions of wf_type/wf_term, for historic reasons still used in definitions and proofs *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">typ_ok_sig</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"signature <span class="main">⇒</span> typ <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">typ_ok_sig</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> type_arity <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> False
  <span class="main">|</span> Some <span class="bound">ar</span> <span class="main">⇒</span> length <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span> <span class="bound">ar</span> <span class="main">∧</span> list_all <span class="main">(</span><span class="free">typ_ok_sig</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">typ_ok_sig</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Tv <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> wf_sort <span class="main">(</span>subclass <span class="main">(</span>osig <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1" id="Theory-typ_ok_sig_imp_wf_type"><span class="command">lemma</span></span> typ_ok_sig_imp_wf_type<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="free">T</span> <span class="main">⟹</span> wf_type <span class="free">Σ</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_type.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1" id="Theory-wf_type_imp_typ_ok_sig"><span class="command">lemma</span></span> wf_type_imp_typ_ok_sig<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_type <span class="free">Σ</span> <span class="free">T</span> <span class="main">⟹</span> typ_ok_sig <span class="free">Σ</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_type.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  
<span class="keyword1"><span class="command">corollary</span></span> wf_type_iff_typ_ok_sig<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_type <span class="free">Σ</span> <span class="free">T</span> <span class="main">=</span> typ_ok_sig <span class="free">Σ</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_type_imp_typ_ok_sig typ_ok_sig_imp_wf_type <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">term_ok'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"signature <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">term_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Fv <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> typ_ok_sig <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">term_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Bv <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">term_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> const_type <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> False
  <span class="main">|</span> Some <span class="bound">ty</span> <span class="main">⇒</span> typ_ok_sig <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span> tinstT <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="bound">ty</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">term_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">term_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="free">term_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">term_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">⟷</span> typ_ok_sig <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span> <span class="free">term_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Theory-term_ok'_imp_wf_term"><span class="command">lemma</span></span> term_ok'_imp_wf_term<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="free">t</span> <span class="main">⟹</span> wf_term <span class="free">Σ</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_term.intros <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1" id="Theory-wf_term_imp_term_ok'"><span class="command">lemma</span></span> wf_term_imp_term_ok'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_term <span class="free">Σ</span> <span class="free">t</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_term.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">corollary</span></span> wf_term_iff_term_ok'<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_term <span class="free">Σ</span> <span class="free">t</span> <span class="main">=</span> term_ok' <span class="free">Σ</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> term_ok'_imp_wf_term wf_term_imp_term_ok' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Theory-acyclic_empty"><span class="command">lemma</span></span> acyclic_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"acyclic <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> acyclic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"wf_sig <span class="main">(</span>Map.empty<span class="main">,</span> Map.empty<span class="main">,</span> empty_osig<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coregular_tcsigs_def complete_tcsigs_def consistent_length_tcsigs_def 
      all_normalized_and_ex_tcsigs_def<span class="main">)</span>
<span class="keyword1" id="Theory-term_ok_imp_typ_ok_pre"><span class="command">lemma</span></span> 
  term_ok_imp_typ_ok_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_std_sig <span class="free">Σ</span> <span class="main">⟹</span> wf_term <span class="free">Σ</span> <span class="free">t</span> <span class="main">⟹</span> list_all <span class="main">(</span>typ_ok_sig <span class="free">Σ</span><span class="main">)</span> <span class="free">Ts</span>
  <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span> <span class="main">⟹</span> typ_ok_sig <span class="free">Σ</span> <span class="free">ty</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ty</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typ_of1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">Ts</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv list_all_length <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bodyT</span></span> <span class="keyword2"><span class="keyword">where</span></span> bodyT<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="skolem">T</span><span class="main">#</span><span class="skolem">Ts</span><span class="main">)</span> <span class="skolem">body</span> <span class="main">=</span> Some <span class="skolem">bodyT</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ty</span> <span class="main">=</span> <span class="skolem">T</span> <span class="main">→</span> <span class="skolem">bodyT</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="skolem">bodyT</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> 4 bodyT <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> ty 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Σ</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">Ts</span> <span class="skolem">f</span> <span class="skolem">u</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="skolem">Ts</span> <span class="skolem">u</span> <span class="main">=</span> Some <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> typ_of1_split_App <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="skolem">Ts</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">U</span> <span class="main">→</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5.prems"</span><span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> typ_of1_arg_typ<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="main">(</span><span class="skolem">U</span> <span class="main">→</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5.IH"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"5.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"5.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"5.prems"</span><span class="main">(</span>3<span class="main">)</span> term_ok'.simps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>

<span class="comment1">(* This might now be doable with just prod rules *)</span>
<span class="keyword1" id="Theory-theory_full_exhaust"><span class="command">lemma</span></span> theory_full_exhaust<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">cto</span> <span class="bound">tao</span> <span class="bound">sorts</span> <span class="bound">axioms</span><span class="main">.</span> 
    <span class="free">Θ</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">cto</span><span class="main">,</span> <span class="bound">tao</span><span class="main">,</span> <span class="bound">sorts</span><span class="main">)</span><span class="main">,</span> <span class="bound">axioms</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span>
  <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> Σ axioms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Σ</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">typ_ok</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span> wf_type <span class="main">(</span>sig <span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">term_ok</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> wt_term <span class="main">(</span>sig <span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">corollary</span></span> typ_of_subst_bv_no_change<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">≠</span> None <span class="main">⟹</span> subst_bv <span class="free">u</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> closed_subst_bv_no_change typ_of_imp_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">corollary</span></span> term_ok_subst_bv_no_change<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span> <span class="main">⟹</span> subst_bv <span class="free">u</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typ_of_subst_bv_no_change wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> eq_axs_def <span class="main">=</span> eq_reflexive_ax_def eq_symmetric_ax_def eq_transitive_ax_def eq_intr_ax_def 
  eq_elim_ax_def eq_combination_ax_def eq_abstract_rule_ax_def

<span class="keyword1"><span class="command">bundle</span></span> eq_axs_simp
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">declare</span></span> eq_axs_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> mk_all_list_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> add_vars'_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> bind_eq_Some_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> bind_fv_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Theory-typ_of_eq_ax"><span class="command">lemma</span></span> typ_of_eq_ax<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>eq_reflexive_ax<span class="main">)</span> <span class="main">=</span> Some propT"</span></span> 
    <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>eq_symmetric_ax<span class="main">)</span> <span class="main">=</span> Some propT"</span></span> 
    <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>eq_transitive_ax<span class="main">)</span> <span class="main">=</span> Some propT"</span></span> 
    <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>eq_intr_ax<span class="main">)</span> <span class="main">=</span> Some propT"</span></span> 
    <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>eq_elim_ax<span class="main">)</span> <span class="main">=</span> Some propT"</span></span>
    <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>eq_combination_ax<span class="main">)</span> <span class="main">=</span> Some propT"</span></span> 
    <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>eq_abstract_rule_ax<span class="main">)</span> <span class="main">=</span> Some propT"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typ_of_def eq_axs_def mk_all_list_def add_vars'_def bind_eq_Some_conv bind_fv_def<span class="main">)</span>
  
<span class="keyword1" id="Theory-term_ok_eq_ax"><span class="command">lemma</span></span> term_ok_eq_ax<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_std_sig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>eq_reflexive_ax<span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>eq_symmetric_ax<span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>eq_transitive_ax<span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>eq_intr_ax<span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>eq_elim_ax<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>eq_combination_ax<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>eq_abstract_rule_ax<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">all</span> <span class="quoted">‹<span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main">:</span> theory_full_exhaust›</span><span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def typ_of_def tinstT_def eq_axs_def bind_eq_Some_conv
      bind_fv_def sort_ex_def normalize_sort_def mk_all_list_def add_vars'_def wf_sort_def<span class="main">)</span>

<span class="keyword1" id="Theory-wf_theory_imp_is_std_sig"><span class="command">lemma</span></span> wf_theory_imp_is_std_sig<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> is_std_sig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1" id="Theory-wf_theory_imp_wf_sig"><span class="command">lemma</span></span> wf_theory_imp_wf_sig<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> wf_sig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Theory-term_ok_imp_typ_ok"><span class="command">lemma</span></span> 
  term_ok_imp_typ_ok<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_theory <span class="free">thy</span> <span class="main">⟹</span> term_ok <span class="free">thy</span> <span class="free">t</span> <span class="main">⟹</span> typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span> <span class="main">⟹</span> typ_ok <span class="free">thy</span> <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">thy</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> term_ok_imp_typ_ok_pre term_ok_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.pred_inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wt_term_def wf_theory_imp_is_std_sig typ_of_def typ_ok_def wf_type_iff_typ_ok_sig<span class="main">)</span>

<span class="keyword1" id="Theory-axioms_terms_ok"><span class="command">lemma</span></span> axioms_terms_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">thy</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">∈</span>axioms <span class="free">thy</span> <span class="main">⟹</span> term_ok <span class="free">thy</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">thy</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Theory-axioms_typ_of_propT"><span class="command">lemma</span></span> axioms_typ_of_propT<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">thy</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">∈</span>axioms <span class="free">thy</span> <span class="main">⟹</span> typ_of <span class="free">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword1"><span class="command">using</span></span> has_typ_iff_typ_of <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">thy</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Theory-propT_ok"><span class="command">lemma</span></span> propT_ok<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> typ_ok <span class="free">Θ</span> propT"</span></span>
  <span class="keyword1"><span class="command">using</span></span> term_ok_imp_typ_ok wf_theory.elims<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sig.simps term_ok_eq_ax<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> typ_of_eq_ax<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Theory-term_ok_mk_eqD"><span class="command">lemma</span></span> term_ok_mk_eqD<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_eq <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="free">s</span> <span class="main">∧</span> term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> term_ok'.simps<span class="main">(</span>4<span class="main">)</span> wt_term_def typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>
<span class="keyword1" id="Theory-term_ok_app_eqD"><span class="command">lemma</span></span> term_ok_app_eqD<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span><span class="free">s</span> <span class="main">$</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="free">s</span> <span class="main">∧</span> term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> term_ok'.simps<span class="main">(</span>4<span class="main">)</span> wt_term_def typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>

<span class="keyword1" id="Theory-wf_type_Type_imp_mgd"><span class="command">lemma</span></span> wf_type_Type_imp_mgd<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"wf_sig <span class="free">Σ</span> <span class="main">⟹</span> wf_type <span class="free">Σ</span> <span class="main">(</span>Ty <span class="free">n</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">⟹</span> tcsigs <span class="main">(</span>osig <span class="free">Σ</span><span class="main">)</span> <span class="free">n</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Σ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Theory-term_ok_eta_expand"><span class="command">lemma</span></span> term_ok_eta_expand<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms typ_of_eta_expand <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>

<span class="keyword1" id="Theory-term_ok'_incr_bv"><span class="command">lemma</span></span> term_ok'_incr_bv<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="free">t</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="main">(</span>incr_bv <span class="free">inc</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">inc</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> incr_bv.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Theory-term_ok'_subst_bv2"><span class="command">lemma</span></span> term_ok'_subst_bv2<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="free">s</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">u</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="main">(</span>subst_bv2 <span class="free">s</span> <span class="free">lev</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bv2.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> term_ok'_incr_bv<span class="main">)</span>

<span class="keyword1" id="Theory-term_ok'_subst_bv"><span class="command">lemma</span></span> term_ok'_subst_bv<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">T</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substn_subst_0' term_ok'_subst_bv2<span class="main">)</span>
<span class="keyword1" id="Theory-term_ok_subst_bv"><span class="command">lemma</span></span> term_ok_subst_bv<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">T</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> term_ok'_subst_bv wt_term_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> subst_bv_def typ_of1_subst_bv_gen' typ_of_Abs_body_typ' typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Theory-term_ok_subst_bv2_0"><span class="command">lemma</span></span> term_ok_subst_bv2_0<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bv2 <span class="free">t</span> <span class="main">0</span> <span class="main">(</span>Fv <span class="free">x</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> term_ok'_subst_bv2 wt_term_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> substn_subst_0' typ_of1_subst_bv_gen' typ_of_Abs_body_typ' typ_of_def
    wt_term_def term_ok_subst_bv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Theory-has_sort_empty"><span class="command">lemma</span></span> has_sort_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_sig <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_type <span class="free">Σ</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>osig <span class="free">Σ</span><span class="main">)</span> <span class="free">T</span> full_sort"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cl</span></span> <span class="skolem"><span class="skolem">tcs</span></span> <span class="keyword2"><span class="keyword">where</span></span> cltcs<span class="main">:</span> <span class="quoted"><span class="quoted">"osig <span class="free">Σ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">cl</span><span class="main">,</span> <span class="skolem">tcs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mgd</span></span> <span class="keyword2"><span class="keyword">where</span></span> mgd<span class="main">:</span> <span class="quoted"><span class="quoted">"tcsigs <span class="main">(</span>osig <span class="free">Σ</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">mgd</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_type_Type_imp_mgd assms Ty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> mgd cltcs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ty <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_sort_Ty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">v</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"osig <span class="free">Σ</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sort_leq_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Theory-typ_Fv_of_full_sort"><span class="command">lemma</span></span> typ_Fv_of_full_sort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="main">(</span>Fv <span class="free">v</span> <span class="free">T</span><span class="main">)</span> <span class="main">⟹</span> has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> full_sort"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def wf_theory_imp_wf_sig<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Term_Subst">
<div class="head">
<h1>Theory Term_Subst</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"More on Substitutions"</span></span>

<span class="comment1">(*
  Originally for stuff from Term_Subst.ML

  Now has little do to with it and contains stuff about various substitutions in general
  Problem: Inconsistent naming
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Term_Subst
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Term">Term</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst_typ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">×</span> typ<span class="main">)</span> list <span class="main">⇒</span> typ <span class="main">⇒</span> typ"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_typ</span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">=</span> 
    Ty <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="free">subst_typ</span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_typ</span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="main">(</span>Tv <span class="free"><span class="bound"><span class="entity">idn</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> the_default <span class="main">(</span>Tv <span class="free"><span class="bound"><span class="entity">idn</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> 
    <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">idn</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term_Subst-subst_typ_nil"><span class="command">lemma</span></span> subst_typ_nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">[]</span> <span class="free">T</span> <span class="main">=</span> <span class="free">T</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_idI<span class="main">)</span>
 
<span class="keyword1" id="Term_Subst-subst_typ_irrelevant_order"><span class="command">lemma</span></span> subst_typ_irrelevant_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">pairs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">pairs'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">pairs</span> <span class="main">=</span> set <span class="free">pairs'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="free">pairs</span> <span class="free">T</span> <span class="main">=</span> subst_typ <span class="free">pairs'</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> lookup_eq_order_irrelevant <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_typ.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Core lemma, Isabelle/Pure's instantiateT_same function can simulate abstract type subtitutions 
  in types *)</span>
<span class="keyword1" id="Term_Subst-subst_typ_simulates_tsubstT_gen'"><span class="command">lemma</span></span> subst_typ_simulates_tsubstT_gen'<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">l</span> <span class="main">⟹</span> tvsT <span class="free">T</span> <span class="main">⊆</span> set <span class="free">l</span> 
  <span class="main">⟹</span> tsubstT <span class="free">T</span> <span class="free">ρ</span> <span class="main">=</span> subst_typ <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta map_idI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> el<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Tv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> lookup_present_eq_key<span class="main">,</span> <span class="operator">OF</span> _ el<span class="main">]</span>  Tv.prems d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_Subst-subst_typ_simulates_tsubstT_gen"><span class="command">lemma</span></span> subst_typ_simulates_tsubstT_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"tsubstT <span class="free">T</span> <span class="free">ρ</span> 
  <span class="main">=</span> subst_typ <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">l</span> <span class="main">.</span> distinct <span class="bound">l</span> <span class="main">∧</span> tvsT <span class="free">T</span> <span class="main">⊆</span> set <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> distinct <span class="bound">a</span> <span class="main">∧</span> tvsT <span class="free">T</span> <span class="main">⊆</span> set <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_tvsT finite_distinct_list
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">l</span> <span class="main">∧</span> tvsT <span class="free">T</span> <span class="main">⊆</span> set <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tsubstT <span class="free">T</span> <span class="free">ρ</span> <span class="main">=</span> subst_typ <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_typ_simulates_tsubstT_gen' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> subst_typ_simulates_tsubstT<span class="main">:</span> <span class="quoted"><span class="quoted">"tsubstT <span class="free">T</span> <span class="free">ρ</span> 
  <span class="main">=</span> subst_typ <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">l</span> <span class="main">.</span> distinct <span class="bound">l</span> <span class="main">∧</span> set <span class="bound">l</span> <span class="main">=</span> tvsT <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> finite_tvsT finite_distinct_list <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">using</span></span> subst_typ_simulates_tsubstT_gen' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* Other direction, can construct a abstract substitution for one performed by instantiateT_same *)</span>
<span class="keyword1" id="Term_Subst-tsubstT_simulates_subst_typ"><span class="command">lemma</span></span> tsubstT_simulates_subst_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ <span class="free">insts</span> <span class="free">T</span>
  <span class="main">=</span> tsubstT <span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">idn</span> <span class="bound">S</span> <span class="main">.</span> the_default <span class="main">(</span>Tv <span class="bound">idn</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="free">insts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* Somewhat janky version of "composition" for subst_typ *)</span>
<span class="keyword1" id="Term_Subst-subst_typ_comp"><span class="command">lemma</span></span> subst_typ_comp<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"subst_typ <span class="free">inst1</span> <span class="main">(</span>subst_typ <span class="free">inst2</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> subst_typ <span class="main">(</span>map <span class="main">(</span>apsnd <span class="main">(</span>subst_typ <span class="free">inst1</span><span class="main">)</span><span class="main">)</span> <span class="free">inst2</span> <span class="main">@</span> <span class="free">inst1</span><span class="main">)</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">inst2</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">inst1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_typ.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">insts</span> <span class="skolem">a</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">insts</span> <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">insts</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(* To make insts distinct again *)</span>
<span class="keyword1" id="Term_Subst-subst_typ_AList_clearjunk"><span class="command">lemma</span></span> subst_typ_AList_clearjunk<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ <span class="free">insts</span> <span class="free">T</span> <span class="main">=</span> subst_typ <span class="main">(</span>AList.clearjunk <span class="free">insts</span><span class="main">)</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">n</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">inst</span> <span class="skolem">insts</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> clearjunk.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lookup_AList_clearjunk<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst_type_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">×</span> typ<span class="main">)</span> list <span class="main">⇒</span> 
    <span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> typ<span class="main">)</span> <span class="main">×</span> term<span class="main">)</span> list <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_type_term</span> <span class="free"><span class="bound"><span class="entity">instT</span></span></span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> Ct <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>subst_typ <span class="free"><span class="bound"><span class="entity">instT</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_type_term</span> <span class="free"><span class="bound"><span class="entity">instT</span></span></span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">idn</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">T'</span> <span class="main">=</span> subst_typ <span class="free"><span class="bound"><span class="entity">instT</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">in</span>
    the_default <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">idn</span></span></span> <span class="bound">T'</span><span class="main">)</span> <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">idn</span></span></span><span class="main">,</span> <span class="bound">T'</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_type_term</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Bv <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_type_term</span> <span class="free"><span class="bound"><span class="entity">instT</span></span></span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Abs <span class="main">(</span>subst_typ <span class="free"><span class="bound"><span class="entity">instT</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">subst_type_term</span> <span class="free"><span class="bound"><span class="entity">instT</span></span></span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_type_term</span> <span class="free"><span class="bound"><span class="entity">instT</span></span></span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">subst_type_term</span> <span class="free"><span class="bound"><span class="entity">instT</span></span></span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free">subst_type_term</span> <span class="free"><span class="bound"><span class="entity">instT</span></span></span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1" id="Term_Subst-subst_type_term_empty_no_change"><span class="command">lemma</span></span> subst_type_term_empty_no_change<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_type_term <span class="main">[]</span> <span class="main">[]</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>

<span class="keyword1" id="Term_Subst-subst_type_term_irrelevant_order"><span class="command">lemma</span></span> subst_type_term_irrelevant_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> instT_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">instT</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">instT'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">instT</span> <span class="main">=</span> set <span class="free">instT'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> insts_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">insts'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">insts</span> <span class="main">=</span> set <span class="free">insts'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_type_term <span class="free">instT</span> <span class="free">insts</span> <span class="free">t</span> <span class="main">=</span> subst_type_term <span class="free">instT'</span> <span class="free">insts'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">idn</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def subst_typ_irrelevant_order<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Fv.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1-3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> lookup_eq_order_irrelevant <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Fv.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Fv.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> insts_assms<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_typ_irrelevant_order<span class="main">[</span><span class="operator">OF</span> instT_assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_typ_irrelevant_order<span class="main"><span class="main">[</span></span><span class="operator">OF</span> instT_assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="comment1">(* Core lemma, Isabelle/Pure's instantiate_same function can simulate abstract 
  term/type subtitutions in terms 

  The tsubst should be no problem, can be rewritten to subst_type using previous simulation lemma
*)</span>
<span class="keyword1" id="Term_Subst-subst_type_term_simulates_subst_tsubst_gen'"><span class="command">lemma</span></span> subst_type_term_simulates_subst_tsubst_gen'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lty_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">lty</span>"</span></span> <span class="quoted"><span class="quoted">"tvs <span class="free">t</span> <span class="main">⊆</span> set <span class="free">lty</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lt_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">lt</span>"</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>tsubst <span class="free">t</span> <span class="free">ρty</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">lt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>tsubst <span class="free">t</span> <span class="free">ρty</span><span class="main">)</span> <span class="free">ρt</span> 
    <span class="main">=</span> subst_type_term <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρty</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">lty</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρt</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">lt</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lty</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρty</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">lty</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> p1ty<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="var">?lty</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lty_assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta map_idI<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρt</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">lt</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> p1t<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="var">?lt</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lt_assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta map_idI<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lty</span></span> <span class="quoted"><span class="free">lt</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">idn</span> <span class="skolem">T</span><span class="main">)</span>
  
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tsubstT <span class="skolem">T</span> <span class="free">ρty</span>"</span></span>  
    <span class="keyword1"><span class="command">have</span></span> el<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="var">?T</span><span class="main">)</span><span class="main">,</span> <span class="free">ρt</span> <span class="skolem">idn</span> <span class="var">?T</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρt</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">lt</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρt</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">lt</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Fv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta map_idI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span>  Fv.prems d 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lookup_present_eq_key<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> d el<span class="main"><span class="main">]</span></span> 
          subst_typ_simulates_tsubstT_gen'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_typ_simulates_tsubstT_gen'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> subst_type_term_simulates_subst_tsubst<span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>tsubst <span class="free">t</span> <span class="free">ρty</span><span class="main">)</span> <span class="free">ρt</span> 
    <span class="main">=</span> subst_type_term <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρty</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">lty</span> <span class="main">.</span> distinct <span class="bound">lty</span> <span class="main">∧</span> tvs <span class="free">t</span> <span class="main">=</span> set <span class="bound">lty</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρt</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">lt</span> <span class="main">.</span> distinct <span class="bound">lt</span> <span class="main">∧</span> fv <span class="main">(</span>tsubst <span class="free">t</span> <span class="free">ρty</span><span class="main">)</span> <span class="main">=</span> set <span class="bound">lt</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> finite_fv finite_distinct_list <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> finite_tvs finite_distinct_list <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">using</span></span> subst_type_term_simulates_subst_tsubst_gen' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst_typ'</span> <span class="free"><span class="bound"><span class="entity">pairs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> map_types <span class="main">(</span>subst_typ <span class="free"><span class="bound"><span class="entity">pairs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Term_Subst-subst_typ'_nil"><span class="command">lemma</span></span> subst_typ'_nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ' <span class="main">[]</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>

<span class="keyword1" id="Term_Subst-subst_typ'_simulates_tsubst_gen'"><span class="command">lemma</span></span> subst_typ'_simulates_tsubst_gen'<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">pairs</span> <span class="main">⟹</span> tvs <span class="free">t</span> <span class="main">⊆</span> set <span class="free">pairs</span>
  <span class="main">⟹</span> tsubst <span class="free">t</span> <span class="free">ρ</span> <span class="main">=</span> subst_typ' <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">pairs</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">pairs</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span> 
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_typ_simulates_tsubstT_gen'<span class="main">)</span>

<span class="keyword1" id="Term_Subst-subst_typ'_simulates_tsubst_gen"><span class="command">lemma</span></span> subst_typ'_simulates_tsubst_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"tsubst <span class="free">t</span> <span class="free">ρ</span> 
  <span class="main">=</span> subst_typ' <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">l</span> <span class="main">.</span> distinct <span class="bound">l</span> <span class="main">∧</span> tvs <span class="free">t</span> <span class="main">⊆</span> set <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> distinct <span class="bound">a</span> <span class="main">∧</span> tvs <span class="free">t</span> <span class="main">⊆</span> set <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_tvs finite_distinct_list
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">l</span> <span class="main">∧</span> tvs <span class="free">t</span> <span class="main">⊆</span> set <span class="skolem">l</span>"</span></span>
  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tsubst <span class="free">t</span> <span class="free">ρ</span> <span class="main">=</span> subst_typ' <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_typ'_simulates_tsubst_gen' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_Subst-tsubst_simulates_subst_typ'"><span class="command">lemma</span></span> tsubst_simulates_subst_typ'<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ' <span class="free">insts</span> <span class="free">T</span>
  <span class="main">=</span> tsubst <span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">idn</span> <span class="bound">S</span> <span class="main">.</span> the_default <span class="main">(</span>Tv <span class="bound">idn</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="free">insts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tsubstT_simulates_subst_typ<span class="main">)</span>

<span class="comment1">(* 
  Naming! 
*)</span>
<span class="keyword1" id="Term_Subst-subst_type_add_degenerate_instance"><span class="command">lemma</span></span> subst_type_add_degenerate_instance<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">idx</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">⟹</span> subst_typ <span class="free">insts</span> <span class="free">T</span> <span class="main">=</span> subst_typ <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">idx</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">idx</span> <span class="free">s</span><span class="main">)</span><span class="main">#</span><span class="free">insts</span><span class="main">)</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_eq_key_not_present<span class="main">)</span>

<span class="keyword1" id="Term_Subst-subst_typ'_add_degenerate_instance"><span class="command">lemma</span></span> subst_typ'_add_degenerate_instance<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">idx</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">⟹</span> subst_typ' <span class="free">insts</span> <span class="free">t</span> <span class="main">=</span> subst_typ' <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">idx</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">idx</span> <span class="free">s</span><span class="main">)</span><span class="main">#</span><span class="free">insts</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_type_add_degenerate_instance<span class="main">)</span>

<span class="comment1">(* Again, janky composition *)</span>
<span class="keyword1" id="Term_Subst-subst_typ'_comp"><span class="command">lemma</span></span> subst_typ'_comp<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"subst_typ' <span class="free">inst1</span> <span class="main">(</span>subst_typ' <span class="free">inst2</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> subst_typ' <span class="main">(</span>map <span class="main">(</span>apsnd <span class="main">(</span>subst_typ <span class="free">inst1</span><span class="main">)</span><span class="main">)</span> <span class="free">inst2</span> <span class="main">@</span> <span class="free">inst1</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> subst_typ_comp <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* To make insts distinct again *)</span>
<span class="keyword1" id="Term_Subst-subst_typ'_AList_clearjunk"><span class="command">lemma</span></span> subst_typ'_AList_clearjunk<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ' <span class="free">insts</span> <span class="free">t</span> <span class="main">=</span> subst_typ' <span class="main">(</span>AList.clearjunk <span class="free">insts</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> subst_typ_AList_clearjunk <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>variable <span class="main">*</span> typ<span class="main">)</span> <span class="main">*</span> term<span class="main">)</span> list <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_term</span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> Ct <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_term</span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">idn</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> the_default <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">idn</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">idn</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_term</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Bv <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_term</span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free">subst_term</span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_term</span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">subst_term</span>  <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free">subst_term</span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1" id="Term_Subst-subst_term_empty_no_change"><span class="command">lemma</span></span> subst_term_empty_no_change<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_term <span class="main">[]</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Subst-subst_type_term_without_type_insts_eq_subst_term"><span class="command">lemma</span></span> subst_type_term_without_type_insts_eq_subst_term<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"subst_type_term <span class="main">[]</span> <span class="free">insts</span> <span class="free">t</span> <span class="main">=</span> subst_term <span class="free">insts</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_term.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Term_Subst-subst_type_term_split_levels"><span class="command">lemma</span></span> subst_type_term_split_levels<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"subst_type_term <span class="free">instT</span> <span class="free">insts</span> <span class="free">t</span> <span class="main">=</span> subst_term <span class="free">insts</span> <span class="main">(</span>subst_typ' <span class="free">instT</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="comment1">(* Express parallel substitution as a series of single substitutions. *)</span>

<span class="comment1">(* Deleted assms in the induction once, recheck proofs, maybe some get easier. *)</span>
<span class="keyword1" id="Term_Subst-subst_typ_stepwise"><span class="command">lemma</span></span> subst_typ_stepwise<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">instT</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">instT</span> <span class="main">.</span> tvsT <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">instT</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="free">instT</span> <span class="free">T</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="free">instT</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">instT</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_typ.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">inst</span> <span class="skolem">a</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">inst</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">inst</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="skolem">inst</span> <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="skolem">inst</span> <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">Ts</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="skolem">inst</span> <span class="skolem">T</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="skolem">inst</span> <span class="skolem">T</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Cons 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="skolem">inst</span> <span class="main">(</span>Ty <span class="skolem">a</span> <span class="main">(</span><span class="skolem">T</span><span class="main">#</span><span class="skolem">Ts</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> <span class="main">(</span>Ty <span class="skolem">a</span> <span class="main">(</span>map <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="skolem">inst</span><span class="main">)</span> <span class="main">(</span><span class="skolem">T</span><span class="main">#</span><span class="skolem">Ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">inst</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">a</span> <span class="main">(</span><span class="skolem">T</span> <span class="main">#</span> <span class="skolem">Ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        Ty <span class="skolem">a</span> <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">T</span> <span class="main">#</span> <span class="skolem">Ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> Cons.prems<span class="main">(</span>2<span class="main">)</span> local.Cons<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">inst</span> <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">inst</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">p</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">∈</span>set <span class="skolem">inst</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_None_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">[</span><span class="skolem">p</span><span class="main">]</span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> Tv <span class="skolem">idn</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">∈</span>set <span class="skolem">inst</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> 
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> this None <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">inst</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">inst</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Some lookup_present_eq_key'' 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">inst</span> <span class="main">=</span> <span class="skolem">fs</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> split_list<span class="main">)</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">p</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">∈</span>set <span class="skolem">fs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> 
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> id_subst_fs<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">[</span><span class="skolem">p</span><span class="main">]</span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> Tv <span class="skolem">idn</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">∈</span>set <span class="skolem">fs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> fs_step<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="skolem">fs</span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> Tv <span class="skolem">idn</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">fs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> change_step<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> bs_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">bs</span> <span class="main">⊆</span> set <span class="skolem">inst</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="skolem">bs</span>"</span></span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>tvsT <span class="main">`</span> snd <span class="main">`</span> set <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> 2 that split <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="skolem">bs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> tvsT <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
      <span class="keyword1"><span class="command">using</span></span> that 2 elem bs_sub <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
    
    <span class="keyword1"><span class="command">hence</span></span> id_subst_bs<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">[</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">bs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induction</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">n</span> <span class="skolem">S</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> bs_step<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="skolem">bs</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> fs_step change_step bs_step split Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> subst_typ_split_first<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">.</span> tvsT <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">T</span> <span class="main">=</span> subst_typ <span class="free">xs</span> <span class="main">(</span>subst_typ <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">T</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">T</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms subst_typ_stepwise <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span> <span class="main">(</span>subst_typ <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst_typ <span class="free">xs</span> <span class="main">(</span>subst_typ <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms subst_typ_stepwise <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> subst_typ_split_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> tvsT <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">T</span> <span class="main">=</span> subst_typ <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">(</span>subst_typ <span class="free">xs</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">T</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">T</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms subst_typ_stepwise <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst_typ <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst_typ <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">(</span>subst_typ <span class="free">xs</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms subst_typ_stepwise <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_Subst-subst_typ'_stepwise"><span class="command">lemma</span></span> subst_typ'_stepwise<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">instT</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span>set <span class="free">instT</span><span class="main">)</span> <span class="main">.</span> tvsT <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="free">instT</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_typ' <span class="free">instT</span> <span class="free">t</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_typ' <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="free">instT</span> <span class="free">t</span>"</span></span>
<span class="comment1">(* I switched the order of inductions and 99% of the proof vanished *)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">instT</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> subst_typ_split_last <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> map_types.simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="comment1">(* ... *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Term_Subst-subst_term_stepwise"><span class="command">lemma</span></span> subst_term_stepwise<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span>set <span class="free">insts</span><span class="main">)</span> <span class="main">.</span> fv <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="free">insts</span> <span class="free">t</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="free">insts</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">idn</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="comment1">(* Allows more direct copy paste, hide structure of list, do proof properly later *)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">insts</span></span> <span class="keyword2"><span class="keyword">where</span></span> insts_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">insts</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> insts_thm1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insts_def snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> insts_thm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="skolem">insts</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> snd <span class="main">`</span> set <span class="skolem">insts</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> insts_def snoc that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> Fv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="comment1">(* Proof copied from subst_typ *)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="skolem">insts</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">p</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">∈</span>set <span class="skolem">insts</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_None_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="main">[</span><span class="skolem">p</span><span class="main">]</span> <span class="main">(</span>Fv <span class="skolem">idn</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> Fv <span class="skolem">idn</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">∈</span>set <span class="skolem">insts</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> 
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> this None <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> insts_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">insts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
  
      <span class="keyword1"><span class="command">have</span></span> elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">insts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Some lookup_present_eq_key'' insts_thm1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">insts</span> <span class="main">=</span> <span class="skolem">fs</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> split_list<span class="main">)</span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insts_thm1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">p</span> <span class="main">~=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">∈</span>set <span class="skolem">fs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> 
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> id_subst_fs<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_term <span class="main">[</span><span class="skolem">p</span><span class="main">]</span> <span class="main">(</span>Fv <span class="skolem">idn</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> Fv <span class="skolem">idn</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">∈</span>set <span class="skolem">fs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">hence</span></span> fs_step<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="skolem">fs</span> <span class="main">(</span>Fv <span class="skolem">idn</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> Fv <span class="skolem">idn</span> <span class="skolem">T</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">fs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  
      <span class="keyword1"><span class="command">have</span></span> change_step<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Fv <span class="skolem">idn</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
      <span class="keyword1"><span class="command">have</span></span> bs_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">bs</span> <span class="main">⊆</span> set <span class="skolem">insts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="skolem">bs</span>"</span></span> 
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> snd <span class="main">`</span> set <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">using</span></span> insts_thm2 that split <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="skolem">bs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> fv <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
        <span class="keyword1"><span class="command">using</span></span> that insts_thm2 elem bs_sub <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      
      <span class="keyword1"><span class="command">hence</span></span> id_subst_bs<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_term <span class="main">[</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">∈</span>set <span class="skolem">bs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induction</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> bs_step<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="skolem">bs</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span> <span class="operator">auto</span>
  
      <span class="keyword1"><span class="command">from</span></span> fs_step change_step bs_step split Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insts_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> subst_term.simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> subst_term_split_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> fv <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> subst_term <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">(</span>subst_term <span class="free">xs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms subst_term_stepwise <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst_term <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst_term <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">(</span>subst_term <span class="free">xs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms subst_term_stepwise <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> subst_type_term_stepwise<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">instT</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">T</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span>set <span class="free">instT</span><span class="main">)</span> <span class="main">.</span> tvsT <span class="bound">T</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="free">instT</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span>set <span class="free">insts</span><span class="main">)</span> <span class="main">.</span> fv <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_type_term <span class="free">instT</span> <span class="free">insts</span> <span class="free">t</span> 
    <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="free">insts</span> <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="main">.</span> subst_typ' <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="free">instT</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms subst_typ'_stepwise subst_term_stepwise subst_type_term_split_levels <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* MOVE *)</span>
<span class="keyword1" id="Term_Subst-distinct_fst_imp_distinct"><span class="command">lemma</span></span> distinct_fst_imp_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">l</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Term_Subst-distinct_kv_list"><span class="command">lemma</span></span> distinct_kv_list<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">l</span> <span class="main">⟹</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Subst-subst_subst_term"><span class="command">lemma</span></span> subst_subst_term<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fv <span class="free">t</span> <span class="main">⊆</span> set <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="free">ρ</span> <span class="main">=</span> subst_term <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> case_prod <span class="free">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">idn</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="skolem">idn</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> case_prod <span class="free">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> case_prod <span class="free">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Fv<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> Some <span class="main">(</span><span class="free">ρ</span> <span class="skolem">idn</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lookup_present_eq_key <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1" id="Term_Subst-subst_term_subst"><span class="command">lemma</span></span> subst_term_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="free">l</span> <span class="free">t</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="bound">idn</span> <span class="main">∧</span><span class="bound">y</span><span class="main">=</span><span class="bound">T</span> <span class="keyword1">then</span> <span class="bound">t</span> <span class="keyword1">else</span> <span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">l</span> Fv<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">idn</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> lookup_None_iff<span class="main">)</span>
    
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="bound">idn</span> <span class="main">∧</span><span class="bound">y</span><span class="main">=</span><span class="bound">T</span> <span class="keyword1">then</span> <span class="bound">t</span> <span class="keyword1">else</span> <span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">l</span> Fv<span class="main">)</span> <span class="skolem">idn</span> <span class="skolem">T</span> <span class="main">=</span> Fv <span class="skolem">idn</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span> 
      
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> None<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">l</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Some lookup_present_eq_key'' Fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="skolem">fs</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> split_list<span class="main">)</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> not_in_bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">p</span> <span class="main">~=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">∈</span>set <span class="skolem">fs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> 
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> fs_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="bound">idn</span> <span class="main">∧</span><span class="bound">y</span><span class="main">=</span><span class="bound">T</span> <span class="keyword1">then</span> <span class="bound">t</span> <span class="keyword1">else</span> <span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">fs</span> Fv<span class="main">)</span> <span class="skolem">idn</span> <span class="skolem">T</span> <span class="main">=</span> Fv <span class="skolem">idn</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> bs_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">bs</span> <span class="main">⊆</span> set <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">p</span> <span class="main">~=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">∈</span>set <span class="skolem">bs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> 
      <span class="keyword1"><span class="command">using</span></span> that not_in_bs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> bs_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="bound">idn</span> <span class="main">∧</span><span class="bound">y</span><span class="main">=</span><span class="bound">T</span> <span class="keyword1">then</span> <span class="bound">t</span> <span class="keyword1">else</span> <span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">bs</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">idn</span> <span class="skolem">T</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">idn</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">from</span></span> fs_step bs_step split Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Subst-subst_typ_combine_single"><span class="command">lemma</span></span> subst_typ_combine_single<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">fresh_idn</span> <span class="main">∉</span> fst <span class="main">`</span> tvsT <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">fresh_idn</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">,</span> <span class="free">τ2</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>subst_typ <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">idn</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">fresh_idn</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="free">τ</span><span class="main">)</span>
    <span class="main">=</span> subst_typ <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">idn</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">,</span> <span class="free">τ2</span><span class="main">)</span><span class="main">]</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">τ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Subst-subst_typ_combine"><span class="command">lemma</span></span> subst_typ_combine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">fresh_idns</span> <span class="main">=</span> length <span class="free">insts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">fresh_idns</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idn</span> <span class="main">∈</span> set <span class="free">fresh_idns</span> <span class="main">.</span> <span class="bound">idn</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>tvsT <span class="free">τ</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ty</span><span class="main">∈</span>snd <span class="main">`</span> set <span class="free">insts</span> <span class="main">.</span> <span class="main">(</span>tvsT <span class="bound">ty</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">∪</span> <span class="main">(</span>fst <span class="main">`</span> set <span class="free">insts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="free">insts</span> <span class="free">τ</span> 
    <span class="main">=</span> subst_typ <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>subst_typ <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">fresh_idns</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_typ.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">inst</span> <span class="skolem">a</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> <span class="comment1">(* LOL, I wanted to do another induction *)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">inst</span> <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inst</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="skolem">inst</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> list.set_map lookup_None_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">inst</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">inst</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_eq_key_not_present<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">inst</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 set_zip_leftD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">inst</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">inst</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_eq_key_not_present<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> None 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">ty</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> idx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">inst</span> <span class="main">!</span> <span class="skolem">idx</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> length <span class="skolem">inst</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">inst</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span> <span class="keyword1"><span class="command">thm</span></span> Cons.IH
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">idx</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">!</span> <span class="bound">idx</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">idx</span> <span class="main">&lt;</span> length <span class="skolem">as</span> <span class="main">⟹</span> <span class="skolem">thesis</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> in_set_conv_nth list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> in_set_conv_nth lookup_present_eq_key'<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fresh_idn</span></span> <span class="keyword2"><span class="keyword">where</span></span> fresh_idn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fresh_idns</span> <span class="main">!</span> <span class="skolem">idx</span> <span class="main">=</span> <span class="skolem">fresh_idn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>1<span class="main">)</span> idx fresh_idn <span class="keyword1"><span class="command">have</span></span> ren<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">inst</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">inst</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">idx</span> 
      <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="skolem">fresh_idn</span> <span class="skolem">S</span><span class="main">)</span> "</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this idx<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="skolem">fresh_idn</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> set
      <span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">inst</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">inst</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> length_map map_fst_zip map_map map_snd_zip nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">inst</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">inst</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>Tv <span class="skolem">fresh_idn</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lookup_present_eq_key''<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>1<span class="main">)</span> idx fresh_idn 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">fresh_idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span> 
      <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">inst</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">inst</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">fresh_idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">inst</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">inst</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">ty</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> distinct_zipI1 lookup_present_eq_key''<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Some 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_Subst-subst_typ_combine'"><span class="command">lemma</span></span> subst_typ_combine'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">fresh_idns</span> <span class="main">=</span> length <span class="free">insts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">fresh_idns</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idn</span> <span class="main">∈</span> set <span class="free">fresh_idns</span> <span class="main">.</span> <span class="bound">idn</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>tvsT <span class="free">τ</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ty</span><span class="main">∈</span>snd <span class="main">`</span> set <span class="free">insts</span> <span class="main">.</span> <span class="main">(</span>tvsT <span class="bound">ty</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">∪</span> <span class="main">(</span>fst <span class="main">`</span> set <span class="free">insts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="free">insts</span> <span class="free">τ</span> 
    <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> fst <span class="main">`</span> set <span class="free">insts</span> "</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> set <span class="main">(</span>map fst <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> map_fst_zip assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free">insts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> set <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> map_snd_zip assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_set length_map<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>tvsT <span class="main">`</span> snd <span class="main">`</span> set <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>tvsT <span class="main">`</span> set <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> this <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>tvsT <span class="main">`</span> snd <span class="main">`</span> set <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span>set <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fresh_idns</span></span> <span class="quoted"><span class="free">insts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> s3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>tvsT <span class="main">`</span> snd <span class="main">`</span> set <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>
                   <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> set <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idn</span> <span class="main">∉</span> fst <span class="main">`</span> fst <span class="main">`</span> set <span class="free">insts</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idn</span> <span class="main">∈</span> set <span class="free">fresh_idns</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">idn</span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">insts</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idn</span> <span class="main">∈</span> set <span class="free">fresh_idns</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">idn</span> <span class="skolem">S</span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv image_eqI<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> u1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subst_typ <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">τ</span><span class="main">)</span>
    <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">τ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_typ_stepwise<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> s1 s2<span class="main">)</span>  
     <span class="keyword1"><span class="command">using</span></span> assms I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse set_zip_leftD<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> u2<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>subst_typ <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">τ</span><span class="main">)</span>
  <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>subst_typ <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_typ_stepwise<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_zipI1<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> assms
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> UnCI imageE image_eqI length_map map_snd_zip prod.collapse set_map set_zip_leftD<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>subst_typ <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">τ</span><span class="main">)</span>
   <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_typ <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms subst_typ_combine unfold <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_Subst-subst_typ'_combine"><span class="command">lemma</span></span> subst_typ'_combine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">fresh_idns</span> <span class="main">=</span> length <span class="free">insts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">fresh_idns</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idn</span> <span class="main">∈</span> set <span class="free">fresh_idns</span> <span class="main">.</span> <span class="bound">idn</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>tvs <span class="free">t</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ty</span><span class="main">∈</span>snd <span class="main">`</span> set <span class="free">insts</span> <span class="main">.</span> <span class="main">(</span>tvsT <span class="bound">ty</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">∪</span> <span class="main">(</span>fst <span class="main">`</span> set <span class="free">insts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_typ' <span class="free">insts</span> <span class="free">t</span>
    <span class="main">=</span> subst_typ' <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>subst_typ' <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">fresh_idns</span></span> <span class="quoted"><span class="free">insts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tvs <span class="skolem">t</span> <span class="main">⊆</span> tvs <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_typ' <span class="skolem">insts</span> <span class="skolem">t</span> <span class="main">=</span>
    subst_typ' <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>subst_typ' <span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="skolem">insts</span> <span class="skolem">T</span> <span class="main">=</span>
    subst_typ <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>subst_typ <span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_typ_combine Abs.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tvs <span class="skolem">t1</span> <span class="main">⊆</span> tvs <span class="main">(</span><span class="skolem">t1</span> <span class="main">$</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"tvs <span class="skolem">t2</span> <span class="main">⊆</span> tvs <span class="main">(</span><span class="skolem">t1</span> <span class="main">$</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_typ' <span class="skolem">insts</span> <span class="skolem">t1</span> <span class="main">=</span>
    subst_typ' <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>subst_typ' <span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t1</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"subst_typ' <span class="skolem">insts</span> <span class="skolem">t2</span> <span class="main">=</span>
    subst_typ' <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>subst_typ' <span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span> <span class="main">(</span>map2 Tv <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> subst_typ_combine <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* Only interesting case is Fv, and that one is copied directly from subst_typ *)</span>
<span class="keyword1" id="Term_Subst-subst_term_combine"><span class="command">lemma</span></span> subst_term_combine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">fresh_idns</span> <span class="main">=</span> length <span class="free">insts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">fresh_idns</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idn</span> <span class="main">∈</span> set <span class="free">fresh_idns</span> <span class="main">.</span> <span class="bound">idn</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>fv <span class="free">t</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>snd <span class="main">`</span> set <span class="free">insts</span> <span class="main">.</span> <span class="main">(</span>fv <span class="bound">t</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">∪</span> <span class="main">(</span>fst <span class="main">`</span> set <span class="free">insts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="free">insts</span> <span class="free">t</span>
    <span class="main">=</span> subst_term <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>subst_term <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">fresh_idns</span></span> <span class="quoted"><span class="free">insts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">idn</span> <span class="skolem">ty</span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">)</span> <span class="skolem">insts</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="skolem">insts</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> list.set_map lookup_None_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Fv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_eq_key_not_present<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Fv set_zip_leftD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Fv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_eq_key_not_present<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> None 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">u</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> idx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">insts</span> <span class="main">!</span> <span class="skolem">idx</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> length <span class="skolem">insts</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">insts</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">idx</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">!</span> <span class="bound">idx</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">idx</span> <span class="main">&lt;</span> length <span class="skolem">as</span> <span class="main">⟹</span> <span class="skolem">thesis</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> in_set_conv_nth insert_iff list.set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> in_set_conv_nth lookup_present_eq_key'<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fresh_idn</span></span> <span class="keyword2"><span class="keyword">where</span></span> fresh_idn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fresh_idns</span> <span class="main">!</span> <span class="skolem">idx</span> <span class="main">=</span> <span class="skolem">fresh_idn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> Fv<span class="main">(</span>1<span class="main">)</span> idx fresh_idn <span class="keyword1"><span class="command">have</span></span> ren<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">idx</span> 
      <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">,</span> Fv <span class="skolem">fresh_idn</span> <span class="skolem">ty</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this idx<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">,</span> Fv <span class="skolem">fresh_idn</span> <span class="skolem">ty</span><span class="main">)</span> <span class="main">∈</span> set
      <span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> <span class="quoted">"Fv.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> length_map map_fst_zip map_map map_snd_zip nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>Fv <span class="skolem">fresh_idn</span> <span class="skolem">ty</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"Fv.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"Fv.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lookup_present_eq_key''<span class="main">)</span>

    <span class="comment1">(* Feels doable with better simp setup *)</span>
    <span class="keyword1"><span class="command">from</span></span> Fv<span class="main">(</span>1<span class="main">)</span> idx fresh_idn 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">fresh_idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> 
      <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">fresh_idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"Fv.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"Fv.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> distinct_zipI1 lookup_present_eq_key''<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Some 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">t1</span> <span class="main">⊆</span> fv <span class="main">(</span><span class="skolem">t1</span> <span class="main">$</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">t2</span> <span class="main">⊆</span> fv <span class="main">(</span><span class="skolem">t1</span> <span class="main">$</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="skolem">insts</span> <span class="skolem">t1</span> <span class="main">=</span>
    subst_term <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>subst_term <span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t1</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="skolem">insts</span> <span class="skolem">t2</span> <span class="main">=</span>
    subst_term <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>subst_term <span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> subst_term_combine'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">fresh_idns</span> <span class="main">=</span> length <span class="free">insts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">fresh_idns</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idn</span> <span class="main">∈</span> set <span class="free">fresh_idns</span> <span class="main">.</span> <span class="bound">idn</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>fv <span class="free">t</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>snd <span class="main">`</span> set <span class="free">insts</span> <span class="main">.</span> <span class="main">(</span>fv <span class="bound">t</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">∪</span> <span class="main">(</span>fst <span class="main">`</span> set <span class="free">insts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="free">insts</span> <span class="free">t</span>
    <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> fst <span class="main">`</span> set <span class="free">insts</span> "</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> set <span class="main">(</span>map fst <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> map_fst_zip assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free">insts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> set <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> map_snd_zip assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_set length_map<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> snd <span class="main">`</span> set <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> set <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> this <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> snd <span class="main">`</span> set <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span>set <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fresh_idns</span></span> <span class="quoted"><span class="free">insts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> s3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> snd <span class="main">`</span> set <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>
                   <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> fst<span class="main">)</span> <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> set <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idn</span> <span class="main">∉</span> fst <span class="main">`</span> fst <span class="main">`</span> set <span class="free">insts</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idn</span> <span class="main">∈</span> set <span class="free">fresh_idns</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">idn</span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">insts</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idn</span> <span class="main">∈</span> set <span class="free">fresh_idns</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">idn</span> <span class="skolem">T</span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv image_eqI<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> u1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subst_term <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_term_stepwise<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> s1 s2<span class="main">)</span>  
     <span class="keyword1"><span class="command">using</span></span> assms I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse set_zip_leftD<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> u2<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_term <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>subst_term <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>
  <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>subst_term <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_term_stepwise<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_zipI1<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> assms
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> UnCI imageE image_eqI length_map map_snd_zip prod.collapse set_map set_zip_leftD<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_term <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>subst_term <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>
   <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="free">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms subst_term_combine unfold <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Term_Subst-subst_term_not_loose_bvar"><span class="command">lemma</span></span> subst_term_not_loose_bvar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">b</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">idn</span><span class="main">,</span><span class="free">T</span><span class="main">)</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">idn</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def loose_bvar_leq<span class="main">)</span>
  
<span class="comment1">(* This seems a bit to weak, second premise probably needs to be more general *)</span>
<span class="keyword1" id="Term_Subst-bind_fv2_subst_bv1_eq_subst_term"><span class="command">lemma</span></span> bind_fv2_subst_bv1_eq_subst_term<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>loose_bvar <span class="free">t</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">idn</span><span class="main">,</span><span class="free">T</span><span class="main">)</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">]</span> <span class="free">t</span> <span class="main">=</span> subst_bv1 <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="free">idn</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="free">n</span> <span class="free">t</span><span class="main">)</span> <span class="free">n</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">idn</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def incr_boundvars_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">b</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_bv <span class="free">b</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">idn</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">idn</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms bind_fv2_subst_bv1_eq_subst_term
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_fv_def subst_bv_def is_open_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> instantiate_var_same_typ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typ_a<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">a</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> closed_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">B</span> <span class="free">lev</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_bv1 <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">lev</span> <span class="free">B</span><span class="main">)</span> <span class="free">lev</span> <span class="free">a</span> <span class="main">=</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">]</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bind_fv2_subst_bv1_eq_subst_term assms typ_of_imp_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> instantiate_var_same_typ'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typ_a<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">a</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> closed_B<span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_bv <span class="free">a</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">]</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> instantiate_var_same_typ bind_fv_def subst_bv_def is_open_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> instantiate_var_same_type''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typ_a<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">a</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> closed_B<span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> <span class="main">∙</span> <span class="free">a</span> <span class="main">=</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">]</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms instantiate_var_same_typ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term_Subst-instantiate_vars_same_typ"><span class="command">lemma</span></span> instantiate_vars_same_typ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">.</span> typ_of <span class="bound">t</span> <span class="main">=</span> Some <span class="bound">ty</span><span class="main">)</span> <span class="free">insts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> closed_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">B</span> <span class="free">lev</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">B</span> <span class="main">.</span> subst_bv1 <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span> <span class="free">lev</span> <span class="bound">B</span><span class="main">)</span> <span class="free">lev</span> <span class="bound">t</span><span class="main">)</span> <span class="free">insts</span> <span class="free">B</span>
    <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="free">insts</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idn</span></span> <span class="skolem"><span class="skolem">ty</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> typ_a<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">ty</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> typs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">.</span> typ_of <span class="bound">t</span> <span class="main">=</span> Some <span class="bound">ty</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> not_loose<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">]</span> <span class="skolem">B</span><span class="main">)</span> <span class="skolem">lev</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Cons.prems subst_term_not_loose_bvar typ_a typ_of_imp_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">note</span></span> single <span class="main">=</span> instantiate_var_same_typ<span class="main">[</span><span class="operator">OF</span> typ_a Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">idn</span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">B</span> <span class="main">.</span> subst_bv1 <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span> <span class="skolem">lev</span> <span class="bound">B</span><span class="main">)</span> <span class="skolem">lev</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">B</span>
    <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">B</span><span class="main">.</span> subst_bv1 <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span> <span class="skolem">lev</span> <span class="bound">B</span><span class="main">)</span> <span class="skolem">lev</span> <span class="bound">t</span><span class="main">)</span> <span class="skolem">xs</span> 
        <span class="main">(</span>subst_bv1 <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span> <span class="skolem">lev</span> <span class="skolem">B</span><span class="main">)</span> <span class="skolem">lev</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">B</span><span class="main">.</span> subst_bv1 <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span> <span class="skolem">lev</span> <span class="bound">B</span><span class="main">)</span> <span class="skolem">lev</span> <span class="bound">t</span><span class="main">)</span> <span class="skolem">xs</span>
    <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">]</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> single <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">]</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">]</span> <span class="skolem">B</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> typs not_loose<span class="main">]</span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">B</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> instantiate_vars_same_typ'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">.</span> typ_of <span class="bound">t</span> <span class="main">=</span> Some <span class="bound">ty</span><span class="main">)</span> <span class="free">insts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> closed_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">B</span> <span class="free">lev</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no_overlap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span>set <span class="free">insts</span><span class="main">)</span> <span class="main">.</span> fv <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">B</span> <span class="main">.</span> subst_bv1 <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span> <span class="free">lev</span> <span class="bound">B</span><span class="main">)</span> <span class="free">lev</span> <span class="bound">t</span><span class="main">)</span> <span class="free">insts</span> <span class="free">B</span>
    <span class="main">=</span> subst_term <span class="free">insts</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> instantiate_vars_same_typ subst_term_stepwise<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Name">
<div class="head">
<h1>Theory Name</h1>
</div>
<pre class="source"><span class="comment1">(*
  Generation of fresh names
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Names"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Name
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Preliminaries">Preliminaries</a> <a href="#Term">Term</a>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Char_ord.html">HOL-Library.Char_ord</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Horrible generator for now(make a string of "a"s that is longer than all strings in the set),
   make something better later 
   Needs list nature of strings, so not directly on literals
*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fresh_name</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string set <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fresh_name</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">=</span>empty <span class="keyword1">then</span> <span class="inner_quoted">''a''</span> <span class="keyword1">else</span> replicate <span class="main">(</span>Max <span class="main">(</span>length <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Name-fresh_name_fresh"><span class="command">lemma</span></span> fresh_name_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fresh_name <span class="free">S</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">=</span>empty"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fresh_name <span class="free">S</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">(</span>Max <span class="main">(</span>image length <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> length <span class="main">(</span>fresh_name <span class="free">S</span><span class="main">)</span> <span class="main">&gt;</span> length <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_imp_less_Suc<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fresh_name <span class="free">S</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Lift this generator to literals *)</span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> <span class="quoted">"String.literal.lifting"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> fresh_name' <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal set <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"fresh_name"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fresh_name' <span class="free">S</span> <span class="main">=</span> String.implode <span class="main">(</span>fresh_name <span class="main">(</span>String.explode <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> String.implode_explode_eq fresh_name'.rep_eq<span class="main">)</span>

<span class="keyword1" id="Name-fresh_name'_fresh"><span class="command">lemma</span></span> fresh_name'_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fresh_name' <span class="free">S</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms finite_imageI fresh_name'.rep_eq fresh_name_fresh rev_image_eqI<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">variant_name</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> name set <span class="main">⇒</span> <span class="main">(</span>name <span class="main">×</span> name set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">variant_name</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">(</span>fresh_name' <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> insert <span class="bound">s'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Name-variant_name_fresh"><span class="command">lemma</span></span> variant_name_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>variant_name <span class="free">s</span> <span class="free">S</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fresh_name'_fresh
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv variant_name.simps<span class="main">)</span>

<span class="keyword1" id="Name-variant_name_adds"><span class="command">lemma</span></span> variant_name_adds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>variant_name <span class="free">s</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>fst <span class="main">(</span>variant_name <span class="free">s</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv snd_conv variant_name.simps<span class="main">)</span>

<span class="comment1">(* This is a hack to transfer result to variables, better to write generator directly *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">name</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"variable <span class="main">⇒</span> name"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">name</span> <span class="main">(</span>variable.Free <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">name</span> <span class="main">(</span>Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="comment1">(* And for variables *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">variant_variable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"variable <span class="main">⇒</span> variable set <span class="main">⇒</span> <span class="main">(</span>variable <span class="main">×</span> variable set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">variant_variable</span> <span class="main">(</span>variable.Free <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> fresh_name' <span class="main">(</span>name <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="keyword1">in</span> 
    <span class="main">(</span>Free <span class="bound">s'</span><span class="main">,</span> insert <span class="main">(</span>variable.Free <span class="bound">s'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">variant_variable</span> <span class="main">(</span>Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> fresh_name' <span class="main">(</span>name <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="keyword1">in</span> 
    <span class="main">(</span>Var <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> insert <span class="main">(</span>Var <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Name-variant_variable_fresh"><span class="command">lemma</span></span> variant_variable_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>variant_variable <span class="free">s</span> <span class="free">S</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms fresh_name'_fresh
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> finite_imageI fstI name.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rev_image_eqI variant_variable.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms fresh_name'_fresh 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> finite_imageI fst_conv image_iff name.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> surj_pair variant_variable.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Name-variant_variable_adds"><span class="command">lemma</span></span> variant_variable_adds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>variant_variable <span class="free">s</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>fst <span class="main">(</span>variant_variable <span class="free">s</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fst_conv snd_conv variant_variable.elims<span class="main">)</span>

<span class="comment1">(* Even worse generator for fresh variable names to allow transforming parallel to sequential substitutions 
  Applied hack for variables here too
*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">variant_variables</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> variable <span class="main">⇒</span> variable set <span class="main">⇒</span> <span class="main">(</span>variable list <span class="main">×</span> variable set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">variant_variables</span> <span class="main">0</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">variant_variables</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">S'</span><span class="main">)</span> <span class="main">=</span> variant_variable <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">in</span> 
      <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">ss</span><span class="main">,</span> <span class="bound">S''</span><span class="main">)</span> <span class="main">=</span> <span class="free">variant_variables</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">s'</span> <span class="bound">S'</span> <span class="keyword1">in</span>
        <span class="main">(</span><span class="bound">s'</span><span class="main">#</span><span class="bound">ss</span><span class="main">,</span> <span class="bound">S''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Name-variant_names_fresh"><span class="command">lemma</span></span> variant_names_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>variant_variables <span class="free">n</span> <span class="free">s</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'S'<span class="main">:</span> <span class="quoted"><span class="quoted">"variant_variable <span class="skolem">s</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems fst_conv variant_variable_fresh<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span>set <span class="main">(</span>fst <span class="main">(</span>variant_variables <span class="skolem">n</span> <span class="skolem">s'</span> <span class="skolem">S'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">S'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.IH Suc.prems s'S' finite.insertI snd_conv variant_variable_adds<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> <span class="skolem">S'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_iff s'S' snd_conv subsetI variant_variable_adds<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def s'S' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Name-variant_names_distinct"><span class="command">lemma</span></span> variant_names_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>fst <span class="main">(</span>variant_variables <span class="free">n</span> <span class="free">s</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'S'<span class="main">:</span> <span class="quoted"><span class="quoted">"variant_variable <span class="skolem">s</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems fst_conv variant_variable_fresh<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>fst <span class="main">(</span>variant_variables <span class="skolem">n</span> <span class="skolem">s'</span> <span class="skolem">S'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.IH Suc.prems s'S' finite.insertI snd_conv variant_variable_adds<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> <span class="skolem">S'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_iff s'S' snd_conv subsetI variant_variable_adds<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def s'S' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems finite.insertI fst_conv insertI1 s'S' snd_conv variant_names_fresh variant_variable_adds<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> variant_names_amount<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="main">(</span>variant_variables <span class="free">n</span> <span class="free">s</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta variant_variable_adds<span class="main">)</span>

<span class="comment1">(* 
  After translation I also need to make sure fresh vars are not in the context
*)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fresh_rename_ns</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>variant_variables <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Free <span class="keyword1">STR</span> <span class="inner_quoted">''lol''</span><span class="main">)</span>
  <span class="main">(</span>fst <span class="main">`</span> <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>snd <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="main">.</span> fv <span class="bound">t</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>fst <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">insts</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fresh_rename_idns</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="main">≡</span> fresh_rename_ns <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span>"</span></span>

<span class="keyword1" id="Name-map_Pair_zip_replicate_conv"><span class="command">lemma</span></span> map_Pair_zip_replicate_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Pair <span class="bound">x</span> <span class="free">c</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> zip <span class="free">l</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="free">l</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Name-distinct_fresh_rename_ns"><span class="command">lemma</span></span> distinct_fresh_rename_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span> <span class="main">⟹</span> distinct <span class="main">(</span>fresh_rename_ns <span class="free">n</span> <span class="free">B</span> <span class="free">insts</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> List.finite_set add_vars'_fv finite_UN finite_Un finite_imageI variant_names_distinct<span class="main">)</span>

<span class="keyword1" id="Name-fresh_fresh_rename_ns"><span class="command">lemma</span></span> fresh_fresh_rename_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">nm</span> <span class="main">∈</span> set <span class="main">(</span>fresh_rename_ns <span class="free">n</span> <span class="free">B</span> <span class="free">insts</span> <span class="free">G</span><span class="main">)</span> <span class="main">.</span> 
  <span class="bound">nm</span> <span class="main">∉</span> <span class="main">(</span>fst <span class="main">`</span> <span class="main">(</span>fv <span class="free">B</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">insts</span> <span class="main">.</span> <span class="main">(</span>fv <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>fst <span class="main">`</span> set <span class="free">insts</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> List.finite_set add_vars'_fv finite_UN finite_Un finite_imageI variant_names_fresh<span class="main">)</span>
  
<span class="keyword1" id="Name-length_fresh_rename_ns"><span class="command">lemma</span></span> length_fresh_rename_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span> <span class="main">⟹</span> length <span class="main">(</span>fresh_rename_ns <span class="free">n</span> <span class="free">B</span> <span class="free">insts</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> List.finite_set add_vars'_fv finite_UN finite_Un finite_imageI variant_names_amount<span class="main">)</span>

<span class="keyword1" id="Name-distinct_fresh_rename_idns"><span class="command">lemma</span></span> distinct_fresh_rename_idns<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span> <span class="main">⟹</span> distinct <span class="main">(</span>fresh_rename_idns <span class="free">n</span> <span class="free">B</span> <span class="free">insts</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_fresh_rename_ns <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>

<span class="keyword1" id="Name-fresh_fresh_rename_idns"><span class="command">lemma</span></span> fresh_fresh_rename_idns<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">nm</span> <span class="main">∈</span> set <span class="main">(</span>fresh_rename_idns <span class="free">n</span> <span class="free">B</span> <span class="free">insts</span> <span class="free">G</span><span class="main">)</span> <span class="main">.</span> 
  <span class="bound">nm</span> <span class="main">∉</span> <span class="main">(</span>fst <span class="main">`</span> <span class="main">(</span>fv <span class="free">B</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">insts</span> <span class="main">.</span> <span class="main">(</span>fv <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>fst <span class="main">`</span> set <span class="free">insts</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_fresh_rename_ns map_Pair_zip_replicate_conv map_Pair_zip_replicate_conv
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fresh_fresh_rename_ns fst_conv imageE image_eqI list.set_map<span class="main">)</span>

<span class="keyword1" id="Name-length_fresh_rename_idns"><span class="command">lemma</span></span> length_fresh_rename_idns<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span> <span class="main">⟹</span>  length <span class="main">(</span>fresh_rename_idns <span class="free">n</span> <span class="free">B</span> <span class="free">insts</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_fresh_rename_ns<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="BetaNorm">
<div class="head">
<h1>Theory BetaNorm</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Beta Normalization"</span></span>

<span class="comment1">(* 
  Much of this material is directly copied and adapted from @{dir "~~/src/HOL/Proofs/Lambda"}

  Proofs are in a lot of cases very ugly as they were copied+fixed
*)</span>

<span class="keyword1"><span class="command">theory</span></span> BetaNorm         
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Term">Term</a>
<span class="keyword2"><span class="keyword">begin</span></span>                             

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">beta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    beta <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> subst_bv2 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
  <span class="main">|</span> appL <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
  <span class="main">|</span> appR <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
  <span class="main">|</span> abs <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">beta_reds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> beta<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> beta_cases <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Bv <span class="free">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"Fv <span class="free">idn</span> <span class="free">S</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"Abs <span class="free">T</span> <span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">$</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">u</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> if_not_P <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> not_less_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="BetaNorm-rtrancl_beta_Abs"><span class="command">lemma</span></span> rtrancl_beta_Abs <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s'</span> <span class="main">⟹</span> Abs <span class="free">T</span> <span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Abs <span class="free">T</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> rtranclp<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="BetaNorm-rtrancl_beta_AppL"><span class="command">lemma</span></span> rtrancl_beta_AppL<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">$</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s'</span> <span class="main">$</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> rtranclp<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="BetaNorm-rtrancl_beta_AppR"><span class="command">lemma</span></span> rtrancl_beta_AppR<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">$</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s</span> <span class="main">$</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> rtranclp<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="BetaNorm-rtrancl_beta_App"><span class="command">lemma</span></span> rtrancl_beta_App <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">$</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s'</span> <span class="main">$</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtrancl_beta_AppL rtrancl_beta_AppR <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtranclp_trans<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> subst_bv2_preserves_beta <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">s</span> <span class="main">⟹</span> subst_bv2 <span class="free">r</span> <span class="free">k</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> subst_bv2 <span class="free">s</span> <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> beta<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_bv2_subst_bv2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> subst_bv2_preserves_beta'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s</span> <span class="main">⟹</span> subst_bv2 <span class="free">r</span> <span class="free">i</span> <span class="free">t</span>  <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> subst_bv2 <span class="free">s</span> <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> rtranclp<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp.rtrancl_refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> rtranclp.rtrancl_into_rtrancl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> subst_bv2_preserves_beta<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> lift_preserves_beta <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">s</span> <span class="main">⟹</span> lift <span class="free">r</span> <span class="free">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> lift <span class="free">s</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> beta<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">T</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lift_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">theorem</span></span> lift_preserves_beta'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s</span> <span class="main">⟹</span> lift <span class="free">r</span> <span class="free">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> lift <span class="free">s</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> rtranclp<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp.rtrancl_refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> rtranclp.rtrancl_into_rtrancl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> lift_preserves_beta<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> subst_bv2_preserves_beta2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">s</span> <span class="main">⟹</span> subst_bv2 <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> subst_bv2 <span class="free">t</span> <span class="free">i</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> r_into_rtranclp›</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> lift_preserves_beta <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtrancl_beta_App<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> subst_bv2_preserves_beta2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s</span> <span class="main">⟹</span> subst_bv2 <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> subst_bv2 <span class="free">t</span> <span class="free">i</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> rtranclp<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rtranclp_trans subst_bv2_preserves_beta2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BetaNorm-beta_preserves_typ_of1"><span class="command">lemma</span></span> beta_preserves_typ_of1<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">T</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">s</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typ_of1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> beta_cases<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> typ_of1.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> typ_of_Abs_body_typ'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">Ts</span> <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">argT</span></span> <span class="keyword2"><span class="keyword">where</span></span> argT<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="skolem">Ts</span> <span class="skolem">u</span> <span class="main">=</span> Some <span class="skolem">argT</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="skolem">Ts</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">argT</span> <span class="main">→</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> typ_of1_split_App_obtains<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> 5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">f</span></span> <span class="main"><span class="main">$</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword1"><span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="skolem"><span class="skolem">s</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹typ_of1 <span class="skolem">Ts</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">argT</span> <span class="main">→</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> argT typ_of1_subst_bv_gen' 
      typ_of_Abs_body_typ' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substn_subst_n<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> beta.cases <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">blast</span><span class="keyword3">+</span>›</span><span class="main">)</span>

<span class="keyword1" id="BetaNorm-beta_preserves_typ_of"><span class="command">lemma</span></span> beta_preserves_typ_of<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">r</span> <span class="main">=</span> Some <span class="free">T</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">s</span> <span class="main">⟹</span> typ_of <span class="free">s</span> <span class="main">=</span> Some <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> beta_preserves_typ_of1 typ_of_def<span class="main">)</span>

<span class="keyword1" id="BetaNorm-beta_star_preserves_typ_of1"><span class="command">lemma</span></span> beta_star_preserves_typ_of1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">T</span>  <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_refl <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_into_rtrancl <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> beta_preserves_typ_of1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(* 
  Convert beta_norm to the inductive predicates. Then later show that one beta step can be justified
  using proves
*)</span>

<span class="keyword1" id="BetaNorm-beta_reducible_imp_beta_step"><span class="command">lemma</span></span> beta_reducible_imp_beta_step<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_reducible <span class="free">t</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> App <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="BetaNorm-beta_step_imp_beta_reducible"><span class="command">lemma</span></span> beta_step_imp_beta_reducible<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span> <span class="main">⟹</span> beta_reducible <span class="free">t</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">T</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>appL <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>appR <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reducible.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BetaNorm-beta_norm_imp_beta_reds"><span class="command">lemma</span></span> beta_norm_imp_beta_reds<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"beta_norm <span class="free">t</span> <span class="main">=</span> Some <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta_norm.fixp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Option.is_none_def ccpo.admissibleI chain_fun flat_lub_def flat_ord_def fun_lub_def 
        insertCI is_none_code<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mem_Collect_eq option.lub_upper subsetI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">comp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> fu <span class="main">=</span> App
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">comp</span> <span class="skolem">f</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">B</span> <span class="skolem">b</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"3.IH"</span> <span class="quoted">"3.prems"</span> Core.subst_bv_def Core.term.simps<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span> 
              Core.term.simps<span class="main"><span class="main">(</span></span>30<span class="main"><span class="main">)</span></span> beta fu rtranclp.rtrancl_into_rtrancl rtranclp.rtrancl_refl rtranclp_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> 3 None <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main">:</span> fu <span class="quasi_keyword">split</span><span class="main">:</span> term.splits option.splits if_splits›</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">fo</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">fo</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ct <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">B</span> <span class="skolem">b</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"3.IH"</span> <span class="quoted">"3.prems"</span> Core.subst_bv_def Core.term.simps<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span>
                Core.term.simps<span class="main"><span class="main">(</span></span>30<span class="main"><span class="main">)</span></span> beta converse_rtranclp_into_rtranclp fu<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> 3 Some <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> fu <span class="quasi_keyword">split</span><span class="main">:</span> term.splits option.splits if_split›</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">B</span> <span class="skolem">b</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"3.IH"</span> <span class="quoted">"3.prems"</span> Core.subst_bv_def Core.term.simps<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span>
                Core.term.simps<span class="main"><span class="main">(</span></span>30<span class="main"><span class="main">)</span></span> beta converse_rtranclp_into_rtranclp fu<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> 3 Some <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> fu <span class="quasi_keyword">split</span><span class="main">:</span> term.splits option.splits if_split›</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bv <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">B</span> <span class="skolem">b</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"3.IH"</span> <span class="quoted">"3.prems"</span> Core.subst_bv_def Core.term.simps<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span>
                Core.term.simps<span class="main"><span class="main">(</span></span>30<span class="main"><span class="main">)</span></span> beta converse_rtranclp_into_rtranclp fu<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> 3 Some <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> fu <span class="quasi_keyword">split</span><span class="main">:</span> term.splits option.splits if_split›</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ct <span class="skolem">n</span> <span class="skolem">C</span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"3.IH"</span> Abs Core.term.simps<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> Ct Some beta_reducible.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> 
                beta_step_imp_beta_reducible converse_rtranclpE<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">n</span> <span class="skolem">C</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"3.IH"</span> Abs Fv Some beta_reducible.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>8<span class="main"><span class="main">)</span></span> beta_step_imp_beta_reducible 
                converse_rtranclpE<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bv <span class="skolem">n</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"3.IH"</span> Abs Some beta_cases<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> converse_rtranclpE term.distinct<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">B</span> <span class="skolem">b</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"3.IH"</span> <span class="quoted">"3.prems"</span> Core.subst_bv_def Core.term.simps<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span>
                Core.term.simps<span class="main"><span class="main">(</span></span>30<span class="main"><span class="main">)</span></span> beta converse_rtranclp_into_rtranclp fu<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fu Some <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits option.splits if_splits<span class="main"><span class="keyword3">;</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Core.subst_bv_def beta converse_rtranclp_into_rtranclp rtrancl_beta_AppL rtranclp_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> AppO<span class="main">:</span> <span class="main">(</span>App <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ct <span class="skolem">n</span> <span class="skolem">C</span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> 3 Some <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ct AppO fu <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits option.splits if_split<span class="main"><span class="keyword3">;</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Core.subst_bv_def beta converse_rtranclp_into_rtranclp<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">n</span> <span class="skolem">C</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> 3 Some <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fv AppO fu <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits option.splits if_split<span class="main"><span class="keyword3">;</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Core.subst_bv_def beta converse_rtranclp_into_rtranclp<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bv <span class="skolem">n</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> 3 Some <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Bv AppO fu <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits option.splits if_split<span class="main"><span class="keyword3">;</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Core.subst_bv_def beta converse_rtranclp_into_rtranclp<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">B</span> <span class="skolem">b</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> 3 Some <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs AppO fu <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits option.splits if_split<span class="main"><span class="keyword3">;</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Core.subst_bv_def beta converse_rtranclp_into_rtranclp<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> 3 Some <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> App AppO fu <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits option.splits if_split<span class="main"><span class="keyword3">;</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Core.subst_bv_def beta converse_rtranclp_into_rtranclp<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="quoted"><span class="quoted">"beta_norm <span class="free">t</span> <span class="main">=</span> Some <span class="free">t'</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">T</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">t'</span> <span class="main">=</span> Some <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> beta_norm_imp_beta_reds beta_star_preserves_typ_of1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword1" id="BetaNorm-beta_imp_beta_norm"><span class="command">lemma</span></span> beta_imp_beta_norm<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"beta_norm <span class="free">t</span> <span class="main">=</span> Some <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">T</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_beta_reducible_imp_beta_norm_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_bv_def substn_subst_n<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>appL <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> beta_reducible.elims<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_norm <span class="skolem">s</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> appL.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">from</span></span> appL <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> beta_reducible.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> not_beta_reducible_imp_beta_norm_unchanged IH t u appL.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>appR <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="skolem">t</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> beta_reducible.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_norm <span class="skolem">s</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> appR.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">from</span></span> appR <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> beta_reducible <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> beta_reducible.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> not_beta_reducible_imp_beta_norm_unchanged IH t u appR.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BetaNorm-beta_subst_bv1"><span class="command">lemma</span></span> beta_subst_bv1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t</span> <span class="main">⟹</span> subst_bv1 <span class="free">s</span> <span class="free">lev</span> <span class="free">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> subst_bv1 <span class="free">t</span> <span class="free">lev</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">T</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> beta.beta subst_bv2_preserves_beta substn_subst_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_bv_def<span class="main">)</span>

<span class="keyword1" id="BetaNorm-beta_subst_bv"><span class="command">lemma</span></span> beta_subst_bv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t</span> <span class="main">⟹</span> subst_bv <span class="free">x</span> <span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> subst_bv <span class="free">x</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substn_subst_0'<span class="main">)</span>

<span class="comment1">(* typ_of to exclude terms like Bv 0 $ Bv 0
  Probably can get rid of one typ_of somehow

  Problem: Not useable for subst_bv (at lev 0)
*)</span>
<span class="keyword1" id="BetaNorm-subst_bv1_beta"><span class="command">lemma</span></span> subst_bv1_beta<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_bv1 <span class="free">s</span> <span class="main">(</span>length <span class="main">(</span><span class="free">T</span><span class="main">#</span><span class="free">Ts</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> subst_bv1 <span class="free">t</span> <span class="main">(</span>length <span class="main">(</span><span class="free">T</span><span class="main">#</span><span class="free">Ts</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> 
  <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">ty</span>
  <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span>
  <span class="main">⟹</span> <span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"subst_bv1 <span class="free">s</span> <span class="main">(</span>length <span class="main">(</span><span class="free">T</span><span class="main">#</span><span class="free">Ts</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"subst_bv1 <span class="free">t</span> <span class="main">(</span>length <span class="main">(</span><span class="free">T</span><span class="main">#</span><span class="free">Ts</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">ty</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">T</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> beta.simps length_Cons loose_bvar_Suc no_loose_bvar_imp_no_subst_bv1 typ_of1_imp_no_loose_bvar<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>appL <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> beta.appL length_Cons loose_bvar_Suc no_loose_bvar_imp_no_subst_bv1 typ_of1_imp_no_loose_bvar<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>appR <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> beta.simps length_Cons loose_bvar_Suc no_loose_bvar_imp_no_subst_bv1 typ_of1_imp_no_loose_bvar<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">bT</span> <span class="skolem">sa</span> <span class="skolem">ta</span> <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="skolem">rT</span> <span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Abs <span class="skolem">bT</span> <span class="skolem">s'</span> <span class="main">=</span> <span class="skolem">sa</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> abs.hyps<span class="main">(</span>3<span class="main">)</span> abs.prems loose_bvar_Suc no_loose_bvar_imp_no_subst_bv1 typ_of1_imp_no_loose_bvar 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Abs <span class="skolem">bT</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="skolem">ta</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> abs.hyps<span class="main">(</span>4<span class="main">)</span> abs.prems loose_bvar_Suc no_loose_bvar_imp_no_subst_bv1 typ_of1_imp_no_loose_bvar 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abs.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> abs.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> abs.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> abs.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> abs.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_Cons 
        loose_bvar_Suc no_loose_bvar_imp_no_subst_bv1 term.inject<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> typ_of1_imp_no_loose_bvar<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Abs <span class="skolem">bT</span> <span class="skolem">s'</span> <span class="main">=</span> <span class="skolem">sa</span>›</span></span> <span class="quoted"><span class="quoted">‹Abs <span class="skolem">bT</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="skolem">ta</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Longterm: Move to Term and unify with subst_bv2, so far only used for beta reduction *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst_bvs1'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> nat <span class="main">⇒</span> term list <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_bvs1'</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="keyword1">then</span> Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>nth <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">lev</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> Bv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> length <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_bvs1'</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free">subst_bvs1'</span> <span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> lift <span class="bound">t</span> <span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_bvs1'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free">subst_bvs1'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">$</span> <span class="free">subst_bvs1'</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_bvs1'</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="BetaNorm-subst_bvs1'_empty"><span class="command">lemma</span></span> subst_bvs1'_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bvs1' <span class="free">t</span> <span class="free">lev</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>term list"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bvs1.induct<span class="main">)</span><span class="operator">auto</span>

<span class="keyword1" id="BetaNorm-subst_bvs1'_eq"><span class="command">lemma</span></span> subst_bvs1'_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">args</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> subst_bvs1' <span class="main">(</span>Bv <span class="free">k</span><span class="main">)</span> <span class="free">k</span> <span class="free">args</span> <span class="main">=</span> <span class="free">args</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="BetaNorm-subst_bvs1'_eq'"><span class="command">lemma</span></span> subst_bvs1'_eq' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">args</span> <span class="main">⟹</span> subst_bvs1' <span class="main">(</span>Bv <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span> <span class="free">args</span> <span class="main">=</span> <span class="free">args</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BetaNorm-subst_bvs1'_gt"><span class="command">lemma</span></span> subst_bvs1'_gt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> length <span class="free">args</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> subst_bvs1' <span class="main">(</span>Bv <span class="free">j</span><span class="main">)</span> <span class="free">i</span> <span class="free">args</span> <span class="main">=</span> Bv <span class="main">(</span><span class="free">j</span> <span class="main">-</span> length <span class="free">args</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BetaNorm-subst_bv2_lt"><span class="command">lemma</span></span> subst_bv2_lt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> subst_bvs1' <span class="main">(</span>Bv <span class="free">j</span><span class="main">)</span> <span class="free">i</span> <span class="free">u</span> <span class="main">=</span> Bv <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BetaNorm-subst_bvs1'_App"><span class="command">lemma</span></span> subst_bvs1'_App<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bvs1' <span class="main">(</span><span class="free">s</span><span class="main">$</span><span class="free">t</span><span class="main">)</span> <span class="free">k</span> <span class="free">args</span>
  <span class="main">=</span> subst_bvs1' <span class="free">s</span> <span class="free">k</span> <span class="free">args</span> <span class="main">$</span> subst_bvs1' <span class="free">t</span> <span class="free">k</span> <span class="free">args</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BetaNorm-incr_bv_incr_bv"><span class="command">lemma</span></span> incr_bv_incr_bv<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> incr_bv <span class="free">inc2</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="free">inc1</span><span class="main">)</span> <span class="main">(</span>incr_bv <span class="free">inc1</span> <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> incr_bv <span class="free">inc1</span> <span class="free">i</span> <span class="main">(</span>incr_bv <span class="free">inc2</span> <span class="free">k</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 add_Suc add_mono1 incr_bv.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BetaNorm-subst_bvs1_subst_bvs1'"><span class="command">lemma</span></span> subst_bvs1_subst_bvs1'<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bvs1 <span class="free">t</span> <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> subst_bvs1' <span class="free">t</span> <span class="free">n</span> <span class="main">(</span>map <span class="main">(</span>incr_bv <span class="free">n</span> <span class="main">0</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incr_boundvars_def incr_bv_combine<span class="main">)</span> 
      <span class="main">(</span><span class="operator">metis</span> One_nat_def comp_apply incr_bv_combine plus_1_eq_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incr_boundvars_def incr_bv_combine<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> subst_bvs1_subst_bvs1'_0<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bvs1 <span class="free">t</span> <span class="main">0</span> <span class="free">s</span> <span class="main">=</span> subst_bvs1' <span class="free">t</span> <span class="main">0</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bvs1 <span class="free">t</span> <span class="main">0</span> <span class="free">s</span> <span class="main">=</span> subst_bvs1' <span class="free">t</span> <span class="main">0</span> <span class="main">(</span>map <span class="main">(</span>incr_bv <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_bvs1_subst_bvs1' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>incr_bv <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> subst_bvs_subst_bvs1'<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bvs <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> subst_bvs1' <span class="free">t</span> <span class="main">0</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subst_bvs_def subst_bvs1_subst_bvs1'_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BetaNorm-no_loose_bvar_subst_bvs1'_unchanged"><span class="command">lemma</span></span> no_loose_bvar_subst_bvs1'_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="free">lev</span> <span class="main">⟹</span> subst_bvs1' <span class="free">t</span> <span class="free">lev</span> <span class="free">args</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">args</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bvs1'.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* This is enough when just substituting variables, however in the β case I will have to
  distribute subst_bvs through a single subst_bv(where the substituted term is not a var).
*)</span>
<span class="keyword1" id="BetaNorm-subst_bvs1'_step"><span class="command">lemma</span></span> subst_bvs1'_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">args</span><span class="main">)</span> <span class="main">.</span> is_closed <span class="bound">x</span> <span class="main">⟹</span>
  subst_bvs1' <span class="free">t</span> <span class="free">lev</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">args</span><span class="main">)</span> <span class="main">=</span> subst_bvs1' <span class="main">(</span>subst_bv2 <span class="free">t</span> <span class="free">lev</span> <span class="free">a</span><span class="main">)</span> <span class="free">lev</span> <span class="free">args</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">args</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bvs1'.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">lev</span> <span class="skolem">args</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> no_loose_bvar_subst_bvs1'_unchanged
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def<span class="main">)</span> 
      <span class="main">(</span><span class="operator">metis</span> Suc_diff_Suc le_add1 le_add_same_cancel1 less_antisym loose_bvar_leq not_less_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def<span class="main">)</span>

<span class="keyword1" id="BetaNorm-not_loose_bvar_incr_bv"><span class="command">lemma</span></span> not_loose_bvar_incr_bv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">a</span> <span class="free">lev</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar <span class="main">(</span>incr_bv <span class="free">inc</span> <span class="free">lev</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">lev</span><span class="main">+</span><span class="free">inc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loose_bvar.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="BetaNorm-not_loose_bvar_incr_bv_less"><span class="command">lemma</span></span> not_loose_bvar_incr_bv_less<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar <span class="main">(</span>incr_bv <span class="free">inc</span> <span class="free">i</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">lev</span><span class="main">+</span><span class="free">inc</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar <span class="main">(</span>incr_bv <span class="free">inc</span> <span class="free">j</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">lev</span><span class="main">+</span><span class="free">inc</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">inc</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> incr_bv.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">inc</span> <span class="skolem">n</span> <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 add_Suc add_mono1 incr_bv.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> loose_bvar.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="BetaNorm-subst_bvs1'_step_work"><span class="command">lemma</span></span> subst_bvs1'_step_work<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">args</span> <span class="main">.</span> is_closed <span class="bound">x</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar <span class="main">(</span>subst_bv2 <span class="free">t</span> <span class="free">lev</span> <span class="free">a</span><span class="main">)</span> <span class="free">lev</span> <span class="main">⟹</span>
  subst_bvs1' <span class="free">t</span> <span class="free">lev</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">args</span><span class="main">)</span> <span class="main">=</span> subst_bvs1' <span class="main">(</span>subst_bv2 <span class="free">t</span> <span class="free">lev</span> <span class="free">a</span><span class="main">)</span> <span class="free">lev</span> <span class="free">args</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="quoted">"<span class="free">lev</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">args</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bvs1'.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_loose_bvar_subst_bvs1'_unchanged
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">T</span> <span class="skolem">body</span> <span class="skolem">lev</span> <span class="skolem">args</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_loose_bvar_subst_bvs1'_unchanged
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">t</span> <span class="skolem">lev</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_loose_bvar_subst_bvs1'_unchanged
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"4_1"</span> <span class="skolem">v</span> <span class="skolem">va</span> <span class="skolem">uu</span> <span class="skolem">uv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_loose_bvar_subst_bvs1'_unchanged
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"4_2"</span> <span class="skolem">v</span> <span class="skolem">va</span> <span class="skolem">uu</span> <span class="skolem">uv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_loose_bvar_subst_bvs1'_unchanged
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BetaNorm-is_closed_subst_bv2_unchanged"><span class="command">lemma</span></span> is_closed_subst_bv2_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">t</span> <span class="main">⟹</span> subst_bv2 <span class="free">t</span> <span class="free">n</span> <span class="free">u</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_open_def lift_def loose_bvar_Suc no_loose_bvar_no_incr subst_bv2_lift zero_induct<span class="main">)</span>

<span class="comment1">(* This might do it, should be able to connect a new substitution to the pushed in one *)</span>
<span class="keyword1" id="BetaNorm-subst_bvs1'_step_extend_lower_level"><span class="command">lemma</span></span> subst_bvs1'_step_extend_lower_level<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">args</span><span class="main">)</span> <span class="main">.</span> is_closed <span class="bound">x</span> <span class="main">⟹</span>
  subst_bv2 <span class="main">(</span>subst_bvs1' <span class="free">t</span> <span class="main">(</span>Suc <span class="free">lev</span><span class="main">)</span> <span class="free">args</span><span class="main">)</span> <span class="free">lev</span> <span class="free">a</span>
    <span class="main">=</span> subst_bvs1' <span class="free">t</span> <span class="free">lev</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">args</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">#</span><span class="free">args</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">args</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bvs1'.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">lev</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bv2 <span class="main">(</span>subst_bvs1' <span class="main">(</span>Bv <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">lev</span><span class="main">)</span> <span class="skolem">args</span><span class="main">)</span> <span class="skolem">lev</span> <span class="skolem">a</span> <span class="main">=</span>
    subst_bvs1' <span class="main">(</span>Bv <span class="skolem">i</span><span class="main">)</span> <span class="skolem">lev</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">args</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="skolem">lev</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bv2 <span class="main">(</span>subst_bvs1' <span class="main">(</span>Bv <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">lev</span><span class="main">)</span> <span class="skolem">args</span><span class="main">)</span> <span class="skolem">lev</span> <span class="skolem">a</span> <span class="main">=</span>
    subst_bvs1' <span class="main">(</span>Bv <span class="skolem">i</span><span class="main">)</span> <span class="skolem">lev</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">args</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> Suc <span class="skolem">lev</span> <span class="main">&lt;</span> length <span class="skolem">args</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="skolem">lev</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bv2 <span class="main">(</span>subst_bvs1' <span class="main">(</span>Bv <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">lev</span><span class="main">)</span> <span class="skolem">args</span><span class="main">)</span> <span class="skolem">lev</span> <span class="skolem">a</span> <span class="main">=</span> subst_bv2 <span class="main">(</span><span class="skolem">args</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> Suc <span class="skolem">lev</span><span class="main">)</span><span class="main">)</span> <span class="skolem">lev</span> <span class="skolem">a</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">args</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> Suc <span class="skolem">lev</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 1 that<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_closed_subst_bv2_unchanged<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bvs1' <span class="main">(</span>Bv <span class="skolem">i</span><span class="main">)</span> <span class="skolem">lev</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">args</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">args</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> Suc <span class="skolem">lev</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bv2<span class="main">(</span>subst_bvs1' <span class="main">(</span>Bv <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">lev</span><span class="main">)</span> <span class="skolem">args</span><span class="main">)</span> <span class="skolem">lev</span> <span class="skolem">a</span> <span class="main">=</span>
    subst_bvs1' <span class="main">(</span>Bv <span class="skolem">i</span><span class="main">)</span> <span class="skolem">lev</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">args</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> Suc <span class="skolem">lev</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> <span class="skolem">lev</span> <span class="main">≥</span> length <span class="skolem">args</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="skolem">lev</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_closed_subst_bv2_unchanged<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> subst_bvs_extend_lower_level<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">args</span><span class="main">)</span> <span class="main">.</span> is_closed <span class="bound">x</span> <span class="main">⟹</span>
  subst_bv <span class="free">a</span> <span class="main">(</span>subst_bvs1' <span class="free">t</span> <span class="main">1</span> <span class="free">args</span><span class="main">)</span> <span class="main">=</span> subst_bvs <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">args</span><span class="main">)</span> <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> subst_bvs1'_step_extend_lower_level 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_bvs_subst_bvs1' substn_subst_0'<span class="main">)</span>

<span class="keyword1" id="BetaNorm-subst_bvs1'_preserves_beta"><span class="command">lemma</span></span> subst_bvs1'_preserves_beta<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">u</span> <span class="main">.</span> is_closed <span class="bound">x</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">s</span> <span class="main">⟹</span> subst_bvs1' <span class="free">r</span> <span class="free">k</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> subst_bvs1' <span class="free">s</span> <span class="free">k</span> <span class="free">u</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subst_bv2 <span class="skolem">r</span> <span class="free">k</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> subst_bv2 <span class="skolem">s</span> <span class="free">k</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subst_bvs1' <span class="main">(</span>subst_bv2 <span class="skolem">r</span> <span class="free">k</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">k</span> <span class="skolem">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> subst_bvs1' <span class="main">(</span>subst_bv2 <span class="skolem">s</span> <span class="free">k</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">k</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_bvs1'_step<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BetaNorm-subst_bvs1'_fold"><span class="command">lemma</span></span> subst_bvs1'_fold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">args</span> <span class="main">.</span> is_closed <span class="bound">x</span> <span class="main">⟹</span>
  subst_bvs1' <span class="free">t</span> <span class="free">lev</span> <span class="free">args</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">arg</span> <span class="bound">t</span> <span class="main">.</span> subst_bv2 <span class="bound">t</span> <span class="free">lev</span> <span class="bound">arg</span><span class="main">)</span> <span class="free">args</span> <span class="free">t</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">args</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_bvs1'_step<span class="main">)</span>

<span class="keyword1" id="BetaNorm-subst_bvs1'_Abs"><span class="command">lemma</span></span> subst_bvs1'_Abs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">args</span> <span class="main">.</span> is_closed <span class="bound">x</span> <span class="main">⟹</span>
  subst_bvs1' <span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="free">lev</span> <span class="free">args</span> <span class="main">=</span> Abs <span class="free">T</span> <span class="main">(</span>subst_bvs1' <span class="free">t</span> <span class="main">(</span>Suc <span class="free">lev</span><span class="main">)</span> <span class="free">args</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def map_idI<span class="main">)</span>

<span class="keyword1" id="BetaNorm-subst_bvs_Abs"><span class="command">lemma</span></span> subst_bvs_Abs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">args</span> <span class="main">.</span> is_closed <span class="bound">x</span> <span class="main">⟹</span>
  subst_bvs <span class="free">args</span> <span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Abs <span class="free">T</span> <span class="main">(</span>subst_bvs1' <span class="free">t</span> <span class="main">1</span> <span class="free">args</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subst_bvs1'_Abs subst_bvs_subst_bvs1'  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BetaNorm-subst_bvs1'_incr_bv"><span class="command">lemma</span></span> subst_bvs1'_incr_bv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"subst_bvs1' <span class="main">(</span>incr_bv <span class="main">(</span>length <span class="free">ss</span><span class="main">)</span> <span class="free">k</span> <span class="free">t</span><span class="main">)</span> <span class="free">k</span> <span class="free">ss</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BetaNorm-lift_subst_bvs1'"><span class="command">lemma</span></span> lift_subst_bvs1' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> lift <span class="main">(</span>subst_bvs1' <span class="free">t</span> <span class="free">j</span> <span class="free">ss</span><span class="main">)</span> <span class="free">i</span> 
    <span class="main">=</span> subst_bvs1' <span class="main">(</span>lift <span class="free">t</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="free">ss</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="main">.</span> lift <span class="bound">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">ss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span>  <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"lift <span class="main">(</span>subst_bvs1' <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> lift <span class="bound">t</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span>
    subst_bvs1' <span class="main">(</span>lift <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">+</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> lift <span class="bound">t</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> lift <span class="bound">a</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> lift <span class="bound">t</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lift <span class="main">(</span>subst_bvs1' <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">ss</span><span class="main">)</span> <span class="skolem">i</span> 
    <span class="main">=</span> Abs <span class="skolem">T</span> <span class="main">(</span>lift <span class="main">(</span>subst_bvs1' <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> lift <span class="bound">t</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Abs <span class="skolem">T</span>
     <span class="main">(</span>subst_bvs1' <span class="main">(</span>lift <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">+</span> length <span class="main">(</span>map <span class="main">(</span>incr_bv <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
       <span class="main">(</span>map <span class="main">(</span>incr_bv <span class="main">1</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>incr_bv <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Abs <span class="skolem">T</span>
     <span class="main">(</span>subst_bvs1' <span class="main">(</span>lift <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">+</span> length <span class="main">(</span>map <span class="main">(</span>incr_bv <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
       <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> lift <span class="bound">t</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> lift <span class="bound">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="main">.</span> lift <span class="bound">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> lift <span class="bound">t</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> lift <span class="bound">t</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> lift <span class="bound">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lift_lift <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lift_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst_bvs1' <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>lift <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">+</span> length <span class="main">(</span>map <span class="main">(</span>incr_bv <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span>
       <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> lift <span class="bound">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_Suc lift_lift <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="BetaNorm-lift_subst_bvs1'_lt"><span class="command">lemma</span></span> lift_subst_bvs1'_lt<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> lift <span class="main">(</span>subst_bvs1' <span class="free">t</span> <span class="free">j</span> <span class="free">ss</span><span class="main">)</span> <span class="free">i</span> 
  <span class="main">=</span> subst_bvs1' <span class="main">(</span>lift <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="main">.</span> lift <span class="bound">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">ss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> lift_lift 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">smt</span> comp_apply map_eq_conv zero_less_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BetaNorm-subst_bvs1'_subst_bv2"><span class="command">lemma</span></span> subst_bvs1'_subst_bv2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> 
    subst_bv2<span class="main">(</span>subst_bvs1' <span class="free">t</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> lift <span class="bound">v</span> <span class="free">i</span><span class="main">)</span> <span class="free">vs</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span>subst_bvs1' <span class="free">u</span> <span class="free">j</span> <span class="free">vs</span><span class="main">)</span> 
    <span class="main">=</span> subst_bvs1' <span class="main">(</span>subst_bv2 <span class="free">t</span> <span class="free">i</span> <span class="free">u</span><span class="main">)</span> <span class="free">j</span> <span class="free">vs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">vs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">smt</span> One_nat_def Suc_eq_plus1 Suc_less_eq comp_apply lift_lift lift_def
        lift_subst_bvs1'_lt map_eq_conv map_map zero_less_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> subst_bv2_lift <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="BetaNorm-fv_subst_bv2_upper_bound"><span class="command">lemma</span></span> fv_subst_bv2_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>subst_bv2 <span class="free">t</span> <span class="free">lev</span> <span class="free">u</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">t</span> <span class="main">∪</span> fv <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bv2.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="BetaNorm-beta_fv"><span class="command">lemma</span></span> beta_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t</span> <span class="main">⟹</span> fv <span class="free">t</span> <span class="main">⊆</span> fv <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta.induct<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> fv_subst_bv2_upper_bound <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="BetaNorm-loose_bvar1_subst_bvs1'_closeds"><span class="command">lemma</span></span> loose_bvar1_subst_bvs1'_closeds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="free">lev</span> <span class="main">⟹</span> <span class="free">lev</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">us</span> <span class="main">.</span> is_closed <span class="bound">x</span>
  <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="main">(</span>subst_bvs1' <span class="free">t</span> <span class="free">k</span> <span class="free">us</span><span class="main">)</span> <span class="free">lev</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bvs1'.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">use</span> is_open_def loose_bvar_iff_exist_loose_bvar1 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> is_open_def›</span><span class="main">)</span>

<span class="keyword1" id="BetaNorm-is_closed_subst_bvs1'_closeds"><span class="command">lemma</span></span> is_closed_subst_bvs1'_closeds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_dependent <span class="free">t</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">us</span> <span class="main">.</span> is_closed <span class="bound">x</span>
  <span class="main">⟹</span> <span class="main">¬</span> is_dependent <span class="main">(</span>subst_bvs1' <span class="free">t</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">us</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_dependent_def loose_bvar1_subst_bvs1'_closeds<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BetaNormProof">
<div class="head">
<h1>Theory BetaNormProof</h1>
</div>
<pre class="source">
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Facts about beta normalization involving theories›</span></span>

<span class="keyword1"><span class="command">theory</span></span> BetaNormProof
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#BetaNorm">BetaNorm</a> <a href="#Theory">Theory</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="BetaNormProof-beta_preserves_term_ok'"><span class="command">lemma</span></span> beta_preserves_term_ok'<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">s</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ct <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tinstT_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="comment1">(* Seems like I miss a simp rule for Ct*)</span>
    <span class="keyword1"><span class="command">using</span></span> beta_reducible.simps<span class="main">(</span>7<span class="main">)</span> beta_step_imp_beta_reducible <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bv <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">R</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">f</span></span> <span class="main"><span class="main">$</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword1"><span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="skolem"><span class="skolem">s</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> term_ok'_subst_bv2 term_ok'.simps<span class="main">(</span>4<span class="main">)</span> term_ok'.simps<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> term_ok'.simps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> term_ok'.simps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BetaNormProof-beta_preserves_term_ok"><span class="command">lemma</span></span> beta_preserves_term_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">s</span> <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">r</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"None <span class="main">≠</span> typ_of1 <span class="main">[]</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 beta_preserves_typ_of1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> has_typ1_imp_typ_of1 has_typ_def option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> term_ok_def wt_term_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> a2 a1 beta_preserves_term_ok' has_typ_iff_typ_of wt_term_def typ_of_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> beta_preserves_typ_of term_ok_def wf_term_iff_term_ok'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BetaNormProof-beta_star_preserves_term_ok'"><span class="command">lemma</span></span> beta_star_preserves_term_ok'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">r</span>  <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> beta_preserves_term_ok'<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> beta_star_preserves_term_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s</span> <span class="main">⟹</span> term_ok <span class="free">thy</span> <span class="free">r</span>  <span class="main">⟹</span> term_ok <span class="free">thy</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> beta_star_preserves_term_ok' beta_star_preserves_typ_of1 wt_term_def typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     
<span class="keyword1"><span class="command">corollary</span></span> term_ok_beta_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">thy</span> <span class="free">t</span> <span class="main">⟹</span> beta_norm <span class="free">t</span> <span class="main">=</span> Some <span class="free">t'</span><span class="main">⟹</span> term_ok <span class="free">thy</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> beta_norm_imp_beta_reds beta_star_preserves_term_ok <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="EtaNorm">
<div class="head">
<h1>Theory EtaNorm</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Eta Normalization"</span></span>

<span class="keyword1"><span class="command">theory</span></span> EtaNorm
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Term">Term</a> <a href="#BetaNorm">BetaNorm</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(* Again from Lambda calculus from @{dir "~~/src/HOL/Proofs/Lambda"} and modified*)</span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">eta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
    eta <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_dependent <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>η</sub></span></span> decr <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
  <span class="main">|</span> appL <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>η</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>η</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
  <span class="main">|</span> appR <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>η</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>η</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
  <span class="main">|</span> abs <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>η</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>η</sub></span></span> Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">eta_reds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span>   <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> eta<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">eta_red0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span>   <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>=</sup></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>=</sup></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> eta<span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> eta_cases <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Abs <span class="free">T</span> <span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="free">z</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">$</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="free">u</span>"</span></span>
  <span class="quoted"><span class="quoted">"Bv <span class="free">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="free">t</span>"</span></span>

<span class="keyword1" id="EtaNorm-subst_bv2_not_free"><span class="command">lemma</span></span> subst_bv2_not_free <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar1 <span class="free">s</span> <span class="free">i</span> <span class="main">⟹</span> subst_bv2 <span class="free">s</span> <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> subst_bv2 <span class="free">s</span> <span class="free">i</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>

<span class="keyword1" id="EtaNorm-free_lift"><span class="command">lemma</span></span> free_lift <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"loose_bvar1 <span class="main">(</span>lift <span class="free">t</span> <span class="free">k</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">∧</span> loose_bvar1 <span class="free">t</span> <span class="free">i</span> <span class="main">∨</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> loose_bvar1 <span class="free">t</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>

<span class="keyword1" id="EtaNorm-free_subst_bv2"><span class="command">lemma</span></span> free_subst_bv2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"loose_bvar1 <span class="main">(</span>subst_bv2 <span class="free">s</span> <span class="free">k</span> <span class="free">t</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span>
      <span class="main">(</span>loose_bvar1 <span class="free">s</span> <span class="free">k</span> <span class="main">∧</span> loose_bvar1 <span class="free">t</span> <span class="free">i</span> <span class="main">∨</span> loose_bvar1 <span class="free">s</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="keyword1">then</span> <span class="free">i</span> <span class="keyword1">else</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> free_lift <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EtaNorm-free_eta"><span class="command">lemma</span></span> free_eta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="free">t</span> <span class="main">⟹</span> loose_bvar1 <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> loose_bvar1 <span class="free">s</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> eta<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> is_dependent_def loose_bvar1_decr''' loose_bvar1_decr'''' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EtaNorm-not_free_eta"><span class="command">lemma</span></span> not_free_eta<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">s</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_eta<span class="main">)</span>

<span class="keyword1" id="EtaNorm-no_loose_bvar1_subst_bv2_decr"><span class="command">lemma</span></span> no_loose_bvar1_subst_bv2_decr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="free">i</span> <span class="main">⟹</span> subst_bv2 <span class="free">t</span> <span class="free">i</span> <span class="free">x</span> <span class="main">=</span> decr <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bv2.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="EtaNorm-eta_subst_bv2"><span class="command">lemma</span></span> eta_subst_bv2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="free">t</span> <span class="main">⟹</span> subst_bv2 <span class="free">s</span> <span class="free">i</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> subst_bv2 <span class="free">t</span> <span class="free">i</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eta.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eta <span class="skolem">s</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar1 <span class="skolem">s</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> is_dependent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decr <span class="main">0</span> <span class="skolem">s</span> <span class="main">=</span> subst_bv2 <span class="skolem">s</span> <span class="main">0</span> <span class="skolem">dummy</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">dummy</span> 
    <span class="keyword1"><span class="command">using</span></span> no_loose_bvar1_subst_bv2_decr<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">OF</span> 1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">dummy</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dummy</span></span> <span class="keyword2"><span class="keyword">where</span></span> dummy<span class="main">:</span> <span class="quoted"><span class="quoted">"decr <span class="main">0</span> <span class="skolem">s</span> <span class="main">=</span> subst_bv2 <span class="skolem">s</span> <span class="main">0</span> <span class="skolem">dummy</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dummy subst_bv2_subst_bv2 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> free_lift is_dependent_def no_loose_bvar1_subst_bv2_decr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> lift_subst_bv2_dummy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">s</span> <span class="free">i</span> <span class="main">⟹</span> lift <span class="main">(</span>decr <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="EtaNorm-decr_is_closed"><span class="command">lemma</span></span> decr_is_closed<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">t</span> <span class="main">⟹</span> decr <span class="free">lev</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_open_def lift_subst_bv2_dummy lift_def loose_bvar_Suc loose_bvar_incr_bvar no_loose_bvar_no_incr zero_induct<span class="main">)</span>

<span class="keyword1" id="EtaNorm-eta_reducible_imp_eta_step"><span class="command">lemma</span></span> eta_reducible_imp_eta_step<span class="main">:</span> <span class="quoted"><span class="quoted">"eta_reducible <span class="free">t</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="bound">t'</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eta_reducible.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="EtaNorm-eta_step_imp_eta_reducible"><span class="command">lemma</span></span> eta_step_imp_eta_reducible<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="free">t'</span> <span class="main">⟹</span> eta_reducible <span class="free">t</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eta.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">u</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> abs eta_reducible_Abs <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> abs <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EtaNorm-eta_reds_appR"><span class="command">lemma</span></span> eta_reds_appR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">$</span> <span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">u</span> <span class="main">$</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl<span class="main">)</span>
<span class="keyword1" id="EtaNorm-eta_reds_appL"><span class="command">lemma</span></span> eta_reds_appL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">$</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t</span> <span class="main">$</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl<span class="main">)</span>
<span class="keyword1" id="EtaNorm-eta_reds_abs"><span class="command">lemma</span></span> eta_reds_abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t</span> <span class="main">⟹</span> Abs <span class="free">T</span> <span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> Abs <span class="free">T</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl<span class="main">)</span>

<span class="keyword1" id="EtaNorm-eta_norm_imp_eta_reds"><span class="command">lemma</span></span> eta_norm_imp_eta_reds<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eta_norm <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eta_norm.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eta_norm <span class="skolem">body</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_dependent_def eta_reds_abs <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits nat.splits if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eta.eta eta_reds_abs eta_reducible.simps<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> is_dependent_def 
          not_eta_reducible_eta_norm not_eta_reducible_imp_eta_norm_no_change rtranclp.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_dependent_def eta_reds_abs <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits nat.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> eta_norm <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> eta_norm <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eta_norm.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> eta_reds_appL eta_reds_appR rtranclp_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EtaNorm-rtrancl_eta_App"><span class="command">lemma</span></span> rtrancl_eta_App<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">$</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s'</span> <span class="main">$</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eta_reds_appR eta_reds_appL <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtranclp_trans<span class="main">)</span>

<span class="keyword1" id="EtaNorm-eta_preserves_typ_of1"><span class="command">lemma</span></span> eta_preserves_typ_of1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="free">t'</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">τ</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">t'</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typ_of1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">uu</span> <span class="skolem">uv</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> eta_step_imp_eta_reducible <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">Ts</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> eta_step_imp_eta_reducible <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">uw</span> <span class="skolem">ux</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> eta_step_imp_eta_reducible <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">body</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">B</span> <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 4
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eta_cases<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> term.distinct<span class="main"><span class="main">(</span></span>19<span class="main"><span class="main">)</span></span> typ_of1.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> typ_of_Abs_body_typ'<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">u</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> oApp <span class="main">=</span> App
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_dependent <span class="skolem">u</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"4.IH"</span> <span class="quoted">"4.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"4.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> App eta_cases<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> term.inject<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> 
            typ_of1.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> typ_of_Abs_body_typ'<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ct <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 4 oApp False typ_of_Abs_body_typ'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eta_cases<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> term.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> term.inject<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> typ_of1.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> 4 oApp False typ_of_Abs_body_typ' 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eta_cases<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> term.distinct<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> term.inject<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> typ_of1.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bv <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">thm</span></span> 4
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eta_cases<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted">"4.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
            <span class="keyword1"><span class="command">thm</span></span> <span class="quoted">"4"</span><span class="main">(</span>3<span class="main">)</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rty</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="skolem">T</span><span class="main">#</span><span class="skolem">Ts</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">rty</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> typ_of_Abs_body_typ'<span class="main">[</span><span class="operator">OF</span> <span class="quoted">"4"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted">"1"</span><span class="main">(</span>3<span class="main">)</span> <span class="quoted">"1"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">T</span> <span class="main">→</span> <span class="skolem">rty</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"4.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation option.inject typ_of_Abs_body_typ'<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span><span class="skolem">T</span><span class="main">#</span><span class="skolem">Ts</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> typ_of1_arg_typ
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Cons nth_Cons_0 typ_of1.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_less_Suc<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="skolem">Ts</span> <span class="main">(</span>decr <span class="main">0</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> append_Cons append_Nil is_dependent_def list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> typ_of1_decr<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
              <span class="keyword1"><span class="command">using</span></span> 1 oApp False typ_of_Abs_body_typ' Bv 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">t</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
              <span class="keyword1"><span class="command">using</span></span> oApp False typ_of_Abs_body_typ' Bv 0
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"4.IH"</span> <span class="quoted">"4.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> typ_of1.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">nat</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> 4 oApp False typ_of_Abs_body_typ' Bv 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eta_cases<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">T</span></span> <span class="quoted"><span class="skolem">body</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"4.IH"</span> <span class="quoted">"4.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> typ_of1.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> 4 oApp False typ_of_Abs_body_typ'
          <span class="comment1">(* Help metis a bit *)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eta.cases<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> term.distinct<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> term.distinct<span class="main"><span class="main">(</span></span>19<span class="main"><span class="main">)</span></span> term.inject<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> term.inject<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span>
              typ_of1.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> 4 oApp False typ_of_Abs_body_typ'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eta_cases<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> term.distinct<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> term.inject<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> typ_of1.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> 4 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">Ts</span> <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> bind.bind_lunit eta_cases<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> typ_of1.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> typ_of1_split_App_obtains<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EtaNorm-eta_preserves_typ_of"><span class="command">lemma</span></span> eta_preserves_typ_of<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="free">t'</span> <span class="main">⟹</span> typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="free">τ</span> <span class="main">⟹</span> typ_of <span class="free">t'</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eta_preserves_typ_of1 typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1" id="EtaNorm-eta_star_preserves_typ_of1"><span class="command">lemma</span></span> eta_star_preserves_typ_of1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">T</span>  <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_refl <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_into_rtrancl <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> eta_preserves_typ_of1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EtaNorm-eta_star_preserves_typ_of"><span class="command">lemma</span></span> eta_star_preserves_typ_of<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s</span> <span class="main">⟹</span> typ_of <span class="free">r</span> <span class="main">=</span> Some <span class="free">T</span>  <span class="main">⟹</span> typ_of <span class="free">s</span> <span class="main">=</span> Some <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eta_star_preserves_typ_of1 typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="EtaNorm-subst_bvs1'_decr"><span class="command">lemma</span></span> subst_bvs1'_decr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">us</span><span class="main">.</span> is_closed <span class="bound">x</span>  <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="free">k</span> 
  <span class="main">⟹</span> subst_bvs1' <span class="main">(</span>decr <span class="free">k</span> <span class="free">t</span><span class="main">)</span> <span class="free">k</span> <span class="free">us</span> <span class="main">=</span> decr <span class="free">k</span> <span class="main">(</span>subst_bvs1' <span class="free">t</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">us</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> decr.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def<span class="main">)</span>

<span class="keyword1" id="EtaNorm-subst_bvs_decr"><span class="command">lemma</span></span> subst_bvs_decr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">us</span><span class="main">.</span> is_closed <span class="bound">x</span>  <span class="main">⟹</span> <span class="main">¬</span> is_dependent <span class="free">t</span>
  <span class="main">⟹</span> subst_bvs <span class="free">us</span> <span class="main">(</span>decr <span class="main">0</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> decr <span class="main">0</span> <span class="main">(</span>subst_bvs1' <span class="free">t</span> <span class="main">1</span> <span class="free">us</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_dependent_def subst_bvs1'_decr subst_bvs_subst_bvs1'<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="EtaNormProof">
<div class="head">
<h1>Theory EtaNormProof</h1>
</div>
<pre class="source">
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Facts about eta normalization involving theories›</span></span>

<span class="keyword1"><span class="command">theory</span></span> EtaNormProof
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#EtaNorm">EtaNorm</a> <a href="#Theory">Theory</a>
  <span class="comment1">(* This means I need to restructure *)</span>
  <a href="#BetaNormProof">BetaNormProof</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="EtaNormProof-term_ok'_decr"><span class="command">lemma</span></span> term_ok'_decr<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="free">t</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="main">(</span>decr <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> decr.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="EtaNormProof-eta_preserves_term_ok'"><span class="command">lemma</span></span> eta_preserves_term_ok'<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="free">s</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ct <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tinstT_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="comment1">(* Seems like I miss a simp rule for Ct*)</span>
    <span class="keyword1"><span class="command">using</span></span> eta_reducible.simps<span class="main">(</span>12<span class="main">)</span> eta_step_imp_eta_reducible <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> eta.cases 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bv <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">R</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> eta.cases 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> term_ok'_decr<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eta_cases<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> term_ok'.simps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EtaNormProof-eta_preserves_term_ok"><span class="command">lemma</span></span> eta_preserves_term_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="free">s</span> <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">r</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"None <span class="main">≠</span> typ_of1 <span class="main">[]</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 eta_preserves_typ_of1 option.collapse wt_term_def typ_of_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> a2 a1 eta_preserves_term_ok' wt_term_def typ_of_def wf_term_iff_term_ok' term_ok_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> eta_preserves_typ_of has_typ_iff_typ_of<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EtaNormProof-eta_star_preserves_term_ok'"><span class="command">lemma</span></span> eta_star_preserves_term_ok'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">r</span>  <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_preserves_term_ok'<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> eta_star_preserves_term_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s</span> <span class="main">⟹</span> term_ok <span class="free">thy</span> <span class="free">r</span>  <span class="main">⟹</span> term_ok <span class="free">thy</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eta_star_preserves_term_ok' eta_star_preserves_typ_of1 wt_term_def typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     
<span class="keyword1"><span class="command">corollary</span></span> term_ok_eta_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">thy</span> <span class="free">t</span> <span class="main">⟹</span> eta_norm <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span><span class="main">⟹</span> term_ok <span class="free">thy</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eta_norm_imp_eta_reds eta_star_preserves_term_ok <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Logic">
<div class="head">
<h1>Theory Logic</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Logic"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Logic            
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Theory">Theory</a> <a href="#Term_Subst">Term_Subst</a> <a href="#SortConstants">SortConstants</a> <a href="#Name">Name</a> <a href="#BetaNormProof">BetaNormProof</a> <a href="#EtaNormProof">EtaNormProof</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted">proves</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">inst_ok</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="main">≡</span> 
    distinct <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">insts</span></span></span><span class="main">)</span> <span class="comment1">―‹No duplicates, makes stuff easier›</span>
  <span class="main">∧</span> list_all <span class="main">(</span>typ_ok <span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">)</span> <span class="main">(</span>map snd <span class="free"><span class="bound"><span class="entity">insts</span></span></span><span class="main">)</span> <span class="comment1">―‹Stuff I substitute in is well typed›</span>
  <span class="main">∧</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">.</span> has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span> <span class="bound">S</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span>"</span></span> <span class="comment1">―‹Types "fit" in the Fviables›</span>

<span class="keyword1" id="Logic-inst_ok_imp_wf_inst"><span class="command">lemma</span></span> inst_ok_imp_wf_inst<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"inst_ok <span class="free">Θ</span> <span class="free">insts</span> <span class="main">⟹</span> wf_inst <span class="free">Θ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">idn</span> <span class="bound">S</span> <span class="main">.</span>the_default <span class="main">(</span>Tv <span class="bound">idn</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="free">insts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>

<span class="keyword1" id="Logic-term_ok'_eta_norm"><span class="command">lemma</span></span> term_ok'_eta_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="free">t</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="main">(</span>eta_norm <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eta_norm.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits nat.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> term_ok'_decr is_dependent_def<span class="main">)</span>
<span class="keyword1"><span class="command">corollary</span></span> term_ok_eta_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">thy</span> <span class="free">t</span> <span class="main">⟹</span> term_ok <span class="free">thy</span> <span class="main">(</span>eta_norm <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wt_term_def typ_of_eta_norm term_ok'_eta_norm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">beta_eta_norm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> map_option eta_norm <span class="main">(</span>beta_norm <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"beta_eta_norm <span class="free">t</span> <span class="main">=</span> Some <span class="free">t'</span> <span class="main">⟹</span> <span class="main">¬</span> eta_reducible <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_eta_reducible_eta_norm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Logic-term_ok_beta_eta_norm"><span class="command">lemma</span></span> term_ok_beta_eta_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">thy</span> <span class="free">t</span> <span class="main">⟹</span> beta_eta_norm <span class="free">t</span> <span class="main">=</span> Some <span class="free">t'</span> <span class="main">⟹</span> term_ok <span class="free">thy</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> term_ok_eta_norm term_ok_beta_norm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1" id="Logic-typ_of_beta_eta_norm"><span class="command">lemma</span></span> typ_of_beta_eta_norm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="free">T</span> <span class="main">⟹</span> beta_eta_norm <span class="free">t</span> <span class="main">=</span> Some <span class="free">t'</span> <span class="main">⟹</span> typ_of <span class="free">t'</span> <span class="main">=</span> Some <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> beta_norm_imp_beta_reds beta_star_preserves_typ_of1 typ_of1_eta_norm typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Logic-inst_ok_nil"><span class="command">lemma</span></span> inst_ok_nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inst_ok <span class="free">Θ</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logic-axiom_subst_typ'"><span class="command">lemma</span></span> axiom_subst_typ'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span>axioms <span class="free">Θ</span>"</span></span> <span class="quoted"><span class="quoted">"inst_ok <span class="free">Θ</span> <span class="free">insts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> subst_typ' <span class="free">insts</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_inst <span class="free">Θ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">idn</span> <span class="bound">S</span> <span class="main">.</span> the_default <span class="main">(</span>Tv <span class="bound">idn</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="free">insts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inst_ok_imp_wf_inst assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_typ' <span class="free">insts</span> <span class="free">A</span>
    <span class="main">=</span> tsubst <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">idn</span> <span class="bound">S</span> <span class="main">.</span> the_default <span class="main">(</span>Tv <span class="bound">idn</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="free">insts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tsubst_simulates_subst_typ'<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms axiom <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> axiom'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> axioms <span class="free">Θ</span> <span class="main">⟹</span> <span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_typ'_nil<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> axiom_subst_typ' inst_ok_nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Logic-has_sort_Tv_refl"><span class="command">lemma</span></span> has_sort_Tv_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_osig <span class="free">oss</span> <span class="main">⟹</span> sort_ex <span class="main">(</span>subclass <span class="free">oss</span><span class="main">)</span> <span class="free">S</span> <span class="main">⟹</span> has_sort <span class="free">oss</span> <span class="main">(</span>Tv <span class="free">v</span> <span class="free">S</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">oss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> osig_subclass_loc wf_subclass_loc.intro has_sort_Tv wf_subclass_loc.sort_leq_refl<span class="main">)</span>

<span class="keyword1" id="Logic-has_sort_Tv_refl'"><span class="command">lemma</span></span> has_sort_Tv_refl'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> typ_ok <span class="free">Θ</span> <span class="main">(</span>Tv <span class="free">v</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Tv <span class="free">v</span> <span class="free">S</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> has_sort_Tv_refl
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_sig.simps osig.elims wf_theory_imp_wf_sig typ_ok_def
      wf_type_imp_typ_ok_sig typ_ok_sig.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wf_sort_def<span class="main">)</span>

<span class="keyword1" id="Logic-wf_inst_imp_inst_ok"><span class="command">lemma</span></span> wf_inst_imp_inst_ok<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> distinct <span class="free">l</span> <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">l</span> <span class="main">.</span> typ_ok <span class="free">Θ</span> <span class="main">(</span>Tv <span class="bound">v</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟹</span> wf_inst <span class="free">Θ</span> <span class="free">ρ</span> 
  <span class="main">⟹</span> inst_ok <span class="free">Θ</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="bound">v</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"inst_ok <span class="free">Θ</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="bound">v</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> case_prod <span class="free">ρ</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="bound">v</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff prod.case_eq_if<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="bound">v</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> I distinct_kv_list distinct_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span> <span class="bound">v</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_type <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>case_prod <span class="free">ρ</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>3-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> typ_ok_Tv wf_type_imp_typ_ok_sig<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="main">(</span>case_prod <span class="free">ρ</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_prod <span class="free">ρ</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> has_sort_Tv_refl' prod.case_eq_if wf_inst_def<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> typ_ok_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* MOVE to term, also use for transfering proofs *)</span>
<span class="keyword1" id="Logic-typs_of_fv_subset_Types"><span class="command">lemma</span></span> typs_of_fv_subset_Types<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> fv <span class="free">t</span> <span class="main">⊆</span> Types <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Logic-osig_tvsT_subset_SortsT"><span class="command">lemma</span></span> osig_tvsT_subset_SortsT<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> tvsT <span class="free">T</span> <span class="main">⊆</span> SortsT <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Logic-osig_tvs_subset_Sorts"><span class="command">lemma</span></span> osig_tvs_subset_Sorts<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> tvs <span class="free">t</span> <span class="main">⊆</span> Sorts <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> osig_tvsT_subset_SortsT <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> image_subset_iff›</span><span class="main">)</span>
  
<span class="keyword1" id="Logic-term_ok_Types_imp_typ_ok_pre"><span class="command">lemma</span></span> term_ok_Types_imp_typ_ok_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_std_sig <span class="free">Σ</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">τ</span> <span class="main">∈</span> Types <span class="free">t</span> <span class="main">⟹</span> typ_ok_sig <span class="free">Σ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">τ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Logic-term_ok_Types_typ_ok"><span class="command">lemma</span></span> term_ok_Types_typ_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">τ</span> <span class="main">∈</span> Types <span class="free">t</span> <span class="main">⟹</span> typ_ok <span class="free">Θ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def 
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> term_ok_Types_imp_typ_ok_pre<span class="main">)</span>

<span class="keyword1" id="Logic-term_ok_fv_imp_typ_ok_pre"><span class="command">lemma</span></span> term_ok_fv_imp_typ_ok_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_std_sig <span class="free">Σ</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">∈</span> fv <span class="free">t</span> <span class="main">⟹</span> typ_ok_sig <span class="free">Σ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typs_of_fv_subset_Types term_ok_Types_imp_typ_ok_pre
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_subset_iff snd_conv<span class="main">)</span>

<span class="keyword1" id="Logic-term_ok_vars_typ_ok"><span class="command">lemma</span></span> term_ok_vars_typ_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∈</span> fv <span class="free">t</span> <span class="main">⟹</span> typ_ok <span class="free">Θ</span> <span class="free">τ</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> term_ok_Types_typ_ok typs_of_fv_subset_Types <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_subset_iff snd_conv<span class="main">)</span> 

<span class="keyword1" id="Logic-typ_ok_TFreesT_imp_sort_ok_pre"><span class="command">lemma</span></span> typ_ok_TFreesT_imp_sort_ok_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_std_sig <span class="free">Σ</span> <span class="main">⟹</span> typ_ok_sig <span class="free">Σ</span> <span class="free">T</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> tvsT <span class="free">T</span> <span class="main">⟹</span> wf_sort <span class="main">(</span>subclass <span class="main">(</span>osig <span class="free">Σ</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_list <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_sort_def<span class="main">)</span> 

<span class="keyword1" id="Logic-term_ok_TFrees_imp_sort_ok_pre"><span class="command">lemma</span></span> term_ok_TFrees_imp_sort_ok_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_std_sig <span class="free">Σ</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> tvs <span class="free">t</span> <span class="main">⟹</span> wf_sort <span class="main">(</span>subclass <span class="main">(</span>osig <span class="free">Σ</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ct <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">use</span> typ_ok_TFreesT_imp_sort_ok_pre wf_sort_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">use</span> typ_ok_TFreesT_imp_sort_ok_pre wf_sort_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bv <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> typ_ok_TFreesT_imp_sort_ok_pre wf_sort_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 
  
<span class="keyword1" id="Logic-typ_ok_tvsT_imp_sort_ok_pre"><span class="command">lemma</span></span> typ_ok_tvsT_imp_sort_ok_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_std_sig <span class="free">Σ</span> <span class="main">⟹</span> typ_ok_sig <span class="free">Σ</span> <span class="free">T</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">S</span><span class="main">)</span> <span class="main">∈</span> tvsT <span class="free">T</span> <span class="main">⟹</span> wf_sort <span class="main">(</span>subclass <span class="main">(</span>osig <span class="free">Σ</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_list <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_sort_def<span class="main">)</span> 

<span class="keyword1" id="Logic-term_ok_tvars_sort_ok"><span class="command">lemma</span></span> term_ok_tvars_sort_ok<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> tvs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_sort <span class="main">(</span>subclass <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_std_sig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> term_ok_TFrees_imp_sort_ok_pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logic-term_ok'_bind_fv2"><span class="command">lemma</span></span> term_ok'_bind_fv2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">T</span><span class="main">)</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">T</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bind_fv2.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-term_ok'_bind_fv"><span class="command">lemma</span></span> term_ok'_bind_fv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> term_ok'_bind_fv2 bind_fv_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Logic-term_ok'_Abs_fv"><span class="command">lemma</span></span> term_ok'_Abs_fv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> term_ok'_bind_fv assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logic-term_ok'_mk_all"><span class="command">lemma</span></span> term_ok'_mk_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">B</span> <span class="main">=</span> Some propT"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>mk_all <span class="free">x</span> <span class="free">τ</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms term_ok'_bind_fv 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_theory.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typ_of_def tinstT_def<span class="main">)</span>

<span class="keyword1" id="Logic-term_ok_mk_all"><span class="command">lemma</span></span> term_ok_mk_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">B</span> <span class="main">=</span> Some propT"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_all <span class="free">x</span> <span class="free">τ</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typ_of_mk_all term_ok'_mk_all assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>

<span class="keyword1" id="Logic-term_ok'_incr_boundvars"><span class="command">lemma</span></span> term_ok'_incr_boundvars<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>incr_boundvars <span class="free">lev</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> term_ok'_incr_bv incr_boundvars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logic-term_ok'_subst_bv1"><span class="command">lemma</span></span> term_ok'_subst_bv1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>subst_bv1 <span class="free">f</span> <span class="free">lev</span> <span class="free">u</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bv1.induct<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> term_ok'_incr_boundvars <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1" id="Logic-term_ok'_subst_bv"><span class="command">lemma</span></span> term_ok'_subst_bv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="free">f</span> <span class="free">u</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms term_ok'_subst_bv1 subst_bv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logic-term_ok'_betapply"><span class="command">lemma</span></span> term_ok'_betapply<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∙</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms term_ok'_subst_bv1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_bv_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Logic-term_ok_betapply"><span class="command">lemma</span></span> term_ok_betapply<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">u</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">uty</span> <span class="main">→</span> <span class="free">tty</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">u</span> <span class="main">=</span> Some <span class="free">uty</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span><span class="free">f</span> <span class="main">∙</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms term_ok'_betapply wt_term_def typ_of_betaply assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Logic-typ_ok_sig_subst_typ"><span class="command">lemma</span></span> typ_ok_sig_subst_typ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_std_sig <span class="free">Σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="free">ty</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>typ_ok_sig <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="free">ty</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span> <span class="quoted"><span class="free">ty</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_typ.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">inst</span> <span class="skolem">a</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="main">(</span>subst_typ <span class="skolem">inst</span> <span class="skolem">ty</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ty</span> <span class="main">∈</span> set <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ty</span> 
    <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ty</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="skolem">inst</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="main">.</span> typ_ok_sig <span class="free">Σ</span> <span class="bound">ty</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>typ_ok_sig <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="skolem">inst</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> list_all_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="skolem">inst</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">Ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">inst</span> <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inst</span> <span class="main">≠</span> None"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> this 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">res</span></span> <span class="keyword2"><span class="keyword">where</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inst</span> <span class="main">=</span> Some <span class="skolem">res</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="skolem">inst</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 res <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">inst</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="skolem">res</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>4<span class="main">)</span> res 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">inst</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>  
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> res <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> rewr<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ <span class="skolem">inst</span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> Tv <span class="skolem">idn</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* MOVE *)</span>
<span class="keyword1"><span class="command">corollary</span></span> subst_typ_tinstT<span class="main">:</span> <span class="quoted"><span class="quoted">"tinstT <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="free">ty</span><span class="main">)</span> <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tinstT_def <span class="keyword1"><span class="command">using</span></span> tsubstT_simulates_subst_typ <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Logic-tsubstT_trans"><span class="command">lemma</span></span> tsubstT_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"tsubstT <span class="free">ty</span> <span class="free">ρ1</span> <span class="main">=</span> <span class="free">ty1</span> <span class="main">⟹</span> tsubstT <span class="free">ty1</span> <span class="free">ρ2</span> <span class="main">=</span> <span class="free">ty2</span> 
  <span class="main">⟹</span> tsubstT <span class="free">ty</span> <span class="main">(</span><span class="main">λ</span><span class="bound">idx</span> <span class="bound">s</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="free">ρ1</span> <span class="bound">idx</span> <span class="bound">s</span> <span class="keyword1">of</span> Tv <span class="bound">idx'</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="free">ρ2</span> <span class="bound">idx'</span> <span class="bound">s'</span> 
  <span class="main">|</span> Ty <span class="bound">s</span> <span class="bound">Ts</span> <span class="main">⇒</span> Ty <span class="bound">s</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> tsubstT <span class="bound">T</span> <span class="free">ρ2</span><span class="main">)</span> <span class="bound">Ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">ty2</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> tinstT_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ty</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ty1</span></span> <span class="quoted"><span class="free">ty2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">idx</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ρ1</span> <span class="skolem">idx</span> <span class="skolem">s</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> tinstT_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"tinstT <span class="free">ty1</span> <span class="free">ty</span> <span class="main">⟹</span> tinstT <span class="free">ty2</span> <span class="free">ty1</span> <span class="main">⟹</span> tinstT <span class="free">ty2</span> <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tinstT_def <span class="keyword1"><span class="command">using</span></span> tsubstT_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Logic-term_ok'_subst_typ'"><span class="command">lemma</span></span> term_ok'_subst_typ'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_std_sig <span class="free">Σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>typ_ok_sig <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> 
    <span class="main">(</span><span class="operator">use</span> typ_ok_sig_subst_typ subst_typ_tinstT tinstT_trans <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits›</span><span class="main">)</span>

<span class="comment1">(* This is a bit suspect, as I am disregarding abstractions... *)</span>
<span class="keyword1" id="Logic-term_ok'_occs"><span class="command">lemma</span></span> 
  term_ok'_occs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_std_sig <span class="free">Σ</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">t</span> <span class="main">⟹</span> occs <span class="free">u</span> <span class="free">t</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
                                                
<span class="keyword1" id="Logic-typ_of1_tsubst"><span class="command">lemma</span></span> typ_of1_tsubst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span> <span class="main">⟹</span> typ_of1 <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">T</span> <span class="main">.</span> tsubstT <span class="bound">T</span> <span class="free">ρ</span><span class="main">)</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">(</span>tsubst <span class="free">t</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>tsubstT <span class="free">ty</span> <span class="free">ρ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ty</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typ_of1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">Ts</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">body</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">Ts</span> <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"5.prems"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u_ty</span></span> <span class="keyword2"><span class="keyword">where</span></span> u_ty<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="skolem">Ts</span> <span class="skolem">u</span> <span class="main">=</span> Some <span class="skolem">u_ty</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted">"5.prems"</span> <span class="keyword1"><span class="command">have</span></span> f_ty<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="skolem">Ts</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">u_ty</span> <span class="main">→</span> <span class="skolem">ty</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv typ_of1_arg_typ<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted">"5.prems"</span><span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> 
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits typ.splits option.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> u_ty <span class="quoted">"5.IH"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> tsubstT <span class="bound">T</span> <span class="free">ρ</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="main">(</span>tsubst <span class="skolem">u</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>tsubstT <span class="skolem">u_ty</span> <span class="free">ρ</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> u_ty f_ty <span class="quoted">"5.IH"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> tsubstT <span class="bound">T</span> <span class="free">ρ</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="main">(</span>tsubst <span class="skolem">f</span> <span class="free">ρ</span><span class="main">)</span> 
    <span class="main">=</span> Some <span class="main">(</span>tsubstT <span class="main">(</span><span class="skolem">u_ty</span> <span class="main">→</span> <span class="skolem">ty</span><span class="main">)</span> <span class="free">ρ</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> typ_of1_tsubst_weak<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">ty</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">T</span> <span class="main">.</span> tsubstT <span class="bound">T</span> <span class="free">ρ</span><span class="main">)</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">(</span>tsubst <span class="free">t</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">ty'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tsubstT <span class="free">ty</span> <span class="free">ρ</span> <span class="main">=</span> <span class="free">ty'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms typ_of1_tsubst <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-tsubstT_no_change"><span class="command">lemma</span></span> tsubstT_no_change<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tsubstT <span class="free">T</span> Tv <span class="main">=</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_idI<span class="main">)</span>

<span class="keyword1" id="Logic-term_ok_mk_eq_same_typ"><span class="command">lemma</span></span> term_ok_mk_eq_same_typ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_eq <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">s</span> <span class="main">=</span> typ_of <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span>
   <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def typ_of_def bind_eq_Some_conv tinstT_def<span class="main">)</span>

<span class="keyword1" id="Logic-typ_of_eta_expand"><span class="command">lemma</span></span> typ_of_eta_expand<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">⟹</span> typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typ_of1_weaken <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv typ_of_def<span class="main">)</span>

<span class="keyword1" id="Logic-term_okI"><span class="command">lemma</span></span> term_okI<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> typ_of <span class="free">t</span> <span class="main">≠</span> None <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>
<span class="keyword1" id="Logic-term_okD1"><span class="command">lemma</span></span> term_okD1<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span> <span class="main">⟹</span> term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>
<span class="keyword1" id="Logic-term_okD2"><span class="command">lemma</span></span> term_okD2<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span> <span class="main">⟹</span> typ_of <span class="free">t</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>

<span class="keyword1" id="Logic-term_ok_imp_typ_ok'"><span class="command">lemma</span></span> term_ok_imp_typ_ok'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="main">(</span>the <span class="main">(</span>typ_of <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ty</span></span> <span class="keyword2"><span class="keyword">where</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="skolem">ty</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms option.exhaust term_okD2<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="skolem">ty</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> term_ok_imp_typ_ok assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logic-term_ok_mk_eqI"><span class="command">lemma</span></span> term_ok_mk_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">s</span> <span class="main">=</span> typ_of <span class="free">t</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_eq <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> term_okI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="main">(</span>the <span class="main">(</span>typ_of <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> term_ok_imp_typ_ok' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>typ_of <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>mk_eq <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> term_okD1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tinstT_def<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>mk_eq <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> term_okD2 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logic-typ_of1_decr'"><span class="command">lemma</span></span> typ_of1_decr'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="main">0</span> <span class="main">⟹</span> typ_of1 <span class="main">(</span><span class="free">T</span><span class="main">#</span><span class="free">Ts</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">τ</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="main">(</span>decr <span class="main">0</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typ_of1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">Ts</span> <span class="skolem">B</span> <span class="skolem">body</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> typ_of1_decr_gen
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> typ_of1_decr_gen<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">Ts</span> <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> no_loose_bvar1_subst_bv2_decr subst_bv_def substn_subst_0' typ_of1.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> typ_of1_subst_bv_gen'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
  
<span class="keyword1" id="Logic-typ_of1_eta_red_step_pre"><span class="command">lemma</span></span> typ_of1_eta_red_step_pre<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="main">0</span> <span class="main">⟹</span> 
  typ_of1 <span class="free">Ts</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">t</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">⟹</span> typ_of1 <span class="free">Ts</span> <span class="main">(</span>decr <span class="main">0</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typ_of1_decr'
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> length_Cons nth_Cons_0 typ_of1.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> typ_of1_arg_typ typ_of_Abs_body_typ' zero_less_Suc<span class="main">)</span>

<span class="keyword1" id="Logic-typ_of1_eta_red_step"><span class="command">lemma</span></span> typ_of1_eta_red_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_dependent <span class="free">t</span> <span class="main">⟹</span> 
  typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">t</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">⟹</span> typ_of <span class="main">(</span>decr <span class="main">0</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typ_of_def is_dependent_def typ_of1_eta_red_step_pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* MOVE *)</span>
<span class="keyword1" id="Logic-distinct_add_vars'"><span class="command">lemma</span></span> distinct_add_vars'<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">acc</span> <span class="main">⟹</span> distinct <span class="main">(</span>add_vars' <span class="free">t</span> <span class="free">acc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_vars'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">acc</span></span><span class="main">)</span> <span class="operator">auto</span>
  
<span class="keyword1" id="Logic-distinct_add_tvarsT'"><span class="command">lemma</span></span> distinct_add_tvarsT'<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">acc</span> <span class="main">⟹</span> distinct <span class="main">(</span>add_tvarsT' <span class="free">T</span> <span class="free">acc</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">acc</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_tvarsT'_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_tvarsT'_def<span class="main">)</span> 

<span class="keyword1" id="Logic-distinct_add_tvars'"><span class="command">lemma</span></span> distinct_add_tvars'<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">acc</span> <span class="main">⟹</span> distinct <span class="main">(</span>add_tvars' <span class="free">t</span> <span class="free">acc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">acc</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_tvars'_def fold_types_def distinct_add_tvarsT'<span class="main">)</span>

<span class="comment1">(* Figure out better syntax for goal *)</span>
<span class="keyword1" id="Logic-proved_terms_well_formed_pre"><span class="command">lemma</span></span> proved_terms_well_formed_pre<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">p</span> <span class="main">⟹</span> typ_of <span class="free">p</span> <span class="main">=</span> Some propT <span class="main">∧</span> term_ok <span class="free">Θ</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> proves.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>axiom <span class="skolem">A</span> <span class="skolem">ρ</span><span class="main">)</span>           

  <span class="keyword1"><span class="command">from</span></span> axiom <span class="keyword1"><span class="command">have</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">[]</span> <span class="skolem">A</span> <span class="main">=</span> Some propT"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def typ_of_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"add_tvars' <span class="skolem">A</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ρ</span> <span class="bound">v</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="var">?l</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?l</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> distinct_add_tvars' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?l</span> <span class="main">.</span> typ_ok <span class="free">Θ</span> <span class="main">(</span>Tv <span class="bound">v</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="main">(</span>Tv <span class="skolem">v</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> tvs <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="skolem">T</span>
      <span class="keyword1"><span class="command">using</span></span> axiom.hyps<span class="main">(</span>1<span class="main">)</span> axiom.hyps<span class="main">(</span>2<span class="main">)</span> axioms_terms_ok
        term_ok_tvars_sort_ok that typ_ok_def typ_ok_Tv
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> wf_sort_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?l</span> <span class="main">=</span> tvs <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?l</span> <span class="main">.</span> has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Tv <span class="bound">v</span> <span class="bound">S</span><span class="main">)</span> <span class="bound">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> axiom.hyps<span class="main">(</span>1<span class="main">)</span> has_sort_Tv_refl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inst_ok <span class="free">Θ</span> <span class="var">?l'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_inst_imp_inst_ok<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> axiom.hyps<span class="main">(</span>1<span class="main">)</span> axiom.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> simp<span class="main">:</span> <span class="quoted"><span class="quoted">"tsubst <span class="skolem">A</span> <span class="skolem">ρ</span> <span class="main">=</span> subst_typ' <span class="var">?l'</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dist subst_typ'_simulates_tsubst_gen' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">[]</span> <span class="main">(</span>tsubst <span class="skolem">A</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">=</span> Some propT"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tsubst_simulates_subst_typ' axioms_typ_of_propT typ_of1_tsubst ty <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">[]</span> <span class="main">(</span>subst_typ' <span class="var">?l'</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> Some propT"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> axiom <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="skolem">A</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>subst_typ' <span class="var">?l'</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> axiom term_ok'_subst_typ' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff wt_term_def typ_of_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹inst_ok <span class="free">Θ</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ρ</span> <span class="bound">v</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>add_tvars' <span class="skolem">A</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>›</span></span> 
        axiom.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.pred_mono_strong sig.simps term_ok'_subst_typ' wf_theory.simps
        typ_ok_def wf_type_imp_typ_ok_sig<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> simp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def typ_of_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"assume"</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">(*Same as case above*)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>forall_intro <span class="skolem">Γ</span> <span class="skolem">B</span> <span class="skolem">x</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="skolem">B</span> <span class="main">=</span> Some propT"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typ_of_mk_all forall_intro
      term_ok_mk_all<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹wf_theory <span class="free">Θ</span>›</span></span> <span class="quoted"><span class="quoted">‹term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="skolem">B</span>›</span></span> 
        <span class="quoted"><span class="quoted">‹typ_of <span class="skolem">B</span> <span class="main">=</span> Some propT›</span></span> _<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹wf_type <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="skolem">τ</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>forall_elim <span class="skolem">Γ</span> <span class="skolem">τ</span> <span class="skolem">B</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> term_ok'_subst_bv1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typ_of_def term_ok'_subst_bv tinstT_def 
        wt_term_def bind_eq_Some_conv subst_bv_def typ_of1_subst_bv_gen' 
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>implies_intro <span class="skolem">Γ</span> <span class="skolem">B</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_theory.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typ_of_def wt_term_def tinstT_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>implies_elim <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv typ_of_def wt_term_def tinstT_def 
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>of_class <span class="skolem">c</span> <span class="skolem">iT</span> <span class="skolem">T</span><span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span>  
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv typ_of_def wt_term_def 
        tinstT_def mk_of_class_def mk_type_def<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>β_conversion <span class="skolem">T</span> <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some propT"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typ_of_def wt_term_def subst_bv_def bind_eq_Some_conv 
        typ_of1_subst_bv_gen'<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="comment1">(* This needs to be moved out *)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> β_conversion.hyps<span class="main">(</span>2<span class="main">)</span> β_conversion.hyps<span class="main">(</span>3<span class="main">)</span> term_ok'.simps<span class="main">(</span>4<span class="main">)</span> wt_term_def term_ok_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> subst_bv_def term_ok'_subst_bv1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"const_type <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.eq''</span>
        <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span>Tv <span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">(</span>Tv <span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> β_conversion.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span><span class="main">)</span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted">"1"</span> typ_of1_split_App typ_of_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>subst_bv <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> list.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subst_bv_def typ.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> typ_of1_split_App typ_of1_subst_bv_gen' typ_of_Abs_body_typ' typ_of_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> β_conversion.hyps<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> calculation<span class="main">(</span>5<span class="main">)</span> wt_term_def term_ok_imp_typ_ok typ_ok_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t'</span> <span class="main">→</span> propT<span class="main">)</span> "</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_theory <span class="free">Θ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tinstT <span class="main">(</span><span class="skolem">T</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">T</span> <span class="main">→</span> propT<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>Tv <span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">(</span>Tv <span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> tinstT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tinstT <span class="main">(</span><span class="skolem">t'</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">t'</span> <span class="main">→</span> propT<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>Tv <span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">(</span>Tv <span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> tinstT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_theory <span class="free">Θ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eta <span class="skolem">t</span> <span class="skolem">τ</span> <span class="skolem">τ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> tyeta<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="skolem">τ</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">τ</span> <span class="main">→</span> <span class="skolem">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> typ_of_eta_expand <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_dependent <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eta.hyps<span class="main">(</span>3<span class="main">)</span> typ_of_imp_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> is_dependent_def is_open_def loose_bvar1_imp_loose_bvar <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> ty_decr<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>decr <span class="main">0</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">τ</span> <span class="main">→</span> <span class="skolem">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> typ_of1_eta_red_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="skolem">τ</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>decr <span class="main">0</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some propT"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eta tyeta <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typ_of_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="main">(</span><span class="skolem">τ</span> <span class="main">→</span> <span class="skolem">τ'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> eta term_ok_imp_typ_ok <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> typ_ok_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> tyok<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="skolem">τ</span>"</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="skolem">τ'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> typ_ok_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="skolem">τ</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> eta<span class="main">(</span>2<span class="main">)</span> tyeta <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>decr <span class="main">0</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eta term_ok'_decr tyeta ty_decr wt_term_def typ_ok_def tyok 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tinstT_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="skolem">τ</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>decr <span class="main">0</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> eta.hyps ty_decr tyeta tyok 1 term_ok_mk_eqI
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1
    <span class="keyword1"><span class="command">using</span></span> eta.hyps<span class="main">(</span>2<span class="main">)</span> eta.hyps<span class="main">(</span>3<span class="main">)</span> has_typ_imp_closed term_ok_subst_bv_no_change
      closed_subst_bv_no_change <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> proved_terms_well_formed<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">p</span> <span class="main">=</span> Some propT"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms proved_terms_well_formed_pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-forall_intros"><span class="command">lemma</span></span> forall_intros<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> <span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span><span class="main">∈</span>set <span class="free">frees</span> <span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">τ</span><span class="main">)</span> <span class="main">∉</span> FV <span class="free">Γ</span> <span class="main">∧</span> typ_ok <span class="free">Θ</span> <span class="bound">τ</span> 
    <span class="main">⟹</span> <span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_all_list <span class="free">frees</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">frees</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> proves.forall_intro <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_all_list_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> FV_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="comment1">(* MOVE *)</span>
<span class="keyword1" id="Logic-term_ok_var"><span class="command">lemma</span></span> term_ok_var<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Fv <span class="free">idn</span> <span class="free">τ</span><span class="main">)</span> <span class="main">=</span> typ_ok <span class="free">Θ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def typ_of_def<span class="main">)</span>
<span class="keyword1" id="Logic-typ_of_var"><span class="command">lemma</span></span> typ_of_var<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Fv <span class="free">idn</span> <span class="free">τ</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typ_of_def<span class="main">)</span>

<span class="comment1">(* Is this a simp rule? *)</span>
<span class="keyword1" id="Logic-is_closed_Fv"><span class="command">lemma</span></span> is_closed_Fv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="main">(</span>Fv <span class="free">idn</span> <span class="free">τ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> proved_terms_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span> <span class="main">⟹</span> is_closed <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> proved_terms_well_formed<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> typ_of_imp_closed<span class="main">)</span>

<span class="keyword1" id="Logic-not_loose_bvar_bind_fv2"><span class="command">lemma</span></span> not_loose_bvar_bind_fv2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="free">lev</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar <span class="main">(</span>bind_fv2 <span class="free">v</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">lev</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Logic-not_loose_bvar_bind_fv2_"><span class="command">lemma</span></span> not_loose_bvar_bind_fv2_<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="main">(</span>bind_fv2 <span class="free">v</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="free">lev</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="free">lev</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Logic-fold_add_vars'_FV_pre"><span class="command">lemma</span></span> fold_add_vars'_FV_pre<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fold add_vars' <span class="free">Hs</span> <span class="free">acc</span><span class="main">)</span> <span class="main">=</span> set <span class="free">acc</span> <span class="main">∪</span> FV <span class="main">(</span>set <span class="free">Hs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Hs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">acc</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_vars'_fv_pre<span class="main">)</span>
<span class="keyword1"><span class="command">corollary</span></span> fold_add_vars'_FV<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fold <span class="main">(</span>add_vars'<span class="main">)</span> <span class="free">Hs</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> FV <span class="main">(</span>set <span class="free">Hs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fold_add_vars'_FV_pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logic-forall_intro_vars"><span class="command">lemma</span></span> forall_intro_vars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> set <span class="free">Hs</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> set <span class="free">Hs</span> <span class="main">⊢</span> forall_intro_vars <span class="free">B</span> <span class="free">Hs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> forall_intros<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">using</span></span> add_vars'_fv proved_terms_well_formed_pre term_ok_vars_typ_ok 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> term_ok_vars_typ_ok typ_ok_def wf_type_imp_typ_ok_sig<span class="main">)</span>

<span class="comment1">(* MOVE *)</span>
<span class="keyword1" id="Logic-mk_all_list'_preserves_term_ok_typ_of"><span class="command">lemma</span></span> mk_all_list'_preserves_term_ok_typ_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">B</span> <span class="main">=</span> Some propT"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span><span class="bound">ty</span><span class="main">)</span><span class="main">∈</span>set <span class="free">vs</span> <span class="main">.</span> typ_ok <span class="free">Θ</span> <span class="bound">ty</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_all_list <span class="free">vs</span> <span class="free">B</span><span class="main">)</span> <span class="main">∧</span> typ_of <span class="main">(</span>mk_all_list <span class="free">vs</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Some propT"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">v</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_all_list <span class="skolem">vs</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>mk_all_list <span class="skolem">vs</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Some propT"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idn</span></span> <span class="skolem"><span class="skolem">ty</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">=</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span><span class="skolem">ty</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mk_all_list <span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> mk_all <span class="skolem">idn</span> <span class="skolem">ty</span> <span class="main">(</span>mk_all_list <span class="main">(</span><span class="skolem">vs</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_all_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="skolem">ty</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> I s term_ok_mk_all snoc.prems<span class="main">(</span>1<span class="main">)</span> wt_term_def typ_of_mk_all <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> forall_intro_vars_preserves_term_ok_typ_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">B</span> <span class="main">=</span> Some propT"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>forall_intro_vars <span class="free">B</span> <span class="free">Hs</span><span class="main">)</span> <span class="main">∧</span> typ_of <span class="main">(</span>forall_intro_vars <span class="free">B</span> <span class="free">Hs</span><span class="main">)</span> <span class="main">=</span> Some propT"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>                                              
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span><span class="bound">ty</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>add_vars' <span class="free">B</span> <span class="main">[]</span><span class="main">)</span> <span class="main">.</span> typ_ok <span class="free">Θ</span> <span class="bound">ty</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_vars'_fv assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> term_ok_vars_typ_ok <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms mk_all_list'_preserves_term_ok_typ_of <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* MOVE and rename *)</span>
<span class="keyword1" id="Logic-bind_fv_remove_var_from_fv"><span class="command">lemma</span></span> bind_fv_remove_var_from_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">idn</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">t</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">idn</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bind_fv2_Fv_fv bind_fv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logic-forall_intro_vars_remove_fv"><span class="command">lemma</span></span> forall_intro_vars_remove_fv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>forall_intro_vars <span class="free">t</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mk_all_list_fv_unchanged add_vars'_fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logic-term_ok_mk_all_list"><span class="command">lemma</span></span> term_ok_mk_all_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">B</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">B</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">l</span> <span class="main">.</span> typ_ok <span class="free">Θ</span> <span class="bound">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_all_list <span class="free">l</span> <span class="free">B</span><span class="main">)</span> <span class="main">∧</span> typ_of <span class="main">(</span>mk_all_list <span class="free">l</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Some propT"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">v</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idn</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> simp<span class="main">:</span> <span class="quoted"><span class="quoted">"mk_all_list <span class="main">(</span><span class="skolem">vs</span><span class="main">@</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">)</span> <span class="free">B</span> <span class="main">=</span> mk_all <span class="skolem">idn</span> <span class="skolem">τ</span> <span class="main">(</span>mk_all_list <span class="skolem">vs</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_all_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_all_list <span class="skolem">vs</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>mk_all_list <span class="skolem">vs</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Some propT"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_all <span class="skolem">idn</span> <span class="skolem">τ</span> <span class="main">(</span>mk_all_list <span class="skolem">vs</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> term_ok_mk_all snoc.prems I v <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>mk_all <span class="skolem">idn</span> <span class="skolem">τ</span> <span class="main">(</span>mk_all_list <span class="skolem">vs</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some propT"</span></span>
    <span class="keyword1"><span class="command">using</span></span> I<span class="main">(</span>2<span class="main">)</span> v typ_of_mk_all <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Move, also see if these are not subsumed *)</span>
<span class="keyword1" id="Logic-tvs_bind_fv2"><span class="command">lemma</span></span> tvs_bind_fv2<span class="main">:</span> <span class="quoted"><span class="quoted">"tvs <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="main">∪</span> tvsT <span class="free">T</span> <span class="main">=</span> tvs <span class="free">t</span> <span class="main">∪</span> tvsT <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bind_fv2.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Logic-tvs_bind_fv"><span class="command">lemma</span></span> tvs_bind_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"tvs <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">T</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">∪</span> tvsT <span class="free">T</span> <span class="main">=</span> tvs <span class="free">t</span> <span class="main">∪</span> tvsT <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tvs_bind_fv2 bind_fv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  

<span class="keyword1" id="Logic-tvs_mk_all'"><span class="command">lemma</span></span> tvs_mk_all'<span class="main">:</span> <span class="quoted"><span class="quoted">"tvs <span class="main">(</span>mk_all <span class="free">idn</span> <span class="free">ty</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> tvs <span class="free">B</span> <span class="main">∪</span> tvsT <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tvs_bind_fv typ_of_def is_variable.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Logic-tvs_mk_all_list"><span class="command">lemma</span></span> tvs_mk_all_list<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"tvs <span class="main">(</span>mk_all_list <span class="free">vs</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> tvs <span class="free">B</span> <span class="main">∪</span> tvsT_Set <span class="main">(</span>snd <span class="main">`</span> set <span class="free">vs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">v</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idn</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> snoc v tvs_mk_all' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_all_list_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logic-tvs_occs"><span class="command">lemma</span></span> tvs_occs<span class="main">:</span> <span class="quoted"><span class="quoted">"occs <span class="free">v</span> <span class="free">t</span> <span class="main">⟹</span> tvs <span class="free">v</span> <span class="main">⊆</span> tvs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-tvs_forall_intro_vars"><span class="command">lemma</span></span> tvs_forall_intro_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"tvs <span class="main">(</span>forall_intro_vars <span class="free">B</span> <span class="free">Hs</span><span class="main">)</span> <span class="main">=</span> tvs <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">∈</span>fv <span class="free">B</span> <span class="main">.</span> occs <span class="main">(</span>Fv <span class="bound">idn</span> <span class="bound">ty</span><span class="main">)</span> <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fv_occs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">∈</span>fv <span class="free">B</span> <span class="main">.</span> tvs <span class="main">(</span>Fv <span class="bound">idn</span> <span class="bound">ty</span><span class="main">)</span> <span class="main">⊆</span> tvs <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tvs_occs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">∈</span>fv <span class="free">B</span> <span class="main">.</span> tvsT <span class="bound">ty</span> <span class="main">⊆</span> tvs <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"tvsT_Set <span class="main">(</span>snd <span class="main">`</span> fv <span class="free">B</span><span class="main">)</span> <span class="main">⊆</span> tvs <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"tvsT_Set <span class="main">(</span>snd <span class="main">`</span> set <span class="main">(</span>add_vars' <span class="free">B</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> tvs <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_vars'_fv<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tvs_mk_all_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"strip_all_single_var <span class="free">B</span> <span class="main">=</span> Some <span class="free">τ</span> <span class="main">⟹</span> strip_all_single_body <span class="free">B</span> <span class="main">≠</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> strip_all_vars_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Logic-strip_all_body_unchanged_iff_strip_all_single_body_unchanged"><span class="command">lemma</span></span> strip_all_body_unchanged_iff_strip_all_single_body_unchanged<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"strip_all_body <span class="free">B</span> <span class="main">=</span> <span class="free">B</span> <span class="main">⟷</span> strip_all_single_body <span class="free">B</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_Cons_self2 not_None_eq not_is_all_imp_strip_all_body_unchanged 
      strip_all_body_single_simp' strip_all_single_var_is_all strip_all_vars_step<span class="main">)</span>

<span class="keyword1" id="Logic-strip_all_body_unchanged_imp_strip_all_vars_no"><span class="command">lemma</span></span> strip_all_body_unchanged_imp_strip_all_vars_no<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"strip_all_body <span class="free">B</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strip_all_vars <span class="free">B</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> assms not_Cons_self2 strip_all_body_single_simp' strip_all_single_body.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> strip_all_vars.elims<span class="main">)</span>

<span class="keyword1" id="Logic-strip_all_body_unchanged_imp_strip_all_single_body_unchanged"><span class="command">lemma</span></span> strip_all_body_unchanged_imp_strip_all_single_body_unchanged<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"strip_all_body <span class="free">B</span> <span class="main">=</span> <span class="free">B</span> <span class="main">⟹</span> strip_all_single_body <span class="free">B</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> not_Cons_self2 strip_all_body_single_simp' strip_all_single_body.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> strip_all_vars.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Logic-strip_all_single_body_unchanged_imp_strip_all_body_unchanged"><span class="command">lemma</span></span> strip_all_single_body_unchanged_imp_strip_all_body_unchanged<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"strip_all_single_body <span class="free">B</span> <span class="main">=</span> <span class="free">B</span> <span class="main">⟹</span> strip_all_body <span class="free">B</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> strip_all_single_body.elims<span class="main">)</span>

<span class="keyword1" id="Logic-strip_all_single_var_np_imp_strip_all_body_single_unchanged"><span class="command">lemma</span></span> strip_all_single_var_np_imp_strip_all_body_single_unchanged<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"strip_all_single_var <span class="free">B</span> <span class="main">=</span> None <span class="main">⟹</span> strip_all_single_body <span class="free">B</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> strip_all_single_var.elims<span class="main">)</span>

<span class="keyword1" id="Logic-strip_all_single_form"><span class="command">lemma</span></span> strip_all_single_form<span class="main">:</span> <span class="quoted"><span class="quoted">"strip_all_single_var <span class="free">B</span> <span class="main">=</span> Some <span class="free">τ</span>
  <span class="main">⟹</span> Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs <span class="free">τ</span> <span class="main">(</span>strip_all_single_body <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> strip_all_single_var.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Logic-proves_strip_all_single"><span class="command">lemma</span></span> proves_strip_all_single<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"strip_all_single_var <span class="free">B</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
    <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> subst_bv <span class="free">t</span> <span class="main">(</span>strip_all_single_body <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs <span class="free">τ</span> <span class="main">(</span>strip_all_single_body <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> strip_all_single_form <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> Abs <span class="free">τ</span> <span class="main">(</span>strip_all_single_body <span class="free">B</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms forall_elim
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_typ <span class="free">t</span> <span class="free">τ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="free">τ</span>›</span></span> has_typ_iff_typ_of<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> betapply.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> forall_elim term_ok_def wt_term_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> proves_strip_all_single_Fv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"strip_all_single_var <span class="free">B</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>strip_all_single_body <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">thm</span></span> strip_all_single_form 
      wt_term_def term_ok_var typ_of_var typ_ok_def proves_strip_all_single 
      strip_all_single_form
  <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs <span class="free">τ</span> <span class="main">(</span>strip_all_single_body <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> strip_all_single_form<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">∈</span> Types <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> s<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ok s term_ok'.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> term_ok'.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> term_okD1 typ_ok_def typ_ok_sig_imp_wf_type<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> term_ok_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms proves_strip_all_single<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> τ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">τ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logic-strip_all_vars_no_strip_all_body_unchanged"><span class="command">lemma</span></span> strip_all_vars_no_strip_all_body_unchanged<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"strip_all_vars <span class="free">B</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> strip_all_body <span class="free">B</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> strip_all_vars.elims<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"strip_all_vars <span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="free">τs</span><span class="main">@</span><span class="main">[</span><span class="free">τ</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> strip_all_body <span class="free">B</span> 
  <span class="main">=</span> strip_all_single_body <span class="main">(</span>Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs <span class="free">τ</span> <span class="main">(</span>strip_all_body <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logic-strip_all_vars_incr_bv"><span class="command">lemma</span></span> strip_all_vars_incr_bv<span class="main">:</span> <span class="quoted"><span class="quoted">"strip_all_vars <span class="main">(</span>incr_bv <span class="free">inc</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> strip_all_vars <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_all_vars.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Logic-strip_all_vars_incr_boundvars"><span class="command">lemma</span></span> strip_all_vars_incr_boundvars<span class="main">:</span> <span class="quoted"><span class="quoted">"strip_all_vars <span class="main">(</span>incr_boundvars <span class="free">inc</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> strip_all_vars <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> incr_boundvars_def strip_all_vars_incr_bv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logic-strip_all_vars_subst_bv1_Fv"><span class="command">lemma</span></span> strip_all_vars_subst_bv1_Fv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strip_all_vars <span class="main">(</span>subst_bv1 <span class="free">B</span> <span class="free">lev</span> <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> strip_all_vars <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_all_vars.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incr_boundvars_def<span class="main">)</span>
<span class="keyword1" id="Logic-strip_all_vars_subst_bv_Fv"><span class="command">lemma</span></span> strip_all_vars_subst_bv_Fv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strip_all_vars <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> strip_all_vars <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_all_vars_subst_bv1_Fv subst_bv_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"strip_all_single_var <span class="free">B</span> <span class="main">=</span> Some <span class="free">τ</span>
  <span class="main">⟹</span> strip_all_vars <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>strip_all_single_body <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>strip_all_vars <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> strip_all_vars_step strip_all_vars_subst_bv_Fv<span class="main">)</span>

<span class="comment1">(* Allowing general terms instead of just vars here is more difficult as one could create new leading
  ⋀s *)</span>
<span class="keyword1"><span class="command">corollary</span></span> proves_strip_all_vars_Fv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="main">(</span>strip_all_vars <span class="free">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">τ</span><span class="main">)</span><span class="main">.</span> subst_bv <span class="main">(</span>Fv <span class="bound">x</span> <span class="bound">τ</span><span class="main">)</span> <span class="keyword1">o</span> strip_all_single_body<span class="main">)</span>
    <span class="main">(</span>zip <span class="free">xs</span> <span class="main">(</span>strip_all_vars <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="quoted">"strip_all_vars <span class="free">B</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">τ</span> <span class="skolem">τs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"strip_all_single_var <span class="skolem">B</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> is_all_iff_strip_all_vars_not_empty list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.inject 
        option.exhaust strip_all_single_var_is_all strip_all_vars_step<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Fv <span class="skolem">x</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="skolem">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs <span class="skolem">τ</span> <span class="skolem">B'</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> st strip_all_single_form <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="skolem">B</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Cons.prems proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="skolem">τ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> term_ok'.simps<span class="main">(</span>5<span class="main">)</span> term_ok'.simps<span class="main">(</span>4<span class="main">)</span> term_ok_def wt_term_def typ_ok_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> term_ok_def wt_term_def typ_ok_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> subst_bv <span class="main">(</span>Fv <span class="skolem">x</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span>strip_all_single_body <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proves_strip_all_single
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.prems proves_strip_all_single_Fv<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span><span class="main">.</span> subst_bv <span class="main">(</span>Fv <span class="bound">x</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">∘</span> strip_all_single_body<span class="main">)</span>
    <span class="main">(</span>zip <span class="skolem">xs</span> <span class="main">(</span>strip_all_vars <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="skolem">x</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span>strip_all_single_body <span class="skolem">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="skolem">x</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span>strip_all_single_body <span class="skolem">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.hyps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.inject st strip_all_vars_step strip_all_vars_subst_bv_Fv<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strip_all_vars <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">τ</span> <span class="main">#</span> <span class="skolem">τs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> st strip_all_vars_step strip_all_vars_subst_bv_Fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Logic-trivial_pre_depr"><span class="command">lemma</span></span> trivial_pre_depr<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">c</span> <span class="main">⟹</span> typ_of <span class="free">c</span> <span class="main">=</span> Some propT <span class="main">⟹</span> <span class="free">Θ</span><span class="main">,</span> <span class="main">{</span><span class="free">c</span><span class="main">}</span> <span class="main">⊢</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted">"assume"</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>

<span class="keyword1" id="Logic-trivial_pre"><span class="command">lemma</span></span> trivial_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">c</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> <span class="free">c</span> <span class="main">⟼</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> <span class="main">{</span><span class="free">c</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">c</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> s<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted">"implies_intro"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="quoted">"assume"</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logic-inst_var"><span class="command">lemma</span></span> inst_var<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> wf_theory<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> typ_a<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">a</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> free<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">∉</span> FV <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">]</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"mk_all <span class="free">x</span> <span class="free">τ</span> <span class="free">B</span> <span class="main">=</span> Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> 
    Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typ_of_def<span class="main">)</span>                
  <span class="keyword1"><span class="command">have</span></span> closed_B<span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B proved_terms_well_formed_pre
    <span class="keyword1"><span class="command">using</span></span> typ_of_imp_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wt_term_def typ_ok_def term_ok_imp_typ_ok
    <span class="keyword1"><span class="command">using</span></span> a_ok wf_theory typ_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_all <span class="free">x</span> <span class="free">τ</span> <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> forall_intro<span class="main">[</span><span class="operator">OF</span> wf_theory B<span class="main">]</span> B typ_a wt_term_def wf_theory 
        term_ok_imp_typ_ok free <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> subst_bv <span class="free">a</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> forall_elim<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">τ</span></span><span class="main">]</span> p1 typ_a a_ok proves_strip_all_single
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> has_typ_iff_typ_of term_ok_def wt_term_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> subst_bv <span class="free">a</span> <span class="main">(</span><span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> forall_elim<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">τ</span></span><span class="main">]</span> p1 typ_a a_ok proves_strip_all_single
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> has_typ_iff_typ_of term_ok_def wt_term_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">]</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> instantiate_var_same_type'' assms closed_B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* MOVE *)</span>
<span class="keyword1" id="Logic-subst_term_single_no_change"><span class="command">lemma</span></span> subst_term_single_no_change<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nvar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span><span class="main">∉</span>fv <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span> <span class="free">B</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-fv_subst_term_single"><span class="command">lemma</span></span> fv_subst_term_single<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span><span class="main">∈</span>fv <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> fv <span class="free">t</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">~=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> fv <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">B1</span> <span class="skolem">B2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span><span class="main">∈</span>fv <span class="skolem">B1</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span><span class="main">∈</span>fv <span class="skolem">B2</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="comment1">(* TODO: Get rid of distinctness and non_overlap by performing standard single to parallel substitution
  construction: Rename variables, then substitute the now non problematic terms

  TODO: Check assms for useless ones, improve syntax
*)</span>
<span class="keyword1" id="Logic-inst_vars_pre"><span class="command">lemma</span></span> inst_vars_pre<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> wf_theory<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span>
  <span class="comment1">(*assumes vars: "set (map fst insts) ⊆ fv B"*)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vars_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>term_ok <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typs_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">.</span> typ_of <span class="bound">t</span> <span class="main">=</span> Some <span class="bound">ty</span><span class="main">)</span> <span class="free">insts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> free<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span> <span class="main">∉</span> FV <span class="free">Γ</span><span class="main">)</span> <span class="free">insts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typ_a<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">a</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no_overlap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span>set <span class="free">insts</span><span class="main">)</span> <span class="main">.</span> fv <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="free">insts</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idn</span></span> <span class="skolem"><span class="skolem">ty</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">B</span>
    <span class="main">⟷</span> <span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">(</span>subst_term <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">(</span>subst_term <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>subst_term <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inst_var Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons single <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* MOVE *)</span>
<span class="keyword1" id="Logic-subterm_term_ok'"><span class="command">lemma</span></span> subterm_term_ok'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_std_sig <span class="free">Σ</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">t</span> <span class="main">⟹</span> is_closed <span class="free">st</span> <span class="main">⟹</span> occs <span class="free">st</span> <span class="free">t</span> <span class="main">⟹</span> term_ok' <span class="free">Σ</span> <span class="free">st</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">st</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> term_ok'_occs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="comment1">(* MOVE *)</span>
<span class="keyword1" id="Logic-infinite_fv_UNIV"><span class="command">lemma</span></span> infinite_fv_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span>indexname <span class="main">×</span> typ<span class="main">)</span> set<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_prod<span class="main">)</span>


<span class="keyword1" id="Logic-implies_intro'_pre"><span class="command">lemma</span></span> implies_intro'_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">A</span> <span class="main">=</span> Some propT"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">A</span> <span class="main">⟼</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms proves.implies_intro <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_empty Diff_insert0<span class="main">)</span>

<span class="keyword1" id="Logic-implies_intro'_pre2"><span class="command">lemma</span></span> implies_intro'_pre2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">A</span> <span class="main">=</span> Some propT"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">A</span> <span class="main">⟼</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">-</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">⊢</span> <span class="free">A</span> <span class="main">⟼</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms proves.implies_intro <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">-</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">⊢</span> <span class="free">A</span> <span class="main">⟼</span> <span class="main">(</span><span class="free">A</span> <span class="main">⟼</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms proves.implies_intro 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 implies_intro'_pre<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">⊢</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proves.assume assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trivial_pre_depr<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">-</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> proves.implies_elim <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Names are suspect, change *)</span>
<span class="keyword1" id="Logic-subst_term_preserves_typ_of1"><span class="command">lemma</span></span> subst_term_preserves_typ_of1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="free">y</span> <span class="free">τ</span><span class="main">)</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> typ_of1 <span class="free">Ts</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typ_of1.induct<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Logic-subst_term_preserves_typ_of"><span class="command">lemma</span></span> subst_term_preserves_typ_of<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="free">y</span> <span class="free">τ</span><span class="main">)</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logic-subst_term_preserves_term_ok'"><span class="command">lemma</span></span> subst_term_preserves_term_ok'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="free">y</span> <span class="free">τ</span><span class="main">)</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span> term_ok' <span class="free">Σ</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-subst_term_preserves_term_ok"><span class="command">lemma</span></span> subst_term_preserves_term_ok<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="free">y</span> <span class="free">τ</span><span class="main">)</span><span class="main">]</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟷</span> term_ok <span class="free">Θ</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>

<span class="keyword1" id="Logic-not_in_FV_in_fv_not_in"><span class="command">lemma</span></span> not_in_FV_in_fv_not_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">∉</span> FV <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">∈</span> fv <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∉</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-subst_term_fv"><span class="command">lemma</span></span> subst_term_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="free">y</span> <span class="free">τ</span><span class="main">)</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span> 
  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">∈</span> fv <span class="free">t</span> <span class="keyword1">then</span> insert <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="keyword1">else</span> id<span class="main">)</span> <span class="main">(</span>fv <span class="free">t</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-rename_free"><span class="command">lemma</span></span> rename_free<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> wf_theory<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> free<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span><span class="main">∉</span> FV <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="free">y</span> <span class="free">τ</span><span class="main">)</span><span class="main">]</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> B free inst_var proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subst_term_single_no_change
      term_ok_vars_typ_ok term_ok_var wf_theory typ_of_var<span class="main">)</span>

<span class="keyword1" id="Logic-tvs_subst_term_single"><span class="command">lemma</span></span> tvs_subst_term_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tvs <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="free">y</span> <span class="free">τ</span><span class="main">)</span><span class="main">]</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> tvs <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* Conditions are a bit random, clear up *)</span>
<span class="keyword1" id="Logic-weaken_proves'"><span class="command">lemma</span></span> weaken_proves'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span> <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="free">A</span> <span class="main">⟹</span> typ_of <span class="free">A</span> <span class="main">=</span> Some propT <span class="main">⟹</span> <span class="free">A</span> <span class="main">∉</span> <span class="free">Γ</span>
  <span class="main">⟹</span> finite <span class="free">Γ</span> 
  <span class="main">⟹</span> <span class="free">Θ</span><span class="main">,</span> insert <span class="free">A</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> proves.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>axiom <span class="skolem">A</span> <span class="skolem">insts</span> <span class="skolem">Γ</span> <span class="skolem">A'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> proves.axiom axiom <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"assume"</span> <span class="skolem">A</span> <span class="skolem">Γ</span> <span class="skolem">A'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> proves.intros <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>forall_intro <span class="skolem">Γ</span> <span class="skolem">B</span> <span class="skolem">x</span> <span class="skolem">τ</span><span class="main">)</span> 

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span><span class="main">∉</span>fst <span class="main">`</span> <span class="main">(</span>fv <span class="skolem">A</span> <span class="main">∪</span> fv <span class="skolem">B</span> <span class="main">∪</span> FV <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>FV <span class="skolem">Γ</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> finite_fv forall_intro.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fv <span class="skolem">A</span> <span class="main">∪</span> fv <span class="skolem">B</span> <span class="main">∪</span> FV <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fst <span class="main">`</span> <span class="main">(</span>fv <span class="skolem">A</span> <span class="main">∪</span> fv <span class="skolem">B</span> <span class="main">∪</span> FV <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> variant_variable_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∉</span>fst <span class="main">`</span> <span class="main">(</span>fv <span class="skolem">A</span> <span class="main">∪</span> fv <span class="skolem">B</span> <span class="main">∪</span> FV <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> not_in_ren<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="skolem">y</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">A</span> <span class="main">∉</span> <span class="skolem">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">∈</span> fv <span class="skolem">A</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> not_in_FV_in_fv_not_in<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">τ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Un_iff <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>fv <span class="skolem">A</span> <span class="main">∪</span> fv <span class="skolem">B</span> <span class="main">∪</span> FV <span class="skolem">Γ</span><span class="main">)</span>›</span></span> fst_conv image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> True subst_term_fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="skolem">y</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> forall_intro.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> term_ok_ren<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="skolem">y</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> forall_intro.prems<span class="main">(</span>1<span class="main">)</span> subst_term_preserves_term_ok <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> typ_of_ren<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="skolem">y</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> Some propT"</span></span>
    <span class="keyword1"><span class="command">using</span></span> forall_intro.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> insert <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="skolem">y</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> forall_intro.IH forall_intro.prems<span class="main">(</span>3<span class="main">)</span> forall_intro.prems<span class="main">(</span>4<span class="main">)</span> 
      not_in_ren term_ok_ren typ_of_ren <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> insert <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="skolem">y</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="main">⊢</span> mk_all <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves.forall_intro<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> forall_intro.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Θ</span><span class="main">,</span> insert <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="skolem">y</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_term_fv <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">∉</span> FV <span class="skolem">Γ</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>fv <span class="skolem">A</span> <span class="main">∪</span> fv <span class="skolem">B</span> <span class="main">∪</span> FV <span class="skolem">Γ</span><span class="main">)</span>›</span></span> fst_conv image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> forall_intro.hyps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊢</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="skolem">y</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">A</span> <span class="main">⟼</span> mk_all <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> forall_intro.hyps<span class="main">(</span>1<span class="main">)</span> forall_intro.hyps<span class="main">(</span>2<span class="main">)</span> forall_intro.hyps<span class="main">(</span>4<span class="main">)</span>
      forall_intro.prems<span class="main">(</span>1<span class="main">)</span> forall_intro.prems<span class="main">(</span>3<span class="main">)</span> 
      implies_intro'_pre local.forall_intro not_in_ren proves.forall_intro 
      subst_term_preserves_typ_of term_ok_ren <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊢</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="skolem">x</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> 
    <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="skolem">y</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">A</span> <span class="main">⟼</span> mk_all <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Un_iff <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>fv <span class="skolem">A</span> <span class="main">∪</span> fv <span class="skolem">B</span> <span class="main">∪</span> FV <span class="skolem">Γ</span><span class="main">)</span>›</span></span> forall_intro.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
        fst_conv image_eqI rename_free<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">A</span> <span class="main">⟼</span> mk_all <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> forall_intro proves.forall_intro implies_intro'_pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{</span><span class="skolem">A</span><span class="main">}</span> <span class="main">⊢</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> forall_intro.prems<span class="main">(</span>1<span class="main">)</span> local.forall_intro<span class="main">(</span>7<span class="main">)</span> trivial_pre_depr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> implies_elim <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>forall_elim <span class="skolem">Γ</span> <span class="skolem">τ</span> <span class="skolem">B</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> proves.forall_elim <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>implies_intro <span class="skolem">Γ</span> <span class="skolem">B</span> <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">=</span><span class="skolem">N</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="comment1">(* Do this less automatic probably, for speed reasons*)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">N</span><span class="main">}</span> <span class="main">⊢</span> <span class="skolem">N</span> <span class="main">⟼</span> <span class="skolem">B</span>"</span></span> 
      
      <span class="keyword1"><span class="command">using</span></span> implies_intro.hyps<span class="main">(</span>1<span class="main">)</span> implies_intro.hyps<span class="main">(</span>2<span class="main">)</span> implies_intro.hyps<span class="main">(</span>3<span class="main">)</span> 
          implies_intro.hyps<span class="main">(</span>4<span class="main">)</span> proves.implies_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">N</span><span class="main">}</span> <span class="main">⊢</span> <span class="skolem">A</span> <span class="main">⟼</span> <span class="skolem">N</span> <span class="main">⟼</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True implies_intro'_pre implies_intro.hyps<span class="main">(</span>1<span class="main">)</span> implies_intro.hyps<span class="main">(</span>3<span class="main">)</span> 
          implies_intro.hyps<span class="main">(</span>4<span class="main">)</span> implies_intro.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span>insert <span class="skolem">N</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">B</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> True implies_elim implies_intro insert_absorb <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> True implies_elim implies_intro.hyps<span class="main">(</span>3<span class="main">)</span> implies_intro.hyps<span class="main">(</span>4<span class="main">)</span> implies_intro.prems<span class="main">(</span>1<span class="main">)</span> 
        trivial_pre_depr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implies_intro'_pre2 implies_intro.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="skolem">A</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">N</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">A</span> <span class="skolem">Γ</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">N</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span>insert <span class="skolem">A</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> implies_intro.prems False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implies_intro.IH<span class="main">)</span>
      
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> s<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves.implies_intro<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> implies_intro.hyps I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>implies_elim <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> proves.implies_elim implies_elim <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnCI Un_insert_left finite_Un<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>β_conversion <span class="skolem">Γ</span> <span class="skolem">s</span> <span class="skolem">T</span> <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> proves.β_conversion <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eta <span class="skolem">t</span> <span class="skolem">τ</span> <span class="skolem">τ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> proves.eta <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>of_class <span class="skolem">c</span> <span class="skolem">T'</span> <span class="skolem">T</span> <span class="skolem">Γ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> proves.of_class<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">corollary</span></span> weaken_proves<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span> <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="free">A</span> <span class="main">⟹</span> typ_of <span class="free">A</span> <span class="main">=</span> Some propT
  <span class="main">⟹</span> finite <span class="free">Γ</span> 
  <span class="main">⟹</span> <span class="free">Θ</span><span class="main">,</span> insert <span class="free">A</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> weaken_proves' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_absorb<span class="main">)</span> 

<span class="keyword1" id="Logic-weaken_proves_set"><span class="command">lemma</span></span> weaken_proves_set<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ2</span> <span class="main">⟹</span> <span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ2</span> <span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ2</span> <span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT
  <span class="main">⟹</span> finite <span class="free">Γ</span>
  <span class="main">⟹</span> <span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">∪</span> <span class="free">Γ2</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> weaken_proves <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* Maybe do directly instead *)</span>
<span class="keyword1" id="Logic-no_tvsT_imp_subst_typ_unchanged"><span class="command">lemma</span></span> no_tvsT_imp_subst_typ_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"tvsT <span class="free">T</span> <span class="main">=</span> empty <span class="main">⟹</span> subst_typ <span class="free">insts</span> <span class="free">T</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_tvsT_imp_tsubsT_unchanged tsubstT_simulates_subst_typ<span class="main">)</span>

<span class="keyword1" id="Logic-subst_typ_fv"><span class="command">lemma</span></span> subst_typ_fv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apsnd <span class="main">(</span>subst_typ <span class="free">insts</span><span class="main">)</span> <span class="main">`</span> fv <span class="free">B</span> <span class="main">=</span> fv <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-subst_typ_fv_point"><span class="command">lemma</span></span> subst_typ_fv_point<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∈</span> fv <span class="free">B</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> subst_typ <span class="free">insts</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∈</span> fv <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> subst_typ_fv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apsnd_conv assms image_eqI<span class="main">)</span>

<span class="keyword1" id="Logic-subst_typ_typ_ok"><span class="command">lemma</span></span> subst_typ_typ_ok<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>typ_ok_sig <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">τ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="free">insts</span>"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lookup_present_eq_key' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>  
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff lookup_present_eq_key' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Logic-subst_typ_comp_single_left"><span class="command">lemma</span></span> subst_typ_comp_single_left<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">[</span><span class="free">single</span><span class="main">]</span> <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="free">T</span><span class="main">)</span> 
  <span class="main">=</span> subst_typ <span class="main">(</span>map <span class="main">(</span>apsnd <span class="main">(</span>subst_typ <span class="main">[</span><span class="free">single</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">insts</span><span class="main">@</span><span class="main">[</span><span class="free">single</span><span class="main">]</span><span class="main">)</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">ty</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-subst_typ_comp_single_left_stronger"><span class="command">lemma</span></span> subst_typ_comp_single_left_stronger<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">[</span><span class="free">single</span><span class="main">]</span> <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="free">T</span><span class="main">)</span> 
  <span class="main">=</span> subst_typ <span class="main">(</span>map <span class="main">(</span>apsnd <span class="main">(</span>subst_typ <span class="main">[</span><span class="free">single</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">insts</span>
  <span class="main">@</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="free">single</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="main">[</span><span class="free">single</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="free">insts</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>apsnd <span class="main">(</span>subst_typ <span class="main">[</span><span class="free">single</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">insts</span><span class="main">)</span> <span class="main">=</span> None"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> None <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_fst_iff list.set_map lookup.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lookup_None_iff subst_typ.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
          subst_typ_comp subst_typ_nil the_default.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>apsnd <span class="main">(</span>subst_typ <span class="main">[</span><span class="free">single</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">insts</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>subst_typ <span class="main">[</span><span class="free">single</span><span class="main">]</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_typ.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subst_typ_comp_single_left the_default.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-subst_typ'_comp_single_left"><span class="command">lemma</span></span> subst_typ'_comp_single_left<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ' <span class="main">[</span><span class="free">single</span><span class="main">]</span> <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">t</span><span class="main">)</span>
  <span class="main">=</span> subst_typ' <span class="main">(</span>map <span class="main">(</span>apsnd <span class="main">(</span>subst_typ <span class="main">[</span><span class="free">single</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">insts</span><span class="main">@</span><span class="main">[</span><span class="free">single</span><span class="main">]</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> subst_typ_comp_single_left <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Logic-subst_typ'_comp_single_left_stronger"><span class="command">lemma</span></span> subst_typ'_comp_single_left_stronger<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ' <span class="main">[</span><span class="free">single</span><span class="main">]</span> <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">t</span><span class="main">)</span>
  <span class="main">=</span> subst_typ' <span class="main">(</span>map <span class="main">(</span>apsnd <span class="main">(</span>subst_typ <span class="main">[</span><span class="free">single</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">insts</span>
  <span class="main">@</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="free">single</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="main">[</span><span class="free">single</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> subst_typ_comp_single_left_stronger <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Logic-subst_typ_preserves_typ_ok"><span class="command">lemma</span></span> subst_typ_preserves_typ_ok<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>typ_ok <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="free">T</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">Ts</span> <span class="main">.</span> typ_ok <span class="free">Θ</span> <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typ_ok_def list_all_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">Ts</span> <span class="main">.</span> typ_ok <span class="free">Θ</span> <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="free">insts</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="main">.</span> typ_ok <span class="free">Θ</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>wf_type <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="free">insts</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  list_allI typ_ok_def Ball_set typ_ok_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Ty list.pred_mono_strong <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logic-typ_ok_Ty"><span class="command">lemma</span></span> typ_ok_Ty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="main">(</span>Ty <span class="free">n</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">⟹</span> list_all <span class="main">(</span>typ_ok <span class="free">Θ</span><span class="main">)</span> <span class="free">Ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typ_ok_def list.pred_mono_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1" id="Logic-typ_ok_sig_Ty"><span class="command">lemma</span></span> typ_ok_sig_Ty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="main">(</span>Ty <span class="free">n</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">⟹</span> list_all <span class="main">(</span>typ_ok_sig <span class="free">Σ</span><span class="main">)</span> <span class="free">Ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_mono_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Logic-wf_theory_imp_wf_osig"><span class="command">lemma</span></span> wf_theory_imp_wf_osig<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> wf_osig <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Logic-the_lift2_option_Somes"><span class="command">lemma</span></span> the_lift2_option_Somes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>lift2_option <span class="free">f</span> <span class="main">(</span>Some <span class="free">a</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logic-class_les_mgd"><span class="command">lemma</span></span> class_les_mgd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_osig <span class="free">oss</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tcsigs <span class="free">oss</span> <span class="free">type</span> <span class="main">=</span> Some <span class="free">mgd</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">mgd</span> <span class="free">C'</span> <span class="main">=</span> Some <span class="free">Ss'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"class_les <span class="main">(</span>subclass <span class="free">oss</span><span class="main">)</span> <span class="free">C'</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mgd</span> <span class="free">C</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"complete_tcsigs <span class="main">(</span>subclass <span class="free">oss</span><span class="main">)</span> <span class="main">(</span>tcsigs <span class="free">oss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">oss</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> class_les_def class_leq_def complete_tcsigs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> domI ranI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logic-has_sort_sort_leq_osig"><span class="command">lemma</span></span> has_sort_sort_leq_osig<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_osig <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">tcs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">tcs</span><span class="main">)</span> <span class="free">T</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"sort_leq <span class="free">sub</span> <span class="free">S</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">tcs</span><span class="main">)</span> <span class="free">T</span> <span class="free">S'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>1<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">tcs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_sort.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>has_sort_Tv <span class="skolem">S</span> <span class="skolem">S'</span> <span class="skolem">tcs</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_osig.simps wf_subclass_loc.intro wf_subclass_loc.sort_leq_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>has_sort_Ty <span class="skolem">κ</span> <span class="skolem">K</span> <span class="skolem">S</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_sort.has_sort_Ty<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> dm<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">K</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">tcs</span> <span class="skolem">κ</span> <span class="main">=</span> Some <span class="skolem">K</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> has_sort_Ty.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C</span><span class="main">∈</span><span class="skolem">S'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">Ss</span><span class="main">.</span> <span class="skolem">K</span> <span class="bound">C</span> <span class="main">=</span> Some <span class="bound">Ss</span> <span class="main">∧</span> list_all2 <span class="main">(</span>has_sort <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">tcs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ts</span> <span class="bound">Ss</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> <span class="skolem">S'</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Ss</span><span class="main">.</span> <span class="skolem">K</span> <span class="skolem">C</span> <span class="main">=</span> Some <span class="bound">Ss</span> <span class="main">∧</span> list_all2 <span class="main">(</span>has_sort <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">tcs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ts</span> <span class="bound">Ss</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> list_all2_mono has_sort_Ty.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"class_les <span class="free">sub</span> <span class="skolem">C'</span> <span class="skolem">C</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> C class_les_def has_sort_Ty.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> has_sort_Ty.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sort_leq_def 
              subclass.simps wf_osig_imp_wf_subclass_loc wf_subclass_loc.class_leq_antisym<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ss'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Ss'<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="skolem">C'</span> <span class="main">=</span> Some <span class="skolem">Ss'</span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>has_sort <span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">tcs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ts</span> <span class="skolem">Ss'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> list_all2_mono has_sort_Ty.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> Ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="skolem">C</span> <span class="main">=</span> Some <span class="skolem">Ss</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> has_sort_Ty.prems class_les_mgd C'<span class="main">(</span>2<span class="main">)</span> has_sort_Ty.hyps<span class="main">(</span>1<span class="main">)</span> wf_theory_imp_wf_osig
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">have</span></span> lengthSs'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Ss'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Ss'<span class="main">(</span>2<span class="main">)</span> list_all2_lengthD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> coregular<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"coregular_tcsigs <span class="free">sub</span> <span class="free">tcs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> has_sort_Ty.prems<span class="main">(</span>2<span class="main">)</span> wf_theory_imp_wf_osig wf_tcsigs_def 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_osig.simps<span class="main">)</span>

        <span class="keyword1"><span class="command">hence</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>sort_leq <span class="free">sub</span><span class="main">)</span> <span class="skolem">Ss'</span> <span class="skolem">Ss</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> C'<span class="main">(</span>2<span class="main">)</span> Ss'<span class="main">(</span>1<span class="main">)</span> Ss has_sort_Ty.hyps<span class="main">(</span>1<span class="main">)</span> ranI
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> class_les_def coregular_tcsigs_def domI option.sel<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>has_sort <span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">tcs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ts</span> <span class="skolem">Ss</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> list_all2_all_nthI<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Ss</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> Ss Ss'<span class="main">(</span>1<span class="main">)</span> lengthSs' wf_theory_imp_wf_osig leq list_all2_lengthD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">Ts</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sort_leq <span class="free">sub</span> <span class="main">(</span><span class="skolem">Ss'</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ss</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> leq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lengthSs' list_all2_nthD<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">tcs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ts</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ss</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> has_sort_Ty.hyps<span class="main">(</span>2<span class="main">)</span> has_sort_Ty.prems<span class="main">(</span>2<span class="main">)</span> C'<span class="main">(</span>1<span class="main">)</span> Ss'<span class="main">(</span>1<span class="main">)</span> n list_all2_nthD
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Ss</span><span class="main">.</span> <span class="skolem">K</span> <span class="skolem">C</span> <span class="main">=</span> Some <span class="bound">Ss</span> <span class="main">∧</span> list_all2 <span class="main">(</span>has_sort <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">tcs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ts</span> <span class="bound">Ss</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logic-has_sort_sort_leq"><span class="command">lemma</span></span> has_sort_sort_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span> <span class="main">⟹</span> has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="free">S</span> 
  <span class="main">⟹</span> sort_leq <span class="main">(</span>subclass <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span> <span class="free">S'</span>
  <span class="main">⟹</span> has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="free">S'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> has_sort_sort_leq_osig subclass.elims wf_theory_imp_wf_osig<span class="main">)</span>

<span class="keyword1" id="Logic-subst_typ_preserves_has_sort"><span class="command">lemma</span></span> subst_typ_preserves_has_sort<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span> <span class="bound">S</span><span class="main">)</span> <span class="free">insts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">κ</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cl</span></span> <span class="skolem"><span class="skolem">tcs</span></span> <span class="keyword2"><span class="keyword">where</span></span> cltcs<span class="main">:</span> <span class="quoted"><span class="quoted">"osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">cl</span><span class="main">,</span> <span class="skolem">tcs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"tcsigs <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">κ</span> <span class="main">=</span> Some <span class="skolem">K</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ty.prems<span class="main">(</span>2<span class="main">)</span> has_sort.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> mgd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tcs</span> <span class="skolem">κ</span> <span class="main">=</span> Some <span class="skolem">K</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="main">(</span>Ty <span class="skolem">κ</span> <span class="skolem">Ts</span><span class="main">)</span><span class="main">)</span> <span class="skolem">S</span>
    <span class="main">=</span> has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">κ</span> <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="free">insts</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span><span class="main">)</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">κ</span> <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="free">insts</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span><span class="main">)</span> <span class="skolem">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> cltcs<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> has_sort_Ty<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">tcs</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> mgd<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> Ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="skolem">C</span> <span class="main">=</span> Some <span class="skolem">Ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C Ty.prems<span class="main">(</span>2<span class="main">)</span> mgd has_sort.simps cltcs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="free">insts</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="skolem">Ss</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list_all2_all_nthI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="free">insts</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">Ss</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> C Ss Ty.prems<span class="main">(</span>2<span class="main">)</span> list_all2_lengthD mgd has_sort.simps cltcs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="free">insts</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>has_sort <span class="main">(</span><span class="skolem">cl</span><span class="main">,</span> <span class="skolem">tcs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ts</span> <span class="skolem">Ss</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> C Ss Ty.prems<span class="main">(</span>2<span class="main">)</span> cltcs has_sort.simps mgd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ts</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ss</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cltcs list_all2_conv_all_nth n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="main">(</span><span class="skolem">Ts</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ss</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 n Ty.prems cltcs C Ss mgd Ty.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="free">insts</span><span class="main">)</span> <span class="skolem">Ts</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ss</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Ss</span><span class="main">.</span> <span class="skolem">K</span> <span class="skolem">C</span> <span class="main">=</span> Some <span class="bound">Ss</span> <span class="main">∧</span> list_all2 <span class="main">(</span>has_sort <span class="main">(</span><span class="skolem">cl</span><span class="main">,</span> <span class="skolem">tcs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="free">insts</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="bound">Ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ss cltcs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">S'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span><span class="main">)</span> <span class="free">insts</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Tv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">res</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">res</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">insts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lookup_present_eq_key' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">res</span> <span class="skolem">S'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Tv
      <span class="keyword1"><span class="command">using</span></span> split_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_leq <span class="main">(</span>subclass <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">S'</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Tv.prems<span class="main">(</span>2<span class="main">)</span> has_sort_Tv_imp_sort_leq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> Some Tv<span class="main">(</span>2<span class="main">)</span> has_sort_Tv_imp_sort_leq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 1 has_sort_sort_leq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Logic-subst_typ_preserves_Some_typ_of1"><span class="command">lemma</span></span> subst_typ_preserves_Some_typ_of1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="free">Ts</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="free">insts</span><span class="main">)</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">t</span><span class="main">)</span> 
      <span class="main">=</span> Some <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">Ts</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">RT</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="skolem">Ts</span> <span class="skolem">t1</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">RT</span> <span class="main">→</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> typ_of1_split_App_obtains <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="free">insts</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">=</span>
    Some <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="main">(</span><span class="skolem">RT</span> <span class="main">→</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> App.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of1 <span class="main">(</span>map <span class="main">(</span>subst_typ <span class="free">insts</span><span class="main">)</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="skolem">RT</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> App <span class="quoted"><span class="quoted">‹typ_of1 <span class="skolem">Ts</span> <span class="skolem">t1</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">RT</span> <span class="main">→</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> typ_of1_fun_typ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">corollary</span></span> subst_typ_preserves_Some_typ_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">t</span><span class="main">)</span> 
      <span class="main">=</span> Some <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms subst_typ_preserves_Some_typ_of1 typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Logic-subst_typ'_incr_bv"><span class="command">lemma</span></span> subst_typ'_incr_bv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"subst_typ' <span class="free">insts</span> <span class="main">(</span>incr_bv <span class="free">inc</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> incr_bv <span class="free">inc</span> <span class="free">lev</span> <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">inc</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> incr_bv.induct<span class="main">)</span> <span class="operator">auto</span> 

<span class="keyword1" id="Logic-subst_typ'_incr_boundvars"><span class="command">lemma</span></span> subst_typ'_incr_boundvars<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_typ' <span class="free">insts</span> <span class="main">(</span>incr_boundvars <span class="free">lev</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> incr_boundvars <span class="free">lev</span> <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subst_typ'_incr_bv incr_boundvars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1" id="Logic-subst_typ'_subst_bv1"><span class="command">lemma</span></span> subst_typ'_subst_bv1<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ' <span class="free">insts</span> <span class="main">(</span>subst_bv1 <span class="free">t</span> <span class="free">n</span> <span class="free">u</span><span class="main">)</span> 
  <span class="main">=</span> subst_bv1 <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">t</span><span class="main">)</span> <span class="free">n</span> <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bv1.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_typ'_incr_boundvars<span class="main">)</span>

<span class="keyword1" id="Logic-subst_typ'_subst_bv"><span class="command">lemma</span></span> subst_typ'_subst_bv<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_typ' <span class="free">insts</span> <span class="main">(</span>subst_bv <span class="free">t</span> <span class="free">u</span><span class="main">)</span> 
  <span class="main">=</span> subst_bv <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subst_typ'_subst_bv1 subst_bv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logic-subst_typ_no_tvsT_unchanged"><span class="command">lemma</span></span> subst_typ_no_tvsT_unchanged<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">insts</span> <span class="main">.</span> <span class="bound">f</span> <span class="main">∉</span> tvsT <span class="free">T</span> <span class="main">⟹</span> subst_typ <span class="free">insts</span> <span class="free">T</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">smt</span> case_prodD case_prodE find_None_iff lookup_None_iff_find_None the_default.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logic-subst_typ'_no_tvs_unchanged"><span class="command">lemma</span></span> subst_typ'_no_tvs_unchanged<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">insts</span> <span class="main">.</span> <span class="bound">f</span> <span class="main">∉</span> tvs <span class="free">t</span> <span class="main">⟹</span> subst_typ' <span class="free">insts</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> subst_typ_no_tvsT_unchanged <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">fastforce</span><span class="keyword3">+</span>›</span><span class="main">)</span>
  
<span class="comment1">(* This is weaker than the previously proved version, but probably easier to use... *)</span>
<span class="keyword1" id="Logic-subst_typ'_preserves_term_ok'"><span class="command">lemma</span></span> subst_typ'_preserves_term_ok'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inst_ok <span class="free">Θ</span> <span class="free">insts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms term_ok'_subst_typ' typ_ok_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.pred_mono_strong wf_theory_imp_is_std_sig wf_type_imp_typ_ok_sig<span class="main">)</span>

<span class="keyword1" id="Logic-subst_typ'_preserves_term_ok"><span class="command">lemma</span></span> subst_typ'_preserves_term_ok<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inst_ok <span class="free">Θ</span> <span class="free">insts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_typ' <span class="free">insts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms subst_typ_preserves_Some_typ_of wt_term_def subst_typ'_preserves_term_ok' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-subst_typ_rename_vars_cancel"><span class="command">lemma</span></span> subst_typ_rename_vars_cancel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fst <span class="main">`</span> tvsT <span class="free">T</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">x</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>subst_typ <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-subst_typ'_rename_tvars_cancel"><span class="command">lemma</span></span> subst_typ'_rename_tvars_cancel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fst <span class="main">`</span> tvs <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fst <span class="main">`</span> tvsT <span class="free">τ</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">x</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span>bind_fv2 <span class="main">(</span><span class="free">x</span><span class="main">,</span> subst_typ <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> 
    <span class="free">lev</span> <span class="main">(</span>subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>
  <span class="main">=</span> bind_fv2 <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">lev</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ct <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_typ_rename_vars_cancel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">idn</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_typ_rename_vars_cancel<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> subst_typ_rename_vars_cancel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Un subst_typ_rename_vars_cancel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Un<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-bind_fv2_renamed_var"><span class="command">lemma</span></span> bind_fv2_renamed_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fst <span class="main">`</span> fv <span class="free">t</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind_fv2 <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="free">y</span> <span class="free">τ</span><span class="main">)</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span> 
    <span class="main">=</span> bind_fv2 <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">i</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-bind_fv_renamed_var"><span class="command">lemma</span></span> bind_fv_renamed_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fst <span class="main">`</span> fv <span class="free">t</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind_fv <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="free">y</span> <span class="free">τ</span><span class="main">)</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">=</span> bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bind_fv2_renamed_var bind_fv_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-subst_typ'_rename_tvar_bind_fv2"><span class="command">lemma</span></span> subst_typ'_rename_tvar_bind_fv2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fst <span class="main">`</span> fv <span class="free">t</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∉</span> tvs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∉</span> tvsT <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind_fv2 <span class="main">(</span><span class="free">y</span><span class="main">,</span> subst_typ <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">b</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="free">τ</span><span class="main">)</span> <span class="free">i</span> 
  <span class="main">(</span>subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">b</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="free">y</span> <span class="free">τ</span><span class="main">)</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">b</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-subst_typ'_rename_tvar_bind_fv"><span class="command">lemma</span></span> subst_typ'_rename_tvar_bind_fv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fst <span class="main">`</span> fv <span class="free">t</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∉</span> tvs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∉</span> tvsT <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind_fv <span class="main">(</span><span class="free">y</span><span class="main">,</span> subst_typ <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">b</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="free">τ</span><span class="main">)</span> 
  <span class="main">(</span>subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">b</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="free">y</span> <span class="free">τ</span><span class="main">)</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">b</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bind_fv_def assms subst_typ'_rename_tvar_bind_fv2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-tvar_in_fv_in_tvs"><span class="command">lemma</span></span> tvar_in_fv_in_tvs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∈</span> fv <span class="free">B</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> tvsT <span class="free">τ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> tvs <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-tvs_bind_fv2_subset"><span class="command">lemma</span></span> tvs_bind_fv2_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"tvs <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">i</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊆</span> tvs <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-tvs_bind_fv_subset"><span class="command">lemma</span></span> tvs_bind_fv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"tvs <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊆</span> tvs <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tvs_bind_fv2_subset bind_fv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logic-subst_typ_rename_tvar_preserves_eq"><span class="command">lemma</span></span> subst_typ_rename_tvar_preserves_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∉</span> tvsT <span class="free">T</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∉</span> tvsT <span class="free">τ</span> <span class="main">⟹</span>
    subst_typ <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="free">T</span> <span class="main">=</span> subst_typ <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="free">τ</span> <span class="main">⟹</span> <span class="free">T</span><span class="main">=</span><span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">τ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">τ</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">smt</span> list.inj_map_strong<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">n</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">n</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">τ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logic-subst_typ'_subst_term_rename_var_swap"><span class="command">lemma</span></span> subst_typ'_subst_term_rename_var_swap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> fst <span class="main">`</span> fv <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∉</span> tvs <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∉</span> tvsT <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> Fv <span class="free">b</span> <span class="free">τ</span><span class="main">)</span><span class="main">]</span> <span class="free">B</span><span class="main">)</span>
    <span class="main">=</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="main">(</span>subst_typ <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Fv <span class="free">b</span> <span class="main">(</span>subst_typ <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> 
      <span class="main">(</span>subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">,</span> Tv <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">]</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">idn</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_typ_rename_tvar_preserves_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>  

<span class="comment1">(* My naming needs work, also those lemmas might be subsumed *)</span>
<span class="keyword1" id="Logic-tvar_not_in_term_imp_free_not_in_term"><span class="command">lemma</span></span> tvar_not_in_term_imp_free_not_in_term<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> tvsT <span class="free">τ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">S</span><span class="main">)</span> <span class="main">∉</span> tvs <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Logic-tvar_not_in_term_imp_free_not_in_term_set"><span class="command">lemma</span></span> tvar_not_in_term_imp_free_not_in_term_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> tvsT <span class="free">τ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">S</span><span class="main">)</span> <span class="main">∉</span> tvs_Set <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∉</span> FV <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tvar_not_in_term_imp_free_not_in_term <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* I can probably weaken vars a bit, should only need wf criteria on insts, nothing more *)</span>
<span class="keyword1" id="Logic-inst_var_multiple"><span class="command">lemma</span></span> inst_var_multiple<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> wf_theory<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">τ</span><span class="main">)</span><span class="main">∈</span>fst <span class="main">`</span> set <span class="free">insts</span> <span class="main">.</span> term_ok <span class="free">Θ</span> <span class="main">(</span>Fv <span class="bound">x</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>snd <span class="main">`</span> set <span class="free">insts</span> <span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> typ_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">τ</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">∈</span>set <span class="free">insts</span> <span class="main">.</span> typ_of <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> free<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">∈</span>set <span class="free">insts</span> <span class="main">.</span> <span class="bound">v</span> <span class="main">∉</span> FV <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> subst_term <span class="free">insts</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fresh_idns</span></span> <span class="keyword2"><span class="keyword">where</span></span> fresh_idns<span class="main">:</span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">fresh_idns</span> <span class="main">=</span> length <span class="free">insts</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idn</span> <span class="main">∈</span> set <span class="skolem">fresh_idns</span> <span class="main">.</span> 
      <span class="bound">idn</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>fv <span class="free">B</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>snd <span class="main">`</span> set <span class="free">insts</span> <span class="main">.</span> <span class="main">(</span>fv <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>fst <span class="main">`</span> set <span class="free">insts</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> fst <span class="main">`</span> <span class="main">(</span>FV <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"distinct <span class="skolem">fresh_idns</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> distinct_fresh_rename_idns fresh_fresh_rename_idns length_fresh_rename_idns finite_FV finite 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_term <span class="free">insts</span> <span class="free">B</span>                                        
    <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fresh_idns distinct subst_term_combine' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> fresh_idns vars a_ok typ_a free distinct <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> 
    <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">fresh_idns</span></span> <span class="quoted"><span class="free">insts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> term_oky<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Fv <span class="main">(</span>fst <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span>
            <span class="main">(</span>zip <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="skolem">xs</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> snoc.IH<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> UN_I Un_iff fst_conv image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>2-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yn</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> ynn<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yn</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> subst_term <span class="main">[</span><span class="main">(</span>fst <span class="skolem">y</span><span class="main">,</span> Fv <span class="skolem">x</span> <span class="skolem">n</span><span class="main">)</span><span class="main">]</span>
          <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>map2 Fv <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ynn<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inst_var<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span>"</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>map2 Fv <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fv <span class="skolem">x</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yn</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems <span class="quoted"><span class="quoted">‹wf_theory <span class="free">Θ</span>›</span></span> 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">using</span></span> term_oky ynn <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def typ_of_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> term_oky ynn <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def typ_of_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>6<span class="main">)</span> ynn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map2 Fv <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span>
      <span class="main">=</span> subst_term <span class="main">[</span><span class="main">(</span>fst <span class="skolem">y</span><span class="main">,</span> Fv <span class="skolem">x</span> <span class="main">(</span>snd <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
          <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>map2 Fv <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.hyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">simp_all</span> 
      
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">point</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">point</span> <span class="main">≡</span> <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span> 
    <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span> <span class="main">(</span>map2 Fv <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
  
  <span class="keyword1"><span class="command">from</span></span> fresh_idns vars a_ok typ_a free distinct <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span> <span class="bound">acc</span> <span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span> <span class="bound">acc</span><span class="main">)</span>
      <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">fresh_idns</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="free">insts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span><span class="main">)</span> 
      <span class="skolem">point</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">fresh_idns</span></span> <span class="quoted"><span class="free">insts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> B 
      <span class="keyword1"><span class="command">using</span></span> 1 point_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    
    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> typ_ofy<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>snd <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>snd <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span>
            <span class="main">(</span>zip <span class="main">(</span>zip <span class="skolem">xs</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>
            <span class="skolem">point</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> snoc.IH<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> UN_I Un_iff fst_conv image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>2-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yn</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> ynn<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yn</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> snd <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">y</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span>
            <span class="main">(</span>zip <span class="main">(</span>zip <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>map snd <span class="main">(</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="skolem">point</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ynn<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inst_var<span class="main">)</span> 
      <span class="keyword1"><span class="command">using</span></span> snoc.prems <span class="quoted"><span class="quoted">‹wf_theory <span class="free">Θ</span>›</span></span> 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 
      <span class="keyword1"><span class="command">using</span></span> typ_ofy ynn <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def typ_of_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> UN_I fst_conv image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span>
            <span class="main">(</span>zip <span class="main">(</span>zip <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>map snd <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="skolem">point</span> <span class="main">=</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> snd <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">y</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">single</span><span class="main">.</span> subst_term <span class="main">[</span><span class="bound">single</span><span class="main">]</span><span class="main">)</span>
            <span class="main">(</span>zip <span class="main">(</span>zip <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>map snd <span class="main">(</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="skolem">point</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> snoc.hyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">simp_all</span> 
    
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">from</span></span> 0 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> point_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logic-term_ok_eta_red_step"><span class="command">lemma</span></span> term_ok_eta_red_step<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_dependent <span class="free">t</span> <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">T</span> <span class="main">(</span><span class="free">t</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="main">(</span>decr <span class="main">0</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> term_ok_def wt_term_def <span class="keyword1"><span class="command">using</span></span> term_ok'_decr eta_preserves_typ_of <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="EqualityProof">
<div class="head">
<h1>Theory EqualityProof</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Derived rules on equality and normalization"</span></span>

<span class="keyword1"><span class="command">theory</span></span> EqualityProof
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Logic">Logic</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Check for automation here, steps seem very small*)</span>

<span class="keyword1" id="EqualityProof-proves_eq_reflexive_pre"><span class="command">lemma</span></span> proves_eq_reflexive_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> mk_eq <span class="free">t</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_reflexive_ax <span class="main">∈</span> axioms <span class="free">Θ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms term_ok_imp_typ_ok <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>       
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> eq_reflexive_ax"</span></span>
    <span class="keyword1"><span class="command">using</span></span> axiom_subst_typ' assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> term_ok_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span> 
    <span class="main">(</span>subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> eq_reflexive_ax<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> τ assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> inst_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span> 
    <span class="main">(</span>subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> eq_reflexive_ax<span class="main">)</span>
    <span class="main">=</span> mk_eq <span class="free">t</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> τ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_axs_def typ_of_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-unsimp_context"><span class="command">lemma</span></span> unsimp_context<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∪</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="EqualityProof-proves_eq_reflexive"><span class="command">lemma</span></span> proves_eq_reflexive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">t</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> unsimp_context<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms proves_eq_reflexive_pre weaken_proves_set <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="EqualityProof-proves_eq_symmetric_pre"><span class="command">lemma</span></span> proves_eq_symmetric_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">s</span> <span class="main">=</span> typ_of <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="free">t</span> <span class="main">⟼</span> mk_eq <span class="free">t</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_symmetric_ax <span class="main">∈</span> axioms <span class="free">Θ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms term_ok_imp_typ_ok <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> eq_symmetric_ax"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms axiom_subst_typ' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> term_ok_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''y''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span>
    <span class="main">(</span>subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> eq_symmetric_ax<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> τ <span class="quoted"><span class="quoted">‹typ_ok <span class="free">Θ</span> <span class="skolem">τ</span>›</span></span> term_ok_var assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inst_var_multiple <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_symmetric_ax_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> τ assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_axs_def typ_of_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_symmetric"><span class="command">lemma</span></span> proves_eq_symmetric<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">s</span> <span class="main">=</span> typ_of <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="free">t</span> <span class="main">⟼</span> mk_eq <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> unsimp_context<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms proves_eq_symmetric_pre weaken_proves_set <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="EqualityProof-proves_eq_symmetric2'"><span class="command">lemma</span></span> proves_eq_symmetric2'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_eq <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="free">t</span> <span class="main">⟼</span> mk_eq <span class="free">t</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms wt_term_def term_ok_mk_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">s</span> <span class="main">=</span> typ_of <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tinstT_def typ_of_def wt_term_def bind_eq_Some_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> proves_eq_symmetric assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_symmetric_rule"><span class="command">lemma</span></span> proves_eq_symmetric_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">s</span> <span class="main">=</span> typ_of <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proves.implies_elim<span class="main">[</span><span class="operator">OF</span> proves_eq_symmetric<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">OF</span> ctxt<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  

<span class="keyword1" id="EqualityProof-proves_eq_transitive_pre"><span class="command">lemma</span></span> proves_eq_transitive_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">s</span> <span class="main">=</span> typ_of <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> typ_of <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="free">t</span> <span class="main">⟼</span> mk_eq <span class="free">t</span> <span class="free">u</span> <span class="main">⟼</span> mk_eq <span class="free">s</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_transitive_ax <span class="main">∈</span> axioms <span class="free">Θ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms term_ok_imp_typ_ok <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> eq_transitive_ax"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms axiom_subst_typ' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> term_ok_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''y''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">,</span> 
      <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''z''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span><span class="main">]</span> 
    <span class="main">(</span>subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> eq_transitive_ax<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> τ assms ok term_ok_var <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inst_var_multiple <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_transitive_ax_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''y''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">,</span> 
      <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''z''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span><span class="main">]</span> 
    <span class="main">(</span>subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">]</span> eq_transitive_ax<span class="main">)</span>
    <span class="main">=</span> mk_eq <span class="free">s</span> <span class="free">t</span> <span class="main">⟼</span> mk_eq <span class="free">t</span> <span class="free">u</span> <span class="main">⟼</span> mk_eq <span class="free">s</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> τ assms<span class="main">(</span>5-6<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_axs_def typ_of_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.sel the_default.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_transitive"><span class="command">lemma</span></span> proves_eq_transitive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">s</span> <span class="main">=</span> typ_of <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> typ_of <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="free">t</span> <span class="main">⟼</span> mk_eq <span class="free">t</span> <span class="free">u</span> <span class="main">⟼</span> mk_eq <span class="free">s</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> unsimp_context<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms proves_eq_transitive_pre weaken_proves_set <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
    
<span class="keyword1" id="EqualityProof-proves_eq_transitive2"><span class="command">lemma</span></span> proves_eq_transitive2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_eq <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_eq <span class="free">t</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="free">t</span> <span class="main">⟼</span> mk_eq <span class="free">t</span> <span class="free">u</span> <span class="main">⟼</span> mk_eq <span class="free">s</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms wt_term_def term_ok_mk_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">s</span> <span class="main">=</span> typ_of <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tinstT_def typ_of_def wt_term_def bind_eq_Some_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> typ_of <span class="free">u</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tinstT_def typ_of_def wt_term_def bind_eq_Some_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> proves_eq_transitive assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_transitive_rule"><span class="command">lemma</span></span> proves_eq_transitive_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">s</span> <span class="main">=</span> typ_of <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> typ_of <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> proves_eq_transitive<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-6<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> proves.implies_elim<span class="main">[</span><span class="operator">OF</span> 1 assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> 3 <span class="main">=</span> proves.implies_elim<span class="main">[</span><span class="operator">OF</span> 2 assms<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ctxt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_intr_pre"><span class="command">lemma</span></span> proves_eq_intr_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">B</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">A</span> <span class="main">⟼</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟼</span> <span class="main">(</span><span class="free">B</span> <span class="main">⟼</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟼</span> mk_eq <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> closed<span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> typ_of_imp_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_intr_ax <span class="main">∈</span> axioms <span class="free">Θ</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> thy <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> eq_intr_ax"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> axiom' thy<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''A''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> propT<span class="main">)</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''B''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> propT<span class="main">)</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span><span class="main">]</span>
    eq_intr_ax"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms term_ok_var propT_ok <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inst_var_multiple <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_intr_ax_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_axs_def typ_of_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_intr"><span class="command">lemma</span></span> proves_eq_intr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">B</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">A</span> <span class="main">⟼</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟼</span> <span class="main">(</span><span class="free">B</span> <span class="main">⟼</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟼</span> mk_eq <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> unsimp_context<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms proves_eq_intr_pre weaken_proves_set <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="EqualityProof-proves_eq_intr_rule"><span class="command">lemma</span></span> proves_eq_intr_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">B</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">A</span> <span class="main">⟼</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">B</span> <span class="main">⟼</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> proves_eq_intr<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> proves.implies_elim<span class="main">[</span><span class="operator">OF</span> 1 assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> 3 <span class="main">=</span> proves.implies_elim<span class="main">[</span><span class="operator">OF</span> 2 assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ctxt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_elim_pre"><span class="command">lemma</span></span> proves_eq_elim_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">B</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> mk_eq <span class="free">A</span> <span class="free">B</span> <span class="main">⟼</span> <span class="free">A</span> <span class="main">⟼</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> closed<span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> typ_of_imp_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_elim_ax <span class="main">∈</span> axioms <span class="free">Θ</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> thy <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> eq_elim_ax"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> axiom' thy<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''A''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> propT<span class="main">)</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''B''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> propT<span class="main">)</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span><span class="main">]</span>
    eq_elim_ax"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms term_ok_var propT_ok <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inst_var_multiple <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_elim_ax_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_axs_def typ_of_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_elim"><span class="command">lemma</span></span> proves_eq_elim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">B</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">A</span> <span class="free">B</span> <span class="main">⟼</span> <span class="free">A</span> <span class="main">⟼</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> unsimp_context<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms proves_eq_elim_pre weaken_proves_set <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="EqualityProof-proves_eq_elim_rule"><span class="command">lemma</span></span> proves_eq_elim_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">B</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">A</span> <span class="main">⟼</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proves.implies_elim<span class="main">[</span><span class="operator">OF</span> proves_eq_elim<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">,</span> <span class="operator">OF</span> ctxt<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1" id="EqualityProof-proves_eq_elim2_rule"><span class="command">lemma</span></span> proves_eq_elim2_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">B</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span> <span class="main">⟼</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">B</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_symmetric_rule<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> proves_eq_elim_rule<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_combination_pre"><span class="command">lemma</span></span> proves_eq_combination_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">g</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">x</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">y</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> mk_eq <span class="free">f</span> <span class="free">g</span> <span class="main">⟼</span> mk_eq <span class="free">x</span> <span class="free">y</span> <span class="main">⟼</span> mk_eq <span class="main">(</span><span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> term_ok_betapply term_ok_imp_typ_ok thy typ_of_betaply thy x f <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_combination_ax <span class="main">∈</span> axioms <span class="free">Θ</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> thy <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms term_ok_imp_typ_ok thy term_ok_betapply typ_of_betaply <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> subst_typ' 
    <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''b''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span><span class="main">]</span> eq_combination_ax"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms axiom_subst_typ' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> term_ok_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> subst_term 
    <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''f''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''g''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span><span class="main">,</span>
      <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''y''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span><span class="main">]</span>
    <span class="main">(</span>subst_typ' <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''b''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span><span class="main">]</span> 
    eq_combination_ax<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms term_ok_var ok <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inst_var_multiple <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_combination_ax_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_axs_def typ_of_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_combination"><span class="command">lemma</span></span> proves_eq_combination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">g</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">x</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">y</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">f</span> <span class="free">g</span> <span class="main">⟼</span> mk_eq <span class="free">x</span> <span class="free">y</span> <span class="main">⟼</span> mk_eq <span class="main">(</span><span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> unsimp_context<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms proves_eq_combination_pre weaken_proves_set <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="comment1">(* Can probably drop a whole lot of assumptions as thy are deriveable from the last one*)</span>
<span class="keyword1" id="EqualityProof-proves_eq_combination_rule"><span class="command">lemma</span></span> proves_eq_combination_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">g</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">x</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">y</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span><span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> proves_eq_combination<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-9<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> proves.implies_elim<span class="main">[</span><span class="operator">OF</span> 1 assms<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> 3 <span class="main">=</span> proves.implies_elim<span class="main">[</span><span class="operator">OF</span> 2 assms<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ctxt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_combination_rule_better"><span class="command">lemma</span></span> proves_eq_combination_rule_better<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">x</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span><span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ok_Apps<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_eq <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_eq <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> proved_terms_well_formed_pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">hence</span></span> tyy<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">y</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tyg<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">g</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> term_ok_mk_eq_same_typ thy x f term_okD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ok_Apps term_ok_mk_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> proves_eq_combination_rule assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_mp_rule"><span class="command">lemma</span></span> proves_eq_mp_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">B</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">A</span> <span class="main">⟼</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> proves_eq_elim_rule<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> eq ctxt<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> proves.implies_elim pA <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_mp_rule_better"><span class="command">lemma</span></span> proves_eq_mp_rule_better<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ctxt eq pA proved_terms_well_formed<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
      proves_eq_mp_rule term_ok_mk_eqD term_ok_mk_eq_same_typ thy<span class="main">)</span>

<span class="keyword1" id="EqualityProof-proves_subst_rule"><span class="command">lemma</span></span> proves_subst_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">x</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">y</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">P</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span> <span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span> <span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span><span class="free">P</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">P</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms proves_eq_reflexive <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> proves_eq_combination_rule assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="EqualityProof-proves_beta_step_rule"><span class="command">lemma</span></span> proves_beta_step_rule<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> abs<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">x</span> <span class="main">=</span> Some <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> subst_bv <span class="free">x</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span><span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proves.β_conversion assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> term_okD1<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tyAbs<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Some propT"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> abs<span class="main">(</span>2<span class="main">)</span> proved_terms_well_formed <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> tySub<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some propT"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tyAbs <span class="keyword1"><span class="command">unfolding</span></span> subst_bv_def typ_of_def 
    <span class="keyword1"><span class="command">using</span></span> typ_of1_subst_bv_gen' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> term_ok'.simps<span class="main">(</span>5<span class="main">)</span> wt_term_def term_ok_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> term_ok'_subst_bv1 x<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> term_okD1 subst_bv_def<span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> x<span class="main">(</span>1<span class="main">)</span> wt_term_def term_ok'_subst_bv1 subst_bv_def tySub term_okD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_mp_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>Abs <span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> <span class="free">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Remember the name of this rule *)</span>
<span class="keyword1" id="EqualityProof-proves_add_param_rule"><span class="command">lemma</span></span> proves_add_param_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> type<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> 
      <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> term_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_eq <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq<span class="main">(</span>1<span class="main">)</span> proved_terms_well_formed_pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> term_ok'<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wt_term_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>mk_eq <span class="free">f</span> <span class="free">g</span><span class="main">)</span>›</span></span> wt_term_def typ_of_def  term_ok_app_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> typ_of <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> thy term_ok <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tinstT_def typ_of_def wt_term_def bind_eq_Some_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> type'<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">g</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> eq<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>fv <span class="main">(</span>mk_eq <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">∪</span> FV <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_fv finite_FV infinite_fv_UNIV variant_variable_fresh ctxt
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> finite_Un finite_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> free<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="main">(</span>mk_eq <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">∪</span> FV <span class="free">Γ</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ctxt proves_eq_reflexive term_ok_var thy type <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_combination_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> τ'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">τ'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms term_ok' type' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> term_ok_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_all <span class="skolem">x</span> <span class="free">τ</span> <span class="main">(</span>mk_eq <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves.forall_intro<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> thy eq type free <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mk_all <span class="skolem">x</span> <span class="free">τ</span> <span class="main">(</span>mk_eq <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span>Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> 
      <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> free eq type type' bind_fv2_changed
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_fv_def bind_fv_unchanged typ_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_add_abs_rule"><span class="command">lemma</span></span> proves_add_abs_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> type<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq<span class="main">(</span>1<span class="main">)</span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> g_ty<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">g</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eq<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> term_ok_mk_eq_same_typ thy<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> closed<span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq<span class="main">(</span>2<span class="main">)</span> typ_of_imp_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> ok'<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> type term_ok_eta_expand ok thy eq<span class="main">(</span>2<span class="main">)</span> g_ty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> ok_ind<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_term <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">f</span>"</span></span>  <span class="quoted"><span class="quoted">"wf_term <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ok wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> proves.eta<span class="main">[</span><span class="operator">OF</span> thy ok_ind<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> typ_of_imp_has_typ<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> proves.eta<span class="main">[</span><span class="operator">OF</span> thy ok_ind<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> typ_of_imp_has_typ<span class="main"><span class="main">[</span></span><span class="operator">OF</span> g_ty<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> simp'<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bv <span class="skolem">x</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"subst_bv <span class="skolem">x</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> ok term_ok_subst_bv_no_change <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">g</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_symmetric_rule<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2"</span>  ok'<span class="main">(</span>2<span class="main">)</span> ok<span class="main">(</span>2<span class="main">)</span> thy typ_of_eta_expand<span class="main">[</span><span class="operator">OF</span> g_ty<span class="main">]</span> g_ty ctxt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simp'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> tr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">g</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> 1 eq<span class="main">(</span>1<span class="main">)</span> g_ty ok'<span class="main">(</span>1<span class="main">)</span> ok<span class="main">(</span>1<span class="main">)</span> ok<span class="main">(</span>2<span class="main">)</span> proves_eq_transitive_rule<span class="main">[</span><span class="operator">OF</span> thy _ _ _ _ _ _ _ ctxt<span class="main">]</span>
      typ_of_eta_expand<span class="main">[</span><span class="operator">OF</span> eq<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> eq<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simp'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> tr1 s2 proves_eq_transitive_rule<span class="main">[</span><span class="operator">OF</span> thy ok'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ok<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ok'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> typ_of_eta_expand eq<span class="main">(</span>2<span class="main">)</span> g_ty
    ctxt
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_inst_bound_rule"><span class="command">lemma</span></span> proves_inst_bound_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span> <span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span> <span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">x</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq<span class="main">(</span>1<span class="main">)</span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> term_ok_mk_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> thy <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tinstT_def typ_of_def wt_term_def bind_eq_Some_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">x</span> <span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ctxt proves_eq_reflexive thy x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> term_ok_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proves_eq_combination_rule<span class="main">[</span><span class="operator">OF</span> thy <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span><span class="main">)</span>›</span></span> eq<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span>›</span></span> 
        <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>›</span></span> x x eq<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ ctxt<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> β_conversion<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> thy x <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span><span class="main">)</span>›</span></span> x
      <span class="quoted"><span class="quoted">‹<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>›</span></span>  proved_terms_well_formed<span class="main">(</span>1<span class="main">)</span> 
      wt_term_def typ_of1_split_App_obtains typ_of_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> term_ok_mk_eqD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span>›</span></span> x
    <span class="quoted"><span class="quoted">‹<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>›</span></span> proved_terms_well_formed<span class="main">(</span>1<span class="main">)</span> 
    wt_term_def typ_of1_split_App_obtains typ_of_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> term_ok_mk_eqD<span class="main">)</span>
 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">τ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>›</span></span> x<span class="main">(</span>2<span class="main">)</span> typ_of_def  typ_of_betapply <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span><span class="main">)</span>›</span></span> substn_subst_0' term_ok'_subst_bv2 wt_term_def x<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span>›</span></span> typ_of_def <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">τ'</span>›</span></span> typ_of_Abs_body_typ' x<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span>›</span></span> typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_symmetric_rule<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> thy <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> ctxt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> β_conversion<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> thy x <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">g</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>›</span></span> 
      <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>›</span></span> 
      <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">τ'</span>›</span></span> betapply.simps<span class="main">(</span>1<span class="main">)</span> subst_bv_def term_ok'.simps<span class="main">(</span>5<span class="main">)</span>
      term_ok'_subst_bv1 wt_term_def typ_of_betaply x<span class="main">(</span>1<span class="main">)</span> x<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted">"3"</span> proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> term_ok_mk_eqD<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">g</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span><span class="main">)</span>›</span></span> eq<span class="main">(</span>2<span class="main">)</span> typ_of_betapply typ_of_def x<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_transitive_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> 
        <span class="main">(</span><span class="operator">use</span> assms 1 2 <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span>›</span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">solves</span> <span class="operator">simp</span>›</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_transitive_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> 
        <span class="main">(</span><span class="operator">use</span> assms 1 2 <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span>›</span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">solves</span> <span class="operator">simp</span>›</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">g</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹typ_of <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">g</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="free">x</span> <span class="free">g</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* The is_closeds are annoying *)</span>
<span class="keyword1" id="EqualityProof-proves_descend_abs_rule"><span class="command">lemma</span></span> proves_descend_abs_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_closed <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">∉</span> FV <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> abs_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq proved_terms_well_formed wt_term_def typ_of1_split_App typ_of_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> term_ok_mk_eqD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ1<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ'</span> <span class="main">→</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> eq proved_terms_well_formed_pre typ_of1_split_App_obtains typ_of_Abs_body_typ' typ_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> τ2<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ'</span> <span class="main">→</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> term_ok_mk_eq_same_typ thy<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> add_param<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq 
    <span class="main">(</span>Abs <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>
    <span class="main">(</span>Abs <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> proves_eq_combination_rule<span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> assms abs_ok τ1 τ2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">solves</span> <span class="operator">simp</span>)<span class="keyword3">?</span>›</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> proves_eq_reflexive term_ok_var thy x<span class="main">(</span>2<span class="main">)</span> wt_term_def ctxt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> βs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq 
    <span class="main">(</span>Abs <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>
    <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> proves.β_conversion<span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> assms abs_ok τ1 τ2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">solves</span> ‹<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> wt_term_def›)<span class="keyword3">?</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> simps<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_bv_bind_fv typ_of_imp_closed eq<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> βs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> βs proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> wt_term_def typ_of_def 
    <span class="keyword1"><span class="command">using</span></span> term_ok_app_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">s</span> <span class="main">$</span> term.Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> βs <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="free">s</span>›</span></span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok'.simps<span class="main">(</span>4<span class="main">)</span> 
        wt_term_def term_ok_mk_eq_same_typ thy
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> term_ok_mk_eqD<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> βs_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_symmetric_rule<span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> assms abs_ok τ1 τ2 t1 t2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">solves</span> <span class="operator">simp</span>)<span class="keyword3">?</span>›</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> βs proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eq_same_typ thy <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> βs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> βt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq 
    <span class="main">(</span>Abs <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>
    <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> proves.β_conversion<span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> assms abs_ok τ1 τ2 t1 t2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">solves</span> ‹<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> wt_term_def›)<span class="keyword3">?</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> simpt<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_bv_bind_fv typ_of_imp_closed eq<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> βt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq  <span class="main">(</span>Abs <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> t3<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">t</span> <span class="main">$</span> term.Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> βs add_param proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> t1 term_ok'.simps<span class="main">(</span>4<span class="main">)</span>
        wt_term_def term_ok_mk_eq_same_typ thy 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> term_ok_mk_eqD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> t4<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">s</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">t</span> <span class="main">$</span> term.Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> βs add_param proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> term_ok_mk_eq_same_typ thy<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> t5<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">s</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">s</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> βs_rev proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eq_same_typ thy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> t6<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">s</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">t</span> <span class="main">$</span> term.Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t4 t5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> half<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_transitive_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Abs <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span>"</span></span><span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> assms abs_ok τ1 τ2 t1 t2 t3 t4 t5 t6 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">solves</span> <span class="operator">simp</span>)<span class="keyword3">?</span>›</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> βs_rev <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> add_param <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> t7<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> βt proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> t1 t4 term_ok'.simps<span class="main">(</span>4<span class="main">)</span> wt_term_def term_ok_mk_eq_same_typ thy
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> term_ok_app_eqD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> t8<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">t</span> <span class="main">$</span> term.Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> βt proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eq_same_typ thy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_transitive_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Abs <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span>"</span></span><span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> assms abs_ok τ1 τ2 t1 t2 t3 t4 t5 t6 t7 t8 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">solves</span> <span class="operator">simp</span>)<span class="keyword3">?</span>›</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> half <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> βt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* MOVE? Not general enough for other place, seems like an adhoc solution*)</span>
<span class="keyword1" id="EqualityProof-obtain_fresh_variable"><span class="command">lemma</span></span> obtain_fresh_variable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="free">t</span> <span class="main">∪</span> FV <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms finite_fv finite_FV
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_Un finite_imageI fst_conv image_eqI variant_variable_fresh<span class="main">)</span>
<span class="keyword1" id="EqualityProof-obtain_fresh_variable'"><span class="command">lemma</span></span> obtain_fresh_variable'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="free">t</span> <span class="main">∪</span> fv <span class="free">u</span> <span class="main">∪</span> FV <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms finite_fv finite_FV
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_Un finite_imageI fst_conv image_eqI variant_variable_fresh<span class="main">)</span>

<span class="keyword1" id="EqualityProof-proves_eq_abstract_rule_pre"><span class="command">lemma</span></span> proves_eq_abstract_rule_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">g</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> <span class="main">(</span>Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs <span class="free">τ</span> <span class="main">(</span>mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟼</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_abstract_rule_ax <span class="main">∈</span> axioms <span class="free">Θ</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> thy <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> ok2<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> term_ok_imp_typ_ok thy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> ok3<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> thy A<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> ok1<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> thy A<span class="main">(</span>2<span class="main">)</span> ok2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> subst_typ' 
    <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''b''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span><span class="main">]</span> eq_abstract_rule_ax"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms axiom_subst_typ' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> term_ok_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''g''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span><span class="main">,</span>
      <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''f''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>subst_typ'
    <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''b''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span><span class="main">]</span> eq_abstract_rule_ax<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ok1 ok2 ok3 assms term_ok_var <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inst_var_multiple <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_abstract_rule_ax_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_term <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''g''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span><span class="main">,</span>
      <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''f''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>subst_typ'
    <span class="main">[</span><span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''b''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> full_sort<span class="main">)</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span><span class="main">]</span> eq_abstract_rule_ax<span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span>Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs <span class="free">τ</span> <span class="main">(</span>mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟼</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms typ_of1_weaken_Ts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_axs_def typ_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_abstract_rule"><span class="command">lemma</span></span> proves_eq_abstract_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">g</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs <span class="free">τ</span> <span class="main">(</span>mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟼</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> unsimp_context<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms proves_eq_abstract_rule_pre weaken_proves_set <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="EqualityProof-proves_eq_abstract_rule_rule"><span class="command">lemma</span></span> proves_eq_abstract_rule_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">g</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs <span class="free">τ</span> <span class="main">(</span>mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> proves_eq_abstract_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> ctxt<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> proves.implies_elim<span class="main">[</span><span class="operator">OF</span> 1 assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ctxt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eq_ext_rule"><span class="command">lemma</span></span> proves_eq_ext_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="free">g</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ</span> <span class="main">→</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs <span class="free">τ</span> <span class="main">(</span>mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">f</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">∉</span> FV <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Un_iff ctxt<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> obtain_fresh_variable'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> closed<span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">g</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> f g has_typ_imp_closed term_ok_def wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prem proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_app_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bv <span class="main">(</span>Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Core.subst_bv_def f<span class="main">(</span>1<span class="main">)</span> term_ok_subst_bv_no_change <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bv <span class="main">(</span>Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Core.subst_bv_def g<span class="main">(</span>1<span class="main">)</span> term_ok_subst_bv_no_change <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bv <span class="main">(</span>Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Core.subst_bv_def<span class="main">)</span>  
  <span class="keyword1"><span class="command">hence</span></span> simp<span class="main">:</span> <span class="quoted"><span class="quoted">"Abs <span class="free">τ</span> <span class="main">(</span>mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> Fv <span class="skolem">x</span> <span class="free">τ</span> <span class="main">=</span> mk_eq <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f g <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typ_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> simp'<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bv <span class="main">(</span>Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f g <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typ_of_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> simp'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> forall_elim<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> τ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">τ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> prem <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>mk_eq' <span class="free">τ'</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> term_ok'.simps<span class="main">(</span>1<span class="main">)</span> term_ok'.simps<span class="main">(</span>5<span class="main">)</span> term_okD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">τ'</span>"</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">τ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f<span class="main">(</span>2<span class="main">)</span> g<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typ_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Fv <span class="skolem">x</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> core<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_abstract_rule_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thy f g _ ctxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> prem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f proves.eta term_okD1 thy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">f</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">(* Should be: auto ... *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_symmetric_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thy f<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ _ _ ctxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>›</span></span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eqD <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Logic.typ_of_eta_expand f<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g proves.eta term_okD1 thy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_transitive_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> thy f<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ g<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ _ left _ ctxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span>›</span></span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eqD <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Logic.typ_of_eta_expand f<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Logic.typ_of_eta_expand f<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> g<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_transitive_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Abs <span class="free">τ</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> thy _ _ g<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>  _ _ core right ctxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span>›</span></span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eqD <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">g</span>›</span></span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eqD <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Logic.typ_of_eta_expand f<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> g<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-bind_fv2_idem"><span class="command">lemma</span></span> bind_fv2_idem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"bind_fv2 <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">lev1</span> <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">lev2</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> bind_fv2 <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">lev2</span> <span class="free">t</span> "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">lev2</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lev1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bind_fv2.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">corollary</span></span> bind_fv_idem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span> "</span></span>
  <span class="keyword1"><span class="command">using</span></span> bind_fv_def bind_fv2_idem <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">corollary</span></span> bind_fv_Abs_fv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Abs_fv <span class="free">x</span> <span class="free">τ</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_fv_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"bind_fv2 <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="free">lev</span> <span class="main">(</span>mk_eq' <span class="free">τ'</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> mk_eq' <span class="free">τ'</span> <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="free">lev</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>bind_fv2 <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="free">lev</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="main">(</span>mk_eq' <span class="free">τ'</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> mk_eq' <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_fv_def<span class="main">)</span>

<span class="keyword1" id="EqualityProof-term_ok_Abs_fvI"><span class="command">lemma</span></span> term_ok_Abs_fvI<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">s</span> <span class="main">⟹</span> typ_ok <span class="free">Θ</span> <span class="free">τ</span> <span class="main">⟹</span> term_ok <span class="free">Θ</span> <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def term_ok'_bind_fv typ_of_Abs_bind_fv<span class="main">)</span>
  
<span class="keyword1" id="EqualityProof-proves_eq_abstract_rule_derived_rule"><span class="command">lemma</span></span> proves_eq_abstract_rule_derived_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∉</span> FV <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="free">t</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">τ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> eq option.exhaust_sel proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> term_okD2 term_ok_app_eqD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="free">t</span> <span class="main">=</span> Some <span class="skolem">τ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> s term_ok_mk_eq_same_typ thy<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> closed<span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq has_typ_imp_closed proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_def term_ok_mk_eqD wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="main">(</span>mk_eq <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq proved_terms_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>mk_eq <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> Fv <span class="free">x</span> <span class="free">τ</span> <span class="main">=</span> mk_eq <span class="free">s</span> <span class="free">t</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> betapply_Abs_fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_all <span class="free">x</span> <span class="free">τ</span> <span class="main">(</span>mk_eq <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq forall_intro thy typ_ok_def x<span class="main">(</span>1<span class="main">)</span> x<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> term_ok_Abs_fvI<span class="main">[</span><span class="operator">OF</span> ok<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> x<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> wf_term.intros<span class="main">(</span>1<span class="main">)</span> typ_ok_def x<span class="main">(</span>2<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> β_conversion<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thy<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subst_bv_bind_fv<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> unfs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> term_ok_Abs_fvI<span class="main">[</span><span class="operator">OF</span> ok<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> x<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> wf_term.intros<span class="main">(</span>1<span class="main">)</span> typ_ok_def x<span class="main">(</span>2<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> β_conversion<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thy<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subst_bv_bind_fv<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> unft<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">have</span></span> prem<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_transitive_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">s</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> thy _ _ _ _ _ _ _ ctxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ok<span class="main">(</span>1<span class="main">)</span> term_ok_mk_eqD unfs unft proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eq_same_typ thy 
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">all</span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> s t term_ok_mk_eq_same_typ thy unft<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> unfs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_transitive_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> thy ok _ _ _ _ _ ctxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eqD unft <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s t<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> term_ok_mk_eq_same_typ thy unft<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_symmetric_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thy ok<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ _ _ ctxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eqD unft <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">using</span></span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eq_same_typ thy unft <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">using</span></span> unft <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_all <span class="free">x</span> <span class="free">τ</span>
    <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> forall_intro thy typ_ok_def x<span class="main">(</span>1<span class="main">)</span> x<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mk_all <span class="free">x</span> <span class="free">τ</span> 
      <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> mk_all <span class="free">x</span> <span class="free">τ</span> 
      <span class="main">(</span>mk_eq' <span class="skolem">τ'</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bind_fv2_preserves_type s t typ_of_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_fv_def typ_of_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mk_all <span class="free">x</span> <span class="free">τ</span> 
      <span class="main">(</span>mk_eq' <span class="skolem">τ'</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs <span class="free">τ</span> 
      <span class="main">(</span>mk_eq' <span class="skolem">τ'</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_fv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> pre_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> Abs <span class="free">τ</span> 
      <span class="main">(</span>mk_eq' <span class="skolem">τ'</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_ext_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> τ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">τ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> τ'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">τ'</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> thy _ _ _ _ _ ctxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_app_eqD unfs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s typ_of_Abs_bind_fv<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_app_eqD unft <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t typ_of_Abs_bind_fv<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> pre_ext <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* This should allow descending under abstractions for rewriting *)</span>
<span class="keyword1" id="EqualityProof-proves_descend_abs_rule_iff"><span class="command">lemma</span></span> proves_descend_abs_rule_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">∉</span> FV <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="free">t</span> 
    <span class="main">⟷</span> <span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="main">(</span>bind_fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_abstract_rule_derived_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thy x ctxt asm<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">s</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms asm proves_descend_abs_rule <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* This seems better *)</span>
<span class="keyword1" id="EqualityProof-proves_descend_abs_rule'"><span class="command">lemma</span></span> proves_descend_abs_rule'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">∉</span> FV <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> abs_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq<span class="main">(</span>1<span class="main">)</span> option.distinct<span class="main">(</span>1<span class="main">)</span> proved_terms_well_formed term_ok'.simps<span class="main">(</span>4<span class="main">)</span>
        wt_term_def typ_of1_split_App typ_of_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> term_ok_mk_eqD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ1<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">τ'</span> <span class="main">→</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> eq proved_terms_well_formed_pre typ_of1_split_App_obtains typ_of_Abs_body_typ' typ_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> τ2<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">t</span><span class="main">)</span><span class="main">=</span> Some <span class="main">(</span><span class="free">τ'</span> <span class="main">→</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> term_ok_mk_eq_same_typ thy<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> add_param<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq 
    <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">s</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>
    <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">t</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_combination_rule<span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> assms abs_ok τ1 τ2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">solves</span> ‹<span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">:</span> term_ok_def›)<span class="keyword3">?</span>›</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> proves_eq_reflexive term_ok_var thy x<span class="main">(</span>2<span class="main">)</span> ctxt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> βs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq 
    <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">s</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>
    <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> proves.β_conversion<span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> assms abs_ok τ1 τ2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">solves</span> ‹<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> wt_term_def›)<span class="keyword3">?</span>›</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> βs proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> wt_term_def typ_of_def 
    <span class="keyword1"><span class="command">using</span></span> term_ok_mk_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">s</span> <span class="main">$</span> term.Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> βs proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> t1 term_ok'.simps<span class="main">(</span>4<span class="main">)</span> wt_term_def term_ok_mk_eq_same_typ thy
      term_ok_mk_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> βs_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">s</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_symmetric_rule<span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> assms abs_ok τ1 τ2 t1 t2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">solves</span> <span class="operator">simp</span>)<span class="keyword3">?</span>›</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> βs proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eq_same_typ thy <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> βs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> βt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq 
    <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">t</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>
    <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> proves.β_conversion<span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> assms abs_ok τ1 τ2 t1 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">solves</span> ‹<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> wt_term_def›)<span class="keyword3">?</span>›</span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> t3<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">t</span> <span class="main">$</span> term.Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> βs add_param proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> t1 term_ok'.simps<span class="main">(</span>4<span class="main">)</span>
        wt_term_def term_ok_mk_eq_same_typ thy term_ok_mk_eqD 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">have</span></span> t4<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">t</span> <span class="main">$</span> term.Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> βs add_param proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> term_ok_mk_eq_same_typ thy<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> t5<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">s</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> βs_rev proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eq_same_typ thy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> t6<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">s</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">t</span> <span class="main">$</span> term.Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t4 t5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> half<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">t</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_transitive_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Abs <span class="free">τ'</span> <span class="free">s</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span>"</span></span><span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> assms abs_ok τ1 τ2 t1 t2 t3 t4 t5 t6 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">solves</span> <span class="operator">simp</span>)<span class="keyword3">?</span>›</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> βs_rev <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> add_param <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> t7<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> βt proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> t1 t4 term_ok'.simps<span class="main">(</span>4<span class="main">)</span> wt_term_def term_ok_mk_eq_same_typ thy
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> term_ok_app_eqD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> t8<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">t</span> <span class="main">$</span> term.Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">=</span> typ_of <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> βt proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eq_same_typ thy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_transitive_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Abs <span class="free">τ'</span> <span class="free">t</span> <span class="main">$</span> Fv <span class="free">x</span> <span class="free">τ'</span>"</span></span><span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> assms abs_ok τ1 τ2 t1 t2 t3 t4 t5 t6 t7 t8 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">solves</span> <span class="operator">simp</span>)<span class="keyword3">?</span>›</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> half <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> βt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_ascend_abs_rule'"><span class="command">lemma</span></span> proves_ascend_abs_rule'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">∉</span> FV <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span> <span class="main">∉</span> fv <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ok_ind<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_type <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">τ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> proves_eq_abstract_rule_derived_rule<span class="main">[</span><span class="operator">OF</span> thy<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> wt_term_def typ_of_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> term_ok_app_eqD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wt_term_def typ_of_imp_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> loose_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">s</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_closed_subst_bv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> loose_s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">s</span> <span class="bound">x</span><span class="main">)</span> "</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_loose_bvar_imp_not_loose_bvar1_all_greater<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> occs <span class="main">(</span>case_prod Fv <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span> <span class="main">∉</span> fv <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_iff_occs<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="main">(</span>subst_bv <span class="main">(</span>term.Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Abs <span class="free">τ'</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subst_bv_def bind_fv_def 
      <span class="keyword1"><span class="command">using</span></span> bind_fv2_subst_bv1_cancel
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> case_prod_conv less_one linorder_neqE_nat
          loose_bvar1_imp_loose_bvar loose_s not_less_zero<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> wt_term_def typ_of_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> term_ok_app_eqD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wt_term_def typ_of_imp_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> loose_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="free">t</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_closed_subst_bv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> loose_s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">¬</span> loose_bvar1 <span class="free">t</span> <span class="bound">x</span><span class="main">)</span> "</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_loose_bvar_imp_not_loose_bvar1_all_greater<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> occs <span class="main">(</span>case_prod Fv <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span> <span class="main">∉</span> fv <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_iff_occs<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_fv <span class="free">x</span> <span class="free">τ'</span> <span class="main">(</span>subst_bv <span class="main">(</span>term.Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Abs <span class="free">τ'</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subst_bv_def bind_fv_def 
      <span class="keyword1"><span class="command">using</span></span> bind_fv2_subst_bv1_cancel
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> case_prod_conv less_one linorder_neqE_nat loose_bvar1_imp_loose_bvar 
        loose_s not_less_zero<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> 1 s t <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ctxt  eq x<span class="main">(</span>1<span class="main">)</span> x<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_descend_abs_rule_iff'"><span class="command">lemma</span></span> proves_descend_abs_rule_iff'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">∉</span> FV <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">∉</span> fv <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="free">τ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="free">x</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">⟷</span> <span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Abs <span class="free">τ'</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms proves_ascend_abs_rule' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> assms proves_descend_abs_rule' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="EqualityProof-proves_beta_step_pre"><span class="command">lemma</span></span> proves_beta_step_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> free<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">τ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">vs</span> <span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="free">t</span> <span class="main">∪</span> FV <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> term_ok'<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="free">vs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> beta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="free">vs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="free">vs</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> beta term_ok' free <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">T</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> beta.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">using</span></span> term_ok_app_eqD term_ok_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">.</span> is_closed <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> beta.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> simp<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="main">=</span> Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> ok'<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ok <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ok<span class="main">(</span>2<span class="main">)</span> wt_term_def typ_of_beta_redex_arg simp
    <span class="keyword1"><span class="command">using</span></span> beta.prems<span class="main">(</span>1<span class="main">)</span> subst_bvs_App
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> term_okD2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> ok_unf<span class="main">:</span> <span class="quoted"><span class="quoted">"wt_term <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_term <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ok<span class="main">(</span>2<span class="main">)</span> ok' wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bvs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> term.Fv <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span>
              <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">s</span> <span class="main">$</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> 
  Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simp<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>subst_bv2 <span class="skolem">s</span> <span class="main">0</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span>subst_bv <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>
              <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_bvs1'_subst_bv2<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> subst_bvs_subst_bvs1'
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 map_map simp subst_bvs1.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subst_bvs1_subst_bvs1' 
        subst_bvs_def substn_subst_0' term.inject<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> β_conversion<span class="main">[</span><span class="operator">OF</span> thy ok_unf<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>appL <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_bvs_App term_ok_app_eqD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set <span class="skolem">vs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="skolem">s</span> <span class="main">∪</span> FV <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> appL <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>
            <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> appL.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span>
      <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proves_eq_reflexive<span class="main">[</span><span class="operator">OF</span> thy ok<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">,</span> <span class="operator">OF</span> finite ctxt<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of 
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ok wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"typ_of 
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">τ</span> <span class="main">→</span> <span class="skolem">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> τ appL.prems<span class="main">(</span>1<span class="main">)</span> not_None_eq subst_bvs_App wt_term_def typ_of1_arg_typ typ_of_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> term_okD2<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> proves_eq_combination_rule_better thy finite ctxt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>appR <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_bvs_App term_ok_app_eqD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set <span class="skolem">vs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="skolem">s</span> <span class="main">∪</span> FV <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> appR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>
            <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> appR.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span>
      <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proves_eq_reflexive<span class="main">[</span><span class="operator">OF</span> thy ok<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">,</span> <span class="operator">OF</span> finite ctxt<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of 
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ok wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"typ_of 
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">τ</span> <span class="main">→</span> <span class="skolem">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> τ appR.prems<span class="main">(</span>1<span class="main">)</span> not_None_eq subst_bvs_App wt_term_def typ_of1_arg_typ typ_of_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> term_okD2<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> proves_eq_combination_rule_better thy finite ctxt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set <span class="skolem">vs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="skolem">s</span> <span class="main">∪</span> FV <span class="free">Γ</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> abs.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">.</span> is_closed <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">hence</span></span> simp<span class="main">:</span> <span class="quoted"><span class="quoted">"mk_eq <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> mk_eq <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">t</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> T_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> abs.prems term_ok_Types_typ_ok simp thy <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fv <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">t</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> FV <span class="free">Γ</span> <span class="main">∪</span> fv <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite finite_fv finite_FV <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> <span class="main">(</span>fv <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">t</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> FV <span class="free">Γ</span> <span class="main">∪</span> fv <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span> <span class="bound">t</span> <span class="bound">P</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∉</span> <span class="bound">P</span> <span class="main">∨</span> <span class="bound">v</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="bound">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> fst_conv image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> 1 variant_variable_fresh finite_Un finite_imageI fst_conv image_eqI <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> <span class="main">(</span>fv <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">t</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> FV <span class="free">Γ</span> <span class="main">∪</span> fv <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> fv <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">t</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> FV <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> fv <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> abs.prems<span class="main">(</span>1<span class="main">)</span> simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


  <span class="keyword1"><span class="command">thm</span></span> subst_bvs_extend_lower_level
  <span class="keyword1"><span class="command">have</span></span> combine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subst_bv <span class="main">(</span>term.Fv <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
              <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> term.Fv <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span><span class="main">#</span><span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_bvs_extend_lower_level 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> term.Fv <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">.</span> is_closed <span class="bound">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span><span class="main">#</span><span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>
        <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span><span class="main">#</span><span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> abs.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ok <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> combine term_ok_subst_bv<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> x abs.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq 
    <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">t</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_ascend_abs_rule'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> thy <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> T_ok <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> 1  <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> term.Fv <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">.</span> is_closed <span class="bound">v</span>›</span></span> subst_bvs_extend_lower_level 
      finite ctxt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-subst_bvs_empty"><span class="command">lemma</span></span> subst_bvs_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bvs <span class="main">[]</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_bvs_subst_bvs1'<span class="main">)</span>

<span class="keyword1" id="EqualityProof-proves_beta_step"><span class="command">lemma</span></span> proves_beta_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> term_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> beta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">t</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> unsimpt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> unsimpu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> unsimp<span class="main">:</span> <span class="quoted"><span class="quoted">"mk_eq <span class="free">t</span> <span class="free">u</span> <span class="main">=</span> mk_eq 
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> unsimp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_beta_step_pre<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_beta_steps"><span class="command">lemma</span></span> proves_beta_steps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> term_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> beta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">t</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> beta term_ok <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_refl <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite ctxt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> proves_eq_reflexive thy<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_into_rtrancl <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="skolem">b</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proves_beta_step rtrancl_into_rtrancl.hyps<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> beta_star_preserves_term_ok local.finite rtrancl_into_rtrancl.hyps<span class="main">(</span>1<span class="main">)</span>
      rtrancl_into_rtrancl.prems thy finite ctxt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> finite ctxt proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> proves_eq_transitive_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thy _ _ _ _ _ _ _ finite ctxt<span class="main"><span class="main">]</span></span>
        term_ok_mk_eqD term_ok_mk_eq_same_typ thy<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_beta_norm"><span class="command">lemma</span></span> proves_beta_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> term_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> beta<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_norm <span class="free">t</span> <span class="main">=</span> Some <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite ctxt
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> beta_norm_imp_beta_reds local.beta local.finite proves_beta_steps term_ok thy
      <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> term_ok_def<span class="main">)</span>

<span class="keyword1" id="EqualityProof-beta_norm_preserves_proves"><span class="command">lemma</span></span> beta_norm_preserves_proves<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> term_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> beta<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_norm <span class="free">t</span> <span class="main">=</span> Some <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms proves_eq_mp_rule_better<span class="main">[</span><span class="operator">OF</span> thy _ _ finite ctxt<span class="main">]</span> proves_beta_norm<span class="main">[</span><span class="operator">OF</span> thy finite _ _ ctxt<span class="main">]</span>
    proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EqualityProof-proves_eta_step_pre"><span class="command">lemma</span></span> proves_eta_step_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> free<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">τ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">vs</span> <span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="free">t</span> <span class="main">∪</span> FV <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> term_ok'<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="free">vs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="free">vs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="free">vs</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> eta term_ok' free <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eta.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eta <span class="skolem">s</span> <span class="skolem">T</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> closeds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">.</span> is_closed <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eta.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> simp<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="main">(</span><span class="skolem">s</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> simp'<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> closed<span class="main">:</span> <span class="quoted"><span class="quoted">"is_closed <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eta<span class="main">(</span>2<span class="main">)</span> wt_term_def typ_of_imp_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> no_loose1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> loose_bvar <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_open_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 loose_bvar.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> loose_bvar.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> simp subst_bvs1'.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> not_dependent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_dependent <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_closed_subst_bvs1'_closeds
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closeds eta.hyps<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> decr_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bv <span class="skolem">x</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>decr <span class="main">0</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closeds eta.hyps subst_bvs_decr<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> is_dependent_def no_loose_bvar1_subst_bv2_decr not_dependent substn_subst_0' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI eta.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> is_dependent_def le_eq_less_or_eq
      loose_bvar_decr_unchanged loose_bvar_iff_exist_loose_bvar1 no_loose1 not_dependent simp' 
      term_ok_eta_red_step<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ok_ind<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_term <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="main">(</span><span class="skolem">s</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">T</span> <span class="main">→</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eta.prems<span class="main">(</span>1<span class="main">)</span> simp wt_term_def typ_of_Abs_body_typ'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> has_typ_iff_typ_of typ_of_def term_ok_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">T</span> <span class="main">→</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eta.eta eta_preserves_typ_of is_closed_decr_unchanged not_dependent
        ok simp simp' wt_term_def typ_of_imp_closed
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> has_typ_imp_closed term_ok_def<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> proves.eta<span class="main">[</span><span class="operator">OF</span> thy ok_ind<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span> ty decr_simp simp' 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closeds eta.hyps subst_bvs_decr typ_of_imp_closed<span class="main">)</span>  
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>appL <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_bvs_App term_ok_app_eqD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set <span class="skolem">vs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="skolem">s</span> <span class="main">∪</span> FV <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> appL <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>
            <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> appL.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span>
      <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proves_eq_reflexive<span class="main">[</span><span class="operator">OF</span> thy ok<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">,</span> <span class="operator">OF</span> finite ctxt<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of 
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ok wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"typ_of 
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">τ</span> <span class="main">→</span> <span class="skolem">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> τ appL.prems<span class="main">(</span>1<span class="main">)</span> not_None_eq subst_bvs_App wt_term_def typ_of1_arg_typ typ_of_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> has_typ_iff_typ_of typ_of_def term_ok_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> proves_eq_combination_rule_better thy finite ctxt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>appR <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_bvs_App term_ok_app_eqD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set <span class="skolem">vs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="skolem">s</span> <span class="main">∪</span> FV <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> appR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>
            <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> appR.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span>
      <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proves_eq_reflexive<span class="main">[</span><span class="operator">OF</span> thy ok<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">,</span> <span class="operator">OF</span> finite ctxt<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_of 
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ok wt_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"typ_of 
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">τ</span> <span class="main">→</span> <span class="skolem">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> τ appR.prems<span class="main">(</span>1<span class="main">)</span> not_None_eq subst_bvs_App wt_term_def typ_of1_arg_typ typ_of_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> term_okD2<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> proves_eq_combination_rule_better thy finite ctxt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set <span class="skolem">vs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">∉</span> fv <span class="skolem">s</span> <span class="main">∪</span> FV <span class="free">Γ</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> abs.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">.</span> is_closed <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">hence</span></span> simp<span class="main">:</span> <span class="quoted"><span class="quoted">"mk_eq <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> mk_eq <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">t</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> T_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">Θ</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> abs.prems term_ok_Types_typ_ok simp thy <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fv <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">t</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> FV <span class="free">Γ</span> <span class="main">∪</span> fv <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite finite_fv finite_FV <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> <span class="main">(</span>fv <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">t</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> FV <span class="free">Γ</span> <span class="main">∪</span> fv <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span> <span class="bound">t</span> <span class="bound">P</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">::</span>variable<span class="main">,</span> <span class="bound">t</span><span class="main">::</span>typ<span class="main">)</span> <span class="main">∉</span> <span class="bound">P</span> <span class="main">∨</span> <span class="bound">v</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="bound">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> fst_conv image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> 1 variant_variable_fresh finite_Un finite_imageI fst_conv image_eqI 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> <span class="main">(</span>fv <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">t</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> FV <span class="free">Γ</span> <span class="main">∪</span> fv <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> fv <span class="main">(</span>mk_eq <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">t</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> FV <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> fv <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> abs.prems<span class="main">(</span>1<span class="main">)</span> simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> combine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subst_bv <span class="main">(</span>Fv <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
              <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span><span class="main">#</span><span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_bvs_extend_lower_level 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> term.Fv <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">.</span> is_closed <span class="bound">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span><span class="main">#</span><span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>
        <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span><span class="main">#</span><span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> abs.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ok combine <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> term_ok_subst_bv<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> x abs.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq 
    <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">s</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>Abs <span class="skolem">T</span> <span class="main">(</span>subst_bvs1' <span class="skolem">t</span> <span class="main">1</span> <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_ascend_abs_rule'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> thy <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> T_ok <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> 1  <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> term.Fv <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">.</span> is_closed <span class="bound">v</span>›</span></span> subst_bvs_extend_lower_level
    finite ctxt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eta_step"><span class="command">lemma</span></span> proves_eta_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> term_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub></span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">t</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> unsimpt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> unsimpu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> unsimp<span class="main">:</span> <span class="quoted"><span class="quoted">"mk_eq <span class="free">t</span> <span class="free">u</span> <span class="main">=</span> mk_eq 
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">(</span>subst_bvs <span class="main">(</span>map <span class="main">(</span>case_prod Fv<span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> unsimp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eta_step_pre<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eta_steps"><span class="command">lemma</span></span> proves_eta_steps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> term_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>η</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">t</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> eta term_ok <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_refl <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite ctxt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> proves_eq_reflexive thy<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_into_rtrancl <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="skolem">b</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proves_eta_step rtrancl_into_rtrancl.hyps<span class="main">(</span>2<span class="main">)</span> eta_star_preserves_term_ok local.finite
      rtrancl_into_rtrancl.hyps<span class="main">(</span>1<span class="main">)</span> rtrancl_into_rtrancl.prems thy finite ctxt
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> proved_terms_well_formed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> proves_eq_transitive_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thy _ _ _ _ _ _ _ finite ctxt<span class="main"><span class="main">]</span></span>
        term_ok_mk_eqD term_ok_mk_eq_same_typ thy<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EqualityProof-proves_eta_norm"><span class="command">lemma</span></span> proves_eta_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> term_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eta<span class="main">:</span> <span class="quoted"><span class="quoted">"eta_norm <span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite ctxt
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_norm_imp_eta_reds local.eta local.finite proves_eta_steps term_ok thy <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> term_ok_def<span class="main">)</span>

<span class="keyword1" id="EqualityProof-eta_norm_preserves_proves"><span class="command">lemma</span></span> eta_norm_preserves_proves<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> term_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eta<span class="main">:</span> <span class="quoted"><span class="quoted">"eta_norm <span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms proves_eq_mp_rule_better<span class="main">[</span><span class="operator">OF</span> thy _ _ finite ctxt<span class="main">]</span>
    proves_eta_norm<span class="main">[</span><span class="operator">OF</span> thy finite _ _ ctxt<span class="main">]</span> proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EqualityProof-beta_eta_norm_preserves_proves"><span class="command">lemma</span></span> beta_eta_norm_preserves_proves<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> term_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> beta_eta<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_eta_norm <span class="free">t</span> <span class="main">=</span> Some <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> beta_eta beta_norm_preserves_proves<span class="main">[</span><span class="operator">OF</span> thy finite _ _ ctxt<span class="main">]</span>
    eta_norm_preserves_proves<span class="main">[</span><span class="operator">OF</span> thy finite _ _ ctxt<span class="main">]</span> finite term_ok thy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EqualityProof-forall_elim'"><span class="command">lemma</span></span> forall_elim'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"has_typ <span class="free">a</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_term <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> term_ok <span class="free">Θ</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">Γ</span><span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span> <span class="main">∙</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_Abs <span class="free">B</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> Abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> Abs <span class="skolem">T</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_Abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="free">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Abs all list.inject proved_terms_well_formed<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> typ.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> typ_of1.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
        typ_of_Abs_body_typ' typ_of_def typ_of_fun<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> True Abs all a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> forall_elim<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> τ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">τ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False

  <span class="keyword1"><span class="command">have</span></span> wf_B<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_term <span class="main">(</span>sig <span class="free">Θ</span><span class="main">)</span> <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> all proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_okD1 term_ok_app_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> B_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">B</span> <span class="main">:</span> <span class="free">τ</span> <span class="main">→</span> propT"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> all proved_terms_well_formed<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> typ_of1.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> typ_of_def 
        typ_of_fun typ_of_imp_has_typ<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∙</span> <span class="free">a</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> betapply.elims term.discI<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs <span class="free">τ</span> <span class="main">(</span><span class="free">B</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span> <span class="main">∙</span> <span class="free">a</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B_typ closed_subst_bv_no_change subst_bv_def typ_of_imp_closed 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_bv_def incr_boundvars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∙</span> <span class="free">a</span> <span class="main">=</span> subst_bv <span class="free">a</span> <span class="main">(</span><span class="free">B</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">B</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> proves.eta<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thy wf_B B_typ<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="free">B</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">B</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_symmetric_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thy _ _ _ 1 ctxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> wf_B  B_typ term_ok_def wt_term_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> 1 proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_mk_eqD <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> B_typ Logic.typ_of_eta_expand <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq <span class="main">(</span>Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_reflexive<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thy _ ctxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> all proved_terms_well_formed<span class="main">(</span>2<span class="main">)</span> term_ok_app_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> mk_eq 
    <span class="main">(</span>Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> <span class="free">B</span><span class="main">)</span>
    <span class="main">(</span>Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">B</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_combination_rule_better<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thy 3 2 _ _ ctxt<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> τ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> τ'<span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">propT</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> typ_of_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> B_typ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Θ</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Ct <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span> <span class="main">$</span> <span class="main">(</span>Abs <span class="free">τ</span> <span class="main">(</span><span class="free">B</span> <span class="main">$</span> Bv <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> proves_eq_mp_rule_better<span class="main"><span class="main">[</span></span><span class="operator">OF</span> thy 4 all ctxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> simp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves.forall_elim<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 5<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ProofTerm">
<div class="head">
<h1>Theory ProofTerm</h1>
</div>
<pre class="source">
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Proof Terms and proof checker"</span></span>

<span class="keyword1"><span class="command">theory</span></span> ProofTerm
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Term">Term</a> <a href="#Logic">Logic</a> <a href="#Term_Subst">Term_Subst</a> <a href="#SortConstants">SortConstants</a> <a href="#EqualityProof">EqualityProof</a>
<span class="keyword2"><span class="keyword">begin</span></span>            

<span class="comment1">(* Move *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> tyinst <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">×</span> typ"</span></span> 
<span class="keyword1"><span class="command">type_synonym</span></span> tinst <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>variable <span class="main">×</span> typ<span class="main">)</span> <span class="main">×</span> term"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> proofterm <span class="main">=</span> PAxm <span class="quoted"><span class="quoted">"term"</span></span> <span class="quoted"><span class="quoted">"tyinst list"</span></span> 
  <span class="main">|</span> PBound <span class="quoted">nat</span>
  <span class="main">|</span> Abst <span class="quoted"><span class="quoted">"typ"</span></span> <span class="quoted">proofterm</span> 
  <span class="main">|</span> AbsP <span class="quoted"><span class="quoted">"term"</span></span> <span class="quoted">proofterm</span>
  <span class="main">|</span> Appt <span class="quoted">proofterm</span> <span class="quoted"><span class="quoted">"term"</span></span> 
  <span class="main">|</span> AppP <span class="quoted">proofterm</span> <span class="quoted">proofterm</span>
  <span class="main">|</span> OfClass <span class="quoted"><span class="quoted">"typ"</span></span> <span class="quoted"><span class="quoted">"class"</span></span>
  <span class="main">|</span> Hyp <span class="quoted"><span class="quoted">"term"</span></span>

<span class="comment1">(* For debbuging, move to code gen or seperate theory? *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">depth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"proofterm <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>Abst <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>AbsP <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>Appt <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>AppP <span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>max <span class="main">(</span><span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">P1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"proofterm <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">size</span> <span class="main">(</span>Abst <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">size</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size</span> <span class="main">(</span>AbsP <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">size</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size</span> <span class="main">(</span>Appt <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">size</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size</span> <span class="main">(</span>AppP <span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">size</span> <span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="main">+</span> <span class="free">size</span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"depth <span class="free">P</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"size <span class="free">P</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"size <span class="free">P</span> <span class="main">≥</span> depth <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">partial_nth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">partial_nth</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">partial_nth</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">partial_nth</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">partial_nth</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">partial_nth'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>nth <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"partial_nth <span class="free">xs</span> <span class="free">n</span> <span class="main">≡</span> partial_nth' <span class="free">xs</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> partial_nth.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ProofTerm-partial_nth_Some_imp_elem"><span class="command">lemma</span></span> partial_nth_Some_imp_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"partial_nth <span class="free">l</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span>set <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> partial_nth.induct<span class="main">)</span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The core of the proof checker›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">replay'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"theory <span class="main">⇒</span> <span class="main">(</span>variable <span class="main">×</span> typ<span class="main">)</span> list <span class="main">⇒</span> variable set 
  <span class="main">⇒</span> term list <span class="main">⇒</span> proofterm <span class="main">⇒</span> term option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>PAxm <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">Tis</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> inst_ok <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">Tis</span></span></span> <span class="main">∧</span> term_ok <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∈</span> axioms <span class="free"><span class="bound"><span class="entity">thy</span></span></span>
      <span class="keyword1">then</span> Some <span class="main">(</span>forall_intro_vars <span class="main">(</span>subst_typ' <span class="free"><span class="bound"><span class="entity">Tis</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> 
    <span class="keyword1">else</span> None <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>PBound <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> partial_nth <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>Abst <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> typ_ok <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> 
    <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">ns'</span><span class="main">)</span> <span class="main">=</span> variant_variable <span class="main">(</span>Free <span class="keyword1">STR</span> <span class="inner_quoted">''default''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="keyword1">in</span> 
      map_option <span class="main">(</span>mk_all <span class="bound">s'</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">replay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="bound">ns'</span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>Appt <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rep</span> <span class="main">=</span> <span class="free">replay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">t'</span> <span class="main">=</span> subst_bvs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">.</span> Fv <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">case</span> <span class="main">(</span><span class="bound">rep</span><span class="main">,</span> typ_of <span class="bound">t'</span><span class="main">)</span> <span class="keyword1">of</span>
        <span class="main">(</span>Some <span class="main">(</span>Ct <span class="bound">s</span> <span class="main">(</span>Ty <span class="bound">fun1</span> <span class="main">[</span>Ty <span class="bound">fun2</span> <span class="main">[</span><span class="bound">τ</span><span class="main">,</span> Ty <span class="bound">propT1</span> Nil<span class="main">]</span><span class="main">,</span> Ty <span class="bound">propT2</span> Nil<span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="bound">b</span><span class="main">)</span><span class="main">,</span> Some <span class="bound">τ'</span><span class="main">)</span> <span class="main">⇒</span> 
          <span class="keyword1">if</span> <span class="bound">s</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">∧</span> <span class="bound">fun1</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> <span class="main">∧</span> <span class="bound">fun2</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> 
            <span class="main">∧</span> <span class="bound">propT1</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">∧</span> <span class="bound">propT2</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span>
             <span class="main">∧</span> <span class="bound">τ</span><span class="main">=</span><span class="bound">τ'</span> <span class="main">∧</span> term_ok <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="bound">t'</span>
            <span class="keyword1">then</span> Some <span class="main">(</span><span class="bound">b</span> <span class="main">∙</span> <span class="bound">t'</span><span class="main">)</span> <span class="keyword1">else</span> None
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>AbsP <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">t'</span> <span class="main">=</span> subst_bvs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">.</span> Fv <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">rep</span> <span class="main">=</span> <span class="free">replay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">(</span><span class="bound">t'</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Hs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="keyword1">if</span> typ_of <span class="bound">t'</span> <span class="main">=</span> Some propT <span class="main">∧</span> term_ok <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="bound">t'</span> <span class="keyword1">then</span> map_option <span class="main">(</span>mk_imp <span class="bound">t'</span><span class="main">)</span> <span class="bound">rep</span> <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>AppP <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rep1</span> <span class="main">=</span> Option.bind <span class="main">(</span><span class="free">replay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span> beta_eta_norm <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">rep2</span> <span class="main">=</span> Option.bind <span class="main">(</span><span class="free">replay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span> beta_eta_norm <span class="keyword1">in</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="bound">rep1</span><span class="main">,</span> <span class="bound">rep2</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>
        Some <span class="main">(</span>Ct <span class="bound">imp</span> <span class="main">(</span>Ty <span class="bound">fn1</span> <span class="main">[</span>Ty <span class="bound">prp1</span> <span class="main">[]</span><span class="main">,</span> Ty <span class="bound">fn2</span> <span class="main">[</span>Ty <span class="bound">prp2</span> <span class="main">[]</span><span class="main">,</span> Ty <span class="bound">prp3</span> <span class="main">[]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="bound">A</span> <span class="main">$</span> <span class="bound">B</span><span class="main">)</span><span class="main">,</span>
        Some <span class="bound">A'</span><span class="main">)</span> <span class="main">⇒</span> 
          <span class="keyword1">if</span> <span class="bound">imp</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.imp''</span> <span class="main">∧</span> <span class="bound">fn1</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> <span class="main">∧</span> <span class="bound">fn2</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span>
            <span class="main">∧</span> <span class="bound">prp1</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">∧</span> <span class="bound">prp2</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">∧</span> <span class="bound">prp3</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">∧</span> <span class="bound">A</span><span class="main">=</span><span class="bound">A'</span> 
          <span class="keyword1">then</span> Some <span class="bound">B</span> <span class="keyword1">else</span> None
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>OfClass <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="free"><span class="bound"><span class="entity">thy</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">}</span> 
    <span class="main">∧</span> typ_ok <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span>
    <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> const_type <span class="main">(</span>sig <span class="free"><span class="bound"><span class="entity">thy</span></span></span><span class="main">)</span> <span class="main">(</span>const_of_class <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="keyword1">of</span> 
      Some <span class="main">(</span>Ty <span class="bound">fun</span> <span class="main">[</span>Ty <span class="bound">it</span> <span class="main">[</span><span class="bound">ity</span><span class="main">]</span><span class="main">,</span> Ty <span class="bound">prop</span> <span class="main">[]</span><span class="main">]</span><span class="main">)</span> <span class="main">⇒</span> 
        <span class="keyword1">if</span> <span class="bound">ity</span> <span class="main">=</span> tvariable <span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span> <span class="main">∧</span> <span class="bound">fun</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> <span class="main">∧</span> <span class="bound">prop</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">∧</span> <span class="bound">it</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''itself''</span>
          <span class="keyword1">then</span> Some <span class="main">(</span>mk_of_class <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>Hyp <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="ProofTerm-fv_subst_bv1"><span class="command">lemma</span></span> fv_subst_bv1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fv <span class="main">(</span>subst_bv1 <span class="free">t</span> <span class="free">lev</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">t</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> loose_bvar1 <span class="free">t</span> <span class="free">lev</span> <span class="keyword1">then</span> fv <span class="free">u</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bv1.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incr_boundvars_def<span class="main">)</span>

<span class="comment1">(* Needs precondition, doable but diverges from previous checker*)</span>
<span class="keyword1"><span class="command">corollary</span></span> fv_subst_bvs_upper_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_closed <span class="free">t</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>subst_bvs <span class="free">us</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">t</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">us</span> <span class="main">.</span> <span class="main">(</span>fv <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_bvs_def
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_open_def no_loose_bvar_imp_no_subst_bvs1<span class="main">)</span>

<span class="keyword1" id="ProofTerm-fv_subst_bvs1_upper_bound"><span class="command">lemma</span></span> fv_subst_bvs1_upper_bound<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fv <span class="main">(</span>subst_bvs1 <span class="free">t</span> <span class="free">lev</span> <span class="free">us</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">t</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">us</span> <span class="main">.</span> <span class="main">(</span>fv <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">lev</span></span> <span class="quoted"><span class="free">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_bvs1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">lev</span> <span class="skolem">args</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">args</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">lev</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">args</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> SUP_upper le_supI1 le_supI2 length_Suc_conv nth_mem set_ConsD set_eq_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incr_boundvars_def<span class="main">)</span>

<span class="keyword1" id="ProofTerm-typ_of_axiom"><span class="command">lemma</span></span> typ_of_axiom<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">thy</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> axioms <span class="free">thy</span> <span class="main">⟹</span> typ_of <span class="free">t</span> <span class="main">=</span> Some propT"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">thy</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> theory_full_exhaust<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fv_Proof</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"proofterm <span class="main">⇒</span> <span class="main">(</span>variable <span class="main">×</span> typ<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fv_Proof</span> <span class="main">(</span>PAxm <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> fv <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv_Proof</span> <span class="main">(</span>PBound <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> empty"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv_Proof</span> <span class="main">(</span>Abst <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fv_Proof</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv_Proof</span> <span class="main">(</span>AbsP <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> fv <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∪</span> <span class="free">fv_Proof</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv_Proof</span> <span class="main">(</span>Appt <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fv_Proof</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> fv <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv_Proof</span> <span class="main">(</span>AppP <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fv_Proof</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">∪</span> <span class="free">fv_Proof</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv_Proof</span> <span class="main">(</span>OfClass <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> empty"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv_Proof</span> <span class="main">(</span>Hyp <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> fv <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="ProofTerm-typ_ok_Tv"><span class="command">lemma</span></span> typ_ok_Tv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">thy</span> <span class="main">(</span>Tv <span class="free">idn</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> wf_sort <span class="main">(</span>subclass <span class="main">(</span>osig <span class="main">(</span>sig <span class="free">thy</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="ProofTerm-typ_ok_contained_tvars_typ_ok"><span class="command">lemma</span></span> typ_ok_contained_tvars_typ_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">thy</span> <span class="free">ty</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">idn</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> tvsT <span class="free">ty</span> <span class="main">⟹</span> typ_ok <span class="free">thy</span> <span class="main">(</span>Tv <span class="free">idn</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ty</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> split_list typ_ok_Ty <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">all</span> ‹<span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits››</span><span class="main">)</span>

<span class="keyword1" id="ProofTerm-typ_ok_sig_contained_tvars_typ_ok_sig"><span class="command">lemma</span></span> typ_ok_sig_contained_tvars_typ_ok_sig<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="free">ty</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">idn</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> tvsT <span class="free">ty</span> <span class="main">⟹</span> typ_ok_sig <span class="free">Σ</span> <span class="main">(</span>Tv <span class="free">idn</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ty</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> split_list typ_ok_sig_Ty <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">all</span> ‹<span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits››</span><span class="main">)</span>

<span class="keyword1" id="ProofTerm-term_ok'_contained_tvars_typ_ok_sig"><span class="command">lemma</span></span> term_ok'_contained_tvars_typ_ok_sig<span class="main">:</span>
  <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">idn</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> tvs <span class="free">t</span> <span class="main">⟹</span> typ_ok_sig <span class="free">Σ</span> <span class="main">(</span>Tv <span class="free">idn</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ct <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="skolem">T</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> typ_ok_sig_contained_tvars_typ_ok_sig Ct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fv <span class="skolem">idn</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> typ_ok_sig_contained_tvars_typ_ok_sig Fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bv <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="skolem">T</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> typ_ok_sig_contained_tvars_typ_ok_sig Abs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="ProofTerm-term_ok_contained_tvars_typ_ok"><span class="command">lemma</span></span> term_ok_contained_tvars_typ_ok<span class="main">:</span>
  <span class="quoted"><span class="quoted">"term_ok <span class="free">thy</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">idn</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> tvs <span class="free">t</span> <span class="main">⟹</span> typ_ok <span class="free">thy</span> <span class="main">(</span>Tv <span class="free">idn</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wt_term_def typ_ok_def term_ok'_contained_tvars_typ_ok_sig term_ok_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="ProofTerm-typ_ok_subst_typ"><span class="command">lemma</span></span> typ_ok_subst_typ<span class="main">:</span>
  <span class="quoted"><span class="quoted">"typ_ok <span class="free">thy</span> <span class="free">T</span> <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">insts</span> <span class="main">.</span> typ_ok <span class="free">thy</span> <span class="bound">ty</span> <span class="main">⟹</span> typ_ok <span class="free">thy</span> <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_typ.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">insts</span> <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">thy</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>set <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> in_set_conv_decomp_first list_all_append list_all_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
      that typ_ok_Ty<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="free">thy</span> <span class="main">(</span>subst_typ <span class="skolem">insts</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>set <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">insts</span> <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ty</span></span> <span class="keyword2"><span class="keyword">where</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">insts</span> <span class="main">=</span> Some <span class="skolem">ty</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> True lookup_None_iff not_Some_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="skolem">insts</span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ty</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>2<span class="main">)</span> ty case_prodD lookup_present_eq_key' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="skolem">insts</span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> Tv <span class="skolem">idn</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> lookup_None_iff subst_typ.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> the_default.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ProofTerm-typ_ok_sig_subst_typ"><span class="command">lemma</span></span> typ_ok_sig_subst_typ<span class="main">:</span>
  <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="free">T</span> <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">insts</span> <span class="main">.</span> typ_ok_sig <span class="free">Σ</span> <span class="bound">ty</span> <span class="main">⟹</span> typ_ok_sig <span class="free">Σ</span> <span class="main">(</span>subst_typ <span class="free">insts</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">insts</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_typ.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">insts</span> <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>set <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> split_list that typ_ok_sig_Ty <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="main">(</span>subst_typ <span class="skolem">insts</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>set <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">insts</span> <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idn</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">insts</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ty</span></span> <span class="keyword2"><span class="keyword">where</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="main">(</span><span class="skolem">idn</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">insts</span> <span class="main">=</span> Some <span class="skolem">ty</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> True lookup_None_iff not_Some_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="skolem">insts</span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ty</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>2<span class="main">)</span> ty case_prodD lookup_present_eq_key' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subst_typ <span class="skolem">insts</span> <span class="main">(</span>Tv <span class="skolem">idn</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> Tv <span class="skolem">idn</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> lookup_None_iff subst_typ.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> the_default.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="ProofTerm-typ_ok_sig_imp_sortsT_ok_sig"><span class="command">lemma</span></span> typ_ok_sig_imp_sortsT_ok_sig<span class="main">:</span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="free">Σ</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">∈</span> SortsT <span class="free">T</span> <span class="main">⟹</span> wf_sort <span class="main">(</span>subclass <span class="main">(</span>osig <span class="free">Σ</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> split_list <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">all</span> ‹<span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> wf_sort_def <span class="quasi_keyword">split</span><span class="main">:</span> option.splits››</span><span class="main">)</span>

<span class="keyword1" id="ProofTerm-term_ok'_imp_Sorts_ok_sig"><span class="command">lemma</span></span> term_ok'_imp_Sorts_ok_sig<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok' <span class="free">Σ</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">∈</span> Sorts <span class="free">t</span> <span class="main">⟹</span> wf_sort <span class="main">(</span>subclass <span class="main">(</span>osig <span class="free">Σ</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> typ_ok_sig_imp_sortsT_ok_sig <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits)<span class="keyword3">+</span>›</span><span class="main">)</span>

<span class="keyword1" id="ProofTerm-replay'_sound_pre"><span class="command">lemma</span></span> replay'_sound_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> thy<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">thy</span>"</span></span>
  <span class="comment1">(* Assumptions *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> HS_invs<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">Hs</span> <span class="main">⟹</span> term_ok <span class="free">thy</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">Hs</span> <span class="main">⟹</span> typ_of <span class="bound">x</span> <span class="main">=</span> Some propT"</span></span>
  <span class="comment1">(* Names used *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ns_invs<span class="main">:</span>
    <span class="quoted"><span class="quoted">"finite <span class="free">ns</span>"</span></span>
    <span class="quoted"><span class="quoted">"fst <span class="main">`</span> FV <span class="main">(</span>set <span class="free">Hs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">ns</span>"</span></span>
    <span class="quoted"><span class="quoted">"fst <span class="main">`</span> fv_Proof <span class="free">P</span> <span class="main">⊆</span> <span class="free">ns</span>"</span></span>
  <span class="comment1">(* Fviables used *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vs_invs<span class="main">:</span>
    <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="free">vs</span> <span class="main">⊆</span> <span class="free">ns</span>"</span></span>
  <span class="comment1">(* Checked proof can be replay'ed using proves*)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"replay' <span class="free">thy</span> <span class="free">vs</span> <span class="free">ns</span> <span class="free">Hs</span> <span class="free">P</span> <span class="main">=</span> Some <span class="free">res</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy</span><span class="main">,</span> <span class="main">(</span>set <span class="free">Hs</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">res</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">thy</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">ns</span></span> <span class="quoted"><span class="free">Hs</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> replay'.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">thy</span> <span class="skolem">uu</span> <span class="skolem">uv</span> <span class="skolem">Hs</span> <span class="skolem">t</span> <span class="skolem">Tis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 
    ax<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∈</span>axioms <span class="skolem">thy</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> insts<span class="main">:</span> <span class="quoted"><span class="quoted">"inst_ok <span class="skolem">thy</span> <span class="skolem">Tis</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="skolem">thy</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"forall_intro_vars <span class="main">(</span>subst_typ' <span class="skolem">Tis</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="skolem">res</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">thy</span><span class="main">,</span> <span class="main">{}</span> <span class="main">⊢</span> <span class="skolem">res</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> res <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> proved_terms_well_formed_pre 
    <span class="keyword1"><span class="command">using</span></span> axiom forall_intro_vars inst_ok_imp_wf_inst tsubst_simulates_subst_typ' 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> empty_set<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> weaken_proves_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="skolem">Hs</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ 1<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">thy</span> <span class="skolem">ux</span> <span class="skolem">uy</span> <span class="skolem">Hs</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">∈</span> set <span class="skolem">Hs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> partial_nth_Some_imp_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> proves.assume 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">thy</span> <span class="skolem">vs</span> <span class="skolem">ns</span> <span class="skolem">Hs</span> <span class="skolem">T</span> <span class="skolem">p</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">ns'</span></span> <span class="keyword2"><span class="keyword">where</span></span> names<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">ns'</span><span class="main">)</span> <span class="main">=</span> variant_variable <span class="main">(</span>Free <span class="keyword1">STR</span> <span class="inner_quoted">''default''</span><span class="main">)</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this 3 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bres</span></span> <span class="keyword2"><span class="keyword">where</span></span> bres<span class="main">:</span> <span class="quoted"><span class="quoted">"replay' <span class="skolem">thy</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">ns'</span> <span class="skolem">Hs</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">bres</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns'</span> <span class="main">=</span> insert <span class="skolem">s'</span> <span class="skolem">ns</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> variant_variable_adds names
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∉</span> <span class="skolem">ns</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span> variant_variable_fresh names
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∉</span> fst <span class="main">`</span> FV <span class="main">(</span>set <span class="skolem">Hs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> free<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∉</span> FV <span class="main">(</span>set <span class="skolem">Hs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> typ_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_type <span class="main">(</span>sig <span class="skolem">thy</span><span class="main">)</span> <span class="skolem">T</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> names <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">thy</span><span class="main">,</span> set <span class="skolem">Hs</span> <span class="main">⊢</span> <span class="skolem">bres</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted">"3.IH"</span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ names<span class="main"><span class="main">]</span></span><span class="main">)</span>  
    <span class="keyword1"><span class="command">using</span></span> names <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main">:</span> if_splits›</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> names <span class="quoted">"3.prems"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ns'</span> <span class="main">=</span> insert <span class="skolem">s'</span> <span class="skolem">ns</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>7<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ns'</span> <span class="main">=</span> insert <span class="skolem">s'</span> <span class="skolem">ns</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>8<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ns'</span> <span class="main">=</span> insert <span class="skolem">s'</span> <span class="skolem">ns</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>7<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ns'</span> <span class="main">=</span> insert <span class="skolem">s'</span> <span class="skolem">ns</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>8<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ns'</span> <span class="main">=</span> insert <span class="skolem">s'</span> <span class="skolem">ns</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> bres <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> mk_all <span class="skolem">s'</span> <span class="skolem">T</span> <span class="skolem">bres</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> names bres 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> proves.forall_intro<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹wf_theory <span class="skolem">thy</span>›</span></span> I free typ_ok<span class="main">]</span> res <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">thy</span> <span class="skolem">vs</span> <span class="skolem">ns</span> <span class="skolem">Hs</span> <span class="skolem">p</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹replay' <span class="skolem">thy</span> <span class="skolem">vs</span> <span class="skolem">ns</span> <span class="skolem">Hs</span> <span class="main">(</span>Appt <span class="skolem">p</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">res</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rep</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">fun1</span></span> <span class="skolem"><span class="skolem">fun2</span></span> <span class="skolem"><span class="skolem">propT1</span></span> <span class="skolem"><span class="skolem">propT2</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="skolem"><span class="skolem">τ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    conds<span class="main">:</span> <span class="quoted"><span class="quoted">"replay' <span class="skolem">thy</span> <span class="skolem">vs</span> <span class="skolem">ns</span> <span class="skolem">Hs</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">rep</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> subst_bvs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">.</span> Fv <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"typ_of <span class="skolem">t'</span> <span class="main">=</span> Some <span class="skolem">τ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">τ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"term_ok <span class="skolem">thy</span> <span class="skolem">t'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">∧</span> <span class="skolem">fun1</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> <span class="main">∧</span> <span class="skolem">fun2</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> <span class="main">∧</span> <span class="skolem">propT1</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">∧</span> <span class="skolem">propT2</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">rep</span> <span class="main">=</span> Ct <span class="skolem">s</span> <span class="main">(</span>Ty <span class="skolem">fun1</span> <span class="main">[</span>Ty <span class="skolem">fun2</span> <span class="main">[</span><span class="skolem">τ</span><span class="main">,</span> Ty <span class="skolem">propT1</span> Nil<span class="main">]</span><span class="main">,</span> Ty <span class="skolem">propT2</span> Nil<span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">∙</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
    <span class="comment1">(* Takes forever, split up  *)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits typ.splits list.splits if_splits option.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

  
  <span class="keyword1"><span class="command">have</span></span> ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="skolem">Hs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">Hs</span> <span class="main">.</span> term_ok <span class="skolem">thy</span> <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">Hs</span> <span class="main">.</span> typ_of <span class="bound">A</span> <span class="main">=</span> Some propT"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> conds <span class="quoted">"4.prems"</span> ctxt 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> res wt_term_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> FV_def 
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> forall_elim'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted">"4.prems"</span><span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> _ _ _ ctxt<span class="main"><span class="main">]</span></span> <span class="quoted">"4.IH"</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">thy</span> <span class="skolem">vs</span> <span class="skolem">ns</span> <span class="skolem">Hs</span> <span class="skolem">t</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">rep</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    conds<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_bvs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">.</span> Fv <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
    <span class="quoted"><span class="quoted">"replay' <span class="skolem">thy</span> <span class="skolem">vs</span> <span class="skolem">ns</span> <span class="main">(</span><span class="skolem">t'</span><span class="main">#</span><span class="skolem">Hs</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">rep</span>"</span></span>
    <span class="quoted"><span class="quoted">"typ_of <span class="skolem">t'</span> <span class="main">=</span> Some propT"</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="skolem">thy</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> mk_imp <span class="skolem">t'</span> <span class="skolem">rep</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits typ.splits list.splits if_splits option.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span><span class="main">∈</span> set <span class="skolem">Hs</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">Hs</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">Hs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">Hs</span> <span class="main">=</span> insert <span class="skolem">t'</span> <span class="main">(</span>set <span class="skolem">Hs</span> <span class="main">-</span><span class="main">{</span><span class="skolem">t'</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">thy</span><span class="main">,</span>set <span class="main">(</span><span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">Hs</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">rep</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted">"5.IH"</span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> conds<span class="main">(</span>4<span class="main">)</span> <span class="quoted">"5.prems"</span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conds<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> conds<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> conds<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">thy</span><span class="main">,</span>set <span class="skolem">Hs</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">t'</span><span class="main">}</span> <span class="main">⊢</span> <span class="skolem">t'</span> <span class="main">⟼</span> <span class="skolem">rep</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> implies_intro <span class="quoted">"5.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"5.prems"</span><span class="main">(</span>4<span class="main">)</span> conds<span class="main">(</span>3<span class="main">)</span> conds<span class="main">(</span>4<span class="main">)</span> s
        <span class="keyword1"><span class="command">using</span></span> has_typ_iff_typ_of term_ok'_imp_wf_term term_okD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> res<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> s'<span class="main">)</span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> weaken_proves<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> conds<span class="main">(</span>3-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">Hs</span> <span class="main">=</span> insert <span class="skolem">t'</span> <span class="main">(</span>set <span class="skolem">Hs</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">t'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FV <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">.</span> Fv <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">vs</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> frees_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="skolem">t'</span> <span class="main">⊆</span> fv <span class="skolem">t</span> <span class="main">∪</span> set <span class="skolem">vs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fv_subst_bvs1_upper_bound subst_bvs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conds<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> 

    <span class="keyword1"><span class="command">have</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">thy</span><span class="main">,</span>set <span class="main">(</span><span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">Hs</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">rep</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted">"5.IH"</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5.prems"</span><span class="main">(</span>5-8<span class="main">)</span> conds<span class="main">(</span>3-4<span class="main">)</span> frees_bound 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"5.prems"</span><span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span> conds<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> conds<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> image_subset_iff <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> term_ok_def<span class="main">)</span>
      
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> res<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> s<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proves.implies_intro<span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> 5 conds <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹(<span class="operator">solves</span> ‹<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> wt_term_def›)<span class="keyword3">?</span>›</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">thy</span> <span class="skolem">vs</span> <span class="skolem">ns</span> <span class="skolem">Hs</span> <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹replay' <span class="skolem">thy</span> <span class="skolem">vs</span> <span class="skolem">ns</span> <span class="skolem">Hs</span> <span class="main">(</span>AppP <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">res</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fn1</span></span> <span class="skolem"><span class="skolem">fn2</span></span> <span class="skolem"><span class="skolem">prp1</span></span> <span class="skolem"><span class="skolem">prp2</span></span> <span class="skolem"><span class="skolem">prp3</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">imp</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> 
    conds<span class="main">:</span> <span class="quoted"><span class="quoted">"Option.bind <span class="main">(</span>replay' <span class="skolem">thy</span> <span class="skolem">vs</span> <span class="skolem">ns</span> <span class="skolem">Hs</span> <span class="skolem">p1</span><span class="main">)</span> beta_eta_norm
      <span class="main">=</span> Some <span class="main">(</span>Ct <span class="skolem">imp</span> <span class="main">(</span>Ty <span class="skolem">fn1</span> <span class="main">[</span>Ty <span class="skolem">prp1</span> <span class="main">[]</span><span class="main">,</span> Ty <span class="skolem">fn2</span> <span class="main">[</span>Ty <span class="skolem">prp2</span> <span class="main">[]</span><span class="main">,</span> Ty <span class="skolem">prp3</span> <span class="main">[]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">A</span> <span class="main">$</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"Option.bind <span class="main">(</span>replay' <span class="skolem">thy</span> <span class="skolem">vs</span> <span class="skolem">ns</span> <span class="skolem">Hs</span> <span class="skolem">p2</span><span class="main">)</span> beta_eta_norm <span class="main">=</span> Some <span class="skolem">A'</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">imp</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.imp''</span> <span class="main">∧</span> <span class="skolem">fn1</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> <span class="main">∧</span> <span class="skolem">fn2</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span>
      <span class="main">∧</span> <span class="skolem">prp1</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">∧</span> <span class="skolem">prp2</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">∧</span> <span class="skolem">prp3</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">∧</span> <span class="skolem">A</span><span class="main">=</span><span class="skolem">A'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits typ.splits list.splits if_splits option.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"Option.bind <span class="main">(</span>replay' <span class="skolem">thy</span> <span class="skolem">vs</span> <span class="skolem">ns</span> <span class="skolem">Hs</span> <span class="skolem">p1</span><span class="main">)</span> beta_eta_norm <span class="main">=</span> Some <span class="main">(</span><span class="skolem">C</span> <span class="main">⟼</span> <span class="skolem">res</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conds res <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">pre_C</span></span> <span class="keyword2"><span class="keyword">where</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"replay' <span class="skolem">thy</span> <span class="skolem">vs</span> <span class="skolem">ns</span> <span class="skolem">Hs</span> <span class="skolem">p1</span> <span class="main">=</span> Some <span class="skolem">pre</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> pre_C<span class="main">:</span> <span class="quoted"><span class="quoted">"replay' <span class="skolem">thy</span> <span class="skolem">vs</span> <span class="skolem">ns</span> <span class="skolem">Hs</span> <span class="skolem">p2</span> <span class="main">=</span> Some <span class="skolem">pre_C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bind_eq_Some_conv conds<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> pre C <span class="keyword1"><span class="command">have</span></span> norm_pre<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_eta_norm <span class="skolem">pre</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">C</span> <span class="main">⟼</span> <span class="skolem">res</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> pre_C pre C conds <span class="keyword1"><span class="command">have</span></span> norm_pre_C<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_eta_norm <span class="skolem">pre_C</span> <span class="main">=</span> Some <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">thy</span><span class="main">,</span> set <span class="skolem">Hs</span> <span class="main">⊢</span> <span class="skolem">pre_C</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted">"6.IH"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> <span class="quoted">"6.prems"</span> conds <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> pre pre_C›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">thy</span><span class="main">,</span> set <span class="skolem">Hs</span> <span class="main">⊢</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> beta_eta_norm_preserves_proves norm_pre_C <span class="quoted"><span class="quoted">‹wf_theory <span class="skolem">thy</span>›</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"6.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"6.prems"</span><span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">thy</span><span class="main">,</span> set <span class="skolem">Hs</span> <span class="main">⊢</span> <span class="skolem">pre</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted">"6.IH"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> <span class="quoted">"6.prems"</span> conds <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> pre pre_C›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> I2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">thy</span><span class="main">,</span> set <span class="skolem">Hs</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">⟼</span> <span class="skolem">res</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> beta_eta_norm_preserves_proves norm_pre <span class="quoted"><span class="quoted">‹wf_theory <span class="skolem">thy</span>›</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"6.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"6.prems"</span><span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> I1 I2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">thy</span><span class="main">,</span> set <span class="skolem">Hs</span> <span class="main">∪</span> set <span class="skolem">Hs</span> <span class="main">⊢</span> <span class="skolem">res</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> proves.implies_elim <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">thy</span> <span class="skolem">vs</span> <span class="skolem">ns</span> <span class="skolem">Hs</span> <span class="skolem">ty</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">fun</span></span>"</span> <span class="skolem"><span class="skolem">it</span></span> <span class="skolem"><span class="skolem">ity</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">prop</span></span>"</span>  <span class="keyword2"><span class="keyword">where</span></span> conds<span class="main">:</span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="skolem">thy</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ty</span> <span class="main">{</span><span class="skolem">c</span><span class="main">}</span>"</span></span> 
    <span class="quoted"><span class="quoted">"typ_ok <span class="skolem">thy</span> <span class="skolem">ty</span>"</span></span> <span class="quoted"><span class="quoted">"const_type <span class="main">(</span>sig <span class="skolem">thy</span><span class="main">)</span> <span class="main">(</span>const_of_class <span class="skolem">c</span><span class="main">)</span> 
      <span class="main">=</span> Some <span class="main">(</span>Ty <span class="skolem">fun</span> <span class="main">[</span>Ty <span class="skolem">it</span> <span class="main">[</span><span class="skolem">ity</span><span class="main">]</span><span class="main">,</span> Ty <span class="skolem">prop</span> <span class="main">[]</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ity</span> <span class="main">=</span> tvariable <span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="skolem">fun</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">prop</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">it</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''itself''</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="main">(</span>mk_of_class <span class="skolem">ty</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits typ.splits list.splits if_splits option.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> res <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> mk_of_class <span class="skolem">ty</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">thy</span><span class="main">,</span>set <span class="skolem">Hs</span> <span class="main">⊢</span> mk_of_class <span class="skolem">ty</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> proves.of_class<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">ty</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> <span class="quoted">"7.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> conds <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">thy</span> <span class="skolem">ux</span> <span class="skolem">uy</span> <span class="skolem">Hs</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">∈</span> set <span class="skolem">Hs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_None_eq option.inject replay'.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> proves.assume 8 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ProofTerm-finite_fv_Proof"><span class="command">lemma</span></span> finite_fv_Proof<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fv_Proof <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">replay''</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> Option.bind <span class="main">(</span>replay' <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> beta_eta_norm"</span></span>

<span class="keyword1" id="ProofTerm-replay''_sound"><span class="command">lemma</span></span> replay''_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">thy</span>"</span></span>
  <span class="comment1">(* Assumptions *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> HS_invs<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">Hs</span> <span class="main">⟹</span> term_ok <span class="free">thy</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">Hs</span> <span class="main">⟹</span> typ_of <span class="bound">x</span> <span class="main">=</span> Some propT"</span></span> 
  <span class="comment1">(* Names used *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ns_invs<span class="main">:</span>
    <span class="quoted"><span class="quoted">"finite <span class="free">ns</span>"</span></span>
    <span class="quoted"><span class="quoted">"fst <span class="main">`</span> FV <span class="main">(</span>set <span class="free">Hs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">ns</span>"</span></span>
    <span class="quoted"><span class="quoted">"fst <span class="main">`</span> fv_Proof <span class="free">P</span> <span class="main">⊆</span> <span class="free">ns</span>"</span></span>
  <span class="comment1">(* Fviables used *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vs_invs<span class="main">:</span>
    <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="free">vs</span> <span class="main">⊆</span> <span class="free">ns</span>"</span></span>
  <span class="comment1">(* Checked proof can be replayed using proves*)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"replay'' <span class="free">thy</span> <span class="free">vs</span> <span class="free">ns</span> <span class="free">Hs</span> <span class="free">P</span> <span class="main">=</span> Some <span class="free">res</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy</span><span class="main">,</span> <span class="main">(</span>set <span class="free">Hs</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">res</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">res'</span></span> <span class="keyword2"><span class="keyword">where</span></span> res'<span class="main">:</span> <span class="quoted"><span class="quoted">"replay' <span class="free">thy</span> <span class="free">vs</span> <span class="free">ns</span> <span class="free">Hs</span> <span class="free">P</span> <span class="main">=</span> Some <span class="skolem">res'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> replay'_sound_pre assms bind_eq_Some_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"beta_eta_norm <span class="skolem">res'</span> <span class="main">=</span> Some <span class="free">res</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> res' assms<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy</span><span class="main">,</span> set <span class="free">Hs</span> <span class="main">⊢</span> <span class="skolem">res'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> res' assms replay'_sound_pre  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> beta_eta_norm_preserves_proves assms<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">thy</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"replay'' <span class="free">thy</span> <span class="main">[]</span> <span class="main">(</span>fst <span class="main">`</span> fv_Proof <span class="free">P</span><span class="main">)</span> <span class="main">[]</span> <span class="free">P</span> <span class="main">=</span> Some <span class="free">res</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy</span><span class="main">,</span> set <span class="main">[]</span> <span class="main">⊢</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms finite_fv_Proof replay'_sound_pre replay''_sound<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> vs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> 
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ns<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="main">`</span> fv_Proof <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Hs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* With open hyps, run  *)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">hyps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"proofterm <span class="main">⇒</span> term list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hyps</span> <span class="main">(</span>Abst <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">hyps</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">hyps</span> <span class="main">(</span>AbsP <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">hyps</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">hyps</span> <span class="main">(</span>Appt <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">hyps</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">hyps</span> <span class="main">(</span>AppP <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span> <span class="main">=</span> List.union <span class="main">(</span><span class="free">hyps</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">hyps</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">hyps</span> <span class="main">(</span>Hyp <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">hyps</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1" id="ProofTerm-replay''_sound_pre_hyps"><span class="command">lemma</span></span> replay''_sound_pre_hyps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">thy</span>"</span></span>
  <span class="comment1">(* This can be checked independently before running replay'. Could also check during replay' in Hyp step... *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>hyps <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> term_ok <span class="free">thy</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>hyps <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> typ_of <span class="bound">x</span> <span class="main">=</span> Some propT"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"replay'' <span class="free">thy</span> <span class="main">[]</span> <span class="main">(</span>fst <span class="main">`</span> <span class="main">(</span>fv_Proof <span class="free">P</span> <span class="main">∪</span> FV <span class="main">(</span>set <span class="main">(</span>hyps <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>hyps <span class="free">P</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> Some <span class="free">res</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy</span><span class="main">,</span> set <span class="main">(</span>hyps <span class="free">P</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> replay''_sound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> vs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ns<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">`</span> <span class="main">(</span>fv_Proof <span class="free">P</span> <span class="main">∪</span> FV <span class="main">(</span>set <span class="main">(</span>hyps <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Hs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"hyps <span class="free">P</span>"</span></span><span class="main"><span class="main">]</span></span>
  <span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">use</span> assms finite_fv_Proof replay'_sound_pre <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">solves</span> <span class="operator">simp</span>›</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">replay</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>hyps <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">.</span> term_ok <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="bound">x</span> <span class="main">∧</span> typ_of <span class="bound">x</span> <span class="main">=</span> Some propT <span class="keyword1">then</span>
  replay'' <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="main">[]</span> <span class="main">(</span>fst <span class="main">`</span> <span class="main">(</span>fv_Proof <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> FV <span class="main">(</span>set <span class="main">(</span>hyps <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>hyps <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="ProofTerm-replay_sound_pre_hyps"><span class="command">lemma</span></span> replay_sound_pre_hyps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">thy</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"replay <span class="free">thy</span> <span class="free">P</span> <span class="main">=</span> Some <span class="free">res</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy</span><span class="main">,</span> set <span class="main">(</span>hyps <span class="free">P</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> replay''_sound_pre_hyps assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">check_proof</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="main">≡</span> wf_theory <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="main">∧</span> replay <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">res</span></span></span>"</span></span>

<span class="keyword1" id="ProofTerm-check_proof_sound"><span class="command">lemma</span></span> check_proof_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"check_proof <span class="free">thy</span> <span class="free">P</span> <span class="free">res</span> <span class="main">⟹</span> <span class="free">thy</span><span class="main">,</span> set <span class="main">(</span>hyps <span class="free">P</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> check_proof_def replay_sound_pre_hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="ProofTerm-check_proof_really_sound"><span class="command">lemma</span></span> check_proof_really_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"check_proof <span class="free">thy</span> <span class="free">P</span> <span class="free">res</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy</span><span class="main">,</span> set <span class="main">(</span>hyps <span class="free">P</span><span class="main">)</span> <span class="main">⊩</span> <span class="free">res</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="free">thy</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms check_proof_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">res</span> <span class="main">=</span> replay <span class="free">thy</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms check_proof_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>hyps <span class="free">P</span><span class="main">)</span> <span class="main">.</span> term_ok <span class="free">thy</span> <span class="bound">x</span> <span class="main">∧</span> typ_of <span class="bound">x</span> <span class="main">=</span> Some propT"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_None_eq replay_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms check_proof_sound has_typ_iff_typ_of proved_terms_well_formed<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> proves'_def 
        term_ok_def wt_term_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="SortsExe">
<div class="head">
<h1>Theory SortsExe</h1>
</div>
<pre class="source">
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Executable Sorts"</span></span>

<span class="keyword1"><span class="command">theory</span></span> SortsExe
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Sorts">Sorts</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> exeosig <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>class <span class="main">×</span> class<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span>name <span class="main">×</span> <span class="main">(</span>class <span class="main">×</span> sort list<span class="main">)</span> list<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">execlasses</span> <span class="main">≡</span> fst"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">exetcsigs</span> <span class="main">≡</span> snd"</span></span>

<span class="comment1">(* Eliminate fully? *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">alist_conds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>linorder <span class="main">×</span> <span class="tfree">'v</span><span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">alist_conds</span> <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="main">≡</span> distinct <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">al</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* This is not executable *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">exe_ars_conds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> <span class="main">(</span>class <span class="main">×</span> sort list<span class="main">)</span> list<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exe_ars_conds</span> <span class="free"><span class="bound"><span class="entity">arss</span></span></span> <span class="main">⟷</span> alist_conds <span class="free"><span class="bound"><span class="entity">arss</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">arss</span></span></span> <span class="main">.</span> alist_conds <span class="bound">ars</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exe_ars_conds'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'k1</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'k2</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">×</span> <span class="tfree">'s</span> list<span class="main">)</span> list<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exe_ars_conds'</span> <span class="free"><span class="bound"><span class="entity">arss</span></span></span> <span class="main">⟷</span> alist_conds <span class="free"><span class="bound"><span class="entity">arss</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">arss</span></span></span> <span class="main">.</span> alist_conds <span class="bound">ars</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span> <span class="main">⟷</span> exe_ars_conds' <span class="free">arss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_ars_conds_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">exe_class_conds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>class <span class="main">×</span> class<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exe_class_conds</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> distinct <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">exe_osig_conds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exeosig <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exe_osig_conds</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> exe_class_conds <span class="main">(</span>execlasses <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">∧</span> exe_ars_conds <span class="main">(</span>exetcsigs <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">translate_ars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> <span class="main">(</span>class <span class="main">×</span> sort list<span class="main">)</span> list<span class="main">)</span> list <span class="main">⇒</span> name <span class="main">⇀</span> <span class="main">(</span>class <span class="main">⇀</span> sort list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">translate_ars</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="main">=</span> map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">illformed_osig</span> <span class="main">≡</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> Map.empty<span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''A''</span> <span class="main">↦</span> Map.empty<span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''A''</span> <span class="main">↦</span> <span class="main">[</span><span class="main">{</span><span class="keyword1">STR</span> <span class="inner_quoted">''A''</span><span class="main">}</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SortsExe-illformed_osig_not_wf_osig"><span class="command">lemma</span></span> illformed_osig_not_wf_osig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wf_osig illformed_osig"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coregular_tcsigs_def complete_tcsigs_def consistent_length_tcsigs_def
      all_normalized_and_ex_tcsigs_def sort_ex_def wf_sort_def<span class="main">)</span>

<span class="comment1">(* I should probably do this with an option return type instead... *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">translate_osig</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exeosig <span class="main">⇒</span> osig"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">translate_osig</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">arss</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> exe_osig_conds <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">arss</span></span></span><span class="main">)</span> 
    <span class="keyword1">then</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> translate_ars <span class="free"><span class="bound"><span class="entity">arss</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> illformed_osig<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">exe_consistent_length_tcsigs</span> <span class="free"><span class="bound"><span class="entity">arss</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">arss</span></span></span> <span class="main">.</span>
  <span class="main">∀</span><span class="bound">ss<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="bound">ars</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ss<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="bound">ars</span><span class="main">.</span> length <span class="bound">ss<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="bound">ss<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SortsExe-in_alist_imp_in_map_of"><span class="command">lemma</span></span> in_alist_imp_in_map_of<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">arss</span><span class="main">)</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">ars</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">arss</span> <span class="main">⟹</span> translate_ars <span class="free">arss</span> <span class="free">name</span> <span class="main">=</span> Some <span class="main">(</span>map_of <span class="free">ars</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">arss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">name</span> <span class="main">.</span> map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free">arss</span><span class="main">)</span> <span class="bound">name</span> <span class="main">=</span> Some <span class="free">ars</span>
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">name</span> <span class="bound">arsl</span> <span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">arsl</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">arss</span> <span class="main">∧</span> map_of <span class="bound">arsl</span> <span class="main">=</span> <span class="free">ars</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_ars_conds_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">arsl</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">arss</span> <span class="main">∧</span> map_of <span class="free">arsl</span> <span class="main">=</span> <span class="free">ars</span>
  <span class="main">⟹</span> map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free">arss</span><span class="main">)</span> <span class="free">name</span> <span class="main">=</span> Some <span class="free">ars</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_ars_conds_def<span class="main">)</span>

<span class="keyword1" id="SortsExe-consistent_length_tcsigs_imp_exe_consistent_length_tcsigs"><span class="command">lemma</span></span> consistent_length_tcsigs_imp_exe_consistent_length_tcsigs<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span> <span class="main">⟹</span> consistent_length_tcsigs <span class="main">(</span>translate_ars <span class="free">arss</span><span class="main">)</span> 
  <span class="main">⟹</span> exe_consistent_length_tcsigs <span class="free">arss</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> consistent_length_tcsigs_def exe_consistent_length_tcsigs_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_ars_conds_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_alist_imp_in_map_of map_of_is_SomeI ranI snd_conv translate_ars.simps<span class="main">)</span>

<span class="keyword1" id="SortsExe-exe_consistent_length_tcsigs_imp_consistent_length_tcsigs"><span class="command">lemma</span></span> exe_consistent_length_tcsigs_imp_consistent_length_tcsigs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span>"</span></span> <span class="quoted"><span class="quoted">"exe_consistent_length_tcsigs <span class="free">arss</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent_length_tcsigs <span class="main">(</span>translate_ars <span class="free">arss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ars</span> <span class="skolem">ss<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ss<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ars</span> <span class="main">∈</span> ran <span class="main">(</span>map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free">arss</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> ran <span class="skolem">ars</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> ran <span class="skolem">ars</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> p<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">name</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free">arss</span><span class="main">)</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">ars</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_range_if_ex_key<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">arsl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">arsl</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">arss</span>"</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">arsl</span> <span class="main">=</span> <span class="skolem">ars</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_ars_conds_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ars</span> <span class="skolem">c1</span> <span class="main">=</span> Some <span class="skolem">ss<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ars</span> <span class="skolem">c2</span> <span class="main">=</span> Some <span class="skolem">ss<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_range_if_ex_key p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> p<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c1</span><span class="main">,</span> <span class="skolem">ss<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">arsl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c2</span><span class="main">,</span> <span class="skolem">ss<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">arsl</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">arsl</span> <span class="main">=</span> <span class="skolem">ars</span>›</span></span> map_of_SomeD<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="skolem">ss<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">arsl</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">arss</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_consistent_length_tcsigs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> consistent_length_tcsigs_def exe_consistent_length_tcsigs_def<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> 1 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SortsExe-consistent_length_tcsigs_iff_exe_consistent_length_tcsigs"><span class="command">lemma</span></span> consistent_length_tcsigs_iff_exe_consistent_length_tcsigs<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span> <span class="main">⟹</span> 
    consistent_length_tcsigs <span class="main">(</span>translate_ars <span class="free">arss</span><span class="main">)</span> <span class="main">⟷</span> exe_consistent_length_tcsigs <span class="free">arss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> consistent_length_tcsigs_imp_exe_consistent_length_tcsigs 
    exe_consistent_length_tcsigs_imp_consistent_length_tcsigs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* Do I even have to translate the relation? *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">exe_complete_tcsigs</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">arss</span></span></span>
 <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">arss</span></span></span> <span class="main">.</span> 
  <span class="main">∀</span><span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">.</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∈</span>fst <span class="main">`</span> set <span class="bound">ars</span> <span class="main">⟶</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∈</span>fst <span class="main">`</span> set <span class="bound">ars</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SortsExe-exe_complete_tcsigs_imp_complete_tcsigs"><span class="command">lemma</span></span> exe_complete_tcsigs_imp_complete_tcsigs<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span>"</span></span> <span class="quoted"><span class="quoted">"exe_complete_tcsigs <span class="free">cs</span> <span class="free">arss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"complete_tcsigs <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>translate_ars <span class="free">arss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ars</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">y</span> 
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ars</span> <span class="main">∈</span> ran <span class="main">(</span>map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free">arss</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ars</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span> 

    <span class="keyword1"><span class="command">from</span></span> p<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">name</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free">arss</span><span class="main">)</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">ars</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_range_if_ex_key<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">arsl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">arsl</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">arss</span>"</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">arsl</span> <span class="main">=</span> <span class="skolem">ars</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_ars_conds_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">arsl</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_SomeD p<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span><span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">ars</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">arsl</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">arss</span>›</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_complete_tcsigs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">arsl</span> <span class="main">=</span> <span class="skolem">ars</span>›</span></span> case_prodD domD domI dom_map_of_conv_image_fst
          p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> p<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complete_tcsigs_def exe_complete_tcsigs_def<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> 1 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SortsExe-complete_tcsigs_imp_exe_complete_tcsigs"><span class="command">lemma</span></span> complete_tcsigs_imp_exe_complete_tcsigs<span class="main">:</span> <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span> <span class="main">⟹</span> 
    complete_tcsigs <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>translate_ars <span class="free">arss</span><span class="main">)</span> <span class="main">⟹</span> exe_complete_tcsigs <span class="free">cs</span> <span class="free">arss</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> complete_tcsigs_def exe_complete_tcsigs_def exe_ars_conds_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_unfold dom_map_of_conv_image_fst in_alist_imp_in_map_of
      in_range_if_ex_key map_of_SomeD ran_distinct<span class="main">)</span>

<span class="keyword1" id="SortsExe-exe_complete_tcsigs_iff_complete_tcsigs"><span class="command">lemma</span></span> exe_complete_tcsigs_iff_complete_tcsigs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span> <span class="main">⟹</span> 
    complete_tcsigs <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>translate_ars <span class="free">arss</span><span class="main">)</span> <span class="main">⟷</span> exe_complete_tcsigs <span class="free">cs</span> <span class="free">arss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exe_complete_tcsigs_imp_complete_tcsigs complete_tcsigs_imp_exe_complete_tcsigs
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">exe_coregular_tcsigs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">::</span> <span class="main">(</span>class <span class="main">×</span> class<span class="main">)</span> list<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">arss</span></span></span>
  <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">arss</span></span></span> <span class="main">.</span>
  <span class="main">∀</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="bound">ars</span><span class="main">.</span> <span class="main">∀</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="bound">ars</span><span class="main">.</span>
    <span class="main">(</span>class_leq <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> 
      list_all2 <span class="main">(</span>sort_leq <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="bound">ars</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="bound">ars</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 


<span class="keyword1" id="SortsExe-exe_coregular_tcsigs_imp_coregular_tcsigs"><span class="command">lemma</span></span> exe_coregular_tcsigs_imp_coregular_tcsigs<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span>"</span></span> <span class="quoted"><span class="quoted">"exe_coregular_tcsigs <span class="free">cs</span> <span class="free">arss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coregular_tcsigs <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>translate_ars <span class="free">arss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ars</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ss1</span> <span class="skolem">ss2</span>
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ars</span> <span class="main">∈</span> ran <span class="main">(</span>map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free">arss</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ars</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="skolem">ss1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ars</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="skolem">ss2</span>"</span></span>
      <span class="quoted"><span class="quoted">"class_leq <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> p<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">name</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free">arss</span><span class="main">)</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">ars</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_range_if_ex_key<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">arsl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">arsl</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">arss</span>"</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">arsl</span> <span class="main">=</span> <span class="skolem">ars</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_ars_conds_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ars</span> <span class="skolem">c1</span> <span class="main">=</span> Some <span class="skolem">ss1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ars</span> <span class="skolem">c2</span> <span class="main">=</span> Some <span class="skolem">ss2</span>"</span></span> <span class="quoted"><span class="quoted">"class_leq <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="skolem">c1</span> <span class="skolem">c2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>2<span class="main">)</span> p<span class="main">(</span>3<span class="main">)</span> p<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c1</span><span class="main">,</span> <span class="skolem">ss1</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">arsl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c2</span><span class="main">,</span> <span class="skolem">ss2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">arsl</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">arsl</span> <span class="main">=</span> <span class="skolem">ars</span>›</span></span> map_of_SomeD<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="skolem">c1</span><span class="main">)</span> <span class="skolem">arsl</span> <span class="main">=</span> Some <span class="skolem">ss1</span>"</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="skolem">c2</span><span class="main">)</span> <span class="skolem">arsl</span> <span class="main">=</span> Some <span class="skolem">ss2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">arsl</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">arss</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> exe_ars_conds_def 
          image_eqI lookup_present_eq_key snd_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>sort_leq <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ss1</span> <span class="skolem">ss2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">arsl</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">arss</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">c1</span><span class="main">,</span> <span class="skolem">ss1</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">arsl</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">c2</span><span class="main">,</span> <span class="skolem">ss2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">arsl</span>›</span></span> 
        <span class="quoted"><span class="quoted">‹class_leq <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="skolem">c1</span> <span class="skolem">c2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_coregular_tcsigs_def<span class="main">)</span>  
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coregular_tcsigs_def exe_coregular_tcsigs_def<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> 1 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SortsExe-coregular_tcsigs_imp_exe_coregular_tcsigs"><span class="command">lemma</span></span> coregular_tcsigs_imp_exe_coregular_tcsigs<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span>"</span></span> <span class="quoted"><span class="quoted">"coregular_tcsigs <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>translate_ars <span class="free">arss</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exe_coregular_tcsigs <span class="free">cs</span> <span class="free">arss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span> <span class="skolem">ars</span> <span class="skolem">c1</span> <span class="skolem">ss1</span> <span class="skolem">c2</span> <span class="skolem">ss2</span> 
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">ars</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">arss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c1</span><span class="main">,</span> <span class="skolem">ss1</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ars</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c2</span><span class="main">,</span> <span class="skolem">ss2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ars</span>"</span></span> 
      <span class="quoted"><span class="quoted">"class_leq <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="skolem">c1</span> <span class="skolem">c2</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">c1</span><span class="main">)</span> <span class="skolem">ars</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">ss1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> lookup_present_eq_key p<span class="main">(</span>1<span class="main">)</span> p<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_ars_conds_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">c2</span><span class="main">)</span> <span class="skolem">ars</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">ss2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> lookup_present_eq_key p<span class="main">(</span>1<span class="main">)</span> p<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_ars_conds_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>sort_leq <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">c1</span><span class="main">)</span> <span class="skolem">ars</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">c2</span><span class="main">)</span> <span class="skolem">ars</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coregular_tcsigs_def s1 s2 exe_ars_conds_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff in_alist_imp_in_map_of map_of_is_SomeI option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.sel 
          p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> p<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> p<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> ranI snd_conv translate_ars.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coregular_tcsigs_def exe_coregular_tcsigs_def<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> 1 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SortsExe-coregular_tcsigs_iff_exe_coregular_tcsigs"><span class="command">lemma</span></span> coregular_tcsigs_iff_exe_coregular_tcsigs<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span> <span class="main">⟹</span> coregular_tcsigs <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>translate_ars <span class="free">arss</span><span class="main">)</span> <span class="main">⟷</span> exe_coregular_tcsigs <span class="free">cs</span> <span class="free">arss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> coregular_tcsigs_imp_exe_coregular_tcsigs exe_coregular_tcsigs_imp_coregular_tcsigs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"wf_subclass <span class="free">sub</span> <span class="main">⟹</span> Field <span class="free">sub</span> <span class="main">=</span> Domain <span class="free">sub</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">exefield</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">=</span> List.union <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span> <span class="main">(</span>map snd <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1" id="SortsExe-Field_set_code"><span class="command">lemma</span></span> Field_set_code<span class="main">:</span> <span class="quoted"><span class="quoted">"Field <span class="main">(</span>set <span class="free">rel</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>exefield <span class="free">rel</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rel</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="SortsExe-class_ex_rec"><span class="command">lemma</span></span> class_ex_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">r</span> <span class="main">⟹</span> class_ex <span class="main">(</span>insert <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">=</span><span class="free">c</span> <span class="main">∨</span> <span class="free">b</span><span class="main">=</span><span class="free">c</span> <span class="main">∨</span> class_ex <span class="free">r</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> class_ex_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">execlass_ex</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> List.member <span class="main">(</span>exefield <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="keyword1" id="SortsExe-execlass_ex_code"><span class="command">lemma</span></span> execlass_ex_code<span class="main">:</span> <span class="quoted"><span class="quoted">"class_ex <span class="main">(</span>set <span class="free">rel</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> execlass_ex <span class="free">rel</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Field_set_code class_ex_def execlass_ex_def in_set_member<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">exesort_ex</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">.</span> <span class="main">(</span>List.member <span class="main">(</span>exefield <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1" id="SortsExe-sort_ex_code"><span class="command">lemma</span></span> sort_ex_code<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_ex <span class="main">(</span>set <span class="free">rel</span><span class="main">)</span> <span class="free">S</span> <span class="main">=</span> exesort_ex <span class="free">rel</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> execlass_ex_code sort_ex_class_ex<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">execlass_les</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">=</span> <span class="main">(</span>List.member <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> List.member <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1" id="SortsExe-execlass_les_code"><span class="command">lemma</span></span> execlass_les_code<span class="main">:</span> <span class="quoted"><span class="quoted">"class_les <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="free">c1</span> <span class="free">c2</span> <span class="main">=</span> execlass_les <span class="free">cs</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> class_leq_def class_les_def member_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">exenormalize_sort</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">::</span>sort<span class="main">)</span>
  <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">c</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span> execlass_les <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="bound">c'</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">exenormalized_sort</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span>exenormalize_sort <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1" id="SortsExe-normalize_sort_code"><span class="command">lemma</span></span> normalize_sort_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"normalize_sort <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> exenormalize_sort <span class="free">cs</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_def List.member_def list_ex_iff class_leq_def class_les_def<span class="main">)</span>

<span class="keyword1" id="SortsExe-normalized_sort_code"><span class="command">lemma</span></span> normalized_sort_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"normalized_sort <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> exenormalized_sort <span class="free">cs</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exenormalized_sort_def normalize_sort_code <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">exewf_sort</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> exenormalized_sort <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> exesort_ex <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="keyword1" id="SortsExe-wf_sort_code"><span class="command">lemma</span></span> wf_sort_code<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_class_conds <span class="free">sub</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_sort <span class="main">(</span>set <span class="free">sub</span><span class="main">)</span> <span class="free">S</span> <span class="main">=</span> exewf_sort <span class="free">sub</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> normalized_sort_code sort_ex_code assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sort_ex_code wf_sort_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> exewf_sort_def<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exewf_sort <span class="free">sub</span> <span class="free">S</span> <span class="main">≡</span> <span class="main">(</span><span class="free">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> exenormalized_sort <span class="free">sub</span> <span class="free">S</span> <span class="main">∧</span> exesort_ex <span class="free">sub</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">smt</span> ball_empty bot_set_def empty_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">exe_all_normalized_and_ex_tcsigs</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">arss</span></span></span>
 <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">arss</span></span></span> <span class="main">.</span> <span class="main">∀</span><span class="bound">ss</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="bound">ars</span> <span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="bound">ss</span><span class="main">.</span> exewf_sort <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SortsExe-all_normalized_and_ex_tcsigs_imp_exe_all_normalized_and_ex_tcsigs"><span class="command">lemma</span></span> all_normalized_and_ex_tcsigs_imp_exe_all_normalized_and_ex_tcsigs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span>"</span></span> <span class="quoted"><span class="quoted">"all_normalized_and_ex_tcsigs <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>translate_ars <span class="free">arss</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exe_all_normalized_and_ex_tcsigs <span class="free">cs</span> <span class="free">arss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ac<span class="main">:</span> <span class="quoted"><span class="quoted">"alist_conds <span class="free">arss</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> exe_ars_conds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">ars</span>
    <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">ars</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">arss</span>"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">Ss</span>
    <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">Ss</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ars</span>"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span>
    <span class="keyword3"><span class="command">assume</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> set <span class="skolem">Ss</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">ars</span> <span class="main">∈</span> ran <span class="main">(</span>map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free">arss</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ac a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>  in_alist_imp_in_map_of ranI translate_ars.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ss</span> <span class="main">∈</span> ran <span class="main">(</span>map_of <span class="skolem">ars</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a1 a2 assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exe_ars_conds_def map_of_is_SomeI ranI ran_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_sort <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> a1 a2 a3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_normalized_and_ex_tcsigs_def <span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> normalize_sort_code wf_sort_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_normalized_and_ex_tcsigs_def exe_all_normalized_and_ex_tcsigs_def
      exe_ars_conds_def wf_sort_def wf_sort_code normalize_sort_def sort_ex_code<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="SortsExe-exe_all_normalized_and_ex_tcsigs_imp_all_normalized_and_ex_tcsigs"><span class="command">lemma</span></span> exe_all_normalized_and_ex_tcsigs_imp_all_normalized_and_ex_tcsigs<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span>"</span></span> <span class="quoted"><span class="quoted">"exe_all_normalized_and_ex_tcsigs <span class="free">cs</span> <span class="free">arss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"all_normalized_and_ex_tcsigs <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>translate_ars <span class="free">arss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ars</span> <span class="skolem">ss</span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ars</span> <span class="main">∈</span> ran <span class="main">(</span>map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free">arss</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">∈</span> ran <span class="skolem">ars</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> set <span class="skolem">ss</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> p<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">name</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free">arss</span><span class="main">)</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">ars</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_range_if_ex_key<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">arsl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">arsl</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">arss</span>"</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">arsl</span> <span class="main">=</span> <span class="skolem">ars</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_ars_conds_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ars</span> <span class="skolem">c</span> <span class="main">=</span> Some <span class="skolem">ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_range_if_ex_key p<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exewf_sort <span class="free">cs</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">arsl</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">arss</span>›</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">arsl</span> <span class="main">=</span> <span class="skolem">ars</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
          exe_all_normalized_and_ex_tcsigs_def exe_ars_conds_def image_iff p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> p<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ran_distinct snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wf_sort <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_sort_code sort_ex_code wf_sort_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_sort_def all_normalized_and_ex_tcsigs_def
        exe_all_normalized_and_ex_tcsigs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SortsExe-all_normalized_and_ex_tcsigs_iff_exe_all_normalized_and_ex_tcsigs"><span class="command">lemma</span></span> all_normalized_and_ex_tcsigs_iff_exe_all_normalized_and_ex_tcsigs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span> <span class="main">⟹</span> all_normalized_and_ex_tcsigs <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>translate_ars <span class="free">arss</span><span class="main">)</span> 
    <span class="main">⟷</span> exe_all_normalized_and_ex_tcsigs <span class="free">cs</span> <span class="free">arss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> all_normalized_and_ex_tcsigs_imp_exe_all_normalized_and_ex_tcsigs exe_all_normalized_and_ex_tcsigs_imp_all_normalized_and_ex_tcsigs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">exe_wf_tcsigs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">::</span> <span class="main">(</span>class <span class="main">×</span> class<span class="main">)</span> list<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">arss</span></span></span> <span class="main">≡</span> 
    exe_coregular_tcsigs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">arss</span></span></span> 
  <span class="main">∧</span> exe_complete_tcsigs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">arss</span></span></span>
  <span class="main">∧</span> exe_consistent_length_tcsigs <span class="free"><span class="bound"><span class="entity">arss</span></span></span>
  <span class="main">∧</span> exe_all_normalized_and_ex_tcsigs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">arss</span></span></span>"</span></span>

<span class="keyword1" id="SortsExe-wf_tcsigs_iff_exe_wf_tcsigs"><span class="command">lemma</span></span> wf_tcsigs_iff_exe_wf_tcsigs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"exe_ars_conds <span class="free">arss</span> <span class="main">⟹</span> wf_tcsigs <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>translate_ars <span class="free">arss</span><span class="main">)</span> <span class="main">⟷</span> exe_wf_tcsigs <span class="free">cs</span> <span class="free">arss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> all_normalized_and_ex_tcsigs_iff_exe_all_normalized_and_ex_tcsigs 
    consistent_length_tcsigs_imp_exe_consistent_length_tcsigs 
    coregular_tcsigs_iff_exe_coregular_tcsigs exe_complete_tcsigs_iff_complete_tcsigs 
    exe_consistent_length_tcsigs_imp_consistent_length_tcsigs exe_wf_tcsigs_def wf_tcsigs_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exe_antisym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exe_antisym</span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exe_antisym</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">exe_antisym</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="SortsExe-exe_antisym_imp_antisym"><span class="command">lemma</span></span> exe_antisym_imp_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"exe_antisym <span class="free">l</span> <span class="main">⟹</span> antisym <span class="main">(</span>set <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> antisym_def<span class="main">)</span>

<span class="keyword1" id="SortsExe-antisym_imp_exe_antisym"><span class="command">lemma</span></span> antisym_imp_exe_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"antisym <span class="main">(</span>set <span class="free">l</span><span class="main">)</span> <span class="main">⟹</span> exe_antisym <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> antisym_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> exe_antisym.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> surj_pair<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SortsExe-antisym_iff_exe_antisym"><span class="command">lemma</span></span> antisym_iff_exe_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"antisym <span class="main">(</span>set <span class="free">l</span><span class="main">)</span> <span class="main">=</span> exe_antisym <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> antisym_imp_exe_antisym exe_antisym_imp_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">exe_wf_subclass</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="main">(</span>trans <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">∧</span> exe_antisym <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">∧</span> Refl <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SortsExe-wf_classes_iff_exe_wf_classes"><span class="command">lemma</span></span> wf_classes_iff_exe_wf_classes<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_subclass <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="main">⟷</span> exe_wf_subclass <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> antisym_iff_exe_antisym exe_wf_subclass_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">exe_wf_osig</span> <span class="free"><span class="bound"><span class="entity">oss</span></span></span> <span class="main">≡</span> exe_wf_subclass <span class="main">(</span>execlasses <span class="free"><span class="bound"><span class="entity">oss</span></span></span><span class="main">)</span>
  <span class="main">∧</span> exe_wf_tcsigs <span class="main">(</span>execlasses <span class="free"><span class="bound"><span class="entity">oss</span></span></span><span class="main">)</span> <span class="main">(</span>exetcsigs <span class="free"><span class="bound"><span class="entity">oss</span></span></span><span class="main">)</span> <span class="main">∧</span> exe_osig_conds <span class="free"><span class="bound"><span class="entity">oss</span></span></span>"</span></span>

<span class="keyword1" id="SortsExe-exe_wf_osig_imp_wf_osig"><span class="command">lemma</span></span> exe_wf_osig_imp_wf_osig<span class="main">:</span> <span class="quoted"><span class="quoted">"exe_wf_osig <span class="free">oss</span> <span class="main">⟹</span> wf_osig <span class="main">(</span>translate_osig <span class="free">oss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exe_coregular_tcsigs_imp_coregular_tcsigs exe_complete_tcsigs_imp_complete_tcsigs
    exe_complete_tcsigs_imp_complete_tcsigs exe_all_normalized_and_ex_tcsigs_imp_all_normalized_and_ex_tcsigs
    exe_consistent_length_tcsigs_imp_consistent_length_tcsigs 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">oss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_wf_subclass_def exe_antisym_imp_antisym  exe_osig_conds_def<span class="main">)</span>

<span class="keyword1" id="SortsExe-classes_translate"><span class="command">lemma</span></span> classes_translate<span class="main">:</span> <span class="quoted"><span class="quoted">"exe_osig_conds <span class="free">oss</span> <span class="main">⟹</span> subclass <span class="main">(</span>translate_osig <span class="free">oss</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>execlasses <span class="free">oss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">oss</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="SortsExe-tcsigs_translate"><span class="command">lemma</span></span> tcsigs_translate<span class="main">:</span> <span class="quoted"><span class="quoted">"exe_osig_conds <span class="free">oss</span>
  <span class="main">⟹</span> tcsigs <span class="main">(</span>translate_osig <span class="free">oss</span><span class="main">)</span> <span class="main">=</span> translate_ars <span class="main">(</span>exetcsigs <span class="free">oss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">oss</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="SortsExe-wf_osig_translate_imp_exe_osig_conds"><span class="command">lemma</span></span> wf_osig_translate_imp_exe_osig_conds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_osig <span class="main">(</span>translate_osig <span class="free">oss</span><span class="main">)</span> <span class="main">⟹</span> exe_osig_conds <span class="free">oss</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> illformed_osig_not_wf_osig <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> translate_osig.elims<span class="main">)</span>

<span class="keyword1" id="SortsExe-wf_osig_imp_exe_wf_osig"><span class="command">lemma</span></span> wf_osig_imp_exe_wf_osig<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_osig <span class="main">(</span>translate_osig <span class="free">oss</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exe_wf_osig <span class="free">oss</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"translate_osig <span class="free">oss</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> classes_translate tcsigs_translate assms wf_osig_translate_imp_exe_osig_conds 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> exe_osig_conds_def exe_wf_osig_def subclass.simps tcsigs.simps
      wf_classes_iff_exe_wf_classes wf_osig.simps wf_tcsigs_iff_exe_wf_tcsigs<span class="main">)</span>

<span class="keyword1" id="SortsExe-wf_osig_iff_exe_wf_osig"><span class="command">lemma</span></span> wf_osig_iff_exe_wf_osig<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_osig <span class="main">(</span>translate_osig <span class="free">oss</span><span class="main">)</span> <span class="main">⟷</span> exe_wf_osig <span class="free">oss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exe_wf_osig_imp_wf_osig wf_osig_imp_exe_wf_osig <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Instances">
<div class="head">
<h1>Theory Instances</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Executable Instance Relations"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Instances
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Term">Term</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*
  Executable versions for the following definitions

  Do by computing such a ρ 

  First using partial functions, then with alists

  definition "tinstT T1 T2 ≡ ∃ρ. tsubstT T2 ρ = T1"
  definition "tinst t1 t2 ≡ ∃ρ. tsubst t2 ρ = t1"
  definition "inst t1 t2 ≡ ∃ρ. subst t2 ρ = t1" 
*)</span>
         
<span class="comment1">(* Straight forward code translation from ML code in distribution *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">raw_match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"typ <span class="main">⇒</span> typ <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">⇀</span> typ<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">⇀</span> typ<span class="main">)</span> option"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">raw_matches</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"typ list <span class="main">⇒</span> typ list <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">⇀</span> typ<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">⇀</span> typ<span class="main">)</span> option"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">raw_match</span> <span class="main">(</span>Tv <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">:=</span> Some <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">U</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">U</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">raw_match</span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">Us</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free">raw_matches</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Us</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">raw_match</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">raw_matches</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Us</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> Option.bind <span class="main">(</span><span class="free">raw_match</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">raw_matches</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Us</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">raw_matches</span> <span class="main">[]</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">subs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">raw_matches</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> None"</span></span>

<span class="comment1">(* Probably easier to use *)</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">raw_match'</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"typ <span class="main">⇒</span> typ <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">⇀</span> typ<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">⇀</span> typ<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">raw_match'</span> <span class="main">(</span>Tv <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">:=</span> Some <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">U</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">U</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">raw_match'</span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">Us</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">Us</span></span></span> 
      <span class="keyword1">then</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="bound">subs</span> <span class="main">.</span> Option.bind <span class="bound">subs</span> <span class="main">(</span><span class="free">raw_match'</span> <span class="bound">T</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Us</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">raw_match'</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">,</span> <span class="bound">subs</span><span class="main">)</span> <span class="main">.</span> size <span class="bound">T</span> <span class="main">+</span> size <span class="bound">U</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">Ts</span> <span class="skolem">b</span> <span class="skolem">Us</span> <span class="skolem">subs</span> <span class="skolem">x</span> <span class="skolem">xa</span> <span class="skolem">y</span> <span class="skolem">xb</span> <span class="skolem">aa</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this 2<span class="main">(</span>2-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quoted"><span class="skolem">Us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Instances-length_neq_imp_not_raw_matches"><span class="command">lemma</span></span> length_neq_imp_not_raw_matches<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">Ts</span> <span class="main">≠</span> length <span class="free">Us</span> <span class="main">⟹</span> raw_matches <span class="free">Ts</span> <span class="free">Us</span> <span class="free">subs</span> <span class="main">=</span> None"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ts</span></span> <span class="quoted"><span class="free">Us</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match_raw_matches.induct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">T</span> <span class="bound">U</span> <span class="bound">subs</span> <span class="main">.</span> True"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> Option.bind_cong<span class="main">)</span>

<span class="comment1">(* Making sure I did not mess up my version of the definition *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"raw_match <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match_raw_matches.induct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">Ts</span> <span class="bound">Us</span> <span class="bound">subs</span> <span class="main">.</span> raw_matches <span class="bound">Ts</span> <span class="bound">Us</span> <span class="bound">subs</span> 
        <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> length <span class="bound">Ts</span> <span class="main">=</span> length <span class="bound">Us</span> 
      <span class="keyword1">then</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="bound">subs</span> <span class="main">.</span> Option.bind <span class="bound">subs</span> <span class="main">(</span>raw_match' <span class="bound">T</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="bound">Ts</span> <span class="bound">Us</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">subs</span><span class="main">)</span>
      <span class="keyword1">else</span> None<span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="skolem">U</span> <span class="skolem">Us</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"raw_match <span class="skolem">T</span> <span class="skolem">U</span> <span class="skolem">subs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Us</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 4 None <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quoted"><span class="skolem">Us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 4 None length_neq_imp_not_raw_matches <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Instances-raw_match'_map_le"><span class="command">lemma</span></span> raw_match'_map_le<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> map_le <span class="free">subs</span> <span class="free">subs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match'.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">Ts</span> <span class="skolem">b</span> <span class="skolem">Us</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">Ts</span> <span class="skolem">Us</span><span class="main">)</span> <span class="main">⟹</span> raw_match' <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">subs'</span> <span class="main">⟹</span> <span class="skolem">subs</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">subs'</span>"</span></span> 
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">subs</span> <span class="skolem">subs'</span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2.IH"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quoted"><span class="skolem">Us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">subs</span></span> <span class="quoted"><span class="skolem">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> map_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_le_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="comment1">(* Specializing for raw_match' *)</span>
<span class="keyword1" id="Instances-fold_matches_first_step_not_None"><span class="command">lemma</span></span> fold_matches_first_step_not_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="bound">subs</span> <span class="main">.</span> Option.bind <span class="bound">subs</span> <span class="main">(</span>raw_match' <span class="bound">T</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">subs</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">point</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"raw_match' <span class="free">x</span> <span class="free">y</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">point</span>"</span></span>
    <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="bound">subs</span> <span class="main">.</span> Option.bind <span class="bound">subs</span> <span class="main">(</span>raw_match' <span class="bound">T</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">point</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fold_matches_first_step_not_None assms <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1" id="Instances-fold_matches_last_step_not_None"><span class="command">lemma</span></span> fold_matches_last_step_not_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="bound">subs</span> <span class="main">.</span> Option.bind <span class="bound">subs</span> <span class="main">(</span>raw_match' <span class="bound">T</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">subs</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">point</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="bound">subs</span> <span class="main">.</span> Option.bind <span class="bound">subs</span> <span class="main">(</span>raw_match' <span class="bound">T</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">subs</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">point</span>"</span></span>
    <span class="quoted"><span class="quoted">"raw_match' <span class="free">x</span> <span class="free">y</span> <span class="free">point</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fold_matches_last_step_not_None assms <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">corollary</span></span> raw_match'_Type_conds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="main">(</span>Ty <span class="free">a</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">(</span>Ty <span class="free">b</span> <span class="free">Us</span><span class="main">)</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">=</span><span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Ts</span> <span class="main">=</span> length <span class="free">Us</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> fold_matches_first_step_not_None'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="bound">subs</span> <span class="main">.</span> Option.bind <span class="bound">subs</span> <span class="main">(</span>raw_match' <span class="bound">T</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">subs</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">x</span> <span class="free">y</span> <span class="free">subs</span> <span class="main">~=</span> None"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fold_matches_first_step_not_None 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.discI<span class="main">)</span> 

<span class="keyword1"><span class="command">corollary</span></span> raw_match'_hd_raw_match'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="main">(</span>Ty <span class="free">a</span> <span class="main">(</span><span class="free">T</span><span class="main">#</span><span class="free">Ts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Ty <span class="free">b</span> <span class="main">(</span><span class="free">U</span><span class="main">#</span><span class="free">Us</span><span class="main">)</span><span class="main">)</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">~=</span> None"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fold_matches_first_step_not_None' raw_match'_Type_conds
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> length_Cons nat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> raw_match'.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> raw_match'_eq_Some_at_point_not_None'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Ts</span> <span class="main">=</span> length <span class="free">Us</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="main">(</span>Ty <span class="free">a</span> <span class="main">(</span><span class="free">Ts</span><span class="main">@</span><span class="free">Ts'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Ty <span class="free">b</span> <span class="main">(</span><span class="free">Us</span><span class="main">@</span><span class="free">Us'</span><span class="main">)</span><span class="main">)</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="main">(</span>Ty <span class="free">a</span> <span class="main">(</span><span class="free">Ts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Ty <span class="free">b</span> <span class="main">(</span><span class="free">Us</span><span class="main">)</span><span class="main">)</span> <span class="free">subs</span> <span class="main">~=</span> None"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fold_Option_bind_eq_Some_at_point_not_None' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="comment1">(* I should have defined a custom induction rule here, instead I copied the structure of the proof 
  each time... Clean up when time
*)</span>

<span class="keyword1" id="Instances-raw_match'_tvsT_subset_dom_res"><span class="command">lemma</span></span> raw_match'_tvsT_subset_dom_res<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> tvsT <span class="free">T</span> <span class="main">⊆</span> dom <span class="free">subs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match'.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">Ts</span> <span class="skolem">b</span> <span class="skolem">Us</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.discI raw_match'.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword1"><span class="command">from</span></span> this 2 <span class="keyword1"><span class="command">have</span></span> better_IH<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">Ts</span> <span class="skolem">Us</span><span class="main">)</span> <span class="main">⟹</span> raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">subs'</span> <span class="main">⟹</span> tvsT <span class="skolem">x</span> <span class="main">⊆</span> dom <span class="skolem">subs'</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="skolem">subs'</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> l <span class="quoted">"2.prems"</span> better_IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quoted"><span class="skolem">Us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">subs</span></span> <span class="quoted"><span class="skolem">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">point</span></span> <span class="keyword2"><span class="keyword">where</span></span> point<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">point</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> rest<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">b</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">point</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.hyps Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fold_matches_first_step_not_None 
          raw_match'.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> raw_match'_Type_conds<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>  

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tvsT <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⊆</span> dom <span class="skolem">subs'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">point</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems rest <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zip_Cons_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tvsT <span class="skolem">x</span> <span class="main">⊆</span> dom <span class="skolem">point</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> point zip_Cons_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">point</span> <span class="main">⊆</span> dom <span class="skolem">subs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> map_le_implies_dom_le raw_match'_map_le rest <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span> 

<span class="keyword1" id="Instances-raw_match'_dom_res_subset_tvsT"><span class="command">lemma</span></span> raw_match'_dom_res_subset_tvsT<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> dom <span class="free">subs'</span> <span class="main">⊆</span> tvsT <span class="free">T</span> <span class="main">∪</span> dom <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match'.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">Ts</span> <span class="skolem">b</span> <span class="skolem">Us</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.discI raw_match'.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword1"><span class="command">from</span></span> this 2 <span class="keyword1"><span class="command">have</span></span> better_IH<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">Ts</span> <span class="skolem">Us</span><span class="main">)</span> <span class="main">⟹</span> raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">subs'</span> 
      <span class="main">⟹</span> dom <span class="skolem">subs'</span> <span class="main">⊆</span> tvsT <span class="skolem">x</span> <span class="main">∪</span> dom <span class="skolem">subs</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="skolem">subs'</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> l <span class="quoted">"2.prems"</span> better_IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quoted"><span class="skolem">Us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">subs</span></span> <span class="quoted"><span class="skolem">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">point</span></span> <span class="keyword2"><span class="keyword">where</span></span> first<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">point</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> rest<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">b</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">point</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.hyps Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fold_matches_first_step_not_None raw_match'.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> raw_match'_Type_conds<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> first <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">point</span> <span class="main">⊆</span> tvsT <span class="skolem">x</span> <span class="main">∪</span> dom <span class="skolem">subs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">subs'</span> <span class="main">⊆</span> tvsT <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∪</span> dom <span class="skolem">point</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> rest <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zip_Cons_Cons<span class="main">)</span>
    
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems in_mono
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv domIff<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> UN_iff Un_iff domIff in_mono option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="comment1">(*by fastforce, but too slow, check later *)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span> 

<span class="keyword1"><span class="command">corollary</span></span> raw_match'_dom_res_eq_tvsT<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> dom <span class="free">subs'</span> <span class="main">=</span> tvsT <span class="free">T</span> <span class="main">∪</span> dom <span class="free">subs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_le_implies_dom_le raw_match'_tvsT_subset_dom_res 
      raw_match'_dom_res_subset_tvsT raw_match'_map_le subset_antisym<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> raw_match'_dom_res_eq_tvsT_empty<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> None<span class="main">)</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> dom <span class="free">subs'</span> <span class="main">=</span> tvsT <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> raw_match'_dom_res_eq_tvsT <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Instances-raw_match'_map_defined"><span class="command">lemma</span></span> raw_match'_map_defined<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> <span class="free">p</span><span class="main">∈</span>tvsT <span class="free">T</span> <span class="main">⟹</span> <span class="free">subs'</span> <span class="free">p</span> <span class="main">~=</span> None"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> raw_match'_dom_res_eq_tvsT <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Instances-raw_match'_extend_map_preserve"><span class="command">lemma</span></span> raw_match'_extend_map_preserve<span class="main">:</span>
  <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> map_le <span class="free">subs'</span> <span class="free">subs''</span> <span class="main">⟹</span> <span class="free">p</span><span class="main">∈</span>tvsT <span class="free">T</span> <span class="main">⟹</span> <span class="free">subs''</span> <span class="free">p</span> <span class="main">=</span> <span class="free">subs'</span> <span class="free">p</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> raw_match'_dom_res_eq_tvsT domIff map_le_implies_dom_le 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_le_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">convert_subs</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span> <span class="bound">S</span> <span class="main">.</span> the_default <span class="main">(</span>Tv <span class="bound">v</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Instances-map_eq_on_tvsT_imp_map_eq_on_typ"><span class="command">lemma</span></span> map_eq_on_tvsT_imp_map_eq_on_typ<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span><span class="main">∈</span>tvsT <span class="free">T</span> <span class="main">⟹</span> <span class="free">subs</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">subs'</span> <span class="bound">p</span><span class="main">)</span> 
  <span class="main">⟹</span> tsubstT <span class="free">T</span> <span class="main">(</span>convert_subs <span class="free">subs</span><span class="main">)</span>
    <span class="main">=</span> tsubstT <span class="free">T</span> <span class="main">(</span>convert_subs <span class="free">subs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Instances-raw_match'_extend_map_preserve'"><span class="command">lemma</span></span> raw_match'_extend_map_preserve'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span> <span class="quoted"><span class="quoted">"map_le <span class="free">subs'</span> <span class="free">subs''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tsubstT <span class="free">T</span> <span class="main">(</span>convert_subs <span class="free">subs'</span><span class="main">)</span>
    <span class="main">=</span> tsubstT <span class="free">T</span> <span class="main">(</span>convert_subs <span class="free">subs''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> map_eq_on_tvsT_imp_map_eq_on_typ<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> raw_match'_extend_map_preserve assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Instances-raw_match'_produces_matcher"><span class="command">lemma</span></span> raw_match'_produces_matcher<span class="main">:</span>
  <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> 
    <span class="main">⟹</span> tsubstT <span class="free">T</span> <span class="main">(</span>convert_subs <span class="free">subs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match'.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">Ts</span> <span class="skolem">b</span> <span class="skolem">Us</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this 2 <span class="keyword1"><span class="command">have</span></span> better_IH<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">Ts</span> <span class="skolem">Us</span><span class="main">)</span> <span class="main">⟹</span> raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">subs'</span> 
    <span class="main">⟹</span> tsubstT <span class="skolem">x</span> <span class="main">(</span>convert_subs <span class="skolem">subs'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="skolem">subs'</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> l better_IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quoted"><span class="skolem">Us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">subs</span></span> <span class="quoted"><span class="skolem">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">point</span></span> <span class="keyword2"><span class="keyword">where</span></span> first<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">point</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> rest<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">b</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">point</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.hyps Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> fold_matches_first_step_not_None l<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_Cons raw_match'.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tsubstT <span class="skolem">x</span> <span class="main">(</span>convert_subs <span class="skolem">point</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> first <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_le <span class="skolem">point</span> <span class="skolem">subs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> raw_match'_map_le rest <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> subs'_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"tsubstT <span class="skolem">x</span> <span class="main">(</span>convert_subs <span class="skolem">subs'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> raw_match'_extend_map_preserve' first <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv subs'_hd first<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span> 

<span class="keyword1" id="Instances-tsubstT_matcher_imp_raw_match'_unchanged"><span class="command">lemma</span></span> tsubstT_matcher_imp_raw_match'_unchanged<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tsubstT <span class="free">T</span> <span class="free">ρ</span> <span class="main">=</span> <span class="free">U</span> <span class="main">⟹</span> raw_match' <span class="free">T</span> <span class="free">U</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> Some <span class="main">(</span><span class="free">ρ</span> <span class="bound">idx</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> Some <span class="main">(</span><span class="free">ρ</span> <span class="bound">idx</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">U</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Instances-raw_match'_imp_raw_match'_on_map_le"><span class="command">lemma</span></span> raw_match'_imp_raw_match'_on_map_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_le <span class="free">lesubs</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">lesubs'</span><span class="main">.</span> raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">lesubs</span> <span class="main">=</span> Some <span class="bound">lesubs'</span> <span class="main">∧</span> map_le <span class="bound">lesubs'</span> <span class="free">subs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lesubs</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match'.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">v</span> <span class="skolem">S</span> <span class="skolem">T</span> <span class="skolem">subs</span> <span class="skolem">lesubs</span> <span class="skolem">subs'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv map_le_def
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> domI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">Ts</span> <span class="skolem">b</span> <span class="skolem">Us</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this 2 <span class="keyword1"><span class="command">have</span></span> better_IH<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">Ts</span> <span class="skolem">Us</span><span class="main">)</span> <span class="main">⟹</span> raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">subs'</span> 
    <span class="main">⟹</span> <span class="skolem">lesubs</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">subs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">lesubs'</span><span class="main">.</span> raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">lesubs</span> <span class="main">=</span> Some <span class="bound">lesubs'</span> <span class="main">∧</span> <span class="bound">lesubs'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">subs'</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="skolem">lesubs</span> <span class="skolem">subs'</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> l better_IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quoted"><span class="skolem">Us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">subs</span></span> <span class="quoted"><span class="skolem">lesubs</span></span> <span class="quoted"><span class="skolem">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">point</span></span> <span class="keyword2"><span class="keyword">where</span></span> first<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">point</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> rest<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">b</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">point</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.hyps Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> fold_matches_first_step_not_None l<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_Cons raw_match'.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">lepoint</span><span class="main">.</span> raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">lesubs</span> <span class="main">=</span> Some <span class="bound">lepoint</span> <span class="main">∧</span> <span class="bound">lepoint</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">point</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons first <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lepoint</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        comp_lepoint<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">lesubs</span> <span class="main">=</span> Some <span class="skolem">lepoint</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le_lepoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lepoint</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">point</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">lesubs'</span><span class="main">.</span> raw_match' <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">b</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">lepoint</span> <span class="main">=</span> Some <span class="bound">lesubs'</span> <span class="main">∧</span> <span class="bound">lesubs'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">subs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons rest le_lepoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lesubs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        comp_lesubs'<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">b</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">lepoint</span> <span class="main">=</span> Some <span class="skolem">lesubs'</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> le_lesubs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lesubs'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">subs'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems Cons.hyps comp_lepoint comp_lesubs' le_lesubs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span> 

<span class="keyword1" id="Instances-map_le_same_dom_imp_same_map"><span class="command">lemma</span></span> map_le_same_dom_imp_same_map<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">g</span> <span class="main">⟹</span> map_le <span class="free">f</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_le_antisym map_le_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> map_le_produces_same_raw_match'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">subs</span> <span class="main">⊆</span> tvsT <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_le <span class="free">lesubs</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">lesubs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">subs'</span> <span class="main">=</span> tvsT <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> raw_match'_dom_res_eq_tvsT <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lesubs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">lesubs</span> <span class="main">=</span> Some <span class="skolem">lesubs'</span>"</span></span> <span class="quoted"><span class="quoted">"map_le <span class="skolem">lesubs'</span> <span class="free">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> raw_match'_imp_raw_match'_on_map_le assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">lesubs'</span> <span class="main">=</span> tvsT <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dom <span class="free">subs'</span> <span class="main">=</span> tvsT <span class="free">T</span>›</span></span> map_le_implies_dom_le raw_match'_tvsT_subset_dom_res <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> map_le_same_dom_imp_same_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> dom <span class="free">subs</span> <span class="main">⊆</span> tvsT <span class="free">T</span> <span class="main">⟹</span>
  raw_match' <span class="free">T</span> <span class="free">U</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="main">.</span> None<span class="main">)</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> map_le_empty map_le_produces_same_raw_match' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Instances-raw_match'_restriction"><span class="command">lemma</span></span> raw_match'_restriction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">" tvsT <span class="free">T</span> <span class="main">⊆</span> <span class="free">restriction</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="main">(</span><span class="free">subs</span><span class="main">|`</span><span class="free">restriction</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">subs'</span><span class="main">|`</span><span class="free">restriction</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">restriction</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match'.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">v</span> <span class="skolem">S</span> <span class="skolem">T</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fun_upd_restrict_conv option.case_eq_if option.discI option.sel restrict_fun_upd<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">Ts</span> <span class="skolem">b</span> <span class="skolem">Us</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this 2 <span class="keyword1"><span class="command">have</span></span> better_IH<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">Ts</span> <span class="skolem">Us</span><span class="main">)</span> <span class="main">⟹</span> raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">subs'</span> <span class="main">⟹</span> tvsT <span class="skolem">x</span> <span class="main">⊆</span> <span class="skolem">restriction</span>
    <span class="main">⟹</span> raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span><span class="skolem">subs</span> <span class="main">|`</span> <span class="skolem">restriction</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">subs'</span> <span class="main">|`</span> <span class="skolem">restriction</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="skolem">restriction</span> <span class="skolem">subs'</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> l better_IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quoted"><span class="skolem">Us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">subs</span></span> <span class="quoted"><span class="skolem">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">point</span></span> <span class="keyword2"><span class="keyword">where</span></span> first<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">point</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> rest<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">b</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">point</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.hyps Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> fold_matches_first_step_not_None l<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
          length_Cons raw_match'.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span><span class="skolem">subs</span> <span class="main">|`</span> <span class="skolem">restriction</span><span class="main">)</span> 
      <span class="main">=</span> Some <span class="main">(</span><span class="skolem">point</span> <span class="main">|`</span> <span class="skolem">restriction</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons first <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">b</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">point</span> <span class="main">|`</span> <span class="skolem">restriction</span><span class="main">)</span> 
      <span class="main">=</span> Some <span class="main">(</span><span class="skolem">subs'</span> <span class="main">|`</span> <span class="skolem">restriction</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons rest <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>        
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>


<span class="keyword1"><span class="command">corollary</span></span> raw_match'_restriction_on_tvsT<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="main">(</span><span class="free">subs</span><span class="main">|`</span>tvsT <span class="free">T</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">subs'</span><span class="main">|`</span>tvsT <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> raw_match'_restriction assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Instances-tinstT_imp_ex_raw_match'"><span class="command">lemma</span></span> tinstT_imp_ex_raw_match'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tinstT <span class="free">T1</span> <span class="free">T2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">subs</span><span class="main">.</span> raw_match' <span class="free">T2</span> <span class="free">T1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="main">.</span> None<span class="main">)</span> <span class="main">=</span> Some <span class="bound">subs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"tsubstT <span class="free">T2</span> <span class="skolem">ρ</span> <span class="main">=</span> <span class="free">T1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms tinstT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T2</span> <span class="free">T1</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">ρ</span> <span class="bound">idx</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">ρ</span> <span class="bound">idx</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> tsubstT_matcher_imp_raw_match'_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T2</span> <span class="free">T1</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">ρ</span> <span class="bound">idx</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">|`</span>tvsT <span class="free">T2</span><span class="main">)</span> 
    <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">ρ</span> <span class="bound">idx</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">|`</span>tvsT <span class="free">T2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> raw_match'_restriction_on_tvsT <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">ρ</span> <span class="bound">idx</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">|`</span>tvsT <span class="free">T2</span><span class="main">)</span> <span class="main">=</span> tvsT <span class="free">T2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> map_le_produces_same_raw_match'
    <span class="keyword1"><span class="command">using</span></span> map_le_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Instances-ex_raw_match'_imp_tinstT"><span class="command">lemma</span></span> ex_raw_match'_imp_tinstT<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">subs</span><span class="main">.</span> raw_match' <span class="free">T2</span> <span class="free">T1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="main">.</span> None<span class="main">)</span> <span class="main">=</span> Some <span class="bound">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tinstT <span class="free">T1</span> <span class="free">T2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">subs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T2</span> <span class="free">T1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="main">.</span> None<span class="main">)</span> <span class="main">=</span> Some <span class="skolem">subs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"tsubstT <span class="free">T2</span> <span class="main">(</span>convert_subs <span class="skolem">subs</span><span class="main">)</span> <span class="main">=</span> <span class="free">T1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> raw_match'_produces_matcher <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> tinstT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> tinstT_iff_ex_raw_match'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"tinstT <span class="free">T1</span> <span class="free">T2</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">subs</span><span class="main">.</span> raw_match' <span class="free">T2</span> <span class="free">T1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="main">.</span> None<span class="main">)</span> <span class="main">=</span> Some <span class="bound">subs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ex_raw_match'_imp_tinstT tinstT_imp_ex_raw_match' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">raw_match_term</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">⇀</span> typ<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">⇀</span> typ<span class="main">)</span> option"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">raw_match_term</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> raw_match' <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">raw_match_term</span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> raw_match' <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">raw_match_term</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">raw_match_term</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> 
    Option.bind <span class="main">(</span>raw_match' <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">raw_match_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">raw_match_term</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> Option.bind <span class="main">(</span><span class="free">raw_match_term</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">raw_match_term</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">raw_match_term</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">size_change</span>

<span class="keyword1" id="Instances-raw_match_term_map_le"><span class="command">lemma</span></span> raw_match_term_map_le<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> map_le <span class="free">subs</span> <span class="free">subs'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match_term.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> map_le_trans raw_match'_map_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>

<span class="keyword1" id="Instances-raw_match_term_tvs_subset_dom_res"><span class="command">lemma</span></span> raw_match_term_tvs_subset_dom_res<span class="main">:</span>
  <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> tvs <span class="free">t</span> <span class="main">⊆</span> dom <span class="free">subs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match_term.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">T</span> <span class="skolem">t</span> <span class="skolem">U</span> <span class="skolem">u</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bsubs</span></span> <span class="keyword2"><span class="keyword">where</span></span> bsubs<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">T</span> <span class="skolem">U</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">bsubs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv raw_match'_produces_matcher<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> body<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">bsubs</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv raw_match'_produces_matcher<span class="main">)</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"tvs <span class="skolem">t</span> <span class="main">⊆</span> dom <span class="skolem">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">from</span></span> bsubs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tvsT <span class="skolem">T</span> <span class="main">⊆</span> dom <span class="skolem">bsubs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> raw_match'_tvsT_subset_dom_res <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bsubs</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">subs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> raw_match_term_map_le body <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"tvsT <span class="skolem">T</span> <span class="main">⊆</span> dom <span class="skolem">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_le_implies_dom_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">f</span> <span class="skolem">u</span> <span class="skolem">f'</span> <span class="skolem">u'</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fsubs</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">fsubs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">fsubs</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"tvs <span class="skolem">u</span> <span class="main">⊆</span> dom <span class="skolem">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f u <span class="quoted">"5.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tvs <span class="skolem">f</span> <span class="main">⊆</span> dom <span class="skolem">fsubs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 5 f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fsubs</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">subs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> raw_match_term_map_le u <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"tvs <span class="skolem">f</span> <span class="main">⊆</span> dom <span class="skolem">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_le_implies_dom_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> raw_match'_tvsT_subset_dom_res <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits if_splits prod.splits›</span><span class="main">)</span> 


<span class="keyword1" id="Instances-raw_match_term_dom_res_subset_tvs"><span class="command">lemma</span></span> raw_match_term_dom_res_subset_tvs<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> dom <span class="free">subs'</span> <span class="main">⊆</span> tvs <span class="free">t</span> <span class="main">∪</span> dom <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match_term.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">T</span> <span class="skolem">t</span> <span class="skolem">U</span> <span class="skolem">u</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bsubs</span></span> <span class="keyword2"><span class="keyword">where</span></span> bsubs<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">T</span> <span class="skolem">U</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">bsubs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv raw_match'_produces_matcher<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> body<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">bsubs</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv raw_match'_produces_matcher<span class="main">)</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">subs'</span> <span class="main">⊆</span> tvs <span class="skolem">t</span> <span class="main">∪</span> dom <span class="skolem">bsubs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">from</span></span> bsubs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">bsubs</span> <span class="main">⊆</span> tvsT <span class="skolem">T</span> <span class="main">∪</span> dom <span class="skolem">bsubs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> raw_match'_dom_res_subset_tvsT <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">subs</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">bsubs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bsubs raw_match'_map_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">bsubs</span> <span class="main">⊆</span> tvsT <span class="skolem">T</span> <span class="main">∪</span> dom <span class="skolem">subs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> bsubs raw_match'_dom_res_subset_tvsT <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">f</span> <span class="skolem">u</span> <span class="skolem">f'</span> <span class="skolem">u'</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fsubs</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">fsubs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">fsubs</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">fsubs</span> <span class="main">⊆</span> tvs <span class="skolem">f</span> <span class="main">∪</span> dom <span class="skolem">subs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 5 f u <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">subs'</span> <span class="main">⊆</span> tvs <span class="skolem">u</span> <span class="main">∪</span> dom <span class="skolem">fsubs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 5 f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fsubs</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">subs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> raw_match_term_map_le u <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">subs'</span> <span class="main">⊆</span> tvs <span class="skolem">f</span> <span class="main">∪</span> tvs <span class="skolem">u</span> <span class="main">∪</span> dom <span class="skolem">subs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted">"1"</span> Un_commute inf_sup_aci<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> subset_Un_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> raw_match'_dom_res_subset_tvsT <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits if_splits prod.splits›</span><span class="main">)</span> 

<span class="keyword1"><span class="command">corollary</span></span> raw_match_term_dom_res_eq_tvs<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> dom <span class="free">subs'</span> <span class="main">=</span> tvs <span class="free">t</span> <span class="main">∪</span> dom <span class="free">subs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_le_implies_dom_le raw_match_term_tvs_subset_dom_res 
      raw_match_term_dom_res_subset_tvs raw_match_term_map_le subset_antisym<span class="main">)</span>

<span class="keyword1" id="Instances-raw_match_term_extend_map_preserve"><span class="command">lemma</span></span> raw_match_term_extend_map_preserve<span class="main">:</span>
  <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> map_le <span class="free">subs'</span> <span class="free">subs''</span> <span class="main">⟹</span> <span class="free">p</span><span class="main">∈</span>tvs <span class="free">t</span> <span class="main">⟹</span> <span class="free">subs''</span> <span class="free">p</span> <span class="main">=</span> <span class="free">subs'</span> <span class="free">p</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> raw_match_term_dom_res_eq_tvs domIff map_le_implies_dom_le 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_le_def<span class="main">)</span>

<span class="keyword1" id="Instances-map_eq_on_tvs_imp_map_eq_on_term"><span class="command">lemma</span></span> map_eq_on_tvs_imp_map_eq_on_term<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span><span class="main">∈</span>tvs <span class="free">t</span> <span class="main">⟹</span> <span class="free">subs</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">subs'</span> <span class="bound">p</span><span class="main">)</span> 
  <span class="main">⟹</span> tsubst <span class="free">t</span> <span class="main">(</span>convert_subs <span class="free">subs</span><span class="main">)</span>
    <span class="main">=</span> tsubst <span class="free">t</span> <span class="main">(</span>convert_subs <span class="free">subs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> map_eq_on_tvsT_imp_map_eq_on_typ <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">fastforce</span><span class="keyword3">+</span>›</span><span class="main">)</span>

<span class="keyword1" id="Instances-raw_match_extend_map_preserve'"><span class="command">lemma</span></span> raw_match_extend_map_preserve'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span> <span class="quoted"><span class="quoted">"map_le <span class="free">subs'</span> <span class="free">subs''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tsubst <span class="free">t</span> <span class="main">(</span>convert_subs <span class="free">subs'</span><span class="main">)</span> 
    <span class="main">=</span> tsubst <span class="free">t</span> <span class="main">(</span>convert_subs <span class="free">subs''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> map_eq_on_tvs_imp_map_eq_on_term<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> raw_match_term_extend_map_preserve assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Instances-raw_match_term_produces_matcher"><span class="command">lemma</span></span> raw_match_term_produces_matcher<span class="main">:</span>
  <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> 
    <span class="main">⟹</span> tsubst <span class="free">t</span> <span class="main">(</span>convert_subs <span class="free">subs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match_term.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">T</span> <span class="skolem">t</span> <span class="skolem">U</span> <span class="skolem">u</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bsubs</span></span> <span class="keyword2"><span class="keyword">where</span></span> bsubs<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">T</span> <span class="skolem">U</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">bsubs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv raw_match'_produces_matcher<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> body<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">bsubs</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv raw_match'_produces_matcher<span class="main">)</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"tsubst <span class="skolem">t</span> <span class="main">(</span>convert_subs <span class="skolem">subs'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">from</span></span> bsubs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tsubstT <span class="skolem">T</span> <span class="main">(</span>convert_subs <span class="skolem">bsubs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> raw_match'_produces_matcher <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bsubs</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">subs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> raw_match_term_map_le body <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"tsubstT <span class="skolem">T</span> <span class="main">(</span>convert_subs <span class="skolem">subs'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> raw_match'_extend_map_preserve'<span class="main">[</span><span class="operator">OF</span> bsubs<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">subs'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">f</span> <span class="skolem">u</span> <span class="skolem">f'</span> <span class="skolem">u'</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fsubs</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">fsubs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">fsubs</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"tsubst <span class="skolem">u</span> <span class="main">(</span>convert_subs <span class="skolem">subs'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f u <span class="quoted">"5.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tsubst <span class="skolem">f</span> <span class="main">(</span>convert_subs <span class="skolem">fsubs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 5 f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fsubs</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">subs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> raw_match_term_map_le u <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"tsubst <span class="skolem">f</span> <span class="main">(</span>convert_subs <span class="skolem">subs'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> raw_match_extend_map_preserve'<span class="main">[</span><span class="operator">OF</span> f<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">subs'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> raw_match'_extend_map_preserve' 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv raw_match'_produces_matcher<span class="main">)</span>

<span class="keyword1" id="Instances-ex_raw_match_term_imp_tinst"><span class="command">lemma</span></span> ex_raw_match_term_imp_tinst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">subs</span><span class="main">.</span> raw_match_term <span class="free">t2</span> <span class="free">t1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="main">.</span> None<span class="main">)</span> <span class="main">=</span> Some <span class="bound">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tinst <span class="free">t1</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">subs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t2</span> <span class="free">t1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="main">.</span> None<span class="main">)</span> <span class="main">=</span> Some <span class="skolem">subs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"tsubst <span class="free">t2</span> <span class="main">(</span>convert_subs <span class="skolem">subs</span><span class="main">)</span> <span class="main">=</span> <span class="free">t1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> raw_match_term_produces_matcher <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> tinst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Instances-tsubst_matcher_imp_raw_match_term_unchanged"><span class="command">lemma</span></span> tsubst_matcher_imp_raw_match_term_unchanged<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tsubst <span class="free">t</span> <span class="free">ρ</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⟹</span> raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> Some <span class="main">(</span><span class="free">ρ</span> <span class="bound">idx</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> Some <span class="main">(</span><span class="free">ρ</span> <span class="bound">idx</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tsubstT_matcher_imp_raw_match'_unchanged<span class="main">)</span>

<span class="keyword1" id="Instances-raw_match_term_restriction"><span class="command">lemma</span></span> raw_match_term_restriction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tvs <span class="free">t</span> <span class="main">⊆</span> <span class="free">restriction</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="main">(</span><span class="free">subs</span><span class="main">|`</span><span class="free">restriction</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">subs'</span><span class="main">|`</span><span class="free">restriction</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">restriction</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match_term.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">use</span> raw_match'_restriction <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> 
    <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits if_splits prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> bind_eq_Some_conv›</span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> raw_match_term_restriction_on_tvs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="main">(</span><span class="free">subs</span><span class="main">|`</span>tvs <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">subs'</span><span class="main">|`</span>tvs <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> raw_match_term_restriction assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Instances-raw_match_term_imp_raw_match_term_on_map_le"><span class="command">lemma</span></span> raw_match_term_imp_raw_match_term_on_map_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_le <span class="free">lesubs</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">lesubs'</span><span class="main">.</span> raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">lesubs</span> <span class="main">=</span> Some <span class="bound">lesubs'</span> <span class="main">∧</span> map_le <span class="bound">lesubs'</span> <span class="free">subs'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lesubs</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match_term.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">T</span> <span class="skolem">t</span> <span class="skolem">U</span> <span class="skolem">u</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bsubs</span></span> <span class="keyword2"><span class="keyword">where</span></span> bsubs<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">T</span> <span class="skolem">U</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">bsubs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv raw_match'_produces_matcher<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> body<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">bsubs</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv raw_match'_produces_matcher<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> bsubs 4 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lebsubs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    lebsubs<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">T</span> <span class="skolem">U</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">lebsubs</span>"</span></span> <span class="quoted"><span class="quoted">"map_le <span class="skolem">lebsubs</span> <span class="skolem">bsubs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> raw_match'_map_le map_le_trans
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv raw_match'_produces_matcher<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lesubs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    lesubs'<span class="main">:</span><span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">lebsubs</span> <span class="main">=</span> Some <span class="skolem">lesubs'</span>"</span></span> <span class="quoted"><span class="quoted">"map_le <span class="skolem">lesubs'</span> <span class="skolem">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv raw_match'_produces_matcher<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lebsubs lesubs' 4 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> raw_match'_imp_raw_match'_on_map_le<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">f</span> <span class="skolem">u</span> <span class="skolem">f'</span> <span class="skolem">u'</span> <span class="skolem">subs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fsubs</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">fsubs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">fsubs</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
   <span class="keyword1"><span class="command">from</span></span> 5 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lefsubs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    lefsubs<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">lefsubs</span>"</span></span> <span class="quoted"><span class="quoted">"map_le <span class="skolem">lefsubs</span> <span class="skolem">fsubs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> raw_match_term_map_le map_le_trans f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lesubs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    lesubs'<span class="main">:</span><span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">lefsubs</span> <span class="main">=</span> Some <span class="skolem">lesubs'</span>"</span></span> <span class="quoted"><span class="quoted">"map_le <span class="skolem">lesubs'</span> <span class="skolem">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5.prems"</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv raw_match'_produces_matcher<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> lefsubs lesubs' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> raw_match'_imp_raw_match'_on_map_le <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> 
    <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits if_splits prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> bind_eq_Some_conv›</span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> map_le_produces_same_raw_match_term<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">subs</span> <span class="main">⊆</span> tvs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_le <span class="free">lesubs</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">lesubs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">subs'</span> <span class="main">=</span> tvs <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> raw_match_term_dom_res_eq_tvs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lesubs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">lesubs</span> <span class="main">=</span> Some <span class="skolem">lesubs'</span>"</span></span> <span class="quoted"><span class="quoted">"map_le <span class="skolem">lesubs'</span> <span class="free">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> raw_match_term_imp_raw_match_term_on_map_le assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">lesubs'</span> <span class="main">=</span> tvs <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dom <span class="free">subs'</span> <span class="main">=</span> tvs <span class="free">t</span>›</span></span> map_le_implies_dom_le raw_match_term_tvs_subset_dom_res <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> map_le_same_dom_imp_same_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Instances-tinst_imp_ex_raw_match_term"><span class="command">lemma</span></span> tinst_imp_ex_raw_match_term<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tinst <span class="free">t1</span> <span class="free">t2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">subs</span><span class="main">.</span> raw_match_term <span class="free">t2</span> <span class="free">t1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="main">.</span> None<span class="main">)</span> <span class="main">=</span> Some <span class="bound">subs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"tsubst <span class="free">t2</span> <span class="skolem">ρ</span> <span class="main">=</span> <span class="free">t1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms tinst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t2</span> <span class="free">t1</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">ρ</span> <span class="bound">idx</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">ρ</span> <span class="bound">idx</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> tsubst_matcher_imp_raw_match_term_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t2</span> <span class="free">t1</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">ρ</span> <span class="bound">idx</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">|`</span>tvs <span class="free">t2</span><span class="main">)</span> 
    <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">ρ</span> <span class="bound">idx</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">|`</span>tvs <span class="free">t2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> raw_match_term_restriction_on_tvs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">idx</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">ρ</span> <span class="bound">idx</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">|`</span>tvs <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> tvs <span class="free">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> map_le_produces_same_raw_match_term
    <span class="keyword1"><span class="command">using</span></span> map_le_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> tinst_iff_ex_raw_match_term<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"tinst <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">subs</span><span class="main">.</span> raw_match_term <span class="free">t2</span> <span class="free">t1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="main">.</span> None<span class="main">)</span> <span class="main">=</span> Some <span class="bound">subs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ex_raw_match_term_imp_tinst tinst_imp_ex_raw_match_term <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* Now transfer to assoc lists for executability *)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">assoc_match</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"typ <span class="main">⇒</span> typ <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">×</span> typ<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">×</span> typ<span class="main">)</span> list option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">assoc_match</span> <span class="main">(</span>Tv <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> Some <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">U</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">U</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">assoc_match</span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">Us</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">Us</span></span></span> 
      <span class="keyword1">then</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="bound">subs</span> <span class="main">.</span> Option.bind <span class="bound">subs</span> <span class="main">(</span><span class="free">assoc_match</span> <span class="bound">T</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Us</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">assoc_match</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">pat_completeness</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">,</span> <span class="bound">subs</span><span class="main">)</span> <span class="main">.</span> size <span class="bound">T</span> <span class="main">+</span> size <span class="bound">U</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">Ts</span> <span class="skolem">b</span> <span class="skolem">Us</span> <span class="skolem">subs</span> <span class="skolem">x</span> <span class="skolem">xa</span> <span class="skolem">y</span> <span class="skolem">xb</span> <span class="skolem">aa</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this 2<span class="main">(</span>2-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quoted"><span class="skolem">Us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> assoc_match_Type_conds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"assoc_match <span class="main">(</span>Ty <span class="free">a</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">(</span>Ty <span class="free">b</span> <span class="free">Us</span><span class="main">)</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">=</span><span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Ts</span> <span class="main">=</span> length <span class="free">Us</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Instances-fold_assoc_matches_first_step_not_None"><span class="command">lemma</span></span> fold_assoc_matches_first_step_not_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="bound">subs</span> <span class="main">.</span> Option.bind <span class="bound">subs</span> <span class="main">(</span>assoc_match <span class="bound">T</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">subs</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">point</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"assoc_match <span class="free">x</span> <span class="free">y</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">point</span>"</span></span>
    <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="bound">subs</span> <span class="main">.</span> Option.bind <span class="bound">subs</span> <span class="main">(</span>assoc_match <span class="bound">T</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">point</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">subs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fold_Option_bind_eq_Some_start_not_None' not_None_eq<span class="main">)</span>

<span class="keyword1" id="Instances-assoc_match_subset"><span class="command">lemma</span></span> assoc_match_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"assoc_match <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> set <span class="free">subs</span> <span class="main">⊆</span> set <span class="free">subs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> assoc_match.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">Ts</span> <span class="skolem">b</span> <span class="skolem">Us</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> better_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">Ts</span> <span class="skolem">Us</span><span class="main">)</span> <span class="main">⟹</span> 
    assoc_match <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">subs'</span> <span class="main">⟹</span> set <span class="skolem">subs</span> <span class="main">⊆</span> set <span class="skolem">subs'</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="skolem">subs'</span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> l better_IH <span class="quoted">"2.prems"</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quoted"><span class="skolem">Us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">subs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">point</span></span> <span class="keyword2"><span class="keyword">where</span></span> first<span class="main">:</span> <span class="quoted"><span class="quoted">"assoc_match <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">point</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> rest<span class="main">:</span> <span class="quoted"><span class="quoted">"assoc_match <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">b</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">point</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fold_assoc_matches_first_step_not_None
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.hyps Cons.prems assoc_match.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assoc_match_Type_conds<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits 
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_present_eq_key bind_eq_Some_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_present_eq_key<span class="main">)</span>

<span class="keyword1" id="Instances-assoc_match_distinct"><span class="command">lemma</span></span> assoc_match_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"assoc_match <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span> <span class="main">=</span> Some <span class="free">subs'</span> <span class="main">⟹</span> distinct <span class="main">(</span>map fst <span class="free">subs</span><span class="main">)</span> 
  <span class="main">⟹</span> distinct <span class="main">(</span>map fst <span class="free">subs'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> assoc_match.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">Ts</span> <span class="skolem">b</span> <span class="skolem">Us</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> better_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">Ts</span> <span class="skolem">Us</span><span class="main">)</span> <span class="main">⟹</span> 
    assoc_match <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">subs'</span> <span class="main">⟹</span> distinct <span class="main">(</span>map fst <span class="skolem">subs</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>map fst <span class="skolem">subs'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="skolem">subs'</span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> l better_IH <span class="quoted">"2.prems"</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quoted"><span class="skolem">Us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">subs</span></span> <span class="quoted"><span class="skolem">subs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">point</span></span> <span class="keyword2"><span class="keyword">where</span></span> first<span class="main">:</span> <span class="quoted"><span class="quoted">"assoc_match <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="main">=</span> Some <span class="skolem">point</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> rest<span class="main">:</span> <span class="quoted"><span class="quoted">"assoc_match <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">b</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">point</span> <span class="main">=</span> Some <span class="skolem">subs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fold_assoc_matches_first_step_not_None
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.hyps Cons.prems assoc_match.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assoc_match_Type_conds<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> dst_point<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">point</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.prems<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> first Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">subs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems rest <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> rest <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> dst_point <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_present_eq_key<span class="main">)</span>


<span class="comment1">(* Seems that distinct is not even necessary, as both take the first one in case of duplicates*)</span>
<span class="keyword1" id="Instances-lookup_eq_map_of_ap"><span class="command">lemma</span></span> lookup_eq_map_of_ap<span class="main">:</span>                           
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">k</span><span class="main">)</span> <span class="free">subs</span> <span class="main">=</span> map_of <span class="free">subs</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* Ugly proof, but should mean that I can replace raw_match' with the executable assoc_match *)</span>
<span class="keyword1" id="Instances-raw_match'_assoc_match"><span class="command">lemma</span></span> raw_match'_assoc_match<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="free">T</span> <span class="free">U</span> <span class="main">(</span>map_of <span class="free">subs</span><span class="main">)</span> <span class="main">=</span> map_option map_of <span class="main">(</span>assoc_match <span class="free">T</span> <span class="free">U</span> <span class="free">subs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">subs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match'.induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">v</span> <span class="skolem">S</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_present_eq_key lookup_eq_map_of_ap<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">Ts</span> <span class="skolem">b</span> <span class="skolem">Us</span> <span class="skolem">subs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>raw_match' <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">b</span> <span class="skolem">Us</span><span class="main">)</span> <span class="main">(</span>map_of <span class="skolem">subs</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">∧</span> length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Us</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 None 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quoted"><span class="skolem">Us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">subs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>

        <span class="keyword1"><span class="command">hence</span></span> eq_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span>map_of <span class="skolem">subs</span><span class="main">)</span> <span class="main">=</span> map_option map_of <span class="main">(</span>assoc_match <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"assoc_match <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span>map_of <span class="skolem">subs</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_hd <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> fold_Option_bind_at_some_point_None_eq_None fold_assoc_matches_first_step_not_None
              Cons.prems 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits 
                <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_Option_bind_eq_None_start_None<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">res</span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span>map_of <span class="skolem">subs</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>map_of <span class="skolem">res</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_hd <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> fold_assoc_matches_first_step_not_None fold_Option_bind_eq_Some_at_each_point_Some
              Cons.prems Cons.IH
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits 
                <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_Option_bind_eq_None_start_None<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> None 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">res</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> better_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">Ts</span> <span class="skolem">Us</span><span class="main">)</span> <span class="main">⟹</span>
    raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span>map_of <span class="skolem">subs</span><span class="main">)</span> <span class="main">=</span> map_option map_of <span class="main">(</span>assoc_match <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span> <span class="keyword1"><span class="command">using</span></span> 2 Some <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> l better_IH Some <span class="quoted">"2.prems"</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ts</span></span> <span class="quoted"><span class="skolem">Us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">subs</span></span> <span class="quoted"><span class="skolem">res</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">point</span></span> <span class="keyword2"><span class="keyword">where</span></span> first<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span>map_of <span class="skolem">subs</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>map_of <span class="skolem">point</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> rest<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">b</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span>map_of <span class="skolem">point</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">res</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fold_matches_first_step_not_None Cons.prems
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits<span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> map_option_eq_Some<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span>map_of <span class="skolem">subs</span><span class="main">)</span> <span class="main">=</span> map_option map_of <span class="main">(</span>assoc_match <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">subs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">b</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span>map_of <span class="skolem">point</span><span class="main">)</span>
        <span class="main">=</span> map_option map_of <span class="main">(</span>assoc_match <span class="main">(</span>Ty <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">b</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">point</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons rest <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> 1 2 first rest
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Cons.IH Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assoc_match.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> map_option_eq_Some 
            rest zip_Cons_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_present_eq_key<span class="main">)</span>

<span class="keyword1" id="Instances-dom_eq_and_eq_on_dom_imp_eq"><span class="command">lemma</span></span> dom_eq_and_eq_on_dom_imp_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">m</span> <span class="main">=</span> dom <span class="free">m'</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="free">m</span> <span class="main">.</span> <span class="free">m</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">m'</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> <span class="free">m'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_le_def map_le_same_dom_imp_same_map<span class="main">)</span>

<span class="keyword1" id="Instances-list_of_map"><span class="command">lemma</span></span> list_of_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">subs</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> map_of <span class="bound">l</span> <span class="main">=</span> <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> the <span class="main">(</span><span class="free">subs</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">k</span> <span class="main">.</span> <span class="bound">k</span><span class="main">∈</span>dom <span class="free">subs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">l</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> the <span class="main">(</span><span class="free">subs</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">k</span> <span class="main">.</span> <span class="bound">k</span><span class="main">∈</span>dom <span class="free">subs</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> finite_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>map_of <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> the <span class="main">(</span><span class="free">subs</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">k</span> <span class="main">.</span> <span class="bound">k</span><span class="main">∈</span>dom <span class="free">subs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_map_of_conv_image_fst<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dom <span class="free">subs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Setcompr_eq_image domI image_image<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>map_of <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">subs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">l</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">subs</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>dom <span class="free">subs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> 
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> l domIff fst_conv map_of_SomeD mem_Collect_eq option.collapse prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> weak_map_of_SomeI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">l</span> <span class="main">=</span> <span class="free">subs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_eq_and_eq_on_dom_imp_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> tinstT_iff_assoc_match<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tinstT <span class="free">T1</span> <span class="free">T2</span> <span class="main">⟷</span> assoc_match <span class="free">T2</span> <span class="free">T1</span> <span class="main">[]</span> <span class="main">~=</span> None"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> tinstT_iff_ex_raw_match' list_of_map raw_match'_assoc_match
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> map_of_eq_empty_iff map_option_is_None option.collapse option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">assoc_match_term</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">×</span> typ<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>variable <span class="main">×</span> sort<span class="main">)</span> <span class="main">×</span> typ<span class="main">)</span> list option"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">assoc_match_term</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> assoc_match <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">assoc_match_term</span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">(</span>Fv <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> assoc_match <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">assoc_match_term</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>Bv <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">assoc_match_term</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> 
    Option.bind <span class="main">(</span>assoc_match <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">assoc_match_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">assoc_match_term</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> Option.bind <span class="main">(</span><span class="free">assoc_match_term</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">assoc_match_term</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">assoc_match_term</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">size_change</span>

<span class="keyword1" id="Instances-raw_match_term_assoc_match_term"><span class="command">lemma</span></span> raw_match_term_assoc_match_term<span class="main">:</span>
  <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t</span> <span class="free">u</span> <span class="main">(</span>map_of <span class="free">subs</span><span class="main">)</span> <span class="main">=</span> map_option map_of <span class="main">(</span>assoc_match_term <span class="free">t</span> <span class="free">u</span> <span class="free">subs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">subs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_match_term.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">T</span> <span class="skolem">t</span> <span class="skolem">U</span> <span class="skolem">u</span><span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"assoc_match <span class="skolem">T</span> <span class="skolem">U</span> <span class="skolem">subs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> raw_match'_assoc_match <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">bsubs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_match' <span class="skolem">T</span> <span class="skolem">U</span> <span class="main">(</span>map_of <span class="skolem">subs</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>map_of <span class="skolem">bsubs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> raw_match'_assoc_match <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="skolem">t</span> <span class="skolem">u</span> <span class="main">(</span>map_of <span class="skolem">bsubs</span><span class="main">)</span> <span class="main">=</span> map_option map_of <span class="main">(</span>assoc_match_term <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">bsubs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Some 1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">f</span> <span class="skolem">u</span> <span class="skolem">f'</span> <span class="skolem">u'</span><span class="main">)</span>
  <span class="comment1">(* Do a real proof here when time *)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"5.hyps"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"5.hyps"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Option.bind <span class="main">(</span>map_option map_of <span class="main">(</span>assoc_match_term <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">subs</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>raw_match_term <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">=</span>
    map_option map_of <span class="main">(</span>Option.bind <span class="main">(</span>assoc_match_term <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">subs</span><span class="main">)</span> <span class="main">(</span>assoc_match_term <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> None_eq_map_option_iff bind.bind_lunit bind_eq_None_conv option.collapse option.map_sel<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> raw_match'_assoc_match 5 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_present_eq_key bind_eq_Some_conv bind_eq_None_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> raw_match'_assoc_match <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits prod.splits›</span><span class="main">)</span>

<span class="comment1">(* Automation surprisingly broke on translation :( *)</span>
<span class="keyword1"><span class="command">corollary</span></span> tinst_iff_assoc_match_term<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tinst <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟷</span> assoc_match_term <span class="free">t2</span> <span class="free">t1</span> <span class="main">[]</span> <span class="main">≠</span> None"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tinst <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">asubs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t2</span> <span class="free">t1</span> Map.empty <span class="main">=</span> Some <span class="skolem">asubs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tinst_imp_ex_raw_match_term <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csubs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"assoc_match_term <span class="free">t2</span> <span class="free">t1</span> <span class="main">[]</span> <span class="main">=</span> Some <span class="skolem">csubs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_eq_map_of_iff map_option_eq_Some raw_match_term_assoc_match_term<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"assoc_match_term <span class="free">t2</span> <span class="free">t1</span> <span class="main">[]</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"assoc_match_term <span class="free">t2</span> <span class="free">t1</span> <span class="main">[]</span> <span class="main">≠</span> None"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csubs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"assoc_match_term <span class="free">t2</span> <span class="free">t1</span> <span class="main">[]</span> <span class="main">=</span> Some <span class="skolem">csubs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">asubs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"raw_match_term <span class="free">t2</span> <span class="free">t1</span> Map.empty <span class="main">=</span> Some <span class="skolem">asubs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_eq_map_of_iff option.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> raw_match_term_assoc_match_term<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"tinst <span class="free">t1</span> <span class="free">t2</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> tinst_iff_ex_raw_match_term <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">hide_fact</span></span> fold_matches_first_step_not_None fold_matches_last_step_not_None

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="TheoryExe">
<div class="head">
<h1>Theory TheoryExe</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Executable Signature and Theory"</span></span>

<span class="comment1">(* Proofs are ugly, clean up if time *)</span>

<span class="keyword1"><span class="command">theory</span></span> TheoryExe
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#SortsExe">SortsExe</a> <a href="#Theory">Theory</a> <a href="#Instances">Instances</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> exesignature <span class="main">=</span> ExeSignature 
  <span class="main">(</span><span class="free"><span class="entity">execonst_type_of</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> typ<span class="main">)</span> list"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">exetyp_arity_of</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> nat<span class="main">)</span> list"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">exesorts</span></span><span class="main">:</span> <span class="quoted">exeosig</span><span class="main">)</span>

<span class="keyword1" id="TheoryExe-exe_const_type_of_ok"><span class="command">lemma</span></span> exe_const_type_of_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"
  alist_conds <span class="free">cto</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">ty</span> <span class="main">∈</span> Map.ran <span class="main">(</span>map_of <span class="free">cto</span><span class="main">)</span> <span class="main">.</span> typ_ok_sig <span class="main">(</span>map_of <span class="free">cto</span><span class="main">,</span> <span class="free">ta</span><span class="main">,</span> <span class="free">sa</span><span class="main">)</span> <span class="bound">ty</span><span class="main">)</span>
  <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ty</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">cto</span>  <span class="main">.</span> typ_ok_sig <span class="main">(</span>map_of <span class="free">cto</span><span class="main">,</span> <span class="free">ta</span><span class="main">,</span> <span class="free">sa</span><span class="main">)</span> <span class="bound">ty</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_distinct<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exe_wf_sig</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exe_wf_sig</span> <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>exe_wf_osig <span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">∧</span>
  fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">tao</span></span></span> 
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">type</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span><span class="main">.</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span>the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="bound">type</span><span class="main">)</span> <span class="main">(</span>exetcsigs <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span>
      the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="bound">type</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span><span class="main">)</span> <span class="main">=</span> length <span class="bound">ars</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ty</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="main">.</span> typ_ok_sig <span class="main">(</span>map_of <span class="free"><span class="bound"><span class="entity">cto</span></span></span><span class="main">,</span> map_of <span class="free"><span class="bound"><span class="entity">tao</span></span></span><span class="main">,</span> translate_osig <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> <span class="bound">ty</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TheoryExe-exe_wf_sig_imp_wf_sig"><span class="command">lemma</span></span> exe_wf_sig_imp_wf_sig<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"alist_conds <span class="free">cto</span>"</span></span> <span class="quoted"><span class="quoted">"alist_conds <span class="free">tao</span>"</span></span> <span class="quoted"><span class="quoted">"exe_osig_conds <span class="free">sa</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>exe_wf_osig <span class="free">sa</span>
  <span class="main">∧</span> fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free">tao</span> 
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">type</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span><span class="main">.</span>  
      <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span>the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="bound">type</span><span class="main">)</span> <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span>
      the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="bound">type</span><span class="main">)</span> <span class="free">tao</span><span class="main">)</span> <span class="main">=</span> length <span class="bound">ars</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ty</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">cto</span> <span class="main">.</span> typ_ok_sig <span class="main">(</span>map_of <span class="free">cto</span><span class="main">,</span> map_of <span class="free">tao</span><span class="main">,</span> translate_osig <span class="free">sa</span><span class="main">)</span> <span class="bound">ty</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_sig <span class="main">(</span>map_of <span class="free">cto</span><span class="main">,</span> map_of <span class="free">tao</span><span class="main">,</span> translate_osig <span class="free">sa</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">type</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"exe_osig_conds <span class="free">sa</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span>fst <span class="main">(</span>translate_osig <span class="free">sa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>translate_osig <span class="free">sa</span><span class="main">)</span> <span class="skolem">type</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"exe_ars_conds <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> exe_osig_conds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"translate_ars <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span> <span class="skolem">type</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snd_conv translate_osig.elims<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">type</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> map_of_SomeD <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">type</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="skolem">type</span><span class="main">)</span> <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">x</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> key_present_imp_eq_lookup_finds_value <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹exe_ars_conds <span class="main">(</span>snd <span class="free">sa</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹translate_ars <span class="main">(</span>snd <span class="free">sa</span><span class="main">)</span> <span class="skolem">type</span> <span class="main">=</span> Some <span class="skolem">y</span>›</span></span> 
          exe_ars_conds_def in_alist_imp_in_map_of lookup_eq_map_of_ap 
          map_of_SomeD option.sel<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="skolem">type</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">tao</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">type</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span>›</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ars</span> <span class="skolem">type</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"exe_osig_conds <span class="free">sa</span>"</span></span>
      <span class="quoted"><span class="quoted">"trans <span class="main">(</span>fst <span class="main">(</span>translate_osig <span class="free">sa</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">cto</span><span class="main">.</span> typ_ok_sig <span class="main">(</span>map_of <span class="free">cto</span><span class="main">,</span> map_of <span class="free">tao</span><span class="main">,</span> translate_osig <span class="free">sa</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">ars</span> <span class="main">∈</span> ran <span class="skolem">y</span>"</span></span>
      <span class="quoted"><span class="quoted">"snd <span class="main">(</span>translate_osig <span class="free">sa</span><span class="main">)</span> <span class="skolem">type</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"exe_ars_conds <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> exe_osig_conds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> p<span class="main">(</span>1-2<span class="main">)</span> p<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"translate_ars <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span> <span class="skolem">type</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snd_conv translate_osig.elims<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">type</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> map_of_SomeD <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">type</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="skolem">type</span><span class="main">)</span> <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">x</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> key_present_imp_eq_lookup_finds_value <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹exe_ars_conds <span class="main">(</span>snd <span class="free">sa</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹translate_ars <span class="main">(</span>snd <span class="free">sa</span><span class="main">)</span> <span class="skolem">type</span> <span class="main">=</span> Some <span class="skolem">y</span>›</span></span> 
            exe_ars_conds_def in_alist_imp_in_map_of lookup_eq_map_of_ap map_of_SomeD option.sel<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ars</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>›</span></span> image_iff in_range_if_ex_key map_of_SomeD p<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">type</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">tao</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">type</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> dom  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span>the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="skolem">type</span><span class="main">)</span> <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span>
        the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="skolem">type</span><span class="main">)</span> <span class="free">tao</span><span class="main">)</span> <span class="main">=</span> length <span class="bound">ars</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">type</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span>›</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">type</span><span class="main">)</span> <span class="free">tao</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">ars</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lookup <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">type</span><span class="main">)</span> <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>›</span></span> 
            in_range_if_ex_key map_of_SomeD option.sel p<span class="main">(</span>3<span class="main">)</span> snd_conv
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 <span class="quoted"><span class="quoted">‹<span class="skolem">ars</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="skolem">x</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>map_of <span class="free">tao</span> <span class="skolem">type</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">ars</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">type</span><span class="main">)</span> <span class="free">tao</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">ars</span>›</span></span> lookup_eq_map_of_ap<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="skolem">b</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free">tao</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">tao</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">sa</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv image_iff p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ars</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="skolem">x</span><span class="main">)</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="skolem">ars</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> key_present_imp_eq_lookup_finds_value<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">ars</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_present_eq_key'<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>map_of <span class="skolem">ars</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> exe_ars_conds_def exe_osig_conds_def in_alist_imp_in_map_of
          lookup_eq_map_of_ap p<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> snd_conv translate_ars.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lookup_eq_map_of_ap<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 3 <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"alist_conds <span class="free">cto</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ran <span class="main">(</span>map_of <span class="free">cto</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">sa</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="main">(</span>map_of <span class="free">cto</span><span class="main">,</span> map_of <span class="free">tao</span><span class="main">,</span> set <span class="skolem">a</span><span class="main">,</span>  map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> p<span class="main">(</span>1<span class="main">)</span> p<span class="main">(</span>2<span class="main">)</span> p<span class="main">(</span>3<span class="main">)</span> ran_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 4 <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_osig <span class="main">(</span>translate_osig <span class="free">sa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> wf_osig_iff_exe_wf_osig <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">sa</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 1 2 3 4 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TheoryExe-wf_sig_imp_exe_wf_sig"><span class="command">lemma</span></span> wf_sig_imp_exe_wf_sig<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"alist_conds <span class="free">cto</span>"</span></span> <span class="quoted"><span class="quoted">"alist_conds <span class="free">tao</span>"</span></span> <span class="quoted"><span class="quoted">"exe_osig_conds <span class="free">sa</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_sig <span class="main">(</span>map_of <span class="free">cto</span><span class="main">,</span> map_of <span class="free">tao</span><span class="main">,</span> translate_osig <span class="free">sa</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>exe_wf_osig <span class="free">sa</span>
    <span class="main">∧</span> fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free">tao</span> 
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">type</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span><span class="main">.</span> 
        <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span>the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="bound">type</span><span class="main">)</span> <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span>
        the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="bound">type</span><span class="main">)</span> <span class="free">tao</span><span class="main">)</span> <span class="main">=</span> length <span class="bound">ars</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ty</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">cto</span> <span class="main">.</span> typ_ok_sig <span class="main">(</span>map_of <span class="free">cto</span><span class="main">,</span> map_of <span class="free">tao</span><span class="main">,</span> translate_osig <span class="free">sa</span><span class="main">)</span> <span class="bound">ty</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"alist_conds <span class="free">tao</span>"</span></span>
      <span class="quoted"><span class="quoted">"exe_ars_conds <span class="skolem">b</span>"</span></span>
      <span class="quoted"><span class="quoted">"dom <span class="main">(</span>map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span>map_of <span class="free">tao</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">b</span>"</span></span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">tao</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff dom_map_of_conv_image_fst exe_ars_conds_def 
          in_alist_imp_in_map_of option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> translate_ars.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cl</span> <span class="skolem">n</span> <span class="skolem">ar</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">tcs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>String.literal <span class="main">×</span> <span class="main">(</span>String.literal <span class="main">×</span> String.literal set list<span class="main">)</span> list<span class="main">)</span> list"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="skolem">tcs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span>map_of <span class="free">tao</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"alist_conds <span class="free">tao</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ar</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">tao</span>"</span></span>
    
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mgd</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"translate_ars <span class="skolem">tcs</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">mgd</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Some_eq_map_of_iff domI domIff option.exhaust_sel translate_ars.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="skolem">tcs</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">mgd</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tcsigs_translate exe_osig_conds_def p<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="skolem">tcs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> domI domIff map_of_eq_None_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="skolem">tcs</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cl</span> <span class="skolem">tcs</span> <span class="skolem">n</span> <span class="skolem">K</span> <span class="skolem">c</span> <span class="skolem">Ss</span> 
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">K</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">tcs</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">Ss</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">tcs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"exe_ars_conds <span class="skolem">tcs</span>"</span></span>
      <span class="quoted"><span class="quoted">"dom <span class="main">(</span>map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="skolem">tcs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span>map_of <span class="free">tao</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">type</span><span class="main">∈</span>dom <span class="main">(</span>map_of <span class="free">tao</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ars</span><span class="main">∈</span>ran <span class="main">(</span>the <span class="main">(</span>map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="skolem">tcs</span><span class="main">)</span> <span class="bound">type</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
          the <span class="main">(</span>map_of <span class="free">tao</span> <span class="bound">type</span><span class="main">)</span> <span class="main">=</span> length <span class="bound">ars</span>"</span></span>
    
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"translate_ars <span class="skolem">tcs</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="main">(</span>map_of <span class="skolem">K</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> exe_ars_conds_def in_alist_imp_in_map_of p<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">K</span> <span class="skolem">c</span> <span class="main">=</span> Some <span class="skolem">Ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>1-3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Some_eq_map_of_iff exe_ars_conds_def image_iff lookup_eq_map_of_ap
          option.sel snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">tao</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">Ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 2 p<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff lookup_eq_map_of_ap option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.sel ranI translate_ars.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 3 <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_osig <span class="main">(</span>translate_osig <span class="free">sa</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>tcsigs <span class="main">(</span>translate_osig <span class="free">sa</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span>map_of <span class="free">tao</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">type</span> <span class="main">∈</span> dom <span class="main">(</span>tcsigs <span class="main">(</span>translate_osig <span class="free">sa</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> ran <span class="main">(</span>the <span class="main">(</span>tcsigs <span class="main">(</span>translate_osig <span class="free">sa</span><span class="main">)</span> <span class="bound">type</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> the <span class="main">(</span><span class="main">(</span>map_of <span class="free">tao</span><span class="main">)</span> <span class="bound">type</span><span class="main">)</span> <span class="main">=</span> length <span class="bound">ars</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">ty</span> <span class="main">∈</span> Map.ran <span class="main">(</span>map_of <span class="free">cto</span><span class="main">)</span> <span class="main">.</span> wf_type <span class="main">(</span>map_of <span class="free">cto</span><span class="main">,</span> map_of <span class="free">tao</span><span class="main">,</span> translate_osig <span class="free">sa</span><span class="main">)</span> <span class="bound">ty</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> pre <span class="main">=</span> 1
           
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exe_wf_osig <span class="free">sa</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>1<span class="main">)</span> wf_osig_iff_exe_wf_osig <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>snd <span class="free">sa</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free">tao</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>snd <span class="free">sa</span><span class="main">)</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free">tao</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_map_of_conv_image_fst exe_ars_conds_def exe_osig_conds_def<span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> tcsigs_translate assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> domIff in_alist_imp_in_map_of option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>snd <span class="free">sa</span><span class="main">)</span> <span class="main">⊇</span> fst <span class="main">`</span> set <span class="free">tao</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"2"</span> assms<span class="main">(</span>2-3<span class="main">)</span> tcsigs_translate <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">type</span><span class="main">∈</span>fst <span class="main">`</span> set <span class="main">(</span>snd <span class="free">sa</span><span class="main">)</span><span class="main">.</span>  <span class="main">∀</span><span class="bound">ars</span><span class="main">∈</span>snd <span class="main">`</span> set <span class="main">(</span>the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">type</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">sa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">type</span><span class="main">)</span> <span class="free">tao</span><span class="main">)</span> <span class="main">=</span> length <span class="bound">ars</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">Ss</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">Ss</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">sa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>map_of <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="main">(</span>snd <span class="free">sa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span>map_of <span class="free">tao</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> pre<span class="main">(</span>2<span class="main">)</span> tcsigs_translate <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> pre<span class="main">(</span>2<span class="main">)</span> c tcsigs_translate pre<span class="main">(</span>2-3<span class="main">)</span> domI 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_osig_conds_def tcsigs_translate<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> 
          <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> key_present_imp_eq_lookup_finds_value lookup_present_eq_key'
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 3<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">sa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">sa</span>"</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">ty</span> <span class="main">∈</span> Map.ran <span class="main">(</span>map_of <span class="free">cto</span><span class="main">)</span> <span class="main">.</span> wf_type <span class="main">(</span>map_of <span class="free">cto</span><span class="main">,</span> map_of <span class="free">tao</span><span class="main">,</span> translate_osig <span class="free">sa</span><span class="main">)</span> <span class="bound">ty</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ran_distinct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TheoryExe-wf_sig_iff_exe_wf_sig_pre"><span class="command">lemma</span></span> wf_sig_iff_exe_wf_sig_pre<span class="main">:</span> <span class="quoted"><span class="quoted">"alist_conds <span class="free">cto</span> <span class="main">⟹</span> alist_conds <span class="free">tao</span> <span class="main">⟹</span> exe_osig_conds <span class="free">sa</span>
  <span class="main">⟹</span> wf_sig <span class="main">(</span>map_of <span class="free">cto</span><span class="main">,</span> map_of <span class="free">tao</span><span class="main">,</span> translate_osig <span class="free">sa</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>exe_wf_osig <span class="free">sa</span>
  <span class="main">∧</span> fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free">tao</span>  
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">type</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span>the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="bound">type</span><span class="main">)</span> <span class="main">(</span>exetcsigs <span class="free">sa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span>
      the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="bound">type</span><span class="main">)</span> <span class="free">tao</span><span class="main">)</span> <span class="main">=</span> length <span class="bound">ars</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ty</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">cto</span> <span class="main">.</span> typ_ok_sig <span class="main">(</span>map_of <span class="free">cto</span><span class="main">,</span> map_of <span class="free">tao</span><span class="main">,</span> translate_osig <span class="free">sa</span><span class="main">)</span> <span class="bound">ty</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exe_wf_sig_imp_wf_sig wf_sig_imp_exe_wf_sig <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>

<span class="keyword1" id="TheoryExe-wf_sig_iff_exe_wf_sig"><span class="command">lemma</span></span> wf_sig_iff_exe_wf_sig<span class="main">:</span> <span class="quoted"><span class="quoted">"alist_conds <span class="free">cto</span> <span class="main">⟹</span> alist_conds <span class="free">tao</span> <span class="main">⟹</span> exe_osig_conds <span class="free">sa</span>
  <span class="main">⟹</span> wf_sig <span class="main">(</span>map_of <span class="free">cto</span><span class="main">,</span> map_of <span class="free">tao</span><span class="main">,</span> translate_osig <span class="free">sa</span><span class="main">)</span>
  <span class="main">⟷</span> exe_wf_sig <span class="main">(</span>ExeSignature <span class="free">cto</span> <span class="free">tao</span> <span class="free">sa</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exe_wf_sig.simps
  <span class="keyword1"><span class="command">using</span></span> wf_sig_iff_exe_wf_sig_pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">translate_signature</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exesignature <span class="main">⇒</span> signature"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">translate_signature</span> <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span>map_of <span class="free"><span class="bound"><span class="entity">cto</span></span></span><span class="main">,</span> map_of <span class="free"><span class="bound"><span class="entity">tao</span></span></span><span class="main">,</span> translate_osig <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exetyp_ok_sig</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exesignature <span class="main">⇒</span> typ <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exetyp_ok_sig</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>exetyp_arity_of <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> False
  <span class="main">|</span> Some <span class="bound">ar</span> <span class="main">⇒</span> length <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span> <span class="bound">ar</span> <span class="main">∧</span> list_all <span class="main">(</span><span class="free">exetyp_ok_sig</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exetyp_ok_sig</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Tv <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> exewf_sort <span class="main">(</span>execlasses <span class="main">(</span>exesorts <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">thm</span></span> exewf_sort_def
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">exesort_ok_sig</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> exesort_ex <span class="main">(</span>execlasses <span class="main">(</span>exesorts <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> 
  <span class="main">∧</span> exenormalized_sort <span class="main">(</span>execlasses <span class="main">(</span>exesorts <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1" id="TheoryExe-typ_arity_lookup_code"><span class="command">lemma</span></span> typ_arity_lookup_code<span class="main">:</span> <span class="quoted"><span class="quoted">"type_arity <span class="main">(</span>translate_signature <span class="free">Σ</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>exetyp_arity_of <span class="free">Σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Σ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_eq_map_of_ap<span class="main">)</span>

<span class="keyword1" id="TheoryExe-typ_ok_sig_code"><span class="command">lemma</span></span> typ_ok_sig_code<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_osig_conds <span class="main">(</span>exesorts <span class="free">Σ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_ok_sig <span class="main">(</span>translate_signature <span class="free">Σ</span><span class="main">)</span> <span class="free">ty</span> <span class="main">=</span> exetyp_ok_sig <span class="free">Σ</span> <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ty</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_sort_def list_all_iff typ_arity_lookup_code<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_sort_code <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Σ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_osig_conds_def classes_translate<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exe_wf_sig'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exe_wf_sig'</span> <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>exe_wf_osig <span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">∧</span>
  fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">tao</span></span></span> 
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">type</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>exetcsigs <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span><span class="main">.</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">ars</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span>the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="bound">type</span><span class="main">)</span> <span class="main">(</span>exetcsigs <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span>
      the <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="bound">type</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span><span class="main">)</span> <span class="main">=</span> length <span class="bound">ars</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ty</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="main">.</span> exetyp_ok_sig <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> <span class="bound">ty</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TheoryExe-exe_wf_sig_code"><span class="command">lemma</span></span> exe_wf_sig_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exe_wf_sig <span class="free">Σ</span> <span class="main">=</span> exe_wf_sig' <span class="free">Σ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typ_ok_sig_code <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> exesignature.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> translate_signature.simps<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exeterm_ok'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exesignature <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exeterm_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Fv <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> exetyp_ok_sig <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exeterm_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Bv <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exeterm_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>execonst_type_of <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> False
  <span class="main">|</span> Some <span class="bound">ty</span> <span class="main">⇒</span> exetyp_ok_sig <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span> tinstT <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="bound">ty</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exeterm_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">exeterm_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="free">exeterm_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exeterm_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">⟷</span> exetyp_ok_sig <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span> <span class="free">exeterm_ok'</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="TheoryExe-const_type_of_lookup_code"><span class="command">lemma</span></span> const_type_of_lookup_code<span class="main">:</span> <span class="quoted"><span class="quoted">"const_type <span class="main">(</span>translate_signature <span class="free">Σ</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>execonst_type_of <span class="free">Σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Σ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_eq_map_of_ap<span class="main">)</span>

<span class="keyword1" id="TheoryExe-wt_term_code"><span class="command">lemma</span></span> wt_term_code<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_osig_conds <span class="main">(</span>exesorts <span class="free">Σ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok' <span class="main">(</span>translate_signature <span class="free">Σ</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> exeterm_ok' <span class="free">Σ</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_type_of_lookup_code assms typ_ok_sig_code <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> exetheory <span class="main">=</span> ExeTheory <span class="main">(</span><span class="free"><span class="entity">exesig</span></span><span class="main">:</span> <span class="quoted">exesignature</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">exeaxioms_of</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"term list"</span></span><span class="main">)</span>

<span class="keyword1" id="TheoryExe-exetheory_full_exhaust"><span class="command">lemma</span></span> exetheory_full_exhaust<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">const_type</span> <span class="bound">typ_arity</span> <span class="bound">sorts</span> <span class="bound">axioms</span><span class="main">.</span> 
    <span class="free">Θ</span> <span class="main">=</span> <span class="main">(</span>ExeTheory <span class="main">(</span>ExeSignature <span class="bound">const_type</span> <span class="bound">typ_arity</span> <span class="bound">sorts</span><span class="main">)</span> <span class="bound">axioms</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span>
  <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> Σ axioms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Σ</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">exe_sig_conds</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">≡</span> alist_conds <span class="main">(</span>execonst_type_of <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">∧</span> alist_conds <span class="main">(</span>exetyp_arity_of <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> 
  <span class="main">∧</span> exe_osig_conds <span class="main">(</span>exesorts <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">illformed_theory</span> <span class="main">≡</span>  <span class="main">(</span><span class="main">(</span>Map.empty<span class="main">,</span> Map.empty<span class="main">,</span> illformed_osig<span class="main">)</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TheoryExe-illformed_theory_not_wf_theory"><span class="command">lemma</span></span> illformed_theory_not_wf_theory<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wf_theory illformed_theory"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">translate_theory</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exetheory <span class="main">⇒</span> theory"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">translate_theory</span> <span class="main">(</span>ExeTheory <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ax</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> exe_sig_conds <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="keyword1">then</span> 
    <span class="main">(</span>translate_signature <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">,</span> set <span class="free"><span class="bound"><span class="entity">ax</span></span></span><span class="main">)</span> <span class="keyword1">else</span> illformed_theory<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exe_wf_theory</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">exe_wf_theory</span> <span class="main">(</span>ExeTheory <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ax</span></span></span><span class="main">)</span> <span class="main">⟷</span>
  exe_sig_conds <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ax</span></span></span> <span class="main">.</span> term_ok <span class="main">(</span>translate_theory <span class="main">(</span>ExeTheory <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ax</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∧</span> typ_of <span class="bound">p</span> <span class="main">=</span> Some propT<span class="main">)</span>
  <span class="main">∧</span> is_std_sig <span class="main">(</span>translate_signature <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> exe_wf_sig <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span>
  <span class="main">∧</span> eq_axs <span class="main">⊆</span> set <span class="free"><span class="bound"><span class="entity">ax</span></span></span>"</span></span>

<span class="keyword1" id="TheoryExe-wf_sig_iff_exe_wf_sig'"><span class="command">lemma</span></span> wf_sig_iff_exe_wf_sig'<span class="main">:</span> <span class="quoted"><span class="quoted">"exe_sig_conds <span class="free">Σ</span> <span class="main">⟹</span>
    wf_sig <span class="main">(</span>translate_signature <span class="free">Σ</span><span class="main">)</span> <span class="main">⟷</span>
    exe_wf_sig <span class="free">Σ</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exe_sig_conds_def exesignature.exhaust_sel wf_sig_iff_exe_wf_sig translate_signature.simps<span class="main">)</span>

<span class="keyword1" id="TheoryExe-wf_sig_imp_exe_wf_sig'"><span class="command">lemma</span></span> wf_sig_imp_exe_wf_sig'<span class="main">:</span> <span class="quoted"><span class="quoted">"exe_sig_conds <span class="free">Σ</span> <span class="main">⟹</span>
    wf_sig <span class="main">(</span>translate_signature <span class="free">Σ</span><span class="main">)</span> <span class="main">⟹</span>
    exe_wf_sig <span class="free">Σ</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exe_sig_conds_def exesignature.exhaust_sel wf_sig_iff_exe_wf_sig translate_signature.simps<span class="main">)</span>

<span class="keyword1" id="TheoryExe-exe_wf_sig_imp_wf_sig'"><span class="command">lemma</span></span> exe_wf_sig_imp_wf_sig'<span class="main">:</span> <span class="quoted"><span class="quoted">"exe_sig_conds <span class="free">Σ</span> <span class="main">⟹</span>
    exe_wf_sig <span class="free">Σ</span>
    <span class="main">⟹</span> wf_sig <span class="main">(</span>translate_signature <span class="free">Σ</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exe_sig_conds_def exesignature.exhaust_sel wf_sig_iff_exe_wf_sig translate_signature.simps<span class="main">)</span>

<span class="keyword1" id="TheoryExe-wf_theory_translate_imp_exe_wf_theory"><span class="command">lemma</span></span> wf_theory_translate_imp_exe_wf_theory<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="main">(</span>translate_theory <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exe_wf_theory <span class="free">a</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exe_sig_conds <span class="main">(</span>exesig <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exetheory.collapse illformed_theory_not_wf_theory translate_theory.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_sig <span class="main">(</span>translate_signature <span class="main">(</span>exesig <span class="free">a</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟷</span> exe_wf_sig <span class="main">(</span>exesig <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wf_sig_iff_exe_wf_sig'<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exe_wf_theory.cases<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff eq_fst_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TheoryExe-exe_wf_theory_translate_imp_wf_theory"><span class="command">lemma</span></span> exe_wf_theory_translate_imp_wf_theory<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_wf_theory <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_theory <span class="main">(</span>translate_theory <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exe_sig_conds <span class="main">(</span>exesig <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> exe_wf_theory.simps exesignature.exhaust_sel exetheory.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> translate_theory.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="main">∀</span><span class="bound">ty</span> <span class="main">∈</span> Map.ran <span class="main">(</span>map_of <span class="main">(</span>execonst_type_of <span class="main">(</span>exesig <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> typ_ok_sig <span class="main">(</span>translate_signature <span class="main">(</span>exesig <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">ty</span><span class="main">)</span>
  <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ty</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span>execonst_type_of <span class="main">(</span>exesig <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> typ_ok_sig <span class="main">(</span>translate_signature <span class="main">(</span>exesig <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">ty</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exe_sig_conds_def ran_distinct<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_sig <span class="main">(</span>translate_signature <span class="main">(</span>exesig <span class="free">a</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟷</span> exe_wf_sig <span class="main">(</span>exesig <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wf_sig_iff_exe_wf_sig'<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exe_wf_theory.cases<span class="main">)</span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TheoryExe-wf_theory_translate_iff_exe_wf_theory"><span class="command">lemma</span></span> wf_theory_translate_iff_exe_wf_theory<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_theory <span class="main">(</span>translate_theory <span class="free">a</span><span class="main">)</span> <span class="main">⟷</span> exe_wf_theory <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exe_wf_theory_translate_imp_wf_theory wf_theory_translate_imp_exe_wf_theory <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exeis_std_sig</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">exeis_std_sig</span> <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sorts</span></span></span><span class="main">)</span> <span class="main">⟷</span>
    lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="main">=</span> Some <span class="numeral">2</span> <span class="main">∧</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span>  <span class="main">=</span> Some <span class="main">0</span> 
  <span class="main">∧</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''itself''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="main">=</span> Some <span class="main">1</span>
  <span class="main">∧</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.eq''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cto</span></span></span> 
    <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span>Tv <span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">(</span>Tv <span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span>Tv <span class="main">(</span>Var  <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort <span class="main">→</span> propT<span class="main">)</span> <span class="main">→</span> propT<span class="main">)</span>
  <span class="main">∧</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.imp''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="main">=</span> Some <span class="main">(</span>propT <span class="main">→</span> <span class="main">(</span>propT <span class="main">→</span> propT<span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.type''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="main">=</span> Some <span class="main">(</span>itselfT <span class="main">(</span>Tv <span class="main">(</span>Var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> full_sort<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TheoryExe-is_std_sig_code"><span class="command">lemma</span></span> is_std_sig_code<span class="main">:</span> <span class="quoted"><span class="quoted">"is_std_sig <span class="main">(</span>translate_signature <span class="free">Σ</span><span class="main">)</span> <span class="main">=</span> exeis_std_sig <span class="free">Σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Σ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_eq_map_of_ap<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exe_wf_theory'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">exe_wf_theory'</span> <span class="main">(</span>ExeTheory <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ax</span></span></span><span class="main">)</span> <span class="main">⟷</span>
  exe_sig_conds <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ax</span></span></span> <span class="main">.</span> exeterm_ok' <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> <span class="bound">p</span> <span class="main">∧</span> typ_of <span class="bound">p</span> <span class="main">=</span> Some propT<span class="main">)</span>
  <span class="main">∧</span> exeis_std_sig <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span>
  <span class="main">∧</span> exe_wf_sig <span class="main">(</span>ExeSignature <span class="free"><span class="bound"><span class="entity">cto</span></span></span> <span class="free"><span class="bound"><span class="entity">tao</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span>
  <span class="main">∧</span> eq_axs <span class="main">⊆</span> set <span class="free"><span class="bound"><span class="entity">ax</span></span></span>"</span></span>

<span class="keyword1" id="TheoryExe-term_ok'_code"><span class="command">lemma</span></span> term_ok'_code<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_osig_conds <span class="main">(</span>exesorts <span class="main">(</span>ExeSignature <span class="free">cto</span> <span class="free">tao</span> <span class="free">sa</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term_ok' <span class="main">(</span>translate_signature <span class="main">(</span>ExeSignature <span class="free">cto</span> <span class="free">tao</span> <span class="free">sa</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> typ_of <span class="free">p</span> <span class="main">=</span> Some propT<span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span>exeterm_ok' <span class="main">(</span>ExeSignature <span class="free">cto</span> <span class="free">tao</span> <span class="free">sa</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> typ_of <span class="free">p</span> <span class="main">=</span> Some propT<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wt_term_code<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="TheoryExe-term_ok_translate_code_step"><span class="command">lemma</span></span> term_ok_translate_code_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_sig_conds <span class="main">(</span>ExeSignature <span class="free">cto</span> <span class="free">tao</span> <span class="free">sa</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term_ok <span class="main">(</span>translate_theory <span class="main">(</span>ExeTheory <span class="main">(</span>ExeSignature <span class="free">cto</span> <span class="free">tao</span> <span class="free">sa</span><span class="main">)</span> <span class="free">ax</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> typ_of <span class="free">p</span> <span class="main">=</span> Some propT<span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span>term_ok' <span class="main">(</span>translate_signature <span class="main">(</span>ExeSignature <span class="free">cto</span> <span class="free">tao</span> <span class="free">sa</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> typ_of <span class="free">p</span> <span class="main">=</span> Some propT<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_term_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  
<span class="keyword1" id="TheoryExe-term_ok_theory_cond_code"><span class="command">lemma</span></span> term_ok_theory_cond_code<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_sig_conds <span class="main">(</span>ExeSignature <span class="free">cto</span> <span class="free">tao</span> <span class="free">sa</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">ax</span> <span class="main">.</span> term_ok <span class="main">(</span>translate_theory <span class="main">(</span>ExeTheory <span class="main">(</span>ExeSignature <span class="free">cto</span> <span class="free">tao</span> <span class="free">sa</span><span class="main">)</span> <span class="free">ax</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∧</span> typ_of <span class="bound">p</span> <span class="main">=</span> Some propT<span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">ax</span> <span class="main">.</span> exeterm_ok' <span class="main">(</span>ExeSignature <span class="free">cto</span> <span class="free">tao</span> <span class="free">sa</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∧</span> typ_of <span class="bound">p</span> <span class="main">=</span> Some propT<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms wf_term_imp_term_ok' exe_sig_conds_def wt_term_code
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> term_ok_translate_code_step wt_term_code wt_term_def<span class="main">)</span>
  
<span class="keyword1" id="TheoryExe-exe_wf_theory_code"><span class="command">lemma</span></span> exe_wf_theory_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exe_wf_theory <span class="free">Θ</span> <span class="main">=</span> exe_wf_theory' <span class="free">Θ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exetheory_full_exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> exe_wf_theory.simps exe_wf_theory'.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> term_ok_theory_cond_code is_std_sig_code <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CheckerExe">
<div class="head">
<h1>Theory CheckerExe</h1>
</div>
<pre class="source">
<span class="keyword1"><span class="command">theory</span></span> CheckerExe
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#TheoryExe">TheoryExe</a> <a href="#ProofTerm">ProofTerm</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">exetyp_ok</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">≡</span> exetyp_ok_sig <span class="main">(</span>exesig <span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CheckerExe-typ_ok_code"><span class="command">lemma</span></span> typ_ok_code<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_wf_theory' <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="main">(</span>translate_theory <span class="free">Θ</span><span class="main">)</span> <span class="free">ty</span> <span class="main">=</span> exetyp_ok <span class="free">Θ</span> <span class="free">ty</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms typ_ok_sig_code
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exe_sig_conds_def exe_wf_theory.simps exe_wf_theory_code exesignature.exhaust
      exetheory.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sig.simps translate_theory.elims typ_ok_def wf_type_iff_typ_ok_sig<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">execlass_leq</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">=</span> List.member <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1" id="CheckerExe-execlass_leq_code"><span class="command">lemma</span></span> execlass_leq_code<span class="main">:</span> <span class="quoted"><span class="quoted">"class_leq <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="free">c1</span> <span class="free">c2</span> <span class="main">=</span> execlass_leq <span class="free">cs</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> class_leq_def class_les_def member_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">exesort_leq</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">.</span> <span class="main">∃</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">.</span> execlass_leq <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1" id="CheckerExe-exesort_les_code"><span class="command">lemma</span></span> exesort_les_code<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_leq <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="free">c1</span> <span class="free">c2</span> <span class="main">=</span> exesort_leq <span class="free">cs</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> execlass_leq_code exesort_leq_def sort_leq_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exehas_sort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exeosig <span class="main">⇒</span> typ <span class="main">⇒</span> sort <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exehas_sort</span> <span class="free"><span class="bound"><span class="entity">oss</span></span></span> <span class="main">(</span>Tv <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span> <span class="main">=</span> exesort_leq <span class="main">(</span>execlasses <span class="free"><span class="bound"><span class="entity">oss</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exehas_sort</span> <span class="free"><span class="bound"><span class="entity">oss</span></span></span> <span class="main">(</span>Ty <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>exetcsigs <span class="free"><span class="bound"><span class="entity">oss</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
  None <span class="main">⇒</span> False <span class="main">|</span>
  Some <span class="bound">mgd</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span>
    <span class="keyword1">case</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="bound">C</span><span class="main">)</span> <span class="bound">mgd</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> False
      <span class="main">|</span> Some <span class="bound">Ss</span> <span class="main">⇒</span> list_all2 <span class="main">(</span><span class="free">exehas_sort</span> <span class="free"><span class="bound"><span class="entity">oss</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="bound">Ss</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* cleanup *)</span>
<span class="keyword1" id="CheckerExe-exehas_sort_imp_has_sort"><span class="command">lemma</span></span> exehas_sort_imp_has_sort<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_osig_conds <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">tcs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exehas_sort <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">tcs</span><span class="main">)</span> <span class="free">T</span> <span class="free">S</span> <span class="main">⟹</span> has_sort <span class="main">(</span>translate_osig <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">tcs</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub'</span></span> <span class="skolem"><span class="skolem">tcs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub'_tcs'<span class="main">:</span> <span class="quoted"><span class="quoted">"translate_osig <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">tcs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub'</span><span class="main">,</span> <span class="skolem">tcs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mgd</span></span> <span class="keyword2"><span class="keyword">where</span></span> mgd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tcs'</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">mgd</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Ty.prems sub'_tcs' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms exe_ars_conds_def exe_osig_conds_def in_alist_imp_in_map_of lookup_eq_map_of_ap 
        map_of_SomeD snd_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> sub'_tcs'<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> has_sort_Ty<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">tcs'</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> mgd<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">∈</span><span class="skolem">S</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free">tcs</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">mgd</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms lookup_eq_map_of_ap mgd snd_conv sub'_tcs' translate_ars.simps translate_osig.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="skolem">n</span><span class="main">)</span> <span class="free">tcs</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">tcs</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre_mgd</span></span> <span class="keyword2"><span class="keyword">where</span></span> pre_mgd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="skolem">n</span><span class="main">)</span> <span class="free">tcs</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">pre_mgd</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> pre_mgd_mgd<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">pre_mgd</span> <span class="main">=</span> <span class="skolem">mgd</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l assms exe_ars_conds_def
          exe_osig_conds_def in_alist_imp_in_map_of lookup_eq_map_of_ap map_of_SomeD 
          option.sel pre_mgd snd_conv translate_ars.simps<span class="main">)</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> Ss<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="skolem">c</span><span class="main">)</span> <span class="skolem">pre_mgd</span> <span class="main">=</span> Some <span class="skolem">Ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ty.prems asm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_mgd <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>exehas_sort <span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">tcs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ts</span> <span class="skolem">Ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹exehas_sort <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">tcs</span><span class="main">)</span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="skolem">S</span>›</span></span>asm pre_mgd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      
    <span class="keyword1"><span class="command">from</span></span> Ss <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mgd</span> <span class="skolem">c</span> <span class="main">=</span> Some <span class="skolem">Ss</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_eq_map_of_ap pre_mgd_mgd<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Ss</span><span class="main">.</span> <span class="skolem">mgd</span> <span class="skolem">c</span> <span class="main">=</span> Some <span class="bound">Ss</span> <span class="main">∧</span> list_all2 <span class="main">(</span>has_sort <span class="main">(</span><span class="skolem">sub'</span><span class="main">,</span> <span class="skolem">tcs'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ts</span> <span class="bound">Ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cond Ty.IH list.rel_mono_strong sub'_tcs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">n</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms exehas_sort.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> exesort_les_code has_sort_Tv prod.collapse translate_osig.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CheckerExe-has_sort_imp_exehas_sort"><span class="command">lemma</span></span> has_sort_imp_exehas_sort<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_osig_conds <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">tcs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>translate_osig <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">tcs</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="free">S</span> <span class="main">⟹</span> exehas_sort <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">tcs</span><span class="main">)</span> <span class="free">T</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ty <span class="skolem">n</span> <span class="skolem">Ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub'</span></span> <span class="skolem"><span class="skolem">tcs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub'_tcs'<span class="main">:</span> <span class="quoted"><span class="quoted">"translate_osig <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">tcs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub'</span><span class="main">,</span> <span class="skolem">tcs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mgd</span></span> <span class="keyword2"><span class="keyword">where</span></span> mgd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tcs'</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">mgd</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Ty.prems sub'_tcs' has_sort.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free">tcs</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">mgd</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms lookup_eq_map_of_ap prod.inject sub'_tcs' translate_ars.simps translate_osig.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>apsnd map_of<span class="main">)</span> <span class="free">tcs</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">mgd</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms lookup_eq_map_of_ap mgd snd_conv sub'_tcs' 
        translate_ars.simps translate_osig.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="skolem">n</span><span class="main">)</span> <span class="free">tcs</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">tcs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre_mgd</span></span> <span class="keyword2"><span class="keyword">where</span></span> pre_mgd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="skolem">n</span><span class="main">)</span> <span class="free">tcs</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">pre_mgd</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> pre_mgd_mgd<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">pre_mgd</span> <span class="main">=</span> <span class="skolem">mgd</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l assms exe_ars_conds_def
        exe_osig_conds_def in_alist_imp_in_map_of lookup_eq_map_of_ap map_of_SomeD option.sel
        pre_mgd snd_conv translate_ars.simps<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">∈</span><span class="skolem">S</span>"</span></span>
    
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> Ss<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="skolem">c</span><span class="main">)</span> <span class="skolem">pre_mgd</span> <span class="main">=</span> Some <span class="skolem">Ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">pre_mgd</span> <span class="main">=</span> <span class="skolem">mgd</span>›</span></span> sub'_tcs' mgd assms Ty.prems has_sort.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_map_of_conv_image_fst domIff eq_fst_iff exe_ars_conds_def 
          map_of_eq_None_iff classes_translate lookup_eq_map_of_ap <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> typ.splits
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> domD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> domI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ts</span> <span class="main">=</span> length <span class="skolem">Ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> asm mgd pre_mgd Ty.prems assms sub'_tcs' Ss list_all2_lengthD pre_mgd_mgd
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_sort.simps lookup_eq_map_of_ap<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="main">∃</span><span class="bound">Ss</span> <span class="main">.</span> <span class="skolem">mgd</span> <span class="bound">c</span> <span class="main">=</span> Some <span class="bound">Ss</span> <span class="main">∧</span> list_all2 <span class="main">(</span>has_sort <span class="main">(</span><span class="skolem">sub'</span><span class="main">,</span> <span class="skolem">tcs'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ts</span> <span class="bound">Ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mgd Ty.prems has_sort.simps sub'_tcs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>exehas_sort <span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">tcs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ts</span> <span class="skolem">Ss</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list_all2_all_nthI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> p <span class="keyword2"><span class="keyword">for</span></span> m 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Ty.IH<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> p Ty.prems assms 1
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ss asm list_all2_conv_all_nth lookup_eq_map_of_ap option.sel pre_mgd_mgd sub'_tcs'<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">C</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span>
    <span class="keyword1">case</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span><span class="bound">C</span><span class="main">)</span> <span class="skolem">pre_mgd</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> False
      <span class="main">|</span> Some <span class="bound">Ss</span> <span class="main">⇒</span> list_all2 <span class="main">(</span>exehas_sort <span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">tcs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ts</span> <span class="bound">Ss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span> Ty.IH list_all2_conv_all_nth lookup_eq_map_of_ap nth_mem option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> 
        pre_mgd_mgd sub'_tcs'<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> pre_mgd <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tv <span class="skolem">n</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms exesort_les_code has_sort_Tv_imp_sort_leq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CheckerExe-has_sort_code"><span class="command">lemma</span></span> has_sort_code<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_osig_conds <span class="free">oss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>translate_osig <span class="free">oss</span><span class="main">)</span> <span class="free">T</span> <span class="free">S</span> <span class="main">=</span> exehas_sort <span class="free">oss</span> <span class="free">T</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms exehas_sort_imp_has_sort has_sort_imp_exehas_sort prod.collapse<span class="main">)</span>

<span class="keyword1" id="CheckerExe-has_sort_code'"><span class="command">lemma</span></span> has_sort_code'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_wf_theory' <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="main">(</span>translate_theory <span class="free">Θ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="free">S</span> 
    <span class="main">=</span> exehas_sort <span class="main">(</span>exesorts <span class="main">(</span>exesig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exetheory_full_exhaust<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms has_sort_code <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">exeinst_ok</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span> <span class="main">≡</span> 
    distinct <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">insts</span></span></span><span class="main">)</span>
  <span class="main">∧</span> list_all <span class="main">(</span>exetyp_ok <span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">)</span> <span class="main">(</span>map snd <span class="free"><span class="bound"><span class="entity">insts</span></span></span><span class="main">)</span>
  <span class="main">∧</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">.</span> exehas_sort <span class="main">(</span>exesorts <span class="main">(</span>exesig <span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span> <span class="bound">S</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">insts</span></span></span>"</span></span>

<span class="keyword1" id="CheckerExe-inst_ok_code1"><span class="command">lemma</span></span> inst_ok_code1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_wf_theory' <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>exetyp_ok <span class="free">Θ</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span> <span class="main">=</span> list_all <span class="main">(</span>typ_ok <span class="main">(</span>translate_theory <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">insts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms typ_ok_code <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

<span class="keyword1" id="CheckerExe-inst_ok_code2"><span class="command">lemma</span></span> inst_ok_code2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_wf_theory' <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">.</span> has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="main">(</span>translate_theory <span class="free">Θ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span> <span class="bound">S</span><span class="main">)</span> <span class="free">insts</span>
    <span class="main">=</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">idn</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">.</span> exehas_sort <span class="main">(</span>exesorts <span class="main">(</span>exesig <span class="free">Θ</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span> <span class="bound">S</span><span class="main">)</span> <span class="free">insts</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> has_sort_code' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CheckerExe-inst_ok_code"><span class="command">lemma</span></span> inst_ok_code<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_wf_theory' <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inst_ok <span class="main">(</span>translate_theory <span class="free">Θ</span><span class="main">)</span> <span class="free">insts</span> <span class="main">=</span> exeinst_ok <span class="free">Θ</span> <span class="free">insts</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inst_ok_code1 inst_ok_code2 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">exeterm_ok</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> exeterm_ok' <span class="main">(</span>exesig <span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> typ_of <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≠</span> None"</span></span>
<span class="keyword1" id="CheckerExe-term_ok_code"><span class="command">lemma</span></span> term_ok_code<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_wf_theory' <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_ok <span class="main">(</span>translate_theory <span class="free">Θ</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> exeterm_ok <span class="free">Θ</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Θ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exetheory_full_exhaust<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exe_sig_conds_def exe_wf_theory'.simps exeterm_ok_def exetheory.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
      sig.simps term_okD1 term_okD2 term_okI wt_term_code translate_theory.simps<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exereplay'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exetheory <span class="main">⇒</span> <span class="main">(</span>variable <span class="main">×</span> typ<span class="main">)</span> list <span class="main">⇒</span> variable set
  <span class="main">⇒</span> term list <span class="main">⇒</span> proofterm <span class="main">⇒</span> term option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exereplay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>PAxm <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">Tis</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> exeinst_ok <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">Tis</span></span></span> <span class="main">∧</span> exeterm_ok <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∈</span> set <span class="main">(</span>exeaxioms_of <span class="free"><span class="bound"><span class="entity">thy</span></span></span><span class="main">)</span>
      <span class="keyword1">then</span> Some <span class="main">(</span>forall_intro_vars <span class="main">(</span>subst_typ' <span class="free"><span class="bound"><span class="entity">Tis</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> 
    <span class="keyword1">else</span> None <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exereplay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>PBound <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> partial_nth <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exereplay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>Abst <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> exetyp_ok <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> 
    <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">ns'</span><span class="main">)</span> <span class="main">=</span> variant_variable <span class="main">(</span>Free <span class="keyword1">STR</span> <span class="inner_quoted">''default''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="keyword1">in</span> 
      map_option <span class="main">(</span>mk_all <span class="bound">s'</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">exereplay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="bound">ns'</span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exereplay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>Appt <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rep</span> <span class="main">=</span> <span class="free">exereplay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">t'</span> <span class="main">=</span> subst_bvs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">.</span> Fv <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">case</span> <span class="main">(</span><span class="bound">rep</span><span class="main">,</span> typ_of <span class="bound">t'</span><span class="main">)</span> <span class="keyword1">of</span>
        <span class="main">(</span>Some <span class="main">(</span>Ct <span class="bound">s</span> <span class="main">(</span>Ty <span class="bound">fun1</span> <span class="main">[</span>Ty <span class="bound">fun2</span> <span class="main">[</span><span class="bound">τ</span><span class="main">,</span> Ty <span class="bound">propT1</span> Nil<span class="main">]</span><span class="main">,</span> Ty <span class="bound">propT2</span> Nil<span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="bound">b</span><span class="main">)</span><span class="main">,</span> Some <span class="bound">τ'</span><span class="main">)</span> <span class="main">⇒</span> 
          <span class="keyword1">if</span> <span class="bound">s</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.all''</span> <span class="main">∧</span> <span class="bound">fun1</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> <span class="main">∧</span> <span class="bound">fun2</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> 
            <span class="main">∧</span> <span class="bound">propT1</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">∧</span> <span class="bound">propT2</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span>
             <span class="main">∧</span> <span class="bound">τ</span><span class="main">=</span><span class="bound">τ'</span> <span class="main">∧</span> exeterm_ok <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="bound">t'</span>
            <span class="keyword1">then</span> Some <span class="main">(</span><span class="bound">b</span> <span class="main">∙</span> <span class="bound">t'</span><span class="main">)</span> <span class="keyword1">else</span> None
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exereplay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>AbsP <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">t'</span> <span class="main">=</span> subst_bvs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">.</span> Fv <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">rep</span> <span class="main">=</span> <span class="free">exereplay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">(</span><span class="bound">t'</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Hs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="keyword1">if</span> typ_of <span class="bound">t'</span> <span class="main">=</span> Some propT <span class="main">∧</span> exeterm_ok <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="bound">t'</span> <span class="keyword1">then</span> map_option <span class="main">(</span>mk_imp <span class="bound">t'</span><span class="main">)</span> <span class="bound">rep</span> <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exereplay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>AppP <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rep1</span> <span class="main">=</span> Option.bind <span class="main">(</span><span class="free">exereplay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span> beta_eta_norm <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">rep2</span> <span class="main">=</span> Option.bind <span class="main">(</span><span class="free">exereplay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span> beta_eta_norm <span class="keyword1">in</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="bound">rep1</span><span class="main">,</span> <span class="bound">rep2</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>
        Some <span class="main">(</span>Ct <span class="bound">imp</span> <span class="main">(</span>Ty <span class="bound">fn1</span> <span class="main">[</span>Ty <span class="bound">prp1</span> <span class="main">[]</span><span class="main">,</span> Ty <span class="bound">fn2</span> <span class="main">[</span>Ty <span class="bound">prp2</span> <span class="main">[]</span><span class="main">,</span> Ty <span class="bound">prp3</span> <span class="main">[]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="bound">A</span> <span class="main">$</span> <span class="bound">B</span><span class="main">)</span><span class="main">,</span>
        Some <span class="bound">A'</span><span class="main">)</span> <span class="main">⇒</span> 
          <span class="keyword1">if</span> <span class="bound">imp</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Pure.imp''</span> <span class="main">∧</span> <span class="bound">fn1</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> <span class="main">∧</span> <span class="bound">fn2</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span>
            <span class="main">∧</span> <span class="bound">prp1</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">∧</span> <span class="bound">prp2</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">∧</span> <span class="bound">prp3</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">∧</span> <span class="bound">A</span><span class="main">=</span><span class="bound">A'</span> 
          <span class="keyword1">then</span> Some <span class="bound">B</span> <span class="keyword1">else</span> None
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exereplay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>OfClass <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> exehas_sort <span class="main">(</span>exesorts <span class="main">(</span>exesig <span class="free"><span class="bound"><span class="entity">thy</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">}</span> 
    <span class="main">∧</span> exetyp_ok <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span>
    <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span>const_of_class <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>execonst_type_of <span class="main">(</span>exesig <span class="free"><span class="bound"><span class="entity">thy</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span> 
      Some <span class="main">(</span>Ty <span class="bound">fun</span> <span class="main">[</span>Ty <span class="bound">it</span> <span class="main">[</span><span class="bound">ity</span><span class="main">]</span><span class="main">,</span> Ty <span class="bound">prop</span> <span class="main">[]</span><span class="main">]</span><span class="main">)</span> <span class="main">⇒</span> 
        <span class="keyword1">if</span> <span class="bound">ity</span> <span class="main">=</span> tvariable <span class="keyword1">STR</span> <span class="inner_quoted">'''a''</span> <span class="main">∧</span> <span class="bound">fun</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''fun''</span> <span class="main">∧</span> <span class="bound">prop</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''prop''</span> <span class="main">∧</span> <span class="bound">it</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''itself''</span>
          <span class="keyword1">then</span> Some <span class="main">(</span>mk_of_class <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exereplay'</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="main">(</span>Hyp <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="CheckerExe-of_class_code1"><span class="command">lemma</span></span> of_class_code1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_wf_theory' <span class="free">thy</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="main">(</span>translate_theory <span class="free">thy</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">ty</span> <span class="main">{</span><span class="free">c</span><span class="main">}</span> <span class="main">∧</span> typ_ok <span class="main">(</span>translate_theory <span class="free">thy</span><span class="main">)</span> <span class="free">ty</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span>exehas_sort <span class="main">(</span>exesorts <span class="main">(</span>exesig <span class="free">thy</span><span class="main">)</span><span class="main">)</span> <span class="free">ty</span> <span class="main">{</span><span class="free">c</span><span class="main">}</span> <span class="main">∧</span> exetyp_ok <span class="free">thy</span> <span class="free">ty</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_sort <span class="main">(</span>osig <span class="main">(</span>sig <span class="main">(</span>translate_theory <span class="free">thy</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">ty</span> <span class="main">{</span><span class="free">c</span><span class="main">}</span>
    <span class="main">=</span> exehas_sort <span class="main">(</span>exesorts <span class="main">(</span>exesig <span class="free">thy</span><span class="main">)</span><span class="main">)</span> <span class="free">ty</span> <span class="main">{</span><span class="free">c</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> has_sort_code' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"typ_ok <span class="main">(</span>translate_theory <span class="free">thy</span><span class="main">)</span> <span class="free">ty</span> <span class="main">=</span> exetyp_ok <span class="free">thy</span> <span class="free">ty</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> typ_ok_code assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CheckerExe-of_class_code2"><span class="command">lemma</span></span> of_class_code2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_wf_theory' <span class="free">thy</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"const_type <span class="main">(</span>sig <span class="main">(</span>translate_theory <span class="free">thy</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>const_of_class <span class="free">c</span><span class="main">)</span> 
    <span class="main">=</span> lookup <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">=</span>const_of_class <span class="free">c</span><span class="main">)</span> <span class="main">(</span>execonst_type_of <span class="main">(</span>exesig <span class="free">thy</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms const_type_of_lookup_code exe_wf_theory_code 
      exe_wf_theory_translate_imp_wf_theory exetheory.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> illformed_theory_not_wf_theory 
      sig.simps translate_theory.elims<span class="main">)</span>

<span class="keyword1" id="CheckerExe-replay'_code"><span class="command">lemma</span></span> replay'_code<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_wf_theory' <span class="free">thy</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"replay' <span class="main">(</span>translate_theory <span class="free">thy</span><span class="main">)</span> <span class="free">vs</span> <span class="free">ns</span> <span class="free">Hs</span> <span class="free">P</span> <span class="main">=</span> exereplay' <span class="free">thy</span> <span class="free">vs</span> <span class="free">ns</span> <span class="free">Hs</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">ns</span></span> <span class="quoted"><span class="free">Hs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PAxm <span class="skolem">ax</span> <span class="skolem">tys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_theory <span class="main">(</span>translate_theory <span class="free">thy</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms exe_wf_theory_code exe_wf_theory_translate_imp_wf_theory<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> inst<span class="main">:</span> <span class="quoted"><span class="quoted">"inst_ok <span class="main">(</span>translate_theory <span class="free">thy</span><span class="main">)</span> <span class="skolem">tys</span> <span class="main">⟷</span> exeinst_ok <span class="free">thy</span> <span class="skolem">tys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms inst_ok_code1 inst_ok_code2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> tok<span class="main">:</span> <span class="quoted"><span class="quoted">"term_ok <span class="main">(</span>translate_theory <span class="free">thy</span><span class="main">)</span> <span class="skolem">ax</span> <span class="main">⟷</span> exeterm_ok <span class="free">thy</span> <span class="skolem">ax</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms term_ok_code <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> ax<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ax</span> <span class="main">∈</span> axioms <span class="main">(</span>translate_theory <span class="free">thy</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">ax</span> <span class="main">∈</span> set <span class="main">(</span>exeaxioms_of <span class="free">thy</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> axioms.simps wf exetheory.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> illformed_theory_not_wf_theory translate_theory.elims<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms term_ok_code typ_ok_code of_class_code1 of_class_code2 
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main">:</span> replay'.simps exereplay'.simps <span class="quasi_keyword">split</span><span class="main">:</span> if_splits›</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">exereplay''</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> Option.bind <span class="main">(</span>exereplay' <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">Hs</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> beta_eta_norm"</span></span>
<span class="keyword1" id="CheckerExe-replay''_code"><span class="command">lemma</span></span> replay''_code<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_wf_theory' <span class="free">thy</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"replay'' <span class="main">(</span>translate_theory <span class="free">thy</span><span class="main">)</span> <span class="free">vs</span> <span class="free">ns</span> <span class="free">Hs</span> <span class="free">P</span> <span class="main">=</span> exereplay'' <span class="free">thy</span> <span class="free">vs</span> <span class="free">ns</span> <span class="free">Hs</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms replay'_code<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">exereplay</span> <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>hyps <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">.</span> exeterm_ok <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="bound">x</span> <span class="main">∧</span> typ_of <span class="bound">x</span> <span class="main">=</span> Some propT <span class="keyword1">then</span>
  exereplay'' <span class="free"><span class="bound"><span class="entity">thy</span></span></span> <span class="main">[]</span> <span class="main">(</span>fst <span class="main">`</span> <span class="main">(</span>fv_Proof <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> FV <span class="main">(</span>set <span class="main">(</span>hyps <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>hyps <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="CheckerExe-replay_code"><span class="command">lemma</span></span> replay_code<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exe_wf_theory' <span class="free">thy</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"replay <span class="main">(</span>translate_theory <span class="free">thy</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> exereplay <span class="free">thy</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms replay''_code term_ok_code <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">exe_replay'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> exereplay'' <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">[]</span> <span class="main">(</span>fst <span class="main">`</span> fv_Proof <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">exe_check_proof</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="main">≡</span> 
  exe_wf_theory' <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∧</span> exereplay <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">res</span></span></span>"</span></span>

<span class="keyword1" id="CheckerExe-exe_check_proof_iff_check_proof"><span class="command">lemma</span></span> exe_check_proof_iff_check_proof<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"exe_check_proof <span class="free">e</span> <span class="free">P</span> <span class="free">res</span> <span class="main">⟷</span> check_proof <span class="main">(</span>translate_theory <span class="free">e</span><span class="main">)</span> <span class="free">P</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> check_proof_def exe_check_proof_def wf_theory_translate_iff_exe_wf_theory 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exe_wf_theory_code replay_code<span class="main">)</span>

<span class="keyword1" id="CheckerExe-check_proof_sound"><span class="command">lemma</span></span> check_proof_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exe_check_proof <span class="free">e</span> <span class="free">P</span> <span class="free">res</span> <span class="main">⟹</span> translate_theory <span class="free">e</span><span class="main">,</span> set <span class="main">(</span>hyps <span class="free">P</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_proof_sound exe_check_proof_iff_check_proof<span class="main">)</span>

<span class="keyword1" id="CheckerExe-check_proof_really_sound"><span class="command">lemma</span></span> check_proof_really_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exe_check_proof <span class="free">e</span> <span class="free">P</span> <span class="free">res</span> <span class="main">⟹</span> translate_theory <span class="free">e</span><span class="main">,</span> set <span class="main">(</span>hyps <span class="free">P</span><span class="main">)</span> <span class="main">⊩</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_proof_really_sound exe_check_proof_iff_check_proof<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CodeGen">
<div class="head">
<h1>Theory CodeGen</h1>
</div>
<pre class="source">  
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Code Generation"</span></span>

<span class="keyword1"><span class="command">theory</span></span> CodeGen
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#ProofTerm">ProofTerm</a> <a href="#TheoryExe">TheoryExe</a> <a href="#CheckerExe">CheckerExe</a> <a href="#Instances">Instances</a>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Code_Target_Int.html">HOL-Library.Code_Target_Int</a>"</span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Code_Target_Nat.html">HOL-Library.Code_Target_Nat</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> typ_of_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">exe_check_proof</span></span> <span class="quoted"><span class="quoted">exereplay</span></span> <span class="quoted"><span class="quoted">exe_wf_theory</span></span>
  <span class="quoted"><span class="quoted">Bv</span></span> <span class="quoted"><span class="quoted">PBound</span></span> <span class="quoted"><span class="quoted">Tv</span></span> <span class="quoted"><span class="quoted">Free</span></span> <span class="quoted"><span class="quoted">ExeTheory</span></span> <span class="quoted"><span class="quoted">ExeSignature</span></span> <span class="comment1">(* To have acces to type constructors in interace*)</span>
  <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> ExportCheck <span class="keyword2"><span class="keyword">file_prefix</span></span> export

<span class="comment1">(*
  Need to change the following yourself, to open the interface

  datatype int = Int_of_integer of IntInf.int;
  datatype nat = Nat of IntInf.int;
  datatype 'a set = Set of 'a list | Coset of 'a list;
*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>